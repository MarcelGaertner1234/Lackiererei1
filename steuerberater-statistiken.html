<!DOCTYPE html>
<html lang="de">
<head>
    <!-- üåì FOUC Prevention: Load Theme BEFORE CSS to prevent flash -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>

    <script>
        /// <reference path="js/types.js" />
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistiken | Steuerberater Dashboard</title>

    <!-- Mobile-Responsive CSS Framework -->
    <link rel="stylesheet" href="mobile-responsive.css">

    <!-- Apple Liquid Glass Design System -->
    <link rel="stylesheet" href="design-system.css">
    <link rel="stylesheet" href="components.css">
    <link rel="stylesheet" href="animations.css">
    <link rel="stylesheet" href="mobile-first.css">
    <link rel="stylesheet" href="css/ai-chat-widget.css">
    <link rel="stylesheet" href="css/quota-display.css">

    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>

    <!-- GSAP Animation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', 'Inter', var(--font-system);
            background: var(--color-background);
            min-height: 100vh;
            padding: var(--space-6) var(--space-4) 100px;
            color: var(--color-text-primary);
            transition: background 0.3s ease, color 0.3s ease;
            overflow-x: auto;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 50px,
                rgba(255, 255, 255, 0.02) 50px,
                rgba(255, 255, 255, 0.02) 51px
            );
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            padding: var(--space-8);
            position: relative;
            overflow: visible;
            animation: slideIn 0.4s cubic-bezier(0.22, 1, 0.36, 1);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .nav-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            padding: 15px;
            background: var(--color-surface);
            border-radius: 12px;
            border: 1px solid var(--color-border-glass);
        }

        .nav-btn {
            padding: 10px 20px;
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border-glass);
            border-radius: 8px;
            color: var(--color-text-primary);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover {
            background: var(--color-surface-elevated);
            color: var(--color-primary);
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: var(--color-success);
            color: white;
            border-color: var(--color-success);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            color: var(--color-text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .period-selector {
            display: flex;
            gap: 8px;
            background: var(--color-surface);
            padding: 8px;
            border-radius: 12px;
            border: 1px solid var(--color-border-glass);
        }

        .period-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: var(--color-text-secondary);
            font-weight: 600;
            font-size: 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .period-btn:hover {
            background: var(--color-surface-elevated);
            color: var(--color-text-primary);
        }

        .period-btn.active {
            background: var(--color-success);
            color: white;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        .chart-card {
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border-glass);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s cubic-bezier(0.22, 1, 0.36, 1);
        }

        .chart-card:hover {
            box-shadow: var(--shadow-lg);
        }

        .chart-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--color-border-glass);
        }

        .chart-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--color-text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-container {
            position: relative;
            height: 320px;
        }

        .chart-container.tall {
            height: 400px;
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            gap: 20px;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--color-border-glass);
            border-top-color: var(--color-success);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 1200px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: var(--space-4);
            }

            .header h1 {
                font-size: 24px;
            }

            .chart-container {
                height: 280px;
            }

            .period-selector {
                flex-wrap: wrap;
            }
        }

        /* üåì THEME TOGGLE */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid var(--color-border);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .theme-toggle:hover { transform: scale(1.05); background: rgba(255, 255, 255, 0.15); }
        .theme-toggle__icon { width: 20px; height: 20px; color: var(--color-text-primary); }
        .theme-toggle__icon--light { display: none; }
        [data-theme="light"] .theme-toggle__icon--light { display: block; }
        [data-theme="light"] .theme-toggle__icon--dark { display: none; }
        [data-theme="light"] .theme-toggle { background: rgba(255,255,255,0.8); border-color: rgba(0,0,0,0.1); }

        /* üîô ZUR√úCK-BUTTON (Fixed Position) */
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--color-border, rgba(255,255,255,0.1));
            border-radius: 8px;
            color: var(--color-text-primary, #e0e0e0);
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .back-button:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(-2px);
        }
        [data-theme="light"] .back-button {
            background: rgba(255, 255, 255, 0.8);
            border-color: rgba(0, 0, 0, 0.1);
            color: #1a1a2e;
        }
        @media (max-width: 768px) {
            .back-button { top: 10px; left: 10px; padding: 8px; }
            .back-button span { display: none; }
        }
    </style>
</head>
<body class="has-ai-features">
    <!-- üîô ZUR√úCK-BUTTON -->
    <button class="back-button" onclick="history.back()" title="Zur√ºck">
        <i data-feather="arrow-left"></i>
        <span>Zur√ºck</span>
    </button>

    <!-- üåì THEME TOGGLE -->
    <button id="themeToggle" class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle Theme">
        <i data-feather="sun" class="theme-toggle__icon theme-toggle__icon--light"></i>
        <i data-feather="moon" class="theme-toggle__icon theme-toggle__icon--dark"></i>
    </button>

    <div class="container">
        <!-- Navigation -->
        <div class="nav-bar">
            <a href="index.html" class="nav-btn">
                <i data-feather="home"></i>
                Dashboard
            </a>
            <a href="steuerberater-bilanz.html" class="nav-btn">
                <i data-feather="pie-chart"></i>
                Bilanz-√úbersicht
            </a>
            <a href="steuerberater-statistiken.html" class="nav-btn active">
                <i data-feather="trending-up"></i>
                Statistiken
            </a>
            <a href="steuerberater-kosten.html" class="nav-btn">
                <i data-feather="layers"></i>
                Kostenaufschl√ºsselung
            </a>
            <a href="steuerberater-export.html" class="nav-btn">
                <i data-feather="download"></i>
                Export & Berichte
            </a>
        </div>

        <!-- Header -->
        <div class="header">
            <h1>
                <i data-feather="trending-up" style="color: var(--color-success);"></i>
                Statistiken & Visualisierungen
            </h1>
            <div class="period-selector">
                <button class="period-btn" data-period="month">Monat</button>
                <button class="period-btn" data-period="quarter">Quartal</button>
                <button class="period-btn active" data-period="year">Jahr</button>
                <button class="period-btn" data-period="all">Gesamt</button>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="loading">
            <div class="spinner"></div>
            <p style="color: var(--color-text-secondary); font-weight: 600;">Statistiken werden geladen...</p>
        </div>

        <!-- Charts -->
        <div id="chartsContainer" style="display: none;">
            <!-- Row 1: Umsatz-Trend (Full Width) -->
            <div class="chart-grid">
                <div class="chart-card full-width">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i data-feather="trending-up"></i>
                            Umsatz-Entwicklung
                        </h3>
                    </div>
                    <div class="chart-container tall">
                        <canvas id="umsatzTrendChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Row 2: Service-Verteilung + Gewinn-Marge -->
            <div class="chart-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i data-feather="pie-chart"></i>
                            Service-Verteilung (Umsatz)
                        </h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="serviceVerteilungChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i data-feather="activity"></i>
                            Gewinn & Marge
                        </h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="gewinnMargeChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Row 3: Kosten-Analyse (Full Width) -->
            <div class="chart-grid">
                <div class="chart-card full-width">
                    <div class="chart-header">
                        <h3 class="chart-title">
                            <i data-feather="layers"></i>
                            Kosten-Aufschl√ºsselung (Monatlich)
                        </h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="kostenAnalyseChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <!-- App Scripts (CRITICAL: firebase-config.js MUST be first!) -->
    <script src="firebase-config.js"></script>
    <script src="listener-registry.js"></script>
    <script src="js/auth-manager.js"></script>
    <script src="js/settings-manager.js"></script>
    <script src="js/toast.js"></script>

    <script>
        // ============================================
        // GLOBAL STATE
        // ============================================
        let currentPeriod = 'year';
        let allFahrzeuge = [];
        let werkstattId = '';

        // Chart instances
        let umsatzTrendChart = null;
        let serviceVerteilungChart = null;
        let gewinnMargeChart = null;
        let kostenAnalyseChart = null;

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Steuerberater Statistiken-Dashboard initialisiert');

            feather.replace();
            await checkAuth();

            // Period Selector
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentPeriod = btn.dataset.period;
                    updateAllCharts();
                });
            });

            await loadFinancialData();
        });

        // ============================================
        // AUTH CHECK
        // ============================================
        async function checkAuth() {
            return new Promise((resolve) => {
                firebase.auth().onAuthStateChanged(async (user) => {
                    if (!user) {
                        console.warn('‚ùå Nicht eingeloggt - Redirect zu Login');
                        safeNavigate('login.html');
                        return;
                    }

                    werkstattId = sessionStorage.getItem('werkstattId');
                    if (!werkstattId) {
                        console.error('‚ùå Keine werkstattId gefunden');
                        toast.error('Fehler: Keine Werkstatt-ID gefunden', { duration: 5000 });
                        return;
                    }

                    // üÜï BUGFIX 2025-11-15 (FIX #5): Partner-Zugriff auf Werkstatt-Seiten blockieren
                    // Partner d√ºrfen nur das Partner-Portal nutzen, nicht Werkstatt-Seiten
                    const role = sessionStorage.getItem('role');
                    if (role === 'partner') {
                        console.warn('üö´ Partner-Zugriff blockiert! Redirect zu Partner-Portal...');
                        safeNavigate('./partner-app/meine-anfragen.html');
                        return; // Stop further execution
                    }

                    if (role !== 'werkstatt' && role !== 'steuerberater' && role !== 'admin' && role !== 'superadmin') {
                        console.warn('‚ùå Zugriff verweigert - Keine Steuerberater-Rolle');
                        toast.error('Zugriff verweigert! Nur f√ºr Steuerberater.', { duration: 5000 });
                        setTimeout(() => safeNavigate('index.html'), 2000);
                        return;
                    }

                    console.log('‚úÖ Auth OK - Steuerberater:', user.email);
                    resolve();
                });
            });
        }

        // ============================================
        // LOAD FINANCIAL DATA
        // ============================================
        async function loadFinancialData() {
            try {
                console.log(`üìä Lade Fahrzeuge f√ºr werkstattId: ${werkstattId}`);

                const collection = `fahrzeuge_${werkstattId}`;
                const snapshot = await firebase.firestore()
                    .collection(collection)
                    .where('status', '==', 'abgeschlossen')
                    .get();

                allFahrzeuge = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                console.log(`‚úÖ ${allFahrzeuge.length} abgeschlossene Fahrzeuge geladen`);

                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('chartsContainer').style.display = 'block';

                createAllCharts();
                updateAllCharts();

            } catch (error) {
                console.error('‚ùå Fehler beim Laden der Daten:', error);
                toast.error('Fehler beim Laden der Statistiken', { duration: 5000 });
                document.getElementById('loadingState').innerHTML = `
                    <i data-feather="alert-circle" style="width: 48px; height: 48px; color: var(--color-error);"></i>
                    <p style="color: var(--color-error); font-weight: 600;">Fehler beim Laden der Daten</p>
                `;
                feather.replace();
            }
        }

        // ============================================
        // CREATE CHARTS (INITIAL SETUP)
        // ============================================
        function createAllCharts() {
            // Chart 1: Umsatz-Trend (Line Chart)
            const ctx1 = document.getElementById('umsatzTrendChart').getContext('2d');
            umsatzTrendChart = new Chart(ctx1, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => formatCurrencyShort(value)
                            }
                        }
                    }
                }
            });

            // Chart 2: Service-Verteilung (Doughnut Chart)
            const ctx2 = document.getElementById('serviceVerteilungChart').getContext('2d');
            serviceVerteilungChart = new Chart(ctx2, {
                type: 'doughnut',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'right' },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const label = context.label || '';
                                    const value = formatCurrency(context.parsed);
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Chart 3: Gewinn & Marge (Line Chart)
            const ctx3 = document.getElementById('gewinnMargeChart').getContext('2d');
            gewinnMargeChart = new Chart(ctx3, {
                type: 'line',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => formatCurrencyShort(value)
                            }
                        },
                        y1: {
                            position: 'right',
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: (value) => value + '%'
                            },
                            grid: { drawOnChartArea: false }
                        }
                    }
                }
            });

            // Chart 4: Kosten-Analyse (Stacked Bar Chart)
            const ctx4 = document.getElementById('kostenAnalyseChart').getContext('2d');
            kostenAnalyseChart = new Chart(ctx4, {
                type: 'bar',
                data: { labels: [], datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        x: { stacked: true },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                callback: (value) => formatCurrencyShort(value)
                            }
                        }
                    }
                }
            });

            console.log('‚úÖ Alle Chart-Instanzen erstellt');
        }

        // ============================================
        // UPDATE ALL CHARTS
        // ============================================
        function updateAllCharts() {
            const filtered = filterByPeriod(allFahrzeuge, currentPeriod);
            console.log(`üìä Update Charts f√ºr Periode: ${currentPeriod} (${filtered.length} Fahrzeuge)`);

            updateUmsatzTrendChart(filtered);
            updateServiceVerteilungChart(filtered);
            updateGewinnMargeChart(filtered);
            updateKostenAnalyseChart(filtered);

            feather.replace();
        }

        // ============================================
        // UPDATE: UMSATZ-TREND CHART
        // ============================================
        function updateUmsatzTrendChart(fahrzeuge) {
            const monthlyData = aggregateByMonth(fahrzeuge);
            const months = ['Jan', 'Feb', 'M√§r', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];

            const labels = months;
            const umsatzData = months.map((_, i) => monthlyData[i]?.umsatz || 0);
            const kostenData = months.map((_, i) => monthlyData[i]?.kosten || 0);

            umsatzTrendChart.data.labels = labels;
            umsatzTrendChart.data.datasets = [
                {
                    label: 'Umsatz (Brutto)',
                    data: umsatzData,
                    borderColor: '#22c55e',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'Kosten (Netto)',
                    data: kostenData,
                    borderColor: '#f59e0b',
                    backgroundColor: 'rgba(245, 158, 11, 0.1)',
                    fill: true,
                    tension: 0.4
                }
            ];

            umsatzTrendChart.update();
        }

        // ============================================
        // UPDATE: SERVICE-VERTEILUNG CHART
        // ============================================
        function updateServiceVerteilungChart(fahrzeuge) {
            const serviceData = {};

            fahrzeuge.forEach(f => {
                const service = f.serviceTyp || 'Unbekannt';
                if (!serviceData[service]) {
                    serviceData[service] = 0;
                }
                serviceData[service] += parseFloat(f.gesamtsummeBrutto || 0);
            });

            const sorted = Object.entries(serviceData).sort((a, b) => b[1] - a[1]);
            const labels = sorted.map(([service]) => service);
            const data = sorted.map(([, umsatz]) => umsatz);

            const colors = [
                '#22c55e', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6',
                '#ec4899', '#14b8a6', '#f97316', '#06b6d4', '#84cc16'
            ];

            serviceVerteilungChart.data.labels = labels;
            serviceVerteilungChart.data.datasets = [{
                data: data,
                backgroundColor: colors.slice(0, labels.length),
                borderWidth: 2,
                borderColor: '#ffffff'
            }];

            serviceVerteilungChart.update();
        }

        // ============================================
        // UPDATE: GEWINN-MARGE CHART
        // ============================================
        function updateGewinnMargeChart(fahrzeuge) {
            const monthlyData = aggregateByMonth(fahrzeuge);
            const months = ['Jan', 'Feb', 'M√§r', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];

            const labels = months;
            const gewinnData = months.map((_, i) => {
                const data = monthlyData[i];
                return data ? data.umsatz - data.kosten : 0;
            });
            const margeData = months.map((_, i) => {
                const data = monthlyData[i];
                if (!data || data.umsatz === 0) return 0;
                return ((data.umsatz - data.kosten) / data.umsatz * 100);
            });

            gewinnMargeChart.data.labels = labels;
            gewinnMargeChart.data.datasets = [
                {
                    label: 'Gewinn (‚Ç¨)',
                    data: gewinnData,
                    borderColor: '#22c55e',
                    backgroundColor: 'rgba(34, 197, 94, 0.1)',
                    fill: true,
                    tension: 0.4,
                    yAxisID: 'y'
                },
                {
                    label: 'Marge (%)',
                    data: margeData,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: false,
                    tension: 0.4,
                    yAxisID: 'y1'
                }
            ];

            gewinnMargeChart.update();
        }

        // ============================================
        // UPDATE: KOSTEN-ANALYSE CHART
        // ============================================
        function updateKostenAnalyseChart(fahrzeuge) {
            const monthlyData = aggregateByMonthWithDetails(fahrzeuge);
            const months = ['Jan', 'Feb', 'M√§r', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];

            const labels = months;
            const ersatzteileData = months.map((_, i) => monthlyData[i]?.ersatzteile || 0);
            const arbeitslohnData = months.map((_, i) => monthlyData[i]?.arbeitslohn || 0);
            const lackierungData = months.map((_, i) => monthlyData[i]?.lackierung || 0);
            const materialienData = months.map((_, i) => monthlyData[i]?.materialien || 0);

            kostenAnalyseChart.data.labels = labels;
            kostenAnalyseChart.data.datasets = [
                {
                    label: 'Ersatzteile',
                    data: ersatzteileData,
                    backgroundColor: '#ff9800'
                },
                {
                    label: 'Arbeitslohn',
                    data: arbeitslohnData,
                    backgroundColor: '#2196F3'
                },
                {
                    label: 'Lackierung',
                    data: lackierungData,
                    backgroundColor: '#9C27B0'
                },
                {
                    label: 'Materialien',
                    data: materialienData,
                    backgroundColor: '#009688'
                }
            ];

            kostenAnalyseChart.update();
        }

        // ============================================
        // AGGREGATE BY MONTH
        // ============================================
        function aggregateByMonth(fahrzeuge) {
            const monthlyData = {};

            for (let i = 0; i < 12; i++) {
                monthlyData[i] = { count: 0, umsatz: 0, kosten: 0 };
            }

            fahrzeuge.forEach(f => {
                if (!f.abgeschlossenAm) return;

                const date = f.abgeschlossenAm.toDate ? f.abgeschlossenAm.toDate() : new Date(f.abgeschlossenAm);
                const month = date.getMonth();

                monthlyData[month].count++;
                monthlyData[month].umsatz += parseFloat(f.gesamtsummeBrutto || 0);
                monthlyData[month].kosten += calculateNettoKosten(f);
            });

            return monthlyData;
        }

        // ============================================
        // AGGREGATE BY MONTH WITH DETAILS
        // ============================================
        function aggregateByMonthWithDetails(fahrzeuge) {
            const monthlyData = {};

            for (let i = 0; i < 12; i++) {
                monthlyData[i] = { ersatzteile: 0, arbeitslohn: 0, lackierung: 0, materialien: 0 };
            }

            fahrzeuge.forEach(f => {
                if (!f.abgeschlossenAm) return;

                const date = f.abgeschlossenAm.toDate ? f.abgeschlossenAm.toDate() : new Date(f.abgeschlossenAm);
                const month = date.getMonth();

                const data = f.pdfImport?.editedData || {};

                if (data.ersatzteile) {
                    monthlyData[month].ersatzteile += data.ersatzteile.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0);
                }
                if (data.arbeitslohn) {
                    monthlyData[month].arbeitslohn += data.arbeitslohn.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0);
                }
                if (data.lackierung) {
                    monthlyData[month].lackierung += data.lackierung.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0);
                }
                if (data.materialien) {
                    monthlyData[month].materialien += data.materialien.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0);
                }
            });

            return monthlyData;
        }

        // ============================================
        // FILTER BY PERIOD
        // ============================================
        function filterByPeriod(fahrzeuge, period) {
            if (period === 'all') return fahrzeuge;

            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            const currentQuarter = Math.floor(currentMonth / 3);

            return fahrzeuge.filter(f => {
                if (!f.abgeschlossenAm) return false;

                const date = f.abgeschlossenAm.toDate ? f.abgeschlossenAm.toDate() : new Date(f.abgeschlossenAm);
                const year = date.getFullYear();
                const month = date.getMonth();
                const quarter = Math.floor(month / 3);

                switch (period) {
                    case 'month':
                        return year === currentYear && month === currentMonth;
                    case 'quarter':
                        return year === currentYear && quarter === currentQuarter;
                    case 'year':
                        return year === currentYear;
                    default:
                        return true;
                }
            });
        }

        // ============================================
        // CALCULATE NETTO KOSTEN
        // ============================================
        function calculateNettoKosten(fahrzeug) {
            let kosten = 0;
            const data = fahrzeug.pdfImport?.editedData || {};

            if (data.ersatzteile) {
                kosten += data.ersatzteile.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0);
            }
            if (data.arbeitslohn) {
                kosten += data.arbeitslohn.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0);
            }
            if (data.lackierung) {
                kosten += data.lackierung.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0);
            }
            if (data.materialien) {
                kosten += data.materialien.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0);
            }

            return kosten;
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function formatCurrency(value) {
            return new Intl.NumberFormat('de-DE', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        function formatCurrencyShort(value) {
            if (value >= 1000000) {
                return (value / 1000000).toFixed(1) + 'M ‚Ç¨';
            } else if (value >= 1000) {
                return (value / 1000).toFixed(0) + 'k ‚Ç¨';
            }
            return value.toFixed(0) + ' ‚Ç¨';
        }
    </script>

    <!-- üåì THEME TOGGLE SCRIPT -->
    <script>
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            if (typeof feather !== 'undefined') feather.replace();
        }
    </script>
</body>
</html>
