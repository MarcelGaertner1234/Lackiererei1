<!DOCTYPE html>
<html lang="de">
<head>
    <!-- âœ… BUG #7 FIX: Service Type Normalization Registry -->
    <script src="../js/service-types.js?v=bug7-normalization"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fahrzeugbeschriftung | Partner Portal</title>

    <!-- ğŸ¨ Apple Liquid Glass Design System -->
    <link rel="stylesheet" href="../design-system.css">
    <link rel="stylesheet" href="../components.css">
    <link rel="stylesheet" href="../animations.css">
    <link rel="stylesheet" href="../mobile-first.css">

    <link rel="stylesheet" href="service-form-styles.css">
    <link rel="stylesheet" href="../mobile-responsive.css">
</head>
<body>
    <div class="main-layout">
        <!-- Wizard Sidebar -->
        <div class="wizard-sidebar">
            <div class="sidebar-title">Fortschritt</div>
            <div class="sidebar-steps" id="sidebarSteps">
                <div class="sidebar-step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">Fotos</div>
                    <div class="step-icon"></div>
                </div>
                <div class="sidebar-step pending" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">Fahrzeug</div>
                    <div class="step-icon"></div>
                </div>
                <div class="sidebar-step pending" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">Werbebeklebungs-Details</div>
                    <div class="step-icon"></div>
                </div>
                <div class="sidebar-step pending" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-label">Termin</div>
                    <div class="step-icon"></div>
                </div>
                <div class="sidebar-step pending" data-step="5">
                    <div class="step-number">5</div>
                    <div class="step-label">Zusammenfassung</div>
                    <div class="step-icon"></div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="container">
            <button id="btnThemeToggle" class="btn btn-theme-toggle" onclick="toggleTheme()" title="Theme wechseln">ğŸŒ™</button>

            <div class="header">
                <!-- Werkstatt Logo (dynamisch geladen) -->
                <div id="werkstattLogo" style="display: inline-block; vertical-align: middle; margin-right: 12px;"></div>
                <h1 style="display: inline-block; vertical-align: middle;">ğŸ“¢ Neue Fahrzeugbeschriftung Anfrage</h1>
                <p id="partnerName">Partner Portal</p>
            </div>

            <!-- Progress Indicator -->
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 20%;"></div>
                </div>
                <div class="progress-text" id="progressText">Schritt 1 von 5</div>
            </div>

            <!-- Wizard Container -->
            <div class="wizard-container" id="wizardContainer">

                <!-- Step 1: Fotos -->
                <div class="wizard-step active" data-step="1">
                    <div class="step-title">
                        <span class="icon">ğŸ“¸</span>
                        <span>Fahrzeugfotos hochladen</span>
                    </div>
                    <div class="form-group">
                        <label class="photo-upload" for="photoInput">
                            <div class="icon">ğŸ“·</div>
                            <div class="text">
                                Klicken Sie hier, um Fotos des Fahrzeugs aufzunehmen<br>
                                <small>(Mehrere Perspektiven empfohlen)</small>
                            </div>
                            <input type="file" id="photoInput" accept="image/*" multiple capture="environment">
                        </label>
                        <div class="photo-preview" id="photoPreview"></div>
                    </div>
                </div>

                <!-- Step 2: Fahrzeug -->
                <div class="wizard-step" data-step="2">
                    <div class="step-title">
                        <span class="icon">ğŸš—</span>
                        <span>Fahrzeug</span>
                    </div>
                    <div class="form-group">
                        <label for="kennzeichen">Kennzeichen *</label>
                        <input type="text" id="kennzeichen" placeholder="z.B. MOS-AB 123" required style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label for="marke">Marke *</label>
                        <select id="marke" required>
                            <option value="">Bitte wÃ¤hlen...</option>
                            <option value="Audi">Audi</option>
                            <option value="BMW">BMW</option>
                            <option value="Mercedes-Benz">Mercedes-Benz</option>
                            <option value="Volkswagen">Volkswagen</option>
                            <option value="Opel">Opel</option>
                            <option value="Ford">Ford</option>
                            <option value="Renault">Renault</option>
                            <option value="Peugeot">Peugeot</option>
                            <option value="Toyota">Toyota</option>
                            <option value="Hyundai">Hyundai</option>
                            <option value="Kia">Kia</option>
                            <option value="Mazda">Mazda</option>
                            <option value="Nissan">Nissan</option>
                            <option value="Skoda">Skoda</option>
                            <option value="Seat">Seat</option>
                            <option value="Fiat">Fiat</option>
                            <option value="Citroen">Citroen</option>
                            <option value="Dacia">Dacia</option>
                            <option value="Sonstige">Sonstige</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="modell">Modell *</label>
                        <input type="text" id="modell" placeholder="z.B. A4, 3er, Golf" required>
                    </div>
                </div>

                <!-- Step 3: Werbebeklebungs-Details -->
                <div class="wizard-step" data-step="3">
                    <div class="step-title">
                        <span class="icon">ğŸ“¢</span>
                        <span>Werbebeklebungs-Details</span>
                    </div>

                    <div class="form-group">
                        <label>Umfang der Beklebung *</label>
                        <div class="radio-group">
                            <label class="radio-option selected" onclick="selectUmfang(this, 'vollbeklebung')">
                                <input type="radio" name="umfang" value="vollbeklebung" checked>
                                <div class="label">ğŸšš Vollbeklebung</div>
                                <div class="description">Komplette Fahrzeugbeschriftung (alle Seiten)</div>
                            </label>
                            <label class="radio-option" onclick="selectUmfang(this, 'teilbeklebung')">
                                <input type="radio" name="umfang" value="teilbeklebung">
                                <div class="label">âœ‚ï¸ Teilbeklebung</div>
                                <div class="description">Bestimmte Bereiche (z.B. nur TÃ¼ren, Heck)</div>
                            </label>
                            <label class="radio-option" onclick="selectUmfang(this, 'logo-only')">
                                <input type="radio" name="umfang" value="logo-only">
                                <div class="label">ğŸ·ï¸ Nur Logo</div>
                                <div class="description">Logo-Platzierung ohne Text</div>
                            </label>
                            <label class="radio-option" onclick="selectUmfang(this, 'schriftzug')">
                                <input type="radio" name="umfang" value="schriftzug">
                                <div class="label">âœï¸ Schriftzug</div>
                                <div class="description">Text-Beschriftung ohne Logo</div>
                            </label>
                        </div>
                    </div>

                    <div class="form-group" id="bereicheGroup" style="display: none;">
                        <label>Beklebte Bereiche (fÃ¼r Teilbeklebung) *</label>
                        <div class="checkbox-group">
                            <label class="checkbox-option">
                                <input type="checkbox" name="bereiche" value="fahrertuer">
                                <span>ğŸšª FahrertÃ¼r</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="bereiche" value="beifahrertuer">
                                <span>ğŸšª BeifahrertÃ¼r</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="bereiche" value="hintertueren">
                                <span>ğŸšª HintertÃ¼ren</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="bereiche" value="seitenwaende">
                                <span>â†”ï¸ SeitenwÃ¤nde</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="bereiche" value="heck">
                                <span>ğŸ”™ Heck</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="bereiche" value="motorhaube">
                                <span>ğŸš— Motorhaube</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="bereiche" value="dach">
                                <span>ğŸ  Dach</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="bereiche" value="seitenspiegel">
                                <span>ğŸª Seitenspiegel</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Design-KomplexitÃ¤t *</label>
                        <div class="radio-group">
                            <label class="radio-option selected" onclick="selectKomplexitaet(this, 'einfach')">
                                <input type="radio" name="komplexitaet" value="einfach" checked>
                                <div class="label">ğŸ“ Einfach</div>
                                <div class="description">Text + Logo (1-2 Farben)</div>
                            </label>
                            <label class="radio-option" onclick="selectKomplexitaet(this, 'mittel')">
                                <input type="radio" name="komplexitaet" value="mittel">
                                <div class="label">ğŸ¨ Mittel</div>
                                <div class="description">Logo + Text + Grafiken (3-5 Farben)</div>
                            </label>
                            <label class="radio-option" onclick="selectKomplexitaet(this, 'komplex')">
                                <input type="radio" name="komplexitaet" value="komplex">
                                <div class="label">ğŸŒˆ Komplex</div>
                                <div class="description">VollflÃ¤chiges Design (6+ Farben)</div>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="textelemente">Textelemente *</label>
                        <textarea id="textelemente" rows="4" placeholder="Firmenname, Slogan, Kontaktdaten (Telefon, Website, E-Mail)..." required></textarea>
                        <small>Bitte geben Sie alle Texte an, die auf dem Fahrzeug erscheinen sollen</small>
                    </div>

                    <div class="form-group">
                        <label>Logo/Design Status *</label>
                        <div class="radio-group">
                            <label class="radio-option selected" onclick="selectLogoStatus(this, 'vorhanden')">
                                <input type="radio" name="logoStatus" value="vorhanden" checked>
                                <div class="label">âœ… Vorhanden</div>
                                <div class="description">Logo & Design liegen bereits vor</div>
                            </label>
                            <label class="radio-option" onclick="selectLogoStatus(this, 'nur-logo')">
                                <input type="radio" name="logoStatus" value="nur-logo">
                                <div class="label">ğŸ·ï¸ Nur Logo</div>
                                <div class="description">Nur Logo vorhanden, Design wird benÃ¶tigt</div>
                            </label>
                            <label class="radio-option" onclick="selectLogoStatus(this, 'design-service')">
                                <input type="radio" name="logoStatus" value="design-service">
                                <div class="label">ğŸ¨ Design-Service</div>
                                <div class="description">Logo & Design mÃ¼ssen erstellt werden</div>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="farbanzahl">Anzahl Farben *</label>
                        <input type="number" id="farbanzahl" min="1" max="10" value="2" required>
                        <small>Anzahl der verschiedenen Farben im Design (1-10)</small>
                    </div>

                    <div class="form-group">
                        <label for="werbebeklebungInfo">ZusÃ¤tzliche Anforderungen (Optional)</label>
                        <textarea id="werbebeklebungInfo" rows="3" placeholder="z.B. besondere WÃ¼nsche, Zeitrahmen, Referenzbilder..."></textarea>
                    </div>
                </div>

                <!-- Step 4: Termin -->
                <div class="wizard-step" data-step="4">
                    <div class="step-title">
                        <span class="icon">ğŸ“…</span>
                        <span>Wunschtermin</span>
                    </div>
                    <div class="form-group">
                        <label>GewÃ¼nschter Termin *</label>
                        <div class="termin-grid" id="terminGrid">
                            <div class="loading">
                                <div class="icon">â³</div>
                                <div>Lade verfÃ¼gbare Termine...</div>
                            </div>
                        </div>
                    </div>
                    <!-- ğŸ†• GAP-1c (2025-11-27): Ersatzfahrzeug Option -->
                    <div class="form-group">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="ersatzfahrzeugGewuenscht" style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                            <span style="font-size: 14px;">
                                ğŸš— Ersatzfahrzeug gewÃ¼nscht <small style="color: #999;">(+Aufpreis)</small>
                            </span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label for="anmerkungen">Anmerkungen zum Termin (Optional)</label>
                        <textarea id="anmerkungen" rows="3" placeholder="z.B. nur vormittags mÃ¶glich..."></textarea>
                    </div>
                </div>

                <!-- Step 5: Zusammenfassung -->
                <div class="wizard-step" data-step="5">
                    <div class="step-title">
                        <span class="icon">âœ…</span>
                        <span>Zusammenfassung</span>
                    </div>
                    <p style="color: #666; margin-bottom: 20px;">Bitte Ã¼berprÃ¼fen Sie Ihre Angaben vor dem Absenden:</p>
                    <div id="summaryContent"></div>
                </div>

            </div>

            <!-- Navigation Buttons -->
            <div class="wizard-nav">
                <button type="button" class="btn btn-back" id="btnBack" onclick="prevStep()" style="display: none;">
                    â† ZurÃ¼ck
                </button>
                <button type="button" class="btn btn-primary" id="btnNext" onclick="nextStep()">
                    Weiter â†’
                </button>
            </div>

            <!-- Success Message -->
            <div class="success-message" id="successMessage">
                <div class="icon">âœ…</div>
                <h3>Anfrage erfolgreich gesendet!</h3>
                <p>Wir melden uns schnellstmÃ¶glich mit einem Kostenvoranschlag bei Ihnen.</p>
                <button class="btn btn-primary" onclick="safeNavigate('meine-anfragen.html')">
                    Zu meinen Anfragen
                </button>
            </div>
        </div>
    </div><!-- End main-layout -->

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <script src="../firebase-config.js?v=a4192c4"></script>
    <script src="../js/settings-manager.js"></script>
    <script src="../js/auth-manager.js"></script>
    <script>
        // ğŸ†• FIX #1: FILE UPLOAD VALIDATION (2025-11-15)
        // Prevents: Malware uploads, XSS via SVG, Storage quota exhaustion
        window.validateImageFile = function(file) {
            const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
            const maxSize = 10 * 1024 * 1024; // 10 MB

            if (!file) {
                throw new Error('âŒ Keine Datei ausgewÃ¤hlt!');
            }

            // Check 1: File-Type Validation
            if (!allowedTypes.includes(file.type)) {
                throw new Error(`âŒ UngÃ¼ltiger Dateityp!\n\nErlaubt: JPEG, PNG, WebP\nDein Typ: ${file.type || 'unbekannt'}`);
            }

            // Check 2: Size Validation
            if (file.size > maxSize) {
                throw new Error(`âŒ Datei zu groÃŸ!\n\nMaximum: 10 MB\nDeine GrÃ¶ÃŸe: ${(file.size / 1024 / 1024).toFixed(2)} MB`);
            }

            console.log('âœ… [validateImageFile] Datei validiert:', {
                type: file.type,
                sizeMB: (file.size / 1024 / 1024).toFixed(2)
            });

            return { isValid: true };
        };

        // Global Variables
        let currentStep = 1;
        const totalSteps = 5;
        let partner = null;
        let photos = [];
        let selectedTermin = null;

        // ============================================
        // PRE-INITIALIZE werkstattId from localStorage
        // ============================================
        // CRITICAL: Set werkstattId BEFORE auth-check polling!
        // ğŸ”’ SECURITY FIX (2025-12-08): KEIN Fallback auf 'mosbach' mehr!
        const storedPartner = JSON.parse(localStorage.getItem('partner') || 'null');
        if (!storedPartner?.werkstattId) {
            console.error('âŒ [SECURITY] werkstattId fehlt! Partner muss sich neu einloggen.');
            window.location.href = 'partner-login.html?error=no_werkstatt';
            throw new Error('werkstattId fehlt - Multi-Tenant Isolation verletzt');
        }
        window.werkstattId = storedPartner.werkstattId;
        console.log('âœ… [WERBEBEKLEBUNG-ANFRAGE] werkstattId pre-initialized:', window.werkstattId);

        // AUTH-CHECK POLLING
        let authCheckAttempts = 0;
        const maxAuthCheckAttempts = 20;

        const authCheckInterval = setInterval(async () => {
            authCheckAttempts++;

            if (window.firebaseInitialized && window.werkstattId) {
                clearInterval(authCheckInterval);
                console.log('âœ… [WERBEBEKLEBUNG-ANFRAGE] Firebase ready');

                await initFirebase();
                checkLogin();
                // ğŸ”’ AUTH-FIX: loadTermine() wird jetzt im Auth-State-Listener aufgerufen
                setupAuthListener(); // NEU: Warte auf Auth Ready
                setupPhotoUpload();
                updateProgress();
                return;
            }

            if (authCheckAttempts >= maxAuthCheckAttempts) {
                clearInterval(authCheckInterval);
                console.error('âŒ [FOLIERUNG-ANFRAGE] Firebase timeout');
                showToast('Fehler: Werkstatt-Initialisierung fehlgeschlagen. Bitte neu einloggen.', 'error');
                safeNavigate('index.html');
            }
        }, 250);

        // Check Login
        function checkLogin() {
            partner = JSON.parse(localStorage.getItem('partner') || 'null');
            if (!partner) {
                safeNavigate('index.html');
                return;
            }

            // werkstattId initialization (Multi-Tenant)
            if (!partner.werkstattId) {
                console.error('âŒ Partner-Daten unvollstÃ¤ndig - werkstattId fehlt!');
                showToast('Fehler: Partner-Daten unvollstÃ¤ndig. Bitte melden Sie sich erneut an.', 'error');
                safeNavigate('index.html');
                return;
            }
            window.werkstattId = partner.werkstattId; // âœ… SECURITY FIX: No 'mosbach' fallback (validated above)
            console.log('âœ… [WERBEBEKLEBUNG-ANFRAGE] werkstattId initialized:', window.werkstattId);

            // Display partner name
            document.getElementById('partnerName').textContent = `Partner: ${partner.name}`;

            // Load Werkstatt-Logo & Branding
            (async () => {
                try {
                    const settings = await window.settingsManager.loadSettings();
                    if (settings?.profil) {
                        // Update Page Title
                        document.title = `${settings.profil.name} | Werbebeklebungs-Service`;

                        // Display Logo
                        if (settings.profil.logoUrl) {
                            const logoContainer = document.getElementById('werkstattLogo');
                            if (logoContainer) {
                                logoContainer.innerHTML = `
                                    <img src="${settings.profil.logoUrl}"
                                         alt="${settings.profil.name}"
                                         style="height: 32px; width: auto; vertical-align: middle;">
                                `;
                                console.log('âœ… [PARTNER-WERBEBEKLEBUNG] Werkstatt-Logo angezeigt:', settings.profil.name);
                            }
                        }
                    }
                } catch (error) {
                    console.warn('âš ï¸ [PARTNER-WERBEBEKLEBUNG] Werkstatt-Branding konnte nicht geladen werden:', error);
                }
            })();
        }

        // ğŸ”’ AUTH-FIX: Auth-State-Listener fÃ¼r Kalender-Loading
        function setupAuthListener() {
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    console.log('âœ… Auth ready, loading calendar...');
                    loadTermine();
                }
            });
        }

        // Initialize Firebase
        async function initFirebase() {
            if (typeof firebase === 'undefined') {
                console.error('Firebase SDK not loaded');
                return;
            }

            // Wait for firebase-config.js to initialize
            if (window.firebaseInitialized) {
                await window.firebaseInitialized;
            }
        }

        // ============================================
        // PROGRESS & NAVIGATION
        // ============================================
        function updateProgress() {
            const percent = (currentStep / totalSteps) * 100;
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = `Schritt ${currentStep} von ${totalSteps}`;
        }

        function updateButtons() {
            const btnBack = document.getElementById('btnBack');
            const btnNext = document.getElementById('btnNext');

            if (currentStep === 1) {
                btnBack.style.display = 'none';
            } else {
                btnBack.style.display = 'inline-flex';
            }

            if (currentStep === totalSteps) {
                btnNext.textContent = 'Anfrage senden';
            } else {
                btnNext.textContent = 'Weiter â†’';
            }
        }

        function updateSidebar() {
            const sidebarSteps = document.querySelectorAll('.sidebar-step');

            sidebarSteps.forEach((step, index) => {
                const stepNumber = index + 1;

                // Remove all state classes
                step.classList.remove('completed', 'active', 'pending');

                // Add appropriate class based on current step
                if (stepNumber < currentStep) {
                    step.classList.add('completed');
                } else if (stepNumber === currentStep) {
                    step.classList.add('active');
                } else {
                    step.classList.add('pending');
                }
            });
        }

        // Validation per Step
        function validateStep(step) {
            switch(step) {
                case 1: // Photos optional for dellen
                    return true;

                case 2: // Fahrzeug
                    const kennzeichen = document.getElementById('kennzeichen').value.trim();
                    const marke = document.getElementById('marke').value;
                    const modell = document.getElementById('modell').value.trim();

                    if (!kennzeichen) {
                        showToast('Bitte geben Sie das Kennzeichen ein.', 'warning');
                        return false;
                    }
                    if (!marke || marke === '') {
                        showToast('Bitte wÃ¤hlen Sie die Fahrzeugmarke aus.', 'warning');
                        return false;
                    }
                    if (!modell) {
                        showToast('Bitte geben Sie das Fahrzeugmodell ein.', 'warning');
                        return false;
                    }
                    return true;

                case 3: // Werbebeklebungs-Details
                    const umfang = document.querySelector('input[name="umfang"]:checked');
                    const komplexitaet = document.querySelector('input[name="komplexitaet"]:checked');
                    const textelemente = document.getElementById('textelemente').value.trim();
                    const logoStatus = document.querySelector('input[name="logoStatus"]:checked');
                    const farbanzahl = document.getElementById('farbanzahl').value;

                    if (!umfang) {
                        showToast('Bitte wÃ¤hlen Sie den Umfang der Beklebung aus.', 'warning');
                        return false;
                    }
                    if (umfang.value === 'teilbeklebung') {
                        const bereiche = document.querySelectorAll('input[name="bereiche"]:checked');
                        if (bereiche.length === 0) {
                            showToast('Bitte wÃ¤hlen Sie mindestens einen Bereich aus.', 'warning');
                            return false;
                        }
                    }
                    if (!komplexitaet) {
                        showToast('Bitte wÃ¤hlen Sie die Design-KomplexitÃ¤t aus.', 'warning');
                        return false;
                    }
                    if (!textelemente) {
                        showToast('Bitte geben Sie die Textelemente ein.', 'warning');
                        return false;
                    }
                    if (!logoStatus) {
                        showToast('Bitte wÃ¤hlen Sie den Logo/Design Status aus.', 'warning');
                        return false;
                    }
                    if (!farbanzahl || farbanzahl < 1 || farbanzahl > 10) {
                        showToast('Bitte geben Sie eine gÃ¼ltige Farbanzahl ein (1-10).', 'warning');
                        return false;
                    }
                    return true;

                case 4: // Termin
                    if (!selectedTermin) {
                        showToast('Bitte wÃ¤hlen Sie einen Wunschtermin aus.', 'warning');
                        return false;
                    }
                    return true;

                default:
                    return true;
            }
        }

        // Navigation Functions
        function nextStep() {
            // Validate current step
            if (!validateStep(currentStep)) {
                return;
            }

            if (currentStep === totalSteps) {
                submitAnfrage();
                return;
            }

            // Move to next step
            const currentStepEl = document.querySelector(`.wizard-step[data-step="${currentStep}"]`);
            const nextStepEl = document.querySelector(`.wizard-step[data-step="${currentStep + 1}"]`);

            currentStepEl.classList.remove('active');
            currentStepEl.classList.add('prev');

            setTimeout(() => {
                currentStepEl.classList.remove('prev');
            }, 400);

            nextStepEl.classList.add('active');

            currentStep++;
            updateProgress();
            updateButtons();
            updateSidebar();

            // Generate summary on step 5
            if (currentStep === totalSteps) {
                generateSummary();
            }

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function prevStep() {
            if (currentStep === 1) return;

            const currentStepEl = document.querySelector(`.wizard-step[data-step="${currentStep}"]`);
            const prevStepEl = document.querySelector(`.wizard-step[data-step="${currentStep - 1}"]`);

            currentStepEl.classList.remove('active');
            prevStepEl.classList.add('active');

            currentStep--;
            updateProgress();
            updateButtons();
            updateSidebar();

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ============================================
        // PHOTO UPLOAD
        // ============================================
        function setupPhotoUpload() {
            const input = document.getElementById('photoInput');
            window.listenerRegistry.registerDOM(input, 'change', handlePhotoUpload, 'input change');
        }

        async function handlePhotoUpload(event) {
            const files = Array.from(event.target.files);

            for (const file of files) {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        photos.push(e.target.result);
                        displayPhotos();
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        function displayPhotos() {
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = '';

            photos.forEach((photo, index) => {
                const div = document.createElement('div');
                div.className = 'photo-preview-item';
                div.innerHTML = `
                    <img src="${photo}" alt="Foto ${index + 1}">
                    <button type="button" class="remove-btn" onclick="removePhoto(${index})">Ã—</button>
                `;
                preview.appendChild(div);
            });
        }

        function removePhoto(index) {
            photos.splice(index, 1);
            displayPhotos();
        }

        // ============================================
        // FIREBASE STORAGE UPLOAD (FIX: 1MB Firestore Limit)
        // ============================================
        async function uploadPhotosToStorage(photoBase64Array, anfrageId) {
            if (!firebase.storage) {
                console.warn('âš ï¸ Firebase Storage not available - fallback to Base64');
                return photoBase64Array;
            }

            const storage = firebase.storage();
            const uploadedURLs = [];
            const btnNext = document.getElementById('btnNext');

            console.log(`ğŸ“¤ Uploading ${photoBase64Array.length} photos to Firebase Storage...`);

            for (let i = 0; i < photoBase64Array.length; i++) {
                try {
                    const base64 = photoBase64Array[i];

                    if (btnNext) {
                        btnNext.textContent = `Fotos hochladen (${i + 1}/${photoBase64Array.length})...`;
                    }

                    const response = await fetch(base64);
                    const blob = await response.blob();

                    // ğŸ†• FIX #1: Validate file BEFORE upload (Security)
                    try {
                        window.validateImageFile(blob);
                    } catch (validationError) {
                        console.error('âŒ [UPLOAD] Validation failed:', validationError.message);
                        showToast(validationError.message, 'error');
                        btnNext.disabled = false;
                        btnNext.textContent = 'Weiter â†’';
                        return; // Stop upload
                    }

                    const timestamp = Date.now();
                    const filename = `photo_${i}_${timestamp}.jpg`;
                    const storagePath = `partner-anfragen/${partner.werkstattId}/${anfrageId}/${filename}`;
                    const storageRef = storage.ref(storagePath);

                    console.log(`  ğŸ“¤ Uploading photo ${i + 1}/${photoBase64Array.length}: ${storagePath}`);
                    await storageRef.put(blob);

                    const downloadURL = await storageRef.getDownloadURL();
                    uploadedURLs.push(downloadURL);
                    console.log(`  âœ… Photo ${i + 1} uploaded: ${downloadURL.substring(0, 60)}...`);

                } catch (error) {
                    console.error(`âŒ Error uploading photo ${i + 1}:`, error);
                }
            }

            console.log(`âœ… All ${uploadedURLs.length}/${photoBase64Array.length} photos uploaded successfully`);
            return uploadedURLs;
        }

        // ============================================
        // RADIO OPTION SELECTION
        // ============================================
        function selectUmfang(element, value) {
            // Remove selected class from all options
            element.closest('.radio-group').querySelectorAll('.radio-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            // Add selected class to clicked option
            element.classList.add('selected');
            // Check the radio input
            element.querySelector('input[type="radio"]').checked = true;

            // Show/hide bereiche group based on selection
            const bereicheGroup = document.getElementById('bereicheGroup');
            if (value === 'teilbeklebung') {
                bereicheGroup.style.display = 'block';
            } else {
                bereicheGroup.style.display = 'none';
            }
        }

        function selectKomplexitaet(element, value) {
            // Remove selected class from all options
            element.closest('.radio-group').querySelectorAll('.radio-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            // Add selected class to clicked option
            element.classList.add('selected');
            // Check the radio input
            element.querySelector('input[type="radio"]').checked = true;
        }

        function selectLogoStatus(element, value) {
            // Remove selected class from all options
            element.closest('.radio-group').querySelectorAll('.radio-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            // Add selected class to clicked option
            element.classList.add('selected');
            // Check the radio input
            element.querySelector('input[type="radio"]').checked = true;
        }

        // ============================================
        // TERMIN SELECTION
        // ============================================
        async function loadTermine() {
            const terminGrid = document.getElementById('terminGrid');

            if (!window.db) {
                console.error('Firebase nicht initialisiert');
                terminGrid.innerHTML = '<div class="loading"><div style="color: red;">Fehler beim Laden der Termine</div></div>';
                return;
            }

            try {
                const heute = new Date();
                heute.setHours(0, 0, 0, 0);

                const endDate = new Date(heute);
                endDate.setDate(endDate.getDate() + 21);

                // ğŸ”’ SECURITY: Get current user email for Query-Rule Compliance
                const currentUser = firebase.auth().currentUser;
                if (!currentUser) {
                    console.warn('âš ï¸ User not authenticated yet, skipping calendar load');
                    return;
                }
                const userEmail = currentUser.email.toLowerCase();

                // Query Firestore for existing appointments
                // ğŸ”’ SECURITY: Filter by partnerEmail for Query-Rule Compliance
                const snapshot = await window.getCollection('fahrzeuge')
                    .where('partnerEmail', '==', userEmail)
                    .where('anliefertermin', '>=', heute.toISOString())
                    .where('anliefertermin', '<=', endDate.toISOString())
                    .get();

                // Calculate workload per day
                const auslastung = {};
                snapshot.forEach(doc => {
                    const termin = doc.data().anliefertermin;
                    if (termin) {
                        const date = termin.split('T')[0];
                        auslastung[date] = (auslastung[date] || 0) + 1;
                    }
                });

                // Generate available dates (exclude Sundays)
                const dates = [];
                for (let i = 1; i <= 21; i++) {
                    const date = new Date(heute);
                    date.setDate(date.getDate() + i);
                    if (date.getDay() !== 0) { // Skip Sundays
                        const dateStr = date.toISOString().split('T')[0];
                        const workload = auslastung[dateStr] || 0;
                        dates.push({
                            datum: date,
                            dateStr: dateStr,
                            auslastung: workload === 0 ? 'frei' : workload <= 2 ? 'normal' : 'voll'
                        });
                    }
                }

                // Show 4 intelligently selected dates
                const selectedTermine = [
                    dates.find(d => d.auslastung === 'frei') || dates[0], // First free date
                    dates[Math.floor(dates.length * 0.33)], // ~1 week
                    dates[Math.floor(dates.length * 0.66)], // ~2 weeks
                    dates[dates.length - 1] // Last available
                ];

                terminGrid.innerHTML = selectedTermine.map((t, idx) => {
                    const auslastungIcon = t.auslastung === 'frei' ? 'ğŸŸ¢' : t.auslastung === 'normal' ? 'ğŸŸ¡' : 'ğŸ”´';
                    const auslastungText = t.auslastung === 'frei' ? 'Freie KapazitÃ¤t' : t.auslastung === 'normal' ? 'Normale Auslastung' : 'Ausgelastet';
                    const wochentag = t.datum.toLocaleDateString('de-DE', { weekday: 'short' });
                    const tag = t.datum.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });

                    return `
                        <label class="termin-option" onclick="selectTermin('${t.dateStr}')">
                            <input type="radio" name="termin" value="${t.dateStr}">
                            <div class="weekday">${wochentag}</div>
                            <div class="day">${tag}</div>
                            <div class="indicator">${auslastungIcon} ${auslastungText}</div>
                        </label>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading termine:', error);
                terminGrid.innerHTML = '<div class="loading"><div style="color: red;">Fehler beim Laden der Termine</div></div>';
            }
        }

        function selectTermin(dateStr) {
            // Remove previous selection
            document.querySelectorAll('.termin-option').forEach(opt => {
                opt.classList.remove('selected');
            });

            // Select clicked termin
            const option = document.querySelector(`.termin-option input[value="${dateStr}"]`).closest('.termin-option');
            option.classList.add('selected');
            selectedTermin = dateStr;
        }

        // ============================================
        // SUMMARY GENERATION
        // ============================================
        function generateSummary() {
            // ğŸ†• FIX (2025-12-01): Null-safety fÃ¼r querySelector (verhindert TypeError bei fehlendem Radio-Button)
            const umfang = document.querySelector('input[name="umfang"]:checked')?.value || 'vollbeklebung';
            const umfangLabels = {
                'vollbeklebung': 'ğŸšš Vollbeklebung',
                'teilbeklebung': 'âœ‚ï¸ Teilbeklebung',
                'logo-only': 'ğŸ·ï¸ Nur Logo',
                'schriftzug': 'âœï¸ Schriftzug'
            };

            // ğŸ†• FIX (2025-12-01): Null-safety fÃ¼r querySelector
            const komplexitaet = document.querySelector('input[name="komplexitaet"]:checked')?.value || 'einfach';
            const komplexitaetLabels = {
                'einfach': 'ğŸ“ Einfach',
                'mittel': 'ğŸ¨ Mittel',
                'komplex': 'ğŸŒˆ Komplex'
            };

            // ğŸ†• FIX (2025-12-01): Null-safety fÃ¼r querySelector
            const logoStatus = document.querySelector('input[name="logoStatus"]:checked')?.value || 'vorhanden';
            const logoStatusLabels = {
                'vorhanden': 'âœ… Vorhanden',
                'nur-logo': 'ğŸ·ï¸ Nur Logo',
                'design-service': 'ğŸ¨ Design-Service'
            };

            const bereiche = umfang === 'teilbeklebung' ?
                Array.from(document.querySelectorAll('input[name="bereiche"]:checked')).map(cb => cb.value) : [];

            const bereicheLabels = {
                'fahrertuer': 'ğŸšª FahrertÃ¼r',
                'beifahrertuer': 'ğŸšª BeifahrertÃ¼r',
                'hintertueren': 'ğŸšª HintertÃ¼ren',
                'seitenwaende': 'â†”ï¸ SeitenwÃ¤nde',
                'heck': 'ğŸ”™ Heck',
                'motorhaube': 'ğŸš— Motorhaube',
                'dach': 'ğŸ  Dach',
                'seitenspiegel': 'ğŸª Seitenspiegel'
            };

            const summaryContent = document.getElementById('summaryContent');
            summaryContent.innerHTML = `
                <div class="summary-section">
                    <h3>ğŸš— Fahrzeug</h3>
                    <p><strong>Kennzeichen:</strong> ${document.getElementById('kennzeichen').value}</p>
                    <p><strong>Marke:</strong> ${document.getElementById('marke').value}</p>
                    <p><strong>Modell:</strong> ${document.getElementById('modell').value}</p>
                </div>
                <div class="summary-section">
                    <h3>ğŸ“¢ Werbebeklebungs-Details</h3>
                    <p><strong>Umfang:</strong> ${umfangLabels[umfang]}</p>
                    ${bereiche.length > 0 ? `
                        <p><strong>Bereiche:</strong></p>
                        <ul>
                            ${bereiche.map(b => `<li>${bereicheLabels[b]}</li>`).join('')}
                        </ul>
                    ` : ''}
                    <p><strong>Design-KomplexitÃ¤t:</strong> ${komplexitaetLabels[komplexitaet]}</p>
                    <p><strong>Textelemente:</strong><br>${document.getElementById('textelemente').value}</p>
                    <p><strong>Logo/Design Status:</strong> ${logoStatusLabels[logoStatus]}</p>
                    <p><strong>Anzahl Farben:</strong> ${document.getElementById('farbanzahl').value}</p>
                    ${document.getElementById('werbebeklebungInfo').value ? `
                        <p><strong>ZusÃ¤tzliche Anforderungen:</strong><br>${document.getElementById('werbebeklebungInfo').value}</p>
                    ` : ''}
                </div>
                <div class="summary-section">
                    <h3>ğŸ“… Termin</h3>
                    <p><strong>Wunschtermin:</strong> ${new Date(selectedTermin).toLocaleDateString('de-DE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                    ${document.getElementById('anmerkungen').value ? `
                        <p><strong>Anmerkungen:</strong> ${document.getElementById('anmerkungen').value}</p>
                    ` : ''}
                </div>
                <div class="summary-section">
                    <h3>ğŸ“· Fotos</h3>
                    <p>${photos.length} Foto(s) hochgeladen</p>
                </div>
            `;
        }

        // ============================================
        // SUBMIT ANFRAGE
        // ============================================
        async function submitAnfrage() {
            const btnNext = document.getElementById('btnNext');
            btnNext.disabled = true;
            btnNext.textContent = 'Wird gesendet...';

            try {
                // Generate anfrage ID first (needed for Storage path)
                const anfrageId = 'req_' + Date.now();

                // Compress photos
                btnNext.textContent = 'Fotos komprimieren...';
                const compressedPhotos = await Promise.all(photos.map(photo => compressImage(photo)));
                console.log(`âœ… ${compressedPhotos.length} Fotos komprimiert`);

                // âœ… FIX: Upload photos to Firebase Storage
                btnNext.textContent = 'Fotos hochladen...';
                const photoURLs = await uploadPhotosToStorage(compressedPhotos, anfrageId);
                console.log(`âœ… ${photoURLs.length} Foto-URLs erhalten`);

                // Get form data
                // ğŸ†• FIX (2025-12-01): Null-safety fÃ¼r querySelector (verhindert TypeError bei fehlendem Radio-Button)
                const umfang = document.querySelector('input[name="umfang"]:checked')?.value || 'vollbeklebung';
                const komplexitaet = document.querySelector('input[name="komplexitaet"]:checked')?.value || 'einfach';
                const logoStatus = document.querySelector('input[name="logoStatus"]:checked')?.value || 'vorhanden';
                const bereiche = umfang === 'teilbeklebung' ?
                    Array.from(document.querySelectorAll('input[name="bereiche"]:checked')).map(cb => cb.value) : [];

                // Create anfrage data
                btnNext.textContent = 'Anfrage speichern...';
                const timestamp = new Date().toISOString();
                const anfrageData = {
                    id: anfrageId,  // Use pre-generated ID
                    partnerId: partner.partnerId || partner.id,
                    partnerName: partner.name,
                    partnerEmail: firebase.auth().currentUser.email.toLowerCase(),
                    kundenEmail: firebase.auth().currentUser.email.toLowerCase(),
                    serviceTyp: 'werbebeklebung',
                    timestamp: timestamp,
                    erstelltAm: timestamp,

                    // ğŸ”§ FIX Bug #3 (2025-12-01): Audit-Trail & Multi-Tenant Compliance
                    werkstattId: window.werkstattId || partner.werkstattId || 'mosbach',
                    createdBy: firebase.auth().currentUser.uid,
                    createdByEmail: firebase.auth().currentUser.email.toLowerCase(),

                    serviceData: {
                        umfang: umfang,
                        komplexitaet: komplexitaet,
                        text: document.getElementById('textelemente').value.trim(),
                        logoStatus: logoStatus,
                        // ğŸ†• FIX: Fallback auf 1 wenn Feld leer ist
                        farbanzahl: parseInt(document.getElementById('farbanzahl').value, 10) || 1,
                        bereiche: bereiche,
                        info: document.getElementById('werbebeklebungInfo').value.trim()
                    },
                    kennzeichen: document.getElementById('kennzeichen').value.trim().toUpperCase(),
                    marke: document.getElementById('marke').value,
                    modell: document.getElementById('modell').value.trim(),
                    anliefertermin: selectedTermin,
                    anmerkungen: document.getElementById('anmerkungen').value.trim(),
                    fotos: photoURLs,  // âœ… CHANGED: Store URLs instead of Base64
                    fotoCount: photoURLs.length,  // âœ… ADDED: Quick count
                    ersatzfahrzeugGewuenscht: document.getElementById('ersatzfahrzeugGewuenscht')?.checked || false,  // ğŸ†• GAP-1c (2025-11-27)
                    status: 'neu',
                    statusText: 'Neu eingegangen',
                    kva: null,
                    fahrzeugId: null
                };

                // ğŸ†• FIX (2025-12-01): Defense in Depth - validateServiceTyp vor Firestore Save
                if (typeof window.validateServiceTyp === 'function') {
                    anfrageData.serviceTyp = window.validateServiceTyp(anfrageData.serviceTyp);
                }

                // Save to Firestore
                await window.getCollection('partnerAnfragen').doc(anfrageData.id).set(anfrageData);

                // Show success message
                document.getElementById('successMessage').style.display = 'flex';
                document.querySelector('.wizard-container').style.display = 'none';
                document.querySelector('.wizard-nav').style.display = 'none';

            } catch (error) {
                console.error('Error submitting anfrage:', error);
                showToast('Fehler beim Senden der Anfrage: ' + error.message, 'error');
                btnNext.disabled = false;
                btnNext.textContent = 'Anfrage senden';
            }
        }

        // ============================================
        // IMAGE COMPRESSION
        // ============================================
        function compressImage(base64Image) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // Max dimensions
                    const maxWidth = 1920;
                    const maxHeight = 1080;

                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth || height > maxHeight) {
                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                        width = width * ratio;
                        height = height * ratio;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);

                    // Compress to 85% quality
                    resolve(canvas.toDataURL('image/jpeg', 0.85));
                };
                img.src = base64Image;
            });
        }

        // Theme Toggle Function
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            const btnToggle = document.getElementById('btnThemeToggle');
            if (btnToggle) {
                btnToggle.textContent = newTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
            }
        }

        // Initialize Theme on Load
        (function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            const btnToggle = document.getElementById('btnThemeToggle');
            if (btnToggle) {
                btnToggle.textContent = savedTheme === 'dark' ? 'â˜€ï¸' : 'ğŸŒ™';
            }
        })();
    </script>
    <script src="../listener-registry.js"></script>
    <script src="../error-handler.js"></script>
</body>
</html>
