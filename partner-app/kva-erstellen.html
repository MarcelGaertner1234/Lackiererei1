<!DOCTYPE html>
<html lang="de">
<head>
    <!-- üåì FOUC Prevention: Load Theme BEFORE CSS to prevent flash -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>

    <script>
        // ‚úÖ BUG #5 FIX: Global DEBUG flag for conditional logging
        window.DEBUG = (
            localStorage.getItem('DEBUG') === 'true' ||
            window.location.search.includes('debug=true') ||
            window.location.hostname === 'localhost' ||
            window.location.port === '8000'
        );
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kostenvoranschlag erstellen | Admin</title>

    <!-- Design System -->
    <link rel="stylesheet" href="../design-system.css">

    <!-- üõ°Ô∏è PERFORMANCE FIX Phase 2: Ausgelagertes CSS -->
    <link rel="stylesheet" href="css/kva-erstellen.css">

    <!-- Mobile-Responsive CSS Framework -->
    <link rel="stylesheet" href="../mobile-responsive.css">

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

    <!-- jsPDF for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- PDF.js for PDF Parsing -->
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
</head>
<body>
    <!-- üåì THEME TOGGLE BUTTON -->
    <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle Light/Dark Mode">
        <span class="icon-light">‚òÄÔ∏è</span>
        <span class="icon-dark">üåô</span>
    </button>

    <div class="container">
        <div class="header">
            <h1>Kostenvoranschlag erstellen</h1>
            <p>Partner-Anfrage pr√ºfen und KVA erstellen</p>
        </div>

        <div class="nav-buttons">
            <a href="admin-anfragen.html" class="btn btn-secondary">‚Üê Zur√ºck zu Anfragen</a>
        </div>

        <!-- PDF-UPLOAD SECTION -->
        <div class="pdf-upload-section" style="background: #f0f9ff; padding: 15px; border-radius: 10px; border-left: 4px solid #003366; margin: 20px 0;">
            <div style="margin-bottom: 10px;">
                <strong style="color: #003366;">üìÑ DAT-Kalkulation hochladen (optional)</strong>
                <p style="color: #666; font-size: 13px; margin: 5px 0;">Ersatzteile, Arbeitsl√∂hne und Lackierung werden automatisch √ºbernommen</p>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <button type="button" class="btn btn-secondary" style="font-size: 14px;"
                        onclick="document.getElementById('datKvaPdfInput').click()">
                    üìÑ PDF ausw√§hlen
                </button>
                <input type="file" id="datKvaPdfInput" accept="application/pdf" style="display: none;">
                <span id="kvaPdfFileName" style="color: #28a745; font-size: 14px;"></span>
                <button type="button" id="kvaPdfRemoveBtn" class="btn-icon-small"
                        style="display: none; background: transparent; border: none; cursor: pointer; font-size: 18px;"
                        onclick="removeKvaPdf()">‚ùå</button>
            </div>
        </div>

        <div id="loading" class="loading">
            <p>Anfrage wird geladen...</p>
        </div>

        <div id="errorBox" class="error-box"></div>

        <div id="contentArea" style="display: none;">
            <!-- Anfrage-Info -->
            <div class="info-box" id="anfrageInfo">
                <!-- Wird dynamisch gef√ºllt -->
            </div>

            <!-- KVA-Formular -->
            <form id="kvaForm">
                <div class="section-title" id="kvaTitle">Kostenaufstellung</div>
                <p style="color: #666; font-size: 14px; margin-bottom: 20px;" id="kvaDescription">
                    Erstellen Sie ein Kosten-Angebot f√ºr den Partner.
                </p>

                <!-- DYNAMISCHER VARIANTEN-CONTAINER (wird per JavaScript gef√ºllt) -->
                <div id="variantenContainer"></div>

                <!-- ‚úÖ VARIANTEN-TABELLEN CONTAINER (wird dynamisch generiert) -->
                <div id="variantTabellenContainer">
                    <!-- Wird durch renderVariantTables() gef√ºllt -->
                    <p style="color: #999; text-align: center; padding: 20px;">
                        ‚è≥ Varianten-Tabellen werden geladen...
                    </p>
                </div>

                <!-- ‚úÖ PHASE 2d: ERSATZFAHRZEUG - Wird jetzt PRO VARIANTE in der Kostenaufschl√ºsselung angezeigt -->
                <!-- (Separate Section entfernt - Ersatzfahrzeug erscheint in jeder Varianten-Tabelle) -->

                <!-- Termine statt vage Lieferzeit -->
                <div class="section-title" id="terminSectionTitle">üìÖ Service-Termin</div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="startDatum" id="startDatumLabel">Service Start (von) *</label>
                        <input type="date" id="startDatum" required onchange="berechneErsatzfahrzeugTage()">
                        <small style="color: #666; display: block; margin-top: 5px;">Wann k√∂nnen wir starten?</small>
                    </div>
                    <div class="form-group">
                        <label for="endDatum">Abholung bereit (bis) *</label>
                        <input type="date" id="endDatum" required onchange="berechneErsatzfahrzeugTage()">
                        <small style="color: #666; display: block; margin-top: 5px;">Wann ist das Fahrzeug fertig?</small>
                    </div>
                </div>
                <div class="form-group">
                    <label for="abholzeit">Abholzeit (optional)</label>
                    <input type="time" id="abholzeit" placeholder="z.B. 14:00">
                    <small style="color: #666; display: block; margin-top: 5px;">Uhrzeit f√ºr die Abholung (wird in Kalender eingetragen)</small>
                </div>

                <div class="form-group">
                    <label for="notizen">Interne Notizen (optional)</label>
                    <textarea id="notizen" placeholder="Zus√§tzliche Informationen zur Kalkulation..."></textarea>
                </div>

                <div style="display: flex; gap: 10px; width: 100%;">
                    <button type="button" class="btn btn-secondary" onclick="downloadKVAPDF()" style="flex: 1;">
                        üìÑ Als PDF herunterladen
                    </button>
                    <button type="submit" class="btn btn-primary" style="flex: 2;" id="submitBtn">
                        ‚úÖ KVA an Partner senden
                    </button>
                </div>
            </form>
        </div>

        <div class="success-message" id="successMessage">
            <div class="icon">‚úÖ</div>
            <h3>KVA erfolgreich erstellt!</h3>
            <p>Der Kostenvoranschlag wurde an den Partner gesendet.</p>
            <button class="btn btn-primary" onclick="window.safeNavigate('admin-anfragen.html')" style="margin-top: 20px;">
                Zur√ºck zur √úbersicht
            </button>
        </div>
    </div>


    <script src="../firebase-config.js?v=a4192c4"></script>

    <!-- üõ°Ô∏è PERFORMANCE FIX Phase 2: Ausgelagertes JavaScript -->
    <script src="js/kva-erstellen.js"></script>

    <script src="../listener-registry.js"></script>
    <script src="../error-handler.js"></script>

    <!-- üåì THEME TOGGLE SCRIPT -->
    <script>
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            console.log(`üåì Theme toggled: ${currentTheme} ‚Üí ${newTheme}`);
        }
    </script>
</body>
</html>
