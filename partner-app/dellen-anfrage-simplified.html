<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dellen-Dr√ºckung | Partner Portal</title>
    <link rel="stylesheet" href="service-form-styles.css">
</head>
<body>
    <div class="main-layout">
        <!-- Wizard Sidebar -->
        <div class="wizard-sidebar">
            <div class="sidebar-header">
                <h2>üî® Dellen-Dr√ºckung</h2>
                <p>PDR - Smart Repair ohne Lackierung</p>
            </div>
            <div class="sidebar-steps">
                <div class="sidebar-step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">Fotos</div>
                    <div class="step-icon"></div>
                </div>
                <div class="sidebar-step pending" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">Fahrzeug</div>
                    <div class="step-icon"></div>
                </div>
                <div class="sidebar-step pending" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">Dellen-Details</div>
                    <div class="step-icon"></div>
                </div>
                <div class="sidebar-step pending" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-label">Termin</div>
                    <div class="step-icon"></div>
                </div>
                <div class="sidebar-step pending" data-step="5">
                    <div class="step-number">5</div>
                    <div class="step-label">Zusammenfassung</div>
                    <div class="step-icon"></div>
                </div>
            </div>
            <div class="sidebar-footer">
                <button onclick="window.location.href='service-auswahl.html'" class="btn-back">‚Üê Zur√ºck zur Auswahl</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="container">
            <button id="btnThemeToggle" class="btn btn-theme-toggle" onclick="toggleTheme()" title="Theme wechseln">üåô</button>

            <!-- Step 1: Fotos -->
            <div class="wizard-step active" data-step="1">
                <div class="step-title">üì∏ Dellen-Fotos</div>
                <div class="step-description">
                    ‚ö†Ô∏è Wichtig: Mindestens 1 Foto der Delle(n) erforderlich!
                </div>
                <label class="photo-upload" for="photoInput">
                    <span class="upload-icon">üì∑</span>
                    <span class="upload-text">Fotos ausw√§hlen oder hier ablegen</span>
                    <input type="file" id="photoInput" accept="image/*" multiple required>
                </label>
                <div class="photo-preview" id="photoPreview"></div>
                <button class="btn-primary" onclick="nextStep(2)">Weiter ‚Üí</button>
            </div>

            <!-- Step 2: Fahrzeug -->
            <div class="wizard-step" data-step="2">
                <div class="step-title">üöó Fahrzeug</div>
                <div class="form-group">
                    <label for="kennzeichen">Kennzeichen *</label>
                    <input type="text" id="kennzeichen" placeholder="MOS-CG 123" required>
                </div>
                <div class="form-group">
                    <label for="marke">Marke *</label>
                    <select id="marke" required>
                        <option value="">Bitte w√§hlen...</option>
                        <option value="Audi">Audi</option>
                        <option value="BMW">BMW</option>
                        <option value="Mercedes-Benz">Mercedes-Benz</option>
                        <option value="Volkswagen">Volkswagen</option>
                        <option value="Opel">Opel</option>
                        <option value="Ford">Ford</option>
                        <option value="Renault">Renault</option>
                        <option value="Peugeot">Peugeot</option>
                        <option value="Toyota">Toyota</option>
                        <option value="Hyundai">Hyundai</option>
                        <option value="Kia">Kia</option>
                        <option value="Mazda">Mazda</option>
                        <option value="Nissan">Nissan</option>
                        <option value="Skoda">Skoda</option>
                        <option value="Seat">Seat</option>
                        <option value="Fiat">Fiat</option>
                        <option value="Citroen">Citroen</option>
                        <option value="Dacia">Dacia</option>
                        <option value="Sonstige">Sonstige</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="modell">Modell *</label>
                    <input type="text" id="modell" placeholder="z.B. A4, 3er, Golf" required>
                </div>
                <div class="wizard-navigation">
                    <button class="btn-secondary" onclick="prevStep(1)">‚Üê Zur√ºck</button>
                    <button class="btn-primary" onclick="nextStep(3)">Weiter ‚Üí</button>
                </div>
            </div>

            <!-- Step 3: Dellen-Details -->
            <div class="wizard-step" data-step="3">
                <div class="step-title">üî® Dellen-Details</div>

                <div class="form-section">
                    <label class="section-label">Dellengr√∂√üe *</label>
                    <div class="radio-group">
                        <label class="radio-option selected">
                            <input type="radio" name="dellenGroesse" value="klein" checked>
                            <div class="option-content">
                                <div class="label">‚ö™ Klein (√ò &lt; 2 cm)</div>
                                <div class="sublabel">Hagelschaden, kleine Parkrempler</div>
                            </div>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="dellenGroesse" value="mittel">
                            <div class="option-content">
                                <div class="label">üîµ Mittel (√ò 2-5 cm)</div>
                                <div class="sublabel">T√ºrrempler, Einkaufswagen</div>
                            </div>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="dellenGroesse" value="gross">
                            <div class="option-content">
                                <div class="label">üî¥ Gro√ü (√ò &gt; 5 cm)</div>
                                <div class="sublabel">Gr√∂√üere Parksch√§den</div>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="dellenAnzahl">Anzahl der Dellen *</label>
                    <input type="number" id="dellenAnzahl" min="1" max="50" value="1" required>
                </div>

                <div class="form-section">
                    <label class="section-label">Position der Dellen *</label>
                    <div class="checkbox-group">
                        <label class="checkbox-option">
                            <input type="checkbox" name="position" value="tuer">
                            <span>üö™ T√ºr</span>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" name="position" value="kotfluegel">
                            <span>‚öôÔ∏è Kotfl√ºgel</span>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" name="position" value="motorhaube">
                            <span>üîß Motorhaube</span>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" name="position" value="dach">
                            <span>üè† Dach</span>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" name="position" value="heckklappe">
                            <span>üîô Heckklappe</span>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" name="position" value="seite">
                            <span>‚ÜîÔ∏è Seitenwand</span>
                        </label>
                    </div>
                </div>

                <div class="form-section">
                    <label class="section-label">Lackschaden vorhanden? *</label>
                    <div class="toggle-group">
                        <label class="toggle-option selected">
                            <input type="radio" name="lackschaden" value="nein" checked>
                            ‚úÖ Nein - Lack intakt (PDR m√∂glich)
                        </label>
                        <label class="toggle-option">
                            <input type="radio" name="lackschaden" value="ja">
                            ‚ö†Ô∏è Ja - Lackschaden vorhanden (Zusatzarbeit n√∂tig)
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="dellenInfo">Zus√§tzliche Informationen (Optional)</label>
                    <textarea id="dellenInfo" rows="3" placeholder="z.B. Unfallhergang, besondere Anforderungen..."></textarea>
                </div>

                <div class="wizard-navigation">
                    <button class="btn-secondary" onclick="prevStep(2)">‚Üê Zur√ºck</button>
                    <button class="btn-primary" onclick="nextStep(4)">Weiter ‚Üí</button>
                </div>
            </div>

            <!-- Step 4: Termin -->
            <div class="wizard-step" data-step="4">
                <div class="step-title">üìÖ Wunschtermin</div>
                <div class="step-description">
                    W√§hlen Sie Ihren bevorzugten Termin f√ºr die Anlieferung
                </div>
                <div class="termin-grid" id="terminGrid">
                    <!-- Dynamically loaded -->
                </div>
                <div class="form-group">
                    <label for="anmerkungen">Anmerkungen zum Termin (Optional)</label>
                    <textarea id="anmerkungen" rows="3" placeholder="z.B. nur vormittags m√∂glich..."></textarea>
                </div>
                <div class="wizard-navigation">
                    <button class="btn-secondary" onclick="prevStep(3)">‚Üê Zur√ºck</button>
                    <button class="btn-primary" onclick="nextStep(5)">Weiter ‚Üí</button>
                </div>
            </div>

            <!-- Step 5: Zusammenfassung -->
            <div class="wizard-step" data-step="5">
                <div class="step-title">‚úÖ Zusammenfassung</div>
                <div class="step-description">
                    Bitte √ºberpr√ºfen Sie Ihre Angaben
                </div>
                <div id="summaryContent" class="summary-box">
                    <!-- Dynamically generated -->
                </div>
                <div class="wizard-navigation">
                    <button class="btn-secondary" onclick="prevStep(4)">‚Üê Zur√ºck</button>
                    <button class="btn-success" id="btnSubmit">Anfrage absenden</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="../firebase-config.js?v=a4192c4"></script>

    <script>
        let currentStep = 1;
        let photos = [];
        let partner = null;
        let selectedTermin = null;

        // Load partner from localStorage
        document.addEventListener('DOMContentLoaded', () => {
            partner = JSON.parse(localStorage.getItem('partner') || 'null');
            if (!partner) {
                alert('Bitte melden Sie sich erst an!');
                window.location.href = 'index.html';
                return;
            }

            // Load available Termine
            loadTermine();

            // Photo upload
            document.getElementById('photoInput').addEventListener('change', handlePhotoUpload);

            // Radio options
            document.querySelectorAll('.radio-option').forEach(option => {
                option.addEventListener('click', function() {
                    const radio = this.querySelector('input[type="radio"]');
                    if (radio) {
                        this.closest('.radio-group, .toggle-group').querySelectorAll('.radio-option, .toggle-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        this.classList.add('selected');
                        radio.checked = true;
                    }
                });
            });

            // Submit button
            document.getElementById('btnSubmit').addEventListener('click', submitAnfrage);
        });

        // ============================================
        // STEP NAVIGATION
        // ============================================
        function nextStep(stepNumber) {
            // Validation
            if (currentStep === 1) {
                if (photos.length === 0) {
                    alert('Bitte laden Sie mindestens 1 Foto der Delle(n) hoch!');
                    return;
                }
            }

            if (currentStep === 2) {
                const kennzeichen = document.getElementById('kennzeichen').value.trim();
                const marke = document.getElementById('marke').value;
                const modell = document.getElementById('modell').value.trim();

                if (!kennzeichen || !marke || !modell) {
                    alert('Bitte f√ºllen Sie alle Pflichtfelder aus!');
                    return;
                }
            }

            if (currentStep === 3) {
                const anzahl = document.getElementById('dellenAnzahl').value;
                const positionen = Array.from(document.querySelectorAll('input[name="position"]:checked'));

                if (!anzahl || anzahl < 1) {
                    alert('Bitte geben Sie die Anzahl der Dellen an!');
                    return;
                }

                if (positionen.length === 0) {
                    alert('Bitte w√§hlen Sie mindestens eine Position!');
                    return;
                }
            }

            if (currentStep === 4) {
                if (!selectedTermin) {
                    alert('Bitte w√§hlen Sie einen Wunschtermin!');
                    return;
                }
            }

            // Show summary on step 5
            if (stepNumber === 5) {
                generateSummary();
            }

            // Hide current step
            document.querySelector(`.wizard-step[data-step="${currentStep}"]`).classList.remove('active');
            document.querySelector(`.sidebar-step[data-step="${currentStep}"]`).classList.remove('active');
            document.querySelector(`.sidebar-step[data-step="${currentStep}"]`).classList.add('completed');

            // Show next step
            currentStep = stepNumber;
            document.querySelector(`.wizard-step[data-step="${currentStep}"]`).classList.add('active');
            document.querySelector(`.sidebar-step[data-step="${currentStep}"]`).classList.add('active');

            // Scroll to top
            window.scrollTo(0, 0);
        }

        function prevStep(stepNumber) {
            // Hide current step
            document.querySelector(`.wizard-step[data-step="${currentStep}"]`).classList.remove('active');
            document.querySelector(`.sidebar-step[data-step="${currentStep}"]`).classList.remove('active');
            document.querySelector(`.sidebar-step[data-step="${currentStep}"]`).classList.add('pending');
            document.querySelector(`.sidebar-step[data-step="${currentStep}"]`).classList.remove('completed');

            // Show previous step
            currentStep = stepNumber;
            document.querySelector(`.wizard-step[data-step="${currentStep}"]`).classList.add('active');
            document.querySelector(`.sidebar-step[data-step="${currentStep}"]`).classList.remove('completed');
            document.querySelector(`.sidebar-step[data-step="${currentStep}"]`).classList.add('active');

            // Scroll to top
            window.scrollTo(0, 0);
        }

        // ============================================
        // PHOTO UPLOAD
        // ============================================
        function handlePhotoUpload(e) {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        photos.push(event.target.result);
                        renderPhotoPreview();
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function renderPhotoPreview() {
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = photos.map((photo, index) => `
                <div class="photo-item">
                    <img src="${photo}" alt="Foto ${index + 1}">
                    <button class="btn-remove" onclick="removePhoto(${index})">&times;</button>
                </div>
            `).join('');
        }

        function removePhoto(index) {
            photos.splice(index, 1);
            renderPhotoPreview();
        }

        // ============================================
        // TERMIN SELECTION
        // ============================================
        function loadTermine() {
            const terminGrid = document.getElementById('terminGrid');
            const termine = [];
            const today = new Date();

            // Generate next 14 days
            for (let i = 1; i <= 14; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() + i);

                // Skip Sundays
                if (date.getDay() === 0) continue;

                termine.push({
                    date: date.toISOString().split('T')[0],
                    weekday: ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'][date.getDay()],
                    day: date.getDate(),
                    month: date.toLocaleDateString('de-DE', { month: 'short' })
                });
            }

            terminGrid.innerHTML = termine.map(t => `
                <div class="termin-karte" data-date="${t.date}" onclick="selectTermin('${t.date}')">
                    <div class="weekday">${t.weekday}</div>
                    <div class="day">${t.day}</div>
                    <div class="month">${t.month}</div>
                </div>
            `).join('');
        }

        function selectTermin(date) {
            // Remove previous selection
            document.querySelectorAll('.termin-karte').forEach(k => k.classList.remove('selected'));

            // Select clicked termin
            document.querySelector(`.termin-karte[data-date="${date}"]`).classList.add('selected');
            selectedTermin = date;
        }

        // ============================================
        // SUMMARY GENERATION
        // ============================================
        function generateSummary() {
            const groesse = document.querySelector('input[name="dellenGroesse"]:checked').value;
            const groesseLabels = {
                'klein': '‚ö™ Klein (√ò < 2 cm)',
                'mittel': 'üîµ Mittel (√ò 2-5 cm)',
                'gross': 'üî¥ Gro√ü (√ò > 5 cm)'
            };

            const anzahl = document.getElementById('dellenAnzahl').value;

            const positionen = Array.from(document.querySelectorAll('input[name="position"]:checked'))
                .map(cb => cb.value);

            const positionLabels = {
                'tuer': 'üö™ T√ºr',
                'kotfluegel': '‚öôÔ∏è Kotfl√ºgel',
                'motorhaube': 'üîß Motorhaube',
                'dach': 'üè† Dach',
                'heckklappe': 'üîô Heckklappe',
                'seite': '‚ÜîÔ∏è Seitenwand'
            };

            const lackschaden = document.querySelector('input[name="lackschaden"]:checked').value;

            const summaryContent = document.getElementById('summaryContent');
            summaryContent.innerHTML = `
                <div class="summary-section">
                    <h3>üöó Fahrzeug</h3>
                    <p><strong>Kennzeichen:</strong> ${document.getElementById('kennzeichen').value}</p>
                    <p><strong>Marke:</strong> ${document.getElementById('marke').value}</p>
                    <p><strong>Modell:</strong> ${document.getElementById('modell').value}</p>
                </div>
                <div class="summary-section">
                    <h3>üî® Dellen-Details</h3>
                    <p><strong>Dellengr√∂√üe:</strong> ${groesseLabels[groesse]}</p>
                    <p><strong>Anzahl:</strong> ${anzahl} Delle(n)</p>
                    <p><strong>Position:</strong></p>
                    <ul>
                        ${positionen.map(p => `<li>${positionLabels[p]}</li>`).join('')}
                    </ul>
                    <p><strong>Lackschaden:</strong> ${lackschaden === 'ja' ? '‚ö†Ô∏è Ja (Zusatzarbeit erforderlich)' : '‚úÖ Nein (PDR m√∂glich)'}</p>
                    ${document.getElementById('dellenInfo').value ? `
                        <p><strong>Zus√§tzliche Informationen:</strong><br>${document.getElementById('dellenInfo').value}</p>
                    ` : ''}
                </div>
                <div class="summary-section">
                    <h3>üìÖ Termin</h3>
                    <p><strong>Wunschtermin:</strong> ${new Date(selectedTermin).toLocaleDateString('de-DE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                    ${document.getElementById('anmerkungen').value ? `
                        <p><strong>Anmerkungen:</strong> ${document.getElementById('anmerkungen').value}</p>
                    ` : ''}
                </div>
                <div class="summary-section">
                    <h3>üì∑ Fotos</h3>
                    <p>${photos.length} Foto(s) hochgeladen</p>
                </div>
            `;
        }

        // ============================================
        // SUBMIT ANFRAGE
        // ============================================
        async function submitAnfrage() {
            const btnSubmit = document.getElementById('btnSubmit');
            btnSubmit.disabled = true;
            btnSubmit.textContent = 'Wird gesendet...';

            try {
                // Compress photos
                const compressedPhotos = await Promise.all(photos.map(photo => compressImage(photo)));

                // Get form data
                const groesse = document.querySelector('input[name="dellenGroesse"]:checked').value;
                const anzahl = document.getElementById('dellenAnzahl').value;
                const positionen = Array.from(document.querySelectorAll('input[name="position"]:checked'))
                    .map(cb => cb.value);
                const lackschaden = document.querySelector('input[name="lackschaden"]:checked').value === 'ja';

                // Create anfrage data
                const anfrageData = {
                    id: 'req_' + Date.now(),
                    partnerId: partner.id,
                    partnerName: partner.name,
                    serviceTyp: 'dellen',
                    serviceData: {
                        art: groesse,
                        anzahl: parseInt(anzahl),
                        lackschaden: lackschaden,
                        position: positionen,
                        info: document.getElementById('dellenInfo').value.trim()
                    },
                    kennzeichen: document.getElementById('kennzeichen').value.trim(),
                    marke: document.getElementById('marke').value,
                    modell: document.getElementById('modell').value.trim(),
                    anliefertermin: selectedTermin,
                    anmerkungen: document.getElementById('anmerkungen').value.trim(),
                    fotos: compressedPhotos,
                    status: 'neu',
                    timestamp: new Date().toISOString()
                };

                // Save to Firestore
                await window.getCollection('partnerAnfragen').doc(anfrageData.id).set(anfrageData);

                // Success
                alert('‚úÖ Dellen-Dr√ºckung Anfrage erfolgreich gesendet!');
                window.location.href = 'meine-anfragen.html';

            } catch (error) {
                console.error('Error submitting anfrage:', error);
                alert('‚ùå Fehler beim Senden der Anfrage: ' + error.message);
                btnSubmit.disabled = false;
                btnSubmit.textContent = 'Anfrage absenden';
            }
        }

        // ============================================
        // IMAGE COMPRESSION
        // ============================================
        function compressImage(base64Image) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // Max dimensions
                    const maxWidth = 1920;
                    const maxHeight = 1080;

                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth || height > maxHeight) {
                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                        width = width * ratio;
                        height = height * ratio;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);

                    // Compress to 85% quality
                    resolve(canvas.toDataURL('image/jpeg', 0.85));
                };
                img.src = base64Image;
            });
        }

        // Theme Toggle Function
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            const btnToggle = document.getElementById('btnThemeToggle');
            if (btnToggle) {
                btnToggle.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            }
        }

        // Initialize Theme on Load
        (function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            const btnToggle = document.getElementById('btnThemeToggle');
            if (btnToggle) {
                btnToggle.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            }
        })();
    </script>
</body>
</html>
