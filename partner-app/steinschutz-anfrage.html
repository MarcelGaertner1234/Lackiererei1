<!DOCTYPE html>
<html lang="de">
<head>
    <!-- ‚úÖ BUG #7 FIX: Service Type Normalization Registry -->
    <script src="../js/service-types.js?v=bug7-normalization"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Steinschutzfolie (PPF) | Partner Portal</title>
    <link rel="stylesheet" href="service-form-styles.css">
    <link rel="stylesheet" href="../mobile-responsive.css">
</head>
<body>
    <div class="main-layout">
        <!-- Wizard Sidebar -->
        <div class="wizard-sidebar">
            <div class="sidebar-title">Fortschritt</div>
            <div class="sidebar-steps" id="sidebarSteps">
                <div class="sidebar-step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">Fotos</div>
                    <div class="step-icon"></div>
                </div>
                <div class="sidebar-step pending" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">Fahrzeug</div>
                    <div class="step-icon"></div>
                </div>
                <div class="sidebar-step pending" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">Schutz-Details</div>
                    <div class="step-icon"></div>
                </div>
                <div class="sidebar-step pending" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-label">Termin</div>
                    <div class="step-icon"></div>
                </div>
                <div class="sidebar-step pending" data-step="5">
                    <div class="step-number">5</div>
                    <div class="step-label">Zusammenfassung</div>
                    <div class="step-icon"></div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="container">
            <button id="btnThemeToggle" class="btn btn-theme-toggle" onclick="toggleTheme()" title="Theme wechseln">üåô</button>

            <div class="header">
                <!-- Werkstatt Logo (dynamisch geladen) -->
                <div id="werkstattLogo" style="display: inline-block; vertical-align: middle; margin-right: 12px;"></div>
                <h1 style="display: inline-block; vertical-align: middle;">üõ°Ô∏è Neue Steinschutzfolie Anfrage</h1>
                <p id="partnerName">Partner Portal</p>
            </div>

            <!-- Progress Indicator -->
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 20%;"></div>
                </div>
                <div class="progress-text" id="progressText">Schritt 1 von 5</div>
            </div>

            <!-- Wizard Container -->
            <div class="wizard-container" id="wizardContainer">

                <!-- Step 1: Fotos -->
                <div class="wizard-step active" data-step="1">
                    <div class="step-title">
                        <span class="icon">üì∏</span>
                        <span>Fahrzeugfotos hochladen</span>
                    </div>
                    <div class="form-group">
                        <label class="photo-upload" for="photoInput">
                            <div class="icon">üì∑</div>
                            <div class="text">
                                Klicken Sie hier, um Fotos des Fahrzeugs aufzunehmen<br>
                                <small>(Mehrere Perspektiven empfohlen)</small>
                            </div>
                            <input type="file" id="photoInput" accept="image/*" multiple capture="environment">
                        </label>
                        <div class="photo-preview" id="photoPreview"></div>
                    </div>
                </div>

                <!-- Step 2: Fahrzeug -->
                <div class="wizard-step" data-step="2">
                    <div class="step-title">
                        <span class="icon">üöó</span>
                        <span>Fahrzeug</span>
                    </div>
                    <div class="form-group">
                        <label for="kennzeichen">Kennzeichen *</label>
                        <input type="text" id="kennzeichen" placeholder="z.B. MOS-AB 123" required style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label for="marke">Marke *</label>
                        <select id="marke" required>
                            <option value="">Bitte w√§hlen...</option>
                            <option value="Audi">Audi</option>
                            <option value="BMW">BMW</option>
                            <option value="Mercedes-Benz">Mercedes-Benz</option>
                            <option value="Volkswagen">Volkswagen</option>
                            <option value="Opel">Opel</option>
                            <option value="Ford">Ford</option>
                            <option value="Renault">Renault</option>
                            <option value="Peugeot">Peugeot</option>
                            <option value="Toyota">Toyota</option>
                            <option value="Hyundai">Hyundai</option>
                            <option value="Kia">Kia</option>
                            <option value="Mazda">Mazda</option>
                            <option value="Nissan">Nissan</option>
                            <option value="Skoda">Skoda</option>
                            <option value="Seat">Seat</option>
                            <option value="Fiat">Fiat</option>
                            <option value="Citroen">Citroen</option>
                            <option value="Dacia">Dacia</option>
                            <option value="Sonstige">Sonstige</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="modell">Modell *</label>
                        <input type="text" id="modell" placeholder="z.B. A4, 3er, Golf" required>
                    </div>
                </div>

                <!-- Step 3: Steinschutz-Details -->
                <div class="wizard-step" data-step="3">
                    <div class="step-title">
                        <span class="icon">üõ°Ô∏è</span>
                        <span>Steinschutz-Details</span>
                    </div>

                    <div class="form-group">
                        <label>Schutzumfang *</label>
                        <div class="radio-group">
                            <label class="radio-option selected" onclick="selectSchutzUmfang(this, 'premium')">
                                <input type="radio" name="schutzUmfang" value="premium" checked>
                                <div class="label">üõ°Ô∏è Premium-Paket</div>
                                <div class="description">Komplettschutz: Front, Motorhaube, Kotfl√ºgel, Spiegel, T√ºrkanten, Schweller</div>
                            </label>
                            <label class="radio-option" onclick="selectSchutzUmfang(this, 'standard')">
                                <input type="radio" name="schutzUmfang" value="standard">
                                <div class="label">üì¶ Standard-Paket</div>
                                <div class="description">Front, Motorhaube, Seitenspiegel</div>
                            </label>
                            <label class="radio-option" onclick="selectSchutzUmfang(this, 'minimal')">
                                <input type="radio" name="schutzUmfang" value="minimal">
                                <div class="label">‚ö° Minimal-Paket</div>
                                <div class="description">Nur Front-Sto√üstange</div>
                            </label>
                            <label class="radio-option" onclick="selectSchutzUmfang(this, 'individuell')">
                                <input type="radio" name="schutzUmfang" value="individuell">
                                <div class="label">üéØ Individuell</div>
                                <div class="description">Bereiche selbst ausw√§hlen</div>
                            </label>
                        </div>
                    </div>

                    <div class="form-group" id="bereicheGroup" style="display: none;">
                        <label>Gesch√ºtzte Bereiche *</label>
                        <div class="checkbox-group">
                            <label class="checkbox-option">
                                <input type="checkbox" name="bereiche" value="front-stossstange">
                                <span>üöó Front-Sto√üstange</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="bereiche" value="motorhaube-komplett">
                                <span>üîß Motorhaube (komplett)</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="bereiche" value="motorhaube-vorderkante">
                                <span>üîß Motorhaube (Vorderkante)</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="bereiche" value="kotfluegel">
                                <span>‚öôÔ∏è Kotfl√ºgel</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="bereiche" value="seitenspiegel">
                                <span>ü™û Seitenspiegel</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="bereiche" value="tuerkanten">
                                <span>üö™ T√ºrkanten</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="bereiche" value="heckklappenkante">
                                <span>üîô Heckklappenkante</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="bereiche" value="scheinwerfer">
                                <span>üí° Scheinwerfer</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="bereiche" value="schweller">
                                <span>üîª Schweller</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="bereiche" value="heck-stossstange">
                                <span>üîô Heck-Sto√üstange</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Materialqualit√§t *</label>
                        <div class="radio-group">
                            <label class="radio-option selected" onclick="selectMaterial(this, 'standard')">
                                <input type="radio" name="material" value="standard" checked>
                                <div class="label">üì¶ Standard PPF</div>
                                <div class="description">Hochwertige Steinschutzfolie (5 Jahre Garantie)</div>
                            </label>
                            <label class="radio-option" onclick="selectMaterial(this, 'premium')">
                                <input type="radio" name="material" value="premium">
                                <div class="label">üíé Premium PPF</div>
                                <div class="description">Premium-Folie mit UV-Schutz (7 Jahre Garantie)</div>
                            </label>
                            <label class="radio-option" onclick="selectMaterial(this, 'self-healing')">
                                <input type="radio" name="material" value="self-healing">
                                <div class="label">üîÑ Self-Healing</div>
                                <div class="description">Selbstheilende Folie (10 Jahre Garantie)</div>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Oberfl√§che *</label>
                        <div class="toggle-group">
                            <label class="toggle-option selected" onclick="selectFinish('gloss')">
                                <input type="radio" name="finish" value="gloss" checked>
                                ‚ú® Hochglanz (Original-Look)
                            </label>
                            <label class="toggle-option" onclick="selectFinish('matt')">
                                <input type="radio" name="finish" value="matt">
                                üé≠ Matt (Stealth-Look)
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Zusatzoptionen (Optional)</label>
                        <div class="checkbox-group">
                            <label class="checkbox-option">
                                <input type="checkbox" name="optionen" value="full-coverage-motorhaube">
                                <span>üîÑ Full-Coverage Motorhaube</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="optionen" value="scheinwerfer-schutz">
                                <span>üí° Scheinwerfer-Schutz</span>
                            </label>
                            <label class="checkbox-option">
                                <input type="checkbox" name="optionen" value="heck-bumper">
                                <span>üîô Heck-Bumper</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="steinschutzInfo">Zus√§tzliche Informationen (Optional)</label>
                        <textarea id="steinschutzInfo" rows="3" placeholder="z.B. Besondere Anforderungen, vorhandene Lacksch√§den, etc."></textarea>
                    </div>
                </div>

                <!-- Step 4: Termin -->
                <div class="wizard-step" data-step="4">
                    <div class="step-title">
                        <span class="icon">üìÖ</span>
                        <span>Wunschtermin</span>
                    </div>
                    <div class="form-group">
                        <label>Gew√ºnschter Termin *</label>
                        <div class="termin-grid" id="terminGrid">
                            <div class="loading">
                                <div class="icon">‚è≥</div>
                                <div>Lade verf√ºgbare Termine...</div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="anmerkungen">Anmerkungen zum Termin (Optional)</label>
                        <textarea id="anmerkungen" rows="3" placeholder="z.B. nur vormittags m√∂glich..."></textarea>
                    </div>
                </div>

                <!-- Step 5: Zusammenfassung -->
                <div class="wizard-step" data-step="5">
                    <div class="step-title">
                        <span class="icon">‚úÖ</span>
                        <span>Zusammenfassung</span>
                    </div>
                    <p style="color: #666; margin-bottom: 20px;">Bitte √ºberpr√ºfen Sie Ihre Angaben vor dem Absenden:</p>
                    <div id="summaryContent"></div>
                </div>

            </div>

            <!-- Navigation Buttons -->
            <div class="wizard-nav">
                <button type="button" class="btn btn-back" id="btnBack" onclick="prevStep()" style="display: none;">
                    ‚Üê Zur√ºck
                </button>
                <button type="button" class="btn btn-primary" id="btnNext" onclick="nextStep()">
                    Weiter ‚Üí
                </button>
            </div>

            <!-- Success Message -->
            <div class="success-message" id="successMessage">
                <div class="icon">‚úÖ</div>
                <h3>Anfrage erfolgreich gesendet!</h3>
                <p>Wir melden uns schnellstm√∂glich mit einem Kostenvoranschlag bei Ihnen.</p>
                <button class="btn btn-primary" onclick="window.location.href='meine-anfragen.html'">
                    Zu meinen Anfragen
                </button>
            </div>
        </div>
    </div><!-- End main-layout -->

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <script src="../firebase-config.js?v=a4192c4"></script>
    <script src="../js/settings-manager.js"></script>
    <script src="../js/auth-manager.js"></script>
    <script>
        // üÜï FIX #1: FILE UPLOAD VALIDATION (2025-11-15)
        // Prevents: Malware uploads, XSS via SVG, Storage quota exhaustion
        window.validateImageFile = function(file) {
            const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
            const maxSize = 10 * 1024 * 1024; // 10 MB

            if (!file) {
                throw new Error('‚ùå Keine Datei ausgew√§hlt!');
            }

            // Check 1: File-Type Validation
            if (!allowedTypes.includes(file.type)) {
                throw new Error(`‚ùå Ung√ºltiger Dateityp!\n\nErlaubt: JPEG, PNG, WebP\nDein Typ: ${file.type || 'unbekannt'}`);
            }

            // Check 2: Size Validation
            if (file.size > maxSize) {
                throw new Error(`‚ùå Datei zu gro√ü!\n\nMaximum: 10 MB\nDeine Gr√∂√üe: ${(file.size / 1024 / 1024).toFixed(2)} MB`);
            }

            console.log('‚úÖ [validateImageFile] Datei validiert:', {
                type: file.type,
                sizeMB: (file.size / 1024 / 1024).toFixed(2)
            });

            return { isValid: true };
        };

        // Global Variables
        let currentStep = 1;
        const totalSteps = 5;
        let partner = null;
        let photos = [];
        let selectedTermin = null;

        // ============================================
        // PRE-INITIALIZE werkstattId from localStorage
        // ============================================
        // CRITICAL: Set werkstattId BEFORE auth-check polling!
        const storedPartner = JSON.parse(localStorage.getItem('partner') || 'null');
        window.werkstattId = (storedPartner && storedPartner.werkstattId) || 'mosbach';
        console.log('‚úÖ [FOLIERUNG-ANFRAGE] werkstattId pre-initialized:', window.werkstattId);

        // AUTH-CHECK POLLING
        let authCheckAttempts = 0;
        const maxAuthCheckAttempts = 20;

        const authCheckInterval = setInterval(async () => {
            authCheckAttempts++;

            if (window.firebaseInitialized && window.werkstattId) {
                clearInterval(authCheckInterval);
                console.log('‚úÖ [FOLIERUNG-ANFRAGE] Firebase ready');

                await initFirebase();
                checkLogin();
                // üîí AUTH-FIX: loadTermine() wird jetzt im Auth-State-Listener aufgerufen
                setupAuthListener(); // NEU: Warte auf Auth Ready
                setupPhotoUpload();
                updateProgress();
                return;
            }

            if (authCheckAttempts >= maxAuthCheckAttempts) {
                clearInterval(authCheckInterval);
                console.error('‚ùå [FOLIERUNG-ANFRAGE] Firebase timeout');
                alert('Fehler: Werkstatt-Initialisierung fehlgeschlagen. Bitte neu einloggen.');
                window.location.href = 'index.html';
            }
        }, 250);

        // Check Login
        function checkLogin() {
            partner = JSON.parse(localStorage.getItem('partner') || 'null');
            if (!partner) {
                window.location.href = 'index.html';
                return;
            }

            // werkstattId initialization (Multi-Tenant)
            if (!partner.werkstattId) {
                console.error('‚ùå Partner-Daten unvollst√§ndig - werkstattId fehlt!');
                alert('Fehler: Partner-Daten unvollst√§ndig. Bitte melden Sie sich erneut an.');
                window.location.href = 'index.html';
                return;
            }
            window.werkstattId = partner.werkstattId || 'mosbach'; // Fallback to 'mosbach'
            console.log('‚úÖ [FOLIERUNG-ANFRAGE] werkstattId initialized:', window.werkstattId);

            // Display partner name
            document.getElementById('partnerName').textContent = `Partner: ${partner.name}`;

            // Load Werkstatt-Logo & Branding
            (async () => {
                try {
                    const settings = await window.settingsManager.loadSettings();
                    if (settings?.profil) {
                        // Update Page Title
                        document.title = `${settings.profil.name} | Steinschutz-Service`;

                        // Display Logo
                        if (settings.profil.logoUrl) {
                            const logoContainer = document.getElementById('werkstattLogo');
                            if (logoContainer) {
                                logoContainer.innerHTML = `
                                    <img src="${settings.profil.logoUrl}"
                                         alt="${settings.profil.name}"
                                         style="height: 32px; width: auto; vertical-align: middle;">
                                `;
                                console.log('‚úÖ [PARTNER-STEINSCHUTZ] Werkstatt-Logo angezeigt:', settings.profil.name);
                            }
                        }
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è [PARTNER-STEINSCHUTZ] Werkstatt-Branding konnte nicht geladen werden:', error);
                }
            })();
        }

        // üîí AUTH-FIX: Auth-State-Listener f√ºr Kalender-Loading
        function setupAuthListener() {
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    console.log('‚úÖ Auth ready, loading calendar...');
                    loadTermine();
                }
            });
        }

        // Initialize Firebase
        async function initFirebase() {
            if (typeof firebase === 'undefined') {
                console.error('Firebase SDK not loaded');
                return;
            }

            // Wait for firebase-config.js to initialize
            if (window.firebaseInitialized) {
                await window.firebaseInitialized;
            }
        }

        // ============================================
        // PROGRESS & NAVIGATION
        // ============================================
        function updateProgress() {
            const percent = (currentStep / totalSteps) * 100;
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = `Schritt ${currentStep} von ${totalSteps}`;
        }

        function updateButtons() {
            const btnBack = document.getElementById('btnBack');
            const btnNext = document.getElementById('btnNext');

            if (currentStep === 1) {
                btnBack.style.display = 'none';
            } else {
                btnBack.style.display = 'inline-flex';
            }

            if (currentStep === totalSteps) {
                btnNext.textContent = 'Anfrage senden';
            } else {
                btnNext.textContent = 'Weiter ‚Üí';
            }
        }

        function updateSidebar() {
            const sidebarSteps = document.querySelectorAll('.sidebar-step');

            sidebarSteps.forEach((step, index) => {
                const stepNumber = index + 1;

                // Remove all state classes
                step.classList.remove('completed', 'active', 'pending');

                // Add appropriate class based on current step
                if (stepNumber < currentStep) {
                    step.classList.add('completed');
                } else if (stepNumber === currentStep) {
                    step.classList.add('active');
                } else {
                    step.classList.add('pending');
                }
            });
        }

        // Validation per Step
        function validateStep(step) {
            switch(step) {
                case 1: // Photos optional for dellen
                    return true;

                case 2: // Fahrzeug
                    const kennzeichen = document.getElementById('kennzeichen').value.trim();
                    const marke = document.getElementById('marke').value;
                    const modell = document.getElementById('modell').value.trim();

                    if (!kennzeichen) {
                        alert('Bitte geben Sie das Kennzeichen ein.');
                        return false;
                    }
                    if (!marke || marke === '') {
                        alert('Bitte w√§hlen Sie die Fahrzeugmarke aus.');
                        return false;
                    }
                    if (!modell) {
                        alert('Bitte geben Sie das Fahrzeugmodell ein.');
                        return false;
                    }
                    return true;

                case 3: // Steinschutz-Details
                    const schutzUmfang = document.querySelector('input[name="schutzUmfang"]:checked');
                    const material = document.querySelector('input[name="material"]:checked');
                    const finish = document.querySelector('input[name="finish"]:checked');

                    if (!schutzUmfang) {
                        alert('Bitte w√§hlen Sie den Schutzumfang aus.');
                        return false;
                    }
                    if (!material) {
                        alert('Bitte w√§hlen Sie die Materialqualit√§t aus.');
                        return false;
                    }
                    if (!finish) {
                        alert('Bitte w√§hlen Sie die Oberfl√§che aus.');
                        return false;
                    }
                    if (schutzUmfang.value === 'individuell') {
                        const bereiche = document.querySelectorAll('input[name="bereiche"]:checked');
                        if (bereiche.length === 0) {
                            alert('Bitte w√§hlen Sie mindestens einen Bereich aus.');
                            return false;
                        }
                    }
                    return true;

                case 4: // Termin
                    if (!selectedTermin) {
                        alert('Bitte w√§hlen Sie einen Wunschtermin aus.');
                        return false;
                    }
                    return true;

                default:
                    return true;
            }
        }

        // Navigation Functions
        function nextStep() {
            // Validate current step
            if (!validateStep(currentStep)) {
                return;
            }

            if (currentStep === totalSteps) {
                submitAnfrage();
                return;
            }

            // Move to next step
            const currentStepEl = document.querySelector(`.wizard-step[data-step="${currentStep}"]`);
            const nextStepEl = document.querySelector(`.wizard-step[data-step="${currentStep + 1}"]`);

            currentStepEl.classList.remove('active');
            currentStepEl.classList.add('prev');

            setTimeout(() => {
                currentStepEl.classList.remove('prev');
            }, 400);

            nextStepEl.classList.add('active');

            currentStep++;
            updateProgress();
            updateButtons();
            updateSidebar();

            // Generate summary on step 5
            if (currentStep === totalSteps) {
                generateSummary();
            }

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function prevStep() {
            if (currentStep === 1) return;

            const currentStepEl = document.querySelector(`.wizard-step[data-step="${currentStep}"]`);
            const prevStepEl = document.querySelector(`.wizard-step[data-step="${currentStep - 1}"]`);

            currentStepEl.classList.remove('active');
            prevStepEl.classList.add('active');

            currentStep--;
            updateProgress();
            updateButtons();
            updateSidebar();

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ============================================
        // PHOTO UPLOAD
        // ============================================
        function setupPhotoUpload() {
            const input = document.getElementById('photoInput');
            window.listenerRegistry.registerDOM(input, 'change', handlePhotoUpload, 'input change');
        }

        async function handlePhotoUpload(event) {
            const files = Array.from(event.target.files);

            for (const file of files) {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        photos.push(e.target.result);
                        displayPhotos();
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        function displayPhotos() {
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = '';

            photos.forEach((photo, index) => {
                const div = document.createElement('div');
                div.className = 'photo-preview-item';
                div.innerHTML = `
                    <img src="${photo}" alt="Foto ${index + 1}">
                    <button type="button" class="remove-btn" onclick="removePhoto(${index})">√ó</button>
                `;
                preview.appendChild(div);
            });
        }

        function removePhoto(index) {
            photos.splice(index, 1);
            displayPhotos();
        }

        // ============================================
        // FIREBASE STORAGE UPLOAD (FIX: 1MB Firestore Limit)
        // ============================================
        async function uploadPhotosToStorage(photoBase64Array, anfrageId) {
            if (!firebase.storage) {
                console.warn('‚ö†Ô∏è Firebase Storage not available - fallback to Base64');
                return photoBase64Array;
            }

            const storage = firebase.storage();
            const uploadedURLs = [];
            const btnNext = document.getElementById('btnNext');

            console.log(`üì§ Uploading ${photoBase64Array.length} photos to Firebase Storage...`);

            for (let i = 0; i < photoBase64Array.length; i++) {
                try {
                    const base64 = photoBase64Array[i];

                    if (btnNext) {
                        btnNext.textContent = `Fotos hochladen (${i + 1}/${photoBase64Array.length})...`;
                    }

                    const response = await fetch(base64);
                    const blob = await response.blob();

                    // üÜï FIX #1: Validate file BEFORE upload (Security)
                    try {
                        window.validateImageFile(blob);
                    } catch (validationError) {
                        console.error('‚ùå [UPLOAD] Validation failed:', validationError.message);
                        alert(validationError.message);
                        btnNext.disabled = false;
                        btnNext.textContent = 'Weiter ‚Üí';
                        return; // Stop upload
                    }

                    const timestamp = Date.now();
                    const filename = `photo_${i}_${timestamp}.jpg`;
                    const storagePath = `partner-anfragen/${partner.werkstattId}/${anfrageId}/${filename}`;
                    const storageRef = storage.ref(storagePath);

                    console.log(`  üì§ Uploading photo ${i + 1}/${photoBase64Array.length}: ${storagePath}`);
                    await storageRef.put(blob);

                    const downloadURL = await storageRef.getDownloadURL();
                    uploadedURLs.push(downloadURL);
                    console.log(`  ‚úÖ Photo ${i + 1} uploaded: ${downloadURL.substring(0, 60)}...`);

                } catch (error) {
                    console.error(`‚ùå Error uploading photo ${i + 1}:`, error);
                }
            }

            console.log(`‚úÖ All ${uploadedURLs.length}/${photoBase64Array.length} photos uploaded successfully`);
            return uploadedURLs;
        }

        // ============================================
        // RADIO OPTION SELECTION
        // ============================================
        function selectSchutzUmfang(element, value) {
            // Remove selected class from all options
            element.closest('.radio-group').querySelectorAll('.radio-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            // Add selected class to clicked option
            element.classList.add('selected');
            // Check the radio input
            element.querySelector('input[type="radio"]').checked = true;

            // Show/hide bereiche group based on selection
            const bereicheGroup = document.getElementById('bereicheGroup');
            if (value === 'individuell') {
                bereicheGroup.style.display = 'block';
            } else {
                bereicheGroup.style.display = 'none';
            }
        }

        function selectMaterial(element, value) {
            // Remove selected class from all options
            element.closest('.radio-group').querySelectorAll('.radio-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            // Add selected class to clicked option
            element.classList.add('selected');
            // Check the radio input
            element.querySelector('input[type="radio"]').checked = true;
        }

        function selectFinish(value) {
            // Remove selected class from all options
            document.querySelectorAll('.toggle-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            // Add selected class to clicked option
            const option = document.querySelector(`.toggle-option input[value="${value}"]`).closest('.toggle-option');
            option.classList.add('selected');
            // Check the radio input
            option.querySelector('input[type="radio"]').checked = true;
        }

        // ============================================
        // TERMIN SELECTION
        // ============================================
        async function loadTermine() {
            const terminGrid = document.getElementById('terminGrid');

            if (!window.db) {
                console.error('Firebase nicht initialisiert');
                terminGrid.innerHTML = '<div class="loading"><div style="color: red;">Fehler beim Laden der Termine</div></div>';
                return;
            }

            try {
                const heute = new Date();
                heute.setHours(0, 0, 0, 0);

                const endDate = new Date(heute);
                endDate.setDate(endDate.getDate() + 21);

                // üîí SECURITY: Get current user email for Query-Rule Compliance
                const currentUser = firebase.auth().currentUser;
                if (!currentUser) {
                    console.warn('‚ö†Ô∏è User not authenticated yet, skipping calendar load');
                    return;
                }
                const userEmail = currentUser.email.toLowerCase();

                // Query Firestore for existing appointments
                // üîí SECURITY: Filter by partnerEmail for Query-Rule Compliance
                const snapshot = await window.getCollection('fahrzeuge')
                    .where('partnerEmail', '==', userEmail)
                    .where('anliefertermin', '>=', heute.toISOString())
                    .where('anliefertermin', '<=', endDate.toISOString())
                    .get();

                // Calculate workload per day
                const auslastung = {};
                snapshot.forEach(doc => {
                    const termin = doc.data().anliefertermin;
                    if (termin) {
                        const date = termin.split('T')[0];
                        auslastung[date] = (auslastung[date] || 0) + 1;
                    }
                });

                // Generate available dates (exclude Sundays)
                const dates = [];
                for (let i = 1; i <= 21; i++) {
                    const date = new Date(heute);
                    date.setDate(date.getDate() + i);
                    if (date.getDay() !== 0) { // Skip Sundays
                        const dateStr = date.toISOString().split('T')[0];
                        const workload = auslastung[dateStr] || 0;
                        dates.push({
                            datum: date,
                            dateStr: dateStr,
                            auslastung: workload === 0 ? 'frei' : workload <= 2 ? 'normal' : 'voll'
                        });
                    }
                }

                // Show 4 intelligently selected dates
                const selectedTermine = [
                    dates.find(d => d.auslastung === 'frei') || dates[0], // First free date
                    dates[Math.floor(dates.length * 0.33)], // ~1 week
                    dates[Math.floor(dates.length * 0.66)], // ~2 weeks
                    dates[dates.length - 1] // Last available
                ];

                terminGrid.innerHTML = selectedTermine.map((t, idx) => {
                    const auslastungIcon = t.auslastung === 'frei' ? 'üü¢' : t.auslastung === 'normal' ? 'üü°' : 'üî¥';
                    const auslastungText = t.auslastung === 'frei' ? 'Freie Kapazit√§t' : t.auslastung === 'normal' ? 'Normale Auslastung' : 'Ausgelastet';
                    const wochentag = t.datum.toLocaleDateString('de-DE', { weekday: 'short' });
                    const tag = t.datum.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });

                    return `
                        <label class="termin-option" onclick="selectTermin('${t.dateStr}')">
                            <input type="radio" name="termin" value="${t.dateStr}">
                            <div class="weekday">${wochentag}</div>
                            <div class="day">${tag}</div>
                            <div class="indicator">${auslastungIcon} ${auslastungText}</div>
                        </label>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading termine:', error);
                terminGrid.innerHTML = '<div class="loading"><div style="color: red;">Fehler beim Laden der Termine</div></div>';
            }
        }

        function selectTermin(dateStr) {
            // Remove previous selection
            document.querySelectorAll('.termin-option').forEach(opt => {
                opt.classList.remove('selected');
            });

            // Select clicked termin
            const option = document.querySelector(`.termin-option input[value="${dateStr}"]`).closest('.termin-option');
            option.classList.add('selected');
            selectedTermin = dateStr;
        }

        // ============================================
        // SUMMARY GENERATION
        // ============================================
        function generateSummary() {
            const schutzUmfang = document.querySelector('input[name="schutzUmfang"]:checked').value;
            const umfangLabels = {
                'premium': 'üõ°Ô∏è Premium-Paket',
                'standard': '‚úÖ Standard-Paket',
                'minimal': 'üì¶ Minimal-Paket',
                'individuell': '‚öôÔ∏è Individuell'
            };

            const material = document.querySelector('input[name="material"]:checked').value;
            const materialLabels = {
                'standard': 'üì¶ Standard PPF',
                'premium': 'üíé Premium PPF',
                'self-healing': 'üîÑ Self-Healing PPF'
            };

            const finish = document.querySelector('input[name="finish"]:checked').value;
            const finishLabels = {
                'gloss': '‚ú® Hochglanz',
                'matt': 'üé≠ Matt'
            };

            const bereiche = schutzUmfang === 'individuell' ?
                Array.from(document.querySelectorAll('input[name="bereiche"]:checked')).map(cb => cb.value) : [];

            const bereicheLabels = {
                'front-stossstange': 'üöó Front-Sto√üstange',
                'motorhaube-komplett': 'üè† Motorhaube (komplett)',
                'motorhaube-partial': 'üìê Motorhaube (Teilbereich)',
                'kotfluegel-vorne': '‚öôÔ∏è Kotfl√ºgel vorne',
                'seitenschweller': '‚ÜîÔ∏è Seitenschweller',
                'seitenspiegel': 'ü™û Seitenspiegel',
                'tuerkanten': 'üö™ T√ºrkanten',
                'a-saeule': 'üèõÔ∏è A-S√§ulen',
                'heck-stossstange': 'üîô Heck-Sto√üstange',
                'heckklappe': 'üöê Heckklappe'
            };

            const optionen = Array.from(document.querySelectorAll('input[name="optionen"]:checked')).map(cb => cb.value);
            const optionenLabels = {
                'full-coverage-motorhaube': 'üî• Full-Coverage Motorhaube',
                'scheinwerfer-schutz': 'üí° Scheinwerfer-Schutz',
                'heck-bumper': 'üîô Heck-Bumper Schutz'
            };

            const summaryContent = document.getElementById('summaryContent');
            summaryContent.innerHTML = `
                <div class="summary-section">
                    <h3>üöó Fahrzeug</h3>
                    <p><strong>Kennzeichen:</strong> ${document.getElementById('kennzeichen').value}</p>
                    <p><strong>Marke:</strong> ${document.getElementById('marke').value}</p>
                    <p><strong>Modell:</strong> ${document.getElementById('modell').value}</p>
                </div>
                <div class="summary-section">
                    <h3>üõ°Ô∏è Steinschutz-Details</h3>
                    <p><strong>Schutzumfang:</strong> ${umfangLabels[schutzUmfang]}</p>
                    ${bereiche.length > 0 ? `
                        <p><strong>Bereiche:</strong></p>
                        <ul>
                            ${bereiche.map(b => `<li>${bereicheLabels[b]}</li>`).join('')}
                        </ul>
                    ` : ''}
                    <p><strong>Material:</strong> ${materialLabels[material]}</p>
                    <p><strong>Oberfl√§che:</strong> ${finishLabels[finish]}</p>
                    ${optionen.length > 0 ? `
                        <p><strong>Zusatzoptionen:</strong></p>
                        <ul>
                            ${optionen.map(o => `<li>${optionenLabels[o]}</li>`).join('')}
                        </ul>
                    ` : ''}
                    ${document.getElementById('steinschutzInfo').value ? `
                        <p><strong>Zus√§tzliche Informationen:</strong><br>${document.getElementById('steinschutzInfo').value}</p>
                    ` : ''}
                </div>
                <div class="summary-section">
                    <h3>üìÖ Termin</h3>
                    <p><strong>Wunschtermin:</strong> ${new Date(selectedTermin).toLocaleDateString('de-DE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                    ${document.getElementById('anmerkungen').value ? `
                        <p><strong>Anmerkungen:</strong> ${document.getElementById('anmerkungen').value}</p>
                    ` : ''}
                </div>
                <div class="summary-section">
                    <h3>üì∑ Fotos</h3>
                    <p>${photos.length} Foto(s) hochgeladen</p>
                </div>
            `;
        }

        // ============================================
        // SUBMIT ANFRAGE
        // ============================================
        async function submitAnfrage() {
            const btnNext = document.getElementById('btnNext');
            btnNext.disabled = true;
            btnNext.textContent = 'Wird gesendet...';

            try {
                // Generate anfrage ID first (needed for Storage path)
                const anfrageId = 'req_' + Date.now();

                // Compress photos
                btnNext.textContent = 'Fotos komprimieren...';
                const compressedPhotos = await Promise.all(photos.map(photo => compressImage(photo)));
                console.log(`‚úÖ ${compressedPhotos.length} Fotos komprimiert`);

                // ‚úÖ FIX: Upload photos to Firebase Storage
                btnNext.textContent = 'Fotos hochladen...';
                const photoURLs = await uploadPhotosToStorage(compressedPhotos, anfrageId);
                console.log(`‚úÖ ${photoURLs.length} Foto-URLs erhalten`);

                // Get form data
                const schutzUmfang = document.querySelector('input[name="schutzUmfang"]:checked').value;
                const material = document.querySelector('input[name="material"]:checked').value;
                const finish = document.querySelector('input[name="finish"]:checked').value;
                const bereiche = schutzUmfang === 'individuell' ?
                    Array.from(document.querySelectorAll('input[name="bereiche"]:checked')).map(cb => cb.value) : [];
                const optionen = Array.from(document.querySelectorAll('input[name="optionen"]:checked')).map(cb => cb.value);

                // Create anfrage data
                btnNext.textContent = 'Anfrage speichern...';
                const timestamp = new Date().toISOString();
                const anfrageData = {
                    id: anfrageId,  // Use pre-generated ID
                    partnerId: partner.partnerId || partner.id,
                    partnerName: partner.name,
                    partnerEmail: firebase.auth().currentUser.email.toLowerCase(),
                    kundenEmail: firebase.auth().currentUser.email.toLowerCase(),
                    serviceTyp: 'steinschutz',
                    timestamp: timestamp,
                    erstelltAm: timestamp,
                    serviceData: {
                        umfang: schutzUmfang,
                        bereiche: bereiche,
                        material: material,
                        finish: finish,
                        optionen: optionen,
                        info: document.getElementById('steinschutzInfo').value.trim()
                    },
                    kennzeichen: document.getElementById('kennzeichen').value.trim().toUpperCase(),
                    marke: document.getElementById('marke').value,
                    modell: document.getElementById('modell').value.trim(),
                    anliefertermin: selectedTermin,
                    anmerkungen: document.getElementById('anmerkungen').value.trim(),
                    fotos: photoURLs,  // ‚úÖ CHANGED: Store URLs instead of Base64
                    fotoCount: photoURLs.length,  // ‚úÖ ADDED: Quick count
                    status: 'neu',
                    statusText: 'Neu eingegangen',
                    kva: null,
                    fahrzeugId: null
                };

                // Save to Firestore
                await window.getCollection('partnerAnfragen').doc(anfrageData.id).set(anfrageData);

                // Show success message
                document.getElementById('successMessage').style.display = 'flex';
                document.querySelector('.wizard-container').style.display = 'none';
                document.querySelector('.wizard-nav').style.display = 'none';

            } catch (error) {
                console.error('Error submitting anfrage:', error);
                alert('‚ùå Fehler beim Senden der Anfrage: ' + error.message);
                btnNext.disabled = false;
                btnNext.textContent = 'Anfrage senden';
            }
        }

        // ============================================
        // IMAGE COMPRESSION
        // ============================================
        function compressImage(base64Image) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // Max dimensions
                    const maxWidth = 1920;
                    const maxHeight = 1080;

                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth || height > maxHeight) {
                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                        width = width * ratio;
                        height = height * ratio;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);

                    // Compress to 85% quality
                    resolve(canvas.toDataURL('image/jpeg', 0.85));
                };
                img.src = base64Image;
            });
        }

        // Theme Toggle Function
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            const btnToggle = document.getElementById('btnThemeToggle');
            if (btnToggle) {
                btnToggle.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            }
        }

        // Initialize Theme on Load
        (function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            const btnToggle = document.getElementById('btnThemeToggle');
            if (btnToggle) {
                btnToggle.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            }
        })();
    </script>
    <script src="../listener-registry.js"></script>
    <script src="../error-handler.js"></script>
</body>
</html>
