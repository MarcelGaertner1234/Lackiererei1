<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reifen-Service | Partner Portal</title>

    <!-- Shared Service-Form Styles (747 lines extracted to separate file) -->
    <link rel="stylesheet" href="service-form-styles.css">

    <!-- Skip inline styles block -->
    <style style="display:none;">
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }

        .main-layout {
            display: flex;
            gap: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Sidebar */
        .wizard-sidebar {
            width: 280px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 30px 20px;
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .sidebar-title {
            font-size: 14px;
            font-weight: 600;
            color: #003366;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sidebar-steps {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .sidebar-step {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            transition: all 0.2s;
            cursor: default;
        }

        .sidebar-step .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            flex-shrink: 0;
            transition: all 0.2s;
        }

        .sidebar-step .step-label {
            font-size: 13px;
            font-weight: 500;
            color: #666;
            transition: all 0.2s;
        }

        .sidebar-step .step-icon {
            font-size: 18px;
            margin-left: auto;
        }

        /* Step States */
        .sidebar-step.completed .step-number {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .sidebar-step.completed .step-label {
            color: #2e7d32;
        }

        .sidebar-step.completed .step-icon::before {
            content: '‚úì';
            color: #2e7d32;
        }

        .sidebar-step.active {
            background: #e3f2fd;
            border: 2px solid #003366;
        }

        .sidebar-step.active .step-number {
            background: #003366;
            color: white;
        }

        .sidebar-step.active .step-label {
            color: #003366;
            font-weight: 600;
        }

        .sidebar-step.active .step-icon::before {
            content: '‚Üí';
            color: #003366;
        }

        .sidebar-step.pending .step-number {
            background: #f5f5f5;
            color: #999;
        }

        .sidebar-step.pending .step-label {
            color: #999;
        }

        .sidebar-step.pending .step-icon::before {
            content: '‚óã';
            color: #ccc;
        }

        .container {
            flex: 1;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 40px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .header h1 {
            color: #003366;
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        /* Progress Indicator */
        .progress-container {
            margin-bottom: 30px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #003366, #00509e);
            border-radius: 3px;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .progress-text {
            text-align: center;
            font-size: 13px;
            color: #666;
            font-weight: 600;
        }

        /* Wizard Steps */
        .wizard-container {
            position: relative;
            min-height: 400px;
            overflow: hidden;
        }

        .wizard-step {
            position: absolute;
            width: 100%;
            opacity: 0;
            transform: translateX(100px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: none;
        }

        .wizard-step.active {
            position: relative;
            opacity: 1;
            transform: translateX(0);
            pointer-events: all;
        }

        .wizard-step.prev {
            transform: translateX(-100px);
        }

        .step-title {
            font-size: 20px;
            font-weight: 600;
            color: #003366;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .step-title .icon {
            font-size: 28px;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input[type="text"],
        .form-group input[type="date"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #003366;
        }

        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* Photo Upload */
        .photo-upload {
            border: 3px dashed #e0e0e0;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f9f9f9;
        }

        .photo-upload:hover {
            border-color: #003366;
            background: #f0f9ff;
        }

        .photo-upload input {
            display: none;
        }

        .photo-upload .icon {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .photo-upload .text {
            color: #666;
            font-size: 14px;
        }

        .photo-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        .photo-preview-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            background: #f5f5f5;
        }

        .photo-preview-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .photo-preview-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255,0,0,0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            line-height: 1;
        }

        /* Toggle Options */
        .toggle-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .toggle-option {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            background: white;
        }

        .toggle-option:hover {
            border-color: #003366;
            background: #f0f9ff;
        }

        .toggle-option.selected {
            border-color: #003366;
            background: #e3f2fd;
            font-weight: 600;
        }

        .toggle-option input {
            display: none;
        }

        /* Radio Options */
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .radio-option {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .radio-option:hover {
            border-color: #003366;
            background: #f0f9ff;
        }

        .radio-option.selected {
            border-color: #003366;
            background: #e3f2fd;
            box-shadow: 0 4px 12px rgba(0,51,102,0.1);
        }

        .radio-option input {
            display: none;
        }

        .radio-option .label {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .radio-option .description {
            font-size: 12px;
            color: #999;
            line-height: 1.5;
        }

        /* Termin Options */
        .termin-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .termin-option {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .termin-option:hover {
            border-color: #003366;
            background: #f0f9ff;
        }

        .termin-option.selected {
            border-color: #003366;
            background: #e3f2fd;
        }

        .termin-option input {
            display: none;
        }

        .termin-option .label {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 6px;
        }

        /* Summary View */
        .summary-section {
            margin-bottom: 25px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid #003366;
        }

        .summary-section h3 {
            font-size: 14px;
            color: #003366;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .summary-section p {
            font-size: 14px;
            color: #333;
            margin: 5px 0;
        }

        .summary-section .label {
            color: #666;
            font-size: 12px;
            font-weight: 600;
        }

        /* Navigation Buttons */
        .wizard-nav {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .btn {
            padding: 14px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn-primary {
            background: #003366;
            color: white;
            flex: 1;
        }

        .btn-primary:hover {
            background: #00509e;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,51,102,0.2);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-back {
            background: white;
            color: #333;
            border: 2px solid #e0e0e0;
        }

        .btn-back:hover {
            border-color: #003366;
            background: #f9f9f9;
        }

        /* Success Message */
        .success-message {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        .success-message .icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .success-message h3 {
            margin-bottom: 15px;
            font-size: 24px;
        }

        /* Conditional Fields */
        .conditional-field {
            margin-top: 20px;
            padding: 15px;
            background: #f0f9ff;
            border-radius: 8px;
            border-left: 3px solid #2196f3;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 30px;
            color: #999;
        }

        .loading .icon {
            font-size: 40px;
            margin-bottom: 10px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Mobile Responsive */
        @media (max-width: 968px) {
            .main-layout {
                flex-direction: column;
            }

            .wizard-sidebar {
                width: 100%;
                position: static;
                order: -1;
            }

            .sidebar-steps {
                flex-direction: row;
                overflow-x: auto;
                gap: 12px;
                padding-bottom: 10px;
            }

            .sidebar-step {
                flex-direction: column;
                min-width: 80px;
                padding: 10px;
                text-align: center;
            }

            .sidebar-step .step-label {
                font-size: 11px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 80px;
            }

            .sidebar-step .step-icon {
                display: none;
            }
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 20px;
            }

            .header h1 {
                font-size: 20px;
            }

            /* Wizard Container */
            .wizard-container {
                min-height: 300px;
            }

            /* Step Title */
            .step-title {
                font-size: 18px;
            }

            .step-title .icon {
                font-size: 24px;
            }

            /* Photo Upload - Mobile Optimierung */
            .photo-upload {
                padding: 20px;
            }

            .photo-upload .icon {
                font-size: 40px;
            }

            .photo-upload .text {
                font-size: 13px;
            }

            /* Form Inputs - iOS Zoom Prevention */
            .form-group input[type="text"],
            .form-group input[type="date"],
            .form-group select,
            .form-group textarea {
                font-size: 16px !important;
            }

            /* Success Message */
            .success-message .icon {
                font-size: 50px;
            }

            .success-message h3 {
                font-size: 20px;
            }

            /* Termin Grid */
            .termin-grid {
                grid-template-columns: 1fr;
            }

            /* Toggle Group */
            .toggle-group {
                flex-direction: column;
            }

            /* Wizard Navigation */
            .wizard-nav {
                flex-direction: column;
            }

            .btn-back {
                order: 2;
            }

            .btn-primary {
                order: 1;
            }

            /* Sidebar Steps */
            .sidebar-step {
                min-width: 60px;
            }

            .sidebar-step .step-label {
                font-size: 10px;
                max-width: 60px;
            }

            /* Radio Options - Mobile */
            .radio-option {
                padding: 12px;
            }

            .radio-option .label {
                font-size: 13px;
            }

            .radio-option .description {
                font-size: 11px;
            }

            /* Summary Sections */
            .summary-section {
                padding: 12px;
            }

            .summary-section h3 {
                font-size: 13px;
            }

            .summary-section p {
                font-size: 13px;
            }
        }
    
        /* Enhanced Mobile Optimizations - Minimalistic */
        @media (max-width: 768px) {
            body { padding: 10px !important; }
            .container { padding: 15px !important; border-radius: 8px !important; }
            .header h1 { font-size: 18px !important; margin-bottom: 6px !important; }
            .header p { font-size: 12px !important; }
            .wizard-nav { gap: 10px !important; }
            .btn { padding: 8px 14px !important; font-size: 12px !important; border-radius: 6px !important; }
            .btn-back { padding: 8px 12px !important; }
            .form-group label { font-size: 11px !important; }
            .form-group input, .form-group textarea, .form-group select {
                padding: 8px !important; font-size: 12px !important; border: 1px solid #e0e0e0 !important;
            }
            .wizard-step .step-title { font-size: 16px !important; }
            .wizard-step .step-title .icon { font-size: 22px !important; }
            .photo-upload { padding: 20px !important; border-width: 2px !important; }
            .photo-upload .icon { font-size: 40px !important; }
            .photo-upload .text { font-size: 12px !important; }
            .toggle-option, .radio-option, .termin-option { padding: 10px !important; }
            .radio-option .label { font-size: 12px !important; }
            .radio-option .description { font-size: 11px !important; }
            .summary-section { padding: 12px !important; }
            .summary-section h3 { font-size: 12px !important; }
            .summary-section p { font-size: 12px !important; }
        }

        @media (max-width: 480px) {
            .container { padding: 12px !important; }
            .header h1 { font-size: 16px !important; }
            .btn { padding: 6px 10px !important; font-size: 10px !important; }
            .btn-back { padding: 6px 10px !important; font-size: 10px !important; }
            .wizard-step .step-title { font-size: 15px !important; }
            .form-group label { font-size: 10px !important; }
            .photo-upload { padding: 15px !important; }
        }

        /* ============================================
           üåì DARK MODE VARIABLES (MINIMAL)
           ============================================ */

        /* Light Mode (Default) */
        :root {
            --bg-color: #f5f5f5;
            --surface-color: white;
            --text-primary: #003366;
            --text-secondary: #666;
            --border-color: #e0e0e0;
            --hover-bg: #f0f0f0;
        }

        /* Dark Mode */
        [data-theme="dark"] {
            --bg-color: #1a1a1d;
            --surface-color: #2a2a2d;
            --text-primary: rgba(255,255,255,0.9);
            --text-secondary: rgba(255,255,255,0.6);
            --border-color: rgba(255,255,255,0.18);
            --hover-bg: rgba(255,255,255,0.1);
        }

        /* Override service-form-styles.css colors with variables */
        body {
            background: var(--bg-color) !important;
        }
        .wizard-sidebar, .container {
            background: var(--surface-color) !important;
        }
        .sidebar-title, .header h1 {
            color: var(--text-primary) !important;
        }
        .header p, .sidebar-step .step-label {
            color: var(--text-secondary) !important;
        }

        /* Theme Toggle Button */
        .btn-theme-toggle {
            background: var(--surface-color);
            border: 2px solid var(--border-color);
            padding: 10px 12px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .btn-theme-toggle:hover {
            transform: scale(1.1) rotate(20deg);
        }

    </style>

    <!-- Mobile-Responsive CSS Framework -->
    <link rel="stylesheet" href="../mobile-responsive.css">
</head>
<body>
    <div class="main-layout">
        <!-- Sidebar Navigation -->
        <div class="wizard-sidebar">
            <div class="sidebar-title">Fortschritt</div>
            <div class="sidebar-steps" id="sidebarSteps">
                <div class="sidebar-step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">Fotos</div>
                    <div class="step-icon"></div>
                </div>
                <div class="sidebar-step pending" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">Fahrzeug</div>
                    <div class="step-icon"></div>
                </div>
                <div class="sidebar-step pending" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">FIN/Schein</div>
                    <div class="step-icon"></div>
                </div>
                <div class="sidebar-step pending" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-label">Reifen-Typ</div>
                    <div class="step-icon"></div>
                </div>
                <div class="sidebar-step pending" data-step="5">
                    <div class="step-number">5</div>
                    <div class="step-label">Service-Art</div>
                    <div class="step-icon"></div>
                </div>
                <div class="sidebar-step pending" data-step="6">
                    <div class="step-number">6</div>
                    <div class="step-label">Dimension</div>
                    <div class="step-icon"></div>
                </div>
                <div class="sidebar-step pending" data-step="7">
                    <div class="step-number">7</div>
                    <div class="step-label">Termin</div>
                    <div class="step-icon"></div>
                </div>
                <div class="sidebar-step pending" data-step="8">
                    <div class="step-number">8</div>
                    <div class="step-label">Lieferung</div>
                    <div class="step-icon"></div>
                </div>
                <div class="sidebar-step pending" data-step="9">
                    <div class="step-number">9</div>
                    <div class="step-label">Anmerkungen</div>
                    <div class="step-icon"></div>
                </div>
                <div class="sidebar-step pending" data-step="10">
                    <div class="step-number">10</div>
                    <div class="step-label">Zusammenfassung</div>
                    <div class="step-icon"></div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="container">
            <button id="btnThemeToggle" class="btn btn-theme-toggle" onclick="toggleTheme()" title="Theme wechseln">üåô</button>

            <div class="header">
                <!-- Werkstatt Logo (dynamisch geladen) -->
                <div id="werkstattLogo" style="display: inline-block; vertical-align: middle; margin-right: 12px;"></div>
                <h1 style="display: inline-block; vertical-align: middle;">üöó Neue Reifen-Anfrage</h1>
                <p id="partnerName">Partner Portal</p>
            </div>

        <!-- Progress Indicator -->
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 11%;"></div>
            </div>
            <div class="progress-text" id="progressText">Schritt 1 von 9</div>
        </div>

        <!-- Wizard Container -->
        <div class="wizard-container" id="wizardContainer">

            <!-- Step 1: Reifenfotos -->
            <div class="wizard-step active" data-step="1">
                <div class="step-title">
                    <span class="icon"></span>
                    <span>Reifenfotos</span>
                </div>
                <div class="form-group">
                    <label class="photo-upload" for="photoInput">
                        <div class="icon"></div>
                        <div class="text">
                            Klicken Sie hier, um Fotos der Reifen aufzunehmen<br>
                            <small>(Profiltiefe, Besch√§digungen, DOT-Nummer)</small>
                        </div>
                        <input type="file" id="photoInput" accept="image/*" multiple capture="environment">
                    </label>
                    <div class="photo-preview" id="photoPreview"></div>
                </div>
                <p style="color: #999; font-size: 13px; margin-top: 15px;">
                    Tipp: Laden Sie mindestens 1 Foto hoch, um fortzufahren
                </p>
            </div>

            <!-- Step 2: Fahrzeug-Referenz -->
            <div class="wizard-step" data-step="2">
                <div class="step-title">
                    <span class="icon">üöó</span>
                    <span>Fahrzeug-Referenz</span>
                </div>
                <div class="form-group">
                    <label>Wie m√∂chten Sie das Fahrzeug identifizieren?</label>
                    <div class="toggle-group">
                        <label class="toggle-option selected" onclick="selectReferenzType('kennzeichen')">
                            <input type="radio" name="referenzType" value="kennzeichen" checked>
                            üöò Kennzeichen
                        </label>
                        <label class="toggle-option" onclick="selectReferenzType('auftrag')">
                            <input type="radio" name="referenzType" value="auftrag">
                            üìã Auftragsnummer
                        </label>
                    </div>

                    <!-- Kennzeichen Input -->
                    <div id="kennzeichenInput">
                        <label for="kennzeichen">Kennzeichen</label>
                        <input type="text" id="kennzeichen" placeholder="z.B. MOS-AB 123" style="text-transform: uppercase;">
                    </div>

                    <!-- Auftragsnummer Input -->
                    <div id="auftragInput" style="display: none;">
                        <label for="auftragsnummer">Auftragsnummer</label>
                        <input type="text" id="auftragsnummer" placeholder="z.B. AH-2024-0123">
                        <small style="color: #999; font-size: 12px; margin-top: 5px; display: block;">
                            Ihre interne Auftragsnummer f√ºr nicht-angemeldete Fahrzeuge
                        </small>
                    </div>

                    <!-- NEU: Fahrzeugdaten f√ºr KVA-Kalkulation -->
                    <div class="form-group" style="margin-top: 30px; padding-top: 25px; border-top: 2px solid #e0e0e0;">
                        <h4 style="color: #003366; margin-bottom: 15px; font-size: 16px;">üöó Fahrzeugdaten f√ºr Kalkulation</h4>
                        <p style="color: #666; font-size: 13px; margin-bottom: 20px;">
                            Diese Angaben helfen der Werkstatt, einen genauen Kostenvoranschlag zu erstellen.
                        </p>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label for="marke">Marke *</label>
                                <select id="marke" required style="width: 100%;">
                                    <option value="">Bitte w√§hlen...</option>
                                    <option value="Audi">Audi</option>
                                    <option value="BMW">BMW</option>
                                    <option value="Mercedes-Benz">Mercedes-Benz</option>
                                    <option value="Volkswagen">Volkswagen</option>
                                    <option value="Porsche">Porsche</option>
                                    <option value="Opel">Opel</option>
                                    <option value="Ford">Ford</option>
                                    <option value="Renault">Renault</option>
                                    <option value="Peugeot">Peugeot</option>
                                    <option value="Citro√´n">Citro√´n</option>
                                    <option value="Fiat">Fiat</option>
                                    <option value="Toyota">Toyota</option>
                                    <option value="Honda">Honda</option>
                                    <option value="Mazda">Mazda</option>
                                    <option value="Nissan">Nissan</option>
                                    <option value="Hyundai">Hyundai</option>
                                    <option value="Kia">Kia</option>
                                    <option value="Skoda">Skoda</option>
                                    <option value="Seat">Seat</option>
                                    <option value="Volvo">Volvo</option>
                                    <option value="Tesla">Tesla</option>
                                    <option value="Sonstige">Sonstige</option>
                                </select>
                            </div>
                            <div>
                                <label for="baujahr">Baujahr *</label>
                                <input type="number" id="baujahr" placeholder="z.B. 2018" min="1950" max="2025" required>
                            </div>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label for="modell">Modell *</label>
                            <input type="text" id="modell" placeholder="z.B. Golf 7, 320d, C-Klasse" required>
                        </div>
                        <div>
                            <label for="kilometerstand">Kilometerstand (optional)</label>
                            <input type="number" id="kilometerstand" placeholder="z.B. 85000" min="0" step="1000">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Fahrzeugidentifikation (NEU) -->
            <div class="wizard-step" data-step="3">
                <div class="step-title">
                    <span class="icon">üî¢</span>
                    <span>Fahrzeugidentifikation</span>
                </div>
                <div class="form-group">
                    <label>Wie m√∂chten Sie das Fahrzeug identifizieren?</label>
                    <div class="toggle-group">
                        <label class="toggle-option selected" onclick="selectIdentificationType('vin')">
                            <input type="radio" name="identificationType" value="vin" checked>
                            üî¢ FIN/VIN eingeben
                        </label>
                        <label class="toggle-option" onclick="selectIdentificationType('fahrzeugschein')">
                            <input type="radio" name="identificationType" value="fahrzeugschein">
                            üìÑ Fahrzeugschein fotografieren
                        </label>
                    </div>

                    <!-- VIN Input -->
                    <div id="vinInput" style="margin-top: 20px;">
                        <label for="vin">Fahrzeug-Identifizierungsnummer (FIN/VIN)</label>
                        <input type="text" id="vin" placeholder="z.B. WVWZZZ1KZXW123456" style="text-transform: uppercase;" maxlength="17">
                        <small style="color: #999; font-size: 12px; margin-top: 5px; display: block;">
                            17-stellige Nummer im Fahrzeugschein (Feld E)
                        </small>
                    </div>

                    <!-- Fahrzeugschein Upload -->
                    <div id="fahrzeugscheinInput" style="display: none; margin-top: 20px;">
                        <label class="photo-upload" for="fahrzeugscheinInputFile">
                            <div class="icon">üìÑ</div>
                            <div class="text">
                                Fahrzeugschein fotografieren<br>
                                <small>(Seite 1 - Vorderseite)</small>
                            </div>
                            <input type="file" id="fahrzeugscheinInputFile" accept="image/*" multiple capture="environment">
                        </label>
                        <div class="photo-preview" id="fahrzeugscheinPreview"></div>
                    </div>
                </div>
                <p style="color: #999; font-size: 13px; margin-top: 15px;">
                    üí° Tipp: Die FIN/VIN hilft uns, die richtigen Ersatzteile zu finden
                </p>
            </div>

            <!-- Step 4: Reifen-Typ -->
            <div class="wizard-step" data-step="4">
                <div class="step-title">
                    <span class="icon">‚ùÑÔ∏è</span>
                    <span>Reifen-Typ</span>
                </div>
                <div class="form-group">
                    <label>Welche Art von Reifen wird ben√∂tigt?</label>
                    <div class="radio-group">
                        <label class="radio-option selected" onclick="selectReifenTyp(this, 'sommer')">
                            <input type="radio" name="reifenTyp" value="sommer" checked>
                            <div class="label">‚òÄÔ∏è Sommerreifen</div>
                            <div class="description">F√ºr trockene und nasse Stra√üen</div>
                        </label>
                        <label class="radio-option" onclick="selectReifenTyp(this, 'winter')">
                            <input type="radio" name="reifenTyp" value="winter">
                            <div class="label">Winterreifen</div>
                            <div class="description">F√ºr Schnee, Eis und K√§lte</div>
                        </label>
                        <label class="radio-option" onclick="selectReifenTyp(this, 'ganzjahr')">
                            <input type="radio" name="reifenTyp" value="ganzjahr">
                            <div class="label">Ganzjahresreifen</div>
                            <div class="description">Allwetter, das ganze Jahr nutzbar</div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Step 5: Service-Art -->
            <div class="wizard-step" data-step="5">
                <div class="step-title">
                    <span class="icon"></span>
                    <span>Service-Art</span>
                </div>
                <div class="form-group">
                    <label>Welche Dienstleistung wird ben√∂tigt?</label>
                    <div class="radio-group">
                        <label class="radio-option selected" onclick="selectServiceArt(this, 'wechsel')">
                            <input type="radio" name="serviceArt" value="wechsel" checked>
                            <div class="label">Reifenwechsel</div>
                            <div class="description">Sommer ‚Üî Winter Wechsel</div>
                        </label>
                        <label class="radio-option" onclick="selectServiceArt(this, 'bestellung')">
                            <input type="radio" name="serviceArt" value="bestellung">
                            <div class="label">üõí Reifen-Bestellung</div>
                            <div class="description">Neue Reifen bestellen & montieren</div>
                        </label>
                        <label class="radio-option" onclick="selectServiceArt(this, 'montage')">
                            <input type="radio" name="serviceArt" value="montage">
                            <div class="label">üî© Montage</div>
                            <div class="description">Reifen auf Felgen montieren</div>
                        </label>
                        <label class="radio-option" onclick="selectServiceArt(this, 'einlagerung')">
                            <input type="radio" name="serviceArt" value="einlagerung">
                            <div class="label">üì¶ Einlagerung</div>
                            <div class="description">Reifenlagerung (Sommer/Winter)</div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Step 6: Dimension -->
            <div class="wizard-step" data-step="6">
                <div class="step-title">
                    <span class="icon">üìê</span>
                    <span>Reifengr√∂√üe</span>
                </div>
                <div class="form-group">
                    <label for="reifenDimension">Reifengr√∂√üe (optional - falls bekannt)</label>
                    <input type="text" id="reifenDimension" placeholder="z.B. 205/55 R16 91V">
                    <small style="color: #999; font-size: 12px; margin-top: 5px; display: block;">
                        Steht an der Reifenflanke, z.B. 205/55 R16 oder 225/45 R17
                    </small>
                </div>
                <div class="form-group">
                    <label for="reifenAnzahl">Anzahl Reifen</label>
                    <select id="reifenAnzahl">
                        <option value="2">2 Reifen</option>
                        <option value="4" selected>4 Reifen</option>
                        <option value="5">5 Reifen (inkl. Ersatzrad)</option>
                    </select>
                </div>
            </div>

            <!-- Step 7: Termin-Auswahl -->
            <div class="wizard-step" data-step="7">
                <div class="step-title">
                    <span class="icon"></span>
                    <span>Gew√ºnschter Termin</span>
                </div>
                <div class="form-group">
                    <label>Wann soll der Service durchgef√ºhrt werden?</label>
                    <div class="termin-grid" id="terminGrid">
                        <div class="loading">
                            <div class="icon">‚è≥</div>
                            <div>Lade verf√ºgbare Termine...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 8: Lieferoptionen -->
            <div class="wizard-step" data-step="8">
                <div class="step-title">
                    <span class="icon">üöó</span>
                    <span>Lieferung & Services</span>
                </div>
                <div class="form-group">
                    <label>Wie wird das Fahrzeug angeliefert?</label>
                    <div class="toggle-group">
                        <label class="toggle-option selected" onclick="selectLieferoption('selbst_bringen')">
                            <input type="radio" name="lieferoption" value="selbst_bringen" checked>
                            ‚úÖ Selbst bringen
                        </label>
                        <label class="toggle-option" onclick="selectLieferoption('abholung')">
                            <input type="radio" name="lieferoption" value="abholung">
                            üöö Abholservice
                        </label>
                    </div>

                    <!-- Abholservice Details -->
                    <div id="abholserviceDetails" class="conditional-field" style="display: none;">
                        <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 15px; border-radius: 4px; margin-bottom: 15px;">
                            <p style="margin: 0; color: #1976d2; font-size: 13px; line-height: 1.6;">
                                üìç <strong>Abholung:</strong> Wir holen das Fahrzeug am <strong>Vortag vor dem Anliefertermin</strong> an Ihrer Gesch√§ftsadresse ab.<br>
                                <small style="color: #666;">Den genauen Abholtermin erhalten Sie mit dem Kostenvoranschlag.</small>
                            </p>
                        </div>
                        <div class="form-group">
                            <label for="abholadresse">Abholadresse</label>
                            <input type="text" id="abholadresse" placeholder="Stra√üe, Hausnummer, PLZ Ort">
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="ersatzfahrzeugGewuenscht" style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                                <span style="font-size: 14px;">
                                    Ersatzfahrzeug gew√ºnscht <small style="color: #999;">(+Aufpreis)</small>
                                </span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 9: Anmerkungen -->
            <div class="wizard-step" data-step="9">
                <div class="step-title">
                    <span class="icon"></span>
                    <span>Anmerkungen</span>
                </div>
                <div class="form-group">
                    <label for="anmerkungen">Zus√§tzliche Anmerkungen (optional)</label>
                    <textarea id="anmerkungen" placeholder="z.B. besondere W√ºnsche, Felgen-Informationen, Besch√§digungen..."></textarea>
                </div>
            </div>

            <!-- Step 10: Zusammenfassung -->
            <div class="wizard-step" data-step="10">
                <div class="step-title">
                    <span class="icon"></span>
                    <span>Zusammenfassung</span>
                </div>
                <p style="color: #666; margin-bottom: 20px;">Bitte √ºberpr√ºfen Sie Ihre Angaben vor dem Absenden:</p>
                <div id="summaryContent"></div>
            </div>

        </div>

        <!-- Navigation Buttons -->
        <div class="wizard-nav">
            <button type="button" class="btn btn-back" id="btnBack" onclick="prevStep()" style="display: none;">
                ‚Üê Zur√ºck
            </button>
            <button type="button" class="btn btn-primary" id="btnNext" onclick="nextStep()">
                Weiter ‚Üí
            </button>
        </div>

        <!-- Success Message -->
        <div class="success-message" id="successMessage">
            <div class="icon"></div>
            <h3>Anfrage erfolgreich gesendet!</h3>
            <p>Wir melden uns schnellstm√∂glich mit einem Kostenvoranschlag bei Ihnen.</p>
            <button class="btn btn-primary" onclick="window.safeNavigate('meine-anfragen.html')">
                Zu meinen Anfragen
            </button>
        </div>
    </div>
    </div><!-- End main-layout -->

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <script src="../firebase-config.js?v=a4192c4"></script>
    <script src="../js/settings-manager.js"></script>
    <script src="../js/auth-manager.js"></script>
    <script>
        // Global Variables
        let currentStep = 1;
        const totalSteps = 10;
        let partner = null;
        let photos = [];
        let fahrzeugscheinPhotos = [];

        // üõ°Ô∏è DEFENSE IN DEPTH (2025-11-14): serviceTyp Validation
        function validateServiceTyp(serviceTyp) {
            const validTypes = ['lackier', 'reifen', 'mechanik', 'pflege', 'tuev', 'versicherung', 'glas', 'klima', 'dellen', 'folierung', 'steinschutz', 'werbebeklebung'];
            const serviceTypMap = {'lackschutz': 'steinschutz', 'lackierung': 'lackier', 'smart-repair': 'dellen', 'smartrepair': 'dellen', 'pdr': 'dellen', 'aufbereitung': 'pflege', 't√ºv': 'tuev', 'tauv': 'tuev', 'karosserie': 'lackier', 'unfall': 'versicherung'};
            let correctedTyp = serviceTypMap[serviceTyp] || serviceTyp;
            if (!validTypes.includes(correctedTyp)) { console.error(`‚ùå INVALID serviceTyp: "${serviceTyp}" ‚Üí Fallback: "lackier"`); return 'lackier'; }
            if (correctedTyp !== serviceTyp) { console.warn(`üîß AUTO-FIX serviceTyp: "${serviceTyp}" ‚Üí "${correctedTyp}"`); }
            return correctedTyp;
        }

        // ============================================
        // PRE-INITIALIZE werkstattId from localStorage
        // ============================================
        // CRITICAL: Set werkstattId BEFORE auth-check polling!
        const storedPartner = JSON.parse(localStorage.getItem('partner') || 'null');
        window.werkstattId = (storedPartner && storedPartner.werkstattId) || 'mosbach';
        console.log('‚úÖ [REIFEN-ANFRAGE] werkstattId pre-initialized:', window.werkstattId);

        // ============================================
        // AUTH-CHECK POLLING (20 Versuche √ó 250ms)
        // ============================================
        // Warte auf BEIDE: window.firebaseInitialized UND window.werkstattId
        let authCheckAttempts = 0;
        const maxAuthCheckAttempts = 20;

        const authCheckInterval = setInterval(async () => {
            authCheckAttempts++;

            // Pr√ºfe ob Firebase UND werkstattId bereit sind
            if (window.firebaseInitialized && window.werkstattId) {
                clearInterval(authCheckInterval);
                console.log('‚úÖ [REIFEN-ANFRAGE] Firebase + werkstattId ready - Safe to use Firestore!');

                // JETZT erst mit Initialisierung fortfahren
                await initFirebase();
                checkLogin();
                setupPhotoUpload();
                setupFahrzeugscheinUpload();
                // üîí AUTH-FIX: ladeSmartetermine() wird jetzt im Auth-State-Listener aufgerufen
                setupAuthListener(); // NEU: Warte auf Auth Ready
                updateProgress();
                return;
            }

            // Timeout nach 5 Sekunden (20 √ó 250ms)
            if (authCheckAttempts >= maxAuthCheckAttempts) {
                clearInterval(authCheckInterval);
                console.error('‚ùå [REIFEN-ANFRAGE] Firebase initialization timeout - werkstattId not available!');
                showToast('Fehler: Werkstatt-Initialisierung fehlgeschlagen. Bitte neu einloggen.', 'error');
                window.safeNavigate('index.html');
            }
        }, 250);

        function checkLogin() {
            partner = JSON.parse(localStorage.getItem('partner') || 'null');
            if (!partner) {
                window.safeNavigate('index.html');
                return;
            }

            // üÜï MULTI-TENANT: Set werkstattId from partner object (with fallback)
            window.werkstattId = (partner && partner.werkstattId) || 'mosbach';
            if (!partner || !partner.werkstattId) {
                console.warn('‚ö†Ô∏è [REIFEN-ANFRAGE] partner.werkstattId missing, using fallback: mosbach');
            }
            console.log('‚úÖ [REIFEN-ANFRAGE] werkstattId initialized:', window.werkstattId);

            document.getElementById('partnerName').textContent = partner.name;

            // Load Werkstatt-Logo & Branding
            (async () => {
                try {
                    const settings = await window.settingsManager.loadSettings();
                    if (settings?.profil) {
                        // Update Page Title
                        document.title = `${settings.profil.name} | Reifen-Service`;

                        // Display Logo
                        if (settings.profil.logoUrl) {
                            const logoContainer = document.getElementById('werkstattLogo');
                            if (logoContainer) {
                                logoContainer.innerHTML = `
                                    <img src="${settings.profil.logoUrl}"
                                         alt="${settings.profil.name}"
                                         style="height: 32px; width: auto; vertical-align: middle;">
                                `;
                                console.log('‚úÖ [PARTNER-REIFEN] Werkstatt-Logo angezeigt:', settings.profil.name);
                            }
                        }
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è [PARTNER-REIFEN] Werkstatt-Branding konnte nicht geladen werden:', error);
                }
            })();
        }

        // üîí AUTH-FIX: Auth-State-Listener f√ºr Kalender-Loading
        function setupAuthListener() {
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    console.log('‚úÖ Auth ready, loading calendar...');
                    ladeSmartetermine();
                }
            });
        }

        // Progress Update
        function updateProgress() {
            const percent = (currentStep / totalSteps) * 100;
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = `Schritt ${currentStep} von ${totalSteps}`;
        }

        // Navigation Functions
        function nextStep() {
            // Validate current step
            if (!validateStep(currentStep)) {
                return;
            }

            if (currentStep === totalSteps) {
                submitAnfrage();
                return;
            }

            // Move to next step
            const currentStepEl = document.querySelector(`.wizard-step[data-step="${currentStep}"]`);
            const nextStepEl = document.querySelector(`.wizard-step[data-step="${currentStep + 1}"]`);

            currentStepEl.classList.remove('active');
            currentStepEl.classList.add('prev');

            setTimeout(() => {
                currentStepEl.classList.remove('prev');
            }, 400);

            nextStepEl.classList.add('active');

            currentStep++;
            updateProgress();
            updateButtons();
            updateSidebar();

            // Generate summary on step 9
            if (currentStep === totalSteps) {
                generateSummary();
            }

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function prevStep() {
            if (currentStep === 1) return;

            const currentStepEl = document.querySelector(`.wizard-step[data-step="${currentStep}"]`);
            const prevStepEl = document.querySelector(`.wizard-step[data-step="${currentStep - 1}"]`);

            currentStepEl.classList.remove('active');
            prevStepEl.classList.add('active');

            currentStep--;
            updateProgress();
            updateButtons();
            updateSidebar();

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateButtons() {
            const btnBack = document.getElementById('btnBack');
            const btnNext = document.getElementById('btnNext');

            if (currentStep === 1) {
                btnBack.style.display = 'none';
            } else {
                btnBack.style.display = 'inline-flex';
            }

            if (currentStep === totalSteps) {
                btnNext.textContent = 'Anfrage senden';
            } else {
                btnNext.textContent = 'Weiter ‚Üí';
            }
        }

        // Validation per Step
        function validateStep(step) {
            switch(step) {
                case 1: // Reifenfotos
                    if (photos.length === 0) {
                        showToast('Bitte laden Sie mindestens ein Foto hoch.', 'error');
                        return false;
                    }
                    return true;

                case 2: // Fahrzeug-Referenz + Fahrzeugdaten
                    const referenzType = document.querySelector('input[name="referenzType"]:checked').value;
                    if (referenzType === 'kennzeichen' && !document.getElementById('kennzeichen').value.trim()) {
                        showToast('Bitte geben Sie das Kennzeichen ein.', 'error');
                        return false;
                    }
                    if (referenzType === 'auftrag' && !document.getElementById('auftragsnummer').value.trim()) {
                        showToast('Bitte geben Sie die Auftragsnummer ein.', 'error');
                        return false;
                    }
                    // NEU: Fahrzeugdaten-Validierung
                    const marke = document.getElementById('marke').value;
                    const modell = document.getElementById('modell').value.trim();
                    const baujahr = document.getElementById('baujahr').value;

                    if (!marke || marke === '') {
                        showToast('Bitte w√§hlen Sie die Fahrzeugmarke aus.', 'error');
                        return false;
                    }
                    if (!modell) {
                        showToast('Bitte geben Sie das Fahrzeugmodell ein.', 'error');
                        return false;
                    }
                    if (!baujahr || baujahr < 1950 || baujahr > 2025) {
                        showToast('Bitte geben Sie ein g√ºltiges Baujahr ein (1950-2025).', 'error');
                        return false;
                    }
                    return true;

                default:
                    // Steps 3-7 haben keine Pflichtfelder
                    return true;
            }
        }

        // Image Compression Function
        async function compressImage(base64, maxWidth = 800, quality = 0.65) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    let width = img.width;
                    let height = img.height;
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.onerror = () => reject(new Error('Komprimierung fehlgeschlagen'));
                img.src = base64;
            });
        }

        // Photo Upload (Schadensfotos)
        function setupPhotoUpload() {
            const input = document.getElementById('photoInput');
            window.listenerRegistry.registerDOM(input, 'change', handlePhotoUpload, 'input change');
        }

        async function handlePhotoUpload(event) {
            const files = Array.from(event.target.files);

            for (const file of files) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    photos.push(e.target.result);
                    displayPhotos();
                    updateNextButtonState();
                };
                reader.readAsDataURL(file);
            }
        }

        function displayPhotos() {
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = '';

            photos.forEach((photo, index) => {
                const div = document.createElement('div');
                div.className = 'photo-preview-item';
                div.innerHTML = `
                    <img src="${photo}" alt="Foto ${index + 1}">
                    <button type="button" class="remove-btn" onclick="removePhoto(${index})">√ó</button>
                `;
                preview.appendChild(div);
            });
        }

        function removePhoto(index) {
            photos.splice(index, 1);
            displayPhotos();
            updateNextButtonState();
        }

        // ‚úÖ FIX: Upload photos to Firebase Storage (instead of Base64 in Firestore)
        async function uploadPhotosToStorage(photoBase64Array, anfrageId) {
            if (!firebase.storage) {
                console.warn('‚ö†Ô∏è Firebase Storage not available - falling back to Base64');
                return photoBase64Array;
            }

            const storage = firebase.storage();
            const uploadedURLs = [];
            const btnNext = document.getElementById('btnNext');

            for (let i = 0; i < photoBase64Array.length; i++) {
                const base64 = photoBase64Array[i];

                // Update button text with progress
                btnNext.textContent = `üì§ Uploading photo ${i + 1}/${photoBase64Array.length}...`;

                // Convert Base64 to Blob
                const response = await fetch(base64);
                const blob = await response.blob();

                // Generate unique filename
                const timestamp = Date.now();
                const filename = `photo_${i}_${timestamp}.jpg`;
                const storagePath = `partner-anfragen/${partner.werkstattId}/${anfrageId}/${filename}`;

                // Upload to Storage
                const storageRef = storage.ref(storagePath);
                await storageRef.put(blob);

                // Get download URL
                const downloadURL = await storageRef.getDownloadURL();
                uploadedURLs.push(downloadURL);

                console.log(`‚úÖ Photo ${i + 1} uploaded: ${storagePath}`);
            }

            return uploadedURLs;
        }

        function updateNextButtonState() {
            const btnNext = document.getElementById('btnNext');
            if (currentStep === 1) {
                btnNext.disabled = photos.length === 0;
            }
        }

        // Fahrzeugschein Upload
        function setupFahrzeugscheinUpload() {
            const input = document.getElementById('fahrzeugscheinInputFile');
            window.listenerRegistry.registerDOM(input, 'change', handleFahrzeugscheinUpload, 'input change');
        }

        async function handleFahrzeugscheinUpload(event) {
            const files = Array.from(event.target.files);

            for (const file of files) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    fahrzeugscheinPhotos.push(e.target.result);
                    displayFahrzeugscheinPhotos();
                };
                reader.readAsDataURL(file);
            }
        }

        function displayFahrzeugscheinPhotos() {
            const preview = document.getElementById('fahrzeugscheinPreview');
            preview.innerHTML = '';

            fahrzeugscheinPhotos.forEach((photo, index) => {
                const div = document.createElement('div');
                div.className = 'photo-preview-item';
                div.innerHTML = `
                    <img src="${photo}" alt="Fahrzeugschein ${index + 1}">
                    <button type="button" class="remove-btn" onclick="removeFahrzeugscheinPhoto(${index})">√ó</button>
                `;
                preview.appendChild(div);
            });
        }

        function removeFahrzeugscheinPhoto(index) {
            fahrzeugscheinPhotos.splice(index, 1);
            displayFahrzeugscheinPhotos();
        }

        // Toggle Functions
        function selectReferenzType(type) {
            document.querySelectorAll('input[name="referenzType"]').forEach(input => {
                input.parentElement.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            const kennzeichenDiv = document.getElementById('kennzeichenInput');
            const auftragDiv = document.getElementById('auftragInput');

            if (type === 'kennzeichen') {
                kennzeichenDiv.style.display = 'block';
                auftragDiv.style.display = 'none';
                document.getElementById('auftragsnummer').value = '';
            } else {
                kennzeichenDiv.style.display = 'none';
                auftragDiv.style.display = 'block';
                document.getElementById('kennzeichen').value = '';
            }
        }

        function selectIdentificationType(type) {
            document.querySelectorAll('input[name="identificationType"]').forEach(input => {
                input.parentElement.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            const vinDiv = document.getElementById('vinInput');
            const fahrzeugscheinDiv = document.getElementById('fahrzeugscheinInput');

            if (type === 'vin') {
                vinDiv.style.display = 'block';
                fahrzeugscheinDiv.style.display = 'none';
                fahrzeugscheinPhotos = [];
                document.getElementById('fahrzeugscheinPreview').innerHTML = '';
            } else {
                vinDiv.style.display = 'none';
                fahrzeugscheinDiv.style.display = 'block';
                document.getElementById('vin').value = '';
            }
        }

        function selectLieferoption(option) {
            document.querySelectorAll('input[name="lieferoption"]').forEach(input => {
                input.parentElement.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            const abholserviceDetails = document.getElementById('abholserviceDetails');
            if (option === 'abholung') {
                abholserviceDetails.style.display = 'block';
            } else {
                abholserviceDetails.style.display = 'none';
                document.getElementById('abholadresse').value = '';
                if (document.getElementById('ersatzfahrzeugGewuenscht')) {
                    document.getElementById('ersatzfahrzeugGewuenscht').checked = false;
                }
            }
        }

        function selectErsatzfahrzeug(element, value) {
            document.querySelectorAll('input[name="ersatzfahrzeug"]').forEach(input => {
                input.parentElement.classList.remove('selected');
            });
            element.classList.add('selected');
            element.querySelector('input').checked = true;
        }

        function selectReifenTyp(element, value) {
            document.querySelectorAll('.radio-option').forEach(opt => {
                if (opt.querySelector('input[name="reifenTyp"]')) {
                    opt.classList.remove('selected');
                }
            });
            element.classList.add('selected');
            element.querySelector('input').checked = true;
        }

        function selectServiceArt(element, value) {
            document.querySelectorAll('.radio-option').forEach(opt => {
                if (opt.querySelector('input[name="serviceArt"]')) {
                    opt.classList.remove('selected');
                }
            });
            element.classList.add('selected');
            element.querySelector('input').checked = true;
        }

        // Smart Termine laden
        async function ladeSmartetermine() {
            const terminGrid = document.getElementById('terminGrid');

            if (!db) {
                console.error('Firebase nicht initialisiert');
                terminGrid.innerHTML = '<div class="loading"><div style="color: red;">Fehler beim Laden der Termine</div></div>';
                return;
            }

            try {
                const heute = new Date();
                heute.setHours(0, 0, 0, 0);
                const terminOptionen = [];

                console.log('üìÖ Lade Terminauslastung...');

                // üîí SECURITY: Get current user email for Query-Rule Compliance
                const currentUser = firebase.auth().currentUser;
                if (!currentUser) {
                    console.warn('‚ö†Ô∏è User not authenticated yet, skipping calendar load');
                    return;
                }
                const userEmail = currentUser.email.toLowerCase();

                for (let i = 0; i < 14; i++) {
                    const datum = new Date(heute);
                    datum.setDate(heute.getDate() + i);
                    const dateStr = datum.toISOString().split('T')[0];

                    // üîí SECURITY: Filter by partnerEmail for Query-Rule Compliance
                    const annahmeSnapshot = await window.getCollection('fahrzeuge')
                        .where('partnerEmail', '==', userEmail)
                        .where('annahmeDatum', '==', dateStr)
                        .get();
                    const abnahmeSnapshot = await window.getCollection('fahrzeuge')
                        .where('partnerEmail', '==', userEmail)
                        .where('geplantesAbnahmeDatum', '==', dateStr)
                        .get();

                    const totalTermine = annahmeSnapshot.size + abnahmeSnapshot.size;

                    let auslastung;
                    if (totalTermine <= 2) auslastung = 'frei';
                    else if (totalTermine <= 4) auslastung = 'normal';
                    else auslastung = 'hoch';

                    terminOptionen.push({
                        datum: datum,
                        dateStr: dateStr,
                        anzahlTermine: totalTermine,
                        auslastung: auslastung,
                        tageVonHeute: i
                    });
                }

                const option1 = terminOptionen.find(t => t.tageVonHeute >= 1 && t.auslastung === 'frei') || terminOptionen[1];
                const option2 = terminOptionen.find(t => t.tageVonHeute >= 2 && t.tageVonHeute <= 3 && t.auslastung === 'frei') || terminOptionen[2];
                const option3 = terminOptionen.find(t => t.tageVonHeute >= 4 && t.tageVonHeute <= 6 && t.auslastung !== 'hoch') || terminOptionen[5];
                const option4 = terminOptionen.find(t => t.tageVonHeute >= 7 && t.tageVonHeute <= 10) || terminOptionen[8];

                const selectedTermine = [option1, option2, option3, option4];
                const labels = ['EXPRESS', 'SCHNELL', 'NORMAL', 'ENTSPANNT'];
                const colors = ['#d32f2f', '#ff6f00', '#1976d2', '#388e3c'];

                terminGrid.innerHTML = selectedTermine.map((t, idx) => {
                    const auslastungIcon = t.auslastung === 'frei' ? 'üü¢' : t.auslastung === 'normal' ? 'üü°' : 'üî¥';
                    const auslastungText = t.auslastung === 'frei' ? 'Freie Kapazit√§t' : t.auslastung === 'normal' ? 'Normale Auslastung' : 'Ausgelastet';
                    const wochentag = t.datum.toLocaleDateString('de-DE', { weekday: 'short' });
                    const tag = t.datum.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });

                    return `
                        <label class="termin-option ${idx === 0 ? 'selected' : ''}" onclick="selectTermin(this)">
                            <input type="radio" name="anliefertermin" value="${t.dateStr}" data-label="${labels[idx]}" ${idx === 0 ? 'checked' : ''}>
                            <div class="label" style="color: ${colors[idx]};">${labels[idx]}</div>
                            <div style="font-weight: 600; margin: 5px 0;">${wochentag}, ${tag}</div>
                            <small style="display: block;">${auslastungIcon} ${auslastungText}</small>
                            <small style="display: block; color: #999; margin-top: 3px;">
                                ${t.tageVonHeute === 0 ? 'Heute' : t.tageVonHeute === 1 ? 'Morgen' : `in ${t.tageVonHeute} Tagen`}
                            </small>
                        </label>
                    `;
                }).join('');

            } catch (error) {
                console.error('Fehler beim Laden der Termine:', error);
                terminGrid.innerHTML = '<div class="loading"><div style="color: red;">Fehler beim Laden der Termine</div></div>';
            }
        }

        function selectTermin(element) {
            document.querySelectorAll('.termin-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            element.classList.add('selected');
            element.querySelector('input').checked = true;
        }

        // Summary Generation
        function generateSummary() {
            const summaryContent = document.getElementById('summaryContent');
            const referenzType = document.querySelector('input[name="referenzType"]:checked').value;
            const reifenTyp = document.querySelector('input[name="reifenTyp"]:checked').value;
            const serviceArt = document.querySelector('input[name="serviceArt"]:checked').value;
            const termin = document.querySelector('input[name="anliefertermin"]:checked');

            let html = '';

            // Fotos
            html += `
                <div class="summary-section">
                    <h3> Reifenfotos</h3>
                    <p>${photos.length} Foto(s) hochgeladen</p>
                </div>
            `;

            // Fahrzeug-Referenz
            html += `
                <div class="summary-section">
                    <h3> Fahrzeug-Referenz</h3>
                    <p class="label">${referenzType === 'kennzeichen' ? 'Kennzeichen' : 'Auftragsnummer'}</p>
                    <p>${referenzType === 'kennzeichen' ? document.getElementById('kennzeichen').value : document.getElementById('auftragsnummer').value}</p>
                </div>
            `;

            // NEU: Fahrzeugdaten
            const marke = document.getElementById('marke').value;
            const modell = document.getElementById('modell').value;
            const baujahr = document.getElementById('baujahr').value;
            const kilometerstand = document.getElementById('kilometerstand').value;
            html += `
                <div class="summary-section">
                    <h3>üöó Fahrzeugdaten</h3>
                    <p class="label">Marke & Modell</p>
                    <p>${marke} ${modell}</p>
                    <p class="label" style="margin-top: 5px;">Baujahr</p>
                    <p>${baujahr}</p>
                    ${kilometerstand ? `<p class="label" style="margin-top: 5px;">Kilometerstand</p><p>${Number(kilometerstand).toLocaleString('de-DE')} km</p>` : ''}
                </div>
            `;

            // Fahrzeugidentifikation (NEU)
            const identificationType = document.querySelector('input[name="identificationType"]:checked').value;
            html += `
                <div class="summary-section">
                    <h3>üî¢ Fahrzeugidentifikation</h3>
                    <p class="label">${identificationType === 'vin' ? 'FIN/VIN' : 'Fahrzeugschein'}</p>
                    <p>${identificationType === 'vin' ? document.getElementById('vin').value || 'Nicht angegeben' : fahrzeugscheinPhotos.length + ' Foto(s) hochgeladen'}</p>
                </div>
            `;

            // Reifen-Typ
            const reifenTypLabel = reifenTyp === 'sommer' ? '‚òÄÔ∏è Sommerreifen' :
                                   reifenTyp === 'winter' ? 'Winterreifen' : 'Ganzjahresreifen';
            html += `
                <div class="summary-section">
                    <h3>Reifen-Typ</h3>
                    <p>${reifenTypLabel}</p>
                </div>
            `;

            // Service-Art
            const serviceArtLabel = serviceArt === 'wechsel' ? 'Reifenwechsel' :
                                    serviceArt === 'bestellung' ? 'üõí Reifen-Bestellung' :
                                    serviceArt === 'montage' ? 'üî© Montage' : 'üì¶ Einlagerung';
            html += `
                <div class="summary-section">
                    <h3> Service-Art</h3>
                    <p>${serviceArtLabel}</p>
                </div>
            `;

            // Dimension & Anzahl
            const dimension = document.getElementById('reifenDimension').value;
            const anzahl = document.getElementById('reifenAnzahl').value;
            html += `
                <div class="summary-section">
                    <h3>üìê Reifengr√∂√üe & Anzahl</h3>
                    ${dimension ? `<p class="label">Dimension</p><p>${dimension}</p>` : '<p class="label">Dimension</p><p>Nicht angegeben</p>'}
                    <p class="label" style="margin-top: 5px;">Anzahl</p>
                    <p>${anzahl} Reifen</p>
                </div>
            `;

            // Termin
            if (termin) {
                const terminLabel = termin.getAttribute('data-label');
                const terminDatum = new Date(termin.value).toLocaleDateString('de-DE', { weekday: 'long', day: '2-digit', month: '2-digit', year: 'numeric' });
                html += `
                    <div class="summary-section">
                        <h3> Gew√ºnschter Termin</h3>
                        <p class="label">${terminLabel}</p>
                        <p>${terminDatum}</p>
                    </div>
                `;
            }

            // Lieferoptionen (NEU)
            const lieferoption = document.querySelector('input[name="lieferoption"]:checked').value;
            const ersatzfahrzeugCheckbox = document.getElementById('ersatzfahrzeugGewuenscht');
            html += `
                <div class="summary-section">
                    <h3>üöó Lieferung & Services</h3>
                    <p class="label">Anlieferung</p>
                    <p>${lieferoption === 'selbst_bringen' ? '‚úÖ Partner bringt Fahrzeug selbst' : 'üöö Abholservice gew√ºnscht'}</p>
                    ${lieferoption === 'abholung' ? `
                        <p class="label" style="margin-top: 10px;">Abholadresse</p>
                        <p>${document.getElementById('abholadresse').value || 'Nicht angegeben'}</p>
                        <p class="label" style="margin-top: 5px;">Abholtermin</p>
                        <p>Wird 1 Tag vor Anliefertermin festgelegt</p>
                        <p class="label" style="margin-top: 10px;">Ersatzfahrzeug</p>
                        <p>${ersatzfahrzeugCheckbox?.checked ? 'üöô Ja, ben√∂tigt' : '‚ùå Nein, danke'}</p>
                    ` : ''}
                </div>
            `;

            // Anmerkungen
            const anmerkungen = document.getElementById('anmerkungen').value;
            if (anmerkungen) {
                html += `
                    <div class="summary-section">
                        <h3> Anmerkungen</h3>
                        <p>${anmerkungen}</p>
                    </div>
                `;
            }

            summaryContent.innerHTML = html;
        }

        // Submit Anfrage
        async function submitAnfrage() {
            const btnNext = document.getElementById('btnNext');
            btnNext.disabled = true;
            btnNext.textContent = '‚è≥ Wird komprimiert & gesendet...';

            try {
                if (!db) throw new Error('Firebase nicht verf√ºgbar');

                // ‚úÖ FIX: Generate anfrage ID FIRST (needed for Storage path)
                const anfrageId = 'req_' + Date.now();
                const timestamp = new Date().toISOString();

                // Fotos komprimieren
                console.log('üì∏ Komprimiere ' + photos.length + ' Fotos...');
                btnNext.textContent = 'Fotos komprimieren...';
                const compressedPhotos = await Promise.all(photos.map(p => compressImage(p)));

                // ‚úÖ FIX: Upload photos to Firebase Storage
                console.log('üì§ Uploading ' + compressedPhotos.length + ' photos to Storage...');
                btnNext.textContent = 'Fotos hochladen...';
                const photoURLs = await uploadPhotosToStorage(compressedPhotos, anfrageId);

                const referenzType = document.querySelector('input[name="referenzType"]:checked').value;
                const termin = document.querySelector('input[name="anliefertermin"]:checked');
                const identificationType = document.querySelector('input[name="identificationType"]:checked').value;
                const lieferoption = document.querySelector('input[name="lieferoption"]:checked').value;

                // Fahrzeugschein-Fotos komprimieren (falls vorhanden)
                let compressedFahrzeugscheinFotos = [];
                if (fahrzeugscheinPhotos.length > 0) {
                    console.log('üìÑ Komprimiere ' + fahrzeugscheinPhotos.length + ' Fahrzeugschein-Foto(s)...');
                    compressedFahrzeugscheinFotos = await Promise.all(fahrzeugscheinPhotos.map(p => compressImage(p)));
                }

                const anfrageData = {
                    id: anfrageId,
                    partnerId: partner.partnerId || partner.id, // ‚úÖ Fallback for old partner objects
                    partnerName: partner.name,
                    partnerEmail: firebase.auth().currentUser.email.toLowerCase(),
                    kundenEmail: firebase.auth().currentUser.email.toLowerCase(),
                    serviceTyp: 'reifen',
                    timestamp: timestamp,
                    erstelltAm: timestamp,

                    // Fahrzeug-Referenz
                    referenzType: referenzType,
                    kennzeichen: referenzType === 'kennzeichen' ? document.getElementById('kennzeichen').value.toUpperCase() : null,
                    auftragsnummer: referenzType === 'auftrag' ? document.getElementById('auftragsnummer').value : null,

                    // NEU: Fahrzeugdaten f√ºr KVA-Kalkulation
                    marke: document.getElementById('marke').value,
                    modell: document.getElementById('modell').value,
                    baujahr: parseInt(document.getElementById('baujahr').value),
                    kilometerstand: document.getElementById('kilometerstand').value ? parseInt(document.getElementById('kilometerstand').value) : null,

                    // Fahrzeugidentifikation (NEU)
                    identificationType: identificationType,
                    vin: identificationType === 'vin' ? document.getElementById('vin').value.toUpperCase() : null,
                    fahrzeugscheinFotos: identificationType === 'fahrzeugschein' ? compressedFahrzeugscheinFotos : [],

                    // TOP-LEVEL FELD F√úR KVA (wird von kva-erstellen.html erwartet)
                    schadenBeschreibung: document.getElementById('anmerkungen').value || '',

                    // Reifen-Daten (serviceData-Objekt f√ºr KVA-Anzeige)
                    serviceData: {
                        typ: document.querySelector('input[name="reifenTyp"]:checked').value,
                        art: document.querySelector('input[name="serviceArt"]:checked').value,
                        dimension: document.getElementById('reifenDimension').value || null,
                        anzahl: document.getElementById('reifenAnzahl').value,
                        info: document.getElementById('anmerkungen').value || null
                    },

                    // Termin
                    anliefertermin: termin ? termin.value : null,
                    dringlichkeitLabel: termin ? termin.getAttribute('data-label') : 'NORMAL',

                    // Lieferoptionen (NEU)
                    lieferoption: lieferoption,
                    abholserviceGewuenscht: lieferoption === 'abholung',
                    abholtermin: null, // Wird vom Lackierer im KVA festgelegt (1 Tag vor Anliefertermin)
                    abholadresse: lieferoption === 'abholung' ? (document.getElementById('abholadresse').value || null) : null,
                    ersatzfahrzeugGewuenscht: lieferoption === 'abholung' ? (document.getElementById('ersatzfahrzeugGewuenscht')?.checked || false) : false,

                    // ‚úÖ FIX: Store Storage URLs instead of Base64
                    fotos: photoURLs,
                    fotoCount: photoURLs.length,

                    // Status
                    status: 'neu',
                    statusText: 'Neu eingegangen',
                    kva: null,
                    fahrzeugId: null
                };

                // üõ°Ô∏è DEFENSE IN DEPTH: Validate serviceTyp before saving
                anfrageData.serviceTyp = validateServiceTyp(anfrageData.serviceTyp);

                await window.getCollection('partnerAnfragen').doc(anfrageId).set(anfrageData);

                console.log('Anfrage gespeichert:', anfrageId);

                // Show success
                document.querySelector('.wizard-container').style.display = 'none';
                document.querySelector('.wizard-nav').style.display = 'none';
                document.querySelector('.progress-container').style.display = 'none';
                document.getElementById('successMessage').classList.add('show');

            } catch (error) {
                console.error('Fehler:', error);
                alert('Fehler beim Senden der Anfrage: ' + error.message);
                btnNext.disabled = false;
                btnNext.textContent = 'Anfrage senden';
            }
        }

        // Update Sidebar
        function updateSidebar() {
            const sidebarSteps = document.querySelectorAll('.sidebar-step');

            sidebarSteps.forEach((step, index) => {
                const stepNumber = index + 1;

                // Remove all state classes
                step.classList.remove('completed', 'active', 'pending');

                // Add appropriate class based on current step
                if (stepNumber < currentStep) {
                    step.classList.add('completed');
                } else if (stepNumber === currentStep) {
                    step.classList.add('active');
                } else {
                    step.classList.add('pending');
                }
            });
        }

        // Theme Toggle Function
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            const btnToggle = document.getElementById('btnThemeToggle');
            if (btnToggle) {
                btnToggle.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            }
        }

        // Initialize Theme on Load
        (function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            const btnToggle = document.getElementById('btnThemeToggle');
            if (btnToggle) {
                btnToggle.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            }
        })();
    </script>
    <script src="../listener-registry.js"></script>
    <script src="../error-handler.js"></script>
</body>
</html>
