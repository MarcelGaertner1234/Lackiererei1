<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partner-Anfragen Admin | Auto-Lackierzentrum Mosbach</title>

    <!-- Aggressive No-Cache Headers (Cache-Fix f√ºr v=a4192c4) -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .header h1 {
            color: #003366;
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn-primary {
            background: #003366;
            color: white;
        }

        .btn-primary:hover {
            background: #00509e;
            transform: translateY(-2px);
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 13px;
        }

        .filter-section {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-size: 13px;
            font-weight: 600;
            color: #003366;
        }

        .filter-group select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card .number {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-card .label {
            font-size: 13px;
            opacity: 0.9;
        }

        .anfragen-liste {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .anfrage-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 25px;
            transition: all 0.3s;
            overflow: hidden;
        }

        .anfrage-card:hover {
            border-color: #003366;
            box-shadow: 0 4px 12px rgba(0,51,102,0.1);
        }

        /* ========================================
           COMPACT CARD VIEW (Stufe 1)
           ======================================== */

        .anfrage-card.collapsed {
            max-height: 280px;
        }

        .anfrage-card.collapsed .detail-grid,
        .anfrage-card.collapsed .photos-section,
        .anfrage-card.collapsed .kva-box,
        .anfrage-card.collapsed .status-actions,
        .anfrage-card.collapsed .schadensbeschreibung,
        .anfrage-card.collapsed .action-buttons {
            display: none;
        }

        .anfrage-card.collapsed .anfrage-grid {
            grid-template-columns: 1fr;
            gap: 0;
        }

        .anfrage-card.collapsed .schadensbeschreibung-short {
            display: block;
            background: #f9f9f9;
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .anfrage-card:not(.collapsed) .schadensbeschreibung-short {
            display: none;
        }

        .toggle-card-btn {
            background: #e0e0e0;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.2s;
            color: #666;
        }

        .toggle-card-btn:hover {
            background: #d0d0d0;
            color: #003366;
        }

        .anfrage-card.collapsed .toggle-card-btn {
            transform: rotate(180deg);
        }

        .quick-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .anfrage-card.collapsed .quick-actions {
            display: none;
        }

        .actions-dropdown {
            position: relative;
        }

        .actions-dropdown-btn {
            padding: 8px 14px;
            background: #e0e0e0;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .actions-dropdown-btn:hover {
            background: #d0d0d0;
        }

        .actions-dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 5px;
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 200px;
            z-index: 100;
            display: none;
        }

        .actions-dropdown.active .actions-dropdown-menu {
            display: block;
        }

        .actions-dropdown-menu button {
            display: block;
            width: 100%;
            padding: 10px 15px;
            border: none;
            background: white;
            text-align: left;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .actions-dropdown-menu button:hover {
            background: #f5f5f5;
        }

        .actions-dropdown-menu button:first-child {
            border-radius: 6px 6px 0 0;
        }

        .actions-dropdown-menu button:last-child {
            border-radius: 0 0 6px 6px;
        }

        /* ========================================
           QUICK INFO BADGES (Collapsed View)
           ======================================== */

        .quick-info-badges {
            display: none;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 12px;
        }

        .anfrage-card.collapsed .quick-info-badges {
            display: flex;
        }

        .info-badge {
            padding: 4px 9px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .info-badge.urgent {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef5350;
        }

        .info-badge.normal {
            background: #f5f5f5;
            color: #666;
            border: 1px solid #e0e0e0;
        }

        .info-badge.has-photos {
            background: #e3f2fd;
            color: #1565c0;
            border: 1px solid #90caf9;
        }

        .info-badge.has-vin {
            background: #fff3e0;
            color: #e65100;
            border: 1px solid #ffb74d;
        }

        .info-badge.karosserie {
            background: #fff3e0;
            color: #e65100;
            border: 1px solid #ff9800;
        }

        .info-badge.abhol {
            background: #fce4ec;
            color: #c2185b;
            border: 1px solid #f06292;
        }

        .info-badge.ersatz {
            background: #e1f5fe;
            color: #0277bd;
            border: 1px solid #4fc3f7;
        }

        .info-badge.original {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #66bb6a;
        }

        .info-badge.zubehoer {
            background: #fff8e1;
            color: #f57f17;
            border: 1px solid #ffca28;
        }

        .info-badge.partner-teil {
            background: #f3e5f5;
            color: #6a1b9a;
            border: 1px solid #ba68c8;
        }

        .anfrage-card.neu {
            border-left: 5px solid #1565c0;
        }

        .anfrage-card.warte_kva {
            border-left: 5px solid #e65100;
        }

        .anfrage-card.kva_gesendet {
            border-left: 5px solid #6a1b9a;
        }

        .anfrage-card.beauftragt {
            border-left: 5px solid #2e7d32;
        }

        .anfrage-card.in_arbeit {
            border-left: 5px solid #0277bd;
        }

        .anfrage-card.fertig {
            border-left: 5px solid #1b5e20;
        }

        .anfrage-card.storniert {
            border-left: 5px solid #c62828;
            opacity: 0.8;
        }

        .anfrage-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 20px;
        }

        .anfrage-title {
            font-size: 20px;
            font-weight: 600;
            color: #003366;
            margin-bottom: 5px;
        }

        .anfrage-subtitle {
            font-size: 14px;
            color: #999;
        }

        .status-badge {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
        }

        .status-badge.neu {
            background: #e3f2fd;
            color: #1565c0;
        }

        .status-badge.warte_kva {
            background: #fff3e0;
            color: #e65100;
        }

        .status-badge.kva_gesendet {
            background: #f3e5f5;
            color: #6a1b9a;
        }

        .status-badge.beauftragt {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-badge.in_arbeit {
            background: #e1f5fe;
            color: #0277bd;
        }

        .status-badge.fertig {
            background: #c8e6c9;
            color: #1b5e20;
        }

        .status-badge.storniert {
            background: #ffebee;
            color: #c62828;
            text-decoration: line-through;
        }

        .anfrage-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
            margin-bottom: 20px;
        }

        .info-section h3 {
            font-size: 16px;
            color: #003366;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .detail-item {
            font-size: 14px;
        }

        .detail-item .label {
            color: #666;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .detail-item .value {
            color: #333;
            font-weight: 600;
        }

        .schadensbeschreibung {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .schadensbeschreibung .label {
            color: #666;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .schadensbeschreibung .text {
            color: #333;
            line-height: 1.6;
        }

        .photos-section {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .photo-grid img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .photo-grid img:hover {
            transform: scale(1.05);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .status-actions {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .status-actions h4 {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .status-btn {
            padding: 8px 14px;
            border: 2px solid;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .status-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .status-btn.warte_kva {
            border-color: #e65100;
            color: #e65100;
        }

        .status-btn.warte_kva:hover {
            background: #e65100;
            color: white;
        }

        .status-btn.kva_gesendet {
            border-color: #6a1b9a;
            color: #6a1b9a;
        }

        .status-btn.kva_gesendet:hover {
            background: #6a1b9a;
            color: white;
        }

        .status-btn.beauftragt {
            border-color: #2e7d32;
            color: #2e7d32;
        }

        .status-btn.beauftragt:hover {
            background: #2e7d32;
            color: white;
        }

        .status-btn.in_arbeit {
            border-color: #0277bd;
            color: #0277bd;
        }

        .status-btn.in_arbeit:hover {
            background: #0277bd;
            color: white;
        }

        .status-btn.fertig {
            border-color: #1b5e20;
            color: #1b5e20;
        }

        .status-btn.fertig:hover {
            background: #1b5e20;
            color: white;
        }

        .kva-box {
            background: #f0f9ff;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #003366;
        }

        .kva-box .title {
            font-weight: 600;
            color: #003366;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .kva-box .price {
            font-size: 28px;
            font-weight: 700;
            color: #003366;
            margin-bottom: 10px;
        }

        .kva-box .details {
            font-size: 13px;
            color: #666;
            line-height: 1.6;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state .icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
            overflow: auto;
            display: none;
        }

        .modal.show .modal-content {
            display: block;
        }

        .modal-content img {
            width: 100%;
            height: auto;
        }

        @media (max-width: 900px) {
            .anfrage-grid {
                grid-template-columns: 1fr;
            }

            .detail-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ========================================
           CHAT SYSTEM STYLES
           ======================================== */

        /* Chat Icon Badge (im Header) */
        .chat-icon-badge {
            position: relative;
            cursor: pointer;
            background: #4caf50;
            color: white;
            width: 42px;
            height: 42px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .chat-icon-badge:hover {
            background: #388e3c;
            transform: scale(1.1);
        }

        .chat-icon-badge .unread-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #f44336;
            color: white;
            font-size: 11px;
            font-weight: 700;
            padding: 3px 7px;
            border-radius: 12px;
            min-width: 20px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Chat Button */
        .chat-btn {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .chat-btn .unread-badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background: #f44336;
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        /* Chat Modal */
        .chat-modal {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 420px;
            max-height: 600px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            display: none;
            flex-direction: column;
            z-index: 2000;
        }

        .chat-modal.active {
            display: flex;
        }

        .chat-modal.minimized {
            max-height: 60px;
        }

        .chat-modal.minimized .chat-body,
        .chat-modal.minimized .chat-footer {
            display: none;
        }

        .chat-header {
            background: linear-gradient(135deg, #003366 0%, #00509e 100%);
            color: white;
            padding: 18px 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .chat-header-title {
            font-weight: 700;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-header-actions {
            display: flex;
            gap: 10px;
        }

        .chat-header-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .chat-header-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .chat-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f9f9f9;
            max-height: 450px;
        }

        .chat-messages {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .chat-message {
            display: flex;
            flex-direction: column;
            max-width: 75%;
        }

        .chat-message.werkstatt {
            align-self: flex-end;
        }

        .chat-message.partner {
            align-self: flex-start;
        }

        .chat-message-sender {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 5px;
        }

        .chat-message-bubble {
            padding: 12px 15px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .chat-message.werkstatt .chat-message-bubble {
            background: #003366;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .chat-message.partner .chat-message-bubble {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 4px;
        }

        .chat-message-time {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .chat-message.werkstatt .chat-message-time {
            justify-content: flex-end;
        }

        .chat-message-system {
            background: #fff3e0;
            border: 1px solid #ffe0b2;
            color: #e65100;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 13px;
            text-align: center;
            align-self: center;
            max-width: 85%;
        }

        .chat-footer {
            padding: 15px;
            background: white;
            border-top: 1px solid #e0e0e0;
            border-radius: 0 0 15px 15px;
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: none;
            max-height: 100px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #003366;
        }

        .chat-send-btn {
            background: #003366;
            color: white;
            border: none;
            width: 46px;
            height: 46px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .chat-send-btn:hover {
            background: #00509e;
        }

        .chat-send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        /* Mobile Responsive f√ºr Chat */
        @media (max-width: 600px) {
            .chat-modal {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                width: 100%;
                max-height: 100%;
                border-radius: 0;
            }

            .chat-modal.minimized {
                display: none !important;
            }

            .chat-header {
                border-radius: 0;
            }

            .chat-body {
                max-height: none;
                flex: 1;
            }

            .chat-footer {
                border-radius: 0;
            }
        }
    </style>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

    <!-- Mobile-Responsive CSS Framework -->
    <link rel="stylesheet" href="../mobile-responsive.css">

    <!-- Global Chat Notifications -->
    <link rel="stylesheet" href="../global-chat-notifications.css">
    <script src="../global-chat-notifications.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¢ Partner-Anfragen Verwaltung</h1>
            <p>Admin-Bereich f√ºr Partner-Lackieranfragen</p>
        </div>

        <!-- üÜï PHASE 2.3.1: Werkstatt-Auswahl f√ºr Admin -->
        <div class="nav-buttons">
            <select id="werkstattSelector" class="btn btn-secondary" onchange="onWerkstattChange()" style="min-width: 150px;" title="Werkstatt ausw√§hlen">
                <option value="mosbach">Mosbach</option>
                <option value="heidelberg">Heidelberg</option>
                <option value="heilbronn">Heilbronn</option>
            </select>
            <a href="../index.html" class="btn btn-secondary">‚Üê Zur√ºck zur Hauptseite</a>
        </div>

        <!-- Statistics -->
        <div class="stats-row" id="statsRow">
            <div class="stat-card">
                <div class="number" id="statsNeu">0</div>
                <div class="label">Neu</div>
            </div>
            <div class="stat-card">
                <div class="number" id="statsWarteKva">0</div>
                <div class="label">Warte auf KVA</div>
            </div>
            <div class="stat-card">
                <div class="number" id="statsKvaGesendet">0</div>
                <div class="label">KVA gesendet</div>
            </div>
            <div class="stat-card">
                <div class="number" id="statsBeauftragt">0</div>
                <div class="label">Beauftragt</div>
            </div>
            <div class="stat-card">
                <div class="number" id="statsInArbeit">0</div>
                <div class="label">In Arbeit</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #66bb6a 0%, #388e3c 100%);">
                <div class="number" id="statsFertig">0</div>
                <div class="label">Fertig</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #ef5350 0%, #c62828 100%);">
                <div class="number" id="statsStorniert">0</div>
                <div class="label">Storniert</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filter-section">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="filterStatus">Status filtern:</label>
                    <select id="filterStatus">
                        <option value="">Alle anzeigen</option>
                        <option value="neu">Neu</option>
                        <option value="warte_kva">Warte auf KVA</option>
                        <option value="kva_gesendet">KVA gesendet</option>
                        <option value="beauftragt">Beauftragt</option>
                        <option value="in_arbeit">In Arbeit</option>
                        <option value="fertig">Fertig</option>
                        <option value="storniert">Storniert</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filterPartner">Partner filtern:</label>
                    <select id="filterPartner">
                        <option value="">Alle Partner</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filterDringlichkeit">Dringlichkeit:</label>
                    <select id="filterDringlichkeit">
                        <option value="">Alle</option>
                        <option value="eilig">Nur Eilig</option>
                        <option value="normal">Nur Normal</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="loading" class="loading">
            <p>‚è≥ Anfragen werden geladen...</p>
        </div>

        <div id="anfrageNListe" class="anfragen-liste" style="display: none;">
            <!-- Dynamisch gef√ºllt -->
        </div>

        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="icon">üì≠</div>
            <h3>Keine Anfragen gefunden</h3>
            <p>Mit den aktuellen Filtern wurden keine Anfragen gefunden.</p>
        </div>
    </div>

    <!-- Photo Modal -->
    <div class="modal" id="photoModal" onclick="closePhotoModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <img id="modalPhoto" src="" alt="Foto" style="display: none;">
        </div>
    </div>

    <script src="../firebase-config.js?v=a4192c4"></script>
    <script src="../js/auth-manager.js"></script>
    <script>
        let allAnfragen = [];
        let allPartner = [];

        // üÜï Admin Auth Check (PHASE 2.3.2)
        async function checkAdminAuth() {
            return new Promise((resolve, reject) => {
                firebase.auth().onAuthStateChanged(async (user) => {
                    if (!user) {
                        showToast('‚ö†Ô∏è Admin-Login erforderlich!\n\nBitte melden Sie sich zuerst in der Hauptanwendung an.', 'error');
                        window.safeNavigate('../index.html');
                        return reject('Not authenticated');
                    }

                    try {
                        // Check role (admin oder werkstatt)
                        const userDoc = await db.collection('users').doc(user.uid).get();
                        if (!userDoc.exists) {
                            showToast('‚ùå User-Daten nicht gefunden!\n\nBitte kontaktieren Sie den Administrator.', 'error');
                            window.safeNavigate('../index.html');
                            return reject('User not found');
                        }

                        const role = userDoc.data().role;
                        if (role !== 'admin' && role !== 'werkstatt' && role !== 'superadmin') {
                            showToast('‚ùå Keine Admin-Berechtigung!\n\nDiese Seite ist nur f√ºr Administratoren und Werkstatt-Mitarbeiter.', 'info');
                            window.safeNavigate('../index.html');
                            return reject('Not admin');
                        }

                        console.log('‚úÖ [ADMIN-ANFRAGEN] Admin authenticated:', user.email, '| Role:', role);
                        resolve();
                    } catch (error) {
                        console.error('‚ùå Auth Check Error:', error);
                        alert('‚ùå Fehler beim Pr√ºfen der Berechtigung:\n\n' + error.message);
                        window.safeNavigate('../index.html');
                        reject(error);
                    }
                });
            });
        }

        // üÜï PRE-INITIALIZE werkstattId from localStorage
        // CRITICAL: Set werkstattId BEFORE auth-check polling starts!
        // This prevents Catch-22: auth-check waits for werkstattId, but werkstattId was set AFTER auth-check
        const selectedWerkstatt = localStorage.getItem('selectedWerkstatt');
        window.werkstattId = selectedWerkstatt || 'mosbach';
        console.log('‚úÖ [ADMIN-ANFRAGEN] werkstattId pre-initialized:', window.werkstattId);

        // AUTH-CHECK POLLING
        let authCheckAttempts = 0;
        const maxAuthCheckAttempts = 20;

        const authCheckInterval = setInterval(async () => {
            authCheckAttempts++;

            if (window.firebaseInitialized && window.werkstattId) {
                clearInterval(authCheckInterval);
                console.log('‚úÖ [ADMIN-ANFRAGEN] Firebase + werkstattId ready');

                await initFirebase();
                await checkAdminAuth();

                // Set dropdown to saved value
                const selector = document.getElementById('werkstattSelector');
                if (selector) {
                    selector.value = window.werkstattId;
                }

                await loadAnfragen();
                setupFilters();
                return;
            }

            if (authCheckAttempts >= maxAuthCheckAttempts) {
                clearInterval(authCheckInterval);
                console.error('‚ùå [ADMIN-ANFRAGEN] Firebase timeout');
                showToast('Fehler: Werkstatt-Initialisierung fehlgeschlagen. Bitte neu einloggen.', 'error');
                window.safeNavigate('../index.html');
            }
        }, 250);

        async function loadAnfragen() {
            const loading = document.getElementById('loading');
            const liste = document.getElementById('anfrageNListe');
            const emptyState = document.getElementById('emptyState');

            try {
                if (!db) throw new Error('Firebase nicht verf√ºgbar');

                // Alle Partner-Anfragen laden
                const snapshot = await window.getCollection('partnerAnfragen')
                    .orderBy('timestamp', 'desc')
                    .get();

                loading.style.display = 'none';

                if (snapshot.empty) {
                    emptyState.style.display = 'block';
                    return;
                }

                allAnfragen = [];
                snapshot.forEach(doc => {
                    allAnfragen.push({ id: doc.id, ...doc.data() });
                });

                // Unique Partner extrahieren f√ºr Filter
                allPartner = [...new Set(allAnfragen.map(a => a.partnerName))].sort();
                updatePartnerFilter();

                // Unread Counts laden
                await loadUnreadCounts();

                updateStats();
                renderAnfragen();

            } catch (error) {
                console.error('‚ùå Fehler beim Laden:', error);
                loading.innerHTML = '<p style="color: #c62828;">‚ö†Ô∏è Fehler beim Laden der Anfragen</p>';
            }
        }

        // üÜï PHASE 2.3.1: Werkstatt-Wechsel Handler
        function onWerkstattChange() {
            const selector = document.getElementById('werkstattSelector');
            const newWerkstatt = selector.value;

            console.log('üîÑ [ADMIN-ANFRAGEN] Werkstatt gewechselt:', window.werkstattId, '‚Üí', newWerkstatt);

            // Save to localStorage
            localStorage.setItem('selectedWerkstatt', newWerkstatt);

            // Update global variable
            window.werkstattId = newWerkstatt;

            // Reload page to fetch data for new werkstatt
            window.location.reload();
        }

        function updatePartnerFilter() {
            const select = document.getElementById('filterPartner');
            allPartner.forEach(partner => {
                const option = document.createElement('option');
                option.value = partner;
                option.textContent = partner;
                select.appendChild(option);
            });
        }

        function updateStats() {
            const stats = {
                neu: 0,
                warte_kva: 0,
                kva_gesendet: 0,
                beauftragt: 0,
                in_arbeit: 0,
                fertig: 0,
                storniert: 0
            };

            allAnfragen.forEach(anfrage => {
                if (stats.hasOwnProperty(anfrage.status)) {
                    stats[anfrage.status]++;
                }
            });

            document.getElementById('statsNeu').textContent = stats.neu;
            document.getElementById('statsWarteKva').textContent = stats.warte_kva;
            document.getElementById('statsKvaGesendet').textContent = stats.kva_gesendet;
            document.getElementById('statsBeauftragt').textContent = stats.beauftragt;
            document.getElementById('statsInArbeit').textContent = stats.in_arbeit;
            document.getElementById('statsFertig').textContent = stats.fertig;
            document.getElementById('statsStorniert').textContent = stats.storniert;
        }

        function setupFilters() {
            document.getElementById('filterStatus').addEventListener('change', renderAnfragen);
            document.getElementById('filterPartner').addEventListener('change', renderAnfragen);
            document.getElementById('filterDringlichkeit').addEventListener('change', renderAnfragen);
        }

        function renderAnfragen() {
            const liste = document.getElementById('anfrageNListe');
            const emptyState = document.getElementById('emptyState');

            const filterStatus = document.getElementById('filterStatus').value;
            const filterPartner = document.getElementById('filterPartner').value;
            const filterDringlichkeit = document.getElementById('filterDringlichkeit').value;

            let filtered = allAnfragen.filter(anfrage => {
                if (filterStatus && anfrage.status !== filterStatus) return false;
                if (filterPartner && anfrage.partnerName !== filterPartner) return false;
                if (filterDringlichkeit && anfrage.dringlichkeit !== filterDringlichkeit) return false;
                return true;
            });

            if (filtered.length === 0) {
                liste.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            liste.style.display = 'flex';
            emptyState.style.display = 'none';
            liste.innerHTML = '';

            filtered.forEach(anfrage => {
                const card = createAnfrageCard(anfrage);
                liste.appendChild(card);
            });
        }

        function getServiceBadge(serviceTyp) {
            const badges = {
                'lackier': { icon: 'üé®', label: 'Lackier-Service', color: '#003366' },
                'reifen': { icon: 'üöó', label: 'Reifen-Service', color: '#1976d2' },
                'pflege': { icon: '‚ú®', label: 'Fahrzeugpflege', color: '#7b1fa2' },
                'mechanik': { icon: 'üîß', label: 'Mechanik', color: '#d32f2f' },
                'tuev': { icon: '‚úÖ', label: 'T√úV/AU', color: '#388e3c' },
                'versicherung': { icon: 'üõ°Ô∏è', label: 'Versicherung', color: '#f57c00' },
                'glas': { icon: 'üîç', label: 'Glas-Reparatur', color: '#0288d1' },
                'klima': { icon: '‚ùÑÔ∏è', label: 'Klima-Service', color: '#00bcd4' },
                'dellen': { icon: 'üî®', label: 'Dellen-Dr√ºckung', color: '#757575' },
                'folierung': { icon: 'üåà', label: 'Folierung', color: '#9c27b0' },
                'steinschutz': { icon: 'üõ°Ô∏è', label: 'Steinschutz', color: '#607d8b' },
                'werbebeklebung': { icon: 'üì¢', label: 'Werbebeklebung', color: '#ff5722' }
            };
            const badge = badges[serviceTyp] || { icon: 'üìã', label: 'Service', color: '#666' };
            return `<span style="background: ${badge.color}; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-left: 10px;">${badge.icon} ${badge.label}</span>`;
        }

        function getErsatzteilBadge(praeferenz) {
            const badges = {
                'originalteil': '<span class="info-badge original">‚≠ê Original</span>',
                'guenstig': '<span class="info-badge zubehoer">üîß Zubeh√∂r</span>',
                'gebrauchteil': '<span class="info-badge partner-teil">üì¶ Partner</span>'
            };
            return badges[praeferenz] || '';
        }

        // ========================================
        // COMPACT CARD FUNCTIONS (Stufe 1)
        // ========================================

        function toggleCardCollapse(anfrageId, event) {
            if (event) event.stopPropagation();

            const card = document.querySelector(`.anfrage-card[data-anfrage-id="${anfrageId}"]`);
            if (!card) return;

            const isCollapsed = card.classList.toggle('collapsed');

            // Icon rotation is handled by CSS
            const icon = card.querySelector('.toggle-card-btn');
            if (icon) {
                icon.title = isCollapsed ? 'Details anzeigen' : 'Details verstecken';
            }

            // Save preference to localStorage
            try {
                const collapsedCards = JSON.parse(localStorage.getItem('admin_collapsed_cards') || '{}');
                collapsedCards[anfrageId] = isCollapsed;
                localStorage.setItem('admin_collapsed_cards', JSON.stringify(collapsedCards));
            } catch (error) {
                console.error('Could not save collapse state:', error);
            }
        }

        function toggleActionsDropdown(anfrageId, event) {
            if (event) event.stopPropagation();

            const dropdown = document.querySelector(`#actions-dropdown-${anfrageId}`);
            if (!dropdown) return;

            // Close all other dropdowns
            document.querySelectorAll('.actions-dropdown.active').forEach(d => {
                if (d !== dropdown) d.classList.remove('active');
            });

            dropdown.classList.toggle('active');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', (event) => {
            if (!event.target.closest('.actions-dropdown')) {
                document.querySelectorAll('.actions-dropdown.active').forEach(d => {
                    d.classList.remove('active');
                });
            }
        });

        function truncateText(text, maxLength) {
            if (!text) return '';
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        function createAnfrageCard(anfrage) {
            const card = document.createElement('div');
            card.className = 'anfrage-card ' + anfrage.status;
            card.setAttribute('data-anfrage-id', anfrage.id);

            // Check if this card should be collapsed (default: collapsed)
            const collapsedCards = JSON.parse(localStorage.getItem('admin_collapsed_cards') || '{}');
            const isCollapsed = collapsedCards.hasOwnProperty(anfrage.id) ? collapsedCards[anfrage.id] : true;
            if (isCollapsed) {
                card.classList.add('collapsed');
            }

            const datum = new Date(anfrage.timestamp || anfrage.erstelltAm).toLocaleDateString('de-DE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            const statusTexte = {
                'neu': 'Neu eingegangen',
                'warte_kva': 'In Pr√ºfung',
                'kva_gesendet': 'Angebot erstellt',
                'beauftragt': 'Beauftragt',
                'in_arbeit': 'In Lackierung',
                'fertig': 'Abholbereit',
                'storniert': 'Storniert'
            };

            // Photos HTML
            let photosHTML = '';
            if (anfrage.fotos && anfrage.fotos.length > 0) {
                photosHTML = `
                    <div class="photos-section">
                        <div class="label">üì∑ Schadensfotos (${anfrage.fotos.length})</div>
                        <div class="photo-grid">
                            ${anfrage.fotos.map((foto, index) => `
                                <img src="${foto}" alt="Foto ${index + 1}" onclick="showPhoto('${foto}')">
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // KVA HTML
            let kvaHTML = '';
            let kvaButton = '';
            if (anfrage.kva) {
                // ============================================
                // MULTI-SERVICE KVA (NEU)
                // ============================================
                if (anfrage.kva.isMultiService && anfrage.kva.services) {
                    kvaHTML = `
                        <div class="kva-box" style="background: linear-gradient(135deg, #f0f9ff 0%, #e3f2fd 100%);">
                            <div class="title">üîó Multi-Service KVA erstellt</div>
                            <div style="background: #fff; padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 3px solid #667eea;">
                                <strong style="color: #667eea;">Services in dieser Gruppe:</strong><br>
                                <span style="font-size: 13px; color: #666;">
                                    ${anfrage.kva.services.map(s => {
                                        const serviceLabels = {
                                            'lackierung': 'üé® Lackierung',
                                            'lackier': 'üé® Lackierung',
                                            'reifen': 'üõû Reifen',
                                            'mechanik': 'üîß Mechanik',
                                            'pflege': '‚ú® Pflege',
                                            'tuev': 'üîç T√úV',
                                            'versicherung': 'üìã Versicherung'
                                        };
                                        return serviceLabels[s.serviceTyp] || s.serviceTyp;
                                    }).join(' ‚Ä¢ ')}
                                </span>
                            </div>
                    `;

                    // Zeige jedes Service mit seinen Varianten
                    anfrage.kva.services.forEach(service => {
                        const gewaehlte = anfrage.kva.gewaehlteVarianten?.[service.serviceTyp];
                        const varianten = service.varianten;

                        kvaHTML += `
                            <div style="margin-bottom: 20px; padding: 15px; background: #fff; border-radius: 8px; border-left: 3px solid #003366;">
                                <h4 style="color: #003366; font-size: 14px; margin-bottom: 10px;">
                                    ${service.serviceTyp === 'lackierung' || service.serviceTyp === 'lackier' ? 'üé®' : service.serviceTyp === 'reifen' ? 'üõû' : service.serviceTyp === 'mechanik' ? 'üîß' : service.serviceTyp === 'pflege' ? '‚ú®' : service.serviceTyp === 'tuev' ? 'üîç' : service.serviceTyp === 'versicherung' ? 'üõ°Ô∏è' : service.serviceTyp === 'glas' ? 'üîç' : service.serviceTyp === 'klima' ? '‚ùÑÔ∏è' : service.serviceTyp === 'dellen' ? 'üî®' : service.serviceTyp === 'folierung' ? 'üåà' : service.serviceTyp === 'steinschutz' ? 'üõ°Ô∏è' : service.serviceTyp === 'werbebeklebung' ? 'üì¢' : 'üìã'}
                                    ${service.serviceTyp.charAt(0).toUpperCase() + service.serviceTyp.slice(1)}
                                </h4>
                                <div style="display: grid; gap: 8px;">
                                    ${varianten.original ? `
                                        <div style="background: ${gewaehlte === 'original' ? '#e3f2fd' : '#f9f9f9'}; padding: 10px; border-radius: 6px; font-size: 13px;">
                                            <strong style="color: #003366;">‚≠ê Original:</strong> ${varianten.original.gesamt.toFixed(2)}‚Ç¨
                                            ${gewaehlte === 'original' ? '<span style="color: #4caf50; margin-left: 8px; font-weight: 700;">‚úì</span>' : ''}
                                        </div>
                                    ` : ''}
                                    ${varianten.zubehoer ? `
                                        <div style="background: ${gewaehlte === 'zubehoer' ? '#fff3e0' : '#f9f9f9'}; padding: 10px; border-radius: 6px; font-size: 13px;">
                                            <strong style="color: #e65100;">üîß Budget:</strong> ${varianten.zubehoer.gesamt.toFixed(2)}‚Ç¨
                                            ${gewaehlte === 'zubehoer' ? '<span style="color: #4caf50; margin-left: 8px; font-weight: 700;">‚úì</span>' : ''}
                                        </div>
                                    ` : ''}
                                    ${varianten.partner ? `
                                        <div style="background: ${gewaehlte === 'partner' ? '#e8f5e9' : '#f9f9f9'}; padding: 10px; border-radius: 6px; font-size: 13px;">
                                            <strong style="color: #2e7d32;">üì¶ Partner:</strong> ${varianten.partner.gesamt.toFixed(2)}‚Ç¨
                                            ${gewaehlte === 'partner' ? '<span style="color: #4caf50; margin-left: 8px; font-weight: 700;">‚úì</span>' : ''}
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    });

                    // Termine anzeigen
                    kvaHTML += `
                        ${anfrage.kva.termine ? `
                            <div style="margin-top: 15px; padding: 12px; background: #fff; border-radius: 8px; border-left: 3px solid #003366;">
                                <div style="font-weight: 600; color: #003366; margin-bottom: 8px;">üìÖ Termin</div>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; font-size: 13px;">
                                    <div>
                                        <span style="color: #666;">Start:</span>
                                        <strong style="color: #003366;"> ${new Date(anfrage.kva.termine.start).toLocaleDateString('de-DE')}</strong>
                                    </div>
                                    <div>
                                        <span style="color: #666;">Ende:</span>
                                        <strong style="color: #2e7d32;"> ${new Date(anfrage.kva.termine.ende).toLocaleDateString('de-DE')}</strong>
                                    </div>
                                    ${anfrage.kva.termine.abholzeit ? `
                                        <div>
                                            <span style="color: #666;">Uhrzeit:</span>
                                            <strong style="color: #e65100;"> ${anfrage.kva.termine.abholzeit} Uhr</strong>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}
                        </div>
                    `;

                } else if (anfrage.kva.varianten) {
                    // ============================================
                    // SINGLE-SERVICE KVA (Bestehende Logik)
                    // ============================================
                    const gewaehlte = anfrage.kva.gewaehlteVariante;
                    const varianten = anfrage.kva.varianten;

                    kvaHTML = `
                        <div class="kva-box">
                            <div class="title">üí∂ KVA mit Varianten erstellt</div>
                            <div style="display: grid; gap: 10px; margin-top: 15px;">
                                ${varianten.original ? `
                                    <div style="background: ${gewaehlte === 'original' ? '#e3f2fd' : '#f9f9f9'}; padding: 12px; border-radius: 8px;">
                                        <strong style="color: #003366;">‚≠ê Originalteile:</strong> ${varianten.original.gesamt.toFixed(2)}‚Ç¨
                                        ${gewaehlte === 'original' ? '<span style="color: #4caf50; margin-left: 10px; font-weight: 700;">‚úì Gew√§hlt</span>' : ''}
                                    </div>
                                ` : ''}
                                ${varianten.zubehoer ? `
                                    <div style="background: ${gewaehlte === 'zubehoer' ? '#fff3e0' : '#f9f9f9'}; padding: 12px; border-radius: 8px;">
                                        <strong style="color: #e65100;">üîß Zubeh√∂rteile:</strong> ${varianten.zubehoer.gesamt.toFixed(2)}‚Ç¨
                                        ${gewaehlte === 'zubehoer' ? '<span style="color: #4caf50; margin-left: 10px; font-weight: 700;">‚úì Gew√§hlt</span>' : ''}
                                    </div>
                                ` : ''}
                                ${varianten.partner ? `
                                    <div style="background: ${gewaehlte === 'partner' ? '#e8f5e9' : '#f9f9f9'}; padding: 12px; border-radius: 8px;">
                                        <strong style="color: #2e7d32;">üì¶ Partner-Ersatzteil:</strong> ${varianten.partner.gesamt.toFixed(2)}‚Ç¨
                                        ${gewaehlte === 'partner' ? '<span style="color: #4caf50; margin-left: 10px; font-weight: 700;">‚úì Gew√§hlt</span>' : ''}
                                    </div>
                                ` : ''}
                            </div>
                            ${anfrage.kva.termine ? `
                                <div style="margin-top: 15px; padding: 12px; background: #f0f9ff; border-radius: 8px; border-left: 3px solid #003366;">
                                    <div style="font-weight: 600; color: #003366; margin-bottom: 8px;">üìÖ Lackierungs-Termin</div>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; font-size: 13px;">
                                        <div>
                                            <span style="color: #666;">Start:</span>
                                            <strong style="color: #003366;"> ${new Date(anfrage.kva.termine.start).toLocaleDateString('de-DE')}</strong>
                                        </div>
                                        <div>
                                            <span style="color: #666;">Abholung:</span>
                                            <strong style="color: #2e7d32;"> ${new Date(anfrage.kva.termine.ende).toLocaleDateString('de-DE')}</strong>
                                        </div>
                                        ${anfrage.kva.termine.abholzeit ? `
                                            <div>
                                                <span style="color: #666;">Uhrzeit:</span>
                                                <strong style="color: #e65100;"> ${anfrage.kva.termine.abholzeit} Uhr</strong>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            ` : `
                                <div style="margin-top: 12px; color: #666; font-size: 13px;">
                                    <strong>Lieferzeit:</strong> ${anfrage.kva.lieferzeit || 'k.A.'}
                                </div>
                            `}
                            <div style="margin-top: 10px; color: #666; font-size: 13px;">
                                ${gewaehlte ? `<strong style="color: #4caf50;">Status:</strong> Partner hat "${gewaehlte === 'original' ? 'Originalteile' : gewaehlte === 'zubehoer' ? 'Zubeh√∂rteile' : 'Partner-Ersatzteil'}" gew√§hlt` : '<strong style="color: #ff9800;">Status:</strong> Partner muss noch w√§hlen'}
                            </div>
                        </div>
                    `;
                } else {
                    // Alte KVA-Struktur (Fallback)
                    kvaHTML = `
                        <div class="kva-box">
                            <div class="title">üí∂ Kostenvoranschlag erstellt</div>
                            <div class="price">${anfrage.kva.gesamt}‚Ç¨</div>
                            <div class="details">
                                Material: ${anfrage.kva.material}‚Ç¨<br>
                                Arbeitszeit: ${anfrage.kva.arbeitszeit}‚Ç¨<br>
                                Sonstiges: ${anfrage.kva.sonstiges}‚Ç¨<br>
                                Lieferzeit: ${anfrage.kva.lieferzeit || 'k.A.'}
                            </div>
                        </div>
                    `;
                }
            } else if (anfrage.status === 'neu' || anfrage.status === 'warte_kva') {
                kvaButton = `<a href="kva-erstellen.html?id=${anfrage.id}" class="btn btn-primary btn-small">üí∂ KVA erstellen</a>`;
            }

            // Short description for collapsed view
            const shortDescription = truncateText(anfrage.schadenBeschreibung, 80);

            card.innerHTML = `
                <div class="anfrage-header">
                    <div>
                        <div class="anfrage-title">${anfrage.auftragsnummer || anfrage.kennzeichen || 'Fahrzeug'}${getServiceBadge(anfrage.serviceTyp)}</div>
                        <div class="anfrage-subtitle">
                            ${anfrage.partnerName} ‚Ä¢ ${datum}
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <button class="toggle-card-btn" onclick="toggleCardCollapse('${anfrage.id}', event)" title="${isCollapsed ? 'Details anzeigen' : 'Details verstecken'}">
                            ‚ñº
                        </button>
                        <div class="chat-icon-badge" onclick="openChat('${anfrage.id}', event)" title="Chat √∂ffnen">
                            üí¨
                            ${getUnreadBadge(anfrage.id)}
                        </div>
                        <div class="status-badge ${anfrage.status}">
                            ${statusTexte[anfrage.status] || anfrage.status}
                        </div>
                    </div>
                </div>

                <!-- Short description for collapsed view -->
                <div class="schadensbeschreibung-short">
                    ${shortDescription}
                </div>

                <!-- Quick Info Badges (Stufe 1.5 - only visible in collapsed view) -->
                <div class="quick-info-badges">
                    ${anfrage.dringlichkeit === 'eilig' ? '<span class="info-badge urgent">‚ö° EILIG</span>' : '<span class="info-badge normal">üìÖ Normal</span>'}
                    ${anfrage.fotos && anfrage.fotos.length > 0 ? `<span class="info-badge has-photos">üì∑ ${anfrage.fotos.length} Fotos</span>` : ''}
                    ${anfrage.vin ? '<span class="info-badge has-vin">üî¢ VIN</span>' : ''}
                    ${anfrage.karosseriearbeiten === 'ja' ? '<span class="info-badge karosserie">üîß Karosserie</span>' : ''}
                    ${anfrage.abholserviceGewuenscht ? '<span class="info-badge abhol">üöö Abhol/Bring</span>' : ''}
                    ${anfrage.ersatzfahrzeugGewuenscht ? '<span class="info-badge ersatz">üöò Ersatzwagen</span>' : ''}
                    ${anfrage.ersatzteilPraeferenz ? getErsatzteilBadge(anfrage.ersatzteilPraeferenz) : ''}
                </div>

                <div class="anfrage-grid">
                    <div class="info-section">
                        <h3>üöó Fahrzeug- & Schadensdetails</h3>

                        <div class="detail-grid">
                            <div class="detail-item">
                                <div class="label">${anfrage.referenzType === 'auftrag' ? 'Auftragsnummer' : 'Kennzeichen'}</div>
                                <div class="value">${anfrage.auftragsnummer || anfrage.kennzeichen || 'k.A.'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="label">Fahrzeugdaten</div>
                                <div class="value" style="font-size: 12px; color: #666;">
                                    Aus VIN ermittelt
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="label">Dringlichkeit</div>
                                <div class="value">${anfrage.dringlichkeitLabel || (anfrage.dringlichkeit === 'eilig' ? '‚ö° Eilig (1-2 Tage)' : 'üìÖ Normal (3-5 Tage)')}</div>
                            </div>
                            ${anfrage.karosseriearbeiten === 'ja' ? `
                            <div class="detail-item" style="background: #fff3e0; padding: 10px; border-radius: 5px; border-left: 4px solid #ff9800;">
                                <strong style="color: #e65100;">üîß Karosserie-Arbeiten erforderlich</strong>
                                <div style="font-size: 12px; margin-top: 3px; color: #999;">Demontage/Montage ben√∂tigt</div>
                            </div>
                            ` : ''}
                            ${anfrage.abholserviceGewuenscht ? `
                            <div class="detail-item" style="background: #fff3e0; padding: 10px; border-radius: 5px; border-left: 4px solid #ff9800;">
                                <strong style="color: #e65100;">üöö Abhol- & Bringservice gew√ºnscht</strong>
                                ${anfrage.abholtermin ? `<div style="font-size: 13px; margin-top: 5px; color: #666;">üìç Abholung am ${new Date(anfrage.abholtermin).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' })}</div>` : ''}
                                ${anfrage.abholadresse ? `<div style="font-size: 12px; margin-top: 3px; color: #999;">üìç ${anfrage.abholadresse}</div>` : ''}
                            </div>
                            ` : ''}
                            ${anfrage.ersatzfahrzeugGewuenscht ? `
                            <div class="detail-item" style="background: #e3f2fd; padding: 8px; border-radius: 5px; border-left: 4px solid #2196f3;">
                                <strong style="color: #1565c0; font-size: 13px;">üöò Ersatzfahrzeug gew√ºnscht</strong>
                            </div>
                            ` : ''}
                        </div>

                        <!-- Fahrzeugidentifikation -->
                        ${anfrage.vin || (anfrage.fahrzeugscheinFotos && anfrage.fahrzeugscheinFotos.length > 0) ? `
                            <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #ff9800;">
                                <div style="font-weight: 600; color: #e65100; margin-bottom: 10px;">üî¢ Fahrzeugidentifikation</div>
                                ${anfrage.vin ? `
                                    <div style="font-family: monospace; font-size: 16px; font-weight: 700; color: #333;">
                                        VIN: ${anfrage.vin}
                                    </div>
                                ` : ''}
                                ${anfrage.fahrzeugscheinFotos && anfrage.fahrzeugscheinFotos.length > 0 ? `
                                    <div style="margin-top: 10px;">
                                        <div style="font-size: 13px; color: #e65100; margin-bottom: 8px;">üìÑ Fahrzeugschein (${anfrage.fahrzeugscheinFotos.length} Foto${anfrage.fahrzeugscheinFotos.length > 1 ? 's' : ''})</div>
                                        <div class="photo-grid">
                                            ${anfrage.fahrzeugscheinFotos.map((foto, index) => `
                                                <img src="${foto}" alt="Fahrzeugschein ${index + 1}" onclick="showPhoto('${foto}')" style="cursor: pointer; border-radius: 8px;">
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}

                        <div class="schadensbeschreibung">
                            <div class="label">Schadensbeschreibung</div>
                            <div class="text">${anfrage.schadenBeschreibung}</div>
                        </div>

                        <!-- Ersatzteil-Pr√§ferenz -->
                        ${anfrage.ersatzteilPraeferenz ? `
                            <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #4caf50;">
                                <div style="font-weight: 600; color: #2e7d32; margin-bottom: 10px;">üîß Ersatzteil-Pr√§ferenz</div>
                                <div style="font-size: 14px; color: #333;">
                                    ${anfrage.ersatzteilPraeferenz === 'gebrauchteil' ? 'Ersatzteil vorhanden (vom Partner)' : ''}
                                    ${anfrage.ersatzteilPraeferenz === 'originalteil' ? 'Nur Originalteile' : ''}
                                    ${anfrage.ersatzteilPraeferenz === 'guenstig' ? 'Zubeh√∂rteil <small style="color: #ff6b6b;">(‚ö†Ô∏è Passgenauigkeit nicht gew√§hrleistet)</small>' : ''}
                                </div>
                            </div>
                        ` : ''}

                        <!-- Stornierungsgrund (nur bei storniert) -->
                        ${anfrage.status === 'storniert' && anfrage.stornierungsGrund ? `
                            <div style="background: #ffebee; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #c62828;">
                                <div style="font-weight: 600; color: #c62828; margin-bottom: 10px;">‚ùå Stornierungsgrund</div>
                                <div style="font-size: 14px; color: #333; margin-bottom: 8px;">
                                    ${anfrage.stornierungsGrund}
                                </div>
                                ${anfrage.storniertAm ? `
                                    <div style="font-size: 12px; color: #666; margin-top: 8px;">
                                        Storniert am: ${new Date(anfrage.storniertAm).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}
                                    </div>
                                ` : ''}
                                ${anfrage.storniertVon ? `
                                    <div style="font-size: 12px; color: #666;">
                                        Storniert von: ${anfrage.storniertVon}
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}

                        ${photosHTML}
                    </div>

                    <div class="info-section">
                        <h3>üìã Aktionen & KVA</h3>

                        ${kvaHTML}

                        <!-- Quick Status Actions -->
                        <div class="status-actions" onclick="event.stopPropagation();">
                            <h4>‚ö° Schnell-Status √Ñnderung</h4>
                            <div class="status-buttons">
                                ${anfrage.status === 'neu' ? `
                                    <button class="status-btn warte_kva" onclick="updateStatus('${anfrage.id}', 'warte_kva', event)">üîç In Pr√ºfung</button>
                                ` : ''}
                                ${anfrage.status === 'warte_kva' ? `
                                    <button class="status-btn kva_gesendet" onclick="updateStatus('${anfrage.id}', 'kva_gesendet', event)">üí∞ Angebot senden</button>
                                ` : ''}
                                ${anfrage.status === 'kva_gesendet' ? `
                                    <button class="status-btn beauftragt" onclick="updateStatus('${anfrage.id}', 'beauftragt', event)">‚úÖ Beauftragen</button>
                                ` : ''}
                                ${anfrage.status === 'beauftragt' ? `
                                    <button class="status-btn in_arbeit" onclick="updateStatus('${anfrage.id}', 'in_arbeit', event)">üé® In Arbeit</button>
                                ` : ''}
                                ${anfrage.status === 'in_arbeit' ? `
                                    <button class="status-btn fertig" onclick="updateStatus('${anfrage.id}', 'fertig', event)">üèÅ Fertigstellen</button>
                                ` : ''}
                            </div>
                        </div>

                        <div class="action-buttons" style="margin-top: 20px;" onclick="event.stopPropagation();">
                            <button class="btn btn-primary btn-small chat-btn" onclick="openChat('${anfrage.id}', event)">
                                üí¨ Chat
                                ${getUnreadBadge(anfrage.id)}
                            </button>
                            ${kvaButton}
                            <button class="btn btn-secondary btn-small" onclick="changeStatus('${anfrage.id}', '${anfrage.status}')">
                                üîÑ Status √§ndern
                            </button>
                            ${(anfrage.status === 'beauftragt' || anfrage.status === 'in_arbeit') && !anfrage.fahrzeugAngelegt ? `
                                <button class="btn btn-primary btn-small" onclick="createVehicle('${anfrage.id}')">
                                    ‚ûï Fahrzeug anlegen
                                </button>
                            ` : anfrage.fahrzeugAngelegt ? `
                                <span class="badge badge-success" style="display: inline-block; padding: 8px 12px; background: #4caf50; color: white; border-radius: 6px; font-size: 12px; font-weight: 600;">
                                    ‚úÖ Fahrzeug angelegt
                                </span>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;

            // Klick √∂ffnet Details
            card.onclick = () => {
                window.location.href = `anfrage-detail.html?id=${anfrage.id}`;
            };

            return card;
        }

        function showPhoto(photoData) {
            const img = document.getElementById('modalPhoto');
            img.src = photoData;
            img.style.display = 'block';
            document.getElementById('photoModal').classList.add('show');
        }

        function closePhotoModal() {
            const img = document.getElementById('modalPhoto');
            img.style.display = 'none';
            img.src = '';
            document.getElementById('photoModal').classList.remove('show');
        }

        // Schnelle Status-√Ñnderung
        async function updateStatus(anfrageId, newStatus, event) {
            event.stopPropagation(); // Verhindert, dass Card-Click ausgel√∂st wird

            const statusTexte = {
                'neu': 'Neu eingegangen',
                'warte_kva': 'In Pr√ºfung',
                'kva_gesendet': 'Angebot erstellt',
                'beauftragt': 'Beauftragt',
                'in_arbeit': 'In Arbeit',
                'fertig': 'Fertig',
                'storniert': 'Storniert'
            };

            try {
                // Status History erweitern
                const anfrageDoc = await window.getCollection('partnerAnfragen').doc(anfrageId).get();
                const currentData = anfrageDoc.data();
                const statusHistory = currentData.statusHistory || [];

                // Neuen Status-Eintrag hinzuf√ºgen
                statusHistory.push({
                    status: newStatus,
                    timestamp: Date.now(),
                    changedBy: 'Admin',
                    changedAt: new Date().toISOString()
                });

                // Firestore aktualisieren
                await window.getCollection('partnerAnfragen').doc(anfrageId).update({
                    status: newStatus,
                    statusText: statusTexte[newStatus],
                    statusHistory: statusHistory,
                    lastUpdated: Date.now()
                });

                console.log(`‚úÖ Status ge√§ndert: ${anfrageId} ‚Üí ${newStatus}`);

                // UI aktualisieren
                await loadAnfragen();

                // Erfolgs-Feedback
                showNotification(`Status aktualisiert: ${statusTexte[newStatus]}`);

            } catch (error) {
                console.error('‚ùå Fehler beim Status-Update:', error);
                alert('Fehler beim √Ñndern des Status: ' + error.message);
            }
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #4caf50;
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                z-index: 10000;
                font-weight: 600;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = `‚úÖ ${message}`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        async function changeStatus(anfrageId, currentStatus) {
            const statuses = ['neu', 'warte_kva', 'kva_gesendet', 'beauftragt', 'in_arbeit', 'fertig', 'storniert'];
            const statusTexte = {
                'neu': 'Neu eingegangen',
                'warte_kva': 'In Pr√ºfung',
                'kva_gesendet': 'Angebot erstellt',
                'beauftragt': 'Beauftragt',
                'in_arbeit': 'In Lackierung',
                'fertig': 'Abholbereit',
                'storniert': 'Storniert'
            };

            const options = statuses.map(s => `${s === currentStatus ? '‚úì' : ''} ${statusTexte[s]}`).join('\n');
            const selected = prompt(`Status √§ndern f√ºr ${anfrageId}:\n\n${options}\n\nNeuen Status eingeben (neu/warte_kva/kva_gesendet/beauftragt/in_arbeit/fertig/storniert):`, currentStatus);

            if (selected && statuses.includes(selected)) {
                try {
                    await window.getCollection('partnerAnfragen').doc(anfrageId).update({
                        status: selected,
                        statusText: statusTexte[selected]
                    });

                    showToast('‚úÖ Status erfolgreich ge√§ndert!', 'success');
                    await loadAnfragen();
                } catch (error) {
                    console.error('‚ùå Fehler:', error);
                    alert('Fehler beim √Ñndern des Status: ' + error.message);
                }
            }
        }

        async function createVehicle(anfrageId) {
            const anfrage = allAnfragen.find(a => String(a.id) === String(anfrageId));
            if (!anfrage) {
                showToast('‚ùå Anfrage nicht gefunden', 'error');
                return;
            }

            // ========================================
            // SCHRITT 1: VALIDIERUNG
            // ========================================

            // 1.0: Doppel-Erstellung Check (CRITICAL!)
            if (anfrage.fahrzeugAngelegt) {
                alert('‚ö†Ô∏è Fahrzeug wurde bereits angelegt!\n\n' +
                    `üì¶ Fahrzeug-ID: ${anfrage.fahrzeugId || 'k.A.'}\n` +
                    `üìÖ Angelegt am: ${anfrage.fahrzeugAngelegtAm ? new Date(anfrage.fahrzeugAngelegtAm).toLocaleString('de-DE') : 'k.A.'}\n\n` +
                    `Das Fahrzeug ist bereits in der Hauptapp verf√ºgbar.`);
                return;
            }

            // 1.1: Status-Check
            if (anfrage.status !== 'beauftragt' && anfrage.status !== 'in_arbeit') {
                alert('‚ö†Ô∏è Fahrzeug kann nur bei Status "beauftragt" oder "in_arbeit" angelegt werden!\n\nAktueller Status: ' + anfrage.status);
                return;
            }

            // 1.2: KVA-Check
            if (!anfrage.kva) {
                showToast('‚ùå Kein KVA vorhanden!\n\nBitte zuerst ein KVA erstellen.', 'error');
                return;
            }

            // 1.3: Varianten-Auswahl Check
            if (!anfrage.kva.gewaehlteVariante && !anfrage.kva.varianten?.partner && !anfrage.kva.varianten?.original) {
                showToast('‚ö†Ô∏è Partner hat noch keine Variante gew√§hlt!\n\nBitte warten bis Partner eine Variante ausw√§hlt.', 'error');
                return;
            }

            // ‚úÖ FIX: DOPPEL-CHECK in Firestore ob Fahrzeug bereits existiert (Extra Safety!)
            // Falls fahrzeugAngelegt Flag nicht gesetzt wurde (Bug), pr√ºfen wir in Firestore
            console.log('üîç DOPPEL-CHECK: Pr√ºfe ob Fahrzeug bereits in Firestore existiert...');
            try {
                let existingVehicle = null;

                // Check 1: Auftragsnummer (wenn vorhanden)
                if (anfrage.auftragsnummer) {
                    existingVehicle = await window.getCollection('fahrzeuge')
                        .where('auftragsnummer', '==', anfrage.auftragsnummer)
                        .limit(1)
                        .get();
                    console.log(`   üìä Check Auftragsnummer "${anfrage.auftragsnummer}": ${existingVehicle.size} Treffer`);
                }

                // Check 2: Kennzeichen (Fallback wenn keine Auftragsnummer oder keine Treffer)
                if ((!existingVehicle || existingVehicle.empty) && anfrage.kennzeichen) {
                    existingVehicle = await window.getCollection('fahrzeuge')
                        .where('kennzeichen', '==', anfrage.kennzeichen.toUpperCase())
                        .limit(1)
                        .get();
                    console.log(`   üìä Check Kennzeichen "${anfrage.kennzeichen}": ${existingVehicle.size} Treffer`);
                }

                if (existingVehicle && !existingVehicle.empty) {
                    const vehicle = existingVehicle.docs[0];
                    console.error('‚ùå DUPLIKAT VERHINDERT! Fahrzeug existiert bereits:', vehicle.id);
                    alert('‚ö†Ô∏è Fahrzeug wurde bereits angelegt!\n\n' +
                        `üì¶ Fahrzeug-ID: ${vehicle.id}\n` +
                        `üöó Kennzeichen: ${vehicle.data().kennzeichen || 'k.A.'}\n` +
                        `üìÖ Angelegt am: ${vehicle.data().datum ? new Date(vehicle.data().datum).toLocaleString('de-DE') : 'k.A.'}\n\n` +
                        `DUPLIKAT VERHINDERT! Das Fahrzeug ist bereits in der Hauptapp verf√ºgbar.\n\n` +
                        `Hinweis: Falls fahrzeugAngelegt Flag fehlt, wird es jetzt nachtr√§glich gesetzt.`);

                    // ‚úÖ Nachtr√§glich fahrzeugAngelegt Flag setzen (falls vergessen)
                    if (!anfrage.fahrzeugAngelegt) {
                        console.log('üîß Setze fahrzeugAngelegt Flag nachtr√§glich...');
                        await window.getCollection('partnerAnfragen').doc(anfrageId).update({
                            fahrzeugAngelegt: true,
                            fahrzeugAngelegtAm: vehicle.data().datum || new Date().toISOString(),
                            fahrzeugId: vehicle.id
                        });
                        console.log('‚úÖ Flag nachtr√§glich gesetzt');
                    }

                    return; // Abbruch - Fahrzeug existiert bereits!
                }
                console.log('‚úÖ Kein Duplikat gefunden - Fahrzeug kann angelegt werden');
            } catch (checkError) {
                console.error('‚ùå Fehler beim Duplikat-Check:', checkError);
                // Trotzdem fortfahren - im schlimmsten Fall gibt es ein Duplikat
            }

            // ========================================
            // SCHRITT 2: PREIS ERMITTELN
            // ========================================

            let vereinbarterPreis = 0;
            let gewaehlteVarianteData = null;
            let variantenKey = anfrage.kva.gewaehlteVariante;

            console.log('üîç Preis-Ermittlung START');
            console.log('   KVA-Struktur:', anfrage.kva);
            console.log('   Gew√§hlte Variante:', variantenKey);

            // Preis aus gew√§hlter Variante
            if (variantenKey && anfrage.kva.varianten && anfrage.kva.varianten[variantenKey]) {
                gewaehlteVarianteData = anfrage.kva.varianten[variantenKey];
                vereinbarterPreis = gewaehlteVarianteData.gesamt;
                console.log(`   ‚úÖ Preis aus gew√§hlter Variante "${variantenKey}":`, vereinbarterPreis);
            }
            // Fallback: Partner-Variante (wenn nur eine vorhanden)
            else if (anfrage.kva.varianten && anfrage.kva.varianten.partner) {
                gewaehlteVarianteData = anfrage.kva.varianten.partner;
                vereinbarterPreis = gewaehlteVarianteData.gesamt;
                variantenKey = 'partner';
                console.log('   ‚úÖ Fallback: Partner-Variante:', vereinbarterPreis);
            }
            // Fallback: Original-Variante
            else if (anfrage.kva.varianten && anfrage.kva.varianten.original) {
                gewaehlteVarianteData = anfrage.kva.varianten.original;
                vereinbarterPreis = gewaehlteVarianteData.gesamt;
                variantenKey = 'original';
                console.log('   ‚úÖ Fallback: Original-Variante:', vereinbarterPreis);
            }
            // Legacy Format
            else if (anfrage.kva.gesamt) {
                vereinbarterPreis = anfrage.kva.gesamt;
                gewaehlteVarianteData = { gesamt: anfrage.kva.gesamt };
                variantenKey = 'legacy';
                console.log('   ‚úÖ Legacy-Format:', vereinbarterPreis);
            }

            // Validierung
            if (!vereinbarterPreis || vereinbarterPreis <= 0) {
                console.error('‚ùå Kein g√ºltiger Preis gefunden!');
                alert('‚ùå Kein g√ºltiger Preis gefunden!\n\nKVA-Daten:\n' + JSON.stringify(anfrage.kva, null, 2));
                return;
            }

            // ========================================
            // SCHRITT 3: BEST√ÑTIGUNG
            // ========================================

            const variantenName = variantenKey === 'partner' ? 'Partner-Ersatzteil' :
                                 variantenKey === 'original' ? 'Originalteile' :
                                 variantenKey === 'zubehoer' ? 'Zubeh√∂rteile' : 'Legacy';

            const confirmMsg = `Fahrzeug ${anfrage.auftragsnummer || anfrage.kennzeichen} in Hauptapp √ºbernehmen?\n\n` +
                `üöó Fahrzeug: ${anfrage.marke || ''} ${anfrage.modell || ''} (${anfrage.kennzeichen || anfrage.auftragsnummer})\n` +
                `üì¶ Service: ${anfrage.serviceTyp || 'Lackierung'}\n` +
                `üí∂ Preis: ${vereinbarterPreis.toFixed(2)}‚Ç¨ (${variantenName})\n` +
                `üìÖ Anliefertermin: ${anfrage.kva.termine ? new Date(anfrage.kva.termine.start).toLocaleDateString('de-DE') : 'k.A.'}\n\n` +
                `Dies erstellt ein neues Fahrzeug in der Annahme-Liste.`;

            if (!confirm(confirmMsg)) {
                return;
            }

            // ========================================
            // SCHRITT 4: FAHRZEUG-DATEN VORBEREITEN
            // ========================================

            // KUNDE EINGEBEN (CRITICAL!)
            const kundeName = prompt(
                'üë§ Kundenname eingeben:\n\n' +
                `üöó Fahrzeug: ${anfrage.marke} ${anfrage.modell} (${anfrage.kennzeichen})\n` +
                `üè¢ Partner: ${anfrage.partnerName}\n` +
                `üí∂ Preis: ${vereinbarterPreis.toFixed(2)}‚Ç¨\n\n` +
                `Bitte geben Sie den Namen des Endkunden ein:`,
                ''
            );

            if (!kundeName || kundeName.trim() === '') {
                showToast('‚ö†Ô∏è Kundenname ist erforderlich!\n\nOhne Kunde kann das Fahrzeug nicht korrekt zugeordnet werden.', 'error');
                return;
            }

            const fahrzeugData = {
                // Basis-Daten
                kennzeichen: (anfrage.kennzeichen || anfrage.auftragsnummer || '').toUpperCase(),
                marke: anfrage.marke || '',
                modell: anfrage.modell || '',
                // üîß FIX BUG #5: Alle 3 Farb-Felder setzen f√ºr Konsistenz
                farbe: anfrage.farbe || '',  // Basis-Farbe (Partner Portal)
                farbnummer: anfrage.farbnummer || anfrage.farbe || '-',  // Fallback auf farbe wenn keine Nummer
                farbname: anfrage.farbname || anfrage.farbe || '',  // Fallback auf farbe wenn kein Name
                lackart: anfrage.lackart || 'wasserlack',  // Standard: Wasserlack
                vin: anfrage.vin || '',

                // Service-Typ
                serviceTyp: anfrage.serviceTyp || 'lackier',

                // KUNDE (CRITICAL!)
                kundenname: kundeName.trim(),
                // kundenId wird sp√§ter gesetzt (registriereKundenbesuch)

                // DATUM/ZEIT (CRITICAL f√ºr Liste & Kalender!)
                datum: new Date().toLocaleDateString('de-DE'),
                zeit: new Date().toLocaleTimeString('de-DE'),

                // KVA-Daten (KRITISCH!)
                vereinbarterPreis: vereinbarterPreis,
                kvaGesamt: vereinbarterPreis,
                kvaLack: gewaehlteVarianteData.lackkosten || 0,
                kvaTeile: gewaehlteVarianteData.teilekosten || 0,
                kvaArbeitszeit: gewaehlteVarianteData.arbeitszeit || 0,
                kvaSonstiges: gewaehlteVarianteData.sonstiges || 0,

                // Termine
                anliefertermin: anfrage.kva.termine ? anfrage.kva.termine.start : null,
                abholtermin: anfrage.kva.termine ? anfrage.kva.termine.ende : null,
                abholzeit: anfrage.kva.termine ? anfrage.kva.termine.abholzeit : null,

                // Geplantes Abnahme-Datum f√ºr Kalender
                geplantesAbnahmeDatum: anfrage.kva.termine?.ende
                    ? new Date(anfrage.kva.termine.ende).toLocaleDateString('de-DE')
                    : null,

                // Schaden
                schadenBeschreibung: anfrage.schadenBeschreibung || '',

                // Status
                status: 'neu',
                prozessStatus: 'neu',

                // Metadaten
                quelle: 'Partner-Portal',
                partnerId: anfrage.partnerId,
                partnerName: anfrage.partnerName,
                partnerAnfrageId: anfrageId,
                // üîß FIX BUG #6: Datum-Format konsistent auf DE umgestellt
                erstelltAm: new Date().toLocaleDateString('de-DE'),  // Vorher: ISO-Format
                timestamp: Date.now(),
                // üîß FIX BUG #3: bezahlt & rechnungGeschrieben initial setzen
                bezahlt: false,  // Initial unbezahlt
                rechnungGeschrieben: false  // Initial keine Rechnung
            };

            console.log('üì¶ Fahrzeug-Daten vorbereitet:', fahrzeugData);

            // ========================================
            // SCHRITT 5: FAHRZEUG ERSTELLEN
            // ========================================

            try {
                console.log('üöó Erstelle Fahrzeug aus Partner-Anfrage...');

                // Fahrzeug in Firestore speichern
                const fahrzeugRef = await window.getCollection('fahrzeuge').add(fahrzeugData);

                console.log('‚úÖ Fahrzeug erstellt:', fahrzeugRef.id);

                // Fotos kopieren (falls vorhanden)
                if (anfrage.fotos && anfrage.fotos.length > 0) {
                    console.log(`üì∏ Kopiere ${anfrage.fotos.length} Fotos...`);

                    const fotosData = {
                        photos: anfrage.fotos,
                        count: anfrage.fotos.length,
                        lastUpdated: Date.now(),
                        quelle: 'Partner-Portal'
                    };

                    await window.getCollection('fahrzeuge')
                        .doc(fahrzeugRef.id)
                        .collection('fotos')
                        .doc('vorher')
                        .set(fotosData);

                    console.log('‚úÖ Fotos kopiert');
                }

                // Partner-Anfrage aktualisieren
                await window.getCollection('partnerAnfragen').doc(anfrageId).update({
                    fahrzeugAngelegt: true,
                    fahrzeugId: fahrzeugRef.id,
                    fahrzeugAngelegtAm: new Date().toISOString()
                });

                console.log('‚úÖ Partner-Anfrage aktualisiert');

                // Kunde registrieren (CRITICAL!)
                try {
                    console.log('üë§ Registriere Kunde:', kundeName);
                    const kundeId = await firebaseApp.registriereKundenbesuch(kundeName.trim());
                    if (kundeId) {
                        // kundenId im Fahrzeug speichern
                        await window.getCollection('fahrzeuge').doc(fahrzeugRef.id).update({
                            kundenId: kundeId
                        });
                        console.log('‚úÖ Kunde registriert, ID:', kundeId);
                    }
                } catch (error) {
                    console.error('‚ö†Ô∏è Fehler bei Kundenregistrierung:', error);
                    // Nicht kritisch - Fahrzeug wurde bereits erstellt
                }

                // Erfolg
                alert(`‚úÖ Fahrzeug erfolgreich angelegt!\n\n` +
                    `üöó Kennzeichen: ${fahrzeugData.kennzeichen}\n` +
                    `üë§ Kunde: ${kundeName}\n` +
                    `üí∂ Preis: ${vereinbarterPreis.toFixed(2)}‚Ç¨\n` +
                    `üì¶ Fahrzeug-ID: ${fahrzeugRef.id}\n\n` +
                    `Das Fahrzeug ist jetzt in der Hauptapp verf√ºgbar.`);

                // Seite neu laden
                loadAnfragen();

            } catch (error) {
                console.error('‚ùå Fehler beim Anlegen des Fahrzeugs:', error);
                alert('‚ùå Fehler beim Anlegen des Fahrzeugs:\n\n' + error.message);
            }
        }

        // ========================================
        // CHAT SYSTEM FUNKTIONEN
        // ========================================

        let activeChatAnfrageId = null;
        let chatUnsubscribe = null;
        const unreadCounts = {};

        function openChat(anfrageId, event) {
            if (event) event.stopPropagation();

            activeChatAnfrageId = anfrageId;
            const modal = document.getElementById('chatModal');
            modal.classList.add('active');
            modal.classList.remove('minimized');

            // Titel setzen
            const anfrage = allAnfragen.find(a => String(a.id) === String(anfrageId));
            if (anfrage) {
                document.getElementById('chatTitle').textContent = `Chat: ${anfrage.partnerName} - ${anfrage.auftragsnummer || anfrage.kennzeichen}`;
            }

            loadChatMessages(anfrageId);
            markChatAsRead(anfrageId);
        }

        function closeChatModal(event) {
            if (event) event.stopPropagation();

            const modal = document.getElementById('chatModal');
            modal.classList.remove('active');

            if (chatUnsubscribe) {
                chatUnsubscribe();
                chatUnsubscribe = null;
            }

            activeChatAnfrageId = null;
        }

        function toggleChatMinimize(event) {
            if (event) event.stopPropagation();

            const modal = document.getElementById('chatModal');
            modal.classList.toggle('minimized');
        }

        async function loadChatMessages(anfrageId) {
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">Lade Nachrichten...</p>';

            try {
                // Unsubscribe vorherigen Listener
                if (chatUnsubscribe) {
                    chatUnsubscribe();
                }

                // Real-time Listener
                chatUnsubscribe = window.getCollection('partnerAnfragen')
                    .doc(anfrageId)
                    .collection('chat')
                    .orderBy('timestamp', 'asc')
                    .onSnapshot((snapshot) => {
                        messagesContainer.innerHTML = '';

                        if (snapshot.empty) {
                            messagesContainer.innerHTML = `
                                <div style="text-align: center; color: #999; padding: 40px 20px;">
                                    <div style="font-size: 50px; margin-bottom: 15px;">üí¨</div>
                                    <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Noch keine Nachrichten</div>
                                    <div style="font-size: 13px;">Sende die erste Nachricht an den Partner</div>
                                </div>
                            `;
                            return;
                        }

                        snapshot.forEach(doc => {
                            const msg = doc.data();
                            const messageEl = createChatMessage(msg);
                            messagesContainer.appendChild(messageEl);
                        });

                        // Scroll zum Ende
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }, (error) => {
                        console.error('Chat Listener Error:', error);
                        messagesContainer.innerHTML = '<p style="text-align: center; color: #c62828; padding: 20px;">‚ùå Fehler beim Laden der Nachrichten</p>';
                    });

            } catch (error) {
                console.error('‚ùå Fehler beim Laden des Chats:', error);
                messagesContainer.innerHTML = '<p style="text-align: center; color: #c62828; padding: 20px;">‚ùå Fehler beim Laden</p>';
            }
        }

        function createChatMessage(msg) {
            const messageEl = document.createElement('div');

            if (msg.typ === 'system') {
                messageEl.className = 'chat-message-system';
                messageEl.textContent = msg.text;
                return messageEl;
            }

            messageEl.className = `chat-message ${msg.sender}`;

            const datum = new Date(msg.timestamp);
            const zeit = datum.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            const tag = datum.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });

            const senderName = msg.senderName || (msg.sender === 'werkstatt' ? 'Werkstatt' : 'Partner');
            const gelesen = msg.gelesen ? '‚úì‚úì' : '‚úì';

            messageEl.innerHTML = `
                <div class="chat-message-sender">${senderName}</div>
                <div class="chat-message-bubble">${msg.text}</div>
                <div class="chat-message-time">
                    ${tag} ‚Ä¢ ${zeit}
                    ${msg.sender === 'werkstatt' ? `<span>${gelesen}</span>` : ''}
                </div>
            `;

            return messageEl;
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const text = input.value.trim();

            if (!text || !activeChatAnfrageId) return;

            const sendBtn = document.querySelector('.chat-send-btn');
            sendBtn.disabled = true;

            try {
                const messageData = {
                    sender: 'werkstatt',
                    senderName: 'Auto-Lackierzentrum Mosbach',
                    text: text,
                    timestamp: new Date().toISOString(),
                    gelesen: false,
                    typ: 'text'
                };

                await window.getCollection('partnerAnfragen')
                    .doc(activeChatAnfrageId)
                    .collection('chat')
                    .add(messageData);

                input.value = '';
                input.style.height = 'auto';

            } catch (error) {
                console.error('‚ùå Fehler beim Senden:', error);
                showToast('Fehler beim Senden der Nachricht', 'error');
            } finally {
                sendBtn.disabled = false;
                input.focus();
            }
        }

        // Enter zum Senden
        document.addEventListener('DOMContentLoaded', () => {
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendChatMessage();
                    }
                });

                // Auto-resize textarea
                chatInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 100) + 'px';
                });
            }
        });

        async function loadUnreadCounts() {
            for (const anfrage of allAnfragen) {
                const lastRead = localStorage.getItem(`chat_last_read_admin_${anfrage.id}`) || '0';

                try {
                    const snapshot = await window.getCollection('partnerAnfragen')
                        .doc(anfrage.id)
                        .collection('chat')
                        .where('sender', '==', 'partner')
                        .where('timestamp', '>', lastRead)
                        .get();

                    unreadCounts[anfrage.id] = snapshot.size;
                } catch (error) {
                    // Fallback ohne timestamp filter
                    const snapshot = await window.getCollection('partnerAnfragen')
                        .doc(anfrage.id)
                        .collection('chat')
                        .where('sender', '==', 'partner')
                        .get();

                    const unreadMessages = snapshot.docs.filter(doc =>
                        doc.data().timestamp > lastRead
                    );

                    unreadCounts[anfrage.id] = unreadMessages.length;
                }
            }
        }

        function markChatAsRead(anfrageId) {
            const timestamp = new Date().toISOString();
            localStorage.setItem(`chat_last_read_admin_${anfrageId}`, timestamp);
            unreadCounts[anfrageId] = 0;
            renderAnfragen();
        }

        function getUnreadBadge(anfrageId) {
            const count = unreadCounts[anfrageId] || 0;
            if (count === 0) return '';
            return `<span class="unread-badge">${count}</span>`;
        }
    </script>

    <!-- Chat Modal -->
    <div class="chat-modal" id="chatModal">
        <div class="chat-header" onclick="toggleChatMinimize(event)">
            <div class="chat-header-title">
                <span>üí¨</span>
                <span id="chatTitle">Chat</span>
            </div>
            <div class="chat-header-actions">
                <button class="chat-header-btn" onclick="toggleChatMinimize(event)" title="Minimieren">
                    <span id="minimizeIcon">‚îÄ</span>
                </button>
                <button class="chat-header-btn" onclick="closeChatModal(event)" title="Schlie√üen">√ó</button>
            </div>
        </div>
        <div class="chat-body">
            <div class="chat-messages" id="chatMessages"></div>
        </div>
        <div class="chat-footer">
            <textarea class="chat-input" id="chatInput" placeholder="Nachricht eingeben..." rows="1"></textarea>
            <button class="chat-send-btn" onclick="sendChatMessage()" title="Senden">‚Üí</button>
        </div>
    </div>
    <script src="../listener-registry.js"></script>
    <script src="../error-handler.js"></script>
</body>
</html>
