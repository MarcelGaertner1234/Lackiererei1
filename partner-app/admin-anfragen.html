<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partner-Anfragen Admin | Auto-Lackierzentrum Mosbach</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .header h1 {
            color: #003366;
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn-primary {
            background: #003366;
            color: white;
        }

        .btn-primary:hover {
            background: #00509e;
            transform: translateY(-2px);
        }

        .btn-small {
            padding: 8px 12px;
            font-size: 13px;
        }

        .filter-section {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-group label {
            font-size: 13px;
            font-weight: 600;
            color: #003366;
        }

        .filter-group select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card .number {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-card .label {
            font-size: 13px;
            opacity: 0.9;
        }

        .anfragen-liste {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .anfrage-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 25px;
            transition: all 0.3s;
        }

        .anfrage-card:hover {
            border-color: #003366;
            box-shadow: 0 4px 12px rgba(0,51,102,0.1);
        }

        .anfrage-card.neu {
            border-left: 5px solid #1565c0;
        }

        .anfrage-card.warte_kva {
            border-left: 5px solid #e65100;
        }

        .anfrage-card.kva_gesendet {
            border-left: 5px solid #6a1b9a;
        }

        .anfrage-card.beauftragt {
            border-left: 5px solid #2e7d32;
        }

        .anfrage-card.in_arbeit {
            border-left: 5px solid #0277bd;
        }

        .anfrage-card.fertig {
            border-left: 5px solid #1b5e20;
        }

        .anfrage-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 20px;
        }

        .anfrage-title {
            font-size: 20px;
            font-weight: 600;
            color: #003366;
            margin-bottom: 5px;
        }

        .anfrage-subtitle {
            font-size: 14px;
            color: #999;
        }

        .status-badge {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
        }

        .status-badge.neu {
            background: #e3f2fd;
            color: #1565c0;
        }

        .status-badge.warte_kva {
            background: #fff3e0;
            color: #e65100;
        }

        .status-badge.kva_gesendet {
            background: #f3e5f5;
            color: #6a1b9a;
        }

        .status-badge.beauftragt {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status-badge.in_arbeit {
            background: #e1f5fe;
            color: #0277bd;
        }

        .status-badge.fertig {
            background: #c8e6c9;
            color: #1b5e20;
        }

        .anfrage-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
            margin-bottom: 20px;
        }

        .info-section h3 {
            font-size: 16px;
            color: #003366;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .detail-item {
            font-size: 14px;
        }

        .detail-item .label {
            color: #666;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .detail-item .value {
            color: #333;
            font-weight: 600;
        }

        .schadensbeschreibung {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .schadensbeschreibung .label {
            color: #666;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .schadensbeschreibung .text {
            color: #333;
            line-height: 1.6;
        }

        .photos-section {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .photo-grid img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .photo-grid img:hover {
            transform: scale(1.05);
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .kva-box {
            background: #f0f9ff;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #003366;
        }

        .kva-box .title {
            font-weight: 600;
            color: #003366;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .kva-box .price {
            font-size: 28px;
            font-weight: 700;
            color: #003366;
            margin-bottom: 10px;
        }

        .kva-box .details {
            font-size: 13px;
            color: #666;
            line-height: 1.6;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state .icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            max-width: 90%;
            max-height: 90%;
            border-radius: 10px;
            overflow: auto;
        }

        .modal-content img {
            width: 100%;
            height: auto;
            display: block;
        }

        @media (max-width: 900px) {
            .anfrage-grid {
                grid-template-columns: 1fr;
            }

            .detail-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¢ Partner-Anfragen Verwaltung</h1>
            <p>Admin-Bereich f√ºr Partner-Lackieranfragen</p>
        </div>

        <div class="nav-buttons">
            <a href="../index.html" class="btn btn-secondary">‚Üê Zur√ºck zur Hauptapp</a>
            <a href="../liste.html" class="btn btn-secondary">üöó Fahrzeuge</a>
        </div>

        <!-- Statistics -->
        <div class="stats-row" id="statsRow">
            <div class="stat-card">
                <div class="number" id="statsNeu">0</div>
                <div class="label">Neu</div>
            </div>
            <div class="stat-card">
                <div class="number" id="statsWarteKva">0</div>
                <div class="label">Warte auf KVA</div>
            </div>
            <div class="stat-card">
                <div class="number" id="statsKvaGesendet">0</div>
                <div class="label">KVA gesendet</div>
            </div>
            <div class="stat-card">
                <div class="number" id="statsBeauftragt">0</div>
                <div class="label">Beauftragt</div>
            </div>
            <div class="stat-card">
                <div class="number" id="statsInArbeit">0</div>
                <div class="label">In Arbeit</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filter-section">
            <div class="filter-row">
                <div class="filter-group">
                    <label for="filterStatus">Status filtern:</label>
                    <select id="filterStatus">
                        <option value="">Alle anzeigen</option>
                        <option value="neu">Neu</option>
                        <option value="warte_kva">Warte auf KVA</option>
                        <option value="kva_gesendet">KVA gesendet</option>
                        <option value="beauftragt">Beauftragt</option>
                        <option value="in_arbeit">In Arbeit</option>
                        <option value="fertig">Fertig</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filterPartner">Partner filtern:</label>
                    <select id="filterPartner">
                        <option value="">Alle Partner</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="filterDringlichkeit">Dringlichkeit:</label>
                    <select id="filterDringlichkeit">
                        <option value="">Alle</option>
                        <option value="eilig">Nur Eilig</option>
                        <option value="normal">Nur Normal</option>
                    </select>
                </div>
            </div>
        </div>

        <div id="loading" class="loading">
            <p>‚è≥ Anfragen werden geladen...</p>
        </div>

        <div id="anfrageNListe" class="anfragen-liste" style="display: none;">
            <!-- Dynamisch gef√ºllt -->
        </div>

        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="icon">üì≠</div>
            <h3>Keine Anfragen gefunden</h3>
            <p>Mit den aktuellen Filtern wurden keine Anfragen gefunden.</p>
        </div>
    </div>

    <!-- Photo Modal -->
    <div class="modal" id="photoModal" onclick="closePhotoModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <img id="modalPhoto" src="" alt="Foto">
        </div>
    </div>

    <script src="../firebase-config.js"></script>
    <script>
        let allAnfragen = [];
        let allPartner = [];

        window.addEventListener('DOMContentLoaded', async () => {
            await initFirebase();
            await loadAnfragen();
            setupFilters();
        });

        async function loadAnfragen() {
            const loading = document.getElementById('loading');
            const liste = document.getElementById('anfrageNListe');
            const emptyState = document.getElementById('emptyState');

            try {
                if (!db) throw new Error('Firebase nicht verf√ºgbar');

                // Alle Partner-Anfragen laden
                const snapshot = await db.collection('partnerAnfragen')
                    .orderBy('timestamp', 'desc')
                    .get();

                loading.style.display = 'none';

                if (snapshot.empty) {
                    emptyState.style.display = 'block';
                    return;
                }

                allAnfragen = [];
                snapshot.forEach(doc => {
                    allAnfragen.push(doc.data());
                });

                // Unique Partner extrahieren f√ºr Filter
                allPartner = [...new Set(allAnfragen.map(a => a.partnerName))].sort();
                updatePartnerFilter();

                updateStats();
                renderAnfragen();

            } catch (error) {
                console.error('‚ùå Fehler beim Laden:', error);
                loading.innerHTML = '<p style="color: #c62828;">‚ö†Ô∏è Fehler beim Laden der Anfragen</p>';
            }
        }

        function updatePartnerFilter() {
            const select = document.getElementById('filterPartner');
            allPartner.forEach(partner => {
                const option = document.createElement('option');
                option.value = partner;
                option.textContent = partner;
                select.appendChild(option);
            });
        }

        function updateStats() {
            const stats = {
                neu: 0,
                warte_kva: 0,
                kva_gesendet: 0,
                beauftragt: 0,
                in_arbeit: 0
            };

            allAnfragen.forEach(anfrage => {
                if (stats.hasOwnProperty(anfrage.status)) {
                    stats[anfrage.status]++;
                }
            });

            document.getElementById('statsNeu').textContent = stats.neu;
            document.getElementById('statsWarteKva').textContent = stats.warte_kva;
            document.getElementById('statsKvaGesendet').textContent = stats.kva_gesendet;
            document.getElementById('statsBeauftragt').textContent = stats.beauftragt;
            document.getElementById('statsInArbeit').textContent = stats.in_arbeit;
        }

        function setupFilters() {
            document.getElementById('filterStatus').addEventListener('change', renderAnfragen);
            document.getElementById('filterPartner').addEventListener('change', renderAnfragen);
            document.getElementById('filterDringlichkeit').addEventListener('change', renderAnfragen);
        }

        function renderAnfragen() {
            const liste = document.getElementById('anfrageNListe');
            const emptyState = document.getElementById('emptyState');

            const filterStatus = document.getElementById('filterStatus').value;
            const filterPartner = document.getElementById('filterPartner').value;
            const filterDringlichkeit = document.getElementById('filterDringlichkeit').value;

            let filtered = allAnfragen.filter(anfrage => {
                if (filterStatus && anfrage.status !== filterStatus) return false;
                if (filterPartner && anfrage.partnerName !== filterPartner) return false;
                if (filterDringlichkeit && anfrage.dringlichkeit !== filterDringlichkeit) return false;
                return true;
            });

            if (filtered.length === 0) {
                liste.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            liste.style.display = 'flex';
            emptyState.style.display = 'none';
            liste.innerHTML = '';

            filtered.forEach(anfrage => {
                const card = createAnfrageCard(anfrage);
                liste.appendChild(card);
            });
        }

        function createAnfrageCard(anfrage) {
            const card = document.createElement('div');
            card.className = 'anfrage-card ' + anfrage.status;

            const datum = new Date(anfrage.timestamp).toLocaleDateString('de-DE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            const statusTexte = {
                'neu': 'Neu eingegangen',
                'warte_kva': 'In Pr√ºfung',
                'kva_gesendet': 'Angebot erstellt',
                'beauftragt': 'Beauftragt',
                'in_arbeit': 'In Lackierung',
                'fertig': 'Abholbereit'
            };

            // Photos HTML
            let photosHTML = '';
            if (anfrage.fotos && anfrage.fotos.length > 0) {
                photosHTML = `
                    <div class="photos-section">
                        <div class="label">üì∑ Schadensfotos (${anfrage.fotos.length})</div>
                        <div class="photo-grid">
                            ${anfrage.fotos.map((foto, index) => `
                                <img src="${foto}" alt="Foto ${index + 1}" onclick="showPhoto('${foto}')">
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // KVA HTML
            let kvaHTML = '';
            let kvaButton = '';
            if (anfrage.kva) {
                // Neue Varianten-Struktur
                if (anfrage.kva.varianten) {
                    const gewaehlte = anfrage.kva.gewaehlteVariante;
                    const varianten = anfrage.kva.varianten;

                    kvaHTML = `
                        <div class="kva-box">
                            <div class="title">üí∂ KVA mit 3 Varianten erstellt</div>
                            <div style="display: grid; gap: 10px; margin-top: 15px;">
                                <div style="background: ${gewaehlte === 'original' ? '#e3f2fd' : '#f9f9f9'}; padding: 12px; border-radius: 8px;">
                                    <strong style="color: #003366;">‚≠ê Originalteile:</strong> ${varianten.original.gesamt.toFixed(2)}‚Ç¨
                                    ${gewaehlte === 'original' ? '<span style="color: #4caf50; margin-left: 10px; font-weight: 700;">‚úì Gew√§hlt</span>' : ''}
                                </div>
                                <div style="background: ${gewaehlte === 'zubehoer' ? '#fff3e0' : '#f9f9f9'}; padding: 12px; border-radius: 8px;">
                                    <strong style="color: #e65100;">üîß Zubeh√∂rteile:</strong> ${varianten.zubehoer.gesamt.toFixed(2)}‚Ç¨
                                    ${gewaehlte === 'zubehoer' ? '<span style="color: #4caf50; margin-left: 10px; font-weight: 700;">‚úì Gew√§hlt</span>' : ''}
                                </div>
                                ${varianten.partner ? `
                                    <div style="background: ${gewaehlte === 'partner' ? '#e8f5e9' : '#f9f9f9'}; padding: 12px; border-radius: 8px;">
                                        <strong style="color: #2e7d32;">üì¶ Partner-Ersatzteil:</strong> ${varianten.partner.gesamt.toFixed(2)}‚Ç¨
                                        ${gewaehlte === 'partner' ? '<span style="color: #4caf50; margin-left: 10px; font-weight: 700;">‚úì Gew√§hlt</span>' : ''}
                                    </div>
                                ` : ''}
                            </div>
                            <div style="margin-top: 12px; color: #666; font-size: 13px;">
                                <strong>Lieferzeit:</strong> ${anfrage.kva.lieferzeit || 'k.A.'}<br>
                                ${gewaehlte ? `<strong style="color: #4caf50;">Status:</strong> Partner hat "${gewaehlte === 'original' ? 'Originalteile' : gewaehlte === 'zubehoer' ? 'Zubeh√∂rteile' : 'Partner-Ersatzteil'}" gew√§hlt` : '<strong style="color: #ff9800;">Status:</strong> Partner muss noch w√§hlen'}
                            </div>
                        </div>
                    `;
                } else {
                    // Alte KVA-Struktur (Fallback)
                    kvaHTML = `
                        <div class="kva-box">
                            <div class="title">üí∂ Kostenvoranschlag erstellt</div>
                            <div class="price">${anfrage.kva.gesamt}‚Ç¨</div>
                            <div class="details">
                                Material: ${anfrage.kva.material}‚Ç¨<br>
                                Arbeitszeit: ${anfrage.kva.arbeitszeit}‚Ç¨<br>
                                Sonstiges: ${anfrage.kva.sonstiges}‚Ç¨<br>
                                Lieferzeit: ${anfrage.kva.lieferzeit || 'k.A.'}
                            </div>
                        </div>
                    `;
                }
            } else if (anfrage.status === 'neu' || anfrage.status === 'warte_kva') {
                kvaButton = `<a href="kva-erstellen.html?id=${anfrage.id}" class="btn btn-primary btn-small">üí∂ KVA erstellen</a>`;
            }

            card.innerHTML = `
                <div class="anfrage-header">
                    <div>
                        <div class="anfrage-title">${anfrage.auftragsnummer || anfrage.kennzeichen || 'Fahrzeug'}</div>
                        <div class="anfrage-subtitle">
                            ${anfrage.partnerName} ‚Ä¢ ${datum}
                        </div>
                    </div>
                    <div class="status-badge ${anfrage.status}">
                        ${statusTexte[anfrage.status] || anfrage.status}
                    </div>
                </div>

                <div class="anfrage-grid">
                    <div class="info-section">
                        <h3>üöó Fahrzeug- & Schadensdetails</h3>

                        <div class="detail-grid">
                            <div class="detail-item">
                                <div class="label">${anfrage.referenzType === 'auftrag' ? 'Auftragsnummer' : 'Kennzeichen'}</div>
                                <div class="value">${anfrage.auftragsnummer || anfrage.kennzeichen || 'k.A.'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="label">Fahrzeugdaten</div>
                                <div class="value" style="font-size: 12px; color: #666;">
                                    Aus VIN ermittelt
                                </div>
                            </div>
                            <div class="detail-item">
                                <div class="label">Dringlichkeit</div>
                                <div class="value">${anfrage.dringlichkeit === 'eilig' ? '‚ö° Eilig (1-2 Tage)' : 'üìÖ Normal (3-5 Tage)'}</div>
                            </div>
                        </div>

                        <!-- Fahrzeugidentifikation -->
                        ${anfrage.vin || (anfrage.fahrzeugscheinFotos && anfrage.fahrzeugscheinFotos.length > 0) ? `
                            <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #ff9800;">
                                <div style="font-weight: 600; color: #e65100; margin-bottom: 10px;">üî¢ Fahrzeugidentifikation</div>
                                ${anfrage.vin ? `
                                    <div style="font-family: monospace; font-size: 16px; font-weight: 700; color: #333;">
                                        VIN: ${anfrage.vin}
                                    </div>
                                ` : ''}
                                ${anfrage.fahrzeugscheinFotos && anfrage.fahrzeugscheinFotos.length > 0 ? `
                                    <div style="margin-top: 10px;">
                                        <div style="font-size: 13px; color: #e65100; margin-bottom: 8px;">üìÑ Fahrzeugschein (${anfrage.fahrzeugscheinFotos.length} Foto${anfrage.fahrzeugscheinFotos.length > 1 ? 's' : ''})</div>
                                        <div class="photo-grid">
                                            ${anfrage.fahrzeugscheinFotos.map((foto, index) => `
                                                <img src="${foto}" alt="Fahrzeugschein ${index + 1}" onclick="showPhoto('${foto}')" style="cursor: pointer; border-radius: 8px;">
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}

                        <div class="schadensbeschreibung">
                            <div class="label">Schadensbeschreibung</div>
                            <div class="text">${anfrage.schadenBeschreibung}</div>
                        </div>

                        <!-- Ersatzteil-Pr√§ferenz -->
                        ${anfrage.ersatzteilPraeferenz ? `
                            <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #4caf50;">
                                <div style="font-weight: 600; color: #2e7d32; margin-bottom: 10px;">üîß Ersatzteil-Pr√§ferenz</div>
                                <div style="font-size: 14px; color: #333;">
                                    ${anfrage.ersatzteilPraeferenz === 'gebrauchteil' ? 'Ersatzteil vorhanden (vom Partner)' : ''}
                                    ${anfrage.ersatzteilPraeferenz === 'originalteil' ? 'Nur Originalteile' : ''}
                                    ${anfrage.ersatzteilPraeferenz === 'guenstig' ? 'Zubeh√∂rteil <small style="color: #ff6b6b;">(‚ö†Ô∏è Passgenauigkeit nicht gew√§hrleistet)</small>' : ''}
                                </div>
                            </div>
                        ` : ''}

                        ${photosHTML}
                    </div>

                    <div class="info-section">
                        <h3>üìã Aktionen & KVA</h3>

                        ${kvaHTML}

                        <div class="action-buttons" style="margin-top: 20px;">
                            ${kvaButton}
                            <button class="btn btn-secondary btn-small" onclick="changeStatus('${anfrage.id}', '${anfrage.status}')">
                                üîÑ Status √§ndern
                            </button>
                            ${anfrage.status === 'beauftragt' || anfrage.status === 'in_arbeit' ? `
                                <button class="btn btn-primary btn-small" onclick="createVehicle('${anfrage.id}')">
                                    ‚ûï Fahrzeug anlegen
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;

            return card;
        }

        function showPhoto(photoData) {
            document.getElementById('modalPhoto').src = photoData;
            document.getElementById('photoModal').classList.add('show');
        }

        function closePhotoModal() {
            document.getElementById('photoModal').classList.remove('show');
        }

        async function changeStatus(anfrageId, currentStatus) {
            const statuses = ['neu', 'warte_kva', 'kva_gesendet', 'beauftragt', 'in_arbeit', 'fertig'];
            const statusTexte = {
                'neu': 'Neu eingegangen',
                'warte_kva': 'In Pr√ºfung',
                'kva_gesendet': 'Angebot erstellt',
                'beauftragt': 'Beauftragt',
                'in_arbeit': 'In Lackierung',
                'fertig': 'Abholbereit'
            };

            const options = statuses.map(s => `${s === currentStatus ? '‚úì' : ''} ${statusTexte[s]}`).join('\n');
            const selected = prompt(`Status √§ndern f√ºr ${anfrageId}:\n\n${options}\n\nNeuen Status eingeben (neu/warte_kva/kva_gesendet/beauftragt/in_arbeit/fertig):`, currentStatus);

            if (selected && statuses.includes(selected)) {
                try {
                    await db.collection('partnerAnfragen').doc(anfrageId).update({
                        status: selected,
                        statusText: statusTexte[selected]
                    });

                    alert('‚úÖ Status erfolgreich ge√§ndert!');
                    await loadAnfragen();
                } catch (error) {
                    console.error('‚ùå Fehler:', error);
                    alert('Fehler beim √Ñndern des Status: ' + error.message);
                }
            }
        }

        async function createVehicle(anfrageId) {
            const anfrage = allAnfragen.find(a => a.id === anfrageId);
            if (!anfrage) return;

            if (confirm(`Fahrzeug ${anfrage.marke} ${anfrage.modell} (${anfrage.kennzeichen}) in die Hauptapp √ºbernehmen?\n\nDies erstellt ein neues Fahrzeug in der Annahme-Liste.`)) {
                // In realer Implementation w√ºrde hier ein Fahrzeug erstellt
                alert('‚ÑπÔ∏è Diese Funktion wird mit der Hauptapp verkn√ºpft und erstellt automatisch ein Fahrzeug in der Annahme-Liste.');
            }
        }
    </script>
</body>
</html>
