<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Klima-Service | Partner Portal</title>
    <link rel="stylesheet" href="service-form-styles.css">
</head>
<body>
    <div class="main-layout">
        <!-- Wizard Sidebar -->
        <div class="wizard-sidebar">
            <div class="sidebar-header">
                <h2>‚ùÑÔ∏è Klima-Service</h2>
                <p>Wartung, Bef√ºllung & Reparatur</p>
            </div>
            <div class="sidebar-steps">
                <div class="sidebar-step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">Fotos</div>
                </div>
                <div class="sidebar-step pending" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">Fahrzeug</div>
                </div>
                <div class="sidebar-step pending" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">Klimaanlage</div>
                </div>
                <div class="sidebar-step pending" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-label">Termin</div>
                </div>
                <div class="sidebar-step pending" data-step="5">
                    <div class="step-number">5</div>
                    <div class="step-label">Zusammenfassung</div>
                </div>
            </div>
            <div class="sidebar-footer">
                <button onclick="window.location.href='service-auswahl.html'" class="btn-back">‚Üê Zur√ºck zur Auswahl</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="container">
            <!-- Step 1: Fotos -->
            <div class="wizard-step active" data-step="1">
                <div class="step-title">üì∏ Fotos hochladen</div>
                <div class="step-description">
                    Optional: Fotos vom Klimager√§t oder Armaturenbrett
                </div>
                <label class="photo-upload" for="photoInput">
                    <span class="upload-icon">üì∑</span>
                    <span class="upload-text">Fotos ausw√§hlen oder hier ablegen</span>
                    <input type="file" id="photoInput" accept="image/*" multiple>
                </label>
                <div class="photo-preview" id="photoPreview"></div>
                <button class="btn-primary" onclick="nextStep(2)">Weiter ‚Üí</button>
            </div>

            <!-- Step 2: Fahrzeug -->
            <div class="wizard-step" data-step="2">
                <div class="step-title">üöó Fahrzeug</div>
                <div class="form-group">
                    <label for="kennzeichen">Kennzeichen *</label>
                    <input type="text" id="kennzeichen" placeholder="MOS-CG 123" required>
                </div>
                <div class="form-group">
                    <label for="marke">Marke *</label>
                    <select id="marke" required>
                        <option value="">Bitte w√§hlen...</option>
                        <option value="Audi">Audi</option>
                        <option value="BMW">BMW</option>
                        <option value="Mercedes-Benz">Mercedes-Benz</option>
                        <option value="Volkswagen">Volkswagen</option>
                        <option value="Opel">Opel</option>
                        <option value="Ford">Ford</option>
                        <option value="Renault">Renault</option>
                        <option value="Peugeot">Peugeot</option>
                        <option value="Toyota">Toyota</option>
                        <option value="Hyundai">Hyundai</option>
                        <option value="Kia">Kia</option>
                        <option value="Mazda">Mazda</option>
                        <option value="Nissan">Nissan</option>
                        <option value="Skoda">Skoda</option>
                        <option value="Seat">Seat</option>
                        <option value="Fiat">Fiat</option>
                        <option value="Citroen">Citroen</option>
                        <option value="Dacia">Dacia</option>
                        <option value="Sonstige">Sonstige</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="modell">Modell *</label>
                    <input type="text" id="modell" placeholder="z.B. A4, 3er, Golf" required>
                </div>
                <div class="wizard-navigation">
                    <button class="btn-secondary" onclick="prevStep(1)">‚Üê Zur√ºck</button>
                    <button class="btn-primary" onclick="nextStep(3)">Weiter ‚Üí</button>
                </div>
            </div>

            <!-- Step 3: Klimaanlage Details -->
            <div class="wizard-step" data-step="3">
                <div class="step-title">‚ùÑÔ∏è Klimaanlage Details</div>

                <div class="form-section">
                    <label class="section-label">Service-Art *</label>
                    <div class="radio-group">
                        <label class="radio-option selected">
                            <input type="radio" name="klimaArt" value="wartung" checked>
                            <div class="option-content">
                                <div class="label">üîß Wartung / Inspektion</div>
                                <div class="sublabel">J√§hrliche Wartung, Funktionstest</div>
                            </div>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="klimaArt" value="befuellung">
                            <div class="option-content">
                                <div class="label">üí® Bef√ºllung / K√§ltemittel</div>
                                <div class="sublabel">K√§ltemittel nachf√ºllen</div>
                            </div>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="klimaArt" value="reparatur">
                            <div class="option-content">
                                <div class="label">üî® Reparatur</div>
                                <div class="sublabel">Defekte Komponenten ersetzen</div>
                            </div>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="klimaArt" value="desinfektion">
                            <div class="option-content">
                                <div class="label">üßº Desinfektion</div>
                                <div class="sublabel">Geruchsbeseitigung, Ozon-Behandlung</div>
                            </div>
                        </label>
                    </div>
                </div>

                <div class="form-section">
                    <label class="section-label">Symptome (Optional)</label>
                    <div class="checkbox-group">
                        <label class="checkbox-option">
                            <input type="checkbox" name="symptome" value="kein_kuehlung">
                            <span>‚ùå Keine K√ºhlung</span>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" name="symptome" value="schwache_kuehlung">
                            <span>‚ö†Ô∏è Schwache K√ºhlung</span>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" name="symptome" value="geruch">
                            <span>üëÉ Unangenehmer Geruch</span>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" name="symptome" value="geraeusche">
                            <span>üîä Ungew√∂hnliche Ger√§usche</span>
                        </label>
                        <label class="checkbox-option">
                            <input type="checkbox" name="symptome" value="feuchtigkeit">
                            <span>üíß Feuchtigkeit / Kondenswasser</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="klimaInfo">Zus√§tzliche Informationen (Optional)</label>
                    <textarea id="klimaInfo" rows="3" placeholder="Weitere Details zu Symptomen oder Vorgeschichte..."></textarea>
                </div>

                <div class="wizard-navigation">
                    <button class="btn-secondary" onclick="prevStep(2)">‚Üê Zur√ºck</button>
                    <button class="btn-primary" onclick="nextStep(4)">Weiter ‚Üí</button>
                </div>
            </div>

            <!-- Step 4: Termin -->
            <div class="wizard-step" data-step="4">
                <div class="step-title">üìÖ Wunschtermin</div>
                <div class="step-description">
                    W√§hlen Sie Ihren bevorzugten Termin f√ºr die Anlieferung
                </div>
                <div class="termin-grid" id="terminGrid">
                    <!-- Dynamically loaded -->
                </div>
                <div class="form-group">
                    <label for="anmerkungen">Anmerkungen zum Termin (Optional)</label>
                    <textarea id="anmerkungen" rows="3" placeholder="z.B. nur vormittags m√∂glich..."></textarea>
                </div>
                <div class="wizard-navigation">
                    <button class="btn-secondary" onclick="prevStep(3)">‚Üê Zur√ºck</button>
                    <button class="btn-primary" onclick="nextStep(5)">Weiter ‚Üí</button>
                </div>
            </div>

            <!-- Step 5: Zusammenfassung -->
            <div class="wizard-step" data-step="5">
                <div class="step-title">‚úÖ Zusammenfassung</div>
                <div class="step-description">
                    Bitte √ºberpr√ºfen Sie Ihre Angaben
                </div>
                <div id="summaryContent" class="summary-box">
                    <!-- Dynamically generated -->
                </div>
                <div class="wizard-navigation">
                    <button class="btn-secondary" onclick="prevStep(4)">‚Üê Zur√ºck</button>
                    <button class="btn-success" id="btnSubmit">Anfrage absenden</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="../firebase-config.js?v=a4192c4"></script>

    <script>
        let currentStep = 1;
        let photos = [];
        let partner = null;
        let selectedTermin = null;

        // Load partner from localStorage
        document.addEventListener('DOMContentLoaded', () => {
            partner = JSON.parse(localStorage.getItem('partner') || 'null');
            if (!partner) {
                alert('Bitte melden Sie sich erst an!');
                window.location.href = 'index.html';
                return;
            }

            // Load available Termine
            loadTermine();

            // Photo upload
            document.getElementById('photoInput').addEventListener('change', handlePhotoUpload);

            // Radio options
            document.querySelectorAll('.radio-option').forEach(option => {
                option.addEventListener('click', function() {
                    const radio = this.querySelector('input[type="radio"]');
                    if (radio) {
                        // Remove selected class from all options in the same group
                        this.closest('.radio-group').querySelectorAll('.radio-option').forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        // Add selected class to clicked option
                        this.classList.add('selected');
                        radio.checked = true;
                    }
                });
            });

            // Submit button
            document.getElementById('btnSubmit').addEventListener('click', submitAnfrage);
        });

        // ============================================
        // STEP NAVIGATION
        // ============================================
        function nextStep(stepNumber) {
            // Validation
            if (currentStep === 2) {
                const kennzeichen = document.getElementById('kennzeichen').value.trim();
                const marke = document.getElementById('marke').value;
                const modell = document.getElementById('modell').value.trim();

                if (!kennzeichen || !marke || !modell) {
                    alert('Bitte f√ºllen Sie alle Pflichtfelder aus!');
                    return;
                }
            }

            if (currentStep === 4) {
                if (!selectedTermin) {
                    alert('Bitte w√§hlen Sie einen Wunschtermin!');
                    return;
                }
            }

            // Show summary on step 5
            if (stepNumber === 5) {
                generateSummary();
            }

            // Hide current step
            document.querySelector(`.wizard-step[data-step="${currentStep}"]`).classList.remove('active');
            document.querySelector(`.sidebar-step[data-step="${currentStep}"]`).classList.remove('active');
            document.querySelector(`.sidebar-step[data-step="${currentStep}"]`).classList.add('completed');

            // Show next step
            currentStep = stepNumber;
            document.querySelector(`.wizard-step[data-step="${currentStep}"]`).classList.add('active');
            document.querySelector(`.sidebar-step[data-step="${currentStep}"]`).classList.add('active');

            // Scroll to top
            window.scrollTo(0, 0);
        }

        function prevStep(stepNumber) {
            // Hide current step
            document.querySelector(`.wizard-step[data-step="${currentStep}"]`).classList.remove('active');
            document.querySelector(`.sidebar-step[data-step="${currentStep}"]`).classList.remove('active');
            document.querySelector(`.sidebar-step[data-step="${currentStep}"]`).classList.add('pending');
            document.querySelector(`.sidebar-step[data-step="${currentStep}"]`).classList.remove('completed');

            // Show previous step
            currentStep = stepNumber;
            document.querySelector(`.wizard-step[data-step="${currentStep}"]`).classList.add('active');
            document.querySelector(`.sidebar-step[data-step="${currentStep}"]`).classList.remove('completed');
            document.querySelector(`.sidebar-step[data-step="${currentStep}"]`).classList.add('active');

            // Scroll to top
            window.scrollTo(0, 0);
        }

        // ============================================
        // PHOTO UPLOAD
        // ============================================
        function handlePhotoUpload(e) {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        photos.push(event.target.result);
                        renderPhotoPreview();
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function renderPhotoPreview() {
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = photos.map((photo, index) => `
                <div class="photo-item">
                    <img src="${photo}" alt="Foto ${index + 1}">
                    <button class="btn-remove" onclick="removePhoto(${index})">&times;</button>
                </div>
            `).join('');
        }

        function removePhoto(index) {
            photos.splice(index, 1);
            renderPhotoPreview();
        }

        // ============================================
        // TERMIN SELECTION
        // ============================================
        function loadTermine() {
            const terminGrid = document.getElementById('terminGrid');
            const termine = [];
            const today = new Date();

            // Generate next 14 days
            for (let i = 1; i <= 14; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() + i);

                // Skip Sundays
                if (date.getDay() === 0) continue;

                termine.push({
                    date: date.toISOString().split('T')[0],
                    weekday: ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'][date.getDay()],
                    day: date.getDate(),
                    month: date.toLocaleDateString('de-DE', { month: 'short' })
                });
            }

            terminGrid.innerHTML = termine.map(t => `
                <div class="termin-karte" data-date="${t.date}" onclick="selectTermin('${t.date}')">
                    <div class="weekday">${t.weekday}</div>
                    <div class="day">${t.day}</div>
                    <div class="month">${t.month}</div>
                </div>
            `).join('');
        }

        function selectTermin(date) {
            // Remove previous selection
            document.querySelectorAll('.termin-karte').forEach(k => k.classList.remove('selected'));

            // Select clicked termin
            document.querySelector(`.termin-karte[data-date="${date}"]`).classList.add('selected');
            selectedTermin = date;
        }

        // ============================================
        // SUMMARY GENERATION
        // ============================================
        function generateSummary() {
            const klimaArt = document.querySelector('input[name="klimaArt"]:checked').value;
            const klimaArtLabels = {
                'wartung': 'üîß Wartung / Inspektion',
                'befuellung': 'üí® Bef√ºllung / K√§ltemittel',
                'reparatur': 'üî® Reparatur',
                'desinfektion': 'üßº Desinfektion'
            };

            const symptome = Array.from(document.querySelectorAll('input[name="symptome"]:checked'))
                .map(cb => cb.value);

            const symptomeLabels = {
                'kein_kuehlung': '‚ùå Keine K√ºhlung',
                'schwache_kuehlung': '‚ö†Ô∏è Schwache K√ºhlung',
                'geruch': 'üëÉ Unangenehmer Geruch',
                'geraeusche': 'üîä Ungew√∂hnliche Ger√§usche',
                'feuchtigkeit': 'üíß Feuchtigkeit / Kondenswasser'
            };

            const summaryContent = document.getElementById('summaryContent');
            summaryContent.innerHTML = `
                <div class="summary-section">
                    <h3>üöó Fahrzeug</h3>
                    <p><strong>Kennzeichen:</strong> ${document.getElementById('kennzeichen').value}</p>
                    <p><strong>Marke:</strong> ${document.getElementById('marke').value}</p>
                    <p><strong>Modell:</strong> ${document.getElementById('modell').value}</p>
                </div>
                <div class="summary-section">
                    <h3>‚ùÑÔ∏è Klimaanlage</h3>
                    <p><strong>Service-Art:</strong> ${klimaArtLabels[klimaArt]}</p>
                    ${symptome.length > 0 ? `
                        <p><strong>Symptome:</strong></p>
                        <ul>
                            ${symptome.map(s => `<li>${symptomeLabels[s]}</li>`).join('')}
                        </ul>
                    ` : ''}
                    ${document.getElementById('klimaInfo').value ? `
                        <p><strong>Zus√§tzliche Informationen:</strong><br>${document.getElementById('klimaInfo').value}</p>
                    ` : ''}
                </div>
                <div class="summary-section">
                    <h3>üìÖ Termin</h3>
                    <p><strong>Wunschtermin:</strong> ${new Date(selectedTermin).toLocaleDateString('de-DE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                    ${document.getElementById('anmerkungen').value ? `
                        <p><strong>Anmerkungen:</strong> ${document.getElementById('anmerkungen').value}</p>
                    ` : ''}
                </div>
                <div class="summary-section">
                    <h3>üì∑ Fotos</h3>
                    <p>${photos.length} Foto(s) hochgeladen</p>
                </div>
            `;
        }

        // ============================================
        // SUBMIT ANFRAGE
        // ============================================
        async function submitAnfrage() {
            const btnSubmit = document.getElementById('btnSubmit');
            btnSubmit.disabled = true;
            btnSubmit.textContent = 'Wird gesendet...';

            try {
                // Compress photos
                const compressedPhotos = await Promise.all(photos.map(photo => compressImage(photo)));

                // Get form data
                const klimaArt = document.querySelector('input[name="klimaArt"]:checked').value;
                const symptome = Array.from(document.querySelectorAll('input[name="symptome"]:checked'))
                    .map(cb => cb.value);

                // Create anfrage data
                const anfrageData = {
                    id: 'req_' + Date.now(),
                    partnerId: partner.id,
                    partnerName: partner.name,
                    serviceTyp: 'klima',
                    serviceData: {
                        art: klimaArt,
                        symptome: symptome,
                        info: document.getElementById('klimaInfo').value.trim()
                    },
                    kennzeichen: document.getElementById('kennzeichen').value.trim(),
                    marke: document.getElementById('marke').value,
                    modell: document.getElementById('modell').value.trim(),
                    anliefertermin: selectedTermin,
                    anmerkungen: document.getElementById('anmerkungen').value.trim(),
                    fotos: compressedPhotos,
                    status: 'neu',
                    timestamp: new Date().toISOString()
                };

                // Save to Firestore
                await window.getCollection('partnerAnfragen').doc(anfrageData.id).set(anfrageData);

                // Success
                alert('‚úÖ Klima-Service Anfrage erfolgreich gesendet!');
                window.location.href = 'meine-anfragen.html';

            } catch (error) {
                console.error('Error submitting anfrage:', error);
                alert('‚ùå Fehler beim Senden der Anfrage: ' + error.message);
                btnSubmit.disabled = false;
                btnSubmit.textContent = 'Anfrage absenden';
            }
        }

        // ============================================
        // IMAGE COMPRESSION
        // ============================================
        function compressImage(base64Image) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // Max dimensions
                    const maxWidth = 1920;
                    const maxHeight = 1080;

                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth || height > maxHeight) {
                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                        width = width * ratio;
                        height = height * ratio;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);

                    // Compress to 85% quality
                    resolve(canvas.toDataURL('image/jpeg', 0.85));
                };
                img.src = base64Image;
            });
        }
    </script>
</body>
</html>
