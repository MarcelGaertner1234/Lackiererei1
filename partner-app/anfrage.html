<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neue Anfrage | Partner Portal</title>

    <!-- Shared Service-Form Styles (747 lines extracted to separate file) -->
    <link rel="stylesheet" href="service-form-styles.css">

    <!-- Mobile-Responsive CSS Framework -->
    <link rel="stylesheet" href="../mobile-responsive.css">

    <!-- Minimalistic Mobile Optimizations -->
    <style>
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 15px; border-radius: 8px; }
            .header h1 { font-size: 18px; margin-bottom: 6px; }
            .header p { font-size: 12px; }
            .wizard-nav { gap: 10px; }
            .btn { padding: 8px 14px; font-size: 12px; border-radius: 6px; }
            .btn-back { padding: 8px 12px; }
            .form-group label { font-size: 11px; }
            .form-group input, .form-group textarea, .form-group select {
                padding: 8px; font-size: 12px; border: 1px solid #e0e0e0;
            }
            .wizard-step .step-title { font-size: 16px; }
            .wizard-step .step-title .icon { font-size: 22px; }
            .photo-upload { padding: 20px; border-width: 2px; }
            .photo-upload .icon { font-size: 40px; }
            .photo-upload .text { font-size: 12px; }
            .toggle-option, .radio-option, .termin-option { padding: 10px; }
            .radio-option .label { font-size: 12px; }
            .radio-option .description { font-size: 11px; }
            .summary-section { padding: 12px; }
            .summary-section h3 { font-size: 12px; }
            .summary-section p { font-size: 12px; }
        }

        @media (max-width: 480px) {
            .container { padding: 12px; }
            .header h1 { font-size: 16px; }
            .btn { padding: 6px 10px; font-size: 10px; }
            .btn-back { padding: 6px 10px; font-size: 10px; }
            .wizard-step .step-title { font-size: 15px; }
            .form-group label { font-size: 10px; }
            .photo-upload { padding: 15px; }
        }
    </style>
</head>
<body>
    <div class="main-layout">
        <!-- Sidebar Navigation -->
        <div class="wizard-sidebar">
            <div class="sidebar-title">Fortschritt</div>
            <div class="sidebar-steps" id="sidebarSteps">
                <div class="sidebar-step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">Schadensfotos</div>
                    <div class="step-icon"></div>
                </div>
                <div class="sidebar-step pending" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">Fahrzeug-Ref.</div>
                    <div class="step-icon"></div>
                </div>
                <div class="sidebar-step pending" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">Identifikation</div>
                    <div class="step-icon"></div>
                </div>
                <div class="sidebar-step pending" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-label">Beschreibung</div>
                    <div class="step-icon"></div>
                </div>
                <div class="sidebar-step pending" data-step="5">
                    <div class="step-number">5</div>
                    <div class="step-label">Karosserie</div>
                    <div class="step-icon"></div>
                </div>
                <div class="sidebar-step pending" data-step="6">
                    <div class="step-number">6</div>
                    <div class="step-label">Ersatzteile</div>
                    <div class="step-icon"></div>
                </div>
                <div class="sidebar-step pending" data-step="7">
                    <div class="step-number">7</div>
                    <div class="step-label">Termin</div>
                    <div class="step-icon"></div>
                </div>
                <div class="sidebar-step pending" data-step="8">
                    <div class="step-number">8</div>
                    <div class="step-label">Lieferung</div>
                    <div class="step-icon"></div>
                </div>
                <div class="sidebar-step pending" data-step="9">
                    <div class="step-number">9</div>
                    <div class="step-label">Zusammenfassung</div>
                    <div class="step-icon"></div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="container">
            <div class="header">
                <h1>Neue Lackier-Anfrage</h1>
                <p id="partnerName">Partner Portal</p>
            </div>

        <!-- Progress Indicator -->
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 11%;"></div>
            </div>
            <div class="progress-text" id="progressText">Schritt 1 von 9</div>
        </div>

        <!-- Wizard Container -->
        <div class="wizard-container" id="wizardContainer">

            <!-- Step 1: Schadensfotos -->
            <div class="wizard-step active" data-step="1">
                <div class="step-title">
                    <span class="icon"></span>
                    <span>Schadensfotos</span>
                </div>
                <div class="form-group">
                    <label class="photo-upload" for="photoInput">
                        <div class="icon"></div>
                        <div class="text">
                            Klicken Sie hier, um Fotos vom Schaden aufzunehmen<br>
                            <small>(Kamera oder Galerie)</small>
                        </div>
                        <input type="file" id="photoInput" accept="image/*" multiple capture="environment">
                    </label>
                    <div class="photo-preview" id="photoPreview"></div>
                </div>
                <p style="color: #999; font-size: 13px; margin-top: 15px;">
                    Tipp: Laden Sie mindestens 1 Foto hoch, um fortzufahren
                </p>
            </div>

            <!-- Step 2: Fahrzeug-Referenz -->
            <div class="wizard-step" data-step="2">
                <div class="step-title">
                    <span class="icon"></span>
                    <span>Fahrzeug-Referenz</span>
                </div>
                <div class="form-group">
                    <label>Wie m√∂chten Sie das Fahrzeug identifizieren?</label>
                    <div class="toggle-group">
                        <label class="toggle-option selected" onclick="selectReferenzType('kennzeichen')">
                            <input type="radio" name="referenzType" value="kennzeichen" checked>
                            Kennzeichen
                        </label>
                        <label class="toggle-option" onclick="selectReferenzType('auftrag')">
                            <input type="radio" name="referenzType" value="auftrag">
                            Auftragsnummer
                        </label>
                    </div>

                    <!-- Kennzeichen Input -->
                    <div id="kennzeichenInput">
                        <label for="kennzeichen">Kennzeichen</label>
                        <input type="text" id="kennzeichen" placeholder="z.B. MOS-AB 123" style="text-transform: uppercase;">
                    </div>

                    <!-- Auftragsnummer Input -->
                    <div id="auftragInput" style="display: none;">
                        <label for="auftragsnummer">Auftragsnummer</label>
                        <input type="text" id="auftragsnummer" placeholder="z.B. AH-2024-0123">
                        <small style="color: #999; font-size: 12px; margin-top: 5px; display: block;">
                            Ihre interne Auftragsnummer f√ºr nicht-angemeldete Fahrzeuge
                        </small>
                    </div>
                </div>
            </div>

            <!-- Step 3: Fahrzeugidentifikation -->
            <div class="wizard-step" data-step="3">
                <div class="step-title">
                    <span class="icon">üîë</span>
                    <span>Fahrzeugidentifikation</span>
                </div>
                <div class="form-group">
                    <label>Wie m√∂chten Sie das Fahrzeug identifizieren?</label>
                    <div class="toggle-group">
                        <label class="toggle-option selected" onclick="selectIdentificationType('vin')">
                            <input type="radio" name="identificationType" value="vin" checked>
                            VIN-Nummer
                        </label>
                        <label class="toggle-option" onclick="selectIdentificationType('fahrzeugschein')">
                            <input type="radio" name="identificationType" value="fahrzeugschein">
                            Fahrzeugschein-Foto
                        </label>
                    </div>

                    <!-- VIN Input -->
                    <div id="vinInput">
                        <label for="vin">VIN-Nummer (17 Zeichen)</label>
                        <input type="text" id="vin" placeholder="z.B. WVWZZZ1JZXW123456" maxlength="17" pattern="[A-HJ-NPR-Z0-9]{17}" style="text-transform: uppercase;">
                        <small style="color: #999; font-size: 12px; margin-top: 5px; display: block;">
                            Fahrzeug-Identifizierungsnummer (17 Zeichen, keine Buchstaben I, O, Q)
                        </small>
                    </div>

                    <!-- Fahrzeugschein Foto -->
                    <div id="fahrzeugscheinInput" style="display: none;">
                        <label class="photo-upload" for="fahrzeugscheinInputFile">
                            <div class="icon">üìÑ</div>
                            <div class="text">
                                Fahrzeugschein Teil 1 fotografieren<br>
                                <small>(Vorder- und R√ºckseite)</small>
                            </div>
                            <input type="file" id="fahrzeugscheinInputFile" accept="image/*" multiple capture="environment">
                        </label>
                        <div class="photo-preview" id="fahrzeugscheinPreview"></div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Schadensbeschreibung -->
            <div class="wizard-step" data-step="4">
                <div class="step-title">
                    <span class="icon"></span>
                    <span>Schadensbeschreibung</span>
                </div>
                <div class="form-group">
                    <label for="schadenBeschreibung">Beschreiben Sie den Lackschaden</label>
                    <textarea id="schadenBeschreibung" placeholder="z.B. Kratzer an der Beifahrert√ºr, ca. 20cm lang, bis aufs Blech..."></textarea>
                </div>
            </div>

            <!-- Step 5: Karosserie-Arbeiten -->
            <div class="wizard-step" data-step="5">
                <div class="step-title">
                    <span class="icon"></span>
                    <span>Karosserie-Arbeiten</span>
                </div>
                <div class="form-group">
                    <label>Werden Demontage-/Montagearbeiten ben√∂tigt?</label>
                    <div class="radio-group">
                        <label class="radio-option" onclick="selectKarosserie(this, 'ja')">
                            <input type="radio" name="karosseriearbeiten" value="ja">
                            <div class="label">Ja, Demontage ben√∂tigt</div>
                            <div class="description">z.B. Sto√üf√§nger demontieren, T√ºrgriffe ausbauen</div>
                        </label>
                        <label class="radio-option selected" onclick="selectKarosserie(this, 'nein')">
                            <input type="radio" name="karosseriearbeiten" value="nein" checked>
                            <div class="label">Nein, nur Lackierung</div>
                            <div class="description">Keine zus√§tzlichen Arbeiten erforderlich</div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Step 6: Ersatzteil-Pr√§ferenzen -->
            <div class="wizard-step" data-step="6">
                <div class="step-title">
                    <span class="icon">üî©</span>
                    <span>Ersatzteil-Pr√§ferenzen</span>
                </div>
                <div class="form-group">
                    <label>Welche Ersatzteile sollen verwendet werden? (optional)</label>
                    <div class="radio-group">
                        <label class="radio-option" onclick="selectErsatzteil(this, 'gebrauchteil')">
                            <input type="radio" name="ersatzteilPraeferenz" value="gebrauchteil">
                            <div class="label">Ersatzteil vorhanden</div>
                            <div class="description">Ich stelle ein Ersatzteil zur Verf√ºgung</div>
                        </label>
                        <label class="radio-option" onclick="selectErsatzteil(this, 'originalteil')">
                            <input type="radio" name="ersatzteilPraeferenz" value="originalteil">
                            <div class="label">Nur Originalteile</div>
                            <div class="description">Bitte Originalteile (OEM) verwenden</div>
                        </label>
                        <label class="radio-option" onclick="selectErsatzteil(this, 'guenstig')">
                            <input type="radio" name="ersatzteilPraeferenz" value="guenstig">
                            <div class="label">Zubeh√∂rteil</div>
                            <div class="description">G√ºnstige Alternative ist OK</div>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Step 7: Termin-Auswahl -->
            <div class="wizard-step" data-step="7">
                <div class="step-title">
                    <span class="icon"></span>
                    <span>Gew√ºnschter Termin</span>
                </div>
                <div class="form-group">
                    <label>Wann soll das Fahrzeug angeliefert werden?</label>
                    <div class="termin-grid" id="terminGrid">
                        <div class="loading">
                            <div class="icon">‚è≥</div>
                            <div>Lade verf√ºgbare Termine...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 8: Lieferoptionen -->
            <div class="wizard-step" data-step="8">
                <div class="step-title">
                    <span class="icon"></span>
                    <span>Lieferoptionen</span>
                </div>
                <div class="form-group">
                    <label>Wie soll das Fahrzeug zu uns gelangen?</label>
                    <div class="radio-group">
                        <label class="radio-option selected" onclick="selectLieferoption(this, 'selbst')">
                            <input type="radio" name="lieferoption" value="selbst" checked>
                            <div class="label">Selbst bringen</div>
                            <div class="description" style="color: #2e7d32;">Kostenlos - Sie bringen das Fahrzeug vorbei</div>
                        </label>
                        <label class="radio-option" onclick="selectLieferoption(this, 'abholung')">
                            <input type="radio" name="lieferoption" value="abholung">
                            <div class="label">Abholservice</div>
                            <div class="description">Wir holen das Fahrzeug ab (+Aufpreis)</div>
                        </label>
                    </div>

                    <!-- Conditional: Abholtermin -->
                    <div id="abholFields" class="conditional-field" style="display: none;">
                        <div class="form-group">
                            <label for="abholtermin">Gew√ºnschter Abholtermin</label>
                            <input type="date" id="abholtermin">
                            <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">
                                Wir holen das Fahrzeug an Ihrer Gesch√§ftsadresse ab
                            </small>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="ersatzfahrzeugGewuenscht" style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                                <span style="font-size: 14px;">
                                    Ersatzfahrzeug gew√ºnscht <small style="color: #999;">(+Aufpreis)</small>
                                </span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 9: Zusammenfassung -->
            <div class="wizard-step" data-step="9">
                <div class="step-title">
                    <span class="icon"></span>
                    <span>Zusammenfassung</span>
                </div>
                <p style="color: #666; margin-bottom: 20px;">Bitte √ºberpr√ºfen Sie Ihre Angaben vor dem Absenden:</p>
                <div id="summaryContent"></div>
            </div>

        </div>

        <!-- Navigation Buttons -->
        <div class="wizard-nav">
            <button type="button" class="btn btn-back" id="btnBack" onclick="prevStep()" style="display: none;">
                ‚Üê Zur√ºck
            </button>
            <button type="button" class="btn btn-primary" id="btnNext" onclick="nextStep()">
                Weiter ‚Üí
            </button>
        </div>

        <!-- Success Message -->
        <div class="success-message" id="successMessage">
            <div class="icon"></div>
            <h3>Anfrage erfolgreich gesendet!</h3>
            <p>Wir melden uns schnellstm√∂glich mit einem Kostenvoranschlag bei Ihnen.</p>
            <button class="btn btn-primary" onclick="window.location.href='meine-anfragen.html'">
                Zu meinen Anfragen
            </button>
        </div>
    </div>
    </div><!-- End main-layout -->

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <script src="../firebase-config.js"></script>
    <script>
        // Global Variables
        let currentStep = 1;
        const totalSteps = 9;
        let partner = null;
        let photos = [];
        let fahrzeugscheinPhotos = [];

        // Initialize
        window.addEventListener('DOMContentLoaded', async () => {
            await initFirebase();
            checkLogin();
            setupPhotoUpload();
            setupFahrzeugscheinUpload();
            await ladeSmartetermine();
            updateProgress();
        });

        function checkLogin() {
            partner = JSON.parse(localStorage.getItem('partner') || 'null');
            if (!partner) {
                window.location.href = 'index.html';
                return;
            }
            document.getElementById('partnerName').textContent = partner.name;
        }

        // Progress Update
        function updateProgress() {
            const percent = (currentStep / totalSteps) * 100;
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = `Schritt ${currentStep} von ${totalSteps}`;
        }

        // Navigation Functions
        function nextStep() {
            // Validate current step
            if (!validateStep(currentStep)) {
                return;
            }

            if (currentStep === totalSteps) {
                submitAnfrage();
                return;
            }

            // Move to next step
            const currentStepEl = document.querySelector(`.wizard-step[data-step="${currentStep}"]`);
            const nextStepEl = document.querySelector(`.wizard-step[data-step="${currentStep + 1}"]`);

            currentStepEl.classList.remove('active');
            currentStepEl.classList.add('prev');

            setTimeout(() => {
                currentStepEl.classList.remove('prev');
            }, 400);

            nextStepEl.classList.add('active');

            currentStep++;
            updateProgress();
            updateButtons();
            updateSidebar();

            // Generate summary on step 9
            if (currentStep === totalSteps) {
                generateSummary();
            }

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function prevStep() {
            if (currentStep === 1) return;

            const currentStepEl = document.querySelector(`.wizard-step[data-step="${currentStep}"]`);
            const prevStepEl = document.querySelector(`.wizard-step[data-step="${currentStep - 1}"]`);

            currentStepEl.classList.remove('active');
            prevStepEl.classList.add('active');

            currentStep--;
            updateProgress();
            updateButtons();
            updateSidebar();

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateButtons() {
            const btnBack = document.getElementById('btnBack');
            const btnNext = document.getElementById('btnNext');

            if (currentStep === 1) {
                btnBack.style.display = 'none';
            } else {
                btnBack.style.display = 'inline-flex';
            }

            if (currentStep === totalSteps) {
                btnNext.textContent = 'Anfrage senden';
            } else {
                btnNext.textContent = 'Weiter ‚Üí';
            }
        }

        // Validation per Step
        function validateStep(step) {
            switch(step) {
                case 1: // Photos
                    if (photos.length === 0) {
                        alert('Bitte laden Sie mindestens ein Foto hoch.');
                        return false;
                    }
                    return true;

                case 2: // Referenz
                    const referenzType = document.querySelector('input[name="referenzType"]:checked').value;
                    if (referenzType === 'kennzeichen' && !document.getElementById('kennzeichen').value.trim()) {
                        alert('Bitte geben Sie das Kennzeichen ein.');
                        return false;
                    }
                    if (referenzType === 'auftrag' && !document.getElementById('auftragsnummer').value.trim()) {
                        alert('Bitte geben Sie die Auftragsnummer ein.');
                        return false;
                    }
                    return true;

                case 3: // Identification
                    const identificationType = document.querySelector('input[name="identificationType"]:checked').value;
                    if (identificationType === 'vin') {
                        const vin = document.getElementById('vin').value.trim();
                        if (!vin) {
                            alert('Bitte geben Sie die VIN-Nummer ein.');
                            return false;
                        }
                        if (vin.length !== 17) {
                            alert('Die VIN-Nummer muss exakt 17 Zeichen haben.');
                            return false;
                        }
                    } else {
                        if (fahrzeugscheinPhotos.length === 0) {
                            alert('Bitte fotografieren Sie den Fahrzeugschein (Vorder- und R√ºckseite).');
                            return false;
                        }
                    }
                    return true;

                case 4: // Beschreibung
                    if (!document.getElementById('schadenBeschreibung').value.trim()) {
                        alert('Bitte beschreiben Sie den Schaden.');
                        return false;
                    }
                    return true;

                case 8: // Lieferoptionen
                    const lieferoption = document.querySelector('input[name="lieferoption"]:checked').value;
                    if (lieferoption === 'abholung') {
                        if (!document.getElementById('abholtermin').value) {
                            alert('Bitte w√§hlen Sie einen Abholtermin.');
                            return false;
                        }
                    }
                    return true;

                default:
                    return true;
            }
        }

        // Photo Upload (Schadensfotos)
        function setupPhotoUpload() {
            const input = document.getElementById('photoInput');
            input.addEventListener('change', handlePhotoUpload);
        }

        async function handlePhotoUpload(event) {
            const files = Array.from(event.target.files);

            for (const file of files) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    photos.push(e.target.result);
                    displayPhotos();
                    updateNextButtonState();
                };
                reader.readAsDataURL(file);
            }
        }

        function displayPhotos() {
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = '';

            photos.forEach((photo, index) => {
                const div = document.createElement('div');
                div.className = 'photo-preview-item';
                div.innerHTML = `
                    <img src="${photo}" alt="Foto ${index + 1}">
                    <button type="button" class="remove-btn" onclick="removePhoto(${index})">√ó</button>
                `;
                preview.appendChild(div);
            });
        }

        function removePhoto(index) {
            photos.splice(index, 1);
            displayPhotos();
            updateNextButtonState();
        }

        function updateNextButtonState() {
            const btnNext = document.getElementById('btnNext');
            if (currentStep === 1) {
                btnNext.disabled = photos.length === 0;
            }
        }

        // Fahrzeugschein Upload
        function setupFahrzeugscheinUpload() {
            const input = document.getElementById('fahrzeugscheinInputFile');
            input.addEventListener('change', handleFahrzeugscheinUpload);
        }

        async function handleFahrzeugscheinUpload(event) {
            const files = Array.from(event.target.files);

            for (const file of files) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    fahrzeugscheinPhotos.push(e.target.result);
                    displayFahrzeugscheinPhotos();
                };
                reader.readAsDataURL(file);
            }
        }

        function displayFahrzeugscheinPhotos() {
            const preview = document.getElementById('fahrzeugscheinPreview');
            preview.innerHTML = '';

            fahrzeugscheinPhotos.forEach((photo, index) => {
                const div = document.createElement('div');
                div.className = 'photo-preview-item';
                div.innerHTML = `
                    <img src="${photo}" alt="Fahrzeugschein ${index + 1}">
                    <button type="button" class="remove-btn" onclick="removeFahrzeugscheinPhoto(${index})">√ó</button>
                `;
                preview.appendChild(div);
            });
        }

        function removeFahrzeugscheinPhoto(index) {
            fahrzeugscheinPhotos.splice(index, 1);
            displayFahrzeugscheinPhotos();
        }

        // Toggle Functions
        function selectReferenzType(type) {
            document.querySelectorAll('input[name="referenzType"]').forEach(input => {
                input.parentElement.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            const kennzeichenDiv = document.getElementById('kennzeichenInput');
            const auftragDiv = document.getElementById('auftragInput');

            if (type === 'kennzeichen') {
                kennzeichenDiv.style.display = 'block';
                auftragDiv.style.display = 'none';
                document.getElementById('auftragsnummer').value = '';
            } else {
                kennzeichenDiv.style.display = 'none';
                auftragDiv.style.display = 'block';
                document.getElementById('kennzeichen').value = '';
            }
        }

        function selectIdentificationType(type) {
            document.querySelectorAll('input[name="identificationType"]').forEach(input => {
                input.parentElement.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            const vinDiv = document.getElementById('vinInput');
            const fahrzeugscheinDiv = document.getElementById('fahrzeugscheinInput');

            if (type === 'vin') {
                vinDiv.style.display = 'block';
                fahrzeugscheinDiv.style.display = 'none';
                fahrzeugscheinPhotos = [];
                document.getElementById('fahrzeugscheinPreview').innerHTML = '';
            } else {
                vinDiv.style.display = 'none';
                fahrzeugscheinDiv.style.display = 'block';
                document.getElementById('vin').value = '';
            }
        }

        function selectKarosserie(element, value) {
            document.querySelectorAll('.radio-option').forEach(opt => {
                if (opt.querySelector('input[name="karosseriearbeiten"]')) {
                    opt.classList.remove('selected');
                }
            });
            element.classList.add('selected');
            element.querySelector('input').checked = true;
        }

        function selectErsatzteil(element, value) {
            document.querySelectorAll('.radio-option').forEach(opt => {
                if (opt.querySelector('input[name="ersatzteilPraeferenz"]')) {
                    opt.classList.remove('selected');
                }
            });
            element.classList.add('selected');
            element.querySelector('input').checked = true;
        }

        function selectLieferoption(element, value) {
            document.querySelectorAll('.radio-option').forEach(opt => {
                if (opt.querySelector('input[name="lieferoption"]')) {
                    opt.classList.remove('selected');
                }
            });
            element.classList.add('selected');
            element.querySelector('input').checked = true;

            const abholFields = document.getElementById('abholFields');
            if (value === 'abholung') {
                abholFields.style.display = 'block';
                const morgen = new Date();
                morgen.setDate(morgen.getDate() + 1);
                document.getElementById('abholtermin').min = morgen.toISOString().split('T')[0];
            } else {
                abholFields.style.display = 'none';
                document.getElementById('abholtermin').value = '';
                document.getElementById('ersatzfahrzeugGewuenscht').checked = false;
            }
        }

        // Smart Termine laden
        async function ladeSmartetermine() {
            const terminGrid = document.getElementById('terminGrid');

            if (!db) {
                console.error('Firebase nicht initialisiert');
                terminGrid.innerHTML = '<div class="loading"><div style="color: red;">Fehler beim Laden der Termine</div></div>';
                return;
            }

            try {
                const heute = new Date();
                heute.setHours(0, 0, 0, 0);
                const terminOptionen = [];

                console.log('üìÖ Lade Terminauslastung...');

                for (let i = 0; i < 14; i++) {
                    const datum = new Date(heute);
                    datum.setDate(heute.getDate() + i);
                    const dateStr = datum.toISOString().split('T')[0];

                    const annahmeSnapshot = await db.collection('fahrzeuge')
                        .where('annahmeDatum', '==', dateStr)
                        .get();
                    const abnahmeSnapshot = await db.collection('fahrzeuge')
                        .where('geplantesAbnahmeDatum', '==', dateStr)
                        .get();

                    const totalTermine = annahmeSnapshot.size + abnahmeSnapshot.size;

                    let auslastung;
                    if (totalTermine <= 2) auslastung = 'frei';
                    else if (totalTermine <= 4) auslastung = 'normal';
                    else auslastung = 'hoch';

                    terminOptionen.push({
                        datum: datum,
                        dateStr: dateStr,
                        anzahlTermine: totalTermine,
                        auslastung: auslastung,
                        tageVonHeute: i
                    });
                }

                const option1 = terminOptionen.find(t => t.tageVonHeute >= 1 && t.auslastung === 'frei') || terminOptionen[1];
                const option2 = terminOptionen.find(t => t.tageVonHeute >= 2 && t.tageVonHeute <= 3 && t.auslastung === 'frei') || terminOptionen[2];
                const option3 = terminOptionen.find(t => t.tageVonHeute >= 4 && t.tageVonHeute <= 6 && t.auslastung !== 'hoch') || terminOptionen[5];
                const option4 = terminOptionen.find(t => t.tageVonHeute >= 7 && t.tageVonHeute <= 10) || terminOptionen[8];

                const selectedTermine = [option1, option2, option3, option4];
                const labels = ['EXPRESS', 'SCHNELL', 'NORMAL', 'ENTSPANNT'];
                const colors = ['#d32f2f', '#ff6f00', '#1976d2', '#388e3c'];

                terminGrid.innerHTML = selectedTermine.map((t, idx) => {
                    const auslastungIcon = t.auslastung === 'frei' ? 'üü¢' : t.auslastung === 'normal' ? 'üü°' : 'üî¥';
                    const auslastungText = t.auslastung === 'frei' ? 'Freie Kapazit√§t' : t.auslastung === 'normal' ? 'Normale Auslastung' : 'Ausgelastet';
                    const wochentag = t.datum.toLocaleDateString('de-DE', { weekday: 'short' });
                    const tag = t.datum.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });

                    return `
                        <label class="termin-option ${idx === 0 ? 'selected' : ''}" onclick="selectTermin(this)">
                            <input type="radio" name="anliefertermin" value="${t.dateStr}" data-label="${labels[idx]}" ${idx === 0 ? 'checked' : ''}>
                            <div class="label" style="color: ${colors[idx]};">${labels[idx]}</div>
                            <div style="font-weight: 600; margin: 5px 0;">${wochentag}, ${tag}</div>
                            <small style="display: block;">${auslastungIcon} ${auslastungText}</small>
                            <small style="display: block; color: #999; margin-top: 3px;">
                                ${t.tageVonHeute === 0 ? 'Heute' : t.tageVonHeute === 1 ? 'Morgen' : `in ${t.tageVonHeute} Tagen`}
                            </small>
                        </label>
                    `;
                }).join('');

            } catch (error) {
                console.error('Fehler beim Laden der Termine:', error);
                terminGrid.innerHTML = '<div class="loading"><div style="color: red;">Fehler beim Laden der Termine</div></div>';
            }
        }

        function selectTermin(element) {
            document.querySelectorAll('.termin-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            element.classList.add('selected');
            element.querySelector('input').checked = true;
        }

        // Summary Generation
        function generateSummary() {
            const summaryContent = document.getElementById('summaryContent');
            const referenzType = document.querySelector('input[name="referenzType"]:checked').value;
            const identificationType = document.querySelector('input[name="identificationType"]:checked').value;
            const karosserie = document.querySelector('input[name="karosseriearbeiten"]:checked').value;
            const ersatzteil = document.querySelector('input[name="ersatzteilPraeferenz"]:checked');
            const termin = document.querySelector('input[name="anliefertermin"]:checked');
            const lieferoption = document.querySelector('input[name="lieferoption"]:checked').value;

            let html = '';

            // Fotos
            html += `
                <div class="summary-section">
                    <h3> Schadensfotos</h3>
                    <p>${photos.length} Foto(s) hochgeladen</p>
                </div>
            `;

            // Fahrzeug-Referenz
            html += `
                <div class="summary-section">
                    <h3> Fahrzeug-Referenz</h3>
                    <p class="label">${referenzType === 'kennzeichen' ? 'Kennzeichen' : 'Auftragsnummer'}</p>
                    <p>${referenzType === 'kennzeichen' ? document.getElementById('kennzeichen').value : document.getElementById('auftragsnummer').value}</p>
                </div>
            `;

            // Fahrzeugidentifikation
            html += `
                <div class="summary-section">
                    <h3>üîë Fahrzeugidentifikation</h3>
                    <p class="label">${identificationType === 'vin' ? 'VIN-Nummer' : 'Fahrzeugschein-Foto'}</p>
                    <p>${identificationType === 'vin' ? document.getElementById('vin').value : fahrzeugscheinPhotos.length + ' Foto(s)'}</p>
                </div>
            `;

            // Schadensbeschreibung
            html += `
                <div class="summary-section">
                    <h3> Schadensbeschreibung</h3>
                    <p>${document.getElementById('schadenBeschreibung').value}</p>
                </div>
            `;

            // Karosserie
            html += `
                <div class="summary-section">
                    <h3> Karosserie-Arbeiten</h3>
                    <p>${karosserie === 'ja' ? 'Ja, Demontage ben√∂tigt' : 'Nein, nur Lackierung'}</p>
                </div>
            `;

            // Ersatzteil
            if (ersatzteil) {
                const ersatzteilLabel = ersatzteil.value === 'gebrauchteil' ? 'Ersatzteil vorhanden' :
                                       ersatzteil.value === 'originalteil' ? 'Nur Originalteile' : 'Zubeh√∂rteil';
                html += `
                    <div class="summary-section">
                        <h3>üî© Ersatzteil-Pr√§ferenz</h3>
                        <p>${ersatzteilLabel}</p>
                    </div>
                `;
            }

            // Termin
            if (termin) {
                const terminLabel = termin.getAttribute('data-label');
                const terminDatum = new Date(termin.value).toLocaleDateString('de-DE', { weekday: 'long', day: '2-digit', month: '2-digit', year: 'numeric' });
                html += `
                    <div class="summary-section">
                        <h3> Gew√ºnschter Termin</h3>
                        <p class="label">${terminLabel}</p>
                        <p>${terminDatum}</p>
                    </div>
                `;
            }

            // Lieferoption
            html += `
                <div class="summary-section">
                    <h3> Lieferoption</h3>
                    <p>${lieferoption === 'selbst' ? 'Selbst bringen' : 'Abholservice'}</p>
                    ${lieferoption === 'abholung' ? `
                        <p class="label" style="margin-top: 5px;">Abholtermin</p>
                        <p>${new Date(document.getElementById('abholtermin').value).toLocaleDateString('de-DE')}</p>
                        ${document.getElementById('ersatzfahrzeugGewuenscht').checked ? '<p style="margin-top: 5px;">‚úì Ersatzfahrzeug gew√ºnscht</p>' : ''}
                    ` : ''}
                </div>
            `;

            summaryContent.innerHTML = html;
        }

        // Bild-Komprimierung (Base64)
        async function compressImage(base64, maxWidth = 800, quality = 0.65) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    let width = img.width;
                    let height = img.height;
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.onerror = () => reject(new Error('Komprimierung fehlgeschlagen'));
                img.src = base64;
            });
        }

        // Submit Anfrage
        async function submitAnfrage() {
            const btnNext = document.getElementById('btnNext');
            btnNext.disabled = true;
            btnNext.textContent = '‚è≥ Wird komprimiert & gesendet...';

            try {
                if (!db) throw new Error('Firebase nicht verf√ºgbar');

                // Fotos komprimieren
                console.log('üì∏ Komprimiere ' + photos.length + ' Fotos...');
                const compressedPhotos = await Promise.all(photos.map(p => compressImage(p)));

                // Fahrzeugschein komprimieren (falls vorhanden)
                let compressedFahrzeugschein = [];
                if (fahrzeugscheinPhotos.length > 0) {
                    console.log('üì∏ Komprimiere ' + fahrzeugscheinPhotos.length + ' Fahrzeugschein-Fotos...');
                    compressedFahrzeugschein = await Promise.all(fahrzeugscheinPhotos.map(p => compressImage(p, 800, 0.7)));
                }

                btnNext.textContent = '‚è≥ Wird gesendet...';

                const referenzType = document.querySelector('input[name="referenzType"]:checked').value;
                const identificationType = document.querySelector('input[name="identificationType"]:checked').value;
                const lieferoption = document.querySelector('input[name="lieferoption"]:checked').value;
                const termin = document.querySelector('input[name="anliefertermin"]:checked');

                const anfrageId = 'req_' + Date.now();
                const timestamp = new Date().toISOString();

                const anfrageData = {
                    id: anfrageId,
                    partnerId: partner.id,
                    partnerName: partner.name,
                    serviceTyp: 'lackier',
                    timestamp: timestamp,
                    erstelltAm: timestamp,

                    // Fahrzeug-Referenz
                    referenzType: referenzType,
                    kennzeichen: referenzType === 'kennzeichen' ? document.getElementById('kennzeichen').value.toUpperCase() : null,
                    auftragsnummer: referenzType === 'auftrag' ? document.getElementById('auftragsnummer').value : null,

                    // Fahrzeugidentifikation
                    identificationType: identificationType,
                    vin: identificationType === 'vin' ? document.getElementById('vin').value.toUpperCase() : null,
                    fahrzeugscheinFotos: identificationType === 'fahrzeugschein' ? compressedFahrzeugschein : [],

                    // Anfrage
                    schadenBeschreibung: document.getElementById('schadenBeschreibung').value,
                    karosseriearbeiten: document.querySelector('input[name="karosseriearbeiten"]:checked').value,
                    ersatzteilPraeferenz: document.querySelector('input[name="ersatzteilPraeferenz"]:checked')?.value || null,
                    anliefertermin: termin ? termin.value : null,
                    dringlichkeitLabel: termin ? termin.getAttribute('data-label') : 'NORMAL',
                    lieferoption: lieferoption,
                    abholserviceGewuenscht: lieferoption === 'abholung',
                    abholtermin: lieferoption === 'abholung' ? document.getElementById('abholtermin').value : null,
                    abholadresse: lieferoption === 'abholung' ? (partner.adresse || null) : null,
                    ersatzfahrzeugGewuenscht: document.getElementById('ersatzfahrzeugGewuenscht').checked,
                    fotos: compressedPhotos, // Komprimierte Fotos!

                    // Status
                    status: 'neu',
                    statusText: 'Neu eingegangen',
                    kva: null,
                    fahrzeugId: null
                };

                await db.collection('partnerAnfragen').doc(anfrageId).set(anfrageData);

                console.log('‚úÖ Anfrage gespeichert:', anfrageId);

                // Show success
                document.querySelector('.wizard-container').style.display = 'none';
                document.querySelector('.wizard-nav').style.display = 'none';
                document.querySelector('.progress-container').style.display = 'none';
                document.getElementById('successMessage').classList.add('show');

            } catch (error) {
                console.error('Fehler:', error);
                alert('Fehler beim Senden der Anfrage: ' + error.message);
                btnNext.disabled = false;
                btnNext.textContent = 'Anfrage senden';
            }
        }

        // Update Sidebar
        function updateSidebar() {
            const sidebarSteps = document.querySelectorAll('.sidebar-step');

            sidebarSteps.forEach((step, index) => {
                const stepNumber = index + 1;

                // Remove all state classes
                step.classList.remove('completed', 'active', 'pending');

                // Add appropriate class based on current step
                if (stepNumber < currentStep) {
                    step.classList.add('completed');
                } else if (stepNumber === currentStep) {
                    step.classList.add('active');
                } else {
                    step.classList.add('pending');
                }
            });
        }
    </script>
</body>
</html>
