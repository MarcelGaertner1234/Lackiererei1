<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neue Anfrage | Partner Portal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .header h1 {
            color: #003366;
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn-primary {
            background: #003366;
            color: white;
            flex: 1;
        }

        .btn-primary:hover {
            background: #00509e;
            transform: translateY(-2px);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #003366;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #003366;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #003366;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .photo-upload {
            border: 3px dashed #e0e0e0;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: #f9f9f9;
        }

        .photo-upload:hover {
            border-color: #003366;
            background: #f0f9ff;
        }

        .photo-upload input {
            display: none;
        }

        .photo-upload .icon {
            font-size: 50px;
            margin-bottom: 15px;
        }

        .photo-upload .text {
            color: #666;
            font-size: 14px;
        }

        .photo-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .photo-preview-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
        }

        .photo-preview-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .photo-preview-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255,0,0,0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 16px;
        }

        .dringlichkeit-group {
            display: flex;
            gap: 15px;
        }

        .dringlichkeit-option {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .dringlichkeit-option input {
            display: none;
        }

        .dringlichkeit-option:hover {
            border-color: #003366;
            background: #f0f9ff;
        }

        .dringlichkeit-option.selected {
            border-color: #003366;
            background: #e3f2fd;
        }

        .dringlichkeit-option .icon {
            font-size: 30px;
            margin-bottom: 8px;
        }

        .dringlichkeit-option .label {
            font-weight: 600;
            color: #003366;
            font-size: 14px;
        }

        .success-message {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        .success-message .icon {
            font-size: 60px;
            margin-bottom: 15px;
        }

        .success-message h3 {
            margin-bottom: 10px;
            font-size: 20px;
        }

        .success-message p {
            margin-bottom: 20px;
        }

        /* Fahrzeugidentifikation Toggle */
        .identification-toggle {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }

        .toggle-option {
            flex: 1;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            background: white;
        }

        .toggle-option input {
            display: none;
        }

        .toggle-option:hover {
            border-color: #003366;
            background: #f0f9ff;
        }

        .toggle-option.selected {
            border-color: #003366;
            background: #e3f2fd;
            box-shadow: 0 4px 12px rgba(0,51,102,0.1);
        }

        .toggle-option .icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .toggle-option .label {
            font-weight: 600;
            color: #003366;
            font-size: 15px;
        }

        .identification-section {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .identification-section label {
            display: block;
            font-weight: 600;
            color: #003366;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .identification-section input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            font-family: monospace;
            font-weight: 600;
        }

        .identification-section input[type="text"]:focus {
            outline: none;
            border-color: #003366;
        }

        /* Ersatzteil-Optionen */
        .ersatzteil-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .ersatzteil-option {
            padding: 20px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            background: white;
        }

        .ersatzteil-option input {
            display: none;
        }

        .ersatzteil-option:hover {
            border-color: #003366;
            background: #f0f9ff;
        }

        .ersatzteil-option.selected {
            border-color: #003366;
            background: #e3f2fd;
            box-shadow: 0 4px 12px rgba(0,51,102,0.1);
        }

        .ersatzteil-option .label {
            font-weight: 600;
            color: #003366;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .ersatzteil-option .description {
            font-size: 11px;
            color: #666;
            line-height: 1.4;
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .dringlichkeit-group {
                flex-direction: column;
            }

            .ersatzteil-options {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã Neue Lackier-Anfrage</h1>
            <p id="partnerName">Partner Portal</p>
        </div>

        <div class="nav-buttons">
            <a href="meine-anfragen.html" class="btn btn-secondary">‚Üê Zur√ºck</a>
        </div>

        <form id="anfrageForm" style="display: block;">
            <!-- Fotos hochladen -->
            <div class="section-title">üì∏ Schadensfotos</div>
            <div class="form-group">
                <label class="photo-upload" for="photoInput">
                    <div class="icon">üì∑</div>
                    <div class="text">
                        Klicken Sie hier, um Fotos vom Schaden aufzunehmen<br>
                        <small>(Kamera oder Galerie)</small>
                    </div>
                    <input type="file" id="photoInput" accept="image/*" multiple capture="environment">
                </label>
                <div class="photo-preview" id="photoPreview"></div>
            </div>

            <!-- Fahrzeug-Referenz -->
            <div class="section-title">üöó Fahrzeug-Referenz *</div>
            <div class="form-group">
                <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
                    Geben Sie das Kennzeichen an <strong>oder</strong> (falls nicht angemeldet) Ihre interne Auftragsnummer.
                </p>

                <div class="identification-toggle">
                    <label class="toggle-option selected" onclick="selectFahrzeugReferenz('kennzeichen')">
                        <input type="radio" name="referenzType" value="kennzeichen" checked>
                        <div class="icon">üöó</div>
                        <div class="label">Kennzeichen</div>
                    </label>
                    <label class="toggle-option" onclick="selectFahrzeugReferenz('auftrag')">
                        <input type="radio" name="referenzType" value="auftrag">
                        <div class="icon">üìã</div>
                        <div class="label">Auftragsnummer</div>
                    </label>
                </div>

                <!-- Kennzeichen Eingabe -->
                <div id="kennzeichenSection" class="identification-section">
                    <label for="kennzeichen">Kennzeichen</label>
                    <input type="text" id="kennzeichen" placeholder="z.B. MOS-AB 123" style="text-transform: uppercase;">
                </div>

                <!-- Auftragsnummer Eingabe -->
                <div id="auftragSection" class="identification-section" style="display: none;">
                    <label for="auftragsnummer">Auftragsnummer</label>
                    <input type="text" id="auftragsnummer" placeholder="z.B. AH-2024-0123">
                    <small style="color: #999; font-size: 12px; margin-top: 5px; display: block;">
                        Ihre interne Auftragsnummer f√ºr nicht-angemeldete Fahrzeuge
                    </small>
                </div>
            </div>

            <!-- Fahrzeugidentifikation -->
            <div class="section-title">üî¢ Fahrzeugidentifikation *</div>
            <div class="form-group">
                <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
                    Bitte geben Sie entweder die VIN-Nummer ein <strong>oder</strong> fotografieren Sie den Fahrzeugschein.
                </p>

                <div class="identification-toggle">
                    <label class="toggle-option selected" onclick="selectIdentification('vin')">
                        <input type="radio" name="identificationType" value="vin" checked>
                        <div class="icon">üìù</div>
                        <div class="label">VIN eingeben</div>
                    </label>
                    <label class="toggle-option" onclick="selectIdentification('fahrzeugschein')">
                        <input type="radio" name="identificationType" value="fahrzeugschein">
                        <div class="icon">üìÑ</div>
                        <div class="label">Fahrzeugschein fotografieren</div>
                    </label>
                </div>

                <!-- VIN Eingabe -->
                <div id="vinSection" class="identification-section">
                    <label for="vin">VIN-Nummer (17 Zeichen)</label>
                    <input type="text" id="vin" placeholder="z.B. WVWZZZ1JZXW123456" maxlength="17" pattern="[A-HJ-NPR-Z0-9]{17}" style="text-transform: uppercase;">
                    <small style="color: #999; font-size: 12px; margin-top: 5px; display: block;">
                        Fahrzeug-Identifizierungsnummer (17 Zeichen, keine Buchstaben I, O, Q)
                    </small>
                </div>

                <!-- Fahrzeugschein Foto -->
                <div id="fahrzeugscheinSection" class="identification-section" style="display: none;">
                    <label class="photo-upload" for="fahrzeugscheinInput" style="margin-bottom: 15px;">
                        <div class="icon">üìÑ</div>
                        <div class="text">
                            Fahrzeugschein Teil 1 fotografieren<br>
                            <small>(Vorder- und R√ºckseite)</small>
                        </div>
                        <input type="file" id="fahrzeugscheinInput" accept="image/*" multiple capture="environment">
                    </label>
                    <div class="photo-preview" id="fahrzeugscheinPreview"></div>
                </div>
            </div>

            <!-- Schadensbeschreibung -->
            <div class="form-group">
                <label for="schadenBeschreibung">Schadensbeschreibung *</label>
                <textarea id="schadenBeschreibung" placeholder="Beschreiben Sie den Lackschaden..." required></textarea>
            </div>

            <!-- Ersatzteil-Pr√§ferenzen -->
            <div class="section-title">üîß Ersatzteil-Pr√§ferenzen (optional)</div>
            <div class="form-group">
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                    Geben Sie Ihre Pr√§ferenz f√ºr Ersatzteile an (optional).
                </p>

                <div class="ersatzteil-options">
                    <label class="ersatzteil-option" onclick="selectErsatzteil(this, 'gebrauchteil')">
                        <input type="radio" name="ersatzteilPraeferenz" id="gebrauchteil" value="gebrauchteil">
                        <div class="label">Ersatzteil vorhanden</div>
                        <div class="description">Ich stelle ein Ersatzteil zur Verf√ºgung</div>
                    </label>

                    <label class="ersatzteil-option" onclick="selectErsatzteil(this, 'originalteil')">
                        <input type="radio" name="ersatzteilPraeferenz" id="originalteil" value="originalteil">
                        <div class="label">Nur Originalteile</div>
                        <div class="description">Bitte Originalteile (OEM) verwenden</div>
                    </label>

                    <label class="ersatzteil-option" onclick="selectErsatzteil(this, 'guenstig')">
                        <input type="radio" name="ersatzteilPraeferenz" id="guenstig" value="guenstig">
                        <div class="label">Zubeh√∂rteil</div>
                        <div class="description">G√ºnstige Alternative ist OK<br><small style="color: #ff6b6b;">‚ö†Ô∏è Passgenauigkeit nicht gew√§hrleistet (Spaltma√üe)</small></div>
                    </label>
                </div>
            </div>

            <!-- Gew√ºnschter Anliefertermin -->
            <div class="section-title">üìÖ Gew√ºnschter Termin (Fahrzeug-Anlieferung)</div>
            <div id="terminvorschlaege" class="dringlichkeit-group">
                <div style="text-align: center; padding: 20px; color: #999;">
                    ‚è≥ Lade verf√ºgbare Termine...
                </div>
            </div>

            <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 30px;" id="submitBtn">
                üì§ Anfrage senden
            </button>
        </form>

        <div class="success-message" id="successMessage">
            <div class="icon">‚úÖ</div>
            <h3>Anfrage erfolgreich gesendet!</h3>
            <p>Wir melden uns schnellstm√∂glich mit einem Kostenvoranschlag bei Ihnen.</p>
            <button class="btn btn-primary" onclick="window.location.href='meine-anfragen.html'">
                Zu meinen Anfragen
            </button>
        </div>
    </div>

    <script src="../firebase-config.js"></script>
    <script>
        let photos = [];
        let fahrzeugscheinPhotos = [];
        let partner = null;

        // Smarte Terminvorschl√§ge basierend auf Kalenderauslastung
        async function ladeSmarteTerminvorschlaege() {
            const terminDiv = document.getElementById('terminvorschlaege');

            if (!db) {
                console.error('Firebase nicht initialisiert');
                terminDiv.innerHTML = '<div style="color: red;">Fehler beim Laden der Termine</div>';
                return;
            }

            try {
                // N√§chste 14 Tage laden und Auslastung berechnen
                const heute = new Date();
                heute.setHours(0, 0, 0, 0);
                const terminOptionen = [];

                console.log('üìÖ Lade Terminauslastung f√ºr n√§chste 14 Tage...');

                for (let i = 0; i < 14; i++) {
                    const datum = new Date(heute);
                    datum.setDate(heute.getDate() + i);
                    const dateStr = datum.toISOString().split('T')[0];

                    // Termine f√ºr diesen Tag z√§hlen (Annahme + Abnahme)
                    const annahmeSnapshot = await db.collection('fahrzeuge')
                        .where('annahmeDatum', '==', dateStr)
                        .get();
                    const abnahmeSnapshot = await db.collection('fahrzeuge')
                        .where('geplantesAbnahmeDatum', '==', dateStr)
                        .get();

                    const totalTermine = annahmeSnapshot.size + abnahmeSnapshot.size;

                    // Auslastung kategorisieren
                    let auslastung;
                    if (totalTermine <= 2) {
                        auslastung = 'frei';
                    } else if (totalTermine <= 4) {
                        auslastung = 'normal';
                    } else {
                        auslastung = 'hoch';
                    }

                    terminOptionen.push({
                        datum: datum,
                        dateStr: dateStr,
                        anzahlTermine: totalTermine,
                        auslastung: auslastung,
                        tageVonHeute: i
                    });
                }

                console.log('‚úÖ Terminoptionen geladen:', terminOptionen.length);

                // 4 beste Termine ausw√§hlen
                // Option 1 (EXPRESS): N√§chster freier Tag (ab morgen) oder Tag +1
                const option1 = terminOptionen.find(t => t.tageVonHeute >= 1 && t.auslastung === 'frei') || terminOptionen[1];

                // Option 2 (SCHNELL): In 2-3 Tagen, bevorzugt frei
                const option2 = terminOptionen.find(t => t.tageVonHeute >= 2 && t.tageVonHeute <= 3 && t.auslastung === 'frei')
                             || terminOptionen.find(t => t.tageVonHeute >= 2 && t.tageVonHeute <= 3)
                             || terminOptionen[2];

                // Option 3 (NORMAL): In 4-6 Tagen, nicht hoch ausgelastet
                const option3 = terminOptionen.find(t => t.tageVonHeute >= 4 && t.tageVonHeute <= 6 && t.auslastung !== 'hoch')
                             || terminOptionen.find(t => t.tageVonHeute >= 4 && t.tageVonHeute <= 6)
                             || terminOptionen[5];

                // Option 4 (ENTSPANNT): In 7-10 Tagen, beliebig
                const option4 = terminOptionen.find(t => t.tageVonHeute >= 7 && t.tageVonHeute <= 10)
                             || terminOptionen[8];

                const selectedTermine = [option1, option2, option3, option4];

                console.log('üéØ Ausgew√§hlte Termine:', selectedTermine.map(t => `${t.dateStr} (${t.auslastung})`));

                // UI generieren
                const icons = ['‚ö°', 'üöÄ', 'üìÖ', 'üå¥'];
                const labels = ['EXPRESS', 'SCHNELL', 'NORMAL', 'ENTSPANNT'];
                const colors = ['#d32f2f', '#ff6f00', '#1976d2', '#388e3c'];

                terminDiv.innerHTML = selectedTermine.map((t, idx) => {
                    const auslastungIcon = t.auslastung === 'frei' ? 'üü¢' : t.auslastung === 'normal' ? 'üü°' : 'üî¥';
                    const auslastungText = t.auslastung === 'frei' ? 'Freie Kapazit√§t' : t.auslastung === 'normal' ? 'Normale Auslastung' : 'Ausgelastet';

                    const wochentag = t.datum.toLocaleDateString('de-DE', { weekday: 'short' });
                    const tag = t.datum.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });

                    return `
                        <label class="dringlichkeit-option ${idx === 0 ? 'selected' : ''}" onclick="selectTermin(this, '${t.dateStr}', '${labels[idx]}')">
                            <input type="radio" name="anliefertermin" value="${t.dateStr}" ${idx === 0 ? 'checked' : ''}>
                            <div class="icon" style="font-size: 28px;">${icons[idx]}</div>
                            <div class="label" style="color: ${colors[idx]};">${labels[idx]}</div>
                            <div style="font-size: 14px; font-weight: 600; margin: 5px 0; color: #333;">
                                ${wochentag}, ${tag}
                            </div>
                            <small style="display: block;">${auslastungIcon} ${auslastungText}</small>
                            <small style="display: block; color: #999; margin-top: 3px;">
                                ${t.tageVonHeute === 0 ? 'Heute' : t.tageVonHeute === 1 ? 'Morgen' : `in ${t.tageVonHeute} Tagen`}
                            </small>
                        </label>
                    `;
                }).join('');

                console.log('‚úÖ Terminvorschl√§ge UI generiert');

            } catch (error) {
                console.error('‚ùå Fehler beim Laden der Terminvorschl√§ge:', error);
                terminDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #999;">
                        <div style="font-size: 40px; margin-bottom: 10px;">‚ö†Ô∏è</div>
                        <div>Terminvorschl√§ge konnten nicht geladen werden.</div>
                        <div style="font-size: 12px; margin-top: 10px;">Bitte laden Sie die Seite neu.</div>
                    </div>
                `;
            }
        }

        // Termin ausw√§hlen
        function selectTermin(element, dateStr, label) {
            document.querySelectorAll('.dringlichkeit-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            element.classList.add('selected');
            console.log(`üìÖ Termin gew√§hlt: ${label} - ${dateStr}`);
        }

        window.addEventListener('DOMContentLoaded', async () => {
            await initFirebase();
            checkLogin();
            setupPhotoUpload();
            setupFahrzeugscheinUpload();
            await ladeSmarteTerminvorschlaege();
        });

        function checkLogin() {
            partner = JSON.parse(localStorage.getItem('partner') || 'null');
            if (!partner) {
                window.location.href = 'index.html';
                return;
            }
            document.getElementById('partnerName').textContent = partner.name;
        }

        function setupPhotoUpload() {
            const input = document.getElementById('photoInput');
            input.addEventListener('change', handlePhotoUpload);
        }

        async function handlePhotoUpload(event) {
            const files = Array.from(event.target.files);

            for (const file of files) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    photos.push(e.target.result);
                    displayPhotos();
                };
                reader.readAsDataURL(file);
            }
        }

        function displayPhotos() {
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = '';

            photos.forEach((photo, index) => {
                const div = document.createElement('div');
                div.className = 'photo-preview-item';
                div.innerHTML = `
                    <img src="${photo}" alt="Foto ${index + 1}">
                    <button type="button" class="remove-btn" onclick="removePhoto(${index})">√ó</button>
                `;
                preview.appendChild(div);
            });
        }

        function removePhoto(index) {
            photos.splice(index, 1);
            displayPhotos();
        }

        // Ersatzteil-Optionen Toggle (Radio Buttons - Single Choice)
        function selectErsatzteil(element, value) {
            const radio = element.querySelector('input[type="radio"]');

            // Radio wird automatisch selected, wir m√ºssen nur die visuelle Klasse updaten
            radio.checked = true;

            // Entferne selected von allen Optionen
            document.querySelectorAll('.ersatzteil-option').forEach(opt => {
                opt.classList.remove('selected');
            });

            // F√ºge selected zur geklickten Option hinzu
            element.classList.add('selected');
        }

        // Fahrzeug-Referenz Toggle
        function selectFahrzeugReferenz(type) {
            // Toggle options - nur innerhalb der Referenz-Gruppe
            const referenzToggles = document.querySelectorAll('input[name="referenzType"]');
            referenzToggles.forEach(toggle => {
                toggle.parentElement.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            // Show/hide sections
            const kennzeichenSection = document.getElementById('kennzeichenSection');
            const auftragSection = document.getElementById('auftragSection');

            if (type === 'kennzeichen') {
                kennzeichenSection.style.display = 'block';
                auftragSection.style.display = 'none';
                // Clear Auftragsnummer
                document.getElementById('auftragsnummer').value = '';
            } else {
                kennzeichenSection.style.display = 'none';
                auftragSection.style.display = 'block';
                // Clear Kennzeichen
                document.getElementById('kennzeichen').value = '';
            }
        }

        // Fahrzeugidentifikation Toggle
        function selectIdentification(type) {
            // Toggle options - nur innerhalb der Identifikation-Gruppe
            const identToggles = document.querySelectorAll('input[name="identificationType"]');
            identToggles.forEach(toggle => {
                toggle.parentElement.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            // Show/hide sections
            const vinSection = document.getElementById('vinSection');
            const fahrzeugscheinSection = document.getElementById('fahrzeugscheinSection');

            if (type === 'vin') {
                vinSection.style.display = 'block';
                fahrzeugscheinSection.style.display = 'none';
                // Clear Fahrzeugschein photos if switching to VIN
                fahrzeugscheinPhotos = [];
                document.getElementById('fahrzeugscheinPreview').innerHTML = '';
            } else {
                vinSection.style.display = 'none';
                fahrzeugscheinSection.style.display = 'block';
                // Clear VIN if switching to Fahrzeugschein
                document.getElementById('vin').value = '';
            }
        }

        // Fahrzeugschein Upload
        function setupFahrzeugscheinUpload() {
            const input = document.getElementById('fahrzeugscheinInput');
            input.addEventListener('change', handleFahrzeugscheinUpload);
        }

        async function handleFahrzeugscheinUpload(event) {
            const files = Array.from(event.target.files);

            for (const file of files) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    fahrzeugscheinPhotos.push(e.target.result);
                    displayFahrzeugscheinPhotos();
                };
                reader.readAsDataURL(file);
            }
        }

        function displayFahrzeugscheinPhotos() {
            const preview = document.getElementById('fahrzeugscheinPreview');
            preview.innerHTML = '';

            fahrzeugscheinPhotos.forEach((photo, index) => {
                const div = document.createElement('div');
                div.className = 'photo-preview-item';
                div.innerHTML = `
                    <img src="${photo}" alt="Fahrzeugschein ${index + 1}">
                    <button type="button" class="remove-btn" onclick="removeFahrzeugscheinPhoto(${index})">√ó</button>
                `;
                preview.appendChild(div);
            });
        }

        function removeFahrzeugscheinPhoto(index) {
            fahrzeugscheinPhotos.splice(index, 1);
            displayFahrzeugscheinPhotos();
        }

        // Formular absenden
        document.getElementById('anfrageForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ Wird gesendet...';

            try {
                if (!db) throw new Error('Firebase nicht verf√ºgbar');

                if (photos.length === 0) {
                    throw new Error('Bitte f√ºgen Sie mindestens ein Foto hinzu');
                }

                // Validierung: Kennzeichen ODER Auftragsnummer muss vorhanden sein
                const kennzeichen = document.getElementById('kennzeichen').value.trim();
                const auftragsnummer = document.getElementById('auftragsnummer').value.trim();
                const referenzType = document.querySelector('input[name="referenzType"]:checked').value;

                if (referenzType === 'kennzeichen' && !kennzeichen) {
                    throw new Error('Bitte geben Sie das Kennzeichen ein');
                }

                if (referenzType === 'auftrag' && !auftragsnummer) {
                    throw new Error('Bitte geben Sie Ihre Auftragsnummer ein');
                }

                // Validierung: VIN ODER Fahrzeugschein muss vorhanden sein
                const vin = document.getElementById('vin').value.trim();
                const identificationType = document.querySelector('input[name="identificationType"]:checked').value;

                if (identificationType === 'vin' && !vin) {
                    throw new Error('Bitte geben Sie die VIN-Nummer ein (17 Zeichen)');
                }

                if (identificationType === 'vin' && vin.length !== 17) {
                    throw new Error('Die VIN-Nummer muss exakt 17 Zeichen haben');
                }

                if (identificationType === 'fahrzeugschein' && fahrzeugscheinPhotos.length === 0) {
                    throw new Error('Bitte fotografieren Sie den Fahrzeugschein (Vorder- und R√ºckseite)');
                }

                const anfrageId = 'req_' + Date.now();
                const timestamp = new Date().toISOString();

                const anfrageData = {
                    id: anfrageId,
                    partnerId: partner.id,
                    partnerName: partner.name,
                    timestamp: timestamp,
                    erstelltAm: timestamp,

                    // Fahrzeug-Referenz
                    referenzType: referenzType,
                    kennzeichen: referenzType === 'kennzeichen' ? kennzeichen.toUpperCase() : null,
                    auftragsnummer: referenzType === 'auftrag' ? auftragsnummer : null,

                    // Fahrzeugidentifikation
                    identificationType: identificationType,
                    vin: identificationType === 'vin' ? vin.toUpperCase() : null,
                    fahrzeugscheinFotos: identificationType === 'fahrzeugschein' ? fahrzeugscheinPhotos : [],

                    // Ersatzteil-Pr√§ferenz (Single Choice)
                    ersatzteilPraeferenz: document.querySelector('input[name="ersatzteilPraeferenz"]:checked')?.value || null,

                    // Anfrage
                    schadenBeschreibung: document.getElementById('schadenBeschreibung').value,
                    anliefertermin: document.querySelector('input[name="anliefertermin"]:checked')?.value || null,
                    dringlichkeitLabel: document.querySelector('input[name="anliefertermin"]:checked')?.parentElement.querySelector('.label')?.textContent || 'NORMAL',
                    fotos: photos,

                    // Status
                    status: 'neu',
                    statusText: 'Neu eingegangen',

                    // KVA (sp√§ter ausgef√ºllt)
                    kva: null,

                    // Fahrzeug (sp√§ter verkn√ºpft)
                    fahrzeugId: null
                };

                // In Firestore speichern
                await db.collection('partnerAnfragen').doc(anfrageId).set(anfrageData);

                console.log('‚úÖ Anfrage gespeichert:', anfrageId);

                // Success anzeigen
                document.getElementById('anfrageForm').style.display = 'none';
                document.getElementById('successMessage').classList.add('show');

            } catch (error) {
                console.error('‚ùå Fehler:', error);
                alert('Fehler beim Senden der Anfrage: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'üì§ Anfrage senden';
            }
        });
    </script>
</body>
</html>
