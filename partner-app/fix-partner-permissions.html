<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Partner-Berechtigungen Reparieren</title>

    <!-- Design System -->
    <link rel="stylesheet" href="../design-system.css">
    <link rel="stylesheet" href="../components.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <!-- Firebase Config -->
    <script src="../firebase-config.js"></script>

    <style>
        body {
            background: var(--color-background);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-body);
            padding: var(--space-4);
        }

        .fix-container {
            max-width: 700px;
            width: 100%;
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: var(--space-8);
            box-shadow: var(--shadow-lg);
        }

        h1 {
            font-size: var(--text-3xl);
            color: var(--color-primary);
            margin-bottom: var(--space-4);
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .warning-box {
            background: rgba(255, 165, 0, 0.1);
            border-left: 4px solid orange;
            padding: var(--space-4);
            margin-bottom: var(--space-6);
            border-radius: var(--radius-md);
        }

        .info-box {
            background: rgba(33, 150, 243, 0.1);
            border-left: 4px solid var(--color-primary);
            padding: var(--space-4);
            margin-bottom: var(--space-6);
            border-radius: var(--radius-md);
        }

        .success-box {
            background: rgba(76, 175, 80, 0.1);
            border-left: 4px solid var(--color-success);
            padding: var(--space-4);
            margin-bottom: var(--space-6);
            border-radius: var(--radius-md);
        }

        .error-box {
            background: rgba(220, 53, 69, 0.1);
            border-left: 4px solid var(--color-error);
            padding: var(--space-4);
            margin-bottom: var(--space-6);
            border-radius: var(--radius-md);
        }

        .btn {
            display: inline-block;
            padding: var(--space-3) var(--space-6);
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: var(--text-base);
        }

        .btn:hover {
            background: var(--color-primary-dark);
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: var(--color-border);
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--color-text-secondary);
        }

        .btn-secondary:hover {
            background: var(--color-text-primary);
        }

        .status-log {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: var(--space-4);
            border-radius: var(--radius-md);
            font-family: 'Courier New', monospace;
            font-size: var(--text-sm);
            max-height: 400px;
            overflow-y: auto;
            margin-top: var(--space-4);
        }

        .status-log div {
            margin-bottom: var(--space-1);
        }

        .log-success { color: #4ec9b0; }
        .log-error { color: #f48771; }
        .log-warning { color: #dcdcaa; }
        .log-info { color: #9cdcfe; }

        .checklist {
            list-style: none;
            padding: 0;
        }

        .checklist li {
            padding: var(--space-2) 0;
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .checklist li::before {
            content: '‚òê';
            font-size: var(--text-xl);
            color: var(--color-text-secondary);
        }

        .checklist li.checked::before {
            content: '‚úÖ';
        }

        .checklist li.failed::before {
            content: '‚ùå';
        }
    </style>
</head>
<body>
    <div class="fix-container">
        <h1>üîß Partner-Berechtigungen Reparieren</h1>

        <div class="warning-box">
            <strong>‚ö†Ô∏è Achtung:</strong> Dieses Tool repariert fehlende Partner-Daten und Berechtigungen.
            Verwenden Sie es nur, wenn Sie "Missing or insufficient permissions" Fehler erhalten.
        </div>

        <div class="info-box">
            <p><strong>Was macht dieses Tool?</strong></p>
            <ol>
                <li>Pr√ºft Ihre Firebase Auth Custom Claims</li>
                <li>Pr√ºft Ihr Firestore Partner-Dokument</li>
                <li>Erstellt fehlende Daten automatisch</li>
                <li>Aktualisiert Ihre Berechtigungen</li>
            </ol>
        </div>

        <div id="currentUser" class="info-box" style="display: none;">
            <p><strong>Eingeloggt als:</strong> <span id="userEmail"></span></p>
            <p><strong>Partner-ID:</strong> <span id="userPartnerId"></span></p>
        </div>

        <div id="checklist" class="info-box" style="display: none;">
            <p><strong>Status-Pr√ºfung:</strong></p>
            <ul class="checklist">
                <li id="check-auth">Firebase Auth User</li>
                <li id="check-claims">Custom Claims gesetzt</li>
                <li id="check-users">Firestore users Dokument</li>
                <li id="check-partner">Firestore partners_mosbach Dokument</li>
            </ul>
        </div>

        <div style="display: flex; gap: var(--space-3); margin-top: var(--space-6);">
            <button id="btnDiagnose" class="btn" onclick="diagnosePartnerData()">
                üîç Diagnose starten
            </button>
            <button id="btnFix" class="btn" onclick="fixPartnerData()" disabled>
                üîß Daten reparieren
            </button>
            <a href="meine-anfragen.html" class="btn btn-secondary">
                ‚Üê Zur√ºck zum Portal
            </a>
        </div>

        <div id="statusLog" class="status-log" style="display: none;"></div>

        <div id="successMessage" class="success-box" style="display: none;">
            <p><strong>‚úÖ Erfolgreich repariert!</strong></p>
            <p>Ihre Partner-Daten wurden erfolgreich angelegt. Bitte:</p>
            <ol>
                <li>Loggen Sie sich aus</li>
                <li>Loggen Sie sich erneut ein</li>
                <li>√ñffnen Sie das Partner-Portal</li>
            </ol>
            <button class="btn" onclick="window.location.reload()">
                üîÑ Seite neu laden
            </button>
        </div>
    </div>

    <script>
        let partner = null;
        let diagnosisResult = null;

        // Wait for Firebase initialization
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üîß Partner Permission Fix Tool loaded');

            // Wait for Firebase
            let attempts = 0;
            const waitForFirebase = setInterval(async () => {
                attempts++;
                if (window.firebaseInitialized && firebase.auth) {
                    clearInterval(waitForFirebase);
                    console.log('‚úÖ Firebase initialized');

                    // Check if user is logged in
                    firebase.auth().onAuthStateChanged((user) => {
                        if (user) {
                            document.getElementById('currentUser').style.display = 'block';
                            document.getElementById('userEmail').textContent = user.email;
                            document.getElementById('userPartnerId').textContent = user.email.split('@')[0];

                            partner = {
                                email: user.email,
                                partnerId: user.email.split('@')[0],
                                uid: user.uid
                            };
                        } else {
                            logStatus('error', 'Nicht eingeloggt. Bitte loggen Sie sich zuerst ein.');
                            document.getElementById('btnDiagnose').disabled = true;
                        }
                    });
                }

                if (attempts >= 20) {
                    clearInterval(waitForFirebase);
                    logStatus('error', 'Firebase Initialisierung Timeout');
                }
            }, 250);
        });

        function logStatus(type, message) {
            const log = document.getElementById('statusLog');
            log.style.display = 'block';
            const div = document.createElement('div');
            div.className = `log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            div.textContent = `[${timestamp}] ${message}`;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
        }

        async function diagnosePartnerData() {
            document.getElementById('btnDiagnose').disabled = true;
            document.getElementById('statusLog').innerHTML = '';
            document.getElementById('checklist').style.display = 'block';

            logStatus('info', 'üîç Starte Diagnose...');

            try {
                const user = firebase.auth().currentUser;
                if (!user) {
                    logStatus('error', '‚ùå Nicht eingeloggt');
                    return;
                }

                diagnosisResult = {
                    auth: true,
                    claims: false,
                    users: false,
                    partner: false
                };

                // Check 1: Auth (always true if we're here)
                document.getElementById('check-auth').classList.add('checked');
                logStatus('success', '‚úÖ Firebase Auth User existiert');

                // Check 2: Custom Claims
                const idTokenResult = await user.getIdTokenResult(true);
                const claims = idTokenResult.claims;
                logStatus('info', `Custom Claims: ${JSON.stringify(claims)}`);

                if (claims.role === 'partner' && claims.partnerId) {
                    document.getElementById('check-claims').classList.add('checked');
                    logStatus('success', '‚úÖ Custom Claims korrekt gesetzt');
                    diagnosisResult.claims = true;
                } else {
                    document.getElementById('check-claims').classList.add('failed');
                    logStatus('warning', '‚ö†Ô∏è Custom Claims fehlen oder inkorrekt');
                }

                // Check 3: Firestore users doc
                try {
                    const userDoc = await firebase.firestore().collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        logStatus('info', `Firestore users: ${JSON.stringify(userData)}`);

                        if (userData.status === 'active' && userData.role === 'partner') {
                            document.getElementById('check-users').classList.add('checked');
                            logStatus('success', '‚úÖ Firestore users Dokument korrekt');
                            diagnosisResult.users = true;
                        } else {
                            document.getElementById('check-users').classList.add('failed');
                            logStatus('warning', `‚ö†Ô∏è Status: ${userData.status}, Role: ${userData.role}`);
                        }
                    } else {
                        document.getElementById('check-users').classList.add('failed');
                        logStatus('error', '‚ùå Firestore users Dokument fehlt');
                    }
                } catch (error) {
                    document.getElementById('check-users').classList.add('failed');
                    logStatus('error', `‚ùå Fehler beim Laden von users: ${error.message}`);
                }

                // Check 4: Firestore partners_mosbach doc
                try {
                    const partnerId = user.email.split('@')[0];
                    const partnerDoc = await firebase.firestore().collection('partners_mosbach').doc(partnerId).get();

                    if (partnerDoc.exists) {
                        const partnerData = partnerDoc.data();
                        logStatus('info', `Firestore partners_mosbach: ${JSON.stringify(partnerData)}`);
                        document.getElementById('check-partner').classList.add('checked');
                        logStatus('success', '‚úÖ Firestore partners_mosbach Dokument existiert');
                        diagnosisResult.partner = true;
                    } else {
                        document.getElementById('check-partner').classList.add('failed');
                        logStatus('error', '‚ùå Firestore partners_mosbach Dokument fehlt');
                    }
                } catch (error) {
                    document.getElementById('check-partner').classList.add('failed');
                    logStatus('error', `‚ùå Fehler beim Laden von partners_mosbach: ${error.message}`);
                }

                // Enable fix button if issues found
                const needsFix = !diagnosisResult.claims || !diagnosisResult.users || !diagnosisResult.partner;
                if (needsFix) {
                    document.getElementById('btnFix').disabled = false;
                    logStatus('warning', '‚ö†Ô∏è Probleme gefunden - Klicken Sie "Daten reparieren"');
                } else {
                    logStatus('success', '‚úÖ Alle Daten sind korrekt - kein Fix n√∂tig!');
                }

            } catch (error) {
                logStatus('error', `‚ùå Diagnose-Fehler: ${error.message}`);
            } finally {
                document.getElementById('btnDiagnose').disabled = false;
            }
        }

        async function fixPartnerData() {
            document.getElementById('btnFix').disabled = true;
            logStatus('info', 'üîß Starte Reparatur...');

            try {
                const user = firebase.auth().currentUser;
                if (!user) {
                    logStatus('error', '‚ùå Nicht eingeloggt');
                    return;
                }

                // Call ensurePartnerAccount Cloud Function
                logStatus('info', 'Rufe ensurePartnerAccount Cloud Function auf...');

                // üîß FIX: Use firebase.functions() instead of window.functions
                const functions = firebase.functions('europe-west3');
                const ensureFn = functions.httpsCallable('ensurePartnerAccount');
                const result = await ensureFn({
                    email: user.email,
                    kundenname: user.displayName || user.email.split('@')[0],
                    werkstattId: 'mosbach'
                });

                logStatus('success', `‚úÖ Cloud Function erfolgreich: ${result.data.message}`);
                logStatus('info', JSON.stringify(result.data));

                // Refresh token to get new claims
                logStatus('info', 'Aktualisiere Auth Token...');
                await user.getIdToken(true);
                logStatus('success', '‚úÖ Auth Token aktualisiert');

                // Show success message
                document.getElementById('successMessage').style.display = 'block';
                logStatus('success', 'üéâ Reparatur abgeschlossen!');

            } catch (error) {
                logStatus('error', `‚ùå Reparatur-Fehler: ${error.message}`);
                logStatus('error', error.stack);
            } finally {
                document.getElementById('btnFix').disabled = false;
            }
        }
    </script>
</body>
</html>
