<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto-Login | Partner-Portal</title>

    <!-- Design System -->
    <link rel="stylesheet" href="../design-system.css">
    <link rel="stylesheet" href="../components.css">
    <link rel="stylesheet" href="../animations.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

    <!-- Firebase Config -->
    <script src="../firebase-config.js"></script>

    <style>
        body {
            background: var(--color-background);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-body);
            padding: var(--space-4);
        }

        .auto-login-container {
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        .logo {
            width: 80px;
            height: 80px;
            margin: 0 auto var(--space-6);
            background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }

        .status-card {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: var(--space-8);
            box-shadow: var(--shadow-lg);
        }

        .status-icon {
            font-size: 48px;
            margin-bottom: var(--space-4);
        }

        .status-title {
            font-size: var(--text-2xl);
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: var(--space-2);
        }

        .status-message {
            font-size: var(--text-base);
            color: var(--color-text-secondary);
            margin-bottom: var(--space-6);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--color-border);
            border-top-color: var(--color-primary);
            border-radius: var(--radius-full);
            animation: spin 1s linear infinite;
            margin: 0 auto var(--space-4);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-card {
            background: rgba(220, 53, 69, 0.1);
            border: 2px solid rgba(220, 53, 69, 0.3);
        }

        .error-card .status-title {
            color: var(--color-error);
        }

        .success-card {
            background: rgba(76, 175, 80, 0.1);
            border: 2px solid rgba(76, 175, 80, 0.3);
        }

        .success-card .status-title {
            color: var(--color-success);
        }

        .btn {
            display: inline-block;
            padding: var(--space-3) var(--space-6);
            background: var(--color-primary);
            color: white;
            border-radius: var(--radius-md);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--color-primary-dark);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="auto-login-container">
        <div class="logo">üöó</div>

        <!-- LOADING STATE -->
        <div id="loading" class="status-card">
            <div class="spinner"></div>
            <div class="status-icon">üîê</div>
            <div class="status-title">Authentifizierung l√§uft...</div>
            <div class="status-message">Einen Moment bitte, wir melden Sie automatisch an.</div>
        </div>

        <!-- ERROR STATE -->
        <div id="error" class="status-card error-card" style="display:none;">
            <div class="status-icon">‚ö†Ô∏è</div>
            <div class="status-title">Anmeldung fehlgeschlagen</div>
            <div class="status-message" id="error-message"></div>
            <a href="./index.html" class="btn">Zum Partner-Portal</a>
        </div>

        <!-- SUCCESS STATE -->
        <div id="success" class="status-card success-card" style="display:none;">
            <div class="status-icon">‚úÖ</div>
            <div class="status-title">Anmeldung erfolgreich!</div>
            <div class="status-message">Sie werden weitergeleitet...</div>
        </div>
    </div>

    <script>
        // ============================================
        // AUTO-LOGIN LOGIC
        // ============================================

        console.log('üîê Auto-Login Page geladen');

        // Parse token from URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        console.log('Token aus URL:', token ? 'Vorhanden' : 'Fehlt');

        if (!token || token.length !== 32) {
            // Ung√ºltiger Token
            showError('Ung√ºltiger QR-Code oder fehlender Token. Bitte scannen Sie den QR-Code erneut.');
            console.error('‚ùå Ung√ºltiger Token-Format');
        } else {
            // Warte auf Firebase Initialisierung
            console.log('‚è≥ Warte auf Firebase Initialisierung...');

            let initCheckAttempts = 0;
            const initCheckInterval = setInterval(async () => {
                initCheckAttempts++;

                if (window.firebaseInitialized && firebase) {
                    clearInterval(initCheckInterval);
                    console.log('‚úÖ Firebase initialisiert, starte Auto-Login...');

                    try {
                        // STEP 1: Validate Token via Cloud Function
                        console.log('üì° Calling validatePartnerAutoLoginToken...');
                        // ‚úÖ FIX: Use window.functions (europe-west3) instead of firebase.functions() (us-central1)
                        const validateTokenFn = window.functions.httpsCallable('validatePartnerAutoLoginToken');
                        const result = await validateTokenFn({ token: token });

                        console.log('‚úÖ Token validiert:', result.data.message);
                        console.log('   ‚Üí Partner ID:', result.data.partnerId);
                        console.log('   ‚Üí Werkstatt ID:', result.data.werkstattId);

                        // STEP 2: Sign in with custom token
                        console.log('üîë Signing in with custom token...');
                        const userCredential = await firebase.auth().signInWithCustomToken(result.data.customToken);

                        console.log('‚úÖ Erfolgreich angemeldet als:', userCredential.user.uid);

                        // STEP 3: Store werkstattId in localStorage
                        localStorage.setItem('partner', JSON.stringify({
                            partnerId: result.data.partnerId,
                            werkstattId: result.data.werkstattId,
                            email: result.data.email
                        }));
                        console.log('üíæ Partner-Daten in localStorage gespeichert');

                        // STEP 4: Show success and redirect
                        showSuccess();

                        setTimeout(() => {
                            // Redirect to Meine Anfragen page (if fahrzeugId available) or Dashboard
                            if (result.data.fahrzeugId) {
                                console.log('üöó Redirect zu Fahrzeug:', result.data.fahrzeugId);
                                window.location.href = './meine-anfragen.html';
                            } else {
                                console.log('üìä Redirect zu Dashboard');
                                window.location.href = './index.html';
                            }
                        }, 1500);

                    } catch (error) {
                        console.error('‚ùå Auto-Login fehlgeschlagen:', error);

                        // Spezifische Fehlermeldungen
                        let errorMessage = 'Ein unbekannter Fehler ist aufgetreten.';

                        if (error.code === 'functions/deadline-exceeded') {
                            errorMessage = 'QR-Code ist abgelaufen (30 Tage). Bitte fordern Sie einen neuen QR-Code an.';
                        } else if (error.code === 'functions/not-found') {
                            errorMessage = 'QR-Code ist ung√ºltig oder wurde bereits verwendet.';
                        } else if (error.code === 'functions/resource-exhausted') {
                            errorMessage = 'QR-Code wurde zu oft verwendet.';
                        } else if (error.message) {
                            errorMessage = error.message;
                        }

                        showError(errorMessage);
                    }
                }

                // Timeout after 20 attempts (5 seconds)
                if (initCheckAttempts >= 20) {
                    clearInterval(initCheckInterval);
                    showError('Firebase konnte nicht initialisiert werden. Bitte √ºberpr√ºfen Sie Ihre Internetverbindung.');
                    console.error('‚ùå Firebase Initialisierung Timeout');
                }
            }, 250);
        }

        // ============================================
        // UI HELPER FUNCTIONS
        // ============================================

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('success').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error-message').textContent = message;
        }

        function showSuccess() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('success').style.display = 'block';
        }
    </script>
</body>
</html>
