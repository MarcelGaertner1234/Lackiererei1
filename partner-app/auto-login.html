<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auto-Login | Partner-Portal</title>

    <!-- Design System -->
    <link rel="stylesheet" href="../design-system.css">
    <link rel="stylesheet" href="../components.css">
    <link rel="stylesheet" href="../animations.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

    <!-- Firebase Config -->
    <script src="../firebase-config.js"></script>
    <script src="../js/settings-manager.js"></script>

    <style>
        body {
            background: var(--color-background);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: var(--font-body);
            padding: var(--space-4);
        }

        .auto-login-container {
            max-width: 500px;
            width: 100%;
            text-align: center;
        }

        .logo {
            width: 80px;
            height: 80px;
            margin: 0 auto var(--space-6);
            background: linear-gradient(135deg, var(--color-primary), var(--color-accent));
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }

        .status-card {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: var(--space-8);
            box-shadow: var(--shadow-lg);
        }

        .status-icon {
            font-size: 48px;
            margin-bottom: var(--space-4);
        }

        .status-title {
            font-size: var(--text-2xl);
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: var(--space-2);
        }

        .status-message {
            font-size: var(--text-base);
            color: var(--color-text-secondary);
            margin-bottom: var(--space-6);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--color-border);
            border-top-color: var(--color-primary);
            border-radius: var(--radius-full);
            animation: spin 1s linear infinite;
            margin: 0 auto var(--space-4);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-card {
            background: rgba(220, 53, 69, 0.1);
            border: 2px solid rgba(220, 53, 69, 0.3);
        }

        .error-card .status-title {
            color: var(--color-error);
        }

        .success-card {
            background: rgba(76, 175, 80, 0.1);
            border: 2px solid rgba(76, 175, 80, 0.3);
        }

        .success-card .status-title {
            color: var(--color-success);
        }

        .btn {
            display: inline-block;
            padding: var(--space-3) var(--space-6);
            background: var(--color-primary);
            color: white;
            border-radius: var(--radius-md);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn:hover {
            background: var(--color-primary-dark);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="auto-login-container">
        <div class="logo" id="werkstattLogo">üöó</div>

        <!-- LOADING STATE -->
        <div id="loading" class="status-card">
            <div class="spinner"></div>
            <div class="status-icon">üîê</div>
            <div class="status-title">Authentifizierung l√§uft...</div>
            <div class="status-message">Einen Moment bitte, wir melden Sie automatisch an.</div>
        </div>

        <!-- ERROR STATE -->
        <div id="error" class="status-card error-card" style="display:none;">
            <div class="status-icon">‚ö†Ô∏è</div>
            <div class="status-title">Anmeldung fehlgeschlagen</div>
            <div class="status-message" id="error-message"></div>
            <a href="./index.html" class="btn">Zum Partner-Portal</a>
        </div>

        <!-- SUCCESS STATE -->
        <div id="success" class="status-card success-card" style="display:none;">
            <div class="status-icon">‚úÖ</div>
            <div class="status-title">Anmeldung erfolgreich!</div>
            <div class="status-message">Sie werden weitergeleitet...</div>
        </div>
    </div>

    <script>
        // ============================================
        // AUTO-LOGIN LOGIC
        // ============================================

        // Load Werkstatt-Logo & Branding
        (async () => {
            try {
                const settings = await window.settingsManager.loadSettings();
                if (settings?.profil) {
                    // Update Page Title
                    document.title = `${settings.profil.name} | Auto-Login`;

                    // Display Logo
                    if (settings.profil.logoUrl) {
                        const logoContainer = document.getElementById('werkstattLogo');
                        if (logoContainer) {
                            logoContainer.innerHTML = `
                                <img src="${settings.profil.logoUrl}"
                                     alt="${settings.profil.name}"
                                     style="width: 80px; height: 80px; object-fit: contain; border-radius: 50%;">
                            `;
                            console.log('‚úÖ [PARTNER-AUTO-LOGIN] Werkstatt-Logo angezeigt:', settings.profil.name);
                        }
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è [PARTNER-AUTO-LOGIN] Werkstatt-Branding konnte nicht geladen werden:', error);
            }
        })();

        console.log('üîê Auto-Login Page geladen');

        // Parse token from URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        console.log('Token aus URL:', token ? 'Vorhanden' : 'Fehlt');

        if (!token || token.length !== 32) {
            // Ung√ºltiger Token
            showError('Ung√ºltiger QR-Code oder fehlender Token. Bitte scannen Sie den QR-Code erneut.');
            console.error('‚ùå Ung√ºltiger Token-Format');
        } else {
            // Warte auf Firebase Initialisierung
            console.log('‚è≥ Warte auf Firebase Initialisierung...');

            let initCheckAttempts = 0;
            const initCheckInterval = setInterval(async () => {
                initCheckAttempts++;

                if (window.firebaseInitialized && firebase) {
                    clearInterval(initCheckInterval);
                    console.log('‚úÖ Firebase initialisiert, starte Auto-Login...');

                    try {
                        // STEP 1: Validate Token via Cloud Function
                        console.log('üì° Calling validatePartnerAutoLoginToken...');
                        // ‚úÖ FIX: Use window.functions (europe-west3) instead of firebase.functions() (us-central1)
                        const validateTokenFn = window.functions.httpsCallable('validatePartnerAutoLoginToken');
                        const result = await validateTokenFn({ token: token });

                        console.log('‚úÖ Token validiert:', result.data.message);
                        console.log('   ‚Üí Partner ID:', result.data.partnerId);
                        console.log('   ‚Üí Werkstatt ID:', result.data.werkstattId);

                        // STEP 2: Sign in with custom token
                        console.log('üîë Signing in with custom token...');
                        const userCredential = await firebase.auth().signInWithCustomToken(result.data.customToken);

                        console.log('‚úÖ Erfolgreich angemeldet als:', userCredential.user.uid);

                        // STEP 3: Store werkstattId in localStorage
                        localStorage.setItem('partner', JSON.stringify({
                            id: result.data.partnerId, // ‚úÖ Add id field for consistency with normal login
                            partnerId: result.data.partnerId,
                            werkstattId: result.data.werkstattId,
                            email: result.data.email
                        }));
                        console.log('üíæ Partner-Daten in localStorage gespeichert');

                        // Set window.werkstattId (for immediate availability)
                        window.werkstattId = result.data.werkstattId;
                        console.log('‚úÖ [AUTO-LOGIN] window.werkstattId gesetzt:', window.werkstattId);

                        // üÜï BUGFIX 2025-11-04 (FIX #20B): Check if password change required
                        console.log('üö® [DEBUG] ABOUT TO CHECK PASSWORD CHANGE REQUIREMENT');
                        console.log('üö® [DEBUG] result.data.partnerId:', result.data.partnerId);
                        console.log('üö® [DEBUG] firebase.firestore available:', typeof firebase.firestore);

                        try {
                            console.log('üîç Pr√ºfe ob Passwort-Reset erforderlich...');

                            // ‚úÖ FIX: Use GLOBAL collection (no werkstattId dependency)
                            // Avoids race condition with window.getCollection()
                            const db = firebase.firestore();
                            const partnerDoc = await db.collection('partner').doc(result.data.partnerId).get();

                            console.log('üîç [DEBUG] partnerDoc.exists:', partnerDoc.exists);
                            if (partnerDoc.exists) {
                                console.log('üîç [DEBUG] partnerDoc.data():', partnerDoc.data());
                            }

                            if (partnerDoc.exists && partnerDoc.data().requiresPasswordChange) {
                                console.log('‚ö†Ô∏è Partner muss Passwort √§ndern - zeige Modal');
                                showSuccess(); // Show success briefly

                                setTimeout(() => {
                                    document.getElementById('success').style.display = 'none';
                                    showForcePasswordChangeModal(result.data.email, result.data.partnerId);
                                }, 1000);
                                return; // STOP - no redirect!
                            }
                            console.log('‚úÖ Kein Passwort-Reset erforderlich - fahre fort mit Redirect');
                        } catch (error) {
                            console.error('‚ö†Ô∏è Fehler beim Password-Check:', error);
                            // Continue with redirect if check fails (don't block login)
                        }

                        // STEP 4: Show success and redirect (only if no password reset needed)
                        showSuccess();

                        setTimeout(() => {
                            // Redirect to Meine Anfragen page (if fahrzeugId available) or Dashboard
                            if (result.data.fahrzeugId) {
                                console.log('üöó Redirect zu Fahrzeug:', result.data.fahrzeugId);
                                window.location.href = './meine-anfragen.html';
                            } else {
                                console.log('üìä Redirect zu Dashboard');
                                window.location.href = './index.html';
                            }
                        }, 1500);

                    } catch (error) {
                        console.error('‚ùå Auto-Login fehlgeschlagen:', error);

                        // Spezifische Fehlermeldungen
                        let errorMessage = 'Ein unbekannter Fehler ist aufgetreten.';

                        if (error.code === 'functions/deadline-exceeded') {
                            errorMessage = 'QR-Code ist abgelaufen (30 Tage). Bitte fordern Sie einen neuen QR-Code an.';
                        } else if (error.code === 'functions/not-found') {
                            errorMessage = 'QR-Code ist ung√ºltig oder wurde bereits verwendet.';
                        } else if (error.code === 'functions/resource-exhausted') {
                            errorMessage = 'QR-Code wurde zu oft verwendet.';
                        } else if (error.message) {
                            errorMessage = error.message;
                        }

                        showError(errorMessage);
                    }
                }

                // Timeout after 20 attempts (5 seconds)
                if (initCheckAttempts >= 20) {
                    clearInterval(initCheckInterval);
                    showError('Firebase konnte nicht initialisiert werden. Bitte √ºberpr√ºfen Sie Ihre Internetverbindung.');
                    console.error('‚ùå Firebase Initialisierung Timeout');
                }
            }, 250);
        }

        // ============================================
        // UI HELPER FUNCTIONS
        // ============================================

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('success').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error-message').textContent = message;
        }

        function showSuccess() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('success').style.display = 'block';
        }

        /**
         * üÜï BUGFIX 2025-11-04: Zeigt das Force Password Change Modal an
         * @param {string} email - Partner email
         * @param {string} partnerId - Partner ID
         */
        function showForcePasswordChangeModal(email, partnerId) {
            console.log('üîê Zeige Force Password Change Modal f√ºr:', email);

            const modal = document.getElementById('forcePasswordChangeModal');
            modal.style.display = 'flex';

            // Form Submit Handler
            const form = document.getElementById('changePasswordForm');
            form.onsubmit = async (e) => {
                e.preventDefault();

                const currentPw = document.getElementById('currentPassword').value;
                const newPw = document.getElementById('newPassword').value;
                const confirmPw = document.getElementById('confirmPassword').value;
                const submitBtn = document.getElementById('pwChangeSubmitBtn');
                const errorDiv = document.getElementById('pwChangeError');
                const errorText = document.getElementById('pwChangeErrorText');

                // Validierung
                if (newPw !== confirmPw) {
                    errorText.textContent = 'Die Passw√∂rter stimmen nicht √ºberein!';
                    errorDiv.style.display = 'block';
                    return;
                }

                if (newPw.length < 8) {
                    errorText.textContent = 'Das Passwort muss mindestens 8 Zeichen lang sein!';
                    errorDiv.style.display = 'block';
                    return;
                }

                // Button deaktivieren
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span style="display: inline-block; animation: spin 1s linear infinite;">‚è≥</span> Passwort wird ge√§ndert...';
                errorDiv.style.display = 'none';

                // ‚úÖ FIX: Define db reference for global collection access
                const db = firebase.firestore();

                try {
                    // Re-authenticate mit aktuellem Passwort
                    const user = firebase.auth().currentUser;
                    if (!user) {
                        throw new Error('Kein Benutzer eingeloggt');
                    }

                    const credential = firebase.auth.EmailAuthProvider.credential(email, currentPw);
                    await user.reauthenticateWithCredential(credential);
                    console.log('‚úÖ Re-Authentifizierung erfolgreich');

                    // Passwort aktualisieren
                    await user.updatePassword(newPw);
                    console.log('‚úÖ Passwort in Firebase Auth aktualisiert');

                    // Firestore aktualisieren - BEIDE Collections (multi-tenant + global)
                    const updateData = {
                        requiresPasswordChange: false,
                        passwordChangedAt: new Date().toISOString(),
                        initialPassword: firebase.firestore.FieldValue.delete() // Initial-Passwort l√∂schen!
                    };

                    await Promise.all([
                        // Multi-tenant collection (z.B. partners_{werkstattId})
                        window.getCollection('partners').doc(partnerId).update(updateData),
                        // Globale collection (partner)
                        db.collection('partner').doc(partnerId).update(updateData)
                    ]);
                    console.log('‚úÖ Firestore aktualisiert - requiresPasswordChange = false (beide Collections)');

                    // Success
                    alert('‚úÖ Passwort erfolgreich ge√§ndert! Sie werden zum Dashboard weitergeleitet.');
                    modal.style.display = 'none';
                    window.location.href = './meine-anfragen.html';

                } catch (error) {
                    console.error('‚ùå Fehler beim Passwort √§ndern:', error);

                    let errorMessage = 'Fehler beim √Ñndern des Passworts.';
                    if (error.code === 'auth/wrong-password') {
                        errorMessage = 'Das aktuelle Passwort ist falsch!';
                    } else if (error.code === 'auth/weak-password') {
                        errorMessage = 'Das neue Passwort ist zu schwach!';
                    } else if (error.code === 'auth/requires-recent-login') {
                        errorMessage = 'Bitte loggen Sie sich erneut ein und versuchen Sie es nochmal.';
                    } else {
                        errorMessage = error.message || errorMessage;
                    }

                    errorText.textContent = errorMessage;
                    errorDiv.style.display = 'block';

                    // Button wieder aktivieren
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Passwort √§ndern';
                }
            };
        }
    </script>

    <!-- üÜï BUGFIX 2025-11-04: Force Password Change Modal -->
    <div id="forcePasswordChangeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 12px; max-width: 500px; width: 90%; padding: 0; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); animation: modalFadeIn 0.3s ease;">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0;">
                <h2 style="margin: 0; font-size: 22px; font-weight: 600;">üîê Passwort √§ndern erforderlich</h2>
                <p style="margin: 10px 0 0 0; font-size: 14px; opacity: 0.95;">Aus Sicherheitsgr√ºnden m√ºssen Sie Ihr Initial-Passwort √§ndern.</p>
            </div>

            <!-- Content -->
            <div style="padding: 25px;">
                <form id="changePasswordForm">
                    <div style="margin-bottom: 18px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #333; font-size: 14px;">
                            Aktuelles Passwort
                        </label>
                        <input type="password" id="currentPassword" required
                               style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border 0.2s;"
                               onfocus="this.style.borderColor='#667eea'"
                               onblur="this.style.borderColor='#e0e0e0'">
                    </div>

                    <div style="margin-bottom: 18px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #333; font-size: 14px;">
                            Neues Passwort (mind. 8 Zeichen)
                        </label>
                        <input type="password" id="newPassword" minlength="8" required
                               style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border 0.2s;"
                               onfocus="this.style.borderColor='#667eea'"
                               onblur="this.style.borderColor='#e0e0e0'">
                        <small style="color: #666; font-size: 12px; margin-top: 4px; display: block;">
                            Mindestens 8 Zeichen, Gro√ü-/Kleinbuchstaben und Zahlen empfohlen
                        </small>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 6px; color: #333; font-size: 14px;">
                            Neues Passwort best√§tigen
                        </label>
                        <input type="password" id="confirmPassword" minlength="8" required
                               style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border 0.2s;"
                               onfocus="this.style.borderColor='#667eea'"
                               onblur="this.style.borderColor='#e0e0e0'">
                    </div>

                    <div id="pwChangeError" style="display: none; background: #fee; border-left: 4px solid #dc3545; padding: 12px; border-radius: 6px; margin-bottom: 16px;">
                        <p style="margin: 0; color: #721c24; font-size: 13px; font-weight: 500;" id="pwChangeErrorText"></p>
                    </div>

                    <button type="submit" id="pwChangeSubmitBtn"
                            style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 14px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;"
                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.4)'"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        Passwort √§ndern
                    </button>
                </form>
            </div>
        </div>
    </div>

    <style>
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>

</body>
</html>
