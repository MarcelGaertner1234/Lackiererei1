<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glas-Reparatur | Partner Portal</title>

    <!-- Shared Service-Form Styles -->
    <link rel="stylesheet" href="service-form-styles.css">
    <link rel="stylesheet" href="../mobile-responsive.css">

    <style>
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 15px; border-radius: 8px; }
            .header h1 { font-size: 18px; }
            .btn { padding: 8px 14px; font-size: 12px; }
        }

        /* Dark Mode Variables */
        :root {
            --bg-color: #f5f5f5;
            --surface-color: white;
            --text-primary: #003366;
            --text-secondary: #666;
            --border-color: #e0e0e0;
        }

        [data-theme="dark"] {
            --bg-color: #1a1a1d;
            --surface-color: #2a2a2d;
            --text-primary: rgba(255,255,255,0.9);
            --text-secondary: rgba(255,255,255,0.6);
            --border-color: rgba(255,255,255,0.18);
        }

        body { background: var(--bg-color) !important; }
        .container { background: var(--surface-color) !important; }
        .header h1 { color: var(--text-primary) !important; }

        .btn-theme-toggle {
            background: var(--surface-color);
            border: 2px solid var(--border-color);
            padding: 10px 12px;
            font-size: 18px;
            cursor: pointer;
            border-radius: 8px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>

<div class="wizard-sidebar">
    <button class="btn-theme-toggle" onclick="toggleTheme()">üåô</button>
    <div class="sidebar-title">Glas-Reparatur üîç</div>
    <div class="sidebar-step" data-step="1">
        <span class="step-number">1</span>
        <span class="step-label">Art der Reparatur</span>
    </div>
    <div class="sidebar-step" data-step="2">
        <span class="step-number">2</span>
        <span class="step-label">Betroffene Scheibe</span>
    </div>
    <div class="sidebar-step" data-step="3">
        <span class="step-number">3</span>
        <span class="step-label">Schadensgr√∂√üe</span>
    </div>
    <div class="sidebar-step" data-step="4">
        <span class="step-number">4</span>
        <span class="step-label">Fotos</span>
    </div>
    <div class="sidebar-step" data-step="5">
        <span class="step-number">5</span>
        <span class="step-label">Zusammenfassung</span>
    </div>
</div>

<div class="container">
    <div class="header">
        <h1>üîç Glas-Reparatur Anfrage</h1>
        <p>Steinschlag, Risse, Scheibenaustausch</p>
    </div>

    <div class="wizard-nav">
        <button class="btn btn-back" onclick="prevStep()" style="display: none;">‚Üê Zur√ºck</button>
        <button class="btn btn-secondary" onclick="window.location.href='service-auswahl.html';">Abbrechen</button>
    </div>

    <form id="glasAnfrageForm">

        <!-- STEP 1: Art der Reparatur -->
        <div class="wizard-step active" data-step="1">
            <div class="step-title">
                <span class="icon">üîç</span>
                Art der Reparatur
            </div>
            <div class="form-group">
                <label>Was muss repariert werden?</label>
                <div class="toggle-group">
                    <div class="radio-option" onclick="selectOption('art', 'steinschlag', this)">
                        <input type="radio" name="art" value="steinschlag" id="steinschlag" required>
                        <label for="steinschlag">
                            <div class="label">ü™® Steinschlag</div>
                            <div class="description">Kleine Besch√§digung (reparierbar ohne Austausch)</div>
                        </label>
                    </div>
                    <div class="radio-option" onclick="selectOption('art', 'riss', this)">
                        <input type="radio" name="art" value="riss" id="riss" required>
                        <label for="riss">
                            <div class="label">„Ä∞Ô∏è Riss</div>
                            <div class="description">L√§ngerer Riss in der Scheibe</div>
                        </label>
                    </div>
                    <div class="radio-option" onclick="selectOption('art', 'austausch', this)">
                        <input type="radio" name="art" value="austausch" id="austausch" required>
                        <label for="austausch">
                            <div class="label">üîÑ Scheibenaustausch</div>
                            <div class="description">Kompletter Austausch erforderlich</div>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- STEP 2: Betroffene Scheibe -->
        <div class="wizard-step" data-step="2">
            <div class="step-title">
                <span class="icon">üöó</span>
                Betroffene Scheibe
            </div>
            <div class="form-group">
                <label>Welche Scheibe ist betroffen?</label>
                <div class="toggle-group">
                    <div class="radio-option" onclick="selectOption('scheibe', 'windschutzscheibe', this)">
                        <input type="radio" name="scheibe" value="windschutzscheibe" id="windschutzscheibe" required>
                        <label for="windschutzscheibe">
                            <div class="label">Windschutzscheibe</div>
                        </label>
                    </div>
                    <div class="radio-option" onclick="selectOption('scheibe', 'seitenscheibe', this)">
                        <input type="radio" name="scheibe" value="seitenscheibe" id="seitenscheibe" required>
                        <label for="seitenscheibe">
                            <div class="label">Seitenscheibe</div>
                        </label>
                    </div>
                    <div class="radio-option" onclick="selectOption('scheibe', 'heckscheibe', this)">
                        <input type="radio" name="scheibe" value="heckscheibe" id="heckscheibe" required>
                        <label for="heckscheibe">
                            <div class="label">Heckscheibe</div>
                        </label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>Position (bei Seitenscheibe)</label>
                <select id="position" name="position">
                    <option value="">-- Ausw√§hlen --</option>
                    <option value="fahrer">Fahrert√ºr</option>
                    <option value="beifahrer">Beifahrert√ºr</option>
                    <option value="hinten_links">Hinten Links</option>
                    <option value="hinten_rechts">Hinten Rechts</option>
                </select>
            </div>

            <div class="form-group" id="anzahlGroup" style="display: none;">
                <label>Anzahl Scheiben (bei Austausch)</label>
                <input type="number" id="anzahl" name="anzahl" min="1" max="4" value="1">
            </div>
        </div>

        <!-- STEP 3: Schadensgr√∂√üe -->
        <div class="wizard-step" data-step="3">
            <div class="step-title">
                <span class="icon">üìè</span>
                Schadensgr√∂√üe
            </div>
            <div class="form-group" id="groesseGroup">
                <label>Wie gro√ü ist der Schaden?</label>
                <div class="toggle-group">
                    <div class="radio-option" onclick="selectOption('groesse', 'klein', this)">
                        <input type="radio" name="groesse" value="klein" id="klein">
                        <label for="klein">
                            <div class="label">Klein (< 2 cm)</div>
                            <div class="description">Gut reparierbar</div>
                        </label>
                    </div>
                    <div class="radio-option" onclick="selectOption('groesse', 'mittel', this)">
                        <input type="radio" name="groesse" value="mittel" id="mittel">
                        <label for="mittel">
                            <div class="label">Mittel (2-5 cm)</div>
                            <div class="description">Reparatur m√∂glich</div>
                        </label>
                    </div>
                    <div class="radio-option" onclick="selectOption('groesse', 'gross', this)">
                        <input type="radio" name="groesse" value="gross" id="gross">
                        <label for="gross">
                            <div class="label">Gro√ü (> 5 cm)</div>
                            <div class="description">Austausch empfohlen</div>
                        </label>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>Zus√§tzliche Informationen (optional)</label>
                <textarea id="info" name="info" rows="3" placeholder="z.B. Schaden im Sichtfeld, Sensoren betroffen, etc."></textarea>
            </div>
        </div>

        <!-- STEP 4: Fotos -->
        <div class="wizard-step" data-step="4">
            <div class="step-title">
                <span class="icon">üì∑</span>
                Fotos hochladen
            </div>
            <div class="form-group">
                <label>Fotos vom Glasschaden (max. 4 Fotos)</label>
                <div class="photo-upload" onclick="document.getElementById('schadenfotoInput').click()">
                    <div class="icon">üì∑</div>
                    <div class="text">Klicken Sie hier, um Fotos auszuw√§hlen</div>
                    <input type="file" id="schadenfotoInput" accept="image/*" multiple style="display: none;" onchange="handleSchadenfotoUpload(event)">
                </div>
                <div id="schadenfotoPreview" class="photo-preview"></div>
            </div>
        </div>

        <!-- STEP 5: Zusammenfassung -->
        <div class="wizard-step" data-step="5">
            <div class="step-title">
                <span class="icon">‚úÖ</span>
                Zusammenfassung & Absenden
            </div>

            <div class="summary-section">
                <h3>Glas-Reparatur Details</h3>
                <p><strong>Art:</strong> <span id="summaryArt">-</span></p>
                <p><strong>Scheibe:</strong> <span id="summaryScheibe">-</span></p>
                <p><strong>Gr√∂√üe:</strong> <span id="summaryGroesse">-</span></p>
            </div>

            <div class="summary-section">
                <h3>Ihre Daten</h3>
                <div class="form-group">
                    <label>Kennzeichen *</label>
                    <input type="text" id="kennzeichen" required placeholder="z.B. MOS-CG 123">
                </div>
                <div class="form-group">
                    <label>Ihr Name *</label>
                    <input type="text" id="name" required placeholder="z.B. Max Mustermann">
                </div>
                <div class="form-group">
                    <label>E-Mail *</label>
                    <input type="email" id="email" required placeholder="z.B. max@beispiel.de">
                </div>
                <div class="form-group">
                    <label>Telefon *</label>
                    <input type="tel" id="telefon" required placeholder="z.B. 0123 456789">
                </div>
            </div>

            <button type="submit" class="btn btn-primary btn-submit">Anfrage absenden</button>
        </div>

    </form>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
<script src="../firebase-config.js"></script>

<script>
// ============================================
// GLOBAL STATE
// ============================================
let currentStep = 1;
let schadenfotoDaten = [];
let formData = {};

// ============================================
// WIZARD NAVIGATION
// ============================================
function nextStep() {
    if (validateCurrentStep()) {
        if (currentStep < 5) {
            currentStep++;
            showStep(currentStep);
            saveFormData();
        }
    }
}

function prevStep() {
    if (currentStep > 1) {
        currentStep--;
        showStep(currentStep);
    }
}

function showStep(step) {
    // Hide all steps
    document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.sidebar-step').forEach(s => s.classList.remove('active'));

    // Show current step
    document.querySelector(`.wizard-step[data-step="${step}"]`).classList.add('active');
    document.querySelector(`.sidebar-step[data-step="${step}"]`).classList.add('active');

    // Show/hide back button
    document.querySelector('.btn-back').style.display = step > 1 ? 'inline-block' : 'none';

    // Update summary
    if (step === 5) {
        updateSummary();
    }

    // Conditional fields
    const art = document.querySelector('input[name="art"]:checked')?.value;
    if (step === 2) {
        document.getElementById('anzahlGroup').style.display = art === 'austausch' ? 'block' : 'none';
    }
    if (step === 3) {
        document.getElementById('groesseGroup').style.display = art !== 'austausch' ? 'block' : 'none';
    }
}

function validateCurrentStep() {
    const step = currentStep;

    if (step === 1) {
        const art = document.querySelector('input[name="art"]:checked');
        if (!art) {
            alert('Bitte w√§hlen Sie eine Art der Reparatur aus!');
            return false;
        }
    } else if (step === 2) {
        const scheibe = document.querySelector('input[name="scheibe"]:checked');
        if (!scheibe) {
            alert('Bitte w√§hlen Sie eine Scheibe aus!');
            return false;
        }
    }

    return true;
}

function selectOption(name, value, element) {
    // Radio-Button w√§hlen
    const radio = element.querySelector(`input[name="${name}"]`);
    radio.checked = true;

    // Andere Optionen deselektieren (visuell)
    element.parentElement.querySelectorAll('.radio-option').forEach(opt => {
        opt.classList.remove('selected');
    });
    element.classList.add('selected');

    // Auto-advance nach kurzer Verz√∂gerung
    setTimeout(() => nextStep(), 300);
}

function saveFormData() {
    const art = document.querySelector('input[name="art"]:checked')?.value;
    const scheibe = document.querySelector('input[name="scheibe"]:checked')?.value;
    const position = document.getElementById('position').value;
    const anzahl = document.getElementById('anzahl').value;
    const groesse = document.querySelector('input[name="groesse"]:checked')?.value;
    const info = document.getElementById('info').value;

    formData = {
        art: art || '',
        scheibe: scheibe || '',
        position: position || '',
        anzahl: parseInt(anzahl) || 1,
        groesse: groesse || '',
        info: info || ''
    };
}

function updateSummary() {
    const labels = {
        art: {
            steinschlag: 'Steinschlag',
            riss: 'Riss',
            austausch: 'Scheibenaustausch'
        },
        scheibe: {
            windschutzscheibe: 'Windschutzscheibe',
            seitenscheibe: 'Seitenscheibe',
            heckscheibe: 'Heckscheibe'
        },
        groesse: {
            klein: 'Klein (< 2 cm)',
            mittel: 'Mittel (2-5 cm)',
            gross: 'Gro√ü (> 5 cm)'
        }
    };

    document.getElementById('summaryArt').textContent = labels.art[formData.art] || '-';

    let scheibeText = labels.scheibe[formData.scheibe] || '-';
    if (formData.position) {
        scheibeText += ` (${formData.position})`;
    }
    if (formData.art === 'austausch') {
        scheibeText += ` (${formData.anzahl}x)`;
    }
    document.getElementById('summaryScheibe').textContent = scheibeText;

    document.getElementById('summaryGroesse').textContent = formData.art !== 'austausch' ? (labels.groesse[formData.groesse] || '-') : 'N/A (Austausch)';
}

// ============================================
// FOTO UPLOAD
// ============================================
function handleSchadenfotoUpload(event) {
    const files = Array.from(event.target.files);
    if (schadenfotoDaten.length + files.length > 4) {
        alert('Maximal 4 Fotos erlaubt!');
        return;
    }

    files.forEach(file => {
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                schadenfotoDaten.push(e.target.result);
                renderFotoPreview();
            };
            reader.readAsDataURL(file);
        }
    });
}

function renderFotoPreview() {
    const container = document.getElementById('schadenfotoPreview');
    container.innerHTML = schadenfotoDaten.map((data, index) => `
        <div class="photo-item">
            <img src="${data}" alt="Foto ${index + 1}">
            <button type="button" onclick="removeFoto(${index})">√ó</button>
        </div>
    `).join('');
}

function removeFoto(index) {
    schadenfotoDaten.splice(index, 1);
    renderFotoPreview();
}

// ============================================
// FORM SUBMIT
// ============================================
document.getElementById('glasAnfrageForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const partner = JSON.parse(localStorage.getItem('partner') || 'null');
    if (!partner) {
        alert('Partner nicht eingeloggt!');
        window.location.href = 'index.html';
        return;
    }

    saveFormData();

    const anfrageData = {
        id: 'req_' + Date.now(),
        partnerId: partner.id,
        partnerName: partner.email,
        serviceTyp: 'glas',
        serviceData: formData,
        kennzeichen: document.getElementById('kennzeichen').value,
        kundenName: document.getElementById('name').value,
        email: document.getElementById('email').value,
        telefon: document.getElementById('telefon').value,
        schadenfotos: schadenfotoDaten,
        status: 'neu',
        timestamp: new Date().toISOString()
    };

    try {
        await window.firebaseInitialized;
        const db = window.db;

        await db.collection('partnerAnfragen').doc(anfrageData.id).set(anfrageData);

        alert('Glas-Reparatur Anfrage wurde erfolgreich gesendet!');
        window.location.href = 'meine-anfragen.html';
    } catch (error) {
        console.error('Fehler beim Speichern:', error);
        alert('Fehler: ' + error.message);
    }
});

// ============================================
// DARK MODE
// ============================================
function toggleTheme() {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    document.querySelector('.btn-theme-toggle').textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
}

// Restore theme on load
const savedTheme = localStorage.getItem('theme') || 'light';
document.documentElement.setAttribute('data-theme', savedTheme);
document.querySelector('.btn-theme-toggle').textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
</script>

</body>
</html>
