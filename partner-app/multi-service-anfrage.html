<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Service Anfrage | Partner Portal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 40px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .header h1 {
            color: #003366;
            font-size: 26px;
            margin-bottom: 8px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .selected-services {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 30px;
        }

        .service-badge {
            background: #e3f2fd;
            color: #003366;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid #003366;
        }

        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .section-header h2 {
            color: #003366;
            font-size: 18px;
            margin: 0;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group label {
            font-size: 12px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .service-specific-section {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        .service-specific-section h3 {
            color: #003366;
            font-size: 15px;
            margin-bottom: 15px;
        }

        .photo-upload {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .photo-upload:hover {
            border-color: #003366;
            background: #f9f9f9;
        }

        .photo-upload input[type="file"] {
            display: none;
        }

        .photo-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .photo-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #d32f2f;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .button-group {
            display: flex;
            gap: 10px;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn-primary {
            background: #003366;
            color: white;
        }

        .btn-primary:hover {
            background: #002244;
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 20px; border-radius: 8px; }
            .header h1 { font-size: 20px; }
            .header p { font-size: 12px; }
            .form-row { grid-template-columns: 1fr; gap: 12px; }
            .form-section { padding: 15px; }
            .section-header h2 { font-size: 16px; }
            .form-group label { font-size: 11px; }
            .form-group input, .form-group select, .form-group textarea {
                padding: 8px;
                font-size: 12px;
            }
            .photo-upload { padding: 20px; }
            .btn { padding: 10px 18px; font-size: 12px; }
        }

        @media (max-width: 480px) {
            .container { padding: 15px; }
            .header h1 { font-size: 18px; }
            .selected-services { gap: 6px; }
            .service-badge { padding: 4px 8px; font-size: 10px; }
            .form-section { padding: 12px; }
            .section-header h2 { font-size: 14px; }
            .btn { padding: 8px 14px; font-size: 11px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Multi-Service Anfrage</h1>
            <p id="partnerName">Mehrere Services für ein Fahrzeug</p>
        </div>

        <div class="selected-services" id="selectedServicesBadges"></div>

        <form id="multiServiceForm">
            <!-- Gemeinsame Fahrzeuginformationen -->
            <div class="form-section">
                <div class="section-header">
                    <h2>Fahrzeug-Informationen</h2>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Kennzeichen *</label>
                        <input type="text" name="kennzeichen" required>
                    </div>
                    <div class="form-group">
                        <label>Marke / Modell</label>
                        <input type="text" name="modell" placeholder="z.B. VW Golf">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Fahrgestellnummer (FIN)</label>
                        <input type="text" name="fin" placeholder="17-stellige FIN">
                    </div>
                    <div class="form-group">
                        <label>Baujahr</label>
                        <input type="number" name="baujahr" min="1980" max="2025" placeholder="z.B. 2020">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Farbe</label>
                        <input type="text" name="farbe" placeholder="z.B. Silber Metallic">
                    </div>
                    <div class="form-group">
                        <label>KM-Stand</label>
                        <input type="number" name="kmStand" placeholder="z.B. 45000">
                    </div>
                </div>

                <div class="form-group">
                    <label>Kundenname</label>
                    <input type="text" name="kundenname" placeholder="Name des Endkunden">
                </div>

                <div class="form-group">
                    <label>Kontakt (Telefon / E-Mail)</label>
                    <input type="text" name="kontakt" placeholder="Telefon oder E-Mail">
                </div>
            </div>

            <!-- Dynamische Service-Sections -->
            <div id="serviceSections"></div>

            <!-- Allgemeine Hinweise -->
            <div class="form-section">
                <div class="section-header">
                    <h2>Allgemeine Hinweise</h2>
                </div>
                <div class="form-group">
                    <label>Zusätzliche Informationen / Anmerkungen</label>
                    <textarea name="hinweise" rows="4" placeholder="Weitere Hinweise für alle Services..."></textarea>
                </div>
            </div>

            <div class="button-group">
                <button type="button" class="btn btn-secondary" onclick="window.location.href='service-auswahl.html'">
                    Zurück
                </button>
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    Anfrage absenden
                </button>
            </div>
        </form>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <script src="../firebase-config.js"></script>
    <script>
        let partner = null;
        let db = null;
        let selectedServices = [];
        let uploadedPhotos = {};

        const serviceLabels = {
            'lackier': 'Lackier-Service',
            'reifen': 'Reifen-Service',
            'pflege': 'Fahrzeugpflege',
            'mechanik': 'Mechanik / Werkstatt',
            'tuev': 'TÜV / AU',
            'versicherung': 'Versicherungsschaden'
        };

        window.addEventListener('DOMContentLoaded', async () => {
            await initFirebase();
            checkLogin();
            loadSelectedServices();
            renderServiceSections();
        });

        function checkLogin() {
            partner = JSON.parse(localStorage.getItem('partner') || 'null');
            if (!partner) {
                alert('Bitte melden Sie sich zuerst an.');
                window.location.href = 'index.html';
                return;
            }
            document.getElementById('partnerName').textContent = `${partner.name} - Mehrere Services für ein Fahrzeug`;
        }

        function loadSelectedServices() {
            const servicesJson = sessionStorage.getItem('selectedServices');
            if (!servicesJson) {
                alert('Keine Services ausgewählt. Sie werden zur Service-Auswahl weitergeleitet.');
                window.location.href = 'service-auswahl.html';
                return;
            }
            selectedServices = JSON.parse(servicesJson);

            // Render service badges
            const badgesContainer = document.getElementById('selectedServicesBadges');
            badgesContainer.innerHTML = selectedServices.map(service =>
                `<div class="service-badge">${serviceLabels[service]}</div>`
            ).join('');
        }

        function renderServiceSections() {
            const container = document.getElementById('serviceSections');

            selectedServices.forEach(service => {
                const section = createServiceSection(service);
                container.appendChild(section);
            });
        }

        function createServiceSection(serviceType) {
            const section = document.createElement('div');
            section.className = 'form-section';
            section.setAttribute('data-service', serviceType);

            let specificFields = '';

            switch(serviceType) {
                case 'lackier':
                    specificFields = `
                        <div class="form-row">
                            <div class="form-group">
                                <label>Art des Schadens</label>
                                <select name="${serviceType}_schadensart">
                                    <option value="">Bitte wählen...</option>
                                    <option value="kratzer">Kratzer</option>
                                    <option value="delle">Delle</option>
                                    <option value="lackschaden">Lackschaden</option>
                                    <option value="unfallschaden">Unfallschaden</option>
                                    <option value="steinschlag">Steinschlag</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Betroffene Teile</label>
                                <input type="text" name="${serviceType}_teile" placeholder="z.B. Stoßstange vorne">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Schadensbeschreibung</label>
                            <textarea name="${serviceType}_beschreibung" rows="3" placeholder="Detaillierte Beschreibung des Lackschadens..."></textarea>
                        </div>
                    `;
                    break;

                case 'reifen':
                    specificFields = `
                        <div class="form-row">
                            <div class="form-group">
                                <label>Service-Art</label>
                                <select name="${serviceType}_art">
                                    <option value="">Bitte wählen...</option>
                                    <option value="wechsel">Reifenwechsel</option>
                                    <option value="montage">Montage neuer Reifen</option>
                                    <option value="einlagerung">Einlagerung</option>
                                    <option value="reparatur">Reparatur</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Reifengröße</label>
                                <input type="text" name="${serviceType}_groesse" placeholder="z.B. 205/55 R16">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Zusätzliche Informationen</label>
                            <textarea name="${serviceType}_info" rows="2" placeholder="Weitere Hinweise zum Reifen-Service..."></textarea>
                        </div>
                    `;
                    break;

                case 'pflege':
                    specificFields = `
                        <div class="form-row">
                            <div class="form-group">
                                <label>Gewünschte Leistung</label>
                                <select name="${serviceType}_leistung">
                                    <option value="">Bitte wählen...</option>
                                    <option value="aussenreinigung">Außenreinigung</option>
                                    <option value="innenreinigung">Innenreinigung</option>
                                    <option value="vollaufbereitung">Vollaufbereitung</option>
                                    <option value="polsterreinigung">Polsterreinigung</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Zustand</label>
                                <select name="${serviceType}_zustand">
                                    <option value="">Bitte wählen...</option>
                                    <option value="leicht_verschmutzt">Leicht verschmutzt</option>
                                    <option value="normal">Normal</option>
                                    <option value="stark_verschmutzt">Stark verschmutzt</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Besondere Anforderungen</label>
                            <textarea name="${serviceType}_anforderungen" rows="2" placeholder="z.B. Lederaufbereitung, Geruchsentfernung..."></textarea>
                        </div>
                    `;
                    break;

                case 'mechanik':
                    specificFields = `
                        <div class="form-row">
                            <div class="form-group">
                                <label>Art der Reparatur</label>
                                <select name="${serviceType}_reparaturart">
                                    <option value="">Bitte wählen...</option>
                                    <option value="inspektion">Inspektion</option>
                                    <option value="reparatur">Reparatur</option>
                                    <option value="diagnose">Diagnose</option>
                                    <option value="wartung">Wartung</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Symptome / Problem</label>
                                <input type="text" name="${serviceType}_symptome" placeholder="z.B. Motorgeräusch, Warnleuchte">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Detaillierte Beschreibung</label>
                            <textarea name="${serviceType}_beschreibung" rows="3" placeholder="Beschreiben Sie das Problem..."></textarea>
                        </div>
                    `;
                    break;

                case 'tuev':
                    specificFields = `
                        <div class="form-row">
                            <div class="form-group">
                                <label>Gewünschte Prüfung</label>
                                <select name="${serviceType}_pruefung">
                                    <option value="">Bitte wählen...</option>
                                    <option value="hu">Hauptuntersuchung (HU)</option>
                                    <option value="au">Abgasuntersuchung (AU)</option>
                                    <option value="hu_au">HU + AU</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Fälligkeit</label>
                                <input type="date" name="${serviceType}_faelligkeit">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Anmerkungen</label>
                            <textarea name="${serviceType}_anmerkungen" rows="2" placeholder="Weitere Hinweise zur Prüfung..."></textarea>
                        </div>
                    `;
                    break;

                case 'versicherung':
                    specificFields = `
                        <div class="form-row">
                            <div class="form-group">
                                <label>Schadennummer</label>
                                <input type="text" name="${serviceType}_schadennummer" placeholder="Schadennummer der Versicherung">
                            </div>
                            <div class="form-group">
                                <label>Versicherung</label>
                                <input type="text" name="${serviceType}_versicherung" placeholder="Name der Versicherung">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Schadenshergang</label>
                            <textarea name="${serviceType}_hergang" rows="3" placeholder="Beschreibung des Unfallhergangs..."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Gutachten vorhanden?</label>
                            <select name="${serviceType}_gutachten">
                                <option value="nein">Nein</option>
                                <option value="ja">Ja, liegt vor</option>
                                <option value="geplant">Wird noch erstellt</option>
                            </select>
                        </div>
                    `;
                    break;
            }

            section.innerHTML = `
                <div class="section-header">
                    <h2>${serviceLabels[serviceType]}</h2>
                </div>
                <div class="service-specific-section">
                    ${specificFields}

                    <div class="form-group" style="margin-top: 15px;">
                        <label>Fotos hochladen</label>
                        <div class="photo-upload" onclick="document.getElementById('photo-${serviceType}').click()">
                            <input type="file" id="photo-${serviceType}" accept="image/*" multiple onchange="handlePhotoUpload(event, '${serviceType}')">
                            <div style="font-size: 40px; color: #ccc; margin-bottom: 10px;">📷</div>
                            <div style="font-size: 13px; color: #666;">Klicken zum Hochladen von Fotos</div>
                        </div>
                        <div id="preview-${serviceType}" class="photo-preview"></div>
                    </div>
                </div>
            `;

            return section;
        }

        function handlePhotoUpload(event, serviceType) {
            const files = event.target.files;
            if (!uploadedPhotos[serviceType]) {
                uploadedPhotos[serviceType] = [];
            }

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    uploadedPhotos[serviceType].push({
                        name: file.name,
                        data: e.target.result,
                        file: file
                    });
                    renderPhotoPreview(serviceType);
                };
                reader.readAsDataURL(file);
            });
        }

        function renderPhotoPreview(serviceType) {
            const container = document.getElementById(`preview-${serviceType}`);
            if (!uploadedPhotos[serviceType] || uploadedPhotos[serviceType].length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = uploadedPhotos[serviceType].map((photo, index) => `
                <div class="photo-item">
                    <img src="${photo.data}" alt="${photo.name}">
                    <button type="button" class="remove-btn" onclick="removePhoto('${serviceType}', ${index})">×</button>
                </div>
            `).join('');
        }

        function removePhoto(serviceType, index) {
            uploadedPhotos[serviceType].splice(index, 1);
            renderPhotoPreview(serviceType);
        }

        // Form submission
        document.getElementById('multiServiceForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Wird gesendet...';

            try {
                const formData = new FormData(e.target);

                // Common vehicle data
                const commonData = {
                    kennzeichen: formData.get('kennzeichen'),
                    modell: formData.get('modell'),
                    fin: formData.get('fin'),
                    baujahr: formData.get('baujahr'),
                    farbe: formData.get('farbe'),
                    kmStand: formData.get('kmStand'),
                    kundenname: formData.get('kundenname'),
                    kontakt: formData.get('kontakt'),
                    hinweise: formData.get('hinweise'),
                };

                // Create one request per service
                const promises = selectedServices.map(async (serviceType) => {
                    const serviceData = {};

                    // Extract service-specific fields
                    for (let [key, value] of formData.entries()) {
                        if (key.startsWith(serviceType + '_')) {
                            const fieldName = key.replace(serviceType + '_', '');
                            serviceData[fieldName] = value;
                        }
                    }

                    // Upload photos for this service
                    let photoUrls = [];
                    if (uploadedPhotos[serviceType] && uploadedPhotos[serviceType].length > 0) {
                        photoUrls = await uploadServicePhotos(serviceType, uploadedPhotos[serviceType]);
                    }

                    // Create request document
                    const requestData = {
                        ...commonData,
                        serviceTyp: serviceType,
                        serviceData: serviceData,
                        fotos: photoUrls,
                        partnerId: partner.id,
                        partnerName: partner.name,
                        partnerEmail: partner.email || '',
                        status: 'neu',
                        auftragsnummer: `REQ-${Date.now()}-${serviceType}`,
                        erstelltAm: new Date().toISOString(),
                        multiServiceGroup: `MULTI-${Date.now()}` // Group related requests
                    };

                    return db.collection('partnerAnfragen').add(requestData);
                });

                await Promise.all(promises);

                alert(`✅ Erfolgreich ${selectedServices.length} Anfragen erstellt!`);
                sessionStorage.removeItem('selectedServices');
                window.location.href = 'meine-anfragen.html';

            } catch (error) {
                console.error('Fehler beim Erstellen der Anfragen:', error);
                alert('❌ Fehler beim Erstellen der Anfragen. Bitte versuchen Sie es erneut.');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Anfrage absenden';
            }
        });

        async function uploadServicePhotos(serviceType, photos) {
            const storage = firebase.storage();
            const uploadPromises = photos.map(async (photo) => {
                const storageRef = storage.ref(`partner-anfragen/${partner.id}/${Date.now()}_${photo.name}`);
                await storageRef.put(photo.file);
                return await storageRef.getDownloadURL();
            });
            return Promise.all(uploadPromises);
        }
    </script>
</body>
</html>
