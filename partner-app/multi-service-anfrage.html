<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Service Anfrage | Partner Portal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 40px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }

        .header h1 {
            color: #003366;
            font-size: 26px;
            margin-bottom: 8px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .selected-services {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 30px;
        }

        .service-badge {
            background: #e3f2fd;
            color: #003366;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid #003366;
        }

        .progress-container {
            margin-bottom: 30px;
        }

        .progress-bar {
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #003366, #0055aa);
            transition: width 0.3s;
        }

        .progress-text {
            text-align: center;
            font-size: 12px;
            color: #666;
            margin-top: 8px;
        }

        /* Common Section Styles */
        .form-section {
            margin-bottom: 25px;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .section-header h2 {
            color: #003366;
            font-size: 18px;
            margin: 0;
        }

        .section-completed {
            color: #2e7d32;
            font-size: 14px;
            font-weight: 600;
        }

        /* Accordion Styles */
        .accordion-section {
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }

        .accordion-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 20px;
            background: #f9f9f9;
            cursor: pointer;
            transition: all 0.2s;
        }

        .accordion-header:hover {
            background: #f0f0f0;
        }

        .accordion-header.active {
            background: #e3f2fd;
            border-bottom: 1px solid #e0e0e0;
        }

        .accordion-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .accordion-title h3 {
            color: #003366;
            font-size: 16px;
            margin: 0;
        }

        .accordion-progress {
            font-size: 12px;
            color: #666;
        }

        .accordion-arrow {
            font-size: 18px;
            color: #003366;
            transition: transform 0.2s;
        }

        .accordion-header.active .accordion-arrow {
            transform: rotate(90deg);
        }

        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            padding: 0 20px;
        }

        .accordion-content.active {
            max-height: 5000px;
            padding: 20px;
        }

        /* Form Elements */
        .form-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group label {
            font-size: 12px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #003366;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group small {
            color: #999;
            font-size: 11px;
            margin-top: 4px;
        }

        /* Toggle Group */
        .toggle-group {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }

        .toggle-option {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            font-weight: 600;
        }

        .toggle-option:hover {
            border-color: #003366;
        }

        .toggle-option.selected {
            background: #e3f2fd;
            border-color: #003366;
            color: #003366;
        }

        .toggle-option input {
            display: none;
        }

        /* Radio Group */
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 8px;
        }

        .radio-option {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .radio-option:hover {
            border-color: #003366;
        }

        .radio-option.selected {
            background: #e3f2fd;
            border-color: #003366;
        }

        .radio-option input {
            display: none;
        }

        .radio-option .label {
            font-size: 14px;
            font-weight: 600;
            color: #003366;
            margin-bottom: 4px;
        }

        .radio-option .description {
            font-size: 12px;
            color: #666;
        }

        /* Photo Upload */
        .photo-upload {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 8px;
        }

        .photo-upload:hover {
            border-color: #003366;
            background: #f9f9f9;
        }

        .photo-upload input[type="file"] {
            display: none;
        }

        .photo-upload .icon {
            font-size: 48px;
            color: #ccc;
            margin-bottom: 10px;
        }

        .photo-upload .text {
            font-size: 13px;
            color: #666;
        }

        .photo-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .photo-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #d32f2f;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Termin Grid */
        .termin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .termin-option {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .termin-option:hover {
            border-color: #003366;
        }

        .termin-option.selected {
            background: #e3f2fd;
            border-color: #003366;
        }

        .termin-option .date {
            font-size: 13px;
            font-weight: 600;
            color: #003366;
            margin-bottom: 4px;
        }

        .termin-option .slots {
            font-size: 11px;
            color: #2e7d32;
        }

        .termin-option .slots.limited {
            color: #f57c00;
        }

        .termin-option .slots.full {
            color: #d32f2f;
        }

        .loading {
            text-align: center;
            padding: 30px;
            color: #999;
        }

        .loading .icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        /* Buttons */
        .button-group {
            display: flex;
            gap: 10px;
            justify-content: space-between;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .btn-primary {
            background: #003366;
            color: white;
        }

        .btn-primary:hover {
            background: #002244;
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Summary Styles */
        .summary-section {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .summary-section h3 {
            color: #003366;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .summary-section p {
            font-size: 13px;
            color: #666;
            margin: 4px 0;
        }

        .summary-section strong {
            color: #333;
        }

        /* Conditional Fields */
        .conditional-field {
            margin-top: 15px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 8px;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container { padding: 20px; border-radius: 8px; }
            .header h1 { font-size: 20px; }
            .header p { font-size: 12px; }
            .form-row { grid-template-columns: 1fr; gap: 12px; }
            .form-section { padding: 15px; }
            .accordion-header { padding: 14px 16px; }
            .accordion-title h3 { font-size: 14px; }
            .section-header h2 { font-size: 16px; }
            .form-group label { font-size: 11px; }
            .form-group input, .form-group select, .form-group textarea {
                padding: 8px;
                font-size: 12px;
            }
            .photo-upload { padding: 20px; }
            .photo-upload .icon { font-size: 40px; }
            .btn { padding: 10px 18px; font-size: 12px; }
            .toggle-group { flex-direction: column; }
            .termin-grid { grid-template-columns: 1fr; }
        }

        @media (max-width: 480px) {
            .container { padding: 15px; }
            .header h1 { font-size: 18px; }
            .selected-services { gap: 6px; }
            .service-badge { padding: 4px 8px; font-size: 10px; }
            .form-section { padding: 12px; }
            .accordion-header { padding: 12px; }
            .accordion-title h3 { font-size: 13px; }
            .section-header h2 { font-size: 14px; }
            .btn { padding: 8px 14px; font-size: 11px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Multi-Service Anfrage</h1>
            <p id="partnerName">Mehrere Services f√ºr ein Fahrzeug</p>
        </div>

        <div class="selected-services" id="selectedServicesBadges"></div>

        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
            </div>
            <div class="progress-text" id="progressText">Bitte f√ºllen Sie alle Sections aus</div>
        </div>

        <form id="multiServiceForm">
            <!-- Gemeinsame Fahrzeuginformationen -->
            <div class="form-section" id="commonSection">
                <div class="section-header">
                    <h2>Fahrzeug-Informationen</h2>
                    <span class="section-completed" id="commonCompleted" style="display:none;">‚úì Ausgef√ºllt</span>
                </div>

                <!-- Fahrzeug-Referenz -->
                <div class="form-group">
                    <label>Wie m√∂chten Sie das Fahrzeug identifizieren?</label>
                    <div class="toggle-group">
                        <label class="toggle-option selected" onclick="selectReferenzType('kennzeichen')">
                            <input type="radio" name="referenzType" value="kennzeichen" checked>
                            Kennzeichen
                        </label>
                        <label class="toggle-option" onclick="selectReferenzType('auftrag')">
                            <input type="radio" name="referenzType" value="auftrag">
                            Auftragsnummer
                        </label>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group" id="kennzeichenInput">
                        <label>Kennzeichen *</label>
                        <input type="text" name="kennzeichen" id="kennzeichen" placeholder="z.B. MOS-AB 123" style="text-transform: uppercase;" required>
                    </div>
                    <div class="form-group" id="auftragInput" style="display: none;">
                        <label>Auftragsnummer *</label>
                        <input type="text" name="auftragsnummer" id="auftragsnummer" placeholder="z.B. AH-2024-0123">
                        <small>Ihre interne Auftragsnummer f√ºr nicht-angemeldete Fahrzeuge</small>
                    </div>
                </div>

                <!-- Fahrzeugidentifikation -->
                <div class="form-group">
                    <label>Fahrzeugidentifikation</label>
                    <div class="toggle-group">
                        <label class="toggle-option selected" onclick="selectIdentificationType('vin')">
                            <input type="radio" name="identificationType" value="vin" checked>
                            VIN-Nummer
                        </label>
                        <label class="toggle-option" onclick="selectIdentificationType('fahrzeugschein')">
                            <input type="radio" name="identificationType" value="fahrzeugschein">
                            Fahrzeugschein-Foto
                        </label>
                    </div>
                </div>

                <div id="vinInputContainer">
                    <div class="form-group">
                        <label>VIN-Nummer (17 Zeichen)</label>
                        <input type="text" name="vin" id="vin" placeholder="z.B. WVWZZZ1JZXW123456" maxlength="17" pattern="[A-HJ-NPR-Z0-9]{17}" style="text-transform: uppercase;">
                        <small>Fahrzeug-Identifizierungsnummer (17 Zeichen, keine Buchstaben I, O, Q)</small>
                    </div>
                </div>

                <div id="fahrzeugscheinInputContainer" style="display: none;">
                    <div class="form-group">
                        <label>Fahrzeugschein Teil 1</label>
                        <div class="photo-upload" onclick="document.getElementById('fahrzeugscheinInput').click()">
                            <input type="file" id="fahrzeugscheinInput" accept="image/*" multiple onchange="handleFahrzeugscheinUpload(event)">
                            <div class="icon">üìÑ</div>
                            <div class="text">Fahrzeugschein fotografieren<br><small>(Vorder- und R√ºckseite)</small></div>
                        </div>
                        <div id="fahrzeugscheinPreview" class="photo-preview"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Marke / Modell</label>
                        <input type="text" name="modell" placeholder="z.B. VW Golf">
                    </div>
                    <div class="form-group">
                        <label>Baujahr</label>
                        <input type="number" name="baujahr" min="1980" max="2025" placeholder="z.B. 2020">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Farbe</label>
                        <input type="text" name="farbe" placeholder="z.B. Silber Metallic">
                    </div>
                    <div class="form-group">
                        <label>KM-Stand</label>
                        <input type="number" name="kmStand" placeholder="z.B. 45000">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Kundenname</label>
                        <input type="text" name="kundenname" placeholder="Name des Endkunden">
                    </div>
                    <div class="form-group">
                        <label>Kontakt (Telefon / E-Mail)</label>
                        <input type="text" name="kontakt" placeholder="Telefon oder E-Mail">
                    </div>
                </div>
            </div>

            <!-- Service-Specific Accordions -->
            <div id="serviceAccordions"></div>

            <!-- Gemeinsame Termin-Auswahl -->
            <div class="form-section">
                <div class="section-header">
                    <h2>Termin & Lieferung</h2>
                </div>

                <div class="form-group">
                    <label>Gew√ºnschter Termin</label>
                    <div class="termin-grid" id="terminGrid">
                        <div class="loading">
                            <div class="icon">‚è≥</div>
                            <div>Lade verf√ºgbare Termine...</div>
                        </div>
                    </div>
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <label>Wie soll das Fahrzeug zu uns gelangen?</label>
                    <div class="radio-group">
                        <label class="radio-option selected" onclick="selectLieferoption(this, 'selbst')">
                            <input type="radio" name="lieferoption" value="selbst" checked>
                            <div class="label">Selbst bringen</div>
                            <div class="description" style="color: #2e7d32;">Kostenlos - Sie bringen das Fahrzeug vorbei</div>
                        </label>
                        <label class="radio-option" onclick="selectLieferoption(this, 'abholung')">
                            <input type="radio" name="lieferoption" value="abholung">
                            <div class="label">Abholservice</div>
                            <div class="description">Wir holen das Fahrzeug ab (+Aufpreis)</div>
                        </label>
                    </div>

                    <div id="abholFields" class="conditional-field" style="display: none;">
                        <div class="form-group">
                            <label for="abholtermin">Gew√ºnschter Abholtermin</label>
                            <input type="date" id="abholtermin" name="abholtermin">
                            <small>Wir holen das Fahrzeug an Ihrer Gesch√§ftsadresse ab</small>
                        </div>
                        <div class="form-group" style="margin-top: 12px;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="ersatzfahrzeugGewuenscht" name="ersatzfahrzeugGewuenscht" style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
                                <span style="font-size: 14px;">Ersatzfahrzeug gew√ºnscht <small style="color: #999;">(+Aufpreis)</small></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Allgemeine Hinweise -->
            <div class="form-section">
                <div class="section-header">
                    <h2>Allgemeine Hinweise</h2>
                </div>
                <div class="form-group">
                    <label>Zus√§tzliche Informationen / Anmerkungen</label>
                    <textarea name="hinweise" rows="4" placeholder="Weitere Hinweise f√ºr alle Services..."></textarea>
                </div>
            </div>

            <div class="button-group">
                <button type="button" class="btn btn-secondary" onclick="window.location.href='service-auswahl.html'">
                    ‚Üê Zur√ºck
                </button>
                <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                    Anfragen absenden
                </button>
            </div>
        </form>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <script src="../firebase-config.js"></script>
    <script>
        let partner = null;
        let selectedServices = [];
        let uploadedPhotos = {};
        let fahrzeugscheinPhotos = [];
        let selectedTermin = null;
        let smartTermine = [];

        const serviceLabels = {
            'lackier': 'Lackier-Service',
            'reifen': 'Reifen-Service',
            'pflege': 'Fahrzeugpflege',
            'mechanik': 'Mechanik / Werkstatt',
            'tuev': 'T√úV / AU',
            'versicherung': 'Versicherungsschaden'
        };

        window.addEventListener('DOMContentLoaded', async () => {
            await initFirebase();
            checkLogin();
            loadSelectedServices();
            renderServiceAccordions();
            await ladeSmartTermine();
            updateProgress();
        });

        function checkLogin() {
            partner = JSON.parse(localStorage.getItem('partner') || 'null');
            if (!partner) {
                alert('Bitte melden Sie sich zuerst an.');
                window.location.href = 'index.html';
                return;
            }
            document.getElementById('partnerName').textContent = `${partner.name} - Mehrere Services f√ºr ein Fahrzeug`;
        }

        function loadSelectedServices() {
            const servicesJson = sessionStorage.getItem('selectedServices');
            if (!servicesJson) {
                alert('Keine Services ausgew√§hlt. Sie werden zur Service-Auswahl weitergeleitet.');
                window.location.href = 'service-auswahl.html';
                return;
            }
            selectedServices = JSON.parse(servicesJson);

            const badgesContainer = document.getElementById('selectedServicesBadges');
            badgesContainer.innerHTML = selectedServices.map(service =>
                `<div class="service-badge">${serviceLabels[service]}</div>`
            ).join('');
        }

        // Reference Type Selection
        function selectReferenzType(type) {
            const kennzeichenInput = document.getElementById('kennzeichenInput');
            const auftragInput = document.getElementById('auftragInput');
            const kennzeichenField = document.getElementById('kennzeichen');
            const auftragField = document.getElementById('auftragsnummer');

            document.querySelectorAll('.toggle-option').forEach(opt => opt.classList.remove('selected'));
            event.currentTarget.classList.add('selected');

            if (type === 'kennzeichen') {
                kennzeichenInput.style.display = 'block';
                auftragInput.style.display = 'none';
                kennzeichenField.required = true;
                auftragField.required = false;
                auftragField.value = '';
            } else {
                kennzeichenInput.style.display = 'none';
                auftragInput.style.display = 'block';
                kennzeichenField.required = false;
                auftragField.required = true;
                kennzeichenField.value = '';
            }
            updateProgress();
        }

        // Identification Type Selection
        function selectIdentificationType(type) {
            const vinContainer = document.getElementById('vinInputContainer');
            const fahrzeugscheinContainer = document.getElementById('fahrzeugscheinInputContainer');

            document.querySelectorAll('[name="identificationType"]').forEach(opt =>
                opt.parentElement.classList.remove('selected')
            );
            event.currentTarget.classList.add('selected');

            if (type === 'vin') {
                vinContainer.style.display = 'block';
                fahrzeugscheinContainer.style.display = 'none';
            } else {
                vinContainer.style.display = 'none';
                fahrzeugscheinContainer.style.display = 'block';
            }
            updateProgress();
        }

        // Fahrzeugschein Upload
        function handleFahrzeugscheinUpload(event) {
            const files = event.target.files;
            fahrzeugscheinPhotos = [];

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    fahrzeugscheinPhotos.push({
                        name: file.name,
                        data: e.target.result,
                        file: file
                    });
                    renderFahrzeugscheinPreview();
                    updateProgress();
                };
                reader.readAsDataURL(file);
            });
        }

        function renderFahrzeugscheinPreview() {
            const container = document.getElementById('fahrzeugscheinPreview');
            if (fahrzeugscheinPhotos.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = fahrzeugscheinPhotos.map((photo, index) => `
                <div class="photo-item">
                    <img src="${photo.data}" alt="${photo.name}">
                    <button type="button" class="remove-btn" onclick="removeFahrzeugscheinPhoto(${index})">√ó</button>
                </div>
            `).join('');
        }

        function removeFahrzeugscheinPhoto(index) {
            fahrzeugscheinPhotos.splice(index, 1);
            renderFahrzeugscheinPreview();
            updateProgress();
        }

        // Lieferoption Selection
        function selectLieferoption(element, option) {
            document.querySelectorAll('.radio-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');

            const abholFields = document.getElementById('abholFields');
            abholFields.style.display = option === 'abholung' ? 'block' : 'none';
            updateProgress();
        }

        // Smart Termine laden
        async function ladeSmartTermine() {
            try {
                const heute = new Date();
                const naechsteWoche = new Date();
                naechsteWoche.setDate(heute.getDate() + 7);

                const snapshot = await db.collection('smartTermine')
                    .where('datum', '>=', heute.toISOString().split('T')[0])
                    .where('datum', '<=', naechsteWoche.toISOString().split('T')[0])
                    .orderBy('datum', 'asc')
                    .limit(6)
                    .get();

                smartTermine = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (smartTermine.length === 0) {
                    smartTermine = generateFallbackTermine();
                }

                renderTermine();
            } catch (error) {
                console.error('Fehler beim Laden der Termine:', error);
                smartTermine = generateFallbackTermine();
                renderTermine();
            }
        }

        function generateFallbackTermine() {
            const termine = [];
            const heute = new Date();

            for (let i = 1; i <= 6; i++) {
                const datum = new Date();
                datum.setDate(heute.getDate() + i);
                termine.push({
                    id: `fallback-${i}`,
                    datum: datum.toISOString().split('T')[0],
                    verfuegbar: Math.floor(Math.random() * 10) + 1,
                    max: 10
                });
            }
            return termine;
        }

        function renderTermine() {
            const grid = document.getElementById('terminGrid');

            grid.innerHTML = smartTermine.map(termin => {
                const datum = new Date(termin.datum + 'T00:00:00');
                const verfuegbarkeit = termin.verfuegbar || 0;
                const max = termin.max || 10;
                const percent = (verfuegbarkeit / max) * 100;

                let slotsClass = '';
                let slotsText = `${verfuegbarkeit} Slots frei`;

                if (percent < 30) {
                    slotsClass = 'full';
                    slotsText = `Nur ${verfuegbarkeit} Slot${verfuegbarkeit !== 1 ? 's' : ''} frei`;
                } else if (percent < 60) {
                    slotsClass = 'limited';
                }

                return `
                    <div class="termin-option ${selectedTermin === termin.id ? 'selected' : ''}"
                         onclick="selectTermin('${termin.id}')">
                        <div class="date">${formatDatum(datum)}</div>
                        <div class="slots ${slotsClass}">${slotsText}</div>
                    </div>
                `;
            }).join('');
        }

        function formatDatum(datum) {
            const tage = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
            const monate = ['Jan', 'Feb', 'M√§r', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'];

            return `${tage[datum.getDay()]}, ${datum.getDate()}. ${monate[datum.getMonth()]}`;
        }

        function selectTermin(terminId) {
            selectedTermin = terminId;
            renderTermine();
            updateProgress();
        }

        // Render Service Accordions
        function renderServiceAccordions() {
            const container = document.getElementById('serviceAccordions');

            selectedServices.forEach(service => {
                const accordion = createServiceAccordion(service);
                container.appendChild(accordion);
            });
        }

        function createServiceAccordion(serviceType) {
            const section = document.createElement('div');
            section.className = 'accordion-section';
            section.setAttribute('data-service', serviceType);

            let specificFields = getServiceSpecificFields(serviceType);

            section.innerHTML = `
                <div class="accordion-header" onclick="toggleAccordion('${serviceType}')">
                    <div class="accordion-title">
                        <h3>${serviceLabels[serviceType]}</h3>
                        <span class="accordion-progress" id="progress-${serviceType}">0% ausgef√ºllt</span>
                    </div>
                    <span class="accordion-arrow">‚ñ∂</span>
                </div>
                <div class="accordion-content" id="content-${serviceType}">
                    ${specificFields}
                </div>
            `;

            return section;
        }

        function getServiceSpecificFields(serviceType) {
            switch(serviceType) {
                case 'lackier':
                    return `
                        <div class="form-group">
                            <label>Schadensfotos hochladen *</label>
                            <div class="photo-upload" onclick="document.getElementById('photo-${serviceType}').click()">
                                <input type="file" id="photo-${serviceType}" accept="image/*" multiple onchange="handlePhotoUpload(event, '${serviceType}')">
                                <div class="icon">üì∑</div>
                                <div class="text">Fotos vom Schaden hochladen<br><small>Mehrere Fotos m√∂glich (Kamera oder Galerie)</small></div>
                            </div>
                            <div id="preview-${serviceType}" class="photo-preview"></div>
                        </div>

                        <div class="form-group">
                            <label>Schadensbeschreibung *</label>
                            <textarea name="${serviceType}_beschreibung" id="${serviceType}_beschreibung" rows="4" placeholder="Beschreiben Sie den Lackschaden..." required></textarea>
                        </div>

                        <div class="form-group">
                            <label>Werden Demontage-/Montagearbeiten ben√∂tigt?</label>
                            <div class="radio-group">
                                <label class="radio-option" onclick="selectRadio(this, '${serviceType}_karosserie', 'ja')">
                                    <input type="radio" name="${serviceType}_karosserie" value="ja">
                                    <div class="label">Ja, Demontage ben√∂tigt</div>
                                    <div class="description">z.B. Sto√üf√§nger demontieren, T√ºrgriffe ausbauen</div>
                                </label>
                                <label class="radio-option selected" onclick="selectRadio(this, '${serviceType}_karosserie', 'nein')">
                                    <input type="radio" name="${serviceType}_karosserie" value="nein" checked>
                                    <div class="label">Nein, nur Lackierung</div>
                                    <div class="description">Keine zus√§tzlichen Arbeiten erforderlich</div>
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Welche Ersatzteile sollen verwendet werden? (optional)</label>
                            <div class="radio-group">
                                <label class="radio-option" onclick="selectRadio(this, '${serviceType}_ersatzteil', 'gebrauchteil')">
                                    <input type="radio" name="${serviceType}_ersatzteil" value="gebrauchteil">
                                    <div class="label">Ersatzteil vorhanden</div>
                                    <div class="description">Ich stelle ein Ersatzteil zur Verf√ºgung</div>
                                </label>
                                <label class="radio-option" onclick="selectRadio(this, '${serviceType}_ersatzteil', 'originalteil')">
                                    <input type="radio" name="${serviceType}_ersatzteil" value="originalteil">
                                    <div class="label">Nur Originalteile</div>
                                    <div class="description">Bitte Originalteile (OEM) verwenden</div>
                                </label>
                                <label class="radio-option" onclick="selectRadio(this, '${serviceType}_ersatzteil', 'guenstig')">
                                    <input type="radio" name="${serviceType}_ersatzteil" value="guenstig">
                                    <div class="label">Zubeh√∂rteil</div>
                                    <div class="description">G√ºnstige Alternative ist OK</div>
                                </label>
                            </div>
                        </div>
                    `;

                case 'reifen':
                    return `
                        <div class="form-group">
                            <label>Reifenfotos hochladen</label>
                            <div class="photo-upload" onclick="document.getElementById('photo-${serviceType}').click()">
                                <input type="file" id="photo-${serviceType}" accept="image/*" multiple onchange="handlePhotoUpload(event, '${serviceType}')">
                                <div class="icon">üì∑</div>
                                <div class="text">Fotos von den Reifen hochladen<br><small>Mehrere Fotos m√∂glich</small></div>
                            </div>
                            <div id="preview-${serviceType}" class="photo-preview"></div>
                        </div>

                        <div class="form-group">
                            <label>Welche Art von Reifen wird ben√∂tigt? *</label>
                            <div class="radio-group">
                                <label class="radio-option selected" onclick="selectRadio(this, '${serviceType}_typ', 'sommer')">
                                    <input type="radio" name="${serviceType}_typ" value="sommer" checked>
                                    <div class="label">Sommerreifen</div>
                                    <div class="description">F√ºr Fr√ºhling & Sommer</div>
                                </label>
                                <label class="radio-option" onclick="selectRadio(this, '${serviceType}_typ', 'winter')">
                                    <input type="radio" name="${serviceType}_typ" value="winter">
                                    <div class="label">Winterreifen</div>
                                    <div class="description">F√ºr Herbst & Winter</div>
                                </label>
                                <label class="radio-option" onclick="selectRadio(this, '${serviceType}_typ', 'ganzjahr')">
                                    <input type="radio" name="${serviceType}_typ" value="ganzjahr">
                                    <div class="label">Ganzjahresreifen</div>
                                    <div class="description">Allwetter-Reifen</div>
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Welche Dienstleistung wird ben√∂tigt? *</label>
                            <div class="radio-group">
                                <label class="radio-option selected" onclick="selectRadio(this, '${serviceType}_art', 'wechsel')">
                                    <input type="radio" name="${serviceType}_art" value="wechsel" checked>
                                    <div class="label">Reifenwechsel</div>
                                    <div class="description">Vorhandene Reifen auf-/abziehen</div>
                                </label>
                                <label class="radio-option" onclick="selectRadio(this, '${serviceType}_art', 'bestellung')">
                                    <input type="radio" name="${serviceType}_art" value="bestellung">
                                    <div class="label">Neue Reifen bestellen</div>
                                    <div class="description">Bestellung neuer Reifen inkl. Montage</div>
                                </label>
                                <label class="radio-option" onclick="selectRadio(this, '${serviceType}_art', 'montage')">
                                    <input type="radio" name="${serviceType}_art" value="montage">
                                    <div class="label">Montage mitgebrachter Reifen</div>
                                    <div class="description">Ich bringe eigene Reifen mit</div>
                                </label>
                                <label class="radio-option" onclick="selectRadio(this, '${serviceType}_art', 'einlagerung')">
                                    <input type="radio" name="${serviceType}_art" value="einlagerung">
                                    <div class="label">Reifen-Einlagerung</div>
                                    <div class="description">Saison-Reifen einlagern</div>
                                </label>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Reifengr√∂√üe (optional - falls bekannt)</label>
                                <input type="text" name="${serviceType}_dimension" id="${serviceType}_dimension" placeholder="z.B. 205/55 R16 91V">
                            </div>
                            <div class="form-group">
                                <label>Anzahl Reifen</label>
                                <select name="${serviceType}_anzahl">
                                    <option value="2">2 Reifen</option>
                                    <option value="4" selected>4 Reifen</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Zus√§tzliche Anmerkungen (optional)</label>
                            <textarea name="${serviceType}_info" rows="3" placeholder="z.B. besondere W√ºnsche, Felgen-Informationen, Besch√§digungen..."></textarea>
                        </div>
                    `;

                case 'pflege':
                    return `
                        <div class="form-group">
                            <label>Fotos vom Fahrzeugzustand hochladen</label>
                            <div class="photo-upload" onclick="document.getElementById('photo-${serviceType}').click()">
                                <input type="file" id="photo-${serviceType}" accept="image/*" multiple onchange="handlePhotoUpload(event, '${serviceType}')">
                                <div class="icon">üì∑</div>
                                <div class="text">Fotos vom Fahrzeug-Zustand hochladen<br><small>Innen- & Au√üenansichten</small></div>
                            </div>
                            <div id="preview-${serviceType}" class="photo-preview"></div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Gew√ºnschte Leistung *</label>
                                <select name="${serviceType}_leistung" id="${serviceType}_leistung" required>
                                    <option value="">Bitte w√§hlen...</option>
                                    <option value="aussenreinigung">Au√üenreinigung</option>
                                    <option value="innenreinigung">Innenreinigung</option>
                                    <option value="vollaufbereitung">Vollaufbereitung</option>
                                    <option value="polsterreinigung">Polsterreinigung</option>
                                    <option value="lackversiegelung">Lackversiegelung</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Zustand *</label>
                                <select name="${serviceType}_zustand" id="${serviceType}_zustand" required>
                                    <option value="">Bitte w√§hlen...</option>
                                    <option value="leicht_verschmutzt">Leicht verschmutzt</option>
                                    <option value="normal" selected>Normal</option>
                                    <option value="stark_verschmutzt">Stark verschmutzt</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Besondere Anforderungen</label>
                            <textarea name="${serviceType}_anforderungen" rows="3" placeholder="z.B. Lederaufbereitung, Geruchsentfernung..."></textarea>
                        </div>
                    `;

                case 'mechanik':
                    return `
                        <div class="form-group">
                            <label>Fotos vom Problem hochladen</label>
                            <div class="photo-upload" onclick="document.getElementById('photo-${serviceType}').click()">
                                <input type="file" id="photo-${serviceType}" accept="image/*" multiple onchange="handlePhotoUpload(event, '${serviceType}')">
                                <div class="icon">üì∑</div>
                                <div class="text">Fotos vom Problem hochladen<br><small>z.B. Motorraum, Warnleuchten, defekte Teile</small></div>
                            </div>
                            <div id="preview-${serviceType}" class="photo-preview"></div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Art der Reparatur *</label>
                                <select name="${serviceType}_reparaturart" id="${serviceType}_reparaturart" required>
                                    <option value="">Bitte w√§hlen...</option>
                                    <option value="inspektion">Inspektion</option>
                                    <option value="reparatur">Reparatur</option>
                                    <option value="diagnose">Diagnose</option>
                                    <option value="wartung">Wartung</option>
                                    <option value="bremsen">Bremsen-Service</option>
                                    <option value="auspuff">Auspuff-Reparatur</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Symptome / Problem</label>
                                <input type="text" name="${serviceType}_symptome" placeholder="z.B. Motorger√§usch, Warnleuchte">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Detaillierte Beschreibung *</label>
                            <textarea name="${serviceType}_beschreibung" id="${serviceType}_beschreibung" rows="4" placeholder="Beschreiben Sie das Problem..." required></textarea>
                        </div>
                    `;

                case 'tuev':
                    return `
                        <div class="form-group">
                            <label>Fahrzeugfotos hochladen (optional)</label>
                            <div class="photo-upload" onclick="document.getElementById('photo-${serviceType}').click()">
                                <input type="file" id="photo-${serviceType}" accept="image/*" multiple onchange="handlePhotoUpload(event, '${serviceType}')">
                                <div class="icon">üì∑</div>
                                <div class="text">Fotos vom Fahrzeug hochladen<br><small>z.B. bei bekannten M√§ngeln</small></div>
                            </div>
                            <div id="preview-${serviceType}" class="photo-preview"></div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Gew√ºnschte Pr√ºfung *</label>
                                <select name="${serviceType}_pruefung" id="${serviceType}_pruefung" required>
                                    <option value="">Bitte w√§hlen...</option>
                                    <option value="hu">Hauptuntersuchung (HU)</option>
                                    <option value="au">Abgasuntersuchung (AU)</option>
                                    <option value="hu_au">HU + AU</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>F√§lligkeit</label>
                                <input type="date" name="${serviceType}_faelligkeit">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Anmerkungen</label>
                            <textarea name="${serviceType}_anmerkungen" rows="3" placeholder="Weitere Hinweise zur Pr√ºfung..."></textarea>
                        </div>
                    `;

                case 'versicherung':
                    return `
                        <div class="form-group">
                            <label>Schadensfotos hochladen *</label>
                            <div class="photo-upload" onclick="document.getElementById('photo-${serviceType}').click()">
                                <input type="file" id="photo-${serviceType}" accept="image/*" multiple onchange="handlePhotoUpload(event, '${serviceType}')">
                                <div class="icon">üì∑</div>
                                <div class="text">Fotos vom Unfallschaden hochladen<br><small>Mehrere Ansichten des Schadens</small></div>
                            </div>
                            <div id="preview-${serviceType}" class="photo-preview"></div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Schadennummer *</label>
                                <input type="text" name="${serviceType}_schadennummer" id="${serviceType}_schadennummer" placeholder="Schadennummer der Versicherung" required>
                            </div>
                            <div class="form-group">
                                <label>Versicherung *</label>
                                <input type="text" name="${serviceType}_versicherung" id="${serviceType}_versicherung" placeholder="Name der Versicherung" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Schadenshergang *</label>
                            <textarea name="${serviceType}_hergang" id="${serviceType}_hergang" rows="4" placeholder="Beschreibung des Unfallhergangs..." required></textarea>
                        </div>

                        <div class="form-group">
                            <label>Gutachten vorhanden?</label>
                            <select name="${serviceType}_gutachten">
                                <option value="nein">Nein</option>
                                <option value="ja">Ja, liegt vor</option>
                                <option value="geplant">Wird noch erstellt</option>
                            </select>
                        </div>
                    `;

                default:
                    return '';
            }
        }

        function toggleAccordion(serviceType) {
            const header = event.currentTarget;
            const content = document.getElementById(`content-${serviceType}`);

            header.classList.toggle('active');
            content.classList.toggle('active');
        }

        function selectRadio(element, name, value) {
            const group = element.closest('.radio-group');
            group.querySelectorAll('.radio-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            updateProgress();
        }

        function handlePhotoUpload(event, serviceType) {
            const files = event.target.files;
            if (!uploadedPhotos[serviceType]) {
                uploadedPhotos[serviceType] = [];
            }

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    uploadedPhotos[serviceType].push({
                        name: file.name,
                        data: e.target.result,
                        file: file
                    });
                    renderPhotoPreview(serviceType);
                    updateProgress();
                };
                reader.readAsDataURL(file);
            });
        }

        function renderPhotoPreview(serviceType) {
            const container = document.getElementById(`preview-${serviceType}`);
            if (!uploadedPhotos[serviceType] || uploadedPhotos[serviceType].length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = uploadedPhotos[serviceType].map((photo, index) => `
                <div class="photo-item">
                    <img src="${photo.data}" alt="${photo.name}">
                    <button type="button" class="remove-btn" onclick="removePhoto('${serviceType}', ${index})">√ó</button>
                </div>
            `).join('');
        }

        function removePhoto(serviceType, index) {
            uploadedPhotos[serviceType].splice(index, 1);
            renderPhotoPreview(serviceType);
            updateProgress();
        }

        // Progress Tracking
        function updateProgress() {
            let totalFields = 0;
            let filledFields = 0;

            // Common section
            const formData = new FormData(document.getElementById('multiServiceForm'));
            const referenzType = document.querySelector('[name="referenzType"]:checked').value;
            const identificationType = document.querySelector('[name="identificationType"]:checked').value;

            if (referenzType === 'kennzeichen' && formData.get('kennzeichen')) filledFields++;
            if (referenzType === 'auftrag' && formData.get('auftragsnummer')) filledFields++;
            totalFields++;

            if (identificationType === 'vin' && formData.get('vin')) filledFields++;
            if (identificationType === 'fahrzeugschein' && fahrzeugscheinPhotos.length > 0) filledFields++;
            totalFields++;

            // Service sections
            selectedServices.forEach(service => {
                const serviceFields = document.querySelectorAll(`[name^="${service}_"]`);
                const requiredFields = Array.from(serviceFields).filter(f => f.required);
                const servicePhotos = uploadedPhotos[service] || [];

                let serviceTotal = requiredFields.length + 1; // +1 for photos
                let serviceFilled = 0;

                requiredFields.forEach(field => {
                    if (field.value) serviceFilled++;
                });

                if (servicePhotos.length > 0) serviceFilled++;

                totalFields += serviceTotal;
                filledFields += serviceFilled;

                const serviceProgress = serviceTotal > 0 ? Math.round((serviceFilled / serviceTotal) * 100) : 0;
                const progressElem = document.getElementById(`progress-${service}`);
                if (progressElem) {
                    progressElem.textContent = `${serviceProgress}% ausgef√ºllt`;
                }
            });

            // Termin
            if (selectedTermin) filledFields++;
            totalFields++;

            const overallProgress = totalFields > 0 ? Math.round((filledFields / totalFields) * 100) : 0;
            document.getElementById('progressFill').style.width = `${overallProgress}%`;
            document.getElementById('progressText').textContent = `${overallProgress}% ausgef√ºllt`;

            // Enable/disable submit button
            document.getElementById('submitBtn').disabled = overallProgress < 80;

            // Mark common section as completed
            const commonCompleted = document.getElementById('commonCompleted');
            if (referenzType === 'kennzeichen' && formData.get('kennzeichen') &&
                (formData.get('vin') || fahrzeugscheinPhotos.length > 0)) {
                commonCompleted.style.display = 'inline';
            } else {
                commonCompleted.style.display = 'none';
            }
        }

        // Listen to input changes
        document.addEventListener('input', updateProgress);
        document.addEventListener('change', updateProgress);

        // Form submission
        document.getElementById('multiServiceForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Wird gesendet...';

            try {
                const formData = new FormData(e.target);
                const multiServiceGroupId = `MULTI-${Date.now()}`;

                // Common vehicle data
                const referenzType = document.querySelector('[name="referenzType"]:checked').value;
                const identificationType = document.querySelector('[name="identificationType"]:checked').value;

                const commonData = {
                    referenzType: referenzType,
                    kennzeichen: referenzType === 'kennzeichen' ? formData.get('kennzeichen') : null,
                    auftragsnummer: referenzType === 'auftrag' ? formData.get('auftragsnummer') : null,
                    identificationType: identificationType,
                    vin: identificationType === 'vin' ? formData.get('vin') : null,
                    modell: formData.get('modell'),
                    baujahr: formData.get('baujahr'),
                    farbe: formData.get('farbe'),
                    kmStand: formData.get('kmStand'),
                    kundenname: formData.get('kundenname'),
                    kontakt: formData.get('kontakt'),
                    hinweise: formData.get('hinweise'),
                    termin: selectedTermin ? smartTermine.find(t => t.id === selectedTermin) : null,
                    lieferoption: formData.get('lieferoption'),
                    abholtermin: formData.get('abholtermin'),
                    ersatzfahrzeugGewuenscht: formData.get('ersatzfahrzeugGewuenscht') === 'on'
                };

                // Upload Fahrzeugschein photos if using fahrzeugschein
                let fahrzeugscheinUrls = [];
                if (identificationType === 'fahrzeugschein' && fahrzeugscheinPhotos.length > 0) {
                    fahrzeugscheinUrls = await uploadFahrzeugscheinPhotos();
                }
                commonData.fahrzeugscheinFotos = fahrzeugscheinUrls;

                // Create one request per service
                const promises = selectedServices.map(async (serviceType) => {
                    const serviceData = {};

                    // Extract service-specific fields
                    for (let [key, value] of formData.entries()) {
                        if (key.startsWith(serviceType + '_')) {
                            const fieldName = key.replace(serviceType + '_', '');
                            serviceData[fieldName] = value;
                        }
                    }

                    // Upload photos for this service
                    let photoUrls = [];
                    if (uploadedPhotos[serviceType] && uploadedPhotos[serviceType].length > 0) {
                        photoUrls = await uploadServicePhotos(serviceType, uploadedPhotos[serviceType]);
                    }

                    // Create request document
                    const requestData = {
                        ...commonData,
                        serviceTyp: serviceType,
                        serviceData: serviceData,
                        fotos: photoUrls,
                        partnerId: partner.id,
                        partnerName: partner.name,
                        partnerEmail: partner.email || partner.kontakt || '',
                        status: 'neu',
                        auftragsnummer: `REQ-${Date.now()}-${serviceType.substring(0, 3).toUpperCase()}`,
                        erstelltAm: new Date().toISOString(),
                        multiServiceGroup: multiServiceGroupId
                    };

                    return db.collection('partnerAnfragen').add(requestData);
                });

                await Promise.all(promises);

                alert(`‚úÖ Erfolgreich ${selectedServices.length} Anfrage${selectedServices.length > 1 ? 'n' : ''} erstellt!`);
                sessionStorage.removeItem('selectedServices');
                window.location.href = 'meine-anfragen.html';

            } catch (error) {
                console.error('Fehler beim Erstellen der Anfragen:', error);
                alert('‚ùå Fehler beim Erstellen der Anfragen. Bitte versuchen Sie es erneut.');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Anfragen absenden';
            }
        });

        async function uploadFahrzeugscheinPhotos() {
            const storage = firebase.storage();
            const uploadPromises = fahrzeugscheinPhotos.map(async (photo) => {
                const storageRef = storage.ref(`partner-anfragen/${partner.id}/fahrzeugschein/${Date.now()}_${photo.name}`);
                await storageRef.put(photo.file);
                return await storageRef.getDownloadURL();
            });
            return Promise.all(uploadPromises);
        }

        async function uploadServicePhotos(serviceType, photos) {
            const storage = firebase.storage();
            const uploadPromises = photos.map(async (photo) => {
                const storageRef = storage.ref(`partner-anfragen/${partner.id}/${serviceType}/${Date.now()}_${photo.name}`);
                await storageRef.put(photo.file);
                return await storageRef.getDownloadURL();
            });
            return Promise.all(uploadPromises);
        }
    </script>
</body>
</html>
