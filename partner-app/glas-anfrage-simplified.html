<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glas-Reparatur | Partner Portal</title>
    <link rel="stylesheet" href="service-form-styles.css">
    <link rel="stylesheet" href="../mobile-responsive.css">
</head>
<body>
    <div class="main-layout">
        <div class="wizard-sidebar">
            <div class="sidebar-title">Fortschritt</div>
            <div class="sidebar-steps" id="sidebarSteps">
                <div class="sidebar-step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">Fotos</div>
                </div>
                <div class="sidebar-step pending" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">Fahrzeug</div>
                </div>
                <div class="sidebar-step pending" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">Glasart & Schaden</div>
                </div>
                <div class="sidebar-step pending" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-label">Termin</div>
                </div>
                <div class="sidebar-step pending" data-step="5">
                    <div class="step-number">5</div>
                    <div class="step-label">Zusammenfassung</div>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="header">
                <h1>🔍 Neue Glas-Reparatur Anfrage</h1>
                <p id="partnerName">Partner Portal</p>
            </div>

            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 20%;"></div>
                </div>
                <div class="progress-text" id="progressText">Schritt 1 von 5</div>
            </div>

            <div class="wizard-container">
                <!-- Step 1: Fotos -->
                <div class="wizard-step active" data-step="1">
                    <div class="step-title"><span>📸 Glasschaden-Fotos</span></div>
                    <div class="form-group">
                        <label class="photo-upload" for="photoInput">
                            <div class="icon">📷</div>
                            <div class="text">Fotos des Glasschadens hochladen<br><small>(Steinschlag, Riss, etc.)</small></div>
                            <input type="file" id="photoInput" accept="image/*" multiple capture="environment">
                        </label>
                        <div class="photo-preview" id="photoPreview"></div>
                    </div>
                </div>

                <!-- Step 2: Fahrzeug -->
                <div class="wizard-step" data-step="2">
                    <div class="step-title"><span>🚗 Fahrzeug</span></div>
                    <div class="form-group">
                        <label for="kennzeichen">Kennzeichen *</label>
                        <input type="text" id="kennzeichen" placeholder="z.B. MOS-AB 123" required style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label for="marke">Marke *</label>
                        <select id="marke" required>
                            <option value="">Bitte wählen...</option>
                            <option value="Audi">Audi</option>
                            <option value="BMW">BMW</option>
                            <option value="Mercedes-Benz">Mercedes-Benz</option>
                            <option value="Volkswagen">Volkswagen</option>
                            <option value="Sonstige">Sonstige</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="modell">Modell *</label>
                        <input type="text" id="modell" placeholder="z.B. Golf 7" required>
                    </div>
                </div>

                <!-- Step 3: Glasart & Schaden -->
                <div class="wizard-step" data-step="3">
                    <div class="step-title"><span>🪟 Glasart & Schaden</span></div>
                    <div class="form-group">
                        <label>Art der Reparatur *</label>
                        <div class="radio-group">
                            <label class="radio-option selected" onclick="selectGlasArt(this, 'steinschlag')">
                                <input type="radio" name="glasArt" value="steinschlag" checked>
                                <div class="label">🔹 Steinschlag reparieren</div>
                                <div class="description">Kleiner Schaden, kann oft repariert werden</div>
                            </label>
                            <label class="radio-option" onclick="selectGlasArt(this, 'riss')">
                                <input type="radio" name="glasArt" value="riss">
                                <div class="label">⚡ Riss/Sprung</div>
                                <div class="description">Größerer Schaden, meist Austausch nötig</div>
                            </label>
                            <label class="radio-option" onclick="selectGlasArt(this, 'ersatz')">
                                <input type="radio" name="glasArt" value="ersatz">
                                <div class="label">🔄 Komplett-Austausch</div>
                                <div class="description">Scheibe muss ersetzt werden</div>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Welche Scheibe? *</label>
                        <div class="toggle-group">
                            <label class="toggle-option selected" onclick="selectScheibenTyp('windschutzscheibe')">
                                <input type="radio" name="scheibenTyp" value="windschutzscheibe" checked>
                                🚗 Windschutzscheibe
                            </label>
                            <label class="toggle-option" onclick="selectScheibenTyp('seitenfenster')">
                                <input type="radio" name="scheibenTyp" value="seitenfenster">
                                🚪 Seitenfenster
                            </label>
                            <label class="toggle-option" onclick="selectScheibenTyp('heckscheibe')">
                                <input type="radio" name="scheibenTyp" value="heckscheibe">
                                🔙 Heckscheibe
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="sensorVorhanden" style="width: 18px; height: 18px; margin-right: 10px;">
                            <span>Regensensor / Spurhalteassistent vorhanden</span>
                        </label>
                    </div>
                </div>

                <!-- Step 4: Termin -->
                <div class="wizard-step" data-step="4">
                    <div class="step-title"><span>📅 Termin</span></div>
                    <div class="form-group">
                        <label>Gewünschter Termin *</label>
                        <div class="termin-grid" id="terminGrid">
                            <div class="loading"><div class="icon">⏳</div><div>Lade verfügbare Termine...</div></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="anmerkungen">Anmerkungen (optional)</label>
                        <textarea id="anmerkungen" placeholder="z.B. Versicherungsschaden, Eilt, etc."></textarea>
                    </div>
                </div>

                <!-- Step 5: Zusammenfassung -->
                <div class="wizard-step" data-step="5">
                    <div class="step-title"><span>✅ Zusammenfassung</span></div>
                    <div id="summaryContent"></div>
                </div>
            </div>

            <div class="wizard-nav">
                <button type="button" class="btn btn-back" id="btnBack" onclick="prevStep()" style="display: none;">← Zurück</button>
                <button type="button" class="btn btn-primary" id="btnNext" onclick="nextStep()">Weiter →</button>
            </div>

            <div class="success-message" id="successMessage">
                <div class="icon">✅</div>
                <h3>Anfrage erfolgreich gesendet!</h3>
                <p>Wir melden uns schnellstmöglich mit einem Kostenvoranschlag bei Ihnen.</p>
                <button class="btn btn-primary" onclick="window.location.href='meine-anfragen.html'">Zu meinen Anfragen</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="../firebase-config.js"></script>
    <script>
        let currentStep = 1;
        const totalSteps = 5;
        let partner = null;
        let photos = [];

        window.addEventListener('DOMContentLoaded', async () => {
            await initFirebase();
            checkLogin();
            setupPhotoUpload();
            await ladeTermine();
        });

        function checkLogin() {
            partner = JSON.parse(localStorage.getItem('partner') || 'null');
            if (!partner) {
                window.location.href = 'index.html';
                return;
            }
            if (!partner || !partner.werkstattId) { throw new Error('Partner-Daten unvollständig - werkstattId fehlt!'); } window.werkstattId = partner.werkstattId;
            document.getElementById('partnerName').textContent = partner.name;
        }

        function setupPhotoUpload() {
            document.getElementById('photoInput').addEventListener('change', async (e) => {
                const files = Array.from(e.target.files);
                for (const file of files) {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        photos.push(ev.target.result);
                        displayPhotos();
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function displayPhotos() {
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = photos.map((photo, i) => `
                <div class="photo-preview-item">
                    <img src="${photo}" alt="Foto ${i+1}">
                    <button type="button" class="remove-btn" onclick="removePhoto(${i})">×</button>
                </div>
            `).join('');
        }

        function removePhoto(index) {
            photos.splice(index, 1);
            displayPhotos();
        }

        function nextStep() {
            if (!validateStep(currentStep)) return;
            if (currentStep === totalSteps) {
                submitAnfrage();
                return;
            }
            document.querySelector(`.wizard-step[data-step="${currentStep}"]`).classList.remove('active');
            currentStep++;
            document.querySelector(`.wizard-step[data-step="${currentStep}"]`).classList.add('active');
            updateProgress();
            updateButtons();
            if (currentStep === totalSteps) generateSummary();
        }

        function prevStep() {
            if (currentStep === 1) return;
            document.querySelector(`.wizard-step[data-step="${currentStep}"]`).classList.remove('active');
            currentStep--;
            document.querySelector(`.wizard-step[data-step="${currentStep}"]`).classList.add('active');
            updateProgress();
            updateButtons();
        }

        function updateProgress() {
            document.getElementById('progressFill').style.width = (currentStep / totalSteps * 100) + '%';
            document.getElementById('progressText').textContent = `Schritt ${currentStep} von ${totalSteps}`;
        }

        function updateButtons() {
            document.getElementById('btnBack').style.display = currentStep === 1 ? 'none' : 'inline-flex';
            document.getElementById('btnNext').textContent = currentStep === totalSteps ? 'Anfrage senden' : 'Weiter →';
        }

        function validateStep(step) {
            if (step === 1 && photos.length === 0) {
                alert('Bitte laden Sie mindestens ein Foto hoch.');
                return false;
            }
            if (step === 2) {
                if (!document.getElementById('kennzeichen').value.trim()) {
                    alert('Bitte geben Sie das Kennzeichen ein.');
                    return false;
                }
                if (!document.getElementById('marke').value) {
                    alert('Bitte wählen Sie die Marke aus.');
                    return false;
                }
                if (!document.getElementById('modell').value.trim()) {
                    alert('Bitte geben Sie das Modell ein.');
                    return false;
                }
            }
            return true;
        }

        function selectGlasArt(element, value) {
            document.querySelectorAll('.radio-option').forEach(opt => {
                if (opt.querySelector('input[name="glasArt"]')) opt.classList.remove('selected');
            });
            element.classList.add('selected');
            element.querySelector('input').checked = true;
        }

        function selectScheibenTyp(value) {
            document.querySelectorAll('input[name="scheibenTyp"]').forEach(input => {
                input.parentElement.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
        }

        async function ladeTermine() {
            const terminGrid = document.getElementById('terminGrid');
            try {
                const heute = new Date();
                const termine = [];
                for (let i = 1; i <= 7; i++) {
                    const datum = new Date(heute);
                    datum.setDate(heute.getDate() + i);
                    const dateStr = datum.toISOString().split('T')[0];
                    const wochentag = datum.toLocaleDateString('de-DE', { weekday: 'short' });
                    const tag = datum.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
                    termine.push({ dateStr, wochentag, tag, i });
                }
                terminGrid.innerHTML = termine.slice(0, 4).map((t, idx) => `
                    <label class="termin-option ${idx === 0 ? 'selected' : ''}" onclick="selectTermin(this)">
                        <input type="radio" name="termin" value="${t.dateStr}" ${idx === 0 ? 'checked' : ''}>
                        <div class="label">${t.wochentag}, ${t.tag}</div>
                    </label>
                `).join('');
            } catch (error) {
                console.error('Fehler beim Laden der Termine:', error);
                terminGrid.innerHTML = '<div style="color: red;">Fehler beim Laden der Termine</div>';
            }
        }

        function selectTermin(element) {
            document.querySelectorAll('.termin-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            element.querySelector('input').checked = true;
        }

        function generateSummary() {
            const glasArt = document.querySelector('input[name="glasArt"]:checked').value;
            const scheibenTyp = document.querySelector('input[name="scheibenTyp"]:checked').value;
            const sensor = document.getElementById('sensorVorhanden').checked;
            const termin = document.querySelector('input[name="termin"]:checked');

            const glasArtLabels = {
                'steinschlag': '🔹 Steinschlag reparieren',
                'riss': '⚡ Riss/Sprung',
                'ersatz': '🔄 Komplett-Austausch'
            };
            const scheibenLabels = {
                'windschutzscheibe': '🚗 Windschutzscheibe',
                'seitenfenster': '🚪 Seitenfenster',
                'heckscheibe': '🔙 Heckscheibe'
            };

            document.getElementById('summaryContent').innerHTML = `
                <div class="summary-section">
                    <h3>📸 Fotos</h3>
                    <p>${photos.length} Foto(s) hochgeladen</p>
                </div>
                <div class="summary-section">
                    <h3>🚗 Fahrzeug</h3>
                    <p class="label">Kennzeichen</p>
                    <p>${document.getElementById('kennzeichen').value}</p>
                    <p class="label">Fahrzeug</p>
                    <p>${document.getElementById('marke').value} ${document.getElementById('modell').value}</p>
                </div>
                <div class="summary-section">
                    <h3>🪟 Glasschaden</h3>
                    <p class="label">Art der Reparatur</p>
                    <p>${glasArtLabels[glasArt]}</p>
                    <p class="label">Scheibe</p>
                    <p>${scheibenLabels[scheibenTyp]}</p>
                    ${sensor ? '<p class="label">Sensor</p><p>✅ Regensensor / Spurhalteassistent vorhanden</p>' : ''}
                </div>
                <div class="summary-section">
                    <h3>📅 Termin</h3>
                    <p>${new Date(termin.value).toLocaleDateString('de-DE', { weekday: 'long', day: '2-digit', month: '2-digit', year: 'numeric' })}</p>
                </div>
                ${document.getElementById('anmerkungen').value ? `
                <div class="summary-section">
                    <h3>💬 Anmerkungen</h3>
                    <p>${document.getElementById('anmerkungen').value}</p>
                </div>` : ''}
            `;
        }

        async function compressImage(base64, maxWidth = 800, quality = 0.65) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    let width = img.width;
                    let height = img.height;
                    if (width > maxWidth) {
                        height = (height * maxWidth) / width;
                        width = maxWidth;
                    }
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.src = base64;
            });
        }

        async function submitAnfrage() {
            const btnNext = document.getElementById('btnNext');
            btnNext.disabled = true;
            btnNext.textContent = '⏳ Wird gesendet...';

            try {
                const compressedPhotos = await Promise.all(photos.map(p => compressImage(p)));
                const glasArt = document.querySelector('input[name="glasArt"]:checked').value;
                const scheibenTyp = document.querySelector('input[name="scheibenTyp"]:checked').value;
                const termin = document.querySelector('input[name="termin"]:checked');

                const anfrageData = {
                    id: 'req_' + Date.now(),
                    partnerId: partner.id,
                    partnerName: partner.name,
                    serviceTyp: 'glas',
                    timestamp: new Date().toISOString(),
                    kennzeichen: document.getElementById('kennzeichen').value.toUpperCase(),
                    marke: document.getElementById('marke').value,
                    modell: document.getElementById('modell').value,
                    serviceData: {
                        art: glasArt,
                        typ: scheibenTyp,
                        sensor: document.getElementById('sensorVorhanden').checked,
                        info: document.getElementById('anmerkungen').value || null
                    },
                    anliefertermin: termin.value,
                    fotos: compressedPhotos,
                    status: 'neu'
                };

                await window.getCollection('partnerAnfragen').doc(anfrageData.id).set(anfrageData);
                document.querySelector('.wizard-container').style.display = 'none';
                document.querySelector('.wizard-nav').style.display = 'none';
                document.querySelector('.progress-container').style.display = 'none';
                document.getElementById('successMessage').classList.add('show');
            } catch (error) {
                console.error('Fehler:', error);
                alert('Fehler beim Senden der Anfrage: ' + error.message);
                btnNext.disabled = false;
                btnNext.textContent = 'Anfrage senden';
            }
        }
    </script>
</body>
</html>
