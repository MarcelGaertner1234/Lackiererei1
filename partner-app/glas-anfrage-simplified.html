<!DOCTYPE html>
<html lang="de">
<head>
    <!-- ‚úÖ BUG #7 FIX: Service Type Normalization Registry -->
    <script src="../js/service-types.js?v=bug7-normalization"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glas-Reparatur | Partner Portal</title>
    <link rel="stylesheet" href="service-form-styles.css">
    <link rel="stylesheet" href="../mobile-responsive.css">
</head>
<body>
    <div class="main-layout">
        <div class="wizard-sidebar">
            <div class="sidebar-title">Fortschritt</div>
            <div class="sidebar-steps" id="sidebarSteps">
                <div class="sidebar-step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">Fotos</div>
                    <div class="step-icon"></div>
                </div>
                <div class="sidebar-step pending" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">Fahrzeug</div>
                    <div class="step-icon"></div>
                </div>
                <div class="sidebar-step pending" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-label">Glasart & Schaden</div>
                    <div class="step-icon"></div>
                </div>
                <div class="sidebar-step pending" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-label">Termin</div>
                    <div class="step-icon"></div>
                </div>
                <div class="sidebar-step pending" data-step="5">
                    <div class="step-number">5</div>
                    <div class="step-label">Zusammenfassung</div>
                    <div class="step-icon"></div>
                </div>
            </div>
        </div>

        <div class="container">
            <button id="btnThemeToggle" class="btn btn-theme-toggle" onclick="toggleTheme()" title="Theme wechseln">üåô</button>

            <div class="header">
                <!-- Werkstatt Logo (dynamisch geladen) -->
                <div id="werkstattLogo" style="display: inline-block; vertical-align: middle; margin-right: 12px;"></div>
                <h1 style="display: inline-block; vertical-align: middle;">üîç Neue Glas-Reparatur Anfrage</h1>
                <p id="partnerName">Partner Portal</p>
            </div>

            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 20%;"></div>
                </div>
                <div class="progress-text" id="progressText">Schritt 1 von 5</div>
            </div>

            <div class="wizard-container">
                <!-- Step 1: Fotos -->
                <div class="wizard-step active" data-step="1">
                    <div class="step-title"><span>üì∏ Glasschaden-Fotos</span></div>
                    <div class="form-group">
                        <label class="photo-upload" for="photoInput">
                            <div class="icon">üì∑</div>
                            <div class="text">Fotos des Glasschadens hochladen<br><small>(Steinschlag, Riss, etc.)</small></div>
                            <input type="file" id="photoInput" accept="image/*" multiple capture="environment">
                        </label>
                        <div class="photo-preview" id="photoPreview"></div>
                    </div>
                </div>

                <!-- Step 2: Fahrzeug -->
                <div class="wizard-step" data-step="2">
                    <div class="step-title"><span>üöó Fahrzeug</span></div>
                    <div class="form-group">
                        <label for="kennzeichen">Kennzeichen *</label>
                        <input type="text" id="kennzeichen" placeholder="z.B. MOS-AB 123" required style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label for="marke">Marke *</label>
                        <select id="marke" required>
                            <option value="">Bitte w√§hlen...</option>
                            <option value="Audi">Audi</option>
                            <option value="BMW">BMW</option>
                            <option value="Mercedes-Benz">Mercedes-Benz</option>
                            <option value="Volkswagen">Volkswagen</option>
                            <option value="Sonstige">Sonstige</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="modell">Modell *</label>
                        <input type="text" id="modell" placeholder="z.B. Golf 7" required>
                    </div>
                </div>

                <!-- Step 3: Glasart & Schaden -->
                <div class="wizard-step" data-step="3">
                    <div class="step-title"><span>ü™ü Glasart & Schaden</span></div>
                    <div class="form-group">
                        <label>Art der Reparatur *</label>
                        <div class="radio-group">
                            <label class="radio-option selected" onclick="selectGlasArt(this, 'steinschlag')">
                                <input type="radio" name="glasArt" value="steinschlag" checked>
                                <div class="label">üîπ Steinschlag reparieren</div>
                                <div class="description">Kleiner Schaden, kann oft repariert werden</div>
                            </label>
                            <label class="radio-option" onclick="selectGlasArt(this, 'riss')">
                                <input type="radio" name="glasArt" value="riss">
                                <div class="label">‚ö° Riss/Sprung</div>
                                <div class="description">Gr√∂√üerer Schaden, meist Austausch n√∂tig</div>
                            </label>
                            <label class="radio-option" onclick="selectGlasArt(this, 'ersatz')">
                                <input type="radio" name="glasArt" value="ersatz">
                                <div class="label">üîÑ Komplett-Austausch</div>
                                <div class="description">Scheibe muss ersetzt werden</div>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Welche Scheibe? *</label>
                        <div class="toggle-group">
                            <label class="toggle-option selected" onclick="selectScheibenTyp('windschutzscheibe')">
                                <input type="radio" name="scheibenTyp" value="windschutzscheibe" checked>
                                üöó Windschutzscheibe
                            </label>
                            <label class="toggle-option" onclick="selectScheibenTyp('seitenfenster')">
                                <input type="radio" name="scheibenTyp" value="seitenfenster">
                                üö™ Seitenfenster
                            </label>
                            <label class="toggle-option" onclick="selectScheibenTyp('heckscheibe')">
                                <input type="radio" name="scheibenTyp" value="heckscheibe">
                                üîô Heckscheibe
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="sensorVorhanden" style="width: 18px; height: 18px; margin-right: 10px;">
                            <span>Regensensor / Spurhalteassistent vorhanden</span>
                        </label>
                    </div>
                </div>

                <!-- Step 4: Termin -->
                <div class="wizard-step" data-step="4">
                    <div class="step-title"><span>üìÖ Termin</span></div>
                    <div class="form-group">
                        <label>Gew√ºnschter Termin *</label>
                        <div class="termin-grid" id="terminGrid">
                            <div class="loading"><div class="icon">‚è≥</div><div>Lade verf√ºgbare Termine...</div></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="anmerkungen">Anmerkungen (optional)</label>
                        <textarea id="anmerkungen" placeholder="z.B. Versicherungsschaden, Eilt, etc."></textarea>
                    </div>
                </div>

                <!-- Step 5: Zusammenfassung -->
                <div class="wizard-step" data-step="5">
                    <div class="step-title"><span>‚úÖ Zusammenfassung</span></div>
                    <div id="summaryContent"></div>
                </div>
            </div>

            <div class="wizard-nav">
                <button type="button" class="btn btn-back" id="btnBack" onclick="prevStep()" style="display: none;">‚Üê Zur√ºck</button>
                <button type="button" class="btn btn-primary" id="btnNext" onclick="nextStep()">Weiter ‚Üí</button>
            </div>

            <div class="success-message" id="successMessage">
                <div class="icon">‚úÖ</div>
                <h3>Anfrage erfolgreich gesendet!</h3>
                <p>Wir melden uns schnellstm√∂glich mit einem Kostenvoranschlag bei Ihnen.</p>
                <button class="btn btn-primary" onclick="safeNavigate('meine-anfragen.html')">Zu meinen Anfragen</button>
            </div>
        </div>
    </div><!-- End main-layout -->

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <script src="../firebase-config.js?v=a4192c4"></script>
    <script src="../js/settings-manager.js"></script>
    <script src="../js/auth-manager.js"></script>
    <script>
        // Global Variables
        let currentStep = 1;
        const totalSteps = 5;
        let partner = null;
        let photos = [];
        let selectedTermin = null;

        // ============================================
        // PRE-INITIALIZE werkstattId from localStorage
        // ============================================
        // CRITICAL: Set werkstattId BEFORE auth-check polling!
        const storedPartner = JSON.parse(localStorage.getItem('partner') || 'null');
        window.werkstattId = (storedPartner && storedPartner.werkstattId) || 'mosbach';
        console.log('‚úÖ [GLAS-ANFRAGE] werkstattId pre-initialized:', window.werkstattId);

        // AUTH-CHECK POLLING
        let authCheckAttempts = 0;
        const maxAuthCheckAttempts = 20;

        const authCheckInterval = setInterval(async () => {
            authCheckAttempts++;

            if (window.firebaseInitialized && window.werkstattId) {
                clearInterval(authCheckInterval);
                console.log('‚úÖ [GLAS-ANFRAGE] Firebase ready');

                await initAuth();
                await initFirebase();
                setupPhotoUpload();

                // Show step 4 content when reached
                const observer = new MutationObserver(() => {
                    if (currentStep === 4 && !document.getElementById('terminGrid').classList.contains('loaded')) {
                        loadTermine();
                        document.getElementById('terminGrid').classList.add('loaded');
                    }
                });

                observer.observe(document.querySelector('.wizard-container'), {
                    childList: true,
                    subtree: true,
                    attributes: true
                });
            }

            if (authCheckAttempts >= maxAuthCheckAttempts) {
                clearInterval(authCheckInterval);
                console.error('‚ùå [GLAS-ANFRAGE] Firebase initialization timeout');
                showToast('Firebase konnte nicht initialisiert werden. Bitte laden Sie die Seite neu.', 'error');
            }
        }, 250);

        // Auth Check
        async function initAuth() {
            partner = JSON.parse(localStorage.getItem('partner'));

            if (!partner || !partner.id) {
                console.error('‚ùå Partner nicht eingeloggt!');
                showToast('Bitte melden Sie sich zun√§chst an.', 'warning');
                safeNavigate('index.html');
                return;
            }

            // werkstattId initialization (Multi-Tenant)
            if (!partner.werkstattId) {
                console.error('‚ùå Partner-Daten unvollst√§ndig - werkstattId fehlt!');
                showToast('Partner-Daten unvollst√§ndig. Bitte melden Sie sich erneut an.', 'error');
                safeNavigate('index.html');
                return;
            }
            window.werkstattId = partner.werkstattId; // ‚úÖ SECURITY FIX: No 'mosbach' fallback (validated above)
            console.log('‚úÖ [GLAS-ANFRAGE] werkstattId initialized:', window.werkstattId);

            // Display partner name
            document.getElementById('partnerName').textContent = `Partner: ${partner.name}`;

            // Load Werkstatt-Logo & Branding
            (async () => {
                try {
                    const settings = await window.settingsManager.loadSettings();
                    if (settings?.profil) {
                        // Update Page Title
                        document.title = `${settings.profil.name} | Glas-Reparatur`;

                        // Display Logo
                        if (settings.profil.logoUrl) {
                            const logoContainer = document.getElementById('werkstattLogo');
                            if (logoContainer) {
                                logoContainer.innerHTML = `
                                    <img src="${settings.profil.logoUrl}"
                                         alt="${settings.profil.name}"
                                         style="height: 32px; width: auto; vertical-align: middle;">
                                `;
                                console.log('‚úÖ [PARTNER-GLAS-SIMPLIFIED] Werkstatt-Logo angezeigt:', settings.profil.name);
                            }
                        }
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è [PARTNER-GLAS-SIMPLIFIED] Werkstatt-Branding konnte nicht geladen werden:', error);
                }
            })();
        }

        // Initialize Firebase
        async function initFirebase() {
            if (typeof firebase === 'undefined') {
                console.error('Firebase SDK not loaded');
                return;
            }

            // Wait for firebase-config.js to initialize
            if (window.firebaseInitialized) {
                await window.firebaseInitialized;
            }
        }

        // ============================================
        // PROGRESS & NAVIGATION
        // ============================================
        function updateProgress() {
            const percent = (currentStep / totalSteps) * 100;
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = `Schritt ${currentStep} von ${totalSteps}`;
        }

        function updateButtons() {
            const btnBack = document.getElementById('btnBack');
            const btnNext = document.getElementById('btnNext');

            if (currentStep === 1) {
                btnBack.style.display = 'none';
            } else {
                btnBack.style.display = 'inline-flex';
            }

            if (currentStep === totalSteps) {
                btnNext.textContent = 'Anfrage senden';
            } else {
                btnNext.textContent = 'Weiter ‚Üí';
            }
        }

        function updateSidebar() {
            const sidebarSteps = document.querySelectorAll('.sidebar-step');

            sidebarSteps.forEach((step, index) => {
                const stepNumber = index + 1;

                // Remove all state classes
                step.classList.remove('completed', 'active', 'pending');

                // Add appropriate class based on current step
                if (stepNumber < currentStep) {
                    step.classList.add('completed');
                } else if (stepNumber === currentStep) {
                    step.classList.add('active');
                } else {
                    step.classList.add('pending');
                }
            });
        }

        // Validation per Step
        function validateStep(step) {
            switch(step) {
                case 1: // Photos optional for glas
                    return true;

                case 2: // Fahrzeug
                    const kennzeichen = document.getElementById('kennzeichen').value.trim();
                    const marke = document.getElementById('marke').value;
                    const modell = document.getElementById('modell').value.trim();

                    if (!kennzeichen) {
                        showToast('Bitte geben Sie das Kennzeichen ein.', 'warning');
                        return false;
                    }
                    if (!marke || marke === '') {
                        showToast('Bitte w√§hlen Sie die Fahrzeugmarke aus.', 'warning');
                        return false;
                    }
                    if (!modell) {
                        showToast('Bitte geben Sie das Fahrzeugmodell ein.', 'warning');
                        return false;
                    }
                    return true;

                case 3: // Glasart & Schaden
                    const glasArt = document.querySelector('input[name="glasArt"]:checked');
                    if (!glasArt) {
                        showToast('Bitte w√§hlen Sie die Art der Reparatur aus.', 'warning');
                        return false;
                    }
                    const scheibenTyp = document.querySelector('input[name="scheibenTyp"]:checked');
                    if (!scheibenTyp) {
                        showToast('Bitte w√§hlen Sie den Scheibentyp aus.', 'warning');
                        return false;
                    }
                    return true;

                case 4: // Termin
                    if (!selectedTermin) {
                        showToast('Bitte w√§hlen Sie einen Wunschtermin aus.', 'warning');
                        return false;
                    }
                    return true;

                default:
                    return true;
            }
        }

        // Navigation Functions
        function nextStep() {
            // Validate current step
            if (!validateStep(currentStep)) {
                return;
            }

            if (currentStep === totalSteps) {
                submitAnfrage();
                return;
            }

            // Move to next step
            const currentStepEl = document.querySelector(`.wizard-step[data-step="${currentStep}"]`);
            const nextStepEl = document.querySelector(`.wizard-step[data-step="${currentStep + 1}"]`);

            currentStepEl.classList.remove('active');
            currentStepEl.classList.add('prev');

            setTimeout(() => {
                currentStepEl.classList.remove('prev');
            }, 400);

            nextStepEl.classList.add('active');

            currentStep++;
            updateProgress();
            updateButtons();
            updateSidebar();

            // Load termine on step 4
            if (currentStep === 4) {
                loadTermine();
            }

            // Generate summary on step 5
            if (currentStep === totalSteps) {
                generateSummary();
            }

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function prevStep() {
            if (currentStep === 1) return;

            const currentStepEl = document.querySelector(`.wizard-step[data-step="${currentStep}"]`);
            const prevStepEl = document.querySelector(`.wizard-step[data-step="${currentStep - 1}"]`);

            currentStepEl.classList.remove('active');
            prevStepEl.classList.add('active');

            currentStep--;
            updateProgress();
            updateButtons();
            updateSidebar();

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ============================================
        // PHOTO UPLOAD
        // ============================================
        function setupPhotoUpload() {
            const input = document.getElementById('photoInput');
            window.listenerRegistry.registerDOM(input, 'change', handlePhotoUpload, 'input change');
        }

        async function handlePhotoUpload(event) {
            const files = Array.from(event.target.files);

            for (const file of files) {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        photos.push(e.target.result);
                        displayPhotos();
                    };
                    reader.readAsDataURL(file);
                }
            }
        }

        function displayPhotos() {
            const preview = document.getElementById('photoPreview');
            preview.innerHTML = '';

            photos.forEach((photo, index) => {
                const div = document.createElement('div');
                div.className = 'photo-preview-item';
                div.innerHTML = `
                    <img src="${photo}" alt="Foto ${index + 1}">
                    <button type="button" class="remove-btn" onclick="removePhoto(${index})">√ó</button>
                `;
                preview.appendChild(div);
            });
        }

        function removePhoto(index) {
            photos.splice(index, 1);
            displayPhotos();
        }

        // ============================================
        // RADIO OPTION SELECTION
        // ============================================
        function selectGlasArt(element, value) {
            // Remove selected class from all options
            element.closest('.radio-group').querySelectorAll('.radio-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            // Add selected class to clicked option
            element.classList.add('selected');
            // Check the radio input
            element.querySelector('input[type="radio"]').checked = true;
        }

        function selectScheibenTyp(value) {
            // Remove selected class from all options
            document.querySelectorAll('.toggle-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            // Add selected class to clicked option
            const option = document.querySelector(`.toggle-option input[value="${value}"]`).closest('.toggle-option');
            option.classList.add('selected');
            // Check the radio input
            document.querySelector(`input[name="scheibenTyp"][value="${value}"]`).checked = true;
        }

        // ============================================
        // TERMIN SELECTION
        // ============================================
        async function loadTermine() {
            const terminGrid = document.getElementById('terminGrid');

            if (!window.db) {
                console.error('Firebase nicht initialisiert');
                terminGrid.innerHTML = '<div class="loading"><div style="color: red;">Fehler beim Laden der Termine</div></div>';
                return;
            }

            try {
                // üîí SECURITY: Get current user email for Query-Rule Compliance
                const currentUser = firebase.auth().currentUser;
                if (!currentUser) {
                    console.warn('‚ö†Ô∏è User not authenticated yet, skipping calendar load');
                    terminGrid.innerHTML = '<div class="loading"><div>Bitte warten...</div></div>';
                    return;
                }
                const userEmail = currentUser.email.toLowerCase();

                const heute = new Date();
                heute.setHours(0, 0, 0, 0);

                const endDate = new Date(heute);
                endDate.setDate(endDate.getDate() + 21);

                // Query Firestore for existing appointments (filtered by partnerEmail for security)
                const snapshot = await window.getCollection('fahrzeuge')
                    .where('partnerEmail', '==', userEmail)
                    .where('anliefertermin', '>=', heute.toISOString())
                    .where('anliefertermin', '<=', endDate.toISOString())
                    .get();

                // Calculate workload per day
                const auslastung = {};
                snapshot.forEach(doc => {
                    const termin = doc.data().anliefertermin;
                    if (termin) {
                        const date = termin.split('T')[0];
                        auslastung[date] = (auslastung[date] || 0) + 1;
                    }
                });

                // Generate available dates (exclude Sundays)
                const dates = [];
                for (let i = 1; i <= 21; i++) {
                    const date = new Date(heute);
                    date.setDate(date.getDate() + i);
                    if (date.getDay() !== 0) { // Skip Sundays
                        const dateStr = date.toISOString().split('T')[0];
                        const workload = auslastung[dateStr] || 0;
                        dates.push({
                            datum: date,
                            dateStr: dateStr,
                            auslastung: workload === 0 ? 'frei' : workload <= 2 ? 'normal' : 'voll'
                        });
                    }
                }

                // Show 4 intelligently selected dates
                const selectedTermine = [
                    dates.find(d => d.auslastung === 'frei') || dates[0], // First free date
                    dates[Math.floor(dates.length * 0.33)], // ~1 week
                    dates[Math.floor(dates.length * 0.66)], // ~2 weeks
                    dates[dates.length - 1] // Last available
                ];

                terminGrid.innerHTML = selectedTermine.map((t, idx) => {
                    const auslastungIcon = t.auslastung === 'frei' ? 'üü¢' : t.auslastung === 'normal' ? 'üü°' : 'üî¥';
                    const auslastungText = t.auslastung === 'frei' ? 'Freie Kapazit√§t' : t.auslastung === 'normal' ? 'Normale Auslastung' : 'Ausgelastet';
                    const wochentag = t.datum.toLocaleDateString('de-DE', { weekday: 'short' });
                    const tag = t.datum.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });

                    return `
                        <label class="termin-option" onclick="selectTermin('${t.dateStr}')">
                            <input type="radio" name="termin" value="${t.dateStr}">
                            <div class="weekday">${wochentag}</div>
                            <div class="day">${tag}</div>
                            <div class="indicator">${auslastungIcon} ${auslastungText}</div>
                        </label>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading termine:', error);
                terminGrid.innerHTML = '<div class="loading"><div style="color: red;">Fehler beim Laden der Termine</div></div>';
            }
        }

        function selectTermin(dateStr) {
            // Remove previous selection
            document.querySelectorAll('.termin-option').forEach(opt => {
                opt.classList.remove('selected');
            });

            // Select clicked termin
            const option = document.querySelector(`.termin-option input[value="${dateStr}"]`).closest('.termin-option');
            option.classList.add('selected');
            selectedTermin = dateStr;
        }

        // ============================================
        // SUMMARY GENERATION
        // ============================================
        function generateSummary() {
            const glasArt = document.querySelector('input[name="glasArt"]:checked').value;
            const glasArtLabels = {
                'steinschlag': 'üîπ Steinschlag reparieren',
                'riss': '‚ö° Riss/Sprung',
                'ersatz': 'üîÑ Komplett-Austausch'
            };

            const scheibenTyp = document.querySelector('input[name="scheibenTyp"]:checked').value;
            const scheibenTypLabels = {
                'windschutzscheibe': 'üöó Windschutzscheibe',
                'seitenfenster': 'üö™ Seitenfenster',
                'heckscheibe': 'üîô Heckscheibe'
            };

            const sensorVorhanden = document.getElementById('sensorVorhanden').checked;

            const summaryContent = document.getElementById('summaryContent');
            summaryContent.innerHTML = `
                <div class="summary-section">
                    <h3>üöó Fahrzeug</h3>
                    <p><strong>Kennzeichen:</strong> ${document.getElementById('kennzeichen').value}</p>
                    <p><strong>Marke:</strong> ${document.getElementById('marke').value}</p>
                    <p><strong>Modell:</strong> ${document.getElementById('modell').value}</p>
                </div>
                <div class="summary-section">
                    <h3>ü™ü Glasschaden</h3>
                    <p><strong>Art der Reparatur:</strong> ${glasArtLabels[glasArt]}</p>
                    <p><strong>Scheibe:</strong> ${scheibenTypLabels[scheibenTyp]}</p>
                    <p><strong>Regensensor/Spurhalteassistent:</strong> ${sensorVorhanden ? '‚úÖ Ja' : '‚ùå Nein'}</p>
                </div>
                <div class="summary-section">
                    <h3>üìÖ Termin</h3>
                    <p><strong>Wunschtermin:</strong> ${new Date(selectedTermin).toLocaleDateString('de-DE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                    ${document.getElementById('anmerkungen').value ? `
                        <p><strong>Anmerkungen:</strong> ${document.getElementById('anmerkungen').value}</p>
                    ` : ''}
                </div>
                <div class="summary-section">
                    <h3>üì∑ Fotos</h3>
                    <p>${photos.length} Foto(s) hochgeladen</p>
                </div>
            `;
        }

        // ============================================
        // SUBMIT ANFRAGE
        // ============================================
        async function submitAnfrage() {
            const btnNext = document.getElementById('btnNext');
            btnNext.disabled = true;
            btnNext.textContent = 'Wird gesendet...';

            try {
                // Compress photos
                const compressedPhotos = await Promise.all(photos.map(photo => compressImage(photo)));

                // Get form data
                const glasArt = document.querySelector('input[name="glasArt"]:checked').value;
                const scheibenTyp = document.querySelector('input[name="scheibenTyp"]:checked').value;
                const sensorVorhanden = document.getElementById('sensorVorhanden').checked;

                // Create anfrage data
                const anfrageData = {
                    id: 'req_' + Date.now(),
                    partnerId: partner.id,
                    partnerName: partner.name,
                    partnerEmail: firebase.auth().currentUser.email.toLowerCase(),  // ‚úÖ FIX Bug #5L Phase 5f (2025-11-23): Security Rule requires partnerEmail
                    serviceTyp: 'glas',
                    serviceData: {
                        // üîß BUGFIX 2025-11-06: Use field names expected by KVA (art, typ, sensor)
                        art: glasArt,              // steinschlag | riss | ersatz
                        typ: scheibenTyp,          // windschutzscheibe | seitenfenster | heckscheibe
                        sensor: sensorVorhanden,   // boolean

                        // üîÑ BACKWARDS COMPATIBILITY: Keep old field names for existing code
                        glasArt: glasArt,
                        scheibenTyp: scheibenTyp,
                        sensorVorhanden: sensorVorhanden,

                        // üìã DISPLAY: Additional fields for KVA service details box
                        scheibe: scheibenTyp,      // Duplicate of typ for display
                        info: document.getElementById('anmerkungen').value.trim()
                    },
                    kennzeichen: document.getElementById('kennzeichen').value.trim(),
                    marke: document.getElementById('marke').value,
                    modell: document.getElementById('modell').value.trim(),
                    anliefertermin: selectedTermin,
                    anmerkungen: document.getElementById('anmerkungen').value.trim(),
                    fotos: compressedPhotos,
                    status: 'neu',
                    timestamp: new Date().toISOString()
                };

                // Save to Firestore
                await window.getCollection('partnerAnfragen').doc(anfrageData.id).set(anfrageData);

                // Show success message
                document.getElementById('successMessage').style.display = 'flex';
                document.querySelector('.wizard-container').style.display = 'none';
                document.querySelector('.wizard-nav').style.display = 'none';

            } catch (error) {
                console.error('Error submitting anfrage:', error);
                showToast('Fehler beim Senden der Anfrage: ' + error.message, 'error');
                btnNext.disabled = false;
                btnNext.textContent = 'Anfrage senden';
            }
        }

        // ============================================
        // IMAGE COMPRESSION
        // ============================================
        function compressImage(base64Image) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');

                    // Max dimensions
                    const maxWidth = 1920;
                    const maxHeight = 1080;

                    let width = img.width;
                    let height = img.height;

                    if (width > maxWidth || height > maxHeight) {
                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                        width = width * ratio;
                        height = height * ratio;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);

                    // Compress to 85% quality
                    resolve(canvas.toDataURL('image/jpeg', 0.85));
                };
                img.src = base64Image;
            });
        }

        // Theme Toggle Function
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme') || 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            const btnToggle = document.getElementById('btnThemeToggle');
            if (btnToggle) {
                btnToggle.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            }
        }

        // Initialize Theme on Load
        (function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            const btnToggle = document.getElementById('btnThemeToggle');
            if (btnToggle) {
                btnToggle.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            }
        })();
    </script>
    <script src="../listener-registry.js"></script>
    <script src="../error-handler.js"></script>
</body>
</html>
