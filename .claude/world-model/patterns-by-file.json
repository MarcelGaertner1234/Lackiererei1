{
  "_meta": {
    "description": "Welche Patterns gelten für welche Dateien",
    "version": "1.0",
    "lastUpdated": "2025-12-11",
    "usage": "Vor dem Editieren einer Datei diese Patterns prüfen!"
  },

  "patterns": {
    "multi-tenant": {
      "description": "window.getCollection() statt db.collection()",
      "rule": ".claude/rules/multi-tenant-patterns.md",
      "appliesTo": [
        "*.html (außer static pages)",
        "js/*.js (außer utils)",
        "partner-app/*.html",
        "functions/index.js"
      ],
      "excludes": ["landing.html", "agb.html", "datenschutz.html", "impressum.html", "kontakt.html"]
    },

    "firebase-init": {
      "description": "await window.firebaseInitialized vor Firebase-Ops",
      "rule": ".claude/rules/firebase-patterns.md",
      "appliesTo": [
        "*.html (mit Firebase)",
        "js/*.js (mit Firebase)"
      ],
      "codePattern": "await window.firebaseInitialized;"
    },

    "serviceTyp-readonly": {
      "description": "serviceTyp NIEMALS nach Erstellung ändern",
      "rule": ".claude/rules/common-gotchas.md#gotcha-5",
      "appliesTo": [
        "kanban.html",
        "annahme.html",
        "liste.html",
        "abnahme.html"
      ],
      "severity": "CRITICAL - DATA LOSS!"
    },

    "listener-registry": {
      "description": "Memory Leak Prevention mit listenerRegistry",
      "rule": ".claude/rules/firebase-patterns.md",
      "appliesTo": [
        "kanban.html",
        "liste.html",
        "wissensdatenbank.html",
        "alle mit onSnapshot()"
      ],
      "codePattern": "window.listenerRegistry?.add(unsubscribe);"
    },

    "null-safety": {
      "description": "Optional chaining und Fallbacks",
      "rule": ".claude/rules/common-gotchas.md#gotcha-2",
      "appliesTo": [
        "annahme.html",
        "tagesplanung.html",
        "alle mit querySelector"
      ],
      "codePattern": "element?.value || 'default'"
    },

    "double-click-prevention": {
      "description": "Button disable während async",
      "rule": ".claude/rules/common-gotchas.md#gotcha-4",
      "appliesTo": [
        "annahme.html",
        "entwuerfe-bearbeiten.html",
        "partner-app/kva-erstellen.html",
        "alle mit Submit-Buttons"
      ],
      "codePattern": "btn.disabled = true; try { await ... } finally { btn.disabled = false; }"
    },

    "timestamp-handling": {
      "description": "Firestore Timestamps konsistent",
      "rule": ".claude/rules/firebase-patterns.md",
      "appliesTo": [
        "abnahme.html",
        "kanban.html",
        "alle mit Datum-Feldern"
      ],
      "codePattern": "firebase.firestore.Timestamp.now()"
    },

    "xss-prevention": {
      "description": "escapeHtml() für User-Input",
      "rule": ".claude/rules/common-gotchas.md",
      "appliesTo": [
        "partner-app/kva-erstellen.html",
        "annahme.html",
        "alle mit User-Input Display"
      ],
      "codePattern": "escapeHtml(userInput)"
    },

    "partner-auth": {
      "description": "Partner haben KEIN Firebase Auth",
      "appliesTo": [
        "partner-app/*.html"
      ],
      "note": "Spezielle Auth-Logik über partnerAutoLoginTokens"
    },

    "werkstatt-daten-embed": {
      "description": "werkstattDaten in Dokumente embedden",
      "appliesTo": [
        "partner-app/meine-anfragen.html",
        "functions/index.js (onNewPartnerAnfrage)"
      ],
      "reason": "Partner können settings Collection nicht lesen"
    },

    "bounds-check": {
      "description": "Array bounds prüfen vor Zugriff",
      "appliesTo": [
        "tagesplanung.html",
        "kanban.html",
        "alle mit Array-Operationen"
      ],
      "codePattern": "if (index >= 0 && index < array.length)"
    },

    "type-safe-ids": {
      "description": "String() für ID-Vergleiche",
      "rule": ".claude/rules/multi-tenant-patterns.md",
      "appliesTo": [
        "liste.html",
        "kanban.html",
        "alle mit find() auf IDs"
      ],
      "codePattern": "String(v.id) === String(vehicleId)"
    }
  },

  "file_pattern_map": {
    "annahme.html": [
      "multi-tenant",
      "firebase-init",
      "serviceTyp-readonly",
      "null-safety",
      "double-click-prevention",
      "xss-prevention"
    ],
    "kanban.html": [
      "multi-tenant",
      "firebase-init",
      "serviceTyp-readonly",
      "listener-registry",
      "bounds-check",
      "type-safe-ids"
    ],
    "liste.html": [
      "multi-tenant",
      "firebase-init",
      "listener-registry",
      "type-safe-ids"
    ],
    "tagesplanung.html": [
      "multi-tenant",
      "firebase-init",
      "bounds-check",
      "null-safety"
    ],
    "abnahme.html": [
      "multi-tenant",
      "firebase-init",
      "timestamp-handling"
    ],
    "entwuerfe-bearbeiten.html": [
      "multi-tenant",
      "firebase-init",
      "double-click-prevention"
    ],
    "kalkulation.html": [
      "multi-tenant",
      "firebase-init"
    ],
    "partner-app/meine-anfragen.html": [
      "multi-tenant",
      "partner-auth",
      "werkstatt-daten-embed"
    ],
    "partner-app/kva-erstellen.html": [
      "multi-tenant",
      "partner-auth",
      "xss-prevention",
      "double-click-prevention"
    ],
    "partner-app/*-anfrage.html": [
      "multi-tenant",
      "partner-auth",
      "null-safety"
    ],
    "functions/index.js": [
      "multi-tenant",
      "werkstatt-daten-embed"
    ],
    "js/auth-manager.js": [
      "firebase-init"
    ],
    "firebase-config.js": [
      "multi-tenant"
    ]
  },

  "quick_lookup": {
    "description": "Schnelle Suche: Welche Patterns für aktuelle Arbeit?",
    "if_editing_html": ["multi-tenant", "firebase-init", "null-safety"],
    "if_editing_kanban": ["serviceTyp-readonly", "listener-registry", "bounds-check"],
    "if_editing_partner_app": ["partner-auth", "werkstatt-daten-embed", "xss-prevention"],
    "if_editing_with_forms": ["double-click-prevention", "null-safety"],
    "if_editing_with_dates": ["timestamp-handling"],
    "if_editing_with_listeners": ["listener-registry"]
  }
}
