{
  "_meta": {
    "description": "Abhängigkeits-Graph der Codebase",
    "version": "2.2",
    "lastUpdated": "2025-12-16",
    "totalCollections": 35,
    "totalStatusValues": 15,
    "documentedPages": 15,
    "changelog_v2.2": "Fixed kalender→calendar, updated XSS note for kva-erstellen.html"
  },

  "core_dependencies": {
    "description": "Diese Dateien werden von fast allen anderen verwendet",
    "files": {
      "firebase-config.js": {
        "dependents": ["ALLE HTML-Dateien mit Firebase"],
        "provides": ["db", "auth", "storage", "getCollection", "firebaseInitialized", "werkstattId"],
        "impact": "CRITICAL - Änderungen betreffen gesamte App"
      },
      "js/auth-manager.js": {
        "dependents": ["ALLE authentifizierten Seiten"],
        "provides": ["AuthManager", "checkAuth", "getCurrentUser"],
        "impact": "CRITICAL - Auth-Änderungen betreffen Login/Logout"
      },
      "js/service-types.js": {
        "dependents": ["annahme.html", "kanban.html", "liste.html", "partner-app/*-anfrage.html"],
        "provides": ["SERVICE_TYPES", "normalizeAndValidateServiceType", "getServiceTypeLabel"],
        "impact": "HIGH - Service-Typ-Änderungen betreffen Workflow"
      },
      "listener-registry.js": {
        "dependents": ["kanban.html", "liste.html", "alle mit onSnapshot"],
        "provides": ["listenerRegistry"],
        "impact": "MEDIUM - Memory Leak bei Änderungen"
      }
    }
  },

  "page_dependencies": {
    "annahme.html": {
      "imports": [
        "firebase-config.js",
        "js/auth-manager.js",
        "js/service-types.js",
        "js/settings-manager.js",
        "js/damage-labeler.js"
      ],
      "collections_used": ["fahrzeuge", "partnerAnfragen", "settings"],
      "cloud_functions_called": ["parseDATPDF"]
    },
    "kanban.html": {
      "imports": [
        "firebase-config.js",
        "js/auth-manager.js",
        "js/service-types.js",
        "listener-registry.js",
        "js/work-timer.js"
      ],
      "collections_used": ["fahrzeuge", "partnerAnfragen"],
      "realtime_listeners": true,
      "note": "Komplexeste Datei - höchstes Bug-Risiko"
    },
    "liste.html": {
      "imports": [
        "firebase-config.js",
        "js/auth-manager.js",
        "js/service-types.js",
        "listener-registry.js"
      ],
      "collections_used": ["fahrzeuge"],
      "realtime_listeners": true
    },
    "tagesplanung.html": {
      "imports": [
        "firebase-config.js",
        "js/auth-manager.js",
        "js/service-types.js"
      ],
      "collections_used": ["fahrzeuge"],
      "note": "Bounds-Check kritisch bei Array-Operationen"
    },
    "kalkulation.html": {
      "imports": [
        "firebase-config.js",
        "js/auth-manager.js",
        "ersatzteile-db.js"
      ],
      "collections_used": ["fahrzeuge", "ersatzteile"],
      "note": "Größte Datei (21k Zeilen) - Preisberechnung kritisch"
    },
    "partner-app/meine-anfragen.html": {
      "imports": [
        "firebase-config.js",
        "partner-chat-notifications.js"
      ],
      "collections_used": ["partnerAnfragen"],
      "note": "KEIN auth-manager - Partner haben eigene Auth!"
    },
    "partner-app/kva-erstellen.html": {
      "imports": [
        "firebase-config.js",
        "js/kva-erstellen.js"
      ],
      "collections_used": ["partnerAnfragen"],
      "note": "XSS-Prevention kritisch bei User-Input (FIXED 2025-12-16: escapeHtml implementiert)"
    },
    "material.html": {
      "imports": [
        "firebase-config.js",
        "js/auth-manager.js"
      ],
      "collections_used": ["materialRequests", "bestellungen", "ersatzteile", "calendar"],
      "gitCommits": 79,
      "note": "Material-Management - Phase 1L Fixes. FIX 2025-12-16: kalender → calendar"
    },
    "dienstplan.html": {
      "imports": [
        "firebase-config.js",
        "js/auth-manager.js"
      ],
      "collections_used": ["schichten", "schichtTypen", "mitarbeiter", "bereiche", "schichtWuensche", "schichtTausche"],
      "gitCommits": 36,
      "note": "Schichtplanung - Phase 1N (10 Fixes)"
    },
    "mitarbeiter-verwaltung.html": {
      "imports": [
        "firebase-config.js",
        "js/auth-manager.js"
      ],
      "collections_used": ["mitarbeiter", "zeiterfassung", "lohnabrechnungen", "urlaubsAnfragen"],
      "getCollectionUses": 31,
      "note": "Komplexe Mitarbeiter-Verwaltung"
    },
    "admin-bonus-auszahlungen.html": {
      "imports": [
        "firebase-config.js",
        "js/auth-manager.js"
      ],
      "collections_used": ["bonusAuszahlungen", "partners"]
    },
    "rechnungen-admin.html": {
      "imports": [
        "firebase-config.js",
        "js/auth-manager.js"
      ],
      "collections_used": ["fahrzeuge", "partnerAnfragen", "partners", "counters", "leihfahrzeuge", "kalenderEvents"],
      "note": "Rechnungs-Pipeline - Optimistic Locking"
    },
    "wissensdatenbank.html": {
      "imports": [
        "firebase-config.js",
        "js/auth-manager.js",
        "listener-registry.js"
      ],
      "collections_used": ["guidelines", "announcements", "shift_handovers", "demontage_anleitungen", "categories"],
      "note": "Wissensdatenbank - Phase 1P (5 Fixes)"
    },
    "admin-einstellungen.html": {
      "imports": [
        "firebase-config.js",
        "js/auth-manager.js",
        "js/settings-manager.js"
      ],
      "collections_used": ["fahrzeuge", "kunden", "mitarbeiter", "einstellungen", "settings"]
    },
    "leihfahrzeuge.html": {
      "imports": [
        "firebase-config.js",
        "js/auth-manager.js"
      ],
      "collections_used": ["leihfahrzeugPool", "leihfahrzeugAnfragen", "leihfahrzeugBuchungen"],
      "note": "Leihfahrzeug-System - Phase 1O (5 Fixes)"
    }
  },

  "collection_usage": {
    "fahrzeuge": {
      "read": ["liste.html", "kanban.html", "annahme.html", "abnahme.html", "tagesplanung.html", "kalkulation.html"],
      "write": ["annahme.html", "kanban.html", "abnahme.html", "tagesplanung.html", "kalkulation.html"],
      "realtime": ["kanban.html", "liste.html"],
      "criticalPatterns": ["multi-tenant", "serviceTyp-readonly"]
    },
    "partnerAnfragen": {
      "read": ["partner-app/meine-anfragen.html", "partner-app/anfrage-detail.html", "kanban.html"],
      "write": ["partner-app/*-anfrage.html", "partner-app/kva-erstellen.html", "annahme.html"],
      "criticalPatterns": ["multi-tenant", "partner-auth", "werkstatt-daten-embed"]
    },
    "users": {
      "read": ["nutzer-verwaltung.html", "auth-manager.js"],
      "write": ["nutzer-verwaltung.html", "registrierung.html"],
      "note": "Globale Collection - KEIN Multi-Tenant Suffix!"
    },
    "settings": {
      "read": ["admin-einstellungen.html", "settings-manager.js"],
      "write": ["admin-einstellungen.html"],
      "note": "Globale Collection - KEIN Multi-Tenant Suffix!"
    },
    "mitarbeiter": {
      "read": ["mitarbeiter-verwaltung.html", "dienstplan.html"],
      "write": ["mitarbeiter-verwaltung.html"],
      "criticalPatterns": ["multi-tenant"]
    },
    "arbeitszeiten": {
      "read": ["admin-arbeitszeiten.html", "admin-datenqualitaet.html"],
      "write": ["work-timer.js"],
      "note": "Neu: AGI Training Data",
      "criticalPatterns": ["multi-tenant"]
    }
  },

  "cloud_function_callers": {
    "onStatusChange": {
      "trigger": "firestore.document('fahrzeuge_{werkstattId}/{docId}').onUpdate",
      "calledBy": "Automatisch bei Status-Änderung"
    },
    "parseDATPDF": {
      "calledBy": ["annahme.html"],
      "requires": "OPENAI_API_KEY"
    },
    "createPartnerAutoLoginToken": {
      "calledBy": ["partner-app/auto-login.html", "admin-einstellungen.html"]
    },
    "exportAllTrainingData": {
      "calledBy": ["admin-datenqualitaet.html"],
      "requires": "admin role"
    }
  },

  "cascade_effects": {
    "description": "Wenn Datei X geändert wird, prüfe auch Y",
    "firebase-config.js": ["ALLE Firebase-nutzenden Dateien"],
    "js/service-types.js": ["annahme.html", "kanban.html", "liste.html", "partner-app/*"],
    "js/auth-manager.js": ["ALLE authentifizierten Seiten"],
    "listener-registry.js": ["kanban.html", "liste.html"],
    "firestore.rules": ["ALLE Firebase-Operationen - Security!"]
  },

  "collection_usage_stats": {
    "description": "Collection-Nutzungshäufigkeit aus Code-Analyse",
    "fahrzeuge": { "usageCount": 154, "rank": 1 },
    "partnerAnfragen": { "usageCount": 96, "rank": 2 },
    "mitarbeiter": { "usageCount": 39, "rank": 3 },
    "partners": { "usageCount": 20, "rank": 4 },
    "bestellungen": { "usageCount": 20, "rank": 4 },
    "schichten": { "usageCount": 19, "rank": 6 },
    "materialRequests": { "usageCount": 17, "rank": 7 },
    "kunden": { "usageCount": 15, "rank": 8 },
    "schichtTypen": { "usageCount": 14, "rank": 9 },
    "ersatzteile": { "usageCount": 12, "rank": 10 }
  },

  "status_values": {
    "description": "Alle verwendeten Status-Werte in der App",
    "fahrzeug_status": ["neu", "angenommen", "in_arbeit", "fertig", "bereit_zur_abholung", "abgeschlossen", "storniert"],
    "partner_anfrage_status": ["neu", "warte_kva", "kva_gesendet", "beauftragt", "abgelehnt", "storniert"],
    "material_status": ["pending", "bestellt", "geliefert", "storniert"],
    "schicht_status": ["active", "inactive"],
    "leihfahrzeug_status": ["verfuegbar", "reserviert", "ausgegeben", "zurueckgegeben"]
  },

  "status_transitions": {
    "description": "Erlaubte Status-Übergänge (Status-Gating)",
    "fahrzeug": {
      "neu": ["angenommen", "storniert"],
      "angenommen": ["in_arbeit", "storniert"],
      "in_arbeit": ["fertig", "angenommen"],
      "fertig": ["bereit_zur_abholung", "in_arbeit"],
      "bereit_zur_abholung": ["abgeschlossen"],
      "abgeschlossen": [],
      "storniert": []
    }
  }
}
