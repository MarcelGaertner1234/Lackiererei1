{
  "_meta": {
    "description": "Bug-Hotspots - Dateien mit hohem Bug-Risiko basierend auf Git-Historie",
    "version": "2.7",
    "lastUpdated": "2026-01-10",
    "source": "Git commit history analysis + Bug-Fix Sprint 2026-01-09/10",
    "recentUpdate": "Bug-Fixes ce9ebdc (Memory Leak + Security) + Test-Verifizierung",
    "testResults": {
      "date": "2026-01-10",
      "smoke": "78/78 (100%)",
      "integration": "364/368 (98.9%)",
      "e2e": "12/12 (100%)",
      "total": "454/458 (99.1%)",
      "failedTests": "4 Performance-Timeouts (keine Code-Bugs)"
    }
  },

  "risk_levels": {
    "critical": "Häufige Bugs, komplexe Logik, viele Abhängigkeiten",
    "high": "Regelmäßige Fixes nötig, mittlere Komplexität",
    "medium": "Gelegentliche Bugs, überschaubare Komplexität",
    "low": "Selten Probleme, einfache Logik"
  },

  "hotspots": {
    "partner-app/meine-anfragen.html": {
      "risk": "critical",
      "lines": 9900,
      "gitCommits": 335,
      "note": "MOST MODIFIED FILE IN ENTIRE CODEBASE!",
      "recentFixes": [
        "Paginierung mit 'Mehr laden' Button (2026-01-09)",
        "Multi-tenant Collection Access",
        "Partner Status Updates",
        "Chat Integration"
      ],
      "commonBugTypes": [
        "Complex partner workflow logic",
        "Multi-tenant violations",
        "Status sync between collections"
      ],
      "preventionPatterns": [
        "ALWAYS use getCollection()",
        "Verify partner context before operations",
        "Sync fahrzeuge AND partnerAnfragen"
      ]
    },

    "kanban.html": {
      "risk": "critical",
      "lines": 11560,
      "bugCount": 21,
      "recentFixes": [
        "Undo-Funktion mit 30s Toast (2026-01-09)",
        "Auftragsstart Fallback-Chain (2025-12-17)",
        "48h-Filter bei Verschiebung",
        "Background Sync Tracker",
        "Drag & Drop Race Conditions",
        "serviceTyp Überschreiben",
        "Listener Memory Leaks"
      ],
      "commonBugTypes": [
        "Race Conditions bei Drag & Drop",
        "serviceTyp wird überschrieben (DATA LOSS!)",
        "Memory Leaks durch nicht aufgeräumte Listener",
        "Sync-Fehler zwischen fahrzeuge und partnerAnfragen"
      ],
      "preventionPatterns": [
        "NIEMALS serviceTyp ändern",
        "IMMER listenerRegistry verwenden",
        "Background Sync Tracker für stille Fehler",
        "Optimistic UI mit Rollback bei Fehler"
      ]
    },

    "tagesplanung.html": {
      "risk": "high",
      "lines": 6300,
      "bugCount": 16,
      "recentFixes": [
        "Kapazitäts-Warnung Toast bei Überschreitung (2026-01-09)",
        "Auftragsstart Fallback-Chain + abholdatum/abholzeit (2025-12-17)",
        "T1 & T2 bounds check",
        "null-checks für Verschieben-Feature",
        "Array Index Out of Bounds"
      ],
      "commonBugTypes": [
        "Array bounds nicht geprüft",
        "null/undefined bei leeren Arrays",
        "Verschieben-Logik komplex"
      ],
      "preventionPatterns": [
        "IMMER bounds check bei Array-Zugriff",
        "Optional chaining (?.) verwenden",
        "Leere Arrays separat behandeln"
      ]
    },

    "annahme.html": {
      "risk": "high",
      "lines": 10724,
      "bugCount": 12,
      "recentFixes": [
        "Neuwagen ohne Kennzeichen - 'Provisorisch' Option (2026-01-09)",
        "querySelector Null-Checks",
        "Radio Button Crash",
        "Double-Click Prevention"
      ],
      "openIssues": [
        {
          "issue": "Foto-Upload funktioniert nicht in Safari/Mac",
          "symptom": "Klick auf '+ Foto hinzufügen' tut nichts, keine Fehlermeldung",
          "rootCause": "Browser-Sicherheitseinschränkung bei programmatischem input.click()",
          "workaround": "Anderen Browser verwenden (Chrome/Firefox)",
          "status": "TODO: Safari-kompatiblen Fallback implementieren",
          "added": "2025-12-16"
        }
      ],
      "commonBugTypes": [
        "querySelector null wenn Element fehlt",
        "Radio buttons ohne Auswahl",
        "Async-Operationen laufen doppelt",
        "Browser-spezifische File-Input Restrictions"
      ],
      "preventionPatterns": [
        "?.value || 'default' für Radio Buttons",
        "Button disable während async",
        "Optional chaining für DOM-Queries",
        "File-Input: User-initiated click events verwenden"
      ]
    },

    "entwuerfe-bearbeiten.html": {
      "risk": "high",
      "lines": 7009,
      "bugCount": 5,
      "recentFixes": [
        "Keine 2 Preise mehr ohne Ersatzteile",
        "Preis-Konsistenz"
      ],
      "commonBugTypes": [
        "Preis-Logik inkonsistent",
        "Ersatzteile-Handling"
      ],
      "preventionPatterns": [
        "Preis-Validierung vor Speichern",
        "Ersatzteile-Array prüfen"
      ]
    },

    "kalkulation.html": {
      "risk": "high",
      "lines": 21693,
      "bugCount": 6,
      "recentFixes": [
        "Preisberechnung",
        "Ersatzteile-Integration"
      ],
      "commonBugTypes": [
        "Numerische Präzision (Floats)",
        "Summen-Berechnung falsch",
        "Ersatzteile nicht synchron"
      ],
      "preventionPatterns": [
        "toFixed(2) für Preise",
        "parseFloat mit Fallback",
        "Ersatzteile-Summe separat validieren"
      ]
    },

    "partner-app/kva-erstellen.html": {
      "risk": "high",
      "lines": 10051,
      "bugCount": 5,
      "recentFixes": [
        "KVA-Varianten Erklärungen (Original/Zubehör/Partner) (2026-01-09)",
        "XSS Protection",
        "Dead Code Cleanup"
      ],
      "commonBugTypes": [
        "XSS bei User-Input",
        "Ungültige Eingaben"
      ],
      "preventionPatterns": [
        "escapeHtml() für alle User-Inputs",
        "Input-Validation serverseitig wiederholen"
      ]
    },

    "functions/index.js": {
      "risk": "high",
      "bugCount": 5,
      "recentFixes": [
        "Status-Mapping bereit_zur_abholung",
        "Email-Retry-Logik"
      ],
      "commonBugTypes": [
        "Status-Mapping unvollständig",
        "Email-Fehler nicht geloggt",
        "Rate Limiting"
      ],
      "preventionPatterns": [
        "ALLE Status in Mapping aufnehmen",
        "Fehler immer loggen",
        "Retry mit exponential backoff"
      ]
    },

    "firebase-config.js": {
      "risk": "high",
      "lines": 1799,
      "bugCount": 2,
      "note": "Core Firebase-Wrapper - Alle HTML-Dateien abhängig",
      "recentFixes": [
        "Cascade Delete für Sub-Collections (fotos, statusHistory) (2026-01-09)"
      ],
      "commonBugTypes": [
        "Sub-Collections werden nicht gelöscht (Orphans)",
        "Async ohne await"
      ],
      "preventionPatterns": [
        "Bei Delete IMMER Sub-Collections prüfen",
        "Batch-Delete für Performance",
        "Alle Async-Ops mit await"
      ]
    },

    "js/mitarbeiter-notifications.js": {
      "risk": "low",
      "lines": 360,
      "bugCount": 1,
      "recentFixes": [
        "async + await für markAsRead in Click-Handler (2026-01-09)"
      ],
      "commonBugTypes": [
        "Event Handler ohne async"
      ],
      "preventionPatterns": [
        "Click-Handler mit async Firestore-Ops müssen async sein",
        "await vor allen Firestore-Operationen"
      ]
    },

    "liste.html": {
      "risk": "medium",
      "lines": 4069,
      "bugCount": 3,
      "commonBugTypes": [
        "Filter-Logik",
        "Listener nicht aufgeräumt"
      ],
      "preventionPatterns": [
        "listenerRegistry verwenden",
        "Filter-State konsistent halten"
      ]
    },

    "wissensdatenbank.html": {
      "risk": "medium",
      "lines": 3786,
      "bugCount": 7,
      "recentFixes": [
        "missing unsubscribeDemontage()",
        "Phase 1P: 5 Double-Click Prevention fixes"
      ],
      "commonBugTypes": [
        "Listener nicht aufgeräumt",
        "Double-click vulnerabilities"
      ],
      "preventionPatterns": [
        "Alle unsubscribe-Funktionen aufrufen",
        "Button disable during async"
      ]
    },

    "dienstplan.html": {
      "risk": "high",
      "lines": 3634,
      "bugCount": 10,
      "note": "Phase 1N - Major bug fix wave (2025-12-11+)",
      "recentFixes": [
        "Phase 1N: 10 Double-Click Prevention fixes",
        "Type-safe ID comparisons (37 uses)"
      ],
      "commonBugTypes": [
        "Double-click vulnerabilities",
        "ID type mismatches",
        "Complex shift management logic"
      ],
      "preventionPatterns": [
        "Button disable during async",
        "String() for ID comparisons",
        "Validate shift data before save"
      ]
    },

    "material.html": {
      "risk": "medium",
      "lines": 6000,
      "gitCommits": 79,
      "bugCount": 5,
      "note": "Phase 1L - Recent fixes",
      "recentFixes": [
        "Phase 1L: 5 bug fixes",
        "Material request workflow"
      ],
      "commonBugTypes": [
        "Material inventory sync",
        "Order status updates"
      ],
      "preventionPatterns": [
        "Validate inventory before operations",
        "Sync calendar with material orders"
      ]
    },

    "mitarbeiter-verwaltung.html": {
      "risk": "medium",
      "lines": 5900,
      "getCollectionUses": 31,
      "recentFixes": [
        "Mitarbeiter-Löschung Cascade-Check für aktive Fahrzeuge (2026-01-09)"
      ],
      "commonBugTypes": [
        "Complex employee data logic",
        "Role permission checks",
        "Cascade-Delete ohne Prüfung"
      ],
      "preventionPatterns": [
        "Validate role before operations",
        "Use getCollection() consistently",
        "Prüfe Referenzen vor dem Löschen"
      ]
    },

    "rechnungen-admin.html": {
      "risk": "medium",
      "lines": 3500,
      "recentFixes": [
        "Rechnungsstornierung Funktion mit Storno-Status (2026-01-09)"
      ],
      "commonBugTypes": [
        "Rechnungsnummer Race Condition (behoben mit Transaction)"
      ],
      "preventionPatterns": [
        "runTransaction für Nummernvergabe",
        "Double-Click Prevention bei Create"
      ]
    },

    "pending-registrations.html": {
      "risk": "high",
      "lines": 1500,
      "recentFixes": [
        "Partner-Ablehnung: Soft-Delete statt permanentes Löschen (2026-01-09)"
      ],
      "commonBugTypes": [
        "Permanentes Löschen ohne Recovery-Option"
      ],
      "preventionPatterns": [
        "Soft-Delete mit abgelehnt-Status",
        "Reaktivieren-Button für abgelehnte Partner"
      ]
    },

    "admin-einstellungen.html": {
      "risk": "medium",
      "lines": 4000,
      "recentFixes": [
        "Service-Deaktivierung Warnung bei aktiven Fahrzeugen (2026-01-09)"
      ],
      "commonBugTypes": [
        "Service deaktivieren ohne Bestandsprüfung"
      ],
      "preventionPatterns": [
        "Prüfe aktive Fahrzeuge vor Service-Deaktivierung",
        "Zeige Warnung mit Anzahl betroffener Fahrzeuge"
      ]
    },

    "abnahme.html": {
      "risk": "high",
      "lines": 3800,
      "recentFixes": [
        "Partielle Abnahme für Multi-Service Fahrzeuge (2026-01-09)"
      ],
      "commonBugTypes": [
        "All-or-Nothing bei Multi-Service",
        "Service-Status nicht synchron"
      ],
      "preventionPatterns": [
        "Separate Abnahme pro Service ermöglichen",
        "Haupt-Status erst bei ALLEN Services 'fertig' ändern"
      ]
    },

    "leihfahrzeuge.html": {
      "risk": "medium",
      "lines": 2500,
      "recentFixes": [
        "LF-BUG-1: formatKategorie Early Global Export (2025-12-27)",
        "6x Syntax-Fehler: if ohne Body (if (x) // comment)"
      ],
      "commonBugTypes": [
        "Funktion zu spät definiert (nach Auth-Redirect)",
        "if-Statement nur mit Kommentar als Body"
      ],
      "preventionPatterns": [
        "Early Global Exports am Anfang der Datei",
        "Auskommentieren: // if(...) statt if(...) //"
      ]
    }
  },

  "patterns_causing_most_bugs": {
    "1_multi_tenant": {
      "description": "Direkter db.collection() statt window.getCollection()",
      "occurrences": 99,
      "note": "99 direct db.collection() calls across 28 files (some in migrations/admin = acceptable)",
      "severity": "critical",
      "files": ["kanban.html", "annahme.html", "liste.html", "partner-app/meine-anfragen.html"]
    },
    "2_null_checks": {
      "description": "Fehlende null/undefined Checks",
      "occurrences": 15,
      "severity": "high",
      "files": ["annahme.html", "tagesplanung.html", "kanban.html"]
    },
    "3_async_handling": {
      "description": "Double-Click, Race Conditions, fehlende awaits",
      "occurrences": 8,
      "severity": "high",
      "files": ["annahme.html", "kanban.html", "entwuerfe-bearbeiten.html"]
    },
    "4_listener_leaks": {
      "description": "Firestore Listener nicht aufgeräumt",
      "occurrences": 6,
      "severity": "medium",
      "files": ["kanban.html", "liste.html", "wissensdatenbank.html"]
    },
    "5_service_typ": {
      "description": "serviceTyp nach Erstellung geändert",
      "occurrences": 3,
      "severity": "critical",
      "files": ["kanban.html"]
    }
  },

  "safe_files": {
    "description": "Dateien mit geringem Bug-Risiko",
    "files": [
      "landing.html",
      "agb.html",
      "datenschutz.html",
      "impressum.html",
      "kontakt.html",
      "js/toast.js",
      "js/utils/escape-html.js"
    ],
    "reason": "Statische Seiten oder einfache Utilities ohne Firebase"
  },

  "console_log_hotspots": {
    "description": "Dateien mit vielen console.logs - Performance-Kandidaten für Cleanup",
    "total": 4327,
    "files": [
      { "file": "partner-app/meine-anfragen.html", "count": 388 },
      { "file": "functions/index.js", "count": 279 },
      { "file": "partner-app/anfrage-detail.html", "count": 267 },
      { "file": "kanban.html", "count": 263 },
      { "file": "annahme.html", "count": 237 },
      { "file": "kalkulation.html", "count": 184 },
      { "file": "entwuerfe-bearbeiten.html", "count": 163 },
      { "file": "partner-app/js/kva-erstellen.js", "count": 150 },
      { "file": "index.html", "count": 124 },
      { "file": "debug-urlaubsanfragen.js", "count": 108 }
    ],
    "analysisDate": "2025-12-23",
    "cleanupHistory": [
      { "date": "2025-12-23", "files": ["meine-anfragen.html", "annahme.html", "kanban.html"], "removed": 126 }
    ]
  }
}
