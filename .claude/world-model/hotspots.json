{
  "_meta": {
    "description": "Bug-Hotspots - Dateien mit hohem Bug-Risiko basierend auf Git-Historie",
    "version": "2.2",
    "lastUpdated": "2025-12-23",
    "source": "Git commit history analysis + Explore agent verification"
  },

  "risk_levels": {
    "critical": "Häufige Bugs, komplexe Logik, viele Abhängigkeiten",
    "high": "Regelmäßige Fixes nötig, mittlere Komplexität",
    "medium": "Gelegentliche Bugs, überschaubare Komplexität",
    "low": "Selten Probleme, einfache Logik"
  },

  "hotspots": {
    "partner-app/meine-anfragen.html": {
      "risk": "critical",
      "lines": 9874,
      "gitCommits": 334,
      "note": "MOST MODIFIED FILE IN ENTIRE CODEBASE!",
      "recentFixes": [
        "Multi-tenant Collection Access",
        "Partner Status Updates",
        "Chat Integration"
      ],
      "commonBugTypes": [
        "Complex partner workflow logic",
        "Multi-tenant violations",
        "Status sync between collections"
      ],
      "preventionPatterns": [
        "ALWAYS use getCollection()",
        "Verify partner context before operations",
        "Sync fahrzeuge AND partnerAnfragen"
      ]
    },

    "kanban.html": {
      "risk": "critical",
      "lines": 11305,
      "bugCount": 20,
      "recentFixes": [
        "Auftragsstart Fallback-Chain (2025-12-17)",
        "48h-Filter bei Verschiebung",
        "Background Sync Tracker",
        "Drag & Drop Race Conditions",
        "serviceTyp Überschreiben",
        "Listener Memory Leaks"
      ],
      "commonBugTypes": [
        "Race Conditions bei Drag & Drop",
        "serviceTyp wird überschrieben (DATA LOSS!)",
        "Memory Leaks durch nicht aufgeräumte Listener",
        "Sync-Fehler zwischen fahrzeuge und partnerAnfragen"
      ],
      "preventionPatterns": [
        "NIEMALS serviceTyp ändern",
        "IMMER listenerRegistry verwenden",
        "Background Sync Tracker für stille Fehler",
        "Optimistic UI mit Rollback bei Fehler"
      ]
    },

    "tagesplanung.html": {
      "risk": "high",
      "lines": 6087,
      "bugCount": 15,
      "recentFixes": [
        "Auftragsstart Fallback-Chain + abholdatum/abholzeit (2025-12-17)",
        "T1 & T2 bounds check",
        "null-checks für Verschieben-Feature",
        "Array Index Out of Bounds"
      ],
      "commonBugTypes": [
        "Array bounds nicht geprüft",
        "null/undefined bei leeren Arrays",
        "Verschieben-Logik komplex"
      ],
      "preventionPatterns": [
        "IMMER bounds check bei Array-Zugriff",
        "Optional chaining (?.) verwenden",
        "Leere Arrays separat behandeln"
      ]
    },

    "annahme.html": {
      "risk": "high",
      "lines": 10774,
      "bugCount": 11,
      "recentFixes": [
        "querySelector Null-Checks",
        "Radio Button Crash",
        "Double-Click Prevention"
      ],
      "openIssues": [
        {
          "issue": "Foto-Upload funktioniert nicht in Safari/Mac",
          "symptom": "Klick auf '+ Foto hinzufügen' tut nichts, keine Fehlermeldung",
          "rootCause": "Browser-Sicherheitseinschränkung bei programmatischem input.click()",
          "workaround": "Anderen Browser verwenden (Chrome/Firefox)",
          "status": "TODO: Safari-kompatiblen Fallback implementieren",
          "added": "2025-12-16"
        }
      ],
      "commonBugTypes": [
        "querySelector null wenn Element fehlt",
        "Radio buttons ohne Auswahl",
        "Async-Operationen laufen doppelt",
        "Browser-spezifische File-Input Restrictions"
      ],
      "preventionPatterns": [
        "?.value || 'default' für Radio Buttons",
        "Button disable während async",
        "Optional chaining für DOM-Queries",
        "File-Input: User-initiated click events verwenden"
      ]
    },

    "entwuerfe-bearbeiten.html": {
      "risk": "high",
      "lines": 7009,
      "bugCount": 5,
      "recentFixes": [
        "Keine 2 Preise mehr ohne Ersatzteile",
        "Preis-Konsistenz"
      ],
      "commonBugTypes": [
        "Preis-Logik inkonsistent",
        "Ersatzteile-Handling"
      ],
      "preventionPatterns": [
        "Preis-Validierung vor Speichern",
        "Ersatzteile-Array prüfen"
      ]
    },

    "kalkulation.html": {
      "risk": "high",
      "lines": 21693,
      "bugCount": 6,
      "recentFixes": [
        "Preisberechnung",
        "Ersatzteile-Integration"
      ],
      "commonBugTypes": [
        "Numerische Präzision (Floats)",
        "Summen-Berechnung falsch",
        "Ersatzteile nicht synchron"
      ],
      "preventionPatterns": [
        "toFixed(2) für Preise",
        "parseFloat mit Fallback",
        "Ersatzteile-Summe separat validieren"
      ]
    },

    "partner-app/kva-erstellen.html": {
      "risk": "high",
      "bugCount": 4,
      "recentFixes": [
        "XSS Protection",
        "Dead Code Cleanup"
      ],
      "commonBugTypes": [
        "XSS bei User-Input",
        "Ungültige Eingaben"
      ],
      "preventionPatterns": [
        "escapeHtml() für alle User-Inputs",
        "Input-Validation serverseitig wiederholen"
      ]
    },

    "functions/index.js": {
      "risk": "high",
      "bugCount": 5,
      "recentFixes": [
        "Status-Mapping bereit_zur_abholung",
        "Email-Retry-Logik"
      ],
      "commonBugTypes": [
        "Status-Mapping unvollständig",
        "Email-Fehler nicht geloggt",
        "Rate Limiting"
      ],
      "preventionPatterns": [
        "ALLE Status in Mapping aufnehmen",
        "Fehler immer loggen",
        "Retry mit exponential backoff"
      ]
    },

    "liste.html": {
      "risk": "medium",
      "lines": 4069,
      "bugCount": 3,
      "commonBugTypes": [
        "Filter-Logik",
        "Listener nicht aufgeräumt"
      ],
      "preventionPatterns": [
        "listenerRegistry verwenden",
        "Filter-State konsistent halten"
      ]
    },

    "wissensdatenbank.html": {
      "risk": "medium",
      "lines": 3786,
      "bugCount": 7,
      "recentFixes": [
        "missing unsubscribeDemontage()",
        "Phase 1P: 5 Double-Click Prevention fixes"
      ],
      "commonBugTypes": [
        "Listener nicht aufgeräumt",
        "Double-click vulnerabilities"
      ],
      "preventionPatterns": [
        "Alle unsubscribe-Funktionen aufrufen",
        "Button disable during async"
      ]
    },

    "dienstplan.html": {
      "risk": "high",
      "lines": 3634,
      "bugCount": 10,
      "note": "Phase 1N - Major bug fix wave (2025-12-11+)",
      "recentFixes": [
        "Phase 1N: 10 Double-Click Prevention fixes",
        "Type-safe ID comparisons (37 uses)"
      ],
      "commonBugTypes": [
        "Double-click vulnerabilities",
        "ID type mismatches",
        "Complex shift management logic"
      ],
      "preventionPatterns": [
        "Button disable during async",
        "String() for ID comparisons",
        "Validate shift data before save"
      ]
    },

    "material.html": {
      "risk": "medium",
      "lines": 6000,
      "gitCommits": 79,
      "bugCount": 5,
      "note": "Phase 1L - Recent fixes",
      "recentFixes": [
        "Phase 1L: 5 bug fixes",
        "Material request workflow"
      ],
      "commonBugTypes": [
        "Material inventory sync",
        "Order status updates"
      ],
      "preventionPatterns": [
        "Validate inventory before operations",
        "Sync calendar with material orders"
      ]
    },

    "mitarbeiter-verwaltung.html": {
      "risk": "medium",
      "lines": 5847,
      "getCollectionUses": 31,
      "commonBugTypes": [
        "Complex employee data logic",
        "Role permission checks"
      ],
      "preventionPatterns": [
        "Validate role before operations",
        "Use getCollection() consistently"
      ]
    }
  },

  "patterns_causing_most_bugs": {
    "1_multi_tenant": {
      "description": "Direkter db.collection() statt window.getCollection()",
      "occurrences": 99,
      "note": "99 direct db.collection() calls across 28 files (some in migrations/admin = acceptable)",
      "severity": "critical",
      "files": ["kanban.html", "annahme.html", "liste.html", "partner-app/meine-anfragen.html"]
    },
    "2_null_checks": {
      "description": "Fehlende null/undefined Checks",
      "occurrences": 15,
      "severity": "high",
      "files": ["annahme.html", "tagesplanung.html", "kanban.html"]
    },
    "3_async_handling": {
      "description": "Double-Click, Race Conditions, fehlende awaits",
      "occurrences": 8,
      "severity": "high",
      "files": ["annahme.html", "kanban.html", "entwuerfe-bearbeiten.html"]
    },
    "4_listener_leaks": {
      "description": "Firestore Listener nicht aufgeräumt",
      "occurrences": 6,
      "severity": "medium",
      "files": ["kanban.html", "liste.html", "wissensdatenbank.html"]
    },
    "5_service_typ": {
      "description": "serviceTyp nach Erstellung geändert",
      "occurrences": 3,
      "severity": "critical",
      "files": ["kanban.html"]
    }
  },

  "safe_files": {
    "description": "Dateien mit geringem Bug-Risiko",
    "files": [
      "landing.html",
      "agb.html",
      "datenschutz.html",
      "impressum.html",
      "kontakt.html",
      "js/toast.js",
      "js/utils/escape-html.js"
    ],
    "reason": "Statische Seiten oder einfache Utilities ohne Firebase"
  },

  "console_log_hotspots": {
    "description": "Dateien mit vielen console.logs - Performance-Kandidaten für Cleanup",
    "total": 4327,
    "files": [
      { "file": "partner-app/meine-anfragen.html", "count": 388 },
      { "file": "functions/index.js", "count": 279 },
      { "file": "partner-app/anfrage-detail.html", "count": 267 },
      { "file": "kanban.html", "count": 263 },
      { "file": "annahme.html", "count": 237 },
      { "file": "kalkulation.html", "count": 184 },
      { "file": "entwuerfe-bearbeiten.html", "count": 163 },
      { "file": "partner-app/js/kva-erstellen.js", "count": 150 },
      { "file": "index.html", "count": 124 },
      { "file": "debug-urlaubsanfragen.js", "count": 108 }
    ],
    "analysisDate": "2025-12-23",
    "cleanupHistory": [
      { "date": "2025-12-23", "files": ["meine-anfragen.html", "annahme.html", "kanban.html"], "removed": 126 }
    ]
  }
}
