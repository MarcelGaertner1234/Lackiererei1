<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dienstplan-Verwaltung - Auto-Lackierzentrum Mosbach</title>

    <!-- Firebase SDKs (Compatibility mode for backward compatibility) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="firebase-config.js"></script>

    <style>
        /* === PHASE 2.2: DIENSTPLAN STYLES === */

        :root {
            --color-primary: #1a73e8;
            --color-secondary: #34a853;
            --color-warning: #fbbc04;
            --color-danger: #ea4335;
            --color-surface: #1e1e1e;
            --color-surface-light: #2a2a2a;
            --color-text: #e8eaed;
            --color-text-secondary: #9aa0a6;
            --color-border: rgba(255,255,255,0.1);
            --shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
            color: var(--color-text);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: var(--color-surface);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: #1557b0;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26,115,232,0.4);
        }

        .btn-secondary {
            background: var(--color-surface-light);
            color: var(--color-text);
            border: 1px solid var(--color-border);
        }

        .btn-secondary:hover {
            background: #333;
            border-color: rgba(255,255,255,0.2);
        }

        .btn-success {
            background: var(--color-secondary);
            color: white;
        }

        .btn-danger {
            background: var(--color-danger);
            color: white;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 13px;
        }

        /* Tab System */
        .tab-container {
            background: var(--color-surface);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--color-border);
            padding-bottom: 0;
        }

        .tab-button {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: var(--color-text-secondary);
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            transition: all 0.2s;
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-button:hover {
            background: rgba(255,255,255,0.05);
            color: var(--color-text);
        }

        .tab-button.active {
            background: rgba(26,115,232,0.15);
            color: var(--color-primary);
            font-weight: 600;
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--color-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* View Toggle */
        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: var(--color-surface-light);
            padding: 4px;
            border-radius: 8px;
            width: fit-content;
        }

        .view-toggle button {
            padding: 8px 20px;
            background: transparent;
            border: none;
            color: var(--color-text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .view-toggle button.active {
            background: var(--color-primary);
            color: white;
        }

        /* Kalender Container */
        .kalender-wrapper {
            background: var(--color-surface-light);
            border-radius: 12px;
            padding: 20px;
            min-height: 600px;
        }

        .kalender-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .kalender-header h2 {
            font-size: 22px;
            font-weight: 600;
        }

        .kalender-navigation {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .nav-arrow {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            color: var(--color-text);
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .nav-arrow:hover {
            background: #333;
            border-color: rgba(255,255,255,0.3);
        }

        /* Week View */
        .week-view {
            display: grid;
            grid-template-columns: 150px repeat(7, 1fr);
            gap: 2px;
            background: var(--color-border);
            border-radius: 8px;
            overflow: hidden;
        }

        .week-header {
            background: var(--color-surface);
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 13px;
        }

        .week-header.corner {
            background: var(--color-surface-light);
        }

        .week-row-header {
            background: var(--color-surface);
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 500;
        }

        .week-cell {
            background: var(--color-surface);
            padding: 8px;
            min-height: 80px;
            position: relative;
        }

        .week-cell.drop-zone {
            border: 2px dashed transparent;
            transition: all 0.2s;
        }

        .week-cell.drop-zone.drag-over {
            background: rgba(26,115,232,0.1);
            border-color: var(--color-primary);
        }

        /* Month View */
        .month-view {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-auto-rows: minmax(100px, auto);
            gap: 2px;
            background: var(--color-border);
            border-radius: 8px;
            overflow: hidden;
            min-height: 600px;
        }

        .month-header {
            background: var(--color-surface);
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            font-size: 13px;
        }

        .month-cell {
            background: var(--color-surface);
            padding: 8px;
            min-height: 100px;
            position: relative;
        }

        .month-cell.other-month {
            opacity: 0.4;
        }

        .month-cell.today {
            background: rgba(26,115,232,0.1);
        }

        .month-cell-date {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        /* Schicht Badge */
        .schicht-badge {
            padding: 6px 10px;
            padding-right: 24px; /* üÜï Space for auto-fill handle */
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 4px;
            cursor: move;
            display: flex;
            align-items: center;
            gap: 6px;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.2s;
            position: relative; /* üÜï For absolute positioned handle */
        }

        .schicht-badge:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        /* üÜï Auto-Fill Handle */
        .auto-fill-handle {
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
            cursor: col-resize;
            opacity: 0;
            transition: opacity 0.2s;
            padding: 2px 4px;
            font-size: 14px;
            line-height: 1;
            user-select: none;
        }

        .schicht-badge:hover .auto-fill-handle {
            opacity: 0.7;
        }

        .auto-fill-handle:hover {
            opacity: 1 !important;
        }

        /* üÜï Auto-Fill Preview (during drag) */
        .auto-fill-preview {
            border: 2px solid #34a853 !important;
            background: rgba(52, 168, 83, 0.1) !important;
        }

        .schicht-badge.dragging {
            opacity: 0.5;
        }

        .schicht-badge-time {
            font-size: 11px;
            opacity: 0.8;
        }

        /* Dropdown Buttons & Menu */
        .dropdown-container {
            position: relative;
            display: inline-block;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            background: var(--color-surface-light);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            min-width: 280px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            margin-top: 4px;
            padding: 8px;
        }

        .dropdown-menu.show {
            display: block !important;
        }

        .dropdown-item {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--color-surface);
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.2s;
        }

        .dropdown-item:hover {
            background: rgba(26, 115, 232, 0.1);
            transform: translateX(4px);
        }

        .dropdown-item-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
        }

        .dropdown-item-actions {
            display: flex;
            gap: 4px;
        }

        .dropdown-item-actions .icon-btn {
            width: 28px;
            height: 28px;
            padding: 4px;
            font-size: 12px;
        }

        .dropdown-empty {
            padding: 12px 16px;
            text-align: center;
            opacity: 0.6;
            font-size: 13px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .schichttyp-item {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: move;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .schichttyp-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .schichttyp-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .schichttyp-actions {
            display: flex;
            gap: 6px;
        }

        .icon-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--color-border);
            color: var(--color-text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .icon-btn:hover {
            background: rgba(255,255,255,0.1);
            border-color: rgba(255,255,255,0.2);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 100000;
            padding: 20px;
            overflow-y: auto;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--color-surface);
            border-radius: 16px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-header h2 {
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255,255,255,0.05);
            border: none;
            color: var(--color-text);
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        /* Form */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--color-text-secondary);
        }

        .form-control {
            width: 100%;
            padding: 12px 16px;
            background: var(--color-surface-light);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            color: var(--color-text);
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--color-primary);
            background: #2a2a2a;
        }

        .form-control[type="color"] {
            height: 50px;
            cursor: pointer;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        /* Grid Layout */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        /* Badge */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-primary {
            background: rgba(26,115,232,0.2);
            color: var(--color-primary);
        }

        .badge-success {
            background: rgba(52,168,83,0.2);
            color: var(--color-secondary);
        }

        .badge-warning {
            background: rgba(251,188,4,0.2);
            color: var(--color-warning);
        }

        .badge-danger {
            background: rgba(234,67,53,0.2);
            color: var(--color-danger);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--color-surface);
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.4);
            z-index: 100001;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .toast.success {
            border-left: 4px solid var(--color-secondary);
        }

        .toast.error {
            border-left: 4px solid var(--color-danger);
        }

        .toast.warning {
            border-left: 4px solid var(--color-warning);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--color-text-secondary);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255,255,255,0.1);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            /* Grid already 1fr for all screen sizes */

            .week-view {
                grid-template-columns: 100px repeat(7, 1fr);
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .week-view {
                overflow-x: auto;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üìÖ Dienstplan-Verwaltung</h1>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="window.location.href='mitarbeiter-verwaltung.html'">
                    ‚Üê Zur√ºck zur Verwaltung
                </button>
                <button class="btn btn-primary" onclick="openSchichtTypModal()">
                    + Schicht-Typ erstellen
                </button>
                <button class="btn btn-primary" onclick="openBereichModal()">
                    + Bereich erstellen
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="tab-container">
            <!-- Tabs -->
            <div class="tabs">
                <button id="tabKalender" class="tab-button active" onclick="switchTab('kalender')">
                    üìÖ Kalender
                </button>
                <button id="tabWuensche" class="tab-button" onclick="switchTab('wuensche')">
                    üí≠ W√ºnsche <span id="wuenscheCount" class="badge badge-warning">0</span>
                </button>
                <button id="tabTausche" class="tab-button" onclick="switchTab('tausche')">
                    üîÑ Tausch-Anfragen <span id="tauscheCount" class="badge badge-warning">0</span>
                </button>
            </div>

            <!-- Tab Content: Kalender -->
            <div id="contentKalender" class="tab-content active">
                <div class="grid-2">
                    <!-- Kalender View -->
                    <div>
                        <!-- View Toggle & Dropdowns -->
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 20px;">
                            <!-- View Toggle -->
                            <div class="view-toggle">
                                <button id="viewWeek" class="active" onclick="switchView('week')">
                                    üìä Wochenansicht
                                </button>
                                <button id="viewMonth" onclick="switchView('month')">
                                    üìÜ Monatsansicht
                                </button>
                            </div>

                            <!-- üÜï Dropdown f√ºr Schicht-Typen -->
                            <div class="dropdown-container">
                                <button class="btn btn-secondary btn-small" onclick="toggleDropdown('schichttypenDropdown')">
                                    üé® Schicht-Typen
                                </button>
                                <div id="schichttypenDropdown" class="dropdown-menu" style="display: none;">
                                    <div style="padding: 8px 12px; border-bottom: 1px solid var(--color-border); margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                                        <strong style="font-size: 14px;">Schicht-Typen</strong>
                                        <button class="btn btn-primary" style="padding: 4px 12px; font-size: 12px;" onclick="openSchichtTypModal(); event.stopPropagation();">
                                            + Neu
                                        </button>
                                    </div>
                                    <div id="schichttypenList">
                                        <!-- Rendered dynamically -->
                                    </div>
                                </div>
                            </div>

                            <!-- üÜï Dropdown f√ºr Bereiche -->
                            <div class="dropdown-container">
                                <button class="btn btn-secondary btn-small" onclick="toggleDropdown('bereicheDropdown')">
                                    üè¢ Bereiche
                                </button>
                                <div id="bereicheDropdown" class="dropdown-menu" style="display: none;">
                                    <div style="padding: 8px 12px; border-bottom: 1px solid var(--color-border); margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                                        <strong style="font-size: 14px;">Bereiche</strong>
                                        <button class="btn btn-primary" style="padding: 4px 12px; font-size: 12px;" onclick="openBereichModal(); event.stopPropagation();">
                                            + Neu
                                        </button>
                                    </div>
                                    <div id="bereicheList">
                                        <!-- Rendered dynamically -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Kalender Wrapper -->
                        <div class="kalender-wrapper">
                            <div class="kalender-header">
                                <h2 id="kalenderTitle">Loading...</h2>
                                <div class="kalender-navigation">
                                    <button class="nav-arrow" onclick="navigateCalendar(-1)">
                                        ‚Üê
                                    </button>
                                    <button class="btn btn-small btn-secondary" onclick="navigateToToday()">
                                        Heute
                                    </button>
                                    <button class="nav-arrow" onclick="navigateCalendar(1)">
                                        ‚Üí
                                    </button>
                                </div>
                            </div>

                            <!-- Week View Container -->
                            <div id="weekViewContainer" class="week-view">
                                <!-- Rendered dynamically -->
                            </div>

                            <!-- Month View Container -->
                            <div id="monthViewContainer" class="month-view">
                                <!-- Rendered dynamically -->
                            </div>

                            <!-- Loading State -->
                            <div id="kalenderLoading" class="loading">
                                <div class="spinner"></div>
                                <p>Kalender wird geladen...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Content: W√ºnsche -->
            <div id="contentWuensche" class="tab-content">
                <h3 style="margin-bottom: 20px;">üí≠ Mitarbeiter-W√ºnsche</h3>
                <div id="wuenscheList">
                    <!-- Rendered dynamically -->
                </div>
            </div>

            <!-- Tab Content: Tausch-Anfragen -->
            <div id="contentTausche" class="tab-content">
                <h3 style="margin-bottom: 20px;">üîÑ Tausch-Anfragen</h3>
                <div id="tauscheList">
                    <!-- Rendered dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- üÜï CONTEXT MENU: Urlaub/Frei/Krank -->
    <div id="contextMenu" style="display: none; position: fixed; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 8px; padding: 8px; z-index: 100002; box-shadow: 0 4px 12px rgba(0,0,0,0.4);">
        <div id="contextMenuOptions"></div>
    </div>

    <!-- MODAL: Schicht-Typ erstellen/bearbeiten -->
    <div id="schichtTypModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><span id="modalSchichtTypTitle">üé® Schicht-Typ erstellen</span></h2>
                <button class="close-btn" onclick="closeSchichtTypModal()">√ó</button>
            </div>
            <form id="schichtTypForm" onsubmit="saveSchichtTyp(event)">
                <input type="hidden" id="editSchichtTypId" value="">

                <div class="form-group">
                    <label for="schichtName">Name der Schicht *</label>
                    <input type="text" id="schichtName" class="form-control" placeholder="z.B. Fr√ºhschicht, Sp√§tschicht" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="schichtStart">Startzeit *</label>
                        <input type="time" id="schichtStart" class="form-control" value="08:00" required>
                    </div>

                    <div class="form-group">
                        <label for="schichtEnde">Endzeit *</label>
                        <input type="time" id="schichtEnde" class="form-control" value="16:00" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="schichtFarbe">Farbe *</label>
                    <input type="color" id="schichtFarbe" class="form-control" value="#1a73e8" required>
                </div>

                <div class="form-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeSchichtTypModal()">
                        Abbrechen
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <span id="btnSchichtTypText">Erstellen</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: Schicht zuweisen -->
    <div id="schichtZuweisenModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìã Schicht zuweisen</h2>
                <button class="close-btn" onclick="closeSchichtZuweisenModal()">√ó</button>
            </div>
            <form id="schichtZuweisenForm" onsubmit="saveSchichtZuweisung(event)">
                <input type="hidden" id="zuweisenMitarbeiterId">
                <input type="hidden" id="zuweisenDatum">

                <div class="form-group">
                    <label>Mitarbeiter</label>
                    <p id="zuweisenMitarbeiterName" style="font-weight: 600; font-size: 16px;">-</p>
                </div>

                <div class="form-group">
                    <label>Datum</label>
                    <p id="zuweisenDatumText" style="font-weight: 600; font-size: 16px;">-</p>
                </div>

                <div class="form-group">
                    <label for="zuweisenSchichtTyp">Schicht-Typ *</label>
                    <select id="zuweisenSchichtTyp" class="form-control" required>
                        <option value="">-- Bitte w√§hlen --</option>
                        <!-- Rendered dynamically -->
                    </select>
                </div>

                <!-- üÜï Multi-Day Auswahl -->
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="multiDayCheckbox" onchange="toggleMultiDaySelection()">
                        üìÖ F√ºr mehrere Tage erstellen
                    </label>
                </div>

                <div id="multiDaySelection" style="display: none; margin-top: 10px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600;">Tage ausw√§hlen:</label>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                            <input type="checkbox" class="multiday-checkbox" value="1" id="day-mo"> Mo
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                            <input type="checkbox" class="multiday-checkbox" value="2" id="day-di"> Di
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                            <input type="checkbox" class="multiday-checkbox" value="3" id="day-mi"> Mi
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                            <input type="checkbox" class="multiday-checkbox" value="4" id="day-do"> Do
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                            <input type="checkbox" class="multiday-checkbox" value="5" id="day-fr"> Fr
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                            <input type="checkbox" class="multiday-checkbox" value="6" id="day-sa"> Sa
                        </label>
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                            <input type="checkbox" class="multiday-checkbox" value="0" id="day-so"> So
                        </label>
                    </div>
                </div>

                <div class="form-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeSchichtZuweisenModal()">
                        Abbrechen
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Zuweisen
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- üÜï MODAL: Bereich erstellen/bearbeiten -->
    <div id="bereichModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><span id="modalBereichTitle">üè¢ Bereich erstellen</span></h2>
                <button class="close-btn" onclick="closeBereichModal()">√ó</button>
            </div>
            <form id="bereichForm" onsubmit="saveBereich(event)">
                <input type="hidden" id="editBereichId" value="">

                <div class="form-group">
                    <label for="bereichName">Name des Bereichs *</label>
                    <input type="text" id="bereichName" class="form-control" placeholder="z.B. Lackierung, Mechanik, Karosserie" required>
                </div>

                <div class="form-group">
                    <label for="bereichFarbe">Farbe *</label>
                    <input type="color" id="bereichFarbe" class="form-control" value="#1a73e8" required>
                </div>

                <div class="form-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeBereichModal()">
                        Abbrechen
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <span id="btnBereichText">Erstellen</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- üÜï MODAL: Bereich zu Schicht zuweisen -->
    <div id="bereichZuweisenModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üè¢ Bereich zuweisen</h2>
                <button class="close-btn" onclick="closeBereichZuweisenModal()">√ó</button>
            </div>
            <form id="bereichZuweisenForm" onsubmit="saveBereichZuweisung(event)">
                <input type="hidden" id="zuweisenSchichtId">

                <div class="form-group">
                    <label>Schicht</label>
                    <p id="zuweisenSchichtInfo" style="font-weight: 600; font-size: 16px;">-</p>
                </div>

                <div class="form-group">
                    <label for="zuweisenBereich">Bereich *</label>
                    <select id="zuweisenBereich" class="form-control" required>
                        <option value="">-- Bitte w√§hlen --</option>
                        <!-- Rendered dynamically -->
                    </select>
                </div>

                <div class="form-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeBereichZuweisenModal()">
                        Abbrechen
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Zuweisen
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/auth-manager.js"></script>
    <script>
        // === PHASE 2.2: DIENSTPLAN JAVASCRIPT ===

        // Global Variables
        let currentView = 'week'; // 'week' or 'month'
        let currentDate = new Date();
        let allMitarbeiter = [];
        let allSchichtTypen = [];
        let allSchichten = [];
        let allWuensche = [];
        let allTausche = [];
        let allBereiche = []; // üÜï Feature 1: Bereiche-System

        // Firebase & Auth Check
        let authCheckInterval;
        let authCheckAttempts = 0;

        window.addEventListener('DOMContentLoaded', () => {
            // Pre-initialize werkstattId from localStorage
            const storedPartner = JSON.parse(localStorage.getItem('partner') || 'null');
            window.werkstattId = (storedPartner && storedPartner.werkstattId) || 'mosbach';

            authCheckInterval = setInterval(async () => {
                authCheckAttempts++;

                if (window.firebaseInitialized && window.werkstattId && window.authManager) {
                    clearInterval(authCheckInterval);

                    const currentUser = window.authManager.getCurrentUser();
                    if (!currentUser) {
                        window.location.href = 'login-werkstatt.html';
                        return;
                    }

                    // Check role: Only werkstatt/admin/superadmin allowed
                    const role = currentUser.role;
                    if (role !== 'werkstatt' && role !== 'admin' && role !== 'superadmin') {
                        alert('‚õî Zugriff verweigert! Diese Seite ist nur f√ºr Administratoren.');
                        window.location.href = 'index.html';
                        return;
                    }

                    // Initialize
                    await initDienstplan();
                }

                if (authCheckAttempts >= 20) {
                    clearInterval(authCheckInterval);
                    alert('‚ùå Firebase-Initialisierung fehlgeschlagen. Bitte lade die Seite neu.');
                }
            }, 250);
        });

        // Initialize Dienstplan
        async function initDienstplan() {
            try {
                // Load all data
                await Promise.all([
                    loadMitarbeiter(),
                    loadSchichtTypen(),
                    loadSchichten(),
                    loadWuensche(),
                    loadTausche(),
                    loadBereiche() // üÜï Feature 1: Bereiche
                ]);

                // üÜï Feature 2: Ensure special schicht-typen exist
                await ensureSpecialSchichtTypen();

                // Render initial view
                renderCalendar();
                renderMitarbeiterSidebar();
                renderSchichttypenPalette();
                renderBereichePalette(); // üÜï Feature 1
                renderWuensche();
                renderTausche();

            } catch (error) {
                console.error('‚ùå Fehler beim Initialisieren:', error);
                showToast('‚ùå Fehler beim Laden der Daten', 'error');
            }
        }

        // === DATA LOADING ===

        async function loadMitarbeiter() {
            try {
                const snapshot = await window.getCollection('mitarbeiter').get();
                allMitarbeiter = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                console.log(`‚úÖ ${allMitarbeiter.length} Mitarbeiter geladen`);
            } catch (error) {
                console.error('‚ùå Fehler beim Laden der Mitarbeiter:', error);
            }
        }

        async function loadSchichtTypen() {
            try {
                const snapshot = await window.getCollection('schichtTypen').get();
                allSchichtTypen = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                console.log(`‚úÖ ${allSchichtTypen.length} Schicht-Typen geladen`);
            } catch (error) {
                console.error('‚ùå Fehler beim Laden der Schicht-Typen:', error);
            }
        }

        async function loadSchichten() {
            try {
                const snapshot = await window.getCollection('schichten').get();
                allSchichten = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                console.log(`‚úÖ ${allSchichten.length} Schichten geladen`);
            } catch (error) {
                console.error('‚ùå Fehler beim Laden der Schichten:', error);
            }
        }

        async function loadWuensche() {
            try {
                const snapshot = await window.getCollection('schichtWuensche')
                    .where('status', '==', 'pending')
                    .orderBy('createdAt', 'desc')
                    .get();
                allWuensche = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                document.getElementById('wuenscheCount').textContent = allWuensche.length;
                console.log(`‚úÖ ${allWuensche.length} W√ºnsche geladen`);
            } catch (error) {
                console.error('‚ùå Fehler beim Laden der W√ºnsche:', error);
            }
        }

        async function loadTausche() {
            try {
                const snapshot = await window.getCollection('schichtTausche')
                    .where('status', '==', 'pending')
                    .orderBy('createdAt', 'desc')
                    .get();
                allTausche = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                document.getElementById('tauscheCount').textContent = allTausche.length;
                console.log(`‚úÖ ${allTausche.length} Tausch-Anfragen geladen`);
            } catch (error) {
                console.error('‚ùå Fehler beim Laden der Tausch-Anfragen:', error);
            }
        }

        async function loadBereiche() {
            try {
                const snapshot = await window.getCollection('bereiche').get();
                allBereiche = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                console.log(`‚úÖ ${allBereiche.length} Bereiche geladen`);
            } catch (error) {
                console.error('‚ùå Fehler beim Laden der Bereiche:', error);
                allBereiche = []; // Set to empty array on error
            }
        }

        // === üÜï SPECIAL SCHICHT-TYPEN (Urlaub/Frei/Krank) ===

        async function ensureSpecialSchichtTypen() {
            try {
                console.log('üéØ [DEBUG] Starting ensureSpecialSchichtTypen...');
                console.log('üéØ [DEBUG] allSchichtTypen length:', allSchichtTypen.length);
                console.log('üéØ [DEBUG] allSchichtTypen:', allSchichtTypen);

                const specialTypes = [
                    {
                        name: 'Urlaub',
                        startzeit: '00:00',
                        endzeit: '23:59',
                        farbe: '#34a853',
                        isSpecial: true,
                        type: 'urlaub',
                        sortierung: 1000
                    },
                    {
                        name: 'Frei',
                        startzeit: '00:00',
                        endzeit: '23:59',
                        farbe: '#9aa0a6',
                        isSpecial: true,
                        type: 'frei',
                        sortierung: 1001
                    },
                    {
                        name: 'Krank',
                        startzeit: '00:00',
                        endzeit: '23:59',
                        farbe: '#ea4335',
                        isSpecial: true,
                        type: 'krank',
                        sortierung: 1002
                    }
                ];

                for (const specialType of specialTypes) {
                    // Check if exists by name (not type field, which doesn't exist yet)
                    const existing = allSchichtTypen.find(st =>
                        st.name === specialType.name
                    );

                    console.log(`üéØ [DEBUG] Checking "${specialType.name}", exists:`, !!existing);

                    if (!existing) {
                        // Create
                        console.log(`üéØ [DEBUG] Creating "${specialType.name}"...`);
                        await window.getCollection('schichtTypen').add({
                            ...specialType,
                            werkstattId: window.werkstattId
                        });
                        console.log(`‚úÖ Special Schicht-Typ "${specialType.name}" erstellt`);
                    } else {
                        console.log(`‚ÑπÔ∏è Special Schicht-Typ "${specialType.name}" existiert bereits`);
                    }
                }

                // Reload to include new special types
                console.log('üéØ [DEBUG] Reloading Schicht-Typen...');
                await loadSchichtTypen();
                console.log('üéØ [DEBUG] Schicht-Typen reloaded, new length:', allSchichtTypen.length);

            } catch (error) {
                console.error('‚ùå Fehler beim Erstellen der Special Schicht-Typen:', error);
            }
        }

        // === TAB SWITCHING ===

        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById('content' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
        }

        // === VIEW SWITCHING ===

        function switchView(view) {
            currentView = view;

            // Update toggle buttons
            document.querySelectorAll('.view-toggle button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('view' + view.charAt(0).toUpperCase() + view.slice(1)).classList.add('active');

            // Render calendar
            renderCalendar();
        }

        // === DROPDOWN TOGGLE ===

        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            const isVisible = dropdown.style.display !== 'none';

            // Alle Dropdowns schlie√üen
            document.querySelectorAll('.dropdown-menu').forEach(el => {
                el.style.display = 'none';
            });

            // Nur dieses Dropdown togglen, wenn es nicht sichtbar war
            if (!isVisible) {
                dropdown.style.display = 'block';
            }
        }

        // Dropdowns schlie√üen wenn au√üen geklickt wird
        document.addEventListener('click', (e) => {
            const isDropdownBtn = e.target.closest('.dropdown-container button');
            const isDropdownMenu = e.target.closest('.dropdown-menu');

            if (!isDropdownBtn && !isDropdownMenu) {
                document.querySelectorAll('.dropdown-menu').forEach(el => {
                    el.style.display = 'none';
                });
            }
        });

        // === CALENDAR NAVIGATION ===

        function navigateCalendar(direction) {
            if (currentView === 'week') {
                currentDate.setDate(currentDate.getDate() + (direction * 7));
            } else {
                currentDate.setMonth(currentDate.getMonth() + direction);
            }
            renderCalendar();
        }

        function navigateToToday() {
            currentDate = new Date();
            renderCalendar();
        }

        // === CALENDAR RENDERING ===

        function calculateBereichStats(datum) {
            // Count schichten per bereich for a specific date
            const daySchichten = allSchichten.filter(s => s.datum === datum);
            const bereichCount = {};

            for (const schicht of daySchichten) {
                if (schicht.bereichId) {
                    const bereich = allBereiche.find(b => String(b.id) === String(schicht.bereichId));
                    if (bereich) {
                        bereichCount[bereich.name] = (bereichCount[bereich.name] || 0) + 1;
                    }
                }
            }

            // Format as text: "Lackiererei: 2, Polieren: 1"
            const parts = [];
            for (const [name, count] of Object.entries(bereichCount)) {
                parts.push(`${name}: ${count}`);
            }

            return parts.join(', ');
        }

        function renderCalendar() {
            document.getElementById('kalenderLoading').style.display = 'none';

            if (currentView === 'week') {
                renderWeekView();
            } else {
                renderMonthView();
            }
        }

        function renderWeekView() {
            const container = document.getElementById('weekViewContainer');
            const monthContainer = document.getElementById('monthViewContainer');

            // Ensure only week view is visible
            container.style.display = 'grid';
            container.style.visibility = 'visible';
            monthContainer.style.display = 'none';
            monthContainer.style.visibility = 'hidden';

            // Get Monday of current week
            const monday = getMonday(currentDate);

            // Update title
            const endDate = new Date(monday);
            endDate.setDate(endDate.getDate() + 6);
            document.getElementById('kalenderTitle').textContent =
                `KW ${getWeekNumber(monday)} ¬∑ ${formatDate(monday, 'DD.MM')} - ${formatDate(endDate, 'DD.MM.YYYY')}`;

            // Build week grid HTML
            let html = '';

            // Header row
            html += '<div class="week-header corner">Mitarbeiter</div>';
            const weekdays = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
            for (let i = 0; i < 7; i++) {
                const day = new Date(monday);
                day.setDate(day.getDate() + i);
                const dateStr = formatDate(day, 'YYYY-MM-DD');
                const isToday = isSameDay(day, new Date());
                const stats = calculateBereichStats(dateStr);
                const statsHtml = stats ? `<br><small style="font-size: 10px; opacity: 0.7; font-weight: normal;">${stats}</small>` : '';
                html += `<div class="week-header ${isToday ? 'today' : ''}">${weekdays[i]}<br><small>${formatDate(day, 'DD.MM')}</small>${statsHtml}</div>`;
            }

            // Mitarbeiter rows
            for (const mitarbeiter of allMitarbeiter) {
                // Row header
                html += `
                    <div class="week-row-header">
                        <div class="mitarbeiter-avatar">${getInitials(mitarbeiter.name)}</div>
                        ${mitarbeiter.name}
                    </div>
                `;

                // Day cells
                for (let i = 0; i < 7; i++) {
                    const day = new Date(monday);
                    day.setDate(day.getDate() + i);
                    const dateStr = formatDate(day, 'YYYY-MM-DD');
                    const isToday = isSameDay(day, new Date());

                    // Find schichten for this mitarbeiter + date
                    const schichten = allSchichten.filter(s =>
                        String(s.mitarbeiterId) === String(mitarbeiter.id) &&
                        s.datum === dateStr
                    );

                    html += `
                        <div class="week-cell drop-zone ${isToday ? 'today' : ''}"
                             data-mitarbeiter-id="${mitarbeiter.id}"
                             data-datum="${dateStr}"
                             ondrop="handleDrop(event); handleAutoFillDrop(event, '${mitarbeiter.id}', '${dateStr}');"
                             ondragover="handleDragOver(event); handleAutoFillDragOver(event, '${mitarbeiter.id}', '${dateStr}');"
                             ondragleave="handleDragLeave(event)"
                             oncontextmenu="showContextMenu(event, '${mitarbeiter.id}', '${dateStr}')">
                    `;

                    // Render schicht badges
                    for (const schicht of schichten) {
                        const schichtTyp = allSchichtTypen.find(st => String(st.id) === String(schicht.schichtTypId));
                        if (schichtTyp) {
                            html += renderSchichtBadge(schicht, schichtTyp);
                        }
                    }

                    html += '</div>';
                }
            }

            container.innerHTML = html;
        }

        function renderMonthView() {
            const container = document.getElementById('monthViewContainer');
            const weekContainer = document.getElementById('weekViewContainer');

            // Ensure only month view is visible
            container.style.display = 'grid';
            container.style.visibility = 'visible';
            weekContainer.style.display = 'none';
            weekContainer.style.visibility = 'hidden';

            // Update title
            document.getElementById('kalenderTitle').textContent =
                formatDate(currentDate, 'MMMM YYYY');

            // Build month grid HTML
            let html = '';

            // Header row
            const weekdays = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
            for (const day of weekdays) {
                html += `<div class="month-header">${day}</div>`;
            }

            // Get first day of month
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);

            // Adjust to Monday (getDay() returns 0=Sunday, we want Monday=0)
            let startDay = firstDay.getDay() - 1;
            if (startDay === -1) startDay = 6;

            // Add previous month days
            for (let i = 0; i < startDay; i++) {
                const day = new Date(firstDay);
                day.setDate(day.getDate() - (startDay - i));
                html += renderMonthCell(day, true);
            }

            // Add current month days
            for (let i = 1; i <= lastDay.getDate(); i++) {
                const day = new Date(currentDate.getFullYear(), currentDate.getMonth(), i);
                html += renderMonthCell(day, false);
            }

            // Add next month days to fill grid
            const totalCells = startDay + lastDay.getDate();
            const remainingCells = 7 - (totalCells % 7);
            if (remainingCells < 7) {
                for (let i = 1; i <= remainingCells; i++) {
                    const day = new Date(lastDay);
                    day.setDate(day.getDate() + i);
                    html += renderMonthCell(day, true);
                }
            }

            container.innerHTML = html;
        }

        function renderMonthCell(date, otherMonth) {
            const dateStr = formatDate(date, 'YYYY-MM-DD');
            const isToday = isSameDay(date, new Date());

            // Find all schichten for this date
            const daySchichten = allSchichten.filter(s => s.datum === dateStr);

            let html = `
                <div class="month-cell drop-zone ${otherMonth ? 'other-month' : ''} ${isToday ? 'today' : ''}"
                     data-datum="${dateStr}"
                     ondrop="handleDrop(event)"
                     ondragover="handleDragOver(event)"
                     ondragleave="handleDragLeave(event)">
                    <div class="month-cell-date">${date.getDate()}</div>
            `;

            // Render schicht badges (max 3, then "+X more")
            const maxBadges = 3;
            for (let i = 0; i < Math.min(daySchichten.length, maxBadges); i++) {
                const schicht = daySchichten[i];

                // Daten validieren
                if (!schicht || !schicht.schichtTypId || !schicht.mitarbeiterId) {
                    console.warn('‚ö†Ô∏è Ung√ºltige Schicht-Daten:', schicht);
                    continue;
                }

                const schichtTyp = allSchichtTypen.find(st => String(st.id) === String(schicht.schichtTypId));
                const mitarbeiter = allMitarbeiter.find(m => String(m.id) === String(schicht.mitarbeiterId));

                // Zus√§tzliche Pr√ºfung f√ºr mitarbeiter.name
                if (schichtTyp && mitarbeiter && mitarbeiter.name) {
                    const firstName = mitarbeiter.name.split(' ')[0];
                    html += `
                        <div class="schicht-badge"
                             style="background: ${schichtTyp.farbe}; color: white; font-size: 11px;"
                             draggable="true"
                             ondragstart="handleSchichtDragStart(event, '${schicht.id}')">
                            ${firstName}
                        </div>
                    `;
                }
            }

            if (daySchichten.length > maxBadges) {
                html += `<div style="font-size: 11px; opacity: 0.7; margin-top: 4px;">+${daySchichten.length - maxBadges} mehr</div>`;
            }

            html += '</div>';
            return html;
        }

        function renderSchichtBadge(schicht, schichtTyp) {
            const mitarbeiter = allMitarbeiter.find(m => String(m.id) === String(schicht.mitarbeiterId));

            // üÜï Bereich-Info
            let bereichInfo = '';
            if (schicht.bereichId) {
                const bereich = allBereiche.find(b => String(b.id) === String(schicht.bereichId));
                if (bereich) {
                    bereichInfo = `<span style="font-size: 10px; opacity: 0.9;"> ‚Ä¢ ${bereich.name}</span>`;
                }
            }

            return `
                <div class="schicht-badge"
                     style="background: ${schichtTyp.farbe}; color: white; cursor: pointer; position: relative;"
                     draggable="true"
                     ondragstart="handleSchichtDragStart(event, '${schicht.id}')">
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px;">
                        <span onclick="event.stopPropagation(); openBereichZuweisenModal('${schicht.id}');"
                              style="flex: 1; cursor: pointer; display: flex; flex-direction: column; gap: 2px;">
                            <span>${schichtTyp.name}${bereichInfo}</span>
                            <span class="schicht-badge-time">${schichtTyp.startzeit}-${schichtTyp.endzeit}</span>
                        </span>
                        <button class="schicht-delete-btn"
                                onclick="deleteSchicht('${schicht.id}'); event.stopPropagation();"
                                title="L√∂schen"
                                style="background: rgba(255, 255, 255, 0.2); border: none; color: white; cursor: pointer; padding: 4px 8px; border-radius: 4px; font-size: 14px; transition: background 0.2s; opacity: 0.7;"
                                onmouseover="this.style.opacity='1'; this.style.background='rgba(255, 255, 255, 0.3)';"
                                onmouseout="this.style.opacity='0.7'; this.style.background='rgba(255, 255, 255, 0.2)';">
                            üóëÔ∏è
                        </button>
                    </div>
                    <div class="auto-fill-handle"
                         draggable="true"
                         ondragstart="handleAutoFillDragStart(event, '${schicht.id}'); event.stopPropagation();"
                         onclick="event.stopPropagation();"
                         title="√úber Woche ziehen">‚ãÆ</div>
                </div>
            `;
        }

        // === SIDEBAR RENDERING ===

        function renderMitarbeiterSidebar() {
            const container = document.getElementById('mitarbeiterList');

            // Sichere Fallback wenn Element nicht existiert (Sidebar wurde entfernt)
            if (!container) {
                console.warn('‚ö†Ô∏è mitarbeiterList Element nicht gefunden - Sidebar wurde umstrukturiert');
                return;
            }

            if (allMitarbeiter.length === 0) {
                container.innerHTML = '<p style="opacity: 0.7; font-size: 14px;">Keine Mitarbeiter gefunden</p>';
                return;
            }

            let html = '';
            for (const mitarbeiter of allMitarbeiter) {
                html += `
                    <div class="mitarbeiter-item"
                         draggable="true"
                         ondragstart="handleMitarbeiterDragStart(event, '${mitarbeiter.id}')">
                        <div class="mitarbeiter-avatar">${getInitials(mitarbeiter.name)}</div>
                        ${mitarbeiter.name}
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function renderSchichttypenPalette() {
            const container = document.getElementById('schichttypenList');

            if (allSchichtTypen.length === 0) {
                container.innerHTML = '<div class="dropdown-empty">Noch keine Schicht-Typen erstellt</div>';
                return;
            }

            let html = '';
            for (const schichtTyp of allSchichtTypen) {
                html += `
                    <div class="dropdown-item"
                         style="background: ${schichtTyp.farbe}30; border: 1px solid ${schichtTyp.farbe};"
                         draggable="true"
                         ondragstart="handleSchichtTypDragStart(event, '${schichtTyp.id}')">
                        <div class="dropdown-item-content">
                            <strong style="color: ${schichtTyp.farbe};">${schichtTyp.name}</strong>
                            <span style="font-size: 12px; opacity: 0.8;">${schichtTyp.startzeit} - ${schichtTyp.endzeit}</span>
                        </div>
                        <div class="dropdown-item-actions">
                            <button class="icon-btn" onclick="editSchichtTyp('${schichtTyp.id}'); event.stopPropagation();" title="Bearbeiten">
                                ‚úèÔ∏è
                            </button>
                            <button class="icon-btn" onclick="deleteSchichtTyp('${schichtTyp.id}'); event.stopPropagation();" title="L√∂schen">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function renderBereichePalette() {
            const container = document.getElementById('bereicheList');

            if (!container) return; // Falls HTML noch nicht hinzugef√ºgt wurde

            if (allBereiche.length === 0) {
                container.innerHTML = '<div class="dropdown-empty">Noch keine Bereiche erstellt</div>';
                return;
            }

            let html = '';
            for (const bereich of allBereiche) {
                html += `
                    <div class="dropdown-item"
                         style="background: ${bereich.farbe}30; border: 1px solid ${bereich.farbe};">
                        <div class="dropdown-item-content">
                            <strong style="color: ${bereich.farbe};">${bereich.name}</strong>
                        </div>
                        <div class="dropdown-item-actions">
                            <button class="icon-btn" onclick="editBereich('${bereich.id}'); event.stopPropagation();" title="Bearbeiten">
                                ‚úèÔ∏è
                            </button>
                            <button class="icon-btn" onclick="deleteBereich('${bereich.id}'); event.stopPropagation();" title="L√∂schen">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // === DRAG & DROP HANDLERS ===

        let draggedData = {
            type: null, // 'mitarbeiter', 'schichtTyp', 'schicht'
            id: null
        };

        // üÜï Auto-Fill Data
        let autoFillData = {
            schicht: null,
            startDatum: null,
            mitarbeiterId: null,
            previewCells: [] // Array of cell elements being previewed
        };

        function handleMitarbeiterDragStart(event, mitarbeiterId) {
            draggedData = {
                type: 'mitarbeiter',
                id: mitarbeiterId
            };
            event.dataTransfer.effectAllowed = 'copy';
            event.target.classList.add('dragging');
        }

        function handleSchichtTypDragStart(event, schichtTypId) {
            draggedData = {
                type: 'schichtTyp',
                id: schichtTypId
            };
            event.dataTransfer.effectAllowed = 'copy';
            event.target.classList.add('dragging');
        }

        function handleSchichtDragStart(event, schichtId) {
            draggedData = {
                type: 'schicht',
                id: schichtId
            };
            event.dataTransfer.effectAllowed = 'move';
            event.target.classList.add('dragging');
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = draggedData.type === 'schicht' ? 'move' : 'copy';
            event.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }

        async function handleDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');

            // Remove dragging class
            document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));

            const dropZone = event.currentTarget;
            const mitarbeiterId = dropZone.dataset.mitarbeiterId; // Week view has this
            const datum = dropZone.dataset.datum;

            if (!datum) {
                showToast('‚ùå Ung√ºltige Drop-Zone', 'error');
                return;
            }

            try {
                if (draggedData.type === 'mitarbeiter') {
                    // Scenario 1: Mitarbeiter auf Tag ziehen
                    const droppedMitarbeiterId = currentView === 'week' ? mitarbeiterId : draggedData.id;
                    openSchichtZuweisenModal(droppedMitarbeiterId, datum);

                } else if (draggedData.type === 'schichtTyp') {
                    // Scenario 2: Schicht-Typ auf Tag ziehen
                    const targetMitarbeiterId = currentView === 'week' ? mitarbeiterId : null;

                    if (!targetMitarbeiterId) {
                        // Month view: Need to ask which mitarbeiter
                        // For simplicity, we'll ask via modal
                        openSchichtZuweisenModal(null, datum, draggedData.id);
                    } else {
                        // Week view: Direct assignment
                        await createSchicht(targetMitarbeiterId, datum, draggedData.id);
                    }

                } else if (draggedData.type === 'schicht') {
                    // Scenario 3 or 4: Schicht verschieben oder tauschen
                    const schicht = allSchichten.find(s => String(s.id) === String(draggedData.id));
                    const targetMitarbeiterId = currentView === 'week' ? mitarbeiterId : null;

                    if (!schicht) {
                        showToast('‚ùå Schicht nicht gefunden', 'error');
                        return;
                    }

                    if (targetMitarbeiterId && String(targetMitarbeiterId) !== String(schicht.mitarbeiterId)) {
                        // Scenario 4: Tausch zwischen Mitarbeitern
                        await tauschSchicht(schicht.id, targetMitarbeiterId, datum);
                    } else {
                        // Scenario 3: Verschieben zu anderem Datum
                        await verschiebeSchicht(schicht.id, datum);
                    }
                }

            } catch (error) {
                console.error('‚ùå Drop-Fehler:', error);
                showToast('‚ùå Fehler beim Zuweisen', 'error');
            }

            // Reset dragged data
            draggedData = { type: null, id: null };
        }

        // === üÜï AUTO-FILL DRAG & DROP ===

        function handleAutoFillDragStart(event, schichtId) {
            event.stopPropagation(); // Prevent normal schicht drag

            const schicht = allSchichten.find(s => String(s.id) === String(schichtId));
            if (!schicht) {
                console.error('‚ùå Schicht nicht gefunden:', schichtId);
                return;
            }

            autoFillData = {
                schicht: schicht,
                startDatum: schicht.datum,
                mitarbeiterId: schicht.mitarbeiterId,
                previewCells: []
            };

            // Set drag image (small visual feedback)
            event.dataTransfer.effectAllowed = 'copy';
            event.dataTransfer.setData('text/plain', schichtId);

            console.log('üéØ Auto-Fill Drag Start:', schicht);
        }

        function handleAutoFillDragOver(event, mitarbeiterId, datum) {
            if (!autoFillData.schicht) return; // Not an auto-fill drag

            event.preventDefault();

            // Only allow on same mitarbeiter
            if (String(mitarbeiterId) !== String(autoFillData.mitarbeiterId)) {
                return;
            }

            // Only allow forward dates (or same date)
            if (datum < autoFillData.startDatum) {
                return;
            }

            // Add preview class
            const cell = event.currentTarget;
            if (!cell.classList.contains('auto-fill-preview')) {
                cell.classList.add('auto-fill-preview');
                autoFillData.previewCells.push(cell);
            }
        }

        async function handleAutoFillDrop(event, mitarbeiterId, datum) {
            if (!autoFillData.schicht) return; // Not an auto-fill drag

            event.preventDefault();
            event.stopPropagation();

            // Clear preview
            clearAutoFillPreview();

            // Validate same mitarbeiter
            if (String(mitarbeiterId) !== String(autoFillData.mitarbeiterId)) {
                showToast('‚ö†Ô∏è Auto-Fill nur f√ºr gleichen Mitarbeiter', 'warning');
                autoFillData = { schicht: null, startDatum: null, mitarbeiterId: null, previewCells: [] };
                return;
            }

            // Get all dates between start and end
            const startDate = new Date(autoFillData.startDatum);
            const endDate = new Date(datum);

            if (endDate < startDate) {
                showToast('‚ö†Ô∏è Bitte nach rechts ziehen (zuk√ºnftige Tage)', 'warning');
                autoFillData = { schicht: null, startDatum: null, mitarbeiterId: null, previewCells: [] };
                return;
            }

            const dates = [];
            let currentDate = new Date(startDate);
            currentDate.setDate(currentDate.getDate() + 1); // Start from next day

            while (currentDate <= endDate) {
                dates.push(formatDate(currentDate, 'YYYY-MM-DD'));
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // Batch create schichten
            let createdCount = 0;
            let skippedCount = 0;

            for (const dateStr of dates) {
                // Check if exists
                const existing = allSchichten.find(s =>
                    String(s.mitarbeiterId) === String(mitarbeiterId) &&
                    s.datum === dateStr &&
                    String(s.schichtTypId) === String(autoFillData.schicht.schichtTypId)
                );

                if (existing) {
                    skippedCount++;
                    continue;
                }

                // Create copy
                await createSchicht(mitarbeiterId, dateStr, autoFillData.schicht.schichtTypId);
                createdCount++;
            }

            if (createdCount > 0) {
                showToast(`‚úÖ ${createdCount} Schicht${createdCount > 1 ? 'en' : ''} kopiert${skippedCount > 0 ? `, ${skippedCount} √ºbersprungen` : ''}`, 'success');
            } else {
                showToast('‚ÑπÔ∏è Alle Schichten existieren bereits', 'info');
            }

            // Reset
            autoFillData = { schicht: null, startDatum: null, mitarbeiterId: null, previewCells: [] };
        }

        function clearAutoFillPreview() {
            autoFillData.previewCells.forEach(cell => {
                cell.classList.remove('auto-fill-preview');
            });
            autoFillData.previewCells = [];
        }

        // === SCHICHT OPERATIONS ===

        async function createSchicht(mitarbeiterId, datum, schichtTypId) {
            try {
                // Check if schicht already exists
                const existing = allSchichten.find(s =>
                    String(s.mitarbeiterId) === String(mitarbeiterId) &&
                    s.datum === datum &&
                    String(s.schichtTypId) === String(schichtTypId)
                );

                if (existing) {
                    showToast('‚ö†Ô∏è Diese Schicht existiert bereits', 'warning');
                    return;
                }

                const currentUser = window.authManager?.getCurrentUser();
                const mitarbeiter = allMitarbeiter.find(m => String(m.id) === String(mitarbeiterId));
                const schichtTyp = allSchichtTypen.find(st => String(st.id) === String(schichtTypId));

                // Validation
                if (!mitarbeiter) {
                    showToast('‚ùå Mitarbeiter nicht gefunden', 'error');
                    return;
                }
                if (!schichtTyp) {
                    showToast('‚ùå Schicht-Typ nicht gefunden', 'error');
                    return;
                }

                await window.getCollection('schichten').add({
                    mitarbeiterId: mitarbeiterId,
                    mitarbeiterName: mitarbeiter.name || mitarbeiter.email || 'Unbekannt',
                    datum: datum,
                    schichtTypId: schichtTypId,
                    schichtTypName: schichtTyp.name,
                    status: 'active',
                    erstelltVon: currentUser?.uid || 'system',
                    erstelltAm: new Date().toISOString(),
                    werkstattId: window.werkstattId
                });

                showToast(`‚úÖ Schicht "${schichtTyp.name}" f√ºr ${mitarbeiter.name || 'Mitarbeiter'} erstellt`, 'success');
                await loadSchichten();
                renderCalendar();

            } catch (error) {
                console.error('‚ùå Fehler beim Erstellen der Schicht:', error);
                showToast('‚ùå Fehler beim Erstellen der Schicht', 'error');
            }
        }

        async function verschiebeSchicht(schichtId, neuesDatum) {
            try {
                const schicht = allSchichten.find(s => String(s.id) === String(schichtId));

                if (schicht.datum === neuesDatum) {
                    showToast('‚ö†Ô∏è Schicht ist bereits an diesem Datum', 'warning');
                    return;
                }

                await window.getCollection('schichten').doc(schichtId).update({
                    datum: neuesDatum,
                    bearbeitetAm: new Date().toISOString()
                });

                showToast(`‚úÖ Schicht verschoben zu ${formatDate(new Date(neuesDatum), 'DD.MM.YYYY')}`, 'success');
                await loadSchichten();
                renderCalendar();

            } catch (error) {
                console.error('‚ùå Fehler beim Verschieben:', error);
                showToast('‚ùå Fehler beim Verschieben', 'error');
            }
        }

        async function tauschSchicht(schichtId, neuerMitarbeiterId, datum) {
            try {
                const schicht = allSchichten.find(s => String(s.id) === String(schichtId));
                const neuerMitarbeiter = allMitarbeiter.find(m => String(m.id) === String(neuerMitarbeiterId));

                await window.getCollection('schichten').doc(schichtId).update({
                    mitarbeiterId: neuerMitarbeiterId,
                    mitarbeiterName: neuerMitarbeiter.name,
                    datum: datum,
                    bearbeitetAm: new Date().toISOString()
                });

                showToast(`‚úÖ Schicht zu ${neuerMitarbeiter.name} getauscht`, 'success');
                await loadSchichten();
                renderCalendar();

            } catch (error) {
                console.error('‚ùå Fehler beim Tauschen:', error);
                showToast('‚ùå Fehler beim Tauschen', 'error');
            }
        }

        // === SCHICHT-TYP MODAL ===

        function openSchichtTypModal() {
            document.getElementById('editSchichtTypId').value = '';
            document.getElementById('modalSchichtTypTitle').textContent = 'üé® Schicht-Typ erstellen';
            document.getElementById('btnSchichtTypText').textContent = 'Erstellen';
            document.getElementById('schichtTypForm').reset();
            document.getElementById('schichtFarbe').value = '#1a73e8';
            document.getElementById('schichtTypModal').classList.add('show');
        }

        function closeSchichtTypModal() {
            document.getElementById('schichtTypModal').classList.remove('show');
        }

        async function editSchichtTyp(schichtTypId) {
            const schichtTyp = allSchichtTypen.find(st => String(st.id) === String(schichtTypId));
            if (!schichtTyp) return;

            document.getElementById('editSchichtTypId').value = schichtTyp.id;
            document.getElementById('modalSchichtTypTitle').textContent = 'üé® Schicht-Typ bearbeiten';
            document.getElementById('btnSchichtTypText').textContent = 'Speichern';
            document.getElementById('schichtName').value = schichtTyp.name;
            document.getElementById('schichtStart').value = schichtTyp.startzeit;
            document.getElementById('schichtEnde').value = schichtTyp.endzeit;
            document.getElementById('schichtFarbe').value = schichtTyp.farbe;
            document.getElementById('schichtTypModal').classList.add('show');
        }

        async function saveSchichtTyp(event) {
            event.preventDefault();

            const editId = document.getElementById('editSchichtTypId').value;
            const name = document.getElementById('schichtName').value.trim();
            const startzeit = document.getElementById('schichtStart').value;
            const endzeit = document.getElementById('schichtEnde').value;
            const farbe = document.getElementById('schichtFarbe').value;

            if (!name || !startzeit || !endzeit || !farbe) {
                showToast('‚ùå Bitte alle Felder ausf√ºllen', 'error');
                return;
            }

            try {
                const data = {
                    name: name,
                    startzeit: startzeit,
                    endzeit: endzeit,
                    farbe: farbe,
                    werkstattId: window.werkstattId
                };

                if (editId) {
                    // Update
                    await window.getCollection('schichtTypen').doc(editId).update(data);
                    showToast(`‚úÖ Schicht-Typ "${name}" aktualisiert`, 'success');
                } else {
                    // Create
                    await window.getCollection('schichtTypen').add(data);
                    showToast(`‚úÖ Schicht-Typ "${name}" erstellt`, 'success');
                }

                closeSchichtTypModal();
                await loadSchichtTypen();
                renderSchichttypenPalette();
                renderCalendar();

            } catch (error) {
                console.error('‚ùå Fehler beim Speichern:', error);
                showToast('‚ùå Fehler beim Speichern', 'error');
            }
        }

        async function deleteSchichtTyp(schichtTypId) {
            const schichtTyp = allSchichtTypen.find(st => String(st.id) === String(schichtTypId));
            if (!schichtTyp) return;

            // Check if schichtTyp is used
            const used = allSchichten.some(s => String(s.schichtTypId) === String(schichtTypId));
            if (used) {
                alert('‚ö†Ô∏è Dieser Schicht-Typ wird noch verwendet und kann nicht gel√∂scht werden!');
                return;
            }

            if (!confirm(`M√∂chtest du den Schicht-Typ "${schichtTyp.name}" wirklich l√∂schen?`)) {
                return;
            }

            try {
                await window.getCollection('schichtTypen').doc(schichtTypId).delete();
                showToast(`‚úÖ Schicht-Typ "${schichtTyp.name}" gel√∂scht`, 'success');
                await loadSchichtTypen();
                renderSchichttypenPalette();

            } catch (error) {
                console.error('‚ùå Fehler beim L√∂schen:', error);
                showToast('‚ùå Fehler beim L√∂schen', 'error');
            }
        }

        // === üÜï SCHICHT L√ñSCHEN ===

        async function deleteSchicht(schichtId) {
            const schicht = allSchichten.find(s => String(s.id) === String(schichtId));
            if (!schicht) {
                showToast('‚ùå Schicht nicht gefunden', 'error');
                return;
            }

            const schichtTyp = allSchichtTypen.find(st => String(st.id) === String(schicht.schichtTypId));
            const mitarbeiter = allMitarbeiter.find(m => String(m.id) === String(schicht.mitarbeiterId));
            const schichtName = schichtTyp ? schichtTyp.name : 'Schicht';
            const mitarbeiterName = mitarbeiter ? mitarbeiter.name : 'Unbekannt';
            const datumFormatted = formatDate(new Date(schicht.datum), 'DD.MM.YYYY');

            if (!confirm(`M√∂chtest du die Schicht wirklich l√∂schen?\n\n${mitarbeiterName} ¬∑ ${schichtName}\n${datumFormatted}`)) {
                return;
            }

            try {
                // Delete from Firestore
                await window.getCollection('schichten').doc(schichtId).delete();

                // Handle special schicht types - revert counters
                if (schichtTyp && schichtTyp.isSpecial && mitarbeiter) {
                    if (schichtTyp.type === 'urlaub') {
                        // Decrement urlaubstageVerbraucht
                        const newVerbraucht = Math.max(0, (mitarbeiter.urlaubstageVerbraucht || 0) - 1);
                        await window.getCollection('mitarbeiter').doc(schicht.mitarbeiterId).update({
                            urlaubstageVerbraucht: newVerbraucht
                        });
                        console.log(`‚úÖ Urlaubstage zur√ºckgebucht: ${newVerbraucht}`);
                    } else if (schichtTyp.type === 'krank') {
                        // Decrement krankheitstage
                        const newKrank = Math.max(0, (mitarbeiter.krankheitstage || 0) - 1);
                        await window.getCollection('mitarbeiter').doc(schicht.mitarbeiterId).update({
                            krankheitstage: newKrank
                        });
                        console.log(`‚úÖ Krankheitstage zur√ºckgebucht: ${newKrank}`);
                    }
                }

                showToast(`‚úÖ Schicht "${schichtName}" gel√∂scht`, 'success');

                // Reload data and update UI
                await loadSchichten();
                await loadMitarbeiter(); // Reload to get updated counters
                updateCalendarView();

            } catch (error) {
                console.error('‚ùå Fehler beim L√∂schen der Schicht:', error);

                // Diagnose specific errors
                if (error.code === 'permission-denied') {
                    showToast('‚ùå Keine Berechtigung zum L√∂schen von Schichten', 'error');
                } else if (error.code === 'not-found') {
                    showToast('‚ùå Schicht nicht gefunden', 'error');
                } else {
                    showToast('‚ùå Fehler beim L√∂schen', 'error');
                }
            }
        }

        // === üÜï BEREICH MODAL ===

        function openBereichModal() {
            document.getElementById('editBereichId').value = '';
            document.getElementById('modalBereichTitle').textContent = 'üè¢ Bereich erstellen';
            document.getElementById('btnBereichText').textContent = 'Erstellen';
            document.getElementById('bereichForm').reset();
            document.getElementById('bereichFarbe').value = '#1a73e8';
            document.getElementById('bereichModal').classList.add('show');
        }

        function closeBereichModal() {
            document.getElementById('bereichModal').classList.remove('show');
        }

        async function editBereich(bereichId) {
            const bereich = allBereiche.find(b => String(b.id) === String(bereichId));
            if (!bereich) return;

            document.getElementById('editBereichId').value = bereich.id;
            document.getElementById('modalBereichTitle').textContent = 'üè¢ Bereich bearbeiten';
            document.getElementById('btnBereichText').textContent = 'Speichern';
            document.getElementById('bereichName').value = bereich.name;
            document.getElementById('bereichFarbe').value = bereich.farbe;
            document.getElementById('bereichModal').classList.add('show');
        }

        async function saveBereich(event) {
            event.preventDefault();

            const editId = document.getElementById('editBereichId').value;
            const name = document.getElementById('bereichName').value.trim();
            const farbe = document.getElementById('bereichFarbe').value;

            if (!name || !farbe) {
                showToast('‚ùå Bitte alle Felder ausf√ºllen', 'error');
                return;
            }

            try {
                const data = {
                    name: name,
                    farbe: farbe,
                    werkstattId: window.werkstattId
                };

                if (editId) {
                    // Update
                    await window.getCollection('bereiche').doc(editId).update(data);
                    showToast(`‚úÖ Bereich "${name}" aktualisiert`, 'success');
                } else {
                    // Create
                    await window.getCollection('bereiche').add(data);
                    showToast(`‚úÖ Bereich "${name}" erstellt`, 'success');
                }

                closeBereichModal();
                await loadBereiche();
                renderBereichePalette();

            } catch (error) {
                console.error('‚ùå Fehler beim Speichern:', error);
                showToast('‚ùå Fehler beim Speichern', 'error');
            }
        }

        async function deleteBereich(bereichId) {
            const bereich = allBereiche.find(b => String(b.id) === String(bereichId));
            if (!bereich) return;

            // Check if bereich is used in schichten
            const used = allSchichten.some(s => s.bereichId && String(s.bereichId) === String(bereichId));
            if (used) {
                alert('‚ö†Ô∏è Dieser Bereich wird noch verwendet und kann nicht gel√∂scht werden!');
                return;
            }

            if (!confirm(`M√∂chtest du den Bereich "${bereich.name}" wirklich l√∂schen?`)) {
                return;
            }

            try {
                await window.getCollection('bereiche').doc(bereichId).delete();
                showToast(`‚úÖ Bereich "${bereich.name}" gel√∂scht`, 'success');
                await loadBereiche();
                renderBereichePalette();

            } catch (error) {
                console.error('‚ùå Fehler beim L√∂schen:', error);
                showToast('‚ùå Fehler beim L√∂schen', 'error');
            }
        }

        // === SCHICHT ZUWEISEN MODAL ===

        function toggleMultiDaySelection() {
            const checkbox = document.getElementById('multiDayCheckbox');
            const selection = document.getElementById('multiDaySelection');
            selection.style.display = checkbox.checked ? 'block' : 'none';
        }

        function openSchichtZuweisenModal(mitarbeiterId, datum, preselectedSchichtTypId = null) {
            document.getElementById('zuweisenMitarbeiterId').value = mitarbeiterId || '';
            document.getElementById('zuweisenDatum').value = datum;

            // üÜï Reset multi-day selection
            document.getElementById('multiDayCheckbox').checked = false;
            document.getElementById('multiDaySelection').style.display = 'none';

            // üÜï Smart Defaults: Wenn Montag ‚Üí Mo-Fr vorselektieren
            const date = new Date(datum);
            const dayOfWeek = date.getDay(); // 0=So, 1=Mo, 2=Di, ...

            if (dayOfWeek === 1) { // Montag
                // Auto-check multi-day checkbox
                document.getElementById('multiDayCheckbox').checked = true;
                document.getElementById('multiDaySelection').style.display = 'block';

                // Preselect Mo-Fr
                document.getElementById('day-mo').checked = true;
                document.getElementById('day-di').checked = true;
                document.getElementById('day-mi').checked = true;
                document.getElementById('day-do').checked = true;
                document.getElementById('day-fr').checked = true;
                document.getElementById('day-sa').checked = false;
                document.getElementById('day-so').checked = false;
            } else {
                // Reset all checkboxes
                document.querySelectorAll('.multiday-checkbox').forEach(cb => cb.checked = false);
            }

            const mitarbeiter = mitarbeiterId ? allMitarbeiter.find(m => String(m.id) === String(mitarbeiterId)) : null;
            document.getElementById('zuweisenMitarbeiterName').textContent = mitarbeiter ? mitarbeiter.name : 'Bitte w√§hlen';
            document.getElementById('zuweisenDatumText').textContent = formatDate(new Date(datum), 'DD.MM.YYYY (dddd)');

            // Populate schichtTypen dropdown
            const select = document.getElementById('zuweisenSchichtTyp');
            select.innerHTML = '<option value="">-- Bitte w√§hlen --</option>';
            for (const schichtTyp of allSchichtTypen) {
                const option = document.createElement('option');
                option.value = schichtTyp.id;
                option.textContent = `${schichtTyp.name} (${schichtTyp.startzeit} - ${schichtTyp.endzeit})`;
                if (preselectedSchichtTypId && String(schichtTyp.id) === String(preselectedSchichtTypId)) {
                    option.selected = true;
                }
                select.appendChild(option);
            }

            document.getElementById('schichtZuweisenModal').classList.add('show');
        }

        function closeSchichtZuweisenModal() {
            document.getElementById('schichtZuweisenModal').classList.remove('show');
        }

        async function saveSchichtZuweisung(event) {
            event.preventDefault();

            const mitarbeiterId = document.getElementById('zuweisenMitarbeiterId').value;
            const datum = document.getElementById('zuweisenDatum').value;
            const schichtTypId = document.getElementById('zuweisenSchichtTyp').value;

            if (!mitarbeiterId || !datum || !schichtTypId) {
                showToast('‚ùå Bitte alle Felder ausf√ºllen', 'error');
                return;
            }

            // üÜï Multi-Day Handling
            const multiDayEnabled = document.getElementById('multiDayCheckbox').checked;

            if (multiDayEnabled) {
                // Get selected days
                const selectedDays = [];
                document.querySelectorAll('.multiday-checkbox:checked').forEach(cb => {
                    selectedDays.push(parseInt(cb.value));
                });

                if (selectedDays.length === 0) {
                    showToast('‚ö†Ô∏è Bitte w√§hle mindestens einen Tag aus', 'warning');
                    return;
                }

                // Create schichten for all selected days (next 4 weeks)
                const startDate = new Date(datum);
                const createdCount = {
                    success: 0,
                    skipped: 0
                };

                for (let week = 0; week < 4; week++) {
                    for (const dayOfWeek of selectedDays) {
                        const targetDate = new Date(startDate);
                        targetDate.setDate(startDate.getDate() + (week * 7));

                        // Adjust to correct day of week
                        const currentDay = targetDate.getDay();
                        const diff = dayOfWeek - currentDay;
                        targetDate.setDate(targetDate.getDate() + diff);

                        const dateStr = formatDate(targetDate, 'YYYY-MM-DD');

                        // Check if schicht already exists
                        const existing = allSchichten.find(s =>
                            String(s.mitarbeiterId) === String(mitarbeiterId) &&
                            s.datum === dateStr &&
                            String(s.schichtTypId) === String(schichtTypId)
                        );

                        if (!existing) {
                            await createSchicht(mitarbeiterId, dateStr, schichtTypId);
                            createdCount.success++;
                        } else {
                            createdCount.skipped++;
                        }
                    }
                }

                showToast(`‚úÖ ${createdCount.success} Schichten erstellt${createdCount.skipped > 0 ? `, ${createdCount.skipped} √ºbersprungen` : ''}`, 'success');

            } else {
                // Single day
                await createSchicht(mitarbeiterId, datum, schichtTypId);
            }

            closeSchichtZuweisenModal();
        }

        // === üÜï BEREICH ZUWEISEN MODAL ===

        function openBereichZuweisenModal(schichtId) {
            const schicht = allSchichten.find(s => String(s.id) === String(schichtId));
            if (!schicht) {
                showToast('‚ùå Schicht nicht gefunden', 'error');
                return;
            }

            document.getElementById('zuweisenSchichtId').value = schichtId;

            // Show schicht info
            const schichtTyp = allSchichtTypen.find(st => String(st.id) === String(schicht.schichtTypId));
            const mitarbeiter = allMitarbeiter.find(m => String(m.id) === String(schicht.mitarbeiterId));
            const infoText = `${mitarbeiter ? mitarbeiter.name : 'Unbekannt'} ¬∑ ${schichtTyp ? schichtTyp.name : 'Unbekannt'} ¬∑ ${formatDate(new Date(schicht.datum), 'DD.MM.YYYY')}`;
            document.getElementById('zuweisenSchichtInfo').textContent = infoText;

            // Populate bereiche dropdown
            const select = document.getElementById('zuweisenBereich');
            select.innerHTML = '<option value="">-- Kein Bereich --</option>';
            for (const bereich of allBereiche) {
                const option = document.createElement('option');
                option.value = bereich.id;
                option.textContent = bereich.name;
                if (schicht.bereichId && String(bereich.id) === String(schicht.bereichId)) {
                    option.selected = true;
                }
                select.appendChild(option);
            }

            document.getElementById('bereichZuweisenModal').classList.add('show');
        }

        function closeBereichZuweisenModal() {
            document.getElementById('bereichZuweisenModal').classList.remove('show');
        }

        async function saveBereichZuweisung(event) {
            event.preventDefault();

            const schichtId = document.getElementById('zuweisenSchichtId').value;
            const bereichId = document.getElementById('zuweisenBereich').value;

            if (!schichtId) {
                showToast('‚ùå Schicht-ID fehlt', 'error');
                return;
            }

            try {
                const updateData = {
                    bereichId: bereichId || null,
                    bereichName: null,
                    bereichFarbe: null
                };

                if (bereichId) {
                    const bereich = allBereiche.find(b => String(b.id) === String(bereichId));
                    if (bereich) {
                        updateData.bereichName = bereich.name;
                        updateData.bereichFarbe = bereich.farbe;
                    }
                }

                await window.getCollection('schichten').doc(schichtId).update(updateData);

                showToast(bereichId ? `‚úÖ Bereich zugewiesen` : `‚úÖ Bereich entfernt`, 'success');
                await loadSchichten();
                renderCalendar();
                closeBereichZuweisenModal();

            } catch (error) {
                console.error('‚ùå Fehler beim Zuweisen:', error);
                showToast('‚ùå Fehler beim Zuweisen', 'error');
            }
        }

        // === üÜï CONTEXT MENU (Urlaub/Frei/Krank) ===

        let contextMenuData = {
            mitarbeiterId: null,
            datum: null
        };

        function showContextMenu(event, mitarbeiterId, datum) {
            event.preventDefault();

            contextMenuData = { mitarbeiterId, datum };

            const menu = document.getElementById('contextMenu');
            const optionsContainer = document.getElementById('contextMenuOptions');

            // Get special schicht-typen
            const urlaubTyp = allSchichtTypen.find(st => st.isSpecial && st.type === 'urlaub');
            const freiTyp = allSchichtTypen.find(st => st.isSpecial && st.type === 'frei');
            const krankTyp = allSchichtTypen.find(st => st.isSpecial && st.type === 'krank');

            let html = '';
            if (urlaubTyp) {
                html += `<div onclick="createSpecialSchicht('urlaub')" style="padding: 10px; cursor: pointer; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">üèñÔ∏è Als Urlaub markieren</div>`;
            }
            if (freiTyp) {
                html += `<div onclick="createSpecialSchicht('frei')" style="padding: 10px; cursor: pointer; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">üåô Als Frei markieren</div>`;
            }
            if (krankTyp) {
                html += `<div onclick="createSpecialSchicht('krank')" style="padding: 10px; cursor: pointer; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">ü§í Als Krank markieren</div>`;
            }

            // üÜï Delete option if schicht exists
            const existingSchicht = allSchichten.find(s =>
                String(s.mitarbeiterId) === String(mitarbeiterId) &&
                s.datum === datum
            );

            if (existingSchicht) {
                // Add separator if there are other options
                if (html.length > 0) {
                    html += `<div style="height: 1px; background: rgba(255,255,255,0.1); margin: 8px 0;"></div>`;
                }
                html += `<div onclick="deleteSchicht('${existingSchicht.id}')" style="padding: 10px; cursor: pointer; border-radius: 6px; transition: background 0.2s; color: #ff4444;" onmouseover="this.style.background='rgba(255,68,68,0.2)'" onmouseout="this.style.background='transparent'">üóëÔ∏è Schicht l√∂schen</div>`;
            }

            optionsContainer.innerHTML = html;

            // Position menu at mouse
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';
            menu.style.display = 'block';
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').style.display = 'none';
        }

        // Hide context menu when clicking anywhere else
        document.addEventListener('click', hideContextMenu);

        async function createSpecialSchicht(type) {
            hideContextMenu();

            const { mitarbeiterId, datum } = contextMenuData;

            if (!mitarbeiterId || !datum) {
                showToast('‚ùå Fehler: Keine Daten verf√ºgbar', 'error');
                return;
            }

            try {
                // Find special schicht-typ
                const schichtTyp = allSchichtTypen.find(st => st.isSpecial && st.type === type);
                if (!schichtTyp) {
                    showToast('‚ùå Schicht-Typ nicht gefunden', 'error');
                    return;
                }

                // Get mitarbeiter
                const mitarbeiter = allMitarbeiter.find(m => String(m.id) === String(mitarbeiterId));
                if (!mitarbeiter) {
                    showToast('‚ùå Mitarbeiter nicht gefunden', 'error');
                    return;
                }

                // Urlaubstage-Check
                if (type === 'urlaub') {
                    const urlaubstageJahr = mitarbeiter.urlaubstageJahr || 30;
                    const urlaubstageVerbraucht = mitarbeiter.urlaubstageVerbraucht || 0;
                    const verfuegbar = urlaubstageJahr - urlaubstageVerbraucht;

                    if (verfuegbar <= 0) {
                        const confirm = window.confirm(`‚ö†Ô∏è Warnung: ${mitarbeiter.name} hat alle Urlaubstage verbraucht (${urlaubstageVerbraucht}/${urlaubstageJahr}).\n\nTrotzdem fortfahren?`);
                        if (!confirm) return;
                    }
                }

                // Create schicht
                await createSchicht(mitarbeiterId, datum, schichtTyp.id);

                // Update counters
                if (type === 'urlaub') {
                    // Update urlaubstageVerbraucht
                    const newVerbraucht = (mitarbeiter.urlaubstageVerbraucht || 0) + 1;
                    await window.getCollection('mitarbeiter').doc(mitarbeiterId).update({
                        urlaubstageVerbraucht: newVerbraucht
                    });
                    console.log(`‚úÖ Urlaubstage aktualisiert: ${newVerbraucht}`);
                } else if (type === 'krank') {
                    // Update krankheitstage
                    const newKrank = (mitarbeiter.krankheitstage || 0) + 1;
                    await window.getCollection('mitarbeiter').doc(mitarbeiterId).update({
                        krankheitstage: newKrank,
                        letzteKrankheitAm: new Date().toISOString()
                    });
                    console.log(`‚úÖ Krankheitstage aktualisiert: ${newKrank}`);
                }

                // Reload mitarbeiter to reflect changes
                await loadMitarbeiter();

            } catch (error) {
                console.error('‚ùå Fehler beim Erstellen der Special-Schicht:', error);
                showToast('‚ùå Fehler beim Erstellen', 'error');
            }
        }

        // === W√úNSCHE & TAUSCHE RENDERING ===

        function renderWuensche() {
            const container = document.getElementById('wuenscheList');

            if (allWuensche.length === 0) {
                container.innerHTML = '<p style="opacity: 0.7;">Keine W√ºnsche vorhanden</p>';
                return;
            }

            let html = '';
            for (const wunsch of allWuensche) {
                const mitarbeiter = allMitarbeiter.find(m => String(m.id) === String(wunsch.mitarbeiterId));
                html += `
                    <div style="background: var(--color-surface-light); border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                            <div>
                                <strong>${mitarbeiter ? mitarbeiter.name : 'Unbekannt'}</strong>
                                <div style="font-size: 14px; opacity: 0.7; margin-top: 4px;">
                                    ${formatDate(new Date(wunsch.datum), 'DD.MM.YYYY (dddd)')}
                                </div>
                            </div>
                            <span class="badge ${wunsch.praeferenz === 'bevorzugt' ? 'badge-success' : 'badge-warning'}">
                                ${wunsch.praeferenz === 'bevorzugt' ? '‚úÖ Bevorzugt' : '‚õî Nicht verf√ºgbar'}
                            </span>
                        </div>
                        ${wunsch.grund ? `<p style="opacity: 0.8; margin-bottom: 16px;">${wunsch.grund}</p>` : ''}
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-small btn-success" onclick="bearbeiteWunsch('${wunsch.id}', 'accepted')">
                                ‚úÖ Ber√ºcksichtigen
                            </button>
                            <button class="btn btn-small btn-secondary" onclick="bearbeiteWunsch('${wunsch.id}', 'rejected')">
                                ‚ùå Ablehnen
                            </button>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        function renderTausche() {
            const container = document.getElementById('tauscheList');

            if (allTausche.length === 0) {
                container.innerHTML = '<p style="opacity: 0.7;">Keine Tausch-Anfragen vorhanden</p>';
                return;
            }

            let html = '';
            for (const tausch of allTausche) {
                const vonMitarbeiter = allMitarbeiter.find(m => String(m.id) === String(tausch.vonMitarbeiterId));
                const nachMitarbeiter = allMitarbeiter.find(m => String(m.id) === String(tausch.nachMitarbeiterId));
                const schicht = allSchichten.find(s => String(s.id) === String(tausch.schichtId));

                html += `
                    <div style="background: var(--color-surface-light); border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                        <div style="margin-bottom: 16px;">
                            <strong>${vonMitarbeiter ? vonMitarbeiter.name : 'Unbekannt'}</strong> m√∂chte mit
                            <strong>${nachMitarbeiter ? nachMitarbeiter.name : 'Unbekannt'}</strong> tauschen
                        </div>
                        ${tausch.grund ? `<p style="opacity: 0.8; margin-bottom: 16px;">${tausch.grund}</p>` : ''}
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-small btn-success" onclick="bearbeiteTausch('${tausch.id}', 'approved')">
                                ‚úÖ Genehmigen
                            </button>
                            <button class="btn btn-small btn-danger" onclick="bearbeiteTausch('${tausch.id}', 'rejected')">
                                ‚ùå Ablehnen
                            </button>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        async function bearbeiteWunsch(wunschId, status) {
            try {
                await window.getCollection('schichtWuensche').doc(wunschId).update({
                    status: status,
                    bearbeitetAm: new Date().toISOString()
                });

                showToast(`‚úÖ Wunsch ${status === 'accepted' ? 'ber√ºcksichtigt' : 'abgelehnt'}`, 'success');
                await loadWuensche();
                renderWuensche();

            } catch (error) {
                console.error('‚ùå Fehler:', error);
                showToast('‚ùå Fehler beim Bearbeiten', 'error');
            }
        }

        async function bearbeiteTausch(tauschId, status) {
            try {
                if (status === 'approved') {
                    const tausch = allTausche.find(t => String(t.id) === String(tauschId));
                    // Execute tausch
                    await tauschSchicht(tausch.schichtId, tausch.nachMitarbeiterId, tausch.datum);
                }

                await window.getCollection('schichtTausche').doc(tauschId).update({
                    status: status,
                    bearbeitetAm: new Date().toISOString()
                });

                showToast(`‚úÖ Tausch ${status === 'approved' ? 'genehmigt' : 'abgelehnt'}`, 'success');
                await loadTausche();
                renderTausche();

            } catch (error) {
                console.error('‚ùå Fehler:', error);
                showToast('‚ùå Fehler beim Bearbeiten', 'error');
            }
        }

        // === HELPER FUNCTIONS ===

        function getMonday(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function getWeekNumber(date) {
            const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const dayNum = d.getUTCDay() || 7;
            d.setUTCDate(d.getUTCDate() + 4 - dayNum);
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            return Math.ceil((((d - yearStart) / 86400000) + 1)/7);
        }

        function isSameDay(date1, date2) {
            return date1.getFullYear() === date2.getFullYear() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getDate() === date2.getDate();
        }

        function formatDate(date, format) {
            const d = new Date(date);
            const months = ['Januar', 'Februar', 'M√§rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
            const weekdays = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];

            const replacements = {
                'YYYY': d.getFullYear(),
                'MM': String(d.getMonth() + 1).padStart(2, '0'),
                'DD': String(d.getDate()).padStart(2, '0'),
                'MMMM': months[d.getMonth()],
                'dddd': weekdays[d.getDay()]
            };

            let result = format;
            for (const [key, value] of Object.entries(replacements)) {
                result = result.replace(key, value);
            }

            return result;
        }

        function getInitials(name) {
            if (!name) return '??';  // Fallback for undefined/null names
            return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        }

        // Toast notification
        function showToast(message, type = 'success', duration = 3000) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, duration);
        }
    </script>
</body>
</html>
