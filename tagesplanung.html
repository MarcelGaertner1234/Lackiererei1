<!DOCTYPE html>
<html lang="de">
<head>
    <script>
        /// <reference path="js/types.js" />
        // window.werkstattId is set automatically after successful login
    </script>
    <script>
        window.DEBUG = (
            localStorage.getItem('DEBUG') === 'true' ||
            window.location.search.includes('debug=true') ||
            window.location.hostname === 'localhost' ||
            window.location.port === '8000'
        );
    </script>

    <!-- FOUC Prevention -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tagesplanung - Priorisierung | Auto-Lackierzentrum Mosbach</title>

    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- Design System -->
    <link rel="stylesheet" href="design-system.css?v=tagesplanung-v1">
    <link rel="stylesheet" href="liquid-glass.css?v=tagesplanung-v1">
    <link rel="stylesheet" href="animations.css?v=tagesplanung-v1">
    <link rel="stylesheet" href="mobile-first.css?v=tagesplanung-v1">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-system);
            background: var(--color-background);
            min-height: 100vh;
            padding: var(--space-4);
            color: var(--color-text-primary);
        }

        /* Header */
        .header {
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-2xl);
            padding: var(--space-4) var(--space-6);
            margin-bottom: var(--space-4);
            box-shadow: var(--shadow-xl);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: var(--space-3);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo { font-size: 36px; }

        .title h1 {
            color: var(--color-primary);
            font-size: 22px;
            margin: 0;
        }

        .title .subtitle {
            color: var(--color-text-secondary);
            font-size: 13px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .date-picker {
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            background: var(--color-surface);
            font-size: 14px;
            color: var(--color-text-primary);
        }

        .nav-btn {
            padding: var(--space-2) var(--space-4);
            background: linear-gradient(135deg, rgba(0, 191, 255, 0.8), rgba(0, 122, 255, 0.7));
            border: none;
            color: white;
            text-decoration: none;
            border-radius: var(--radius-lg);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .nav-btn.success {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.8), rgba(22, 163, 74, 0.7));
        }

        /* Main Layout */
        .main-container {
            display: grid;
            grid-template-columns: 260px 1fr;
            gap: var(--space-4);
            height: calc(100vh - 140px);
        }

        /* Ungeplant Section */
        .ungeplant-section {
            background: var(--color-surface);
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-xl);
            padding: var(--space-4);
            overflow-y: auto;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-3);
            padding-bottom: var(--space-2);
            border-bottom: 1px solid var(--color-border);
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .count-badge {
            background: var(--color-primary);
            color: white;
            padding: 2px 8px;
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 600;
        }

        .sort-select {
            padding: 4px 8px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 12px;
            background: var(--color-surface);
        }

        /* Fahrzeug Cards */
        .fahrzeug-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-3);
            margin-bottom: var(--space-2);
            cursor: grab;
            transition: all 0.2s;
            position: relative;
        }

        .fahrzeug-card:hover {
            border-color: var(--color-primary);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .fahrzeug-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .fahrzeug-card .kennzeichen {
            font-weight: 700;
            font-size: 15px;
            margin-bottom: 4px;
        }

        .fahrzeug-card .info {
            font-size: 12px;
            color: var(--color-text-secondary);
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .fahrzeug-card .service-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            font-size: 11px;
            font-weight: 500;
        }

        .fahrzeug-card .dringlichkeit {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .dringlichkeit.hoch { background: #ef4444; }
        .dringlichkeit.mittel { background: #f59e0b; }
        .dringlichkeit.niedrig { background: #6b7280; }

        /* Queue Sections - Logistik + Werkstatt */
        .queues-container {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
            overflow-y: auto;
        }

        .queue-group {
            background: rgba(59, 130, 246, 0.03);
            border: 1px solid var(--color-border-glass);
            border-left: 4px solid var(--color-primary);
            border-radius: var(--radius-xl);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .queue-group-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: var(--space-3);
            padding-bottom: var(--space-2);
            border-bottom: 2px solid var(--color-border);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .queue-section {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-3);
        }

        .queue-section.werkstatt {
            grid-template-columns: repeat(4, 1fr);
        }

        @media (min-width: 1800px) {
            .queue-section.werkstatt {
                grid-template-columns: repeat(6, 1fr);
            }
        }

        @media (max-width: 1200px) {
            .queue-section.werkstatt {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 900px) {
            .queue-section,
            .queue-section.werkstatt {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .queue-column {
            background: var(--color-surface);
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-xl);
            padding: var(--space-3);
            min-height: auto;
            height: fit-content;
            max-height: 450px;
            display: flex;
            flex-direction: column;
        }

        /* Service-farbige Borders */
        .queue-column[data-queue="lackier"] { border-top: 3px solid #dc2626; }
        .queue-column[data-queue="mechanik"] { border-top: 3px solid #2563eb; }
        .queue-column[data-queue="reifen"] { border-top: 3px solid #16a34a; }
        .queue-column[data-queue="pflege"] { border-top: 3px solid #9333ea; }
        .queue-column[data-queue="glas"] { border-top: 3px solid #06b6d4; }
        .queue-column[data-queue="klima"] { border-top: 3px solid #0ea5e9; }
        .queue-column[data-queue="dellen"] { border-top: 3px solid #f97316; }
        .queue-column[data-queue="folierung"] { border-top: 3px solid #ec4899; }
        .queue-column[data-queue="steinschutz"] { border-top: 3px solid #84cc16; }
        .queue-column[data-queue="werbebeklebung"] { border-top: 3px solid #8b5cf6; }
        .queue-column[data-queue="tuev"] { border-top: 3px solid #64748b; }
        .queue-column[data-queue="versicherung"] { border-top: 3px solid #0d9488; }
        /* Logistik - alle orange */
        .queue-column[data-queue="abholen"],
        .queue-column[data-queue="liefern"],
        .queue-column[data-queue="leih_bringen"],
        .queue-column[data-queue="leih_abholen"] { border-top: 3px solid #f59e0b; }

        .queue-header {
            text-align: center;
            padding-bottom: var(--space-1);
            margin-bottom: var(--space-1);
            border-bottom: 2px solid var(--color-border);
        }

        .queue-header .icon {
            font-size: 18px;
            margin-bottom: 2px;
        }

        .queue-header .name {
            font-weight: 600;
            font-size: 12px;
        }

        .queue-header .queue-count {
            font-size: 10px;
            color: var(--color-text-secondary);
        }

        .queue-items {
            flex: 1;
            overflow-y: auto;
            min-height: 80px;
            padding: var(--space-2);
            border: 2px dashed transparent;
            border-radius: var(--radius-lg);
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .queue-items.drag-over {
            border-color: var(--color-primary);
            background: rgba(0, 122, 255, 0.05);
        }

        .queue-item {
            background: var(--color-background);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: var(--space-2);
            margin-bottom: 0;
            cursor: grab;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .queue-item:hover {
            border-color: var(--color-primary);
        }

        .queue-item.dragging {
            opacity: 0.5;
        }

        /* Multi-Service Badges */
        .service-badges {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-top: 4px;
            font-size: 9px;
        }

        .service-badge {
            padding: 1px 4px;
            border-radius: 3px;
            font-weight: 500;
        }

        .service-badge.fertig {
            background: #dcfce7;
            color: #16a34a;
        }

        .service-badge.offen {
            background: #f3f4f6;
            color: #6b7280;
        }

        .finish-service-btn {
            width: 100%;
            margin-top: 6px;
            padding: 4px 8px;
            background: #dcfce7;
            border: 1px solid #16a34a;
            border-radius: 4px;
            color: #16a34a;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }

        .finish-service-btn:hover {
            background: #16a34a;
            color: white;
        }

        .queue-item .position {
            background: var(--color-primary);
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .queue-item .kennzeichen {
            font-weight: 600;
            font-size: 13px;
            flex: 1;
        }

        .queue-item .remove-btn {
            background: none;
            border: none;
            color: var(--color-text-secondary);
            cursor: pointer;
            padding: 2px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .queue-item:hover .remove-btn {
            opacity: 1;
        }

        .queue-item .remove-btn:hover {
            color: #ef4444;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: var(--space-4);
            color: var(--color-text-secondary);
            font-size: 13px;
        }

        /* Stats Bar */
        .stats-bar {
            background: var(--color-surface);
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-xl);
            padding: var(--space-3) var(--space-4);
            margin-bottom: var(--space-4);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--space-3);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-item .label {
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        .stat-item .value {
            font-size: 18px;
            font-weight: 700;
            color: var(--color-primary);
        }

        /* ðŸ”§ 2025-12-07: KapazitÃ¤ts-Bar Header */
        /* ðŸ”§ FIX 27/28 (2025-12-09): ID-Selektor + height/overflow override */
        /* Das Element hat sowohl class="capacity-bar" als auch id="capacityBar" */
        /* .capacity-bar CSS (Zeile 1402) setzt height:4px und overflow:hidden - das muss Ã¼berschrieben werden! */
        #capacityBar {
            background: var(--color-surface);
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-xl);
            padding: var(--space-3) var(--space-4);
            margin-bottom: var(--space-4);
            height: auto !important;
            overflow: visible !important;
        }

        .capacity-bar-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--color-text-secondary);
            margin-bottom: var(--space-2);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .capacity-items {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-2);
        }

        .capacity-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-lg);
            font-size: 13px;
            font-weight: 500;
            border: 1px solid transparent;
            transition: all 0.2s ease;
        }

        .capacity-item .service-icon {
            font-size: 14px;
        }

        .capacity-item .usage {
            font-weight: 700;
        }

        /* Farbcodierung: GrÃ¼n <80%, Gelb 80-100%, Rot >100% */
        .capacity-item.status-green {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.3);
            color: #16a34a;
        }

        .capacity-item.status-yellow {
            background: rgba(234, 179, 8, 0.15);
            border-color: rgba(234, 179, 8, 0.4);
            color: #ca8a04;
        }

        .capacity-item.status-red {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.4);
            color: #dc2626;
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .capacity-percent {
            font-size: 11px;
            opacity: 0.8;
            margin-left: 2px;
        }

        /* Service Colors */
        .service-lackier { background: rgba(239, 68, 68, 0.15); color: #dc2626; }
        .service-mechanik { background: rgba(59, 130, 246, 0.15); color: #2563eb; }
        .service-reifen { background: rgba(34, 197, 94, 0.15); color: #16a34a; }
        .service-pflege { background: rgba(168, 85, 247, 0.15); color: #9333ea; }
        .service-tuev { background: rgba(249, 115, 22, 0.15); color: #ea580c; }
        .service-default { background: rgba(107, 114, 128, 0.15); color: #4b5563; }

        /* ========================================== */
        /* UNGEPLANT TABS (2025-12-09)                */
        /* ========================================== */

        .ungeplant-tabs {
            display: flex;
            gap: var(--space-1);
            margin-bottom: var(--space-3);
            background: var(--color-background);
            border-radius: var(--radius-lg);
            padding: 3px;
        }

        .ungeplant-tabs .tab {
            flex: 1;
            padding: var(--space-2) var(--space-2);
            border: none;
            background: transparent;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            color: var(--color-text-secondary);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .ungeplant-tabs .tab:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .ungeplant-tabs .tab.active {
            background: var(--color-surface);
            color: var(--color-text-primary);
            box-shadow: var(--shadow-sm);
        }

        .ungeplant-tabs .tab .tab-count {
            background: var(--color-primary);
            color: white;
            padding: 1px 5px;
            border-radius: var(--radius-full);
            font-size: 10px;
            font-weight: 700;
            min-width: 18px;
            text-align: center;
        }

        .ungeplant-tabs .tab.bereit .tab-count {
            background: #16a34a;
        }

        .ungeplant-tabs .tab.logistik .tab-count {
            background: #f59e0b;
        }

        .ungeplant-tabs .tab.zukunft .tab-count {
            background: #6b7280;
        }

        /* Logistik-Status Badges */
        .logistik-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 6px;
        }

        .logistik-badge {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            font-size: 10px;
            font-weight: 500;
        }

        .logistik-badge.ausstehend {
            background: rgba(245, 158, 11, 0.15);
            color: #d97706;
        }

        .logistik-badge.geplant {
            background: rgba(59, 130, 246, 0.15);
            color: #2563eb;
        }

        .logistik-badge.erledigt {
            background: rgba(34, 197, 94, 0.15);
            color: #16a34a;
        }

        /* Start-Status Indicator */
        .start-status {
            margin-top: 6px;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-size: 10px;
            font-weight: 600;
            text-align: center;
        }

        .start-status.gruen {
            background: rgba(34, 197, 94, 0.15);
            color: #16a34a;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .start-status.rot {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        /* Eingetroffen Button */
        .eingetroffen-btn {
            width: 100%;
            margin-top: 6px;
            padding: 6px 8px;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid #16a34a;
            border-radius: var(--radius-md);
            color: #16a34a;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }

        .eingetroffen-btn:hover {
            background: #16a34a;
            color: white;
        }

        /* ðŸ†• Durchplanen-Button (2025-12-09) */
        .durchplanen-btn {
            width: 100%;
            margin-top: 6px;
            padding: 6px 8px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
            border: 1px solid #6366f1;
            border-radius: var(--radius-md);
            color: #6366f1;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }

        .durchplanen-btn:hover {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--color-border);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--color-surface);
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h3 {
            margin-bottom: var(--space-4);
        }

        .modal-actions {
            display: flex;
            gap: var(--space-3);
            margin-top: var(--space-4);
            justify-content: flex-end;
        }

        /* ========================================== */
        /* DURCHPLANEN-MODAL (2025-12-09)             */
        /* Multi-Service-Durchplanung                 */
        /* ========================================== */

        .durchplanen-modal {
            max-width: 700px;
            width: 95%;
            max-height: 90vh;
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        .durchplanen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-4) var(--space-5);
            border-bottom: 1px solid var(--color-border);
            background: linear-gradient(135deg, var(--color-primary), #6366f1);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
        }

        .durchplanen-header h3 {
            margin: 0;
            color: white;
            font-size: 1.1rem;
        }

        .durchplanen-header .modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .durchplanen-header .modal-close:hover {
            background: rgba(255,255,255,0.3);
        }

        .durchplanen-fahrzeug-info {
            padding: var(--space-4) var(--space-5);
            background: var(--color-surface-elevated);
            border-bottom: 1px solid var(--color-border);
        }

        .durchplanen-fahrzeug-info .kennzeichen {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .durchplanen-fahrzeug-info .fahrzeug-details {
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            margin-top: 4px;
        }

        .durchplanen-steps {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-4) var(--space-5);
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }

        .durchplanen-step {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            position: relative;
        }

        .durchplanen-step::before {
            content: '';
            position: absolute;
            left: 24px;
            top: 100%;
            width: 2px;
            height: var(--space-3);
            background: var(--color-border);
        }

        .durchplanen-step:last-child::before {
            display: none;
        }

        .durchplanen-step-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-3);
        }

        .durchplanen-step-number {
            width: 28px;
            height: 28px;
            background: var(--color-primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .durchplanen-step-title {
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .durchplanen-step-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-3);
            margin-bottom: var(--space-3);
        }

        .durchplanen-step-inputs label {
            font-size: 0.8rem;
            color: var(--color-text-secondary);
            display: block;
            margin-bottom: 4px;
        }

        .durchplanen-step-inputs input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 0.9rem;
        }

        .durchplanen-step-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--color-text-secondary);
            padding-top: var(--space-2);
            border-top: 1px solid var(--color-border);
        }

        .durchplanen-step-capacity {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .capacity-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 500;
        }

        .capacity-indicator.green {
            background: rgba(34, 197, 94, 0.15);
            color: #16a34a;
        }

        .capacity-indicator.yellow {
            background: rgba(234, 179, 8, 0.15);
            color: #ca8a04;
        }

        .capacity-indicator.red {
            background: rgba(239, 68, 68, 0.15);
            color: #dc2626;
        }

        .durchplanen-summary {
            padding: var(--space-4) var(--space-5);
            background: var(--color-surface-elevated);
            border-top: 1px solid var(--color-border);
        }

        .durchplanen-summary-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
        }

        .durchplanen-summary-row.total {
            font-weight: 600;
            border-top: 1px solid var(--color-border);
            padding-top: var(--space-3);
            margin-top: var(--space-2);
        }

        .durchplanen-modal .modal-actions {
            padding: var(--space-4) var(--space-5);
            border-top: 1px solid var(--color-border);
            background: var(--color-surface);
            border-radius: 0 0 var(--radius-xl) var(--radius-xl);
        }

        /* ========================================== */
        /* VERSCHIEBEN-MODAL (2025-12-11)             */
        /* ========================================== */

        .verschieben-modal {
            max-width: 500px;
            width: 95%;
            max-height: 90vh;
            padding: 0;
            display: flex;
            flex-direction: column;
        }

        .verschieben-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-4) var(--space-5);
            border-bottom: 1px solid var(--color-border);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
        }

        .verschieben-header h3 {
            margin: 0;
            font-size: 18px;
        }

        .verschieben-kennzeichen {
            padding: var(--space-3) var(--space-5);
            background: var(--color-surface-elevated);
            font-weight: 600;
            font-size: 16px;
            border-bottom: 1px solid var(--color-border);
        }

        .verschieben-service-list {
            padding: var(--space-4) var(--space-5);
            overflow-y: auto;
            max-height: 400px;
        }

        .verschieben-service {
            background: var(--color-surface);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-3);
            margin-bottom: var(--space-2);
        }

        .verschieben-service.changed {
            border-color: #f59e0b;
            background: #fffbeb;
        }

        .verschieben-service .service-header {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-bottom: var(--space-2);
            font-weight: 600;
        }

        .verschieben-service .service-datum {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            flex-wrap: wrap;
        }

        .verschieben-service .service-datum input[type="date"] {
            padding: 6px 10px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 14px;
        }

        .verschieben-service .service-datum input[type="date"]:disabled {
            background: #f3f4f6;
            color: #6b7280;
            cursor: not-allowed;
        }

        .verschieben-service .service-datum input[type="time"] {
            padding: 6px 10px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 14px;
        }

        .verschieben-service .service-zeit {
            color: var(--color-text-muted);
            font-size: 13px;
        }

        .verschieben-service .auto-shift-hint {
            margin-top: var(--space-2);
            font-size: 12px;
            color: #d97706;
            font-weight: 500;
        }

        .verschieben-arrow {
            text-align: center;
            color: var(--color-text-muted);
            font-size: 20px;
            padding: var(--space-1) 0;
        }

        .verschieben-info {
            margin: 0 var(--space-5);
            padding: var(--space-3);
            background: #e0f2fe;
            border-radius: var(--radius-md);
            font-size: 13px;
            color: #0369a1;
            line-height: 1.4;
        }

        .verschieben-modal .modal-actions {
            padding: var(--space-4) var(--space-5);
            border-top: 1px solid var(--color-border);
            background: var(--color-surface);
            border-radius: 0 0 var(--radius-xl) var(--radius-xl);
        }

        /* Verschieben Button Style */
        .verschieben-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .verschieben-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }

        /* ðŸ†• Mini-Verschieben-Button fÃ¼r Queue-Items (2025-12-11) */
        .verschieben-btn-mini {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        .verschieben-btn-mini:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }

        /* ========================================== */
        /* ERWEITERTES DETAIL-MODAL (2025-12-07)      */
        /* ========================================== */

        /* GrÃ¶ÃŸeres Modal fÃ¼r Detail-Ansicht */
        .modal.detail-modal-large {
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .detail-modal-large .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: var(--space-3);
            border-bottom: 1px solid var(--color-border);
            margin-bottom: var(--space-3);
        }

        .detail-modal-large .modal-header h3 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .detail-modal-large .modal-header-actions {
            display: flex;
            gap: var(--space-2);
        }

        .detail-modal-large .modal-header-actions button {
            padding: 6px 12px;
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .detail-modal-large .btn-print {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            color: var(--color-text-primary);
        }

        .detail-modal-large .btn-print:hover {
            background: var(--color-primary);
            color: white;
        }

        .detail-modal-large .btn-close {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            font-weight: bold;
        }

        .detail-modal-large .btn-close:hover {
            background: #dc2626;
            color: white;
        }

        /* Tab Navigation */
        .detail-tabs {
            display: flex;
            gap: 4px;
            border-bottom: 2px solid var(--color-border);
            margin-bottom: var(--space-4);
            overflow-x: auto;
        }

        .detail-tab {
            padding: 10px 16px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: var(--color-text-secondary);
            white-space: nowrap;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .detail-tab:hover {
            color: var(--color-primary);
            background: rgba(0, 122, 255, 0.05);
        }

        .detail-tab.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
            font-weight: 600;
        }

        .detail-tab .tab-badge {
            background: var(--color-primary);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        /* Tab Content */
        .detail-tab-content {
            display: none;
            flex: 1;
            overflow-y: auto;
        }

        .detail-tab-content.active {
            display: block;
        }

        /* Auftrag-Info Grid */
        .auftrag-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-4);
        }

        .info-section {
            background: rgba(0, 122, 255, 0.03);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-3);
        }

        .info-section h4 {
            font-size: 13px;
            color: var(--color-primary);
            margin-bottom: var(--space-2);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            font-size: 13px;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-row .label {
            color: var(--color-text-secondary);
        }

        .info-row .value {
            font-weight: 500;
            color: var(--color-text-primary);
        }

        .info-row .value.success {
            color: #16a34a;
        }

        .info-row .value.warning {
            color: #d97706;
        }

        /* Foto-Grid */
        .foto-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: var(--space-3);
            margin-top: var(--space-3);
        }

        .foto-thumbnail {
            aspect-ratio: 1;
            border-radius: var(--radius-lg);
            overflow: hidden;
            cursor: pointer;
            border: 2px solid var(--color-border);
            transition: all 0.2s;
            position: relative;
        }

        .foto-thumbnail:hover {
            transform: scale(1.05);
            border-color: var(--color-primary);
            box-shadow: var(--shadow-lg);
        }

        .foto-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .foto-thumbnail .foto-number {
            position: absolute;
            bottom: 4px;
            right: 4px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
        }

        .foto-empty {
            text-align: center;
            padding: var(--space-6);
            color: var(--color-text-secondary);
        }

        /* Kalkulation Tabelle */
        .kalkulation-section {
            margin-bottom: var(--space-4);
        }

        .kalkulation-section h4 {
            font-size: 14px;
            color: var(--color-text-primary);
            margin-bottom: var(--space-2);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .kalkulation-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .kalkulation-table th,
        .kalkulation-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid var(--color-border);
        }

        .kalkulation-table th {
            background: rgba(0, 122, 255, 0.05);
            font-weight: 600;
            color: var(--color-text-secondary);
            font-size: 12px;
            text-transform: uppercase;
        }

        .kalkulation-table td.number {
            text-align: right;
            font-family: monospace;
        }

        .kalkulation-table tr.summe {
            background: rgba(0, 122, 255, 0.1);
            font-weight: 600;
        }

        .kalkulation-table tr.gesamt {
            background: var(--color-primary);
            color: white;
            font-weight: 700;
            font-size: 15px;
        }

        /* Bestellstatus Badges */
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
        }
        .badge-gray {
            background: #e5e7eb;
            color: #6b7280;
        }
        .badge-yellow {
            background: #fef3c7;
            color: #92400e;
        }
        .badge-blue {
            background: #dbeafe;
            color: #1e40af;
        }
        .badge-green {
            background: #d1fae5;
            color: #065f46;
        }

        /* PDF-Liste */
        .pdfs-section h4 {
            margin-bottom: 12px;
            color: var(--color-text);
        }
        .pdf-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .pdf-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--color-bg);
            border-radius: 8px;
            border: 1px solid var(--color-border);
        }
        .pdf-icon {
            font-size: 24px;
        }
        .pdf-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .pdf-name {
            font-weight: 600;
            color: var(--color-text);
        }
        .pdf-date {
            font-size: 12px;
            color: var(--color-text-secondary);
        }
        .btn-download {
            padding: 6px 12px;
            background: var(--color-primary);
            color: white;
            border-radius: 6px;
            text-decoration: none;
            font-size: 12px;
            font-weight: 600;
            transition: background 0.2s;
        }
        .btn-download:hover {
            background: #005ec5;
        }

        /* Audit-Trail */
        .audit-trail {
            display: flex;
            flex-direction: column;
            gap: 0;
            padding-left: 8px;
        }
        .audit-event {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 8px 0;
            position: relative;
        }
        .audit-event::before {
            content: '';
            position: absolute;
            left: 12px;
            top: 32px;
            bottom: -8px;
            width: 2px;
            background: var(--color-border);
        }
        .audit-event.last::before {
            display: none;
        }
        .audit-icon {
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            background: var(--color-bg);
            border: 2px solid var(--color-border);
            border-radius: 50%;
            flex-shrink: 0;
            z-index: 1;
        }
        .audit-content {
            display: flex;
            flex-direction: column;
            gap: 2px;
            padding-top: 2px;
        }
        .audit-text {
            font-weight: 600;
            color: var(--color-text);
            font-size: 13px;
        }
        .audit-date {
            font-size: 11px;
            color: var(--color-text-secondary);
        }
        .no-events {
            color: var(--color-text-secondary);
            font-style: italic;
        }

        /* Ersatzteile-Liste */
        .ersatzteile-list {
            font-size: 13px;
        }

        .ersatzteil-item {
            display: grid;
            grid-template-columns: 100px 1fr 60px 80px;
            gap: var(--space-2);
            padding: 8px 0;
            border-bottom: 1px solid var(--color-border);
            align-items: center;
        }

        .ersatzteil-item:last-child {
            border-bottom: none;
        }

        .ersatzteil-item .etn {
            font-family: monospace;
            font-size: 11px;
            color: var(--color-text-secondary);
        }

        /* Lightbox */
        .lightbox-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 20000;
        }

        .lightbox-overlay.active {
            display: flex;
        }

        .lightbox-content {
            position: relative;
            max-width: 90vw;
            max-height: 90vh;
        }

        .lightbox-content img {
            max-width: 100%;
            max-height: 85vh;
            object-fit: contain;
            border-radius: var(--radius-lg);
        }

        .lightbox-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            transition: all 0.2s;
        }

        .lightbox-close:hover {
            background: rgba(255,255,255,0.4);
        }

        .lightbox-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            transition: all 0.2s;
        }

        .lightbox-nav:hover {
            background: rgba(255,255,255,0.4);
        }

        .lightbox-nav.prev { left: -70px; }
        .lightbox-nav.next { right: -70px; }

        .lightbox-counter {
            position: absolute;
            bottom: -35px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 14px;
        }

        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            .modal-overlay.active,
            .modal-overlay.active * {
                visibility: visible;
            }
            .modal-overlay.active {
                position: absolute;
                background: white;
            }
            .modal.detail-modal-large {
                max-width: 100%;
                max-height: none;
                box-shadow: none;
            }
            .detail-tabs, .modal-header-actions, .modal-actions {
                display: none !important;
            }
            .detail-tab-content {
                display: block !important;
                page-break-inside: avoid;
                margin-bottom: 20px;
            }
            .foto-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            .foto-thumbnail {
                break-inside: avoid;
            }
        }

        /* Service Color Classes for all 12 types */
        .service-versicherung { background: rgba(139, 92, 246, 0.15); color: #7c3aed; }
        .service-glas { background: rgba(6, 182, 212, 0.15); color: #0891b2; }
        .service-klima { background: rgba(59, 130, 246, 0.15); color: #2563eb; }
        .service-dellen { background: rgba(245, 158, 11, 0.15); color: #d97706; }
        .service-folierung { background: rgba(236, 72, 153, 0.15); color: #db2777; }
        .service-steinschutz { background: rgba(20, 184, 166, 0.15); color: #0d9488; }
        .service-werbebeklebung { background: rgba(249, 115, 22, 0.15); color: #ea580c; }

        /* Logistik Queue Colors */
        .queue-column.logistik {
            border-color: rgba(59, 130, 246, 0.3);
            background: rgba(59, 130, 246, 0.05);
        }

        /* Info Button on Cards */
        .info-btn {
            position: absolute;
            top: 6px;
            right: 24px;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fahrzeug-card:hover .info-btn,
        .queue-item:hover .info-btn {
            opacity: 1;
        }

        /* KapazitÃ¤ts-Anzeige (Phase 2) */
        .queue-capacity {
            font-size: 11px;
            color: var(--color-text-secondary);
            font-weight: 500;
            margin-top: 2px;
        }

        .queue-capacity.warning {
            color: #f59e0b;
            font-weight: 600;
        }

        .queue-capacity.danger {
            color: #ef4444;
            font-weight: 700;
        }

        .capacity-bar {
            height: 4px;
            background: var(--color-border);
            border-radius: 2px;
            margin-top: 6px;
            overflow: hidden;
        }

        .capacity-fill {
            height: 100%;
            background: #22c55e;
            transition: width 0.3s ease, background 0.3s ease;
            border-radius: 2px;
        }

        .capacity-fill.warning {
            background: #f59e0b;
        }

        .capacity-fill.danger {
            background: #ef4444;
        }

        /* Stunden-Badge auf Queue-Items */
        .hours-badge {
            font-size: 10px;
            padding: 2px 5px;
            border-radius: var(--radius-sm);
            font-weight: 600;
            white-space: nowrap;
            cursor: help;
        }

        /* KVA-basierte Stunden = GrÃ¼n (genau!) */
        .hours-badge.kva {
            background: rgba(34, 197, 94, 0.15);
            color: #16a34a;
        }

        /* Default-SchÃ¤tzung = Grau (unsicher) */
        .hours-badge.default {
            background: rgba(107, 114, 128, 0.15);
            color: #6b7280;
        }

        /* Klickbarer Badge */
        .hours-badge:hover {
            opacity: 0.8;
            transform: scale(1.05);
            cursor: pointer;
        }

        /* Stunden-Details Popup */
        .hours-breakdown {
            background: var(--color-surface-alt, #f8f9fa);
            border-radius: var(--radius-md, 8px);
            padding: var(--space-3, 12px);
            margin-bottom: var(--space-4, 16px);
        }

        .hours-breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid var(--color-border, #e5e7eb);
            font-size: 14px;
        }

        .hours-breakdown-item:last-child {
            border-bottom: none;
        }

        .hours-breakdown-total {
            font-weight: bold;
            margin-top: var(--space-2, 8px);
            padding-top: var(--space-2, 8px);
            border-top: 2px solid var(--color-border, #e5e7eb);
        }

        .hours-edit-section {
            display: flex;
            align-items: center;
            gap: var(--space-2, 8px);
            margin-top: var(--space-4, 16px);
            padding: var(--space-3, 12px);
            background: rgba(59, 130, 246, 0.1);
            border-radius: var(--radius-md, 8px);
        }

        .hours-edit-section label {
            font-weight: 500;
            white-space: nowrap;
        }

        .hours-edit-section input {
            width: 80px;
            padding: 8px;
            border: 1px solid var(--color-border, #d1d5db);
            border-radius: var(--radius-sm, 4px);
            font-size: 16px;
            text-align: center;
        }

        .hours-edit-section input:focus {
            outline: none;
            border-color: var(--color-primary, #3b82f6);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        /* Mobile */
        @media (max-width: 1400px) {
            .queue-section.werkstatt {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 1200px) {
            .queue-section {
                grid-template-columns: repeat(2, 1fr);
            }
            .queue-section.werkstatt {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 900px) {
            .main-container {
                grid-template-columns: 1fr;
            }
            .queue-section,
            .queue-section.werkstatt {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .queue-section,
            .queue-section.werkstatt {
                grid-template-columns: 1fr;
            }
        }

        /* ðŸ†• Anlieferungsart-Badges (2025-12-07) */
        .anlieferung-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 6px;
        }

        .anlieferung-badge.abholung {
            background: rgba(59, 130, 246, 0.15);
            color: #3B82F6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .anlieferung-badge.selbst {
            background: rgba(34, 197, 94, 0.15);
            color: #22C55E;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .abhol-info {
            display: block;
            font-size: 10px;
            color: var(--color-text-muted, #6b7280);
            margin-top: 4px;
        }

        /* Dark Mode */
        [data-theme="dark"] .anlieferung-badge.abholung {
            background: rgba(59, 130, 246, 0.25);
        }

        [data-theme="dark"] .anlieferung-badge.selbst {
            background: rgba(34, 197, 94, 0.25);
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <span class="logo">ðŸ“…</span>
            <div class="title">
                <h1>Tagesplanung</h1>
                <span class="subtitle">Priorisierung & Abteilungs-Queues</span>
            </div>
        </div>
        <div class="header-right">
            <input type="date" class="date-picker" id="datePicker">
            <button class="nav-btn success" onclick="saveTagesplan()">
                <span>ðŸ’¾</span> Speichern
            </button>
            <a href="kanban.html" class="nav-btn">
                <span>ðŸ“Š</span> Kanban
            </a>
            <a href="liste.html" class="nav-btn">
                <span>ðŸ“‹</span> Liste
            </a>
        </div>
    </header>

    <!-- Stats Bar -->
    <div class="stats-bar">
        <div class="stat-item">
            <span class="label">Ungeplant:</span>
            <span class="value" id="statUngeplant">0</span>
        </div>
        <div class="stat-item">
            <span class="label">Geplant:</span>
            <span class="value" id="statGeplant">0</span>
        </div>
        <div class="stat-item">
            <span class="label">Heute fÃ¤llig:</span>
            <span class="value" id="statHeuteFaellig">0</span>
        </div>
        <div class="stat-item">
            <span class="label">ÃœberfÃ¤llig:</span>
            <span class="value" id="statUeberfaellig" style="color: #ef4444;">0</span>
        </div>
    </div>

    <!-- ðŸ”§ 2025-12-07: KapazitÃ¤ts-Bar -->
    <div class="capacity-bar" id="capacityBar">
        <div class="capacity-bar-title">
            <span>ðŸ“Š</span>
            <span>KapazitÃ¤tsauslastung fÃ¼r <strong id="capacityDate">heute</strong>:</span>
        </div>
        <div class="capacity-items" id="capacityItems">
            <!-- Wird dynamisch befÃ¼llt -->
            <div class="capacity-item status-green">
                <span class="service-icon">ðŸŽ¨</span>
                <span>Lackierung:</span>
                <span class="usage">-/-</span>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Ungeplant Section -->
        <div class="ungeplant-section">
            <div class="section-header">
                <span class="section-title">
                    Ungeplant
                    <span class="count-badge" id="ungeplantCount">0</span>
                </span>
                <select class="sort-select" id="sortSelect" onchange="sortUngeplant()">
                    <option value="dringlichkeit">Nach Dringlichkeit</option>
                    <option value="datum">Nach Eingangsdatum</option>
                    <option value="termin">Nach Termin</option>
                </select>
            </div>

            <!-- 3 Tabs: Bereit / Logistik / Zukuenftig -->
            <div class="ungeplant-tabs">
                <button class="tab bereit active" data-filter="bereit" onclick="switchUngeplantTab('bereit')">
                    Bereit <span class="tab-count" id="countBereit">0</span>
                </button>
                <button class="tab logistik" data-filter="logistik" onclick="switchUngeplantTab('logistik')">
                    Logistik <span class="tab-count" id="countLogistik">0</span>
                </button>
                <button class="tab zukunft" data-filter="zukunft" onclick="switchUngeplantTab('zukunft')">
                    Zukuenftig <span class="tab-count" id="countZukunft">0</span>
                </button>
            </div>

            <div id="ungeplantList">
                <!-- Fahrzeuge werden hier eingefuegt -->
            </div>
        </div>

        <!-- Queue Container -->
        <div class="queues-container">
            <!-- LOGISTIK QUEUES -->
            <div class="queue-group">
                <div class="queue-group-title">ðŸšš Logistik</div>
                <div class="queue-section">
                    <!-- Abhol-Fahrt: Fzg. abholen + Leih bringen (kombiniert) -->
                    <div class="queue-column logistik" data-queue="abhol_fahrt">
                        <div class="queue-header">
                            <div class="icon">ðŸšš</div>
                            <div class="name">Abhol-Fahrt</div>
                            <div class="sub-info" style="font-size:10px;color:#6b7280;">Fzg. abholen + Leih bringen</div>
                            <div class="queue-count"><span id="queueCountAbhol_fahrt">0</span></div>
                            <div class="queue-capacity" id="capacityAbhol_fahrt">0/8h</div>
                            <div class="capacity-bar"><div class="capacity-fill" id="capacityFillAbhol_fahrt"></div></div>
                        </div>
                        <div class="queue-items" id="queueAbhol_fahrt" data-queue="abhol_fahrt">
                            <div class="empty-state">Hierher ziehen</div>
                        </div>
                    </div>
                    <!-- Liefer-Fahrt: Fzg. liefern + Leih abholen (kombiniert) -->
                    <div class="queue-column logistik" data-queue="liefer_fahrt">
                        <div class="queue-header">
                            <div class="icon">ðŸ </div>
                            <div class="name">Liefer-Fahrt</div>
                            <div class="sub-info" style="font-size:10px;color:#6b7280;">Fzg. liefern + Leih abholen</div>
                            <div class="queue-count"><span id="queueCountLiefer_fahrt">0</span></div>
                            <div class="queue-capacity" id="capacityLiefer_fahrt">0/8h</div>
                            <div class="capacity-bar"><div class="capacity-fill" id="capacityFillLiefer_fahrt"></div></div>
                        </div>
                        <div class="queue-items" id="queueLiefer_fahrt" data-queue="liefer_fahrt">
                            <div class="empty-state">Hierher ziehen</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- WERKSTATT QUEUES -->
            <div class="queue-group">
                <div class="queue-group-title">ðŸ”§ Werkstatt (12 Abteilungen)</div>
                <div class="queue-section werkstatt">
                    <!-- Zeile 1 -->
                    <div class="queue-column" data-queue="lackier">
                        <div class="queue-header">
                            <div class="icon">ðŸŽ¨</div>
                            <div class="name">Lackierung</div>
                            <div class="queue-count"><span id="queueCountLackier">0</span></div>
                            <div class="queue-capacity" id="capacityLackier">0/8h</div>
                            <div class="capacity-bar"><div class="capacity-fill" id="capacityFillLackier"></div></div>
                        </div>
                        <div class="queue-items" id="queueLackier" data-queue="lackier">
                            <div class="empty-state">Hierher ziehen</div>
                        </div>
                    </div>
                    <div class="queue-column" data-queue="mechanik">
                        <div class="queue-header">
                            <div class="icon">ðŸ”§</div>
                            <div class="name">Mechanik</div>
                            <div class="queue-count"><span id="queueCountMechanik">0</span></div>
                            <div class="queue-capacity" id="capacityMechanik">0/8h</div>
                            <div class="capacity-bar"><div class="capacity-fill" id="capacityFillMechanik"></div></div>
                        </div>
                        <div class="queue-items" id="queueMechanik" data-queue="mechanik">
                            <div class="empty-state">Hierher ziehen</div>
                        </div>
                    </div>
                    <div class="queue-column" data-queue="reifen">
                        <div class="queue-header">
                            <div class="icon">ðŸ›ž</div>
                            <div class="name">Reifen</div>
                            <div class="queue-count"><span id="queueCountReifen">0</span></div>
                            <div class="queue-capacity" id="capacityReifen">0/8h</div>
                            <div class="capacity-bar"><div class="capacity-fill" id="capacityFillReifen"></div></div>
                        </div>
                        <div class="queue-items" id="queueReifen" data-queue="reifen">
                            <div class="empty-state">Hierher ziehen</div>
                        </div>
                    </div>
                    <div class="queue-column" data-queue="pflege">
                        <div class="queue-header">
                            <div class="icon">âœ¨</div>
                            <div class="name">Pflege</div>
                            <div class="queue-count"><span id="queueCountPflege">0</span></div>
                            <div class="queue-capacity" id="capacityPflege">0/8h</div>
                            <div class="capacity-bar"><div class="capacity-fill" id="capacityFillPflege"></div></div>
                        </div>
                        <div class="queue-items" id="queuePflege" data-queue="pflege">
                            <div class="empty-state">Hierher ziehen</div>
                        </div>
                    </div>
                    <div class="queue-column" data-queue="tuev">
                        <div class="queue-header">
                            <div class="icon">ðŸ“‹</div>
                            <div class="name">TÃœV/AU</div>
                            <div class="queue-count"><span id="queueCountTuev">0</span></div>
                            <div class="queue-capacity" id="capacityTuev">0/8h</div>
                            <div class="capacity-bar"><div class="capacity-fill" id="capacityFillTuev"></div></div>
                        </div>
                        <div class="queue-items" id="queueTuev" data-queue="tuev">
                            <div class="empty-state">Hierher ziehen</div>
                        </div>
                    </div>
                    <div class="queue-column" data-queue="versicherung">
                        <div class="queue-header">
                            <div class="icon">ðŸ›¡ï¸</div>
                            <div class="name">Versicherung</div>
                            <div class="queue-count"><span id="queueCountVersicherung">0</span></div>
                            <div class="queue-capacity" id="capacityVersicherung">0/8h</div>
                            <div class="capacity-bar"><div class="capacity-fill" id="capacityFillVersicherung"></div></div>
                        </div>
                        <div class="queue-items" id="queueVersicherung" data-queue="versicherung">
                            <div class="empty-state">Hierher ziehen</div>
                        </div>
                    </div>
                    <!-- Zeile 2 -->
                    <div class="queue-column" data-queue="glas">
                        <div class="queue-header">
                            <div class="icon">ðŸªŸ</div>
                            <div class="name">Glas</div>
                            <div class="queue-count"><span id="queueCountGlas">0</span></div>
                            <div class="queue-capacity" id="capacityGlas">0/8h</div>
                            <div class="capacity-bar"><div class="capacity-fill" id="capacityFillGlas"></div></div>
                        </div>
                        <div class="queue-items" id="queueGlas" data-queue="glas">
                            <div class="empty-state">Hierher ziehen</div>
                        </div>
                    </div>
                    <div class="queue-column" data-queue="klima">
                        <div class="queue-header">
                            <div class="icon">â„ï¸</div>
                            <div class="name">Klima</div>
                            <div class="queue-count"><span id="queueCountKlima">0</span></div>
                            <div class="queue-capacity" id="capacityKlima">0/8h</div>
                            <div class="capacity-bar"><div class="capacity-fill" id="capacityFillKlima"></div></div>
                        </div>
                        <div class="queue-items" id="queueKlima" data-queue="klima">
                            <div class="empty-state">Hierher ziehen</div>
                        </div>
                    </div>
                    <div class="queue-column" data-queue="dellen">
                        <div class="queue-header">
                            <div class="icon">ðŸ”¨</div>
                            <div class="name">Dellen</div>
                            <div class="queue-count"><span id="queueCountDellen">0</span></div>
                            <div class="queue-capacity" id="capacityDellen">0/8h</div>
                            <div class="capacity-bar"><div class="capacity-fill" id="capacityFillDellen"></div></div>
                        </div>
                        <div class="queue-items" id="queueDellen" data-queue="dellen">
                            <div class="empty-state">Hierher ziehen</div>
                        </div>
                    </div>
                    <div class="queue-column" data-queue="folierung">
                        <div class="queue-header">
                            <div class="icon">ðŸŒˆ</div>
                            <div class="name">Folierung</div>
                            <div class="queue-count"><span id="queueCountFolierung">0</span></div>
                            <div class="queue-capacity" id="capacityFolierung">0/8h</div>
                            <div class="capacity-bar"><div class="capacity-fill" id="capacityFillFolierung"></div></div>
                        </div>
                        <div class="queue-items" id="queueFolierung" data-queue="folierung">
                            <div class="empty-state">Hierher ziehen</div>
                        </div>
                    </div>
                    <div class="queue-column" data-queue="steinschutz">
                        <div class="queue-header">
                            <div class="icon">ðŸ›¡ï¸</div>
                            <div class="name">Steinschutz</div>
                            <div class="queue-count"><span id="queueCountSteinschutz">0</span></div>
                            <div class="queue-capacity" id="capacitySteinschutz">0/8h</div>
                            <div class="capacity-bar"><div class="capacity-fill" id="capacityFillSteinschutz"></div></div>
                        </div>
                        <div class="queue-items" id="queueSteinschutz" data-queue="steinschutz">
                            <div class="empty-state">Hierher ziehen</div>
                        </div>
                    </div>
                    <div class="queue-column" data-queue="werbebeklebung">
                        <div class="queue-header">
                            <div class="icon">ðŸ“¢</div>
                            <div class="name">Werbung</div>
                            <div class="queue-count"><span id="queueCountWerbebeklebung">0</span></div>
                            <div class="queue-capacity" id="capacityWerbebeklebung">0/8h</div>
                            <div class="capacity-bar"><div class="capacity-fill" id="capacityFillWerbebeklebung"></div></div>
                        </div>
                        <div class="queue-items" id="queueWerbebeklebung" data-queue="werbebeklebung">
                            <div class="empty-state">Hierher ziehen</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detail Modal (Erweitert 2025-12-07) -->
    <div class="modal-overlay" id="detailModal">
        <div class="modal detail-modal-large">
            <!-- Header mit Titel + Aktionen -->
            <div class="modal-header">
                <h3 id="modalTitle">Fahrzeug Details</h3>
                <div class="modal-header-actions">
                    <button class="btn-print" onclick="printDetailModal()">ðŸ–¨ï¸ Drucken</button>
                    <button class="btn-close" onclick="closeModal()">âœ•</button>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="detail-tabs">
                <button class="detail-tab active" data-tab="auftrag" onclick="switchDetailTab('auftrag')">
                    ðŸ“‹ Auftrag
                </button>
                <button class="detail-tab" data-tab="fotos" onclick="switchDetailTab('fotos')">
                    ðŸ“¸ Fotos <span class="tab-badge" id="fotoCount">0</span>
                </button>
                <button class="detail-tab" data-tab="kalkulation" onclick="switchDetailTab('kalkulation')">
                    ðŸ’° Kalkulation
                </button>
                <button class="detail-tab" data-tab="teile" onclick="switchDetailTab('teile')">
                    ðŸ“¦ Teile <span class="tab-badge" id="teileCount">0</span>
                </button>
                <button class="detail-tab" data-tab="pdfs" onclick="switchDetailTab('pdfs')">
                    ðŸ“„ PDFs <span class="tab-badge" id="pdfCount">0</span>
                </button>
            </div>

            <!-- Tab Contents -->
            <div id="modalContent">
                <!-- Tab: Auftrag -->
                <div class="detail-tab-content active" id="tab-auftrag"></div>

                <!-- Tab: Fotos -->
                <div class="detail-tab-content" id="tab-fotos"></div>

                <!-- Tab: Kalkulation -->
                <div class="detail-tab-content" id="tab-kalkulation"></div>

                <!-- Tab: Teile -->
                <div class="detail-tab-content" id="tab-teile"></div>

                <!-- Tab: PDFs -->
                <div class="detail-tab-content" id="tab-pdfs"></div>
            </div>
        </div>
    </div>

    <!-- Lightbox fÃ¼r Foto-Vollansicht -->
    <div class="lightbox-overlay" id="lightboxOverlay" onclick="closeLightbox(event)">
        <div class="lightbox-content" onclick="event.stopPropagation()">
            <button class="lightbox-close" onclick="closeLightbox()">&times;</button>
            <button class="lightbox-nav prev" onclick="lightboxNavigate(-1)">â®</button>
            <img id="lightboxImage" src="" alt="Foto">
            <button class="lightbox-nav next" onclick="lightboxNavigate(1)">â¯</button>
            <div class="lightbox-counter" id="lightboxCounter">1 / 5</div>
        </div>
    </div>

    <!-- Stunden-Details Modal -->
    <div class="modal-overlay" id="hoursModal">
        <div class="modal">
            <h3 id="hoursModalTitle">Arbeitszeit-Details</h3>
            <div id="hoursBreakdown">
                <!-- AufschlÃ¼sselung wird dynamisch eingefÃ¼gt -->
            </div>
            <div class="hours-edit-section">
                <label>Manuelle Anpassung:</label>
                <input type="number" id="manualHoursInput" step="0.5" min="0.5" max="100" placeholder="0.0">
                <span>Stunden</span>
            </div>
            <div class="modal-actions">
                <button class="nav-btn" onclick="closeHoursModal()">Abbrechen</button>
                <button class="nav-btn primary" onclick="saveManualHours()">Speichern</button>
            </div>
        </div>
    </div>

    <!-- ðŸ†• Durchplanen-Modal (Multi-Service-Planung) -->
    <div class="modal-overlay" id="durchplanenModal">
        <div class="modal durchplanen-modal">
            <div class="durchplanen-header">
                <h3>ðŸ“… Service-Durchplanung</h3>
                <button class="modal-close" onclick="closeDurchplanenModal()">&times;</button>
            </div>
            <div class="durchplanen-fahrzeug-info" id="durchplanenFahrzeugInfo">
                <!-- Fahrzeug-Info wird dynamisch eingefÃ¼gt -->
            </div>
            <div class="durchplanen-steps" id="durchplanenSteps">
                <!-- Service-Schritte werden dynamisch eingefÃ¼gt -->
            </div>
            <div class="durchplanen-summary" id="durchplanenSummary">
                <!-- Zusammenfassung wird dynamisch eingefÃ¼gt -->
            </div>
            <div class="modal-actions">
                <button class="nav-btn" onclick="closeDurchplanenModal()">Abbrechen</button>
                <button class="nav-btn primary" onclick="saveDurchplanung()">
                    <span>âœ…</span> Plan speichern
                </button>
            </div>
        </div>
    </div>

    <!-- Termin verschieben Modal -->
    <div class="modal-overlay" id="verschiebenModal">
        <div class="modal verschieben-modal">
            <div class="verschieben-header">
                <h3>ðŸ“… Termine verschieben</h3>
                <button class="modal-close" onclick="closeVerschiebenModal()">&times;</button>
            </div>
            <div class="verschieben-kennzeichen" id="verschiebenKennzeichen">
                <!-- Kennzeichen wird dynamisch eingefÃ¼gt -->
            </div>
            <div class="verschieben-service-list" id="verschiebenServiceList">
                <!-- Service-Liste wird dynamisch eingefÃ¼gt -->
            </div>
            <div class="verschieben-info">
                Ã„nderung bei einem Service verschiebt alle nachfolgenden Services automatisch um die gleiche Anzahl Tage.
            </div>
            <div class="modal-actions">
                <button class="nav-btn" onclick="closeVerschiebenModal()">Abbrechen</button>
                <button class="nav-btn primary" onclick="saveVerschiebung()">
                    <span>ðŸ’¾</span> Speichern
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

    <!-- App Scripts -->
    <script src="firebase-config.js"></script>
    <script src="listener-registry.js"></script>
    <script src="js/auth-manager.js"></script>
    <script src="js/service-types.js"></script>
    <script src="js/permissions-helper.js"></script>
    <script src="js/toast.js"></script>
    <script src="js/firebase-sync.js"></script>

    <script>
        // ============================================
        // TAGESPLANUNG - JavaScript
        // ============================================

        // Global State
        let allFahrzeuge = [];
        let ungeplanteFahrzeuge = [];
        let currentUngeplantTab = 'bereit';  // bereit | logistik | zukunft
        let categorizedUngeplant = { bereit: [], logistik: [], zukunft: [] };

        // ALL 14 QUEUES: 2 Logistik-Fahrten + 12 Service
        const ALL_QUEUES = [
            // Logistik (2 kombinierte Fahrten)
            'abhol_fahrt', 'liefer_fahrt',
            // Service (12)
            'lackier', 'mechanik', 'reifen', 'pflege', 'tuev', 'versicherung',
            'glas', 'klima', 'dellen', 'folierung', 'steinschutz', 'werbebeklebung'
        ];

        let queuedFahrzeuge = {};
        ALL_QUEUES.forEach(q => queuedFahrzeuge[q] = []);

        let selectedDate = new Date();
        let hasUnsavedChanges = false;

        // ðŸ”§ 2025-12-07: KapazitÃ¤ts-Settings
        let kapazitaetSettings = {
            lackierung: 15, karosserie: 12, mechanik: 10, glas: 5,
            reifen: 8, smartRepair: 6, inspektion: 8, aufbereitung: 4,
            klima: 6, tuning: 3, leihwagen: 10, logistik: 5
        };

        // Service-Icons und Labels fÃ¼r KapazitÃ¤ts-Anzeige
        const SERVICE_KAPAZITAET_CONFIG = {
            lackierung:   { icon: 'ðŸŽ¨', label: 'Lackierung', queues: ['lackier'] },
            karosserie:   { icon: 'ðŸ”§', label: 'Karosserie', queues: ['dellen'] },
            mechanik:     { icon: 'âš™ï¸', label: 'Mechanik', queues: ['mechanik', 'tuev'] },
            glas:         { icon: 'ðŸªŸ', label: 'Glas', queues: ['glas'] },
            reifen:       { icon: 'ðŸ›ž', label: 'Reifen', queues: ['reifen'] },
            smartRepair:  { icon: 'âœ¨', label: 'Smart Repair', queues: ['pflege'] },
            inspektion:   { icon: 'ðŸ”', label: 'Inspektion', queues: ['versicherung'] },
            aufbereitung: { icon: 'ðŸ§¹', label: 'Aufbereitung', queues: ['folierung', 'steinschutz', 'werbebeklebung'] },
            klima:        { icon: 'â„ï¸', label: 'Klima', queues: ['klima'] },
            logistik:     { icon: 'ðŸšš', label: 'Logistik', queues: ['abhol_fahrt', 'liefer_fahrt'] }
        };

        // ============================================
        // ðŸ†• MULTI-SERVICE-DURCHPLANUNG (2025-12-09)
        // ============================================

        // Standard-Service-Dauern in Minuten (Fallback wenn keine KVA-Daten)
        const SERVICE_DEFAULT_DURATION = {
            abhol_fahrt: 45,        // Abholung (wird durch Google Maps Ã¼berschrieben)
            liefer_fahrt: 45,       // Lieferung (wird durch Google Maps Ã¼berschrieben)
            lackier: 300,           // 5h Lackierung
            mechanik: 180,          // 3h Mechanik
            reifen: 60,             // 1h Reifenwechsel
            glas: 120,              // 2h Glasarbeiten
            dellen: 240,            // 4h Dellenentfernung
            pflege: 90,             // 1.5h Pflege/Smart Repair
            tuev: 60,               // 1h TÃœV
            versicherung: 60,       // 1h Versicherung/Inspektion
            klima: 90,              // 1.5h Klimaservice
            folierung: 180,         // 3h Folierung
            steinschutz: 120,       // 2h Steinschutz
            werbebeklebung: 240     // 4h Werbebeklebung
        };

        // Queue-Labels fÃ¼r UI
        const QUEUE_LABELS = {
            abhol_fahrt: { icon: 'ðŸš—', label: 'Fahrzeug abholen' },
            liefer_fahrt: { icon: 'ðŸšš', label: 'Fahrzeug ausliefern' },
            lackier: { icon: 'ðŸŽ¨', label: 'Lackierung' },
            mechanik: { icon: 'âš™ï¸', label: 'Mechanik' },
            reifen: { icon: 'ðŸ›ž', label: 'Reifenwechsel' },
            glas: { icon: 'ðŸªŸ', label: 'Glasarbeiten' },
            dellen: { icon: 'ðŸ”§', label: 'Dellenentfernung' },
            pflege: { icon: 'âœ¨', label: 'Pflege/Smart Repair' },
            tuev: { icon: 'ðŸ“‹', label: 'TÃœV' },
            versicherung: { icon: 'ðŸ”', label: 'Inspektion' },
            klima: { icon: 'â„ï¸', label: 'Klimaservice' },
            folierung: { icon: 'ðŸŽžï¸', label: 'Folierung' },
            steinschutz: { icon: 'ðŸ›¡ï¸', label: 'Steinschutz' },
            werbebeklebung: { icon: 'ðŸ“¢', label: 'Werbebeklebung' }
        };

        // Logistik-Queue IDs (verwendet fÃ¼r Durchplanung und Queue-Management)
        const LOGISTIK_QUEUES = ['abhol_fahrt', 'liefer_fahrt'];

        /**
         * Berechnet die Service-Dauer fÃ¼r einen bestimmten Service-Typ
         * Priorisiert KVA-Daten, nutzt Standard als Fallback
         */
        function getServiceDuration(fahrzeug, serviceTyp) {
            // 1. Versuche aus KVA-Daten zu berechnen (AW * 5 Minuten)
            const kalkulation = fahrzeug.kalkulationData || fahrzeug.kalkulation || {};

            if (kalkulation.positionen) {
                // Filtere Positionen fÃ¼r diesen Service-Typ (wenn kategorisiert)
                const servicePositionen = kalkulation.positionen.filter(p =>
                    p.kategorie === serviceTyp || p.service === serviceTyp
                );

                if (servicePositionen.length > 0) {
                    const totalAW = servicePositionen.reduce((sum, p) => sum + (p.arbeitswerte || 0), 0);
                    if (totalAW > 0) {
                        return Math.max(30, Math.round(totalAW * 5)); // Min 30 Min
                    }
                }
            }

            // 2. FÃ¼r Logistik: Google Maps Fahrzeit nutzen
            if (LOGISTIK_QUEUES.includes(serviceTyp) && fahrzeug.logistikDetails?.travelTimeOneWay) {
                return Math.round(fahrzeug.logistikDetails.travelTimeOneWay);
            }

            // 3. Standard-Wert als Fallback
            return SERVICE_DEFAULT_DURATION[serviceTyp] || 120; // Default 2h
        }

        /**
         * Addiert Minuten zu einer Zeit-String (HH:MM)
         */
        function addMinutesToTime(timeStr, minutes) {
            const [hours, mins] = timeStr.split(':').map(Number);
            const totalMinutes = hours * 60 + mins + minutes;
            const newHours = Math.floor(totalMinutes / 60) % 24;
            const newMins = totalMinutes % 60;
            return `${String(newHours).padStart(2, '0')}:${String(newMins).padStart(2, '0')}`;
        }

        /**
         * Generiert automatisch einen Service-Plan basierend auf Fahrzeug-Daten
         */
        function generateServicePlan(fahrzeug, startDate = null, startTime = '08:00') {
            const plan = [];
            let currentTime = startTime;
            let currentDate = startDate || document.getElementById('datePicker')?.value || new Date().toISOString().split('T')[0];
            let reihenfolge = 1;

            // 1. Abholung hinzufÃ¼gen (wenn Abholservice gewÃ¼nscht)
            if (fahrzeug.abholserviceGewuenscht || fahrzeug.fahrzeugAbholung === 'ja') {
                const fahrzeit = fahrzeug.logistikDetails?.travelTimeOneWay || SERVICE_DEFAULT_DURATION.abhol_fahrt;
                plan.push({
                    id: `sp_${Date.now()}_${reihenfolge}`,
                    queue: 'abhol_fahrt',
                    datum: currentDate,
                    startzeit: currentTime,
                    endzeit: addMinutesToTime(currentTime, fahrzeit),
                    geschaetzteDauer: fahrzeit,
                    status: 'geplant',
                    reihenfolge: reihenfolge++
                });
                currentTime = addMinutesToTime(currentTime, fahrzeit + 15); // +15 Min Puffer fÃ¼r Ankunft
            }

            // 2. Services aus requiredServices, serviceTyp UND additionalServices
            // ðŸ”§ FIX: Sammle ALLE Services fÃ¼r Multiservice-Fahrzeuge
            let services = [];

            // 2a. Haupt-Service aus requiredServices oder serviceTyp
            if (fahrzeug.requiredServices && fahrzeug.requiredServices.length > 0) {
                services = [...fahrzeug.requiredServices];
            } else if (Array.isArray(fahrzeug.serviceTyp)) {
                services = [...fahrzeug.serviceTyp];
            } else if (fahrzeug.serviceTyp) {
                services = [fahrzeug.serviceTyp];
            } else {
                services = ['lackier'];
            }

            // 2b. ZusÃ¤tzliche Services aus additionalServices hinzufÃ¼gen
            if (fahrzeug.additionalServices && Array.isArray(fahrzeug.additionalServices)) {
                for (const addService of fahrzeug.additionalServices) {
                    const typ = addService.serviceTyp || addService;
                    if (typ && !services.includes(typ)) {
                        services.push(typ);
                    }
                }
            }
            console.log('ðŸ“‹ Alle Services fÃ¼r Plan:', services);

            for (const service of services) {
                // Skip wenn es Logistik ist (wird separat behandelt)
                if (LOGISTIK_QUEUES.includes(service)) continue;

                const dauer = getServiceDuration(fahrzeug, service);

                // PrÃ¼fe ob Arbeitstag voll wÃ¤re (nach 18:00)
                const endzeit = addMinutesToTime(currentTime, dauer);
                const [endH] = endzeit.split(':').map(Number);
                if (endH >= 18) {
                    // NÃ¤chster Arbeitstag
                    const nextDay = new Date(currentDate);
                    nextDay.setDate(nextDay.getDate() + 1);
                    // Wochenende Ã¼berspringen
                    while (nextDay.getDay() === 0 || nextDay.getDay() === 6) {
                        nextDay.setDate(nextDay.getDate() + 1);
                    }
                    currentDate = nextDay.toISOString().split('T')[0];
                    currentTime = '08:00';
                }

                plan.push({
                    id: `sp_${Date.now()}_${reihenfolge}`,
                    queue: service,
                    datum: currentDate,
                    startzeit: currentTime,
                    endzeit: addMinutesToTime(currentTime, dauer),
                    geschaetzteDauer: dauer,
                    status: 'geplant',
                    reihenfolge: reihenfolge++
                });
                currentTime = addMinutesToTime(currentTime, dauer + 15); // +15 Min Puffer
            }

            // 3. Auslieferung hinzufÃ¼gen (wenn Abholung war)
            if (fahrzeug.abholserviceGewuenscht || fahrzeug.fahrzeugAbholung === 'ja') {
                const fahrzeit = fahrzeug.logistikDetails?.travelTimeOneWay || SERVICE_DEFAULT_DURATION.liefer_fahrt;

                // PrÃ¼fe ob Arbeitstag voll wÃ¤re
                const endzeit = addMinutesToTime(currentTime, fahrzeit);
                const [endH] = endzeit.split(':').map(Number);
                if (endH >= 18) {
                    const nextDay = new Date(currentDate);
                    nextDay.setDate(nextDay.getDate() + 1);
                    while (nextDay.getDay() === 0 || nextDay.getDay() === 6) {
                        nextDay.setDate(nextDay.getDate() + 1);
                    }
                    currentDate = nextDay.toISOString().split('T')[0];
                    currentTime = '08:00';
                }

                plan.push({
                    id: `sp_${Date.now()}_${reihenfolge}`,
                    queue: 'liefer_fahrt',
                    datum: currentDate,
                    startzeit: currentTime,
                    endzeit: addMinutesToTime(currentTime, fahrzeit),
                    geschaetzteDauer: fahrzeit,
                    status: 'geplant',
                    reihenfolge: reihenfolge++
                });
            }

            return plan;
        }

        /**
         * Berechnet die Gesamtdauer eines Service-Plans in Minuten
         */
        function calculateTotalPlanDuration(plan) {
            return plan.reduce((sum, step) => sum + step.geschaetzteDauer, 0);
        }

        /**
         * Formatiert Minuten als "Xh Ymin" String
         */
        function formatDuration(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            if (hours === 0) return `${mins} Min`;
            if (mins === 0) return `${hours}h`;
            return `${hours}h ${mins}min`;
        }

        // ============================================
        // DURCHPLANEN-MODAL FUNKTIONEN
        // ============================================

        let currentDurchplanenFahrzeug = null;
        let currentServicePlan = [];

        /**
         * Konvertiert servicePlan-Objekt aus Entwurf zu Array-Format fÃ¼r Tagesplanung
         * @param {Object} fahrzeug - Fahrzeug mit servicePlan-Objekt
         * @returns {Array} - Service-Plan im Array-Format
         */
        function convertEntwurfServicePlan(fahrzeug) {
            const plan = [];
            const servicePlan = fahrzeug.servicePlan;
            let reihenfolge = 1;

            // âœ… ALLE Service-Typen in korrekter Reihenfolge (14 Services)
            const serviceOrder = [
                'abhol_fahrt',      // Logistik Start
                'lackier',          // Werkstatt Services
                'mechanik',
                'reifen',
                'pflege',
                'tuev',
                'versicherung',
                'glas',
                'klima',
                'dellen',
                'folierung',
                'steinschutz',
                'werbebeklebung',
                'liefer_fahrt'      // Logistik Ende
            ];

            // âœ… Standard-Dauern fÃ¼r ALLE Services (in Minuten)
            const serviceDurations = {
                'abhol_fahrt': 45,
                'lackier': 300,         // 5h
                'mechanik': 180,        // 3h
                'reifen': 60,           // 1h
                'pflege': 120,          // 2h
                'tuev': 60,             // 1h
                'versicherung': 240,    // 4h
                'glas': 90,             // 1.5h
                'klima': 60,            // 1h
                'dellen': 120,          // 2h
                'folierung': 480,       // 8h
                'steinschutz': 180,     // 3h
                'werbebeklebung': 240,  // 4h
                'liefer_fahrt': 45
            };

            // âœ… Labels fÃ¼r ALLE Services
            const serviceLabels = {
                'abhol_fahrt': 'ðŸš— Fahrzeug abholen',
                'lackier': 'ðŸŽ¨ Lackierung',
                'mechanik': 'ðŸ”§ Mechanik',
                'reifen': 'ðŸ›ž Reifen',
                'pflege': 'âœ¨ Pflege',
                'tuev': 'ðŸ“‹ TÃœV/AU',
                'versicherung': 'ðŸ›¡ï¸ Versicherung',
                'glas': 'ðŸ” Glas',
                'klima': 'â„ï¸ Klima',
                'dellen': 'ðŸ”¨ Dellen/PDR',
                'folierung': 'ðŸŒˆ Folierung',
                'steinschutz': 'ðŸ›¡ï¸ Steinschutz',
                'werbebeklebung': 'ðŸ“¢ Werbebeklebung',
                'liefer_fahrt': 'ðŸš— Fahrzeug ausliefern'
            };

            // Sortiert nach serviceOrder durchgehen
            for (const serviceType of serviceOrder) {
                if (servicePlan[serviceType]) {
                    const datum = servicePlan[serviceType];
                    plan.push({
                        id: `sp_${Date.now()}_${reihenfolge}`,
                        queue: serviceType,
                        label: serviceLabels[serviceType] || serviceType,
                        datum: datum,
                        startzeit: '08:00',
                        dauer: serviceDurations[serviceType] || 60,
                        reihenfolge: reihenfolge
                    });
                    reihenfolge++;
                }
            }

            // Auch andere Services aus servicePlan Ã¼bernehmen (falls vorhanden)
            for (const [serviceType, datum] of Object.entries(servicePlan)) {
                if (!serviceOrder.includes(serviceType)) {
                    plan.push({
                        id: `sp_${Date.now()}_${reihenfolge}`,
                        queue: serviceType,
                        label: serviceType,
                        datum: datum,
                        startzeit: '08:00',
                        dauer: 60,
                        reihenfolge: reihenfolge
                    });
                    reihenfolge++;
                }
            }

            // Nach Datum sortieren
            plan.sort((a, b) => new Date(a.datum) - new Date(b.datum));

            // Startzeiten berechnen (aufeinanderfolgend pro Tag)
            let currentTime = '08:00';
            let lastDate = null;
            for (const step of plan) {
                // Bei neuem Tag: Reset auf 08:00
                if (lastDate && step.datum !== lastDate) {
                    currentTime = '08:00';
                }
                step.startzeit = currentTime;
                lastDate = step.datum;

                // NÃ¤chste Startzeit berechnen
                const [h, m] = currentTime.split(':').map(Number);
                const totalMinutes = h * 60 + m + step.dauer;
                const newH = Math.floor(totalMinutes / 60);
                const newM = totalMinutes % 60;
                currentTime = `${String(newH).padStart(2, '0')}:${String(newM).padStart(2, '0')}`;
            }

            console.log('ðŸ“… convertEntwurfServicePlan:', plan);
            return plan;
        }

        /**
         * Ã–ffnet das Durchplanen-Modal fÃ¼r ein Fahrzeug
         */
        function openDurchplanenModal(fahrzeug) {
            currentDurchplanenFahrzeug = fahrzeug;

            // ðŸ”— PrÃ¼fen ob servicePlan vorhanden (unterstÃ¼tzt BEIDE Formate: Array UND Object)
            if (fahrzeug.servicePlan && Array.isArray(fahrzeug.servicePlan) && fahrzeug.servicePlan.length > 0) {
                // NEU: servicePlan ist bereits Array-Format (aus entwuerfe-bearbeiten.html v2)
                currentServicePlan = fahrzeug.servicePlan;
                console.log('ðŸ“… servicePlan als Array Ã¼bernommen:', currentServicePlan);
            } else if (fahrzeug.servicePlan && typeof fahrzeug.servicePlan === 'object' &&
                !Array.isArray(fahrzeug.servicePlan) && Object.keys(fahrzeug.servicePlan).length > 0) {
                // LEGACY: servicePlan ist Objekt-Format (RÃ¼ckwÃ¤rtskompatibilitÃ¤t)
                currentServicePlan = convertEntwurfServicePlan(fahrzeug);
                console.log('ðŸ“… servicePlan aus Entwurf (Objectâ†’Array) Ã¼bernommen:', currentServicePlan);
            } else {
                // Fallback: Neuen Plan generieren (wenn kein Entwurf-servicePlan vorhanden)
                const startDate = document.getElementById('datePicker')?.value || new Date().toISOString().split('T')[0];
                currentServicePlan = generateServicePlan(fahrzeug, startDate, '08:00');
            }

            // Rendere Modal
            renderDurchplanenModal();

            // Modal anzeigen
            document.getElementById('durchplanenModal').classList.add('active');
        }

        /**
         * SchlieÃŸt das Durchplanen-Modal
         */
        function closeDurchplanenModal() {
            document.getElementById('durchplanenModal').classList.remove('active');
            currentDurchplanenFahrzeug = null;
            currentServicePlan = [];
        }

        // ============================================
        // VERSCHIEBEN-MODAL FUNKTIONEN (2025-12-11)
        // ============================================

        let verschiebenFahrzeug = null;
        let verschiebenOriginalPlan = null;

        /**
         * Ã–ffnet das Verschieben-Modal fÃ¼r ein bereits geplantes Fahrzeug
         */
        function openVerschiebenModal(fahrzeug) {
            if (!fahrzeug) {
                toast.error('Kein Fahrzeug ausgewÃ¤hlt');
                return;
            }

            // Deep copy des Fahrzeugs
            verschiebenFahrzeug = JSON.parse(JSON.stringify(fahrzeug));

            // Wenn kein servicePlan vorhanden, aber abteilungsQueue gesetzt ist,
            // erstelle einen servicePlan aus den vorhandenen Daten
            if (!verschiebenFahrzeug.servicePlan || !Array.isArray(verschiebenFahrzeug.servicePlan) || verschiebenFahrzeug.servicePlan.length === 0) {
                if (verschiebenFahrzeug.abteilungsQueue && verschiebenFahrzeug.queueDatum) {
                    // Erstelle servicePlan aus abteilungsQueue-Daten
                    verschiebenFahrzeug.servicePlan = [{
                        queue: verschiebenFahrzeug.abteilungsQueue,
                        datum: verschiebenFahrzeug.queueDatum,
                        startzeit: verschiebenFahrzeug.queueStartzeit || '08:00',
                        dauer: verschiebenFahrzeug.queueDauer || 240,
                        reihenfolge: 1
                    }];
                    console.log('ðŸ“… servicePlan aus abteilungsQueue erstellt:', verschiebenFahrzeug.servicePlan);
                } else {
                    toast.error('Fahrzeug hat keine Terminplanung. Bitte erst durchplanen.');
                    return;
                }
            }

            verschiebenOriginalPlan = JSON.parse(JSON.stringify(verschiebenFahrzeug.servicePlan));

            document.getElementById('verschiebenKennzeichen').textContent =
                `${fahrzeug.kennzeichen} - ${verschiebenFahrzeug.servicePlan.length} Service(s)`;

            renderVerschiebenServices();
            document.getElementById('verschiebenModal').classList.add('active');
        }

        /**
         * SchlieÃŸt das Verschieben-Modal
         */
        function closeVerschiebenModal() {
            document.getElementById('verschiebenModal').classList.remove('active');
            verschiebenFahrzeug = null;
            verschiebenOriginalPlan = null;
        }

        /**
         * Rendert die Service-Liste im Verschieben-Modal
         */
        function renderVerschiebenServices() {
            const container = document.getElementById('verschiebenServiceList');
            const plan = verschiebenFahrzeug.servicePlan;

            // Service-Labels fÃ¼r Anzeige
            const SERVICE_LABELS = {
                abhol_fahrt: 'ðŸš— Fahrzeug abholen',
                lackier: 'ðŸŽ¨ Lackierung',
                mechanik: 'ðŸ”§ Mechanik',
                reifen: 'ðŸ›ž Reifen',
                pflege: 'âœ¨ Pflege/Smart Repair',
                tuev: 'ðŸ“‹ TÃœV/AU',
                versicherung: 'ðŸ›¡ï¸ Versicherung',
                glas: 'ðŸªŸ Glas',
                klima: 'â„ï¸ Klima',
                dellen: 'ðŸ”¨ Dellen/Karosserie',
                folierung: 'ðŸŽ­ Folierung',
                steinschutz: 'ðŸ›¡ï¸ Steinschutz',
                werbebeklebung: 'ðŸ“¢ Werbebeklebung',
                liefer_fahrt: 'ðŸšš Fahrzeug liefern'
            };

            let html = '';
            plan.forEach((service, index) => {
                const isChanged = service.datum !== verschiebenOriginalPlan[index].datum;
                const label = service.label || SERVICE_LABELS[service.queue] || service.queue;

                html += `
                    <div class="verschieben-service ${isChanged ? 'changed' : ''}">
                        <div class="service-header">
                            ${index + 1}. ${label}
                        </div>
                        <div class="service-datum">
                            <label>Datum:</label>
                            <input type="date"
                                   value="${service.datum}"
                                   onchange="onVerschiebenDatumChange(${index}, this.value)">
                            <label>Uhrzeit:</label>
                            <input type="time"
                                   value="${service.startzeit || '08:00'}"
                                   onchange="onVerschiebenZeitChange(${index}, this.value)">
                        </div>
                        ${isChanged ? '<div class="auto-shift-hint">Verschoben</div>' : ''}
                    </div>
                `;

                if (index < plan.length - 1) {
                    html += '<div class="verschieben-arrow">â†“</div>';
                }
            });

            container.innerHTML = html;
        }

        /**
         * Handler fÃ¼r DatumsÃ¤nderung - verschiebt alle Folge-Services automatisch
         */
        function onVerschiebenDatumChange(changedIndex, newDate) {
            const plan = verschiebenFahrzeug.servicePlan;
            const originalDate = new Date(verschiebenOriginalPlan[changedIndex].datum + 'T00:00:00');
            const newDateObj = new Date(newDate + 'T00:00:00');

            // Differenz in Tagen berechnen
            const diffMs = newDateObj.getTime() - originalDate.getTime();
            const diffDays = Math.round(diffMs / (1000 * 60 * 60 * 24));

            console.log(`Verschiebe Service ${changedIndex} um ${diffDays} Tage`);

            // Alle Services ab changedIndex verschieben
            for (let i = changedIndex; i < plan.length; i++) {
                const origDate = new Date(verschiebenOriginalPlan[i].datum + 'T00:00:00');
                origDate.setDate(origDate.getDate() + diffDays);
                plan[i].datum = origDate.toISOString().split('T')[0];
            }

            renderVerschiebenServices();
        }

        /**
         * Handler fÃ¼r UhrzeitÃ¤nderung
         */
        function onVerschiebenZeitChange(index, newTime) {
            verschiebenFahrzeug.servicePlan[index].startzeit = newTime;
            renderVerschiebenServices();
        }

        /**
         * Speichert die Verschiebung in Firestore
         */
        async function saveVerschiebung() {
            console.log('ðŸ’¾ saveVerschiebung() aufgerufen');

            try {
                console.log('ðŸ“Š verschiebenFahrzeug:', verschiebenFahrzeug);
                console.log('ðŸ“Š verschiebenOriginalPlan:', verschiebenOriginalPlan);

                // PrÃ¼fen ob Ã„nderungen vorliegen (Datum ODER Uhrzeit)
                const hasChanges = verschiebenFahrzeug.servicePlan.some((service, index) => {
                    const datumChanged = service.datum !== verschiebenOriginalPlan[index].datum;
                    const zeitChanged = service.startzeit !== verschiebenOriginalPlan[index].startzeit;
                    console.log(`  Service ${index}: datum ${service.datum} vs ${verschiebenOriginalPlan[index].datum} = ${datumChanged ? 'CHANGED' : 'same'}`);
                    console.log(`  Service ${index}: zeit ${service.startzeit} vs ${verschiebenOriginalPlan[index].startzeit} = ${zeitChanged ? 'CHANGED' : 'same'}`);
                    return datumChanged || zeitChanged;
                });

                console.log('ðŸ“Š hasChanges:', hasChanges);

                if (!hasChanges) {
                    console.log('âš ï¸ Keine Ã„nderungen - zeige Info-Toast');
                    toast.info('Keine Ã„nderungen zum Speichern');
                    closeVerschiebenModal();
                    return;
                }

                console.log('âœ… Ã„nderungen vorhanden - speichere...');
                toast.info('Speichere Ã„nderungen...');

                const fahrzeugId = verschiebenFahrzeug.id;
                const newPlan = verschiebenFahrzeug.servicePlan;

                // Firestore Update
                const collection = window.getCollection('fahrzeuge');
                const updateData = {
                    servicePlan: newPlan,
                    lastModified: firebase.firestore.FieldValue.serverTimestamp(),
                    lastModifiedBy: 'tagesplanung:verschieben'
                };

                // ðŸ†• Geplantes Abnahmetermin aktualisieren (letzter Service bestimmt das Ende)
                const lastService = newPlan[newPlan.length - 1];
                if (lastService && lastService.datum) {
                    // Format fÃ¼r geplantesAbnahmeDatum: DD.MM.YYYY (fÃ¼r Partner-App Anzeige)
                    const [year, month, day] = lastService.datum.split('-');
                    updateData.geplantesAbnahmeDatum = `${day}.${month}.${year}`;
                    updateData.abholtermin = lastService.datum; // ISO-Format fÃ¼r Sortierung

                    // ðŸ†• Partner-App Felder aktualisieren (fertigstellungsdatum wird dort angezeigt)
                    updateData.fertigstellungsdatum = lastService.datum; // ISO-Format
                    updateData['angebotDetails.fertigstellungsdatum'] = lastService.datum;

                    console.log('ðŸ“… Neues Abnahmetermin:', updateData.geplantesAbnahmeDatum);
                }

                // ðŸ†• Auftragsstart-Felder aktualisieren (erster Service = Start)
                const firstService = newPlan[0];
                if (firstService && firstService.datum) {
                    updateData.anliefertermin = firstService.datum;  // YYYY-MM-DD fÃ¼r Partner-App Auftragsstart
                    updateData['kva.termine.start'] = firstService.datum;  // YYYY-MM-DD
                    console.log('ðŸ“… Neuer Auftragsstart:', firstService.datum);

                    // ðŸ†• 48h-Check: Wenn Service auÃŸerhalb 48h-Fenster, aus Kanban-Queue entfernen
                    const firstServiceDate = new Date(firstService.datum);
                    const cutoffDate = new Date();
                    cutoffDate.setHours(0, 0, 0, 0);
                    cutoffDate.setDate(cutoffDate.getDate() + 2); // Ãœbermorgen 00:00 = auÃŸerhalb 48h

                    if (firstServiceDate >= cutoffDate) {
                        console.log('ðŸ“… Service liegt auÃŸerhalb 48h-Fenster - entferne aus Kanban');
                        updateData.abteilungsQueue = firebase.firestore.FieldValue.delete();
                        updateData.queueDatum = firebase.firestore.FieldValue.delete();
                        updateData.queuePosition = firebase.firestore.FieldValue.delete();
                        updateData.logistikQueue = firebase.firestore.FieldValue.delete();
                    }
                }

                // Wenn abteilungsQueue bereits gesetzt, das queueDatum aktualisieren
                if (verschiebenFahrzeug.abteilungsQueue) {
                    // Finde den Service der zur aktuellen abteilungsQueue gehÃ¶rt
                    const currentQueueService = newPlan.find(s => s.queue === verschiebenFahrzeug.abteilungsQueue);
                    if (currentQueueService) {
                        updateData.queueDatum = currentQueueService.datum;
                    }
                }

                await collection.doc(fahrzeugId).update(updateData);

                // ðŸ†• AUCH partnerAnfragen Collection aktualisieren (Partner-App liest von dort!)
                const anfrageId = verschiebenFahrzeug.anfrage_id || verschiebenFahrzeug.anfrageId || verschiebenFahrzeug.originalAnfrageId;
                if (anfrageId) {
                    console.log('ðŸ”„ Aktualisiere partnerAnfragen Dokument:', anfrageId);
                    try {
                        const partnerCollection = window.getCollection('partnerAnfragen');
                        const partnerUpdateData = {
                            servicePlan: newPlan,
                            lastModified: firebase.firestore.FieldValue.serverTimestamp(),
                            lastModifiedBy: 'tagesplanung:verschieben'
                        };

                        // Datum-Felder nur hinzufÃ¼gen wenn lastService existiert
                        if (lastService && lastService.datum) {
                            const [year, month, day] = lastService.datum.split('-');
                            partnerUpdateData.geplantesAbnahmeDatum = `${day}.${month}.${year}`;
                            partnerUpdateData.abholtermin = lastService.datum;
                            partnerUpdateData.fertigstellungsdatum = lastService.datum;
                            partnerUpdateData['angebotDetails.fertigstellungsdatum'] = lastService.datum;
                        }

                        // ðŸ†• Auftragsstart-Felder fÃ¼r Partner-App
                        if (firstService && firstService.datum) {
                            partnerUpdateData.anliefertermin = firstService.datum;
                            partnerUpdateData['kva.termine.start'] = firstService.datum;

                            // ðŸ†• 48h-Check: Gleicher Check wie bei fahrzeuge
                            const firstServiceDate = new Date(firstService.datum);
                            const cutoffDate = new Date();
                            cutoffDate.setHours(0, 0, 0, 0);
                            cutoffDate.setDate(cutoffDate.getDate() + 2);

                            if (firstServiceDate >= cutoffDate) {
                                partnerUpdateData.abteilungsQueue = firebase.firestore.FieldValue.delete();
                                partnerUpdateData.queueDatum = firebase.firestore.FieldValue.delete();
                                partnerUpdateData.queuePosition = firebase.firestore.FieldValue.delete();
                                partnerUpdateData.logistikQueue = firebase.firestore.FieldValue.delete();
                            }
                        }

                        await partnerCollection.doc(String(anfrageId)).update(partnerUpdateData);
                        console.log('âœ… partnerAnfragen erfolgreich aktualisiert');
                    } catch (partnerError) {
                        console.warn('âš ï¸ partnerAnfragen Update fehlgeschlagen (evtl. kein Dokument):', partnerError.message);
                        // Kein Fehler werfen - fahrzeuge wurde bereits aktualisiert
                    }
                } else {
                    console.log('â„¹ï¸ Keine anfrageId gefunden - nur fahrzeuge Collection aktualisiert');
                }

                closeVerschiebenModal();

                // UI neu laden
                await loadFahrzeuge();

                toast.success('Termine erfolgreich verschoben!');

            } catch (error) {
                console.error('Fehler beim Speichern der Verschiebung:', error);
                toast.error('Fehler beim Speichern: ' + error.message);
            }
        }

        /**
         * Rendert den Inhalt des Durchplanen-Modals
         */
        function renderDurchplanenModal() {
            const fahrzeug = currentDurchplanenFahrzeug;
            const plan = currentServicePlan;

            if (!fahrzeug || !plan) return;

            // Fahrzeug-Info
            const services = fahrzeug.requiredServices?.length > 0
                ? fahrzeug.requiredServices.map(s => QUEUE_LABELS[s]?.label || s).join(', ')
                : (QUEUE_LABELS[fahrzeug.serviceTyp]?.label || fahrzeug.serviceTyp || 'Unbekannt');

            const abholInfo = (fahrzeug.abholserviceGewuenscht || fahrzeug.fahrzeugAbholung === 'ja')
                ? ' â€¢ Abholung gewÃ¼nscht' : '';

            document.getElementById('durchplanenFahrzeugInfo').innerHTML = `
                <div class="kennzeichen">${fahrzeug.kennzeichen || 'Unbekannt'}</div>
                <div class="fahrzeug-details">
                    ${fahrzeug.fahrzeugTyp || fahrzeug.modell || ''} â€¢ ${services}${abholInfo}
                </div>
            `;

            // Service-Schritte rendern
            let stepsHtml = '';
            plan.forEach((step, index) => {
                const queueInfo = QUEUE_LABELS[step.queue] || { icon: 'ðŸ“‹', label: step.queue };

                stepsHtml += `
                    <div class="durchplanen-step" data-index="${index}">
                        <div class="durchplanen-step-header">
                            <div class="durchplanen-step-number">${index + 1}</div>
                            <div class="durchplanen-step-title">
                                <span>${queueInfo.icon}</span>
                                <span>${queueInfo.label}</span>
                            </div>
                        </div>
                        <div class="durchplanen-step-inputs">
                            <div>
                                <label>Datum</label>
                                <input type="date"
                                       value="${step.datum}"
                                       onchange="updateDurchplanenStep(${index}, 'datum', this.value)">
                            </div>
                            <div>
                                <label>Startzeit</label>
                                <input type="time"
                                       value="${step.startzeit}"
                                       onchange="updateDurchplanenStep(${index}, 'startzeit', this.value)">
                            </div>
                        </div>
                        <div class="durchplanen-step-info">
                            <span>Dauer: ~${formatDuration(step.geschaetzteDauer)}</span>
                            <span>Ende: ca. ${step.endzeit}</span>
                        </div>
                    </div>
                `;
            });

            document.getElementById('durchplanenSteps').innerHTML = stepsHtml;

            // Zusammenfassung
            const totalDuration = calculateTotalPlanDuration(plan);
            const firstStep = plan[0];
            const lastStep = plan[plan.length - 1];
            const startDatum = firstStep ? new Date(firstStep.datum).toLocaleDateString('de-DE', { weekday: 'short', day: 'numeric', month: 'short' }) : '-';
            const endDatum = lastStep ? new Date(lastStep.datum).toLocaleDateString('de-DE', { weekday: 'short', day: 'numeric', month: 'short' }) : '-';

            document.getElementById('durchplanenSummary').innerHTML = `
                <div class="durchplanen-summary-row">
                    <span>Anzahl Services:</span>
                    <span>${plan.length}</span>
                </div>
                <div class="durchplanen-summary-row">
                    <span>Start:</span>
                    <span>${startDatum}, ${firstStep?.startzeit || '-'}</span>
                </div>
                <div class="durchplanen-summary-row">
                    <span>Ende:</span>
                    <span>${endDatum}, ${lastStep?.endzeit || '-'}</span>
                </div>
                <div class="durchplanen-summary-row total">
                    <span>Gesamtdauer:</span>
                    <span>~${formatDuration(totalDuration)}</span>
                </div>
            `;
        }

        /**
         * Aktualisiert einen Schritt im Plan nach User-Eingabe
         */
        function updateDurchplanenStep(index, field, value) {
            if (!currentServicePlan[index]) return;

            currentServicePlan[index][field] = value;

            // Endzeit neu berechnen wenn Startzeit geÃ¤ndert
            if (field === 'startzeit') {
                currentServicePlan[index].endzeit = addMinutesToTime(
                    value,
                    currentServicePlan[index].geschaetzteDauer
                );

                // Optional: Folgende Schritte automatisch verschieben (wenn gleicher Tag)
                for (let i = index + 1; i < currentServicePlan.length; i++) {
                    const prevStep = currentServicePlan[i - 1];
                    const currStep = currentServicePlan[i];

                    // Nur verschieben wenn gleicher Tag
                    if (prevStep.datum === currStep.datum) {
                        // Startzeit = Ende des vorherigen + 15 Min Puffer
                        currStep.startzeit = addMinutesToTime(prevStep.endzeit, 15);
                        currStep.endzeit = addMinutesToTime(currStep.startzeit, currStep.geschaetzteDauer);
                    }
                }
            }

            // Wenn Datum geÃ¤ndert wird, folgende Schritte nicht automatisch Ã¤ndern
            // (User hat bewusst ein anderes Datum gewÃ¤hlt)

            // Modal neu rendern
            renderDurchplanenModal();
        }

        /**
         * Speichert die Durchplanung in Firestore
         */
        async function saveDurchplanung() {
            if (!currentDurchplanenFahrzeug || !currentServicePlan.length) {
                console.error('âŒ Keine Durchplanung zum Speichern');
                return;
            }

            const fahrzeugId = currentDurchplanenFahrzeug.id;
            const plan = currentServicePlan;

            try {
                // Fahrzeug-Dokument updaten
                const fahrzeugRef = window.getCollection('fahrzeuge').doc(fahrzeugId);

                // Erster Service fÃ¼r RÃ¼ckwÃ¤rtskompatibilitÃ¤t
                const firstServiceStep = plan.find(s => !LOGISTIK_QUEUES.includes(s.queue)) || plan[0];

                await fahrzeugRef.update({
                    // Neues servicePlan Array
                    servicePlan: plan,

                    // RÃ¼ckwÃ¤rtskompatibilitÃ¤t: Hauptzuweisung aus erstem Service-Schritt
                    queueDatum: firebase.firestore.Timestamp.fromDate(new Date(firstServiceStep.datum)),
                    abteilungsQueue: LOGISTIK_QUEUES.includes(firstServiceStep.queue) ? null : firstServiceStep.queue,
                    logistikQueue: LOGISTIK_QUEUES.includes(plan[0].queue) ? plan[0].queue : null,
                    queuePosition: 1,
                    prioritaet: 1
                });

                console.log(`âœ… Service-Plan fÃ¼r ${currentDurchplanenFahrzeug.kennzeichen} gespeichert`);

                if (window.toast) {
                    window.toast.success(`Plan fÃ¼r ${currentDurchplanenFahrzeug.kennzeichen} gespeichert!`);
                }

                // Modal schlieÃŸen
                closeDurchplanenModal();

                // Daten neu laden
                hasUnsavedChanges = false;
                await loadFahrzeuge();

            } catch (error) {
                console.error('âŒ Fehler beim Speichern:', error);
                if (window.toast) {
                    window.toast.error('Fehler beim Speichern des Plans');
                }
            }
        }

        // ============================================
        // FAHRZEIT-BERECHNUNG (Google Maps)
        // ============================================

        /**
         * Berechnet die Fahrzeit fÃ¼r ein Fahrzeug via Google Maps Cloud Function
         * @param {Object} fahrzeug - Das Fahrzeug-Objekt
         */
        async function calculateTravelTimeForFahrzeug(fahrzeug) {
            if (!window.functions) {
                console.warn('âš ï¸ Firebase Functions nicht verfÃ¼gbar - nutze Default-Zeiten');
                return;
            }

            // PrÃ¼fen ob Kundenadresse vorhanden und gÃ¼ltig (min. 5 Zeichen)
            const kundenAdresse = (fahrzeug.abholadresse || fahrzeug.kundenadresse || '').trim();
            if (!kundenAdresse || kundenAdresse.length < 5) {
                console.warn(`âš ï¸ ${fahrzeug.kennzeichen}: Keine gÃ¼ltige Kundenadresse fÃ¼r Fahrzeit-Berechnung`);
                return;
            }

            console.log(`ðŸ—ºï¸ Berechne Fahrzeit fÃ¼r ${fahrzeug.kennzeichen}...`);

            try {
                const calculateTravelTime = window.functions.httpsCallable('calculateTravelTime');
                const result = await calculateTravelTime({
                    fahrzeugId: fahrzeug.id,
                    destination: kundenAdresse,  // Cloud Function erwartet "destination"
                    werkstattId: window.werkstattId
                });

                if (result.data) {
                    // Update lokales Fahrzeug-Objekt
                    fahrzeug.logistikDetails = {
                        ...(fahrzeug.logistikDetails || {}),
                        travelTimeOneWay: result.data.durationMinutes,
                        travelTimeRoundTrip: result.data.durationRoundTrip,
                        distanceKm: result.data.distanceKm,
                        distanceRoundTrip: result.data.distanceRoundTrip,
                        routeOrigin: result.data.origin,       // Werkstatt-Adresse
                        routeDestination: result.data.destination, // Kunden-Adresse
                        calculatedAt: new Date().toISOString()
                    };

                    console.log(`âœ… ${fahrzeug.kennzeichen}: ${result.data.durationRoundTrip} Min Fahrzeit (${result.data.distanceRoundTrip} km)`);

                    // UI aktualisieren
                    renderAll();
                    updateCapacityBar();

                    if (window.toast) {
                        window.toast.success(`Fahrzeit berechnet: ${Math.round(result.data.durationRoundTrip)} Min`);
                    }
                }
            } catch (error) {
                console.error(`âŒ Fahrzeit-Berechnung fehlgeschlagen fÃ¼r ${fahrzeug.kennzeichen}:`, error);
                if (window.toast) {
                    window.toast.warning('Fahrzeit konnte nicht berechnet werden - nutze Standardwert');
                }
            }
        }

        // ============================================
        // INITIALIZATION
        // ============================================

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ðŸ“… Tagesplanung wird initialisiert...');

            // Set date picker to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('datePicker').value = today;
            document.getElementById('datePicker').addEventListener('change', onDateChange);

            // Wait for Firebase
            try {
                await window.firebaseInitialized;
                console.log('âœ… Firebase initialisiert, werkstattId:', window.werkstattId);

                // Check permissions - WAIT for Auth State (Race Condition Fix!)
                // firebase.auth().currentUser is null until onAuthStateChanged fires
                console.log('â³ Warte auf Auth State...');
                const authUser = await new Promise((resolve) => {
                    const unsubscribe = firebase.auth().onAuthStateChanged((user) => {
                        unsubscribe();  // Only fire once
                        resolve(user);
                    });
                });

                if (!authUser) {
                    console.warn('âš ï¸ Nicht eingeloggt - Redirect zu index.html');
                    alert('Bitte zuerst einloggen.');
                    window.safeNavigate ? window.safeNavigate('index.html') : window.location.href = 'index.html';
                    return;
                }
                console.log('âœ… Auth User gefunden:', authUser.email);

                // Rolle aus Firestore laden (users Collection ist global, kein Suffix)
                // ðŸ”§ FIX (2025-12-10): window.db statt firebase.firestore()
                const userDoc = await window.db.collection('users').doc(authUser.uid).get();
                const role = userDoc.exists ? userDoc.data().role : 'mitarbeiter';
                console.log('ðŸ‘¤ User Role:', role, '(UID:', authUser.uid, ')');

                // werkstattId aus userDoc setzen falls noch nicht vorhanden (Race Condition Fix!)
                if (!window.werkstattId && userDoc.exists && userDoc.data().werkstattId) {
                    window.werkstattId = userDoc.data().werkstattId;
                    console.log('ðŸ¢ werkstattId aus userDoc gesetzt:', window.werkstattId);
                }

                // Fallback: Warte kurz auf auth-manager Restore (max 2 Sekunden)
                if (!window.werkstattId) {
                    console.log('â³ Warte auf werkstattId...');
                    let attempts = 0;
                    while (!window.werkstattId && attempts < 20) {
                        await new Promise(r => setTimeout(r, 100));
                        attempts++;
                    }
                    if (window.werkstattId) {
                        console.log('âœ… werkstattId nach Polling verfÃ¼gbar:', window.werkstattId);
                    } else {
                        console.error('âŒ werkstattId konnte nicht geladen werden!');
                        alert('Fehler: Werkstatt-ID nicht gefunden. Bitte neu einloggen.');
                        window.safeNavigate ? window.safeNavigate('index.html') : window.location.href = 'index.html';
                        return;
                    }
                }

                if (role !== 'admin' && role !== 'werkstatt') {
                    alert('Zugriff nur fÃ¼r Werkstattleiter und Admins.');
                    window.safeNavigate ? window.safeNavigate('kanban.html') : window.location.href = 'kanban.html';
                    return;
                }

                // ðŸ”§ 2025-12-07: KapazitÃ¤t laden
                await loadKapazitaetSettings();

                await loadFahrzeuge();
                setupDragAndDrop();
                hideLoading();

                // ðŸ”§ 2025-12-07: KapazitÃ¤ts-Bar aktualisieren
                updateCapacityBar();

            } catch (error) {
                console.error('âŒ Initialisierungsfehler:', error);
                hideLoading();
                alert('Fehler beim Laden. Bitte Seite neu laden.');
            }
        });

        // ============================================
        // DATA LOADING
        // ============================================

        async function loadFahrzeuge() {
            console.log('ðŸ“¥ Lade Fahrzeuge...');

            // ðŸ”§ FIX (2025-12-10): window.db statt firebase.firestore()
            const db = window.db;
            // FIX: getCollectionName gibt String zurÃ¼ck, getCollection gibt CollectionReference!
            const collectionName = window.getCollectionName ? window.getCollectionName('fahrzeuge') : `fahrzeuge_${window.werkstattId}`;

            try {
                // Pipeline-Optimierung (2025-12-08): Nur Fahrzeuge mit status='beauftragt' laden
                // Diese kommen aus Partner-Annahme (meine-anfragen.html/anfrage-detail.html)
                const snapshot = await db.collection(collectionName)
                    .where('status', '==', 'beauftragt')
                    .get();

                allFahrzeuge = [];
                snapshot.forEach(doc => {
                    allFahrzeuge.push({ id: doc.id, ...doc.data() });
                });

                console.log(`âœ… ${allFahrzeuge.length} Fahrzeuge geladen`);

                // Calculate dringlichkeit scores
                allFahrzeuge.forEach(f => {
                    f.dringlichkeitsScore = calculateDringlichkeitsScore(f);
                });

                // Separate ungeplant vs queued
                categorizeVehicles();
                renderAll();
                updateStats();

            } catch (error) {
                console.error('âŒ Fehler beim Laden:', error);
            }
        }

        function categorizeVehicles() {
            const dateStr = document.getElementById('datePicker').value;

            ungeplanteFahrzeuge = [];
            // Reset all 16 queues
            queuedFahrzeuge = {};
            ALL_QUEUES.forEach(q => queuedFahrzeuge[q] = []);

            allFahrzeuge.forEach(f => {
                // ðŸ“… servicePlan Support (2025-12-09) - UPDATED fÃ¼r Array-Format (2025-12-11)
                // Wenn Fahrzeug einen servicePlan hat, prÃ¼fe ob fÃ¼r diesen Tag ein Service geplant ist
                if (f.servicePlan) {
                    let addedToQueue = false;

                    // NEU: Array-Format (aus entwuerfe-bearbeiten.html)
                    if (Array.isArray(f.servicePlan)) {
                        for (const step of f.servicePlan) {
                            if (step.datum === dateStr && queuedFahrzeuge[step.queue] !== undefined) {
                                queuedFahrzeuge[step.queue].push({
                                    ...f,
                                    abteilungsQueue: step.queue,
                                    queueDatum: step.datum,
                                    queueStartzeit: step.startzeit,
                                    queueDauer: step.dauer
                                });
                                addedToQueue = true;
                            }
                        }
                        if (addedToQueue) return;

                        // PrÃ¼fe ob irgendein Service fÃ¼r einen anderen Tag geplant ist
                        const hasAnyPlannedService = f.servicePlan.some(s => s.datum);
                        if (hasAnyPlannedService) return; // Hat Plan fÃ¼r anderen Tag - nicht zu ungeplant
                    }
                    // LEGACY: Object-Format (RÃ¼ckwÃ¤rtskompatibilitÃ¤t)
                    else if (typeof f.servicePlan === 'object') {
                        for (const [serviceType, plannedDate] of Object.entries(f.servicePlan)) {
                            if (plannedDate === dateStr && queuedFahrzeuge[serviceType] !== undefined) {
                                // Fahrzeug fÃ¼r diesen Service an diesem Tag eingeplant
                                queuedFahrzeuge[serviceType].push({
                                    ...f,
                                    // Override fÃ¼r diese Queue
                                    abteilungsQueue: serviceType,
                                    queueDatum: plannedDate
                                });
                                addedToQueue = true;
                            }
                        }
                        if (addedToQueue) return; // Mindestens eine Queue gefunden

                        // PrÃ¼fe ob irgendein Service fÃ¼r einen anderen Tag geplant ist
                        const hasAnyPlannedService = Object.values(f.servicePlan).some(d => d);
                        if (hasAnyPlannedService) return; // Hat Plan fÃ¼r anderen Tag - nicht zu ungeplant
                    }
                }

                // Check if already queued for this date (abteilungsQueue for Service, logistikQueue for Logistik)
                const queue = f.abteilungsQueue || f.logistikQueue;
                if (f.queueDatum && queue) {
                    const queueDate = f.queueDatum.toDate ? f.queueDatum.toDate() : new Date(f.queueDatum);
                    const queueDateStr = queueDate.toISOString().split('T')[0];

                    if (queueDateStr === dateStr && queuedFahrzeuge[queue] !== undefined) {
                        queuedFahrzeuge[queue].push(f);
                        return;
                    }
                    // ðŸ”§ FIX 29 (2025-12-09): Fahrzeug ist fÃ¼r ANDEREN Tag geplant - NICHT zu ungeplant!
                    return;
                }

                // Add to ungeplant (nur wenn KEIN queueDatum oder KEINE queue)
                ungeplanteFahrzeuge.push(f);
            });

            // Sort queues by position
            ALL_QUEUES.forEach(queue => {
                queuedFahrzeuge[queue].sort((a, b) => (a.queuePosition || 999) - (b.queuePosition || 999));
            });

            // Sort ungeplant by dringlichkeit
            sortUngeplant();
        }

        // ============================================
        // DRINGLICHKEIT SCORING
        // ============================================

        // ðŸ†• Pipeline-Optimierung (2025-12-08): Arbeitszeit aus KVA-Daten berechnen
        function calculateWorkHours(fahrzeug) {
            const kalkulation = fahrzeug.kalkulationData || fahrzeug.kalkulation;
            if (!kalkulation?.positionen && !kalkulation?.arbeitslohn) return 2; // Default 2h

            let totalAW = 0;

            // Positionen aus kalkulationData (neues Format)
            if (kalkulation.positionen && Array.isArray(kalkulation.positionen)) {
                totalAW += kalkulation.positionen.reduce((sum, p) => {
                    return sum + (parseFloat(p.arbeitswerte) || 0);
                }, 0);
            }

            // Arbeitslohn-Array (alternatives Format)
            if (kalkulation.arbeitslohn && Array.isArray(kalkulation.arbeitslohn)) {
                totalAW += kalkulation.arbeitslohn.reduce((sum, a) => {
                    return sum + (parseFloat(a.arbeitswerte) || parseFloat(a.aw) || 0);
                }, 0);
            }

            // 1 AW = 5 Minuten â†’ Stunden berechnen
            const hours = (totalAW * 5) / 60;
            return Math.max(0.5, Math.round(hours * 2) / 2); // Min 0.5h, gerundet auf 0.5h
        }

        // ðŸ†• Pipeline-Optimierung (2025-12-08): Zeitslots fÃ¼r Queue berechnen
        function calculateTimeSlots(queueItems) {
            const WORK_START = 8;  // 08:00
            const WORK_END = 17;   // 17:00
            let currentHour = WORK_START;

            return queueItems.map(f => {
                const hours = calculateWorkHours(f);
                const startMinutes = Math.round((currentHour % 1) * 60);
                const start = `${String(Math.floor(currentHour)).padStart(2, '0')}:${String(startMinutes).padStart(2, '0')}`;

                currentHour += hours;
                const endMinutes = Math.round((currentHour % 1) * 60);
                const end = `${String(Math.floor(currentHour)).padStart(2, '0')}:${String(endMinutes).padStart(2, '0')}`;

                return { ...f, scheduledStart: start, scheduledEnd: end, estimatedHours: hours };
            });
        }

        function calculateDringlichkeitsScore(fahrzeug) {
            let score = 0;

            // 1. Termin-Dringlichkeit (max 50 Punkte)
            if (fahrzeug.abholtermin || fahrzeug.geplantesAbnahmeDatum) {
                const deadline = fahrzeug.abholtermin || fahrzeug.geplantesAbnahmeDatum;
                const deadlineDate = deadline.toDate ? deadline.toDate() : new Date(deadline);
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const daysUntil = Math.ceil((deadlineDate - today) / (1000 * 60 * 60 * 24));

                if (daysUntil <= 0) score += 50;      // ÃœberfÃ¤llig
                else if (daysUntil === 1) score += 40; // Heute
                else if (daysUntil === 2) score += 30; // Morgen
                else if (daysUntil <= 7) score += 15;
            }

            // 2. Wartezeit im System (max 30 Punkte)
            if (fahrzeug.erstelltAm || fahrzeug.createdAt) {
                const created = fahrzeug.erstelltAm || fahrzeug.createdAt;
                const createdDate = typeof created === 'number' ? new Date(created) :
                                   (created.toDate ? created.toDate() : new Date(created));
                const daysWaiting = Math.floor((new Date() - createdDate) / (1000 * 60 * 60 * 24));
                score += Math.min(daysWaiting * 3, 30);
            }

            // 3. Arbeitsaufwand-Bonus (max 20 Punkte) - Pipeline-Optimierung
            const workHours = calculateWorkHours(fahrzeug);
            if (workHours <= 2) score += 20;      // Schnelle Jobs priorisieren
            else if (workHours <= 4) score += 10;

            // 4. Service-Typ Bonus (max 15 Punkte) - erweitert
            const serviceBonus = {
                'reifen': 15, 'pflege': 15, 'tuev': 15,  // Schnell
                'glas': 10, 'klima': 10,                  // Mittel
                'mechanik': 5, 'lackier': 0               // Komplex
            };
            score += serviceBonus[fahrzeug.serviceTyp] || 0;

            return score;
        }

        function getDringlichkeitLevel(score) {
            if (score >= 50) return 'hoch';
            if (score >= 25) return 'mittel';
            return 'niedrig';
        }

        // ============================================
        // RENDERING
        // ============================================

        function renderAll() {
            renderUngeplant();
            renderQueues();
        }

        // ============================================
        // KATEGORISIERUNG DER UNGEPLANTEN (2025-12-09)
        // ============================================

        function categorizeUngeplant(fahrzeuge) {
            const bereit = [];      // Fahrzeug vor Ort
            const logistik = [];    // Abholung/Leihwagen ausstehend
            const zukunft = [];     // Start > 7 Tage

            const heute = new Date();
            heute.setHours(0, 0, 0, 0);
            const in7Tagen = new Date(heute.getTime() + 7 * 24 * 60 * 60 * 1000);

            fahrzeuge.forEach(f => {
                // Pruefe ob Fahrzeug vor Ort
                if (f.fahrzeugVorOrt === true) {
                    bereit.push(f);
                    return;
                }

                // Pruefe Start-Datum (zukuenftig = > 7 Tage)
                const startDatum = f.geplantesStartDatum || f.abholtermin || f.abholdatum;
                if (startDatum) {
                    const start = startDatum?.toDate ? startDatum.toDate() : new Date(startDatum);
                    if (start > in7Tagen) {
                        zukunft.push(f);
                        return;
                    }
                }

                // Pruefe Logistik-Status
                const brauchtAbholung = (f.abholserviceGewuenscht || f.fahrzeugAbholung === 'ja') &&
                                        f.logistikStatus?.abholung !== 'erledigt';
                const brauchtLeihwagen = f.ersatzfahrzeugGewuenscht &&
                                         f.logistikStatus?.leihwagen !== 'erledigt';

                // Wenn Logistik ausstehend ODER Selbstanlieferung noch nicht eingetroffen
                if (brauchtAbholung || brauchtLeihwagen) {
                    logistik.push(f);
                } else if (!f.fahrzeugVorOrt) {
                    // Selbstanlieferung, noch nicht eingetroffen
                    logistik.push(f);
                } else {
                    bereit.push(f);
                }
            });

            return { bereit, logistik, zukunft };
        }

        function switchUngeplantTab(tab) {
            currentUngeplantTab = tab;

            // Update Tab-Buttons
            document.querySelectorAll('.ungeplant-tabs .tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === tab);
            });

            // Re-render
            renderUngeplantList();
        }

        function renderUngeplant() {
            const container = document.getElementById('ungeplantList');

            // Gesamt-Zaehler
            document.getElementById('ungeplantCount').textContent = ungeplanteFahrzeuge.length;

            // Kategorisieren
            categorizedUngeplant = categorizeUngeplant(ungeplanteFahrzeuge);

            // Tab-Zaehler aktualisieren
            document.getElementById('countBereit').textContent = categorizedUngeplant.bereit.length;
            document.getElementById('countLogistik').textContent = categorizedUngeplant.logistik.length;
            document.getElementById('countZukunft').textContent = categorizedUngeplant.zukunft.length;

            // Render Liste
            renderUngeplantList();
        }

        function renderUngeplantList() {
            const container = document.getElementById('ungeplantList');
            const fahrzeuge = categorizedUngeplant[currentUngeplantTab] || [];

            if (fahrzeuge.length === 0) {
                const emptyMessages = {
                    bereit: 'Keine Fahrzeuge bereit',
                    logistik: 'Keine ausstehende Logistik',
                    zukunft: 'Keine zukuenftigen Auftraege'
                };
                container.innerHTML = `<div class="empty-state">${emptyMessages[currentUngeplantTab]}</div>`;
                return;
            }

            container.innerHTML = fahrzeuge.map(f => createFahrzeugCard(f)).join('');
        }

        // Fahrzeug als eingetroffen markieren
        async function markFahrzeugEingetroffen(fahrzeugId) {
            try {
                await window.getCollection('fahrzeuge').doc(fahrzeugId).update({
                    fahrzeugVorOrt: true,
                    fahrzeugEingetroffenAm: new Date().toISOString()
                });
                toast.success('Fahrzeug als eingetroffen markiert');
                await loadFahrzeuge();
            } catch (err) {
                console.error('Fehler beim Markieren:', err);
                toast.error('Fehler: ' + err.message);
            }
        }

        function createFahrzeugCard(fahrzeug) {
            const serviceTyp = fahrzeug.serviceTyp || 'default';
            const serviceConfig = window.SERVICE_TYPE_CONFIG?.[serviceTyp] || { label: serviceTyp, icon: 'ðŸ“‹' };
            const dringlichkeit = getDringlichkeitLevel(fahrzeug.dringlichkeitsScore || 0);

            // Format deadline
            let deadlineText = '';
            if (fahrzeug.abholtermin || fahrzeug.geplantesAbnahmeDatum) {
                const deadline = fahrzeug.abholtermin || fahrzeug.geplantesAbnahmeDatum;
                const deadlineDate = deadline.toDate ? deadline.toDate() : new Date(deadline);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const daysUntil = Math.ceil((deadlineDate - today) / (1000 * 60 * 60 * 24));

                if (daysUntil <= 0) deadlineText = 'âš ï¸ ÃœberfÃ¤llig';
                else if (daysUntil === 1) deadlineText = 'â° Heute';
                else if (daysUntil === 2) deadlineText = 'ðŸ“… Morgen';
                else deadlineText = `ðŸ“… ${deadlineDate.toLocaleDateString('de-DE')}`;
            }

            // ðŸ†• Anlieferungsart-Badge (2025-12-07)
            const isAbholung = fahrzeug.abholserviceGewuenscht || fahrzeug.fahrzeugAbholung === 'ja';
            const anlieferungsBadge = isAbholung
                ? `<span class="anlieferung-badge abholung" title="Muss abgeholt werden">ðŸš— Abholung</span>`
                : `<span class="anlieferung-badge selbst" title="Kunde bringt Fahrzeug">ðŸ  Selbst</span>`;

            // ðŸ†• Abholdatum/-zeit (nur wenn Abholung)
            let abholInfo = '';
            if (isAbholung) {
                const abholdatum = fahrzeug.abholdatum || fahrzeug.abholtermin;
                const abholzeit = fahrzeug.abholzeit || '';
                if (abholdatum) {
                    const formatAbholDate = (d) => {
                        const date = d?.toDate ? d.toDate() : new Date(d);
                        return date.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
                    };
                    abholInfo = `<span class="abhol-info">ðŸ“… Abholung: ${formatAbholDate(abholdatum)}${abholzeit ? ' ' + abholzeit : ''}</span>`;
                }
            }

            // ðŸ†• Multi-Service Badges - ALLE Services sammeln (inkl. additionalServices)
            let services = fahrzeug.requiredServices ? [...fahrzeug.requiredServices] : [];
            if (services.length === 0) {
                services = Array.isArray(fahrzeug.serviceTyp) ? [...fahrzeug.serviceTyp] : (fahrzeug.serviceTyp ? [fahrzeug.serviceTyp] : []);
            }
            // additionalServices hinzufÃ¼gen
            if (fahrzeug.additionalServices && Array.isArray(fahrzeug.additionalServices)) {
                for (const addService of fahrzeug.additionalServices) {
                    const typ = addService.serviceTyp || addService;
                    if (typ && !services.includes(typ)) {
                        services.push(typ);
                    }
                }
            }
            const serviceStatuses = fahrzeug.serviceStatuses || {};
            const isMultiService = services.length > 1;

            let multiServiceBadges = '';
            if (isMultiService) {
                multiServiceBadges = `<div class="service-badges" style="margin-top:4px;">` +
                    services.map(s => {
                        const status = serviceStatuses[s]?.status || 'offen';
                        const isFertig = status === 'fertig';
                        const label = window.getServiceLabel ? window.getServiceLabel(s) : s;
                        return `<span class="service-badge ${isFertig ? 'fertig' : 'offen'}">${isFertig ? 'âœ…' : 'â³'} ${label}</span>`;
                    }).join('') +
                    `</div>`;
            }

            // ðŸ†• Logistik-Status Badges (2025-12-09)
            let logistikBadgesHtml = '';
            const logistikItems = [];

            if (isAbholung) {
                const abholStatus = fahrzeug.logistikStatus?.abholung || 'ausstehend';
                const abholIcon = abholStatus === 'erledigt' ? 'âœ“' : (abholStatus === 'geplant' ? 'â±' : 'â³');
                logistikItems.push(`<span class="logistik-badge ${abholStatus}">Abholung: ${abholIcon}</span>`);
            }

            if (fahrzeug.ersatzfahrzeugGewuenscht) {
                const leihStatus = fahrzeug.logistikStatus?.leihwagen || 'ausstehend';
                const leihIcon = leihStatus === 'erledigt' ? 'âœ“' : (leihStatus === 'geplant' ? 'â±' : 'â³');
                logistikItems.push(`<span class="logistik-badge ${leihStatus}">Leihwagen: ${leihIcon}</span>`);
            }

            if (logistikItems.length > 0) {
                logistikBadgesHtml = `<div class="logistik-badges">${logistikItems.join('')}</div>`;
            }

            // ðŸ†• Start-Status und Eingetroffen-Button (2025-12-09)
            const kannStarten = fahrzeug.fahrzeugVorOrt === true;
            let startStatusHtml = '';
            let eintretenBtnHtml = '';

            if (kannStarten) {
                startStatusHtml = `<div class="start-status gruen">Kann starten</div>`;
            } else {
                startStatusHtml = `<div class="start-status rot">Wartet auf Fahrzeug</div>`;
                // Eingetroffen-Button nur fuer Selbstanlieferung (nicht fuer Abholung)
                if (!isAbholung) {
                    eintretenBtnHtml = `<button class="eingetroffen-btn" onclick="event.stopPropagation(); markFahrzeugEingetroffen('${fahrzeug.id}')">Fahrzeug eingetroffen</button>`;
                }
            }

            return `
                <div class="fahrzeug-card" draggable="true" data-id="${fahrzeug.id}" data-service="${serviceTyp}"
                     ondragstart="onDragStart(event)">
                    <div class="dringlichkeit ${dringlichkeit}" title="Dringlichkeit: ${dringlichkeit}"></div>
                    <button class="info-btn" onclick="event.stopPropagation(); showDetails('${fahrzeug.id}')" title="Details">i</button>
                    <div class="kennzeichen">${fahrzeug.kennzeichen || 'N/A'}</div>
                    <div class="info">
                        <span class="service-badge service-${serviceTyp}">${serviceConfig.icon || ''} ${serviceConfig.displayName || serviceTyp}</span>
                        ${anlieferungsBadge}
                        ${deadlineText ? `<span>${deadlineText}</span>` : ''}
                        ${abholInfo}
                    </div>
                    ${multiServiceBadges}
                    ${logistikBadgesHtml}
                    ${startStatusHtml}
                    ${eintretenBtnHtml}
                    ${(fahrzeug.servicePlan && Array.isArray(fahrzeug.servicePlan) && fahrzeug.servicePlan.length > 0) || fahrzeug.abteilungsQueue
                        ? `<button class="verschieben-btn" onclick="event.stopPropagation(); openVerschiebenModal(allFahrzeuge.find(f => f.id === '${fahrzeug.id}'))" title="Termine verschieben">
                               ðŸ“… Verschieben
                           </button>`
                        : `<button class="durchplanen-btn" onclick="event.stopPropagation(); openDurchplanenModal(allFahrzeuge.find(f => f.id === '${fahrzeug.id}'))" title="Service-Durchplanung">
                               ðŸ“… Durchplanen
                           </button>`
                    }
                </div>
            `;
        }

        function renderQueues() {
            ALL_QUEUES.forEach(queue => {
                // Build element ID (handle underscore in queue names like leih_bringen)
                const elementId = queue.split('_').map((part, i) =>
                    i === 0 ? capitalizeFirst(part) : part
                ).join('_');

                const container = document.getElementById(`queue${elementId}`);
                const countElement = document.getElementById(`queueCount${elementId}`);
                const items = queuedFahrzeuge[queue] || [];

                if (countElement) {
                    countElement.textContent = items.length;
                }

                if (!container) {
                    console.warn(`Queue container not found: queue${elementId}`);
                    return;
                }

                if (items.length === 0) {
                    container.innerHTML = '<div class="empty-state">Hierher ziehen</div>';
                } else {
                    container.innerHTML = items.map((f, index) => createQueueItem(f, index + 1, queue)).join('');
                }

                // Update KapazitÃ¤tsanzeige
                updateQueueCapacity(queue, elementId);
            });
        }

        // ============================================
        // KAPAZITÃ„TS-MANAGEMENT (Phase 2)
        // ============================================

        function updateQueueCapacity(queue, elementId) {
            const items = queuedFahrzeuge[queue] || [];
            let totalHours = 0;

            items.forEach(f => {
                const hours = window.getEstimatedHours ? window.getEstimatedHours(f, queue) :
                              (f.geschaetzteStunden ||
                               window.SERVICE_DEFAULT_HOURS?.[f.serviceTyp] ||
                               window.SERVICE_DEFAULT_HOURS?.[queue] || 1.0);
                totalHours += hours;
            });

            const capacity = window.QUEUE_DEFAULT_CAPACITY || 8.0;
            const percentage = (totalHours / capacity) * 100;

            // Update Text
            const capacityEl = document.getElementById(`capacity${elementId}`);
            if (capacityEl) {
                capacityEl.textContent = `${totalHours.toFixed(1)}/${capacity}h`;

                // Status-Klassen
                capacityEl.classList.remove('warning', 'danger');
                if (percentage > 100) {
                    capacityEl.classList.add('danger');
                } else if (percentage > 80) {
                    capacityEl.classList.add('warning');
                }
            }

            // Update Progress Bar
            const fillEl = document.getElementById(`capacityFill${elementId}`);
            if (fillEl) {
                fillEl.style.width = Math.min(percentage, 100) + '%';
                fillEl.classList.remove('warning', 'danger');
                if (percentage > 100) {
                    fillEl.classList.add('danger');
                } else if (percentage > 80) {
                    fillEl.classList.add('warning');
                }
            }

            return { totalHours, capacity, percentage };
        }

        function createQueueItem(fahrzeug, position, queueId = null) {
            // PrÃ¼fe ob KVA-Stunden vorhanden (genau) oder nur SchÃ¤tzung
            const kvaHours = window.calculateKvaHours ? window.calculateKvaHours(fahrzeug) : null;
            const hours = kvaHours ||
                          fahrzeug.geschaetzteStunden ||
                          window.SERVICE_DEFAULT_HOURS?.[fahrzeug.serviceTyp] ||
                          window.SERVICE_DEFAULT_HOURS?.[queueId] || 1.0;

            // Badge-Unterscheidung: KVA (grÃ¼n) vs Default (grau)
            const badgeClass = kvaHours ? 'hours-badge kva' : 'hours-badge default';
            const badgeTitle = kvaHours ? 'Klicken fÃ¼r Details (KVA)' : 'Klicken fÃ¼r Details (SchÃ¤tzwert)';

            // ðŸ†• Mini-Icon fÃ¼r Anlieferungsart (2025-12-07)
            const isAbholung = fahrzeug.abholserviceGewuenscht || fahrzeug.fahrzeugAbholung === 'ja';
            const miniIcon = isAbholung ? 'ðŸš—' : 'ðŸ ';

            // ðŸ†• Multi-Service Support - ALLE Services sammeln (inkl. additionalServices)
            let services = fahrzeug.requiredServices ? [...fahrzeug.requiredServices] : [];
            if (services.length === 0) {
                services = Array.isArray(fahrzeug.serviceTyp) ? [...fahrzeug.serviceTyp] : (fahrzeug.serviceTyp ? [fahrzeug.serviceTyp] : []);
            }
            // additionalServices hinzufÃ¼gen
            if (fahrzeug.additionalServices && Array.isArray(fahrzeug.additionalServices)) {
                for (const addService of fahrzeug.additionalServices) {
                    const typ = addService.serviceTyp || addService;
                    if (typ && !services.includes(typ)) {
                        services.push(typ);
                    }
                }
            }
            const serviceStatuses = fahrzeug.serviceStatuses || {};
            const currentQueue = queueId || fahrzeug.abteilungsQueue;
            const isMultiService = services.length > 1;

            // Service-Badges HTML
            let serviceBadgesHtml = '';
            if (isMultiService) {
                serviceBadgesHtml = services.map(s => {
                    const status = serviceStatuses[s]?.status || 'offen';
                    const isFertig = status === 'fertig';
                    const label = window.getServiceLabel ? window.getServiceLabel(s) : s;
                    return `<span class="service-badge ${isFertig ? 'fertig' : 'offen'}">${isFertig ? 'âœ…' : 'â³'} ${label}</span>`;
                }).join('');
            }

            // Fertig-Button nur wenn Service in dieser Queue noch nicht fertig
            const showFinishBtn = services.includes(currentQueue) &&
                                  serviceStatuses[currentQueue]?.status !== 'fertig';
            const finishBtnHtml = showFinishBtn ? `
                <button class="finish-service-btn" onclick="event.stopPropagation(); finishService('${fahrzeug.id}', '${currentQueue}')">
                    âœ… ${window.getServiceLabel ? window.getServiceLabel(currentQueue) : currentQueue} fertig
                </button>
            ` : '';

            return `
                <div class="queue-item" draggable="true" data-id="${fahrzeug.id}"
                     ondragstart="onDragStart(event)">
                    <div style="display:flex; align-items:center; gap:8px; width:100%;">
                        <span class="position">${position}</span>
                        <span class="kennzeichen">${fahrzeug.kennzeichen || 'N/A'} ${miniIcon}</span>
                        <span class="${badgeClass}" title="${badgeTitle}" onclick="event.stopPropagation(); showHoursDetails('${fahrzeug.id}', '${queueId || ''}')">${typeof hours === 'number' ? hours.toFixed(1) : hours}h</span>
                        <button class="info-btn" onclick="event.stopPropagation(); showDetails('${fahrzeug.id}')" title="Details" style="position:static; opacity:1; margin-left:auto;">â„¹ï¸</button>
                        <button class="verschieben-btn-mini" onclick="event.stopPropagation(); openVerschiebenModal(allFahrzeuge.find(f => f.id === '${fahrzeug.id}'))" title="Termine verschieben">ðŸ“…</button>
                        <button class="remove-btn" onclick="removeFromQueue('${fahrzeug.id}')" title="Entfernen">âœ•</button>
                    </div>
                    ${isMultiService ? `<div class="service-badges">${serviceBadgesHtml}</div>` : ''}
                    ${finishBtnHtml}
                </div>
            `;
        }

        // ðŸ”§ FIX (2025-12-11): Null-Check fÃ¼r capitalizeFirst
        function capitalizeFirst(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // ============================================
        // MULTI-SERVICE WORKFLOW (2025-12-09)
        // ============================================

        async function finishService(fahrzeugId, serviceTyp) {
            const fahrzeug = allFahrzeuge.find(f => f.id === fahrzeugId);
            if (!fahrzeug) {
                console.error('Fahrzeug nicht gefunden:', fahrzeugId);
                return;
            }

            try {
                // 1. Service als fertig markieren + Queue-Daten clearen
                const updateData = {
                    [`serviceStatuses.${serviceTyp}.status`]: 'fertig',
                    [`serviceStatuses.${serviceTyp}.fertigstellungsDatum`]: new Date().toISOString(),
                    // Queue-Daten clearen -> Fahrzeug geht zurueck zu Ungeplant
                    abteilungsQueue: null,
                    logistikQueue: null,
                    queuePosition: null,
                    queueDatum: null
                };

                // ðŸ†• Logistik-Status automatisch aktualisieren (2025-12-09)
                // ðŸ”§ BUG FIX (2025-12-09): Feldname auf 'fzAbholen' geÃ¤ndert (war 'abholung')
                // PROBLEM: kanban.html prÃ¼ft 'logistik.fzAbholen', tagesplanung setzte 'logistik.abholung'
                // LÃ–SUNG: Einheitlicher Feldname 'fzAbholen' in beiden Dateien
                // Wenn "abholen" fertig -> Fahrzeug ist vor Ort
                if (serviceTyp === 'abholen') {
                    updateData['logistikStatus.fzAbholen'] = 'erledigt';
                    updateData.fahrzeugVorOrt = true;
                    updateData.fahrzeugEingetroffenAm = new Date().toISOString();
                }
                // Wenn "leih_bringen" fertig -> Leihwagen erledigt
                if (serviceTyp === 'leih_bringen') {
                    updateData['logistikStatus.leihwagen'] = 'erledigt';
                }

                await window.getCollection('fahrzeuge').doc(fahrzeugId).update(updateData);

                // 2. PrÃ¼fe ob ALLE Services fertig sind
                const services = fahrzeug.requiredServices || [fahrzeug.serviceTyp];
                const updatedStatuses = { ...fahrzeug.serviceStatuses };
                updatedStatuses[serviceTyp] = { status: 'fertig' };

                const allFinished = services.every(s =>
                    updatedStatuses[s]?.status === 'fertig'
                );

                if (allFinished) {
                    // Alle fertig â†’ Fahrzeug aus Tagesplanung entfernen (status Ã¤ndern)
                    await window.getCollection('fahrzeuge').doc(fahrzeugId).update({
                        status: 'abholbereit',
                        prozessStatus: 'fertig',
                        allServicesCompletedAt: new Date().toISOString()
                    });
                    toast.success(`ðŸŽ‰ ${fahrzeug.kennzeichen}: Alle Services abgeschlossen!`);
                } else {
                    const remaining = services.filter(s => updatedStatuses[s]?.status !== 'fertig');
                    const remainingLabels = remaining.map(s => window.getServiceLabel ? window.getServiceLabel(s) : s).join(', ');
                    toast.success(`âœ… ${window.getServiceLabel ? window.getServiceLabel(serviceTyp) : serviceTyp} fertig! Noch offen: ${remainingLabels}`);
                }

                // 3. UI aktualisieren
                await loadFahrzeuge();

            } catch (error) {
                console.error('Fehler beim Fertigstellen:', error);
                toast.error(`âŒ Fehler: ${error.message}`);
            }
        }

        // ============================================
        // DRAG & DROP
        // ============================================

        function setupDragAndDrop() {
            const queueContainers = document.querySelectorAll('.queue-items');

            queueContainers.forEach(container => {
                container.addEventListener('dragover', onDragOver);
                container.addEventListener('dragleave', onDragLeave);
                container.addEventListener('drop', onDrop);
            });

            // Also allow dropping back to ungeplant
            const ungeplantList = document.getElementById('ungeplantList');
            ungeplantList.addEventListener('dragover', onDragOver);
            ungeplantList.addEventListener('dragleave', onDragLeave);
            ungeplantList.addEventListener('drop', onDropToUngeplant);
        }

        function onDragStart(event) {
            const id = event.target.dataset.id;
            event.dataTransfer.setData('text/plain', id);
            event.target.classList.add('dragging');
        }

        function onDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }

        function onDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }

        function onDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');

            const fahrzeugId = event.dataTransfer.getData('text/plain');
            const targetQueue = event.currentTarget.dataset.queue;

            if (!fahrzeugId || !targetQueue) return;

            moveToQueue(fahrzeugId, targetQueue);
        }

        function onDropToUngeplant(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');

            const fahrzeugId = event.dataTransfer.getData('text/plain');
            if (!fahrzeugId) return;

            removeFromQueue(fahrzeugId);
        }

        // ============================================
        // QUEUE MANAGEMENT
        // ============================================

        // LOGISTIK_QUEUES ist oben definiert (bei den Durchplanung-Konstanten)

        function moveToQueue(fahrzeugId, targetQueue) {
            // Find vehicle
            let fahrzeug = ungeplanteFahrzeuge.find(f => f.id === fahrzeugId);
            let sourceQueue = null;

            // Check if already in a queue
            if (!fahrzeug) {
                ALL_QUEUES.forEach(queue => {
                    const found = queuedFahrzeuge[queue]?.find(f => f.id === fahrzeugId);
                    if (found) {
                        fahrzeug = found;
                        sourceQueue = queue;
                    }
                });
            }

            if (!fahrzeug) {
                console.error('Fahrzeug nicht gefunden:', fahrzeugId);
                return;
            }

            // ============================================
            // ABHÃ„NGIGKEITS-CHECK (Phase 2)
            // ============================================
            if (window.canMoveToQueue) {
                const check = window.canMoveToQueue(fahrzeug, targetQueue);
                if (!check.allowed) {
                    if (window.toast && typeof window.toast.warning === 'function') {
                        window.toast.warning(check.reason);
                    } else {
                        alert(check.reason);
                    }
                    console.warn(`âš ï¸ AbhÃ¤ngigkeit nicht erfÃ¼llt: ${check.reason}`);
                    return;
                }
            }

            // Remove from source
            if (sourceQueue) {
                queuedFahrzeuge[sourceQueue] = queuedFahrzeuge[sourceQueue].filter(f => f.id !== fahrzeugId);
            } else {
                ungeplanteFahrzeuge = ungeplanteFahrzeuge.filter(f => f.id !== fahrzeugId);
            }

            // Clear old queue assignments
            delete fahrzeug.abteilungsQueue;
            delete fahrzeug.logistikQueue;

            // Add to target queue (distinguish between Logistik and Service)
            if (LOGISTIK_QUEUES.includes(targetQueue)) {
                fahrzeug.logistikQueue = targetQueue;
            } else {
                fahrzeug.abteilungsQueue = targetQueue;
            }
            fahrzeug.queuePosition = (queuedFahrzeuge[targetQueue]?.length || 0) + 1;
            queuedFahrzeuge[targetQueue].push(fahrzeug);

            hasUnsavedChanges = true;
            renderAll();
            updateStats();
            updateCapacityBar();  // ðŸ”§ 2025-12-07: KapazitÃ¤ts-Anzeige aktualisieren

            const queueType = LOGISTIK_QUEUES.includes(targetQueue) ? 'ðŸšš' : 'ðŸ”§';
            console.log(`${queueType} ${fahrzeug.kennzeichen} â†’ ${targetQueue} (Position ${fahrzeug.queuePosition})`);

            // ðŸ—ºï¸ 2025-12-09: Fahrzeit berechnen wenn in Logistik-Queue verschoben
            if (LOGISTIK_QUEUES.includes(targetQueue) && !fahrzeug.logistikDetails?.travelTimeRoundTrip) {
                calculateTravelTimeForFahrzeug(fahrzeug);  // Async im Hintergrund
            }
        }

        function removeFromQueue(fahrzeugId) {
            let fahrzeug = null;

            ALL_QUEUES.forEach(queue => {
                const found = queuedFahrzeuge[queue]?.find(f => f.id === fahrzeugId);
                if (found) {
                    fahrzeug = found;
                    queuedFahrzeuge[queue] = queuedFahrzeuge[queue].filter(f => f.id !== fahrzeugId);
                }
            });

            if (fahrzeug) {
                delete fahrzeug.abteilungsQueue;
                delete fahrzeug.logistikQueue;
                delete fahrzeug.queuePosition;
                ungeplanteFahrzeuge.push(fahrzeug);

                hasUnsavedChanges = true;
                sortUngeplant();
                renderAll();
                updateStats();
                updateCapacityBar();  // ðŸ”§ 2025-12-07: KapazitÃ¤ts-Anzeige aktualisieren

                console.log(`â†©ï¸ ${fahrzeug.kennzeichen} zurÃ¼ck zu Ungeplant`);
            }
        }

        // ============================================
        // SORTING
        // ============================================

        function sortUngeplant() {
            const sortBy = document.getElementById('sortSelect').value;

            ungeplanteFahrzeuge.sort((a, b) => {
                switch (sortBy) {
                    case 'dringlichkeit':
                        return (b.dringlichkeitsScore || 0) - (a.dringlichkeitsScore || 0);

                    case 'datum':
                        const dateA = a.createdAt || a.erstelltAm || 0;
                        const dateB = b.createdAt || b.erstelltAm || 0;
                        return (typeof dateB === 'number' ? dateB : 0) - (typeof dateA === 'number' ? dateA : 0);

                    case 'termin':
                        const deadlineA = a.abholtermin || a.geplantesAbnahmeDatum || null;
                        const deadlineB = b.abholtermin || b.geplantesAbnahmeDatum || null;
                        if (!deadlineA && !deadlineB) return 0;
                        if (!deadlineA) return 1;
                        if (!deadlineB) return -1;
                        const dateObjA = deadlineA.toDate ? deadlineA.toDate() : new Date(deadlineA);
                        const dateObjB = deadlineB.toDate ? deadlineB.toDate() : new Date(deadlineB);
                        return dateObjA - dateObjB;

                    default:
                        return 0;
                }
            });

            renderUngeplant();
        }

        // ============================================
        // SAVE
        // ============================================

        async function saveTagesplan() {
            if (!hasUnsavedChanges) {
                if (window.toast) {
                    window.toast.info('Keine Ã„nderungen zum Speichern.');
                } else {
                    alert('Keine Ã„nderungen zum Speichern.');
                }
                return;
            }

            // ðŸ”§ 2025-12-07: Phase 1.3 - Ãœberbukungs-Warnung (Confirm-Dialog, keine Sperre!)
            const overbookingCheck = checkOverbookingWarning();
            if (overbookingCheck.isOverbooked) {
                const userConfirmed = confirm(overbookingCheck.message);
                if (!userConfirmed) {
                    console.log('âš ï¸ Speichern abgebrochen wegen Ãœberbuchung');
                    return;
                }
                console.log('âœ… Benutzer hat Ãœberbuchung akzeptiert');
            }

            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<span>â³</span> Speichert...';

            try {
                // ðŸ”§ FIX (2025-12-10): window.db statt firebase.firestore()
                const db = window.db;
                const batch = db.batch();
                // FIX: getCollectionName gibt String zurÃ¼ck, getCollection gibt CollectionReference!
            const collectionName = window.getCollectionName ? window.getCollectionName('fahrzeuge') : `fahrzeuge_${window.werkstattId}`;
                const dateStr = document.getElementById('datePicker').value;
                const queueDate = new Date(dateStr);

                // Update queued vehicles (both Logistik and Service)
                ALL_QUEUES.forEach(queue => {
                    const isLogistik = LOGISTIK_QUEUES.includes(queue);
                    (queuedFahrzeuge[queue] || []).forEach((f, index) => {
                        const ref = db.collection(collectionName).doc(f.id);
                        const updateData = {
                            queuePosition: index + 1,
                            queueDatum: firebase.firestore.Timestamp.fromDate(queueDate),
                            prioritaet: index + 1
                        };

                        // Set correct queue field based on type
                        if (isLogistik) {
                            updateData.logistikQueue = queue;
                            updateData.abteilungsQueue = firebase.firestore.FieldValue.delete();

                            // ðŸ†• Logistik-Status automatisch auf 'geplant' setzen (2025-12-09)
                            // ðŸ”§ BUG FIX (2025-12-09): Feldname auf 'fzAbholen' geÃ¤ndert (war 'abholung')
                            if (queue === 'abholen') {
                                updateData['logistikStatus.fzAbholen'] = 'geplant';
                            }
                            if (queue === 'leih_bringen') {
                                updateData['logistikStatus.leihwagen'] = 'geplant';
                            }
                        } else {
                            updateData.abteilungsQueue = queue;
                            updateData.logistikQueue = firebase.firestore.FieldValue.delete();
                        }

                        batch.update(ref, updateData);
                    });
                });

                // Clear queue data for vehicles returned to ungeplant
                ungeplanteFahrzeuge.forEach(f => {
                    if (f.abteilungsQueue !== undefined || f.logistikQueue !== undefined) {
                        const ref = db.collection(collectionName).doc(f.id);
                        batch.update(ref, {
                            abteilungsQueue: firebase.firestore.FieldValue.delete(),
                            logistikQueue: firebase.firestore.FieldValue.delete(),
                            queuePosition: firebase.firestore.FieldValue.delete(),
                            queueDatum: firebase.firestore.FieldValue.delete(),
                            prioritaet: firebase.firestore.FieldValue.delete()
                        });
                    }
                });

                await batch.commit();

                hasUnsavedChanges = false;

                if (window.toast) {
                    window.toast.success('Tagesplan gespeichert!');
                } else {
                    alert('Tagesplan gespeichert!');
                }

                console.log('âœ… Tagesplan gespeichert');

            } catch (error) {
                console.error('âŒ Fehler beim Speichern:', error);
                if (window.toast) {
                    window.toast.error('Fehler beim Speichern: ' + error.message);
                } else {
                    alert('Fehler beim Speichern: ' + error.message);
                }
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>ðŸ’¾</span> Speichern';
            }
        }

        // ============================================
        // ðŸ”§ 2025-12-07: KAPAZITÃ„T FUNCTIONS
        // ============================================

        async function loadKapazitaetSettings() {
            try {
                console.log('ðŸ“Š Lade KapazitÃ¤tswerte aus Firestore...');
                // FIX: Multi-Tenant Pattern verwenden statt globaler 'settings' Collection
                const settingsRef = window.getCollection('einstellungen').doc('config');
                const doc = await settingsRef.get();

                if (doc.exists) {
                    const data = doc.data();
                    if (data.kapazitaet) {
                        kapazitaetSettings = data.kapazitaet;
                        console.log('âœ… KapazitÃ¤tswerte geladen:', kapazitaetSettings);
                    } else {
                        console.log('âš ï¸ Keine KapazitÃ¤tswerte in config gefunden, verwende Defaults');
                    }
                } else {
                    console.log('âš ï¸ Config-Dokument nicht gefunden, verwende Defaults');
                }
            } catch (error) {
                console.warn('âš ï¸ KapazitÃ¤t konnte nicht geladen werden, verwende Defaults:', error.message);
            }
        }

        function updateCapacityBar() {
            const capacityItemsEl = document.getElementById('capacityItems');
            const capacityDateEl = document.getElementById('capacityDate');

            if (!capacityItemsEl) return;

            // Datum formatieren
            const selectedDateStr = document.getElementById('datePicker')?.value;
            const today = new Date().toISOString().split('T')[0];

            if (selectedDateStr === today) {
                capacityDateEl.textContent = 'heute';
            } else {
                const d = new Date(selectedDateStr);
                capacityDateEl.textContent = d.toLocaleDateString('de-DE', { weekday: 'long', day: 'numeric', month: 'long' });
            }

            // HTML fÃ¼r KapazitÃ¤ts-Items generieren
            let html = '';
            let overbookedServices = [];

            Object.entries(SERVICE_KAPAZITAET_CONFIG).forEach(([serviceKey, config]) => {
                // ZÃ¤hle Fahrzeuge in den zugehÃ¶rigen Queues
                let count = 0;
                config.queues.forEach(queue => {
                    if (queuedFahrzeuge[queue]) {
                        count += queuedFahrzeuge[queue].length;
                    }
                });

                // Maximale KapazitÃ¤t
                const maxCapacity = kapazitaetSettings[serviceKey] || 10;
                const percent = Math.round((count / maxCapacity) * 100);

                // Status-Klasse bestimmen: grÃ¼n <80%, gelb 80-100%, rot >100%
                let statusClass = 'status-green';
                if (percent >= 100) {
                    statusClass = 'status-red';
                    overbookedServices.push(config.label);
                } else if (percent >= 80) {
                    statusClass = 'status-yellow';
                }

                html += `
                    <div class="capacity-item ${statusClass}" title="${config.label}: ${count}/${maxCapacity} (${percent}%)">
                        <span class="service-icon">${config.icon}</span>
                        <span>${config.label}:</span>
                        <span class="usage">${count}/${maxCapacity}</span>
                        <span class="capacity-percent">(${percent}%)</span>
                    </div>
                `;
            });

            capacityItemsEl.innerHTML = html;

            // Warnung bei Ãœberbuchung speichern (fÃ¼r Phase 1.3)
            window._overbookedServices = overbookedServices;

            console.log('ðŸ“Š KapazitÃ¤ts-Bar aktualisiert');
        }

        // PrÃ¼ft auf Ãœberbuchung und zeigt Warnung (fÃ¼r Phase 1.3)
        function checkOverbookingWarning() {
            if (window._overbookedServices && window._overbookedServices.length > 0) {
                const services = window._overbookedServices.join(', ');
                return {
                    isOverbooked: true,
                    message: `Achtung! Folgende Services sind Ã¼berbucht: ${services}. Trotzdem speichern?`
                };
            }
            return { isOverbooked: false };
        }

        // ============================================
        // STATS
        // ============================================

        function updateStats() {
            let totalGeplant = 0;
            Object.values(queuedFahrzeuge).forEach(queue => {
                totalGeplant += queue.length;
            });

            document.getElementById('statUngeplant').textContent = ungeplanteFahrzeuge.length;
            document.getElementById('statGeplant').textContent = totalGeplant;

            // Calculate heute fÃ¤llig and Ã¼berfÃ¤llig
            let heuteFaellig = 0;
            let ueberfaellig = 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            allFahrzeuge.forEach(f => {
                const deadline = f.abholtermin || f.geplantesAbnahmeDatum;
                if (deadline) {
                    const deadlineDate = deadline.toDate ? deadline.toDate() : new Date(deadline);
                    deadlineDate.setHours(0, 0, 0, 0);
                    const diff = deadlineDate - today;

                    if (diff < 0) ueberfaellig++;
                    else if (diff === 0) heuteFaellig++;
                }
            });

            document.getElementById('statHeuteFaellig').textContent = heuteFaellig;
            document.getElementById('statUeberfaellig').textContent = ueberfaellig;
        }

        // ============================================
        // DATE CHANGE
        // ============================================

        function onDateChange() {
            if (hasUnsavedChanges) {
                if (!confirm('Ungespeicherte Ã„nderungen gehen verloren. Fortfahren?')) {
                    document.getElementById('datePicker').value = selectedDate.toISOString().split('T')[0];
                    return;
                }
            }

            hasUnsavedChanges = false;
            selectedDate = new Date(document.getElementById('datePicker').value);
            categorizeVehicles();
            renderAll();
            updateStats();
            updateCapacityBar(); // ðŸ”§ FIX 30 (2025-12-09): KapazitÃ¤t beim Datumswechsel aktualisieren
        }

        // ============================================================
        // ERWEITERTES DETAIL-POPUP (2025-12-07)
        // Alle Infos fÃ¼r Werkstattleiter-Priorisierung
        // ============================================================

        // Globale Variable fÃ¼r Lightbox-Navigation
        let currentLightboxPhotos = [];
        let currentLightboxIndex = 0;

        async function showDetails(fahrzeugId) {
            const fahrzeug = allFahrzeuge.find(f => f.id === fahrzeugId);
            if (!fahrzeug) return;

            // ðŸ†• FIX 17 (2025-12-07): Track-Variable fÃ¼r erfolgreichen Anfrage-Daten Load
            let anfrageDataLoaded = false;

            // ðŸ†• FIX 10 (2025-12-07): Anfrage-Daten nachladen fuer alte Fahrzeuge
            // Problem: Fahrzeuge die VOR den Fixes erstellt wurden haben keine Daten!
            // Die Daten existieren nur in der anfragen Collection

            // ðŸ†• FIX 14 (2025-12-07): Erweiterte needsAnfrageData Bedingung
            // Die alte Bedingung war zu restriktiv - pruefte nur ob kalkulationData existiert
            // aber nicht ob es echte Daten (Arbeitslohn, Ersatzteile, PDFs) enthaelt
            const hasKalkulation = fahrzeug.kalkulationData?.arbeitslohn?.length > 0
                                || fahrzeug.kalkulation?.positionen?.length > 0;
            const hasErsatzteile = fahrzeug.kalkulation?.ersatzteile?.length > 0;
            const hasPDFs = fahrzeug.pdfUrl || fahrzeug.angebotPdfUrl || fahrzeug.entwurfPdfUrl;

            // Brauchen Anfrage-Daten wenn EINES der wichtigen Felder fehlt
            const needsAnfrageData = !hasKalkulation || !hasErsatzteile || !hasPDFs;
            console.log(`ðŸ” [FIX 14] hasKalkulation: ${hasKalkulation}, hasErsatzteile: ${hasErsatzteile}, hasPDFs: ${hasPDFs} â†’ needsAnfrageData: ${needsAnfrageData}`);
            const anfrageId = fahrzeug.anfrage_id || fahrzeug.anfrageId || fahrzeug.originalAnfrageId;

            if (needsAnfrageData && anfrageId) {
                console.log(`ðŸ”„ [FIX 10/19] Lade Anfrage-Daten nach fuer Fahrzeug ${fahrzeugId}, Anfrage: ${anfrageId}`);
                try {
                    // ðŸ†• FIX 19 (2025-12-07): ZUERST in partnerAnfragen suchen!
                    // Partner-Anfragen vom Partner-Portal sind in partnerAnfragen_mosbach gespeichert
                    // NICHT in anfragen_mosbach (das sind Werkstatt-interne Anfragen)
                    let anfrageSnap = await window.getCollection('partnerAnfragen').doc(String(anfrageId)).get();
                    console.log(`ðŸ” [FIX 19] Suche in partnerAnfragen_mosbach: ${anfrageSnap.exists ? 'GEFUNDEN' : 'nicht gefunden'}`);

                    // FALLBACK 1: Werkstatt-Anfragen (Multi-Tenant)
                    if (!anfrageSnap.exists) {
                        console.log(`ðŸ”„ [FIX 19] Fallback 1: Versuche anfragen Collection`);
                        anfrageSnap = await window.getCollection('anfragen').doc(String(anfrageId)).get();
                    }

                    // FALLBACK 2: Globale partnerAnfragen (alte Migration)
                    if (!anfrageSnap.exists) {
                        console.log(`ðŸ”„ [FIX 19] Fallback 2: Versuche globale partnerAnfragen Collection`);
                        anfrageSnap = await window.db.collection('partnerAnfragen').doc(String(anfrageId)).get();
                    }

                    // FALLBACK 3: Globale anfragen (alte Migration)
                    if (!anfrageSnap.exists) {
                        console.log(`ðŸ”„ [FIX 19] Fallback 3: Versuche globale anfragen Collection`);
                        anfrageSnap = await window.db.collection('anfragen').doc(String(anfrageId)).get();
                    }

                    if (anfrageSnap.exists) {
                        const anfrage = anfrageSnap.data();
                        console.log('âœ… [FIX 10/19] Anfrage-Daten gefunden:', Object.keys(anfrage));

                        // Merge fehlende Felder aus Anfrage
                        fahrzeug.kalkulation = fahrzeug.kalkulation || anfrage.kalkulation;

                        // ðŸ†• FIX 21 (2025-12-07): Deep-Merge fÃ¼r kalkulationData
                        // Problem: fahrzeug.kalkulationData existiert (mit Materialien), aber OHNE arbeitslohn!
                        // Der OR-Operator macht KEIN Deep-Merge - wir mÃ¼ssen einzelne Felder mergen
                        if (anfrage.kalkulationData) {
                            fahrzeug.kalkulationData = fahrzeug.kalkulationData || {};

                            // Arbeitslohn: Merge wenn im Fahrzeug leer/fehlend, aber in Anfrage vorhanden
                            if ((!fahrzeug.kalkulationData.arbeitslohn || fahrzeug.kalkulationData.arbeitslohn.length === 0)
                                && anfrage.kalkulationData.arbeitslohn?.length > 0) {
                                fahrzeug.kalkulationData.arbeitslohn = anfrage.kalkulationData.arbeitslohn;
                                console.log('ðŸ†• [FIX 21] arbeitslohn aus Anfrage gemergt:', anfrage.kalkulationData.arbeitslohn.length, 'Positionen');
                            }

                            // Ersatzfahrzeug: Merge wenn im Fahrzeug fehlend
                            if (!fahrzeug.kalkulationData.ersatzfahrzeug && anfrage.kalkulationData.ersatzfahrzeug) {
                                fahrzeug.kalkulationData.ersatzfahrzeug = anfrage.kalkulationData.ersatzfahrzeug;
                                console.log('ðŸ†• [FIX 21] ersatzfahrzeug aus Anfrage gemergt');
                            }

                            // Gesamtpreis: Merge wenn im Fahrzeug fehlend/null
                            if (!fahrzeug.kalkulationData.gesamtpreis && anfrage.kalkulationData.gesamtpreis) {
                                fahrzeug.kalkulationData.gesamtpreis = anfrage.kalkulationData.gesamtpreis;
                            }

                            // gewaehlteVariante: Merge wenn im Fahrzeug fehlend
                            if (!fahrzeug.kalkulationData.gewaehlteVariante && anfrage.kalkulationData.gewaehlteVariante) {
                                fahrzeug.kalkulationData.gewaehlteVariante = anfrage.kalkulationData.gewaehlteVariante;
                            }
                        }

                        fahrzeug.ersatzteile = fahrzeug.ersatzteile || anfrage.ersatzteile;
                        fahrzeug.pdfUrl = fahrzeug.pdfUrl || anfrage.pdfUrl;
                        fahrzeug.angebotPdfUrl = fahrzeug.angebotPdfUrl || anfrage.angebotPdfUrl;
                        fahrzeug.entwurfPdfUrl = fahrzeug.entwurfPdfUrl || anfrage.entwurfPdfUrl;
                        fahrzeug.gewaehlteVariante = fahrzeug.gewaehlteVariante || anfrage.gewaehlteVariante;
                        // ðŸ†• FIX 22B (2025-12-07): abholDatum/abholZeit mergen (BEIDE Schreibweisen!)
                        // Problem: Partner-Anfragen haben lowercase (abholdatum), Display-Code prÃ¼ft beides
                        fahrzeug.abholDatum = fahrzeug.abholDatum || anfrage.abholDatum || anfrage.abholdatum;
                        fahrzeug.abholZeit = fahrzeug.abholZeit || anfrage.abholZeit || anfrage.abholzeit;
                        // Auch lowercase-Varianten setzen fÃ¼r Display-Code KompatibilitÃ¤t
                        fahrzeug.abholdatum = fahrzeug.abholdatum || anfrage.abholdatum || anfrage.abholDatum;
                        fahrzeug.abholzeit = fahrzeug.abholzeit || anfrage.abholzeit || anfrage.abholZeit;
                        // Auch geplantesAbnahmeDatum mergen (Screenshot zeigt dass dieses Feld existiert!)
                        fahrzeug.geplantesAbnahmeDatum = fahrzeug.geplantesAbnahmeDatum || anfrage.geplantesAbnahmeDatum;
                        // ðŸ†• FIX 23: Debug-Log fÃ¼r Abholtermin-Merge
                        console.log('ðŸ†• [FIX 22B/23] Abholtermin gemergt:', {
                            'fahrzeug.abholdatum': fahrzeug.abholdatum,
                            'fahrzeug.abholDatum': fahrzeug.abholDatum,
                            'fahrzeug.geplantesAbnahmeDatum': fahrzeug.geplantesAbnahmeDatum,
                            'anfrage.abholdatum': anfrage.abholdatum,
                            'anfrage.geplantesAbnahmeDatum': anfrage.geplantesAbnahmeDatum
                        });
                        fahrzeug.farbe = fahrzeug.farbe || anfrage.farbname || anfrage.farbe;
                        fahrzeug.farbcode = fahrzeug.farbcode || anfrage.farbnummer || anfrage.farbcode;
                        fahrzeug.kilometerstand = fahrzeug.kilometerstand || anfrage.kilometerstand || anfrage.kmstand;

                        // Auch kva-Daten mergen falls vorhanden
                        if (anfrage.kva && !fahrzeug.kva) {
                            fahrzeug.kva = anfrage.kva;
                        }

                        // ðŸ†• FIX 17: Track erfolgreichen Load
                        anfrageDataLoaded = true;
                    } else {
                        console.warn(`âš ï¸ [FIX 10/19] Anfrage ${anfrageId} nicht gefunden in allen 4 Collections`);
                    }
                } catch (e) {
                    console.warn('âš ï¸ [FIX 10/19] Anfrage-Daten konnten nicht nachgeladen werden:', e.message);
                }
            }

            // ðŸ†• FIX 10B/17/18/19 (2025-12-07): Alternative Anfrage via Kennzeichen-Suche
            // FIX 17: LÃ¤uft jetzt AUCH wenn FIX 10 fehlgeschlagen ist
            // FIX 18: Query OHNE orderBy (kein Composite Index nÃ¶tig!) - sortiere in JavaScript
            // FIX 19: Suche ZUERST in partnerAnfragen (Partner-Portal Anfragen)!
            if (needsAnfrageData && !anfrageDataLoaded && fahrzeug.kennzeichen) {
                console.log(`ðŸ” [FIX 10B/19] Fallback: Versuche Anfrage via Kennzeichen zu finden: ${fahrzeug.kennzeichen}`);
                try {
                    // ðŸ†• FIX 19: ZUERST in partnerAnfragen suchen! (Partner-Portal Anfragen)
                    let kennzeichenQuery = await window.getCollection('partnerAnfragen')
                        .where('kennzeichen', '==', fahrzeug.kennzeichen)
                        .get();
                    console.log(`ðŸ” [FIX 19] Kennzeichen-Suche in partnerAnfragen_mosbach: ${kennzeichenQuery.empty ? '0' : kennzeichenQuery.docs.length} Treffer`);

                    // FALLBACK 1: Werkstatt-Anfragen (Multi-Tenant)
                    if (kennzeichenQuery.empty) {
                        console.log(`ðŸ”„ [FIX 19] Fallback 1: Versuche anfragen Collection`);
                        kennzeichenQuery = await window.getCollection('anfragen')
                            .where('kennzeichen', '==', fahrzeug.kennzeichen)
                            .get();
                    }

                    // FALLBACK 2: Globale partnerAnfragen (alte Migration)
                    if (kennzeichenQuery.empty) {
                        console.log(`ðŸ”„ [FIX 19] Fallback 2: Versuche globale partnerAnfragen Collection`);
                        kennzeichenQuery = await window.db.collection('partnerAnfragen')
                            .where('kennzeichen', '==', fahrzeug.kennzeichen)
                            .get();
                    }

                    // FALLBACK 3: Globale anfragen (alte Migration)
                    if (kennzeichenQuery.empty) {
                        console.log(`ðŸ”„ [FIX 19] Fallback 3: Versuche globale anfragen Collection`);
                        kennzeichenQuery = await window.db.collection('anfragen')
                            .where('kennzeichen', '==', fahrzeug.kennzeichen)
                            .get();
                    }

                    if (!kennzeichenQuery.empty) {
                        // ðŸ†• FIX 18: In JavaScript sortieren (neueste zuerst)
                        const sortedDocs = kennzeichenQuery.docs.sort((a, b) => {
                            const aTime = a.data().createdAt?.toMillis?.() || a.data().createdAt || 0;
                            const bTime = b.data().createdAt?.toMillis?.() || b.data().createdAt || 0;
                            return bTime - aTime;  // Descending (neueste zuerst)
                        });
                        const anfrage = sortedDocs[0].data();
                        console.log('âœ… [FIX 10B/19] Anfrage via Kennzeichen gefunden:', sortedDocs[0].id, Object.keys(anfrage));

                        // Merge fehlende Felder aus Anfrage
                        fahrzeug.kalkulation = fahrzeug.kalkulation || anfrage.kalkulation;

                        // ðŸ†• FIX 21 (2025-12-07): Deep-Merge fÃ¼r kalkulationData
                        // Problem: fahrzeug.kalkulationData existiert (mit Materialien), aber OHNE arbeitslohn!
                        // Der OR-Operator macht KEIN Deep-Merge - wir mÃ¼ssen einzelne Felder mergen
                        if (anfrage.kalkulationData) {
                            fahrzeug.kalkulationData = fahrzeug.kalkulationData || {};

                            // Arbeitslohn: Merge wenn im Fahrzeug leer/fehlend, aber in Anfrage vorhanden
                            if ((!fahrzeug.kalkulationData.arbeitslohn || fahrzeug.kalkulationData.arbeitslohn.length === 0)
                                && anfrage.kalkulationData.arbeitslohn?.length > 0) {
                                fahrzeug.kalkulationData.arbeitslohn = anfrage.kalkulationData.arbeitslohn;
                                console.log('ðŸ†• [FIX 21] arbeitslohn aus Anfrage gemergt:', anfrage.kalkulationData.arbeitslohn.length, 'Positionen');
                            }

                            // Ersatzfahrzeug: Merge wenn im Fahrzeug fehlend
                            if (!fahrzeug.kalkulationData.ersatzfahrzeug && anfrage.kalkulationData.ersatzfahrzeug) {
                                fahrzeug.kalkulationData.ersatzfahrzeug = anfrage.kalkulationData.ersatzfahrzeug;
                                console.log('ðŸ†• [FIX 21] ersatzfahrzeug aus Anfrage gemergt');
                            }

                            // Gesamtpreis: Merge wenn im Fahrzeug fehlend/null
                            if (!fahrzeug.kalkulationData.gesamtpreis && anfrage.kalkulationData.gesamtpreis) {
                                fahrzeug.kalkulationData.gesamtpreis = anfrage.kalkulationData.gesamtpreis;
                            }

                            // gewaehlteVariante: Merge wenn im Fahrzeug fehlend
                            if (!fahrzeug.kalkulationData.gewaehlteVariante && anfrage.kalkulationData.gewaehlteVariante) {
                                fahrzeug.kalkulationData.gewaehlteVariante = anfrage.kalkulationData.gewaehlteVariante;
                            }
                        }

                        fahrzeug.ersatzteile = fahrzeug.ersatzteile || anfrage.ersatzteile;
                        fahrzeug.pdfUrl = fahrzeug.pdfUrl || anfrage.pdfUrl;
                        fahrzeug.angebotPdfUrl = fahrzeug.angebotPdfUrl || anfrage.angebotPdfUrl;
                        fahrzeug.entwurfPdfUrl = fahrzeug.entwurfPdfUrl || anfrage.entwurfPdfUrl;
                        fahrzeug.gewaehlteVariante = fahrzeug.gewaehlteVariante || anfrage.gewaehlteVariante;
                        fahrzeug.abholDatum = fahrzeug.abholDatum || anfrage.abholDatum;
                        fahrzeug.abholZeit = fahrzeug.abholZeit || anfrage.abholZeit;
                        fahrzeug.farbe = fahrzeug.farbe || anfrage.farbname || anfrage.farbe;
                        fahrzeug.farbcode = fahrzeug.farbcode || anfrage.farbnummer || anfrage.farbcode;
                        fahrzeug.kilometerstand = fahrzeug.kilometerstand || anfrage.kilometerstand || anfrage.kmstand;

                        if (anfrage.kva && !fahrzeug.kva) {
                            fahrzeug.kva = anfrage.kva;
                        }

                        // Track erfolgreichen Load
                        anfrageDataLoaded = true;
                    } else {
                        console.warn(`âš ï¸ [FIX 10B/19] Keine Anfrage mit Kennzeichen ${fahrzeug.kennzeichen} gefunden in allen 4 Collections`);
                    }
                } catch (e) {
                    console.warn('âš ï¸ [FIX 10B/19] Kennzeichen-Suche fehlgeschlagen:', e.message);
                }
            }

            const serviceConfig = window.SERVICE_TYPE_CONFIG?.[fahrzeug.serviceTyp] || {};

            // Modal-Titel setzen
            document.getElementById('modalTitle').textContent =
                `${fahrzeug.kennzeichen || 'Fahrzeug'} - ${serviceConfig.label || fahrzeug.serviceTyp}`;

            // TAB 1: AUFTRAGSINFORMATIONEN
            const auftragHtml = generateAuftragTab(fahrzeug, serviceConfig);
            document.getElementById('tab-auftrag').innerHTML = auftragHtml;

            // TAB 2: FOTOS
            const fotosResult = generateFotosTab(fahrzeug);
            document.getElementById('tab-fotos').innerHTML = fotosResult.html;
            document.getElementById('fotoCount').textContent = fotosResult.count;

            // TAB 3: KALKULATION
            const kalkulationHtml = generateKalkulationTab(fahrzeug);
            document.getElementById('tab-kalkulation').innerHTML = kalkulationHtml;

            // TAB 4: ERSATZTEILE (async wegen Bestellungen-Query)
            const teileResult = await generateTeileTab(fahrzeug);
            document.getElementById('tab-teile').innerHTML = teileResult.html;
            document.getElementById('teileCount').textContent = teileResult.count;

            // TAB 5: PDFs
            const pdfsResult = generatePDFsTab(fahrzeug);
            document.getElementById('tab-pdfs').innerHTML = pdfsResult.html;
            document.getElementById('pdfCount').textContent = pdfsResult.count;

            // Reset auf ersten Tab
            switchDetailTab('auftrag');

            // Modal anzeigen
            document.getElementById('detailModal').classList.add('active');
        }

        // ============================================================
        // TAB-GENERIERUNG FUNKTIONEN
        // ============================================================

        function generateAuftragTab(fahrzeug, serviceConfig) {
            const formatDate = (dateVal) => {
                if (!dateVal) return 'N/A';
                try {
                    if (dateVal.toDate) dateVal = dateVal.toDate();
                    if (dateVal instanceof Date) {
                        return dateVal.toLocaleDateString('de-DE', {
                            day: '2-digit', month: '2-digit', year: 'numeric',
                            hour: '2-digit', minute: '2-digit'
                        });
                    }
                    return dateVal;
                } catch (e) { return 'N/A'; }
            };

            // ðŸ†• FIX 5 (2025-12-07): Erweiterte Feldname-Aliase fuer Farbe
            // Firebase speichert in: serviceDetails.farbname, serviceDetailsPerService.lackier.farbname
            const farbname = fahrzeug.farbe
                          || fahrzeug.serviceDetails?.farbname
                          || fahrzeug.serviceDetailsPerService?.lackier?.farbname
                          || '';
            const farbnummer = fahrzeug.farbcode
                            || fahrzeug.serviceDetails?.farbnummer
                            || fahrzeug.serviceDetailsPerService?.lackier?.farbnummer
                            || '';
            const farbeDisplay = farbname
                ? (farbnummer ? `${farbname} (${farbnummer})` : farbname)
                : (farbnummer || 'N/A');

            // ðŸ†• FIX 5 (2025-12-07): Erweiterte KM-Erkennung (kmstand vs kilometerstand)
            const kmRaw = fahrzeug.kilometerstand || fahrzeug.kmstand;
            const kilometerstandDisplay = kmRaw
                ? (typeof kmRaw === 'number' ? kmRaw.toLocaleString('de-DE') + ' km' : kmRaw + ' km')
                : 'N/A';

            // ðŸ†• FIX 6 (2025-12-07): Erweiterte Abholservice-Erkennung
            const abholserviceGewuenscht = fahrzeug.abholserviceGewuenscht
                                        || fahrzeug.fahrzeugAbholen
                                        || fahrzeug.abholservice
                                        || false;

            // ðŸ†• FIX 24/25 (2025-12-09): Auftragsstart berechnen aus Ende minus Leihdauer
            // Problem: "Abholtermin" und "Geplante Abnahme" zeigten beide das ENDE-Datum!
            // LÃ¶sung: Auftragsstart = Ende - Leihdauer (wenn kein explizites abholdatum gesetzt)
            // FIX 25: Firebase Timestamp richtig konvertieren (war RangeError: Invalid time value)
            let auftragsstart = fahrzeug.abholdatum || fahrzeug.abholDatum || fahrzeug.abholtermin || fahrzeug.anliefertermin || fahrzeug.gewuenschterTermin;
            if (!auftragsstart && fahrzeug.geplantesAbnahmeDatum) {
                // Berechne Start aus Ende minus Leihdauer
                const leihdauer = fahrzeug.kva?.zugewiesenesLeihfahrzeug?.tage
                                || fahrzeug.kalkulationData?.ersatzfahrzeug?.tage
                                || 0;
                if (leihdauer > 0) {
                    // ðŸ”§ FIX 25: Firebase Timestamp richtig konvertieren
                    let geplantesEnde = fahrzeug.geplantesAbnahmeDatum;
                    if (geplantesEnde?.toDate) geplantesEnde = geplantesEnde.toDate(); // Firebase Timestamp
                    else if (typeof geplantesEnde === 'string') geplantesEnde = new Date(geplantesEnde);

                    const ende = geplantesEnde instanceof Date ? geplantesEnde : new Date(geplantesEnde);
                    if (!isNaN(ende.getTime())) { // Nur wenn gÃ¼ltiges Datum
                        ende.setDate(ende.getDate() - leihdauer);
                        auftragsstart = ende; // ðŸ”§ FIX 26: Date-Objekt behalten statt String (Zeit bleibt erhalten!)
                    }
                }
            }
            const auftragszeit = fahrzeug.abholzeit || fahrzeug.abholZeit || '';
            let auftragsstartDisplay = 'N/A';
            if (auftragsstart) {
                // ðŸ”§ FIX 26: Sicherstellen dass Date-Objekt fÃ¼r formatDate
                let auftragsstartDate = auftragsstart;
                if (typeof auftragsstartDate === 'string') {
                    auftragsstartDate = new Date(auftragsstartDate);
                }
                // Zeit von abholzeit Ã¼berschreibt die berechnete Zeit (wenn vorhanden)
                if (auftragszeit && auftragszeit.trim()) {
                    // Manuelle Zeit eingegeben - zeige formatiertes Datum + manuelle Zeit
                    const datePart = auftragsstartDate.toLocaleDateString('de-DE', {
                        day: '2-digit', month: '2-digit', year: 'numeric'
                    });
                    auftragsstartDisplay = `${datePart}, ${auftragszeit}`;
                } else {
                    // Keine manuelle Zeit - zeige Datum mit Zeit aus geplantesAbnahmeDatum
                    auftragsstartDisplay = formatDate(auftragsstartDate);
                }
            }

            return `
                <div class="auftrag-info-grid">
                    <div class="info-section">
                        <h4>Kundendaten</h4>
                        <div class="info-row">
                            <span class="info-label">Name:</span>
                            <span class="info-value">${fahrzeug.kundenname || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Telefon:</span>
                            <span class="info-value">${fahrzeug.telefon || fahrzeug.kundenTelefon || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Email:</span>
                            <span class="info-value">${fahrzeug.email || fahrzeug.kundenEmail || 'N/A'}</span>
                        </div>
                    </div>

                    <div class="info-section">
                        <h4>Fahrzeugdaten</h4>
                        <div class="info-row">
                            <span class="info-label">Marke/Modell:</span>
                            <span class="info-value">${fahrzeug.marke || ''} ${fahrzeug.modell || ''}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">VIN:</span>
                            <span class="info-value">${fahrzeug.vin || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Farbe:</span>
                            <span class="info-value">${farbeDisplay}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Kilometerstand:</span>
                            <span class="info-value">${kilometerstandDisplay}</span>
                        </div>
                    </div>

                    <div class="info-section">
                        <h4>Auftragsstatus</h4>
                        <div class="info-row">
                            <span class="info-label">Service:</span>
                            <span class="info-value">${serviceConfig.label || fahrzeug.serviceTyp}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Status:</span>
                            <span class="info-value status-badge ${fahrzeug.status}">${fahrzeug.status || 'N/A'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Dringlichkeit:</span>
                            <span class="info-value">${fahrzeug.dringlichkeitsScore || 0}/100</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Angelegt am:</span>
                            <span class="info-value">${formatDate(fahrzeug.erstelltAm || fahrzeug.createdAt)}</span>
                        </div>
                    </div>

                    <div class="info-section">
                        <h4>Lieferung & Abholung</h4>
                        <div class="info-row">
                            <span class="info-label">Abholservice:</span>
                            <span class="info-value">${abholserviceGewuenscht ? 'Ja' : 'Nein'}</span>
                        </div>
                        ${abholserviceGewuenscht && fahrzeug.abholadresse ? `
                        <div class="info-row">
                            <span class="info-label">Abholadresse:</span>
                            <span class="info-value">${fahrzeug.abholadresse}</span>
                        </div>
                        ` : ''}
                        <div class="info-row">
                            <span class="info-label">Ersatzfahrzeug:</span>
                            <span class="info-value">${fahrzeug.ersatzfahrzeugGewuenscht ? 'Ja' : 'Nein'}</span>
                        </div>
                        ${fahrzeug.zugewiesenesLeihfahrzeug ? `
                        <div class="info-row">
                            <span class="info-label">Leihfahrzeug:</span>
                            <span class="info-value">${fahrzeug.zugewiesenesLeihfahrzeug}</span>
                        </div>
                        ` : ''}
                    </div>

                    <div class="info-section">
                        <h4>Termine</h4>
                        <div class="info-row">
                            <span class="info-label">Auftragsstart:</span>
                            <span class="info-value">${auftragsstartDisplay}</span>
                        </div>
                        ${fahrzeug.ersatzfahrzeugGewuenscht ? `
                        <div class="info-row">
                            <span class="info-label">Leihfahrzeug-Ãœbergabe:</span>
                            <span class="info-value">${auftragsstartDisplay}</span>
                        </div>
                        ` : ''}
                        <div class="info-row">
                            <span class="info-label">Voraussichtliches Ende:</span>
                            <span class="info-value">${formatDate(fahrzeug.geplantesAbnahmeDatum) || 'N/A'}</span>
                        </div>
                        ${fahrzeug.fertigstellungDatum ? `
                        <div class="info-row">
                            <span class="info-label">Fertigstellung:</span>
                            <span class="info-value">${formatDate(fahrzeug.fertigstellungDatum)}</span>
                        </div>
                        ` : ''}
                    </div>

                    ${fahrzeug.notizen ? `
                    <div class="info-section full-width">
                        <h4>Notizen</h4>
                        <div class="notizen-text">${fahrzeug.notizen}</div>
                    </div>
                    ` : ''}

                    ${fahrzeug.schadensbeschreibung ? `
                    <div class="info-section full-width">
                        <h4>Schadensbeschreibung</h4>
                        <div class="notizen-text">${fahrzeug.schadensbeschreibung}</div>
                    </div>
                    ` : ''}

                    <div class="info-section full-width">
                        <h4>Verlauf / Audit-Trail</h4>
                        <div class="audit-trail">
                            ${generateAuditTrail(fahrzeug, formatDate)}
                        </div>
                    </div>
                </div>
            `;
        }

        function generateAuditTrail(fahrzeug, formatDate) {
            const events = [];

            // 1. Auftrag/Anfrage erstellt
            if (fahrzeug.erstelltAm || fahrzeug.createdAt) {
                events.push({
                    date: fahrzeug.erstelltAm || fahrzeug.createdAt,
                    event: 'Auftrag erstellt',
                    icon: 'ðŸ“'
                });
            }

            // 2. Partner-Anfrage gesendet (falls aus Partner-App)
            if (fahrzeug.prozessTimestamps?.anfrage_gesendet) {
                events.push({
                    date: fahrzeug.prozessTimestamps.anfrage_gesendet,
                    event: 'Partner-Anfrage gesendet',
                    icon: 'ðŸ“¤'
                });
            }

            // 3. KVA erstellt
            const kva = fahrzeug.kva || fahrzeug.kvaData || {};
            if (kva.erstelltAm || kva.createdAt) {
                events.push({
                    date: kva.erstelltAm || kva.createdAt,
                    event: 'KVA erstellt',
                    icon: 'ðŸ’°'
                });
            }

            // 4. Auftrag terminiert/angenommen
            if (fahrzeug.prozessTimestamps?.terminiert) {
                events.push({
                    date: fahrzeug.prozessTimestamps.terminiert,
                    event: 'Auftrag angenommen/terminiert',
                    icon: 'âœ…'
                });
            }

            // 5. Kunde hat bestÃ¤tigt
            if (fahrzeug.kundeBestaetigt && (fahrzeug.kundeBestaetigtAm || fahrzeug.kundeEntscheidungAm)) {
                events.push({
                    date: fahrzeug.kundeBestaetigtAm || fahrzeug.kundeEntscheidungAm,
                    event: 'Kunde hat Angebot angenommen',
                    icon: 'ðŸ‘¤'
                });
            } else if (fahrzeug.kundeAbgelehnt && fahrzeug.kundeEntscheidungAm) {
                events.push({
                    date: fahrzeug.kundeEntscheidungAm,
                    event: 'Kunde hat abgelehnt',
                    icon: 'âŒ'
                });
            }

            // 6. In Arbeit (gestartet)
            if (fahrzeug.prozessTimestamps?.in_arbeit) {
                events.push({
                    date: fahrzeug.prozessTimestamps.in_arbeit,
                    event: 'Arbeit gestartet',
                    icon: 'ðŸ”§'
                });
            }

            // 7. Fertiggestellt
            if (fahrzeug.prozessTimestamps?.fertig || fahrzeug.fertigstellungDatum) {
                events.push({
                    date: fahrzeug.prozessTimestamps?.fertig || fahrzeug.fertigstellungDatum,
                    event: 'Fertiggestellt',
                    icon: 'ðŸŽ‰'
                });
            }

            // 8. Ausgeliefert/Abnahme
            if (fahrzeug.abnahmeTimestamp || fahrzeug.prozessTimestamps?.abgegeben) {
                events.push({
                    date: fahrzeug.abnahmeTimestamp || fahrzeug.prozessTimestamps?.abgegeben,
                    event: 'Abnahme/Auslieferung',
                    icon: 'ðŸš—'
                });
            }

            // 9. Bezahlt
            if (fahrzeug.bezahltAm) {
                events.push({
                    date: fahrzeug.bezahltAm,
                    event: 'Rechnung bezahlt',
                    icon: 'ðŸ’¶'
                });
            }

            if (!events.length) {
                return '<div class="no-events">Keine Ereignisse vorhanden</div>';
            }

            // Sortiere nach Datum (Ã¤lteste zuerst)
            events.sort((a, b) => {
                const dateA = a.date?.toDate ? a.date.toDate() : new Date(a.date);
                const dateB = b.date?.toDate ? b.date.toDate() : new Date(b.date);
                return dateA - dateB;
            });

            return events.map((e, idx) => `
                <div class="audit-event ${idx === events.length - 1 ? 'last' : ''}">
                    <span class="audit-icon">${e.icon}</span>
                    <div class="audit-content">
                        <span class="audit-text">${e.event}</span>
                        <span class="audit-date">${formatDate(e.date)}</span>
                    </div>
                </div>
            `).join('');
        }

        function generateFotosTab(fahrzeug) {
            // Alle Foto-Arrays normalisieren
            // FIX (2025-12-07): Deduplication hinzugefuegt - gleiche URLs in mehreren Feldern
            // verursachten 12 Fotos statt 4 (3x Verdreifachung)
            const alleFotosRaw = [
                ...(fahrzeug.fotos || []),
                ...(fahrzeug.bilder || []),
                ...(fahrzeug.schadenfotos || []),
                ...(fahrzeug.photoUrls || []),
                ...(fahrzeug.annahmeFotos || []),
                ...(fahrzeug.pdfImport?.fotos || [])
            ].filter(url => url && typeof url === 'string');

            // Duplikate entfernen (gleiche URL kann in mehreren Feldern sein)
            const alleFotos = [...new Set(alleFotosRaw)];

            const fahrzeugscheinFotos = (fahrzeug.fahrzeugscheinFotos || [])
                .filter(url => url && typeof url === 'string');

            currentLightboxPhotos = [...alleFotos, ...fahrzeugscheinFotos];
            const totalCount = alleFotos.length + fahrzeugscheinFotos.length;

            if (totalCount === 0) {
                return { html: `<div class="no-data">Keine Fotos vorhanden</div>`, count: 0 };
            }

            let html = '';

            if (alleFotos.length > 0) {
                html += `
                    <div class="foto-section">
                        <h4>Annahme- & Schadensfotos (${alleFotos.length})</h4>
                        <div class="foto-grid">
                            ${alleFotos.map((url, idx) => `
                                <div class="foto-thumbnail" onclick="openLightbox(${idx})">
                                    <img src="${url}" alt="Foto ${idx + 1}" loading="lazy"
                                         onerror="this.parentElement.innerHTML='<div class=\\'foto-error\\'>Bild nicht verfÃ¼gbar</div>'">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            if (fahrzeugscheinFotos.length > 0) {
                const startIdx = alleFotos.length;
                html += `
                    <div class="foto-section">
                        <h4>Fahrzeugschein (${fahrzeugscheinFotos.length})</h4>
                        <div class="foto-grid">
                            ${fahrzeugscheinFotos.map((url, idx) => `
                                <div class="foto-thumbnail" onclick="openLightbox(${startIdx + idx})">
                                    <img src="${url}" alt="Fahrzeugschein ${idx + 1}" loading="lazy"
                                         onerror="this.parentElement.innerHTML='<div class=\\'foto-error\\'>Bild nicht verfÃ¼gbar</div>'">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            return { html, count: totalCount };
        }

        function generateKalkulationTab(fahrzeug) {
            // ðŸ†• FIX PIPELINE (2025-12-07): Erweiterte Fallback-Kette
            // Sucht in: kalkulationData â†’ kvaData.kalkulationData â†’ kva.kalkulationData
            const kalk = fahrzeug.kalkulationData
                      || fahrzeug.kvaData?.kalkulationData
                      || fahrzeug.kva?.kalkulationData
                      || {};

            // ðŸ†• FIX (2025-12-07): Feldname-Aliase fÃ¼r KompatibilitÃ¤t
            // kalkulation.html speichert "positionen", tagesplanung erwartet "arbeitslohn"
            const arbeitslohnRaw = kalk.arbeitslohn || kalk.positionen || [];

            // ðŸ†• FIX 7 (2025-12-07): Lackierung aus positionen extrahieren
            // kalkulation.html speichert KEINE separate lackierung Array!
            // Firebase-Daten haben "arbeit: 'lackieren'" NICHT "kategorie: 'Lackierung'"
            // Pruefen auf BEIDE Varianten fuer Kompatibilitaet
            // ðŸ†• FIX 11 (2025-12-07): art als Alias fuer arbeit hinzugefuegt
            // kalkulationData.arbeitslohn[] hat "art: 'lackieren'" NICHT "arbeit: 'lackieren'"!
            const isLackierung = (p) =>
                p.kategorie === 'Lackierung' || p.kategorie === 'lackierung' ||
                p.arbeit === 'lackieren' || p.arbeit === 'Lackieren' ||
                p.art === 'lackieren' || p.art === 'Lackieren';

            const lackierungPositionen = arbeitslohnRaw.filter(isLackierung);
            const sonstigeArbeit = arbeitslohnRaw.filter(p => !isLackierung(p));

            const hasData = arbeitslohnRaw.length ||
                           kalk.ersatzfahrzeug || kalk.gesamtsumme;

            if (!hasData) {
                return `<div class="no-data">Keine Kalkulationsdaten vorhanden</div>`;
            }

            let html = '';
            let gesamtsumme = 0;

            // Sonstige Arbeiten (Karosserie, Mechanik, etc.) - NICHT Lackierung
            if (sonstigeArbeit.length) {
                // ðŸ†• FIX 20 (2025-12-07): Alias `gesamtpreis` hinzugefÃ¼gt (Partner-App speichert so)
                const normalizedArbeitslohn = sonstigeArbeit.map(p => ({
                    bezeichnung: p.bezeichnung || p.name || p.position || 'Position',
                    kategorie: p.kategorie || '',
                    stunden: p.stunden || p.aw || p.arbeitswerte || 0,
                    stundensatz: p.stundensatz || 95,
                    gesamt: p.gesamt || p.preis || p.gesamtpreis || ((p.stunden || p.aw || p.arbeitswerte || 0) * (p.stundensatz || 95))
                }));
                const arbeitslohnSumme = normalizedArbeitslohn.reduce((sum, p) => sum + (p.gesamt || 0), 0);
                gesamtsumme += arbeitslohnSumme;
                html += `
                    <div class="kalkulation-section">
                        <h4>Arbeitslohn (Karosserie/Mechanik)</h4>
                        <table class="kalkulation-table">
                            <thead><tr><th>Position</th><th>AW/Std</th><th>Satz</th><th>Gesamt</th></tr></thead>
                            <tbody>
                                ${normalizedArbeitslohn.map(p => `
                                    <tr>
                                        <td>${p.bezeichnung}${p.kategorie ? ` <small style="color:#888">(${p.kategorie})</small>` : ''}</td>
                                        <td>${p.stunden}</td>
                                        <td>${(p.stundensatz).toLocaleString('de-DE', {style: 'currency', currency: 'EUR'})}</td>
                                        <td>${(p.gesamt).toLocaleString('de-DE', {style: 'currency', currency: 'EUR'})}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                            <tfoot><tr><td colspan="3"><strong>Summe</strong></td><td><strong>${arbeitslohnSumme.toLocaleString('de-DE', {style: 'currency', currency: 'EUR'})}</strong></td></tr></tfoot>
                        </table>
                    </div>
                `;
            }

            // ðŸ†• FIX (2025-12-07): Lackierung aus positionen mit kategorie='Lackierung'
            // ðŸ†• FIX 20 (2025-12-07): Alias `gesamtpreis` hinzugefÃ¼gt (Partner-App speichert so)
            if (lackierungPositionen.length) {
                const normalizedLackierung = lackierungPositionen.map(p => ({
                    bezeichnung: p.bezeichnung || p.name || p.position || 'Position',
                    stunden: p.stunden || p.aw || p.arbeitswerte || 0,
                    stundensatz: p.stundensatz || 85,  // Lackierung Stundensatz default 85
                    gesamt: p.gesamt || p.preis || p.gesamtpreis || ((p.stunden || p.aw || p.arbeitswerte || 0) * (p.stundensatz || 85))
                }));
                const lackierungSumme = normalizedLackierung.reduce((sum, p) => sum + (p.gesamt || 0), 0);
                gesamtsumme += lackierungSumme;
                html += `
                    <div class="kalkulation-section">
                        <h4>Lackierung</h4>
                        <table class="kalkulation-table">
                            <thead><tr><th>Position</th><th>AW/Std</th><th>Satz</th><th>Gesamt</th></tr></thead>
                            <tbody>
                                ${normalizedLackierung.map(p => `
                                    <tr>
                                        <td>${p.bezeichnung}</td>
                                        <td>${p.stunden}</td>
                                        <td>${(p.stundensatz).toLocaleString('de-DE', {style: 'currency', currency: 'EUR'})}</td>
                                        <td>${(p.gesamt).toLocaleString('de-DE', {style: 'currency', currency: 'EUR'})}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                            <tfoot><tr><td colspan="3"><strong>Summe</strong></td><td><strong>${lackierungSumme.toLocaleString('de-DE', {style: 'currency', currency: 'EUR'})}</strong></td></tr></tfoot>
                        </table>
                    </div>
                `;
            }

            if (kalk.ersatzfahrzeug && (kalk.ersatzfahrzeug.tage || kalk.ersatzfahrzeug.gesamt)) {
                const efGesamt = kalk.ersatzfahrzeug.gesamt || 0;
                gesamtsumme += efGesamt;
                html += `
                    <div class="kalkulation-section">
                        <h4>Ersatzfahrzeug</h4>
                        <table class="kalkulation-table">
                            <tbody>
                                <tr>
                                    <td>${kalk.ersatzfahrzeug.bezeichnung || 'Ersatzfahrzeug'}</td>
                                    <td>${kalk.ersatzfahrzeug.tage || 0} Tage</td>
                                    <td>${(kalk.ersatzfahrzeug.tagessatz || 0).toLocaleString('de-DE', {style: 'currency', currency: 'EUR'})}/Tag</td>
                                    <td><strong>${efGesamt.toLocaleString('de-DE', {style: 'currency', currency: 'EUR'})}</strong></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            }

            const displaySumme = kalk.gesamtsumme || gesamtsumme;
            html += `
                <div class="kalkulation-total">
                    <span>GESAMTSUMME (netto)</span>
                    <span class="total-value">${displaySumme.toLocaleString('de-DE', {style: 'currency', currency: 'EUR'})}</span>
                </div>
            `;

            return html;
        }

        async function generateTeileTab(fahrzeug) {
            // ðŸ†• FIX PIPELINE (2025-12-07): Erweiterte Fallback-Kette (wie generateKalkulationTab)
            const kalk = fahrzeug.kalkulationData
                      || fahrzeug.kvaData?.kalkulationData
                      || fahrzeug.kva?.kalkulationData
                      || {};

            // ðŸ†• FIX 8 (2025-12-07): Erweiterte Fallback-Kette MIT LaengenprÃ¼fung
            // Problem: kalk.ersatzteile = [] (leeres Array) ist truthy und blockiert Fallback!
            // Firebase speichert Ersatzteile an mehreren Stellen:
            // 1. fahrzeug.ersatzteile[] - Root-Level (direkt aus Anfrage)
            // 2. fahrzeug.kalkulation.ersatzteile[] - In kalkulation-Objekt
            // 3. fahrzeug.kalkulationData.ersatzteile[] - In kalkulationData (anderes Format)
            const ersatzteileRaw =
                (fahrzeug.kalkulation?.ersatzteile?.length ? fahrzeug.kalkulation.ersatzteile : null) ||
                (fahrzeug.ersatzteile?.length ? fahrzeug.ersatzteile : null) ||
                (kalk.ersatzteile?.length ? kalk.ersatzteile : null) ||
                [];

            // ðŸ†• FIX 12 (2025-12-07): Ersatzteile nach gewaehlteVariante filtern
            // User-Anforderung: "ersatzteile sollte ja nur das vom kunden gewaehlte werden"
            // Firebase hat: gewaehlteVariante: "original" oder "aftermarket"
            // Ersatzteile haben: preisTyp: "Original" oder "Aftermarket"
            const gewaehlteVariante = fahrzeug.gewaehlteVariante || fahrzeug.kalkulation?.gewaehlteVariante || 'original';
            console.log(`ðŸ” [FIX 12] gewaehlteVariante: "${gewaehlteVariante}", ersatzteileRaw: ${ersatzteileRaw.length}`);

            let ersatzteile = ersatzteileRaw;
            if (ersatzteileRaw.length > 0) {
                const varianteLower = gewaehlteVariante.toLowerCase();

                // Filter nach preisTyp (Original/Aftermarket)
                const filtered = ersatzteileRaw.filter(t => {
                    const preisTyp = (t.preisTyp || t.qualitaet || '').toLowerCase();
                    // Wenn keine preisTyp-Info vorhanden, zeigen (z.B. Verbrauchsmaterialien)
                    if (!preisTyp) return true;
                    // Match Original vs Aftermarket
                    if (varianteLower === 'original' && preisTyp === 'original') return true;
                    if (varianteLower === 'aftermarket' && preisTyp === 'aftermarket') return true;
                    // Wenn es kein expliziter Match ist, nicht zeigen
                    return false;
                });

                // Fallback: Wenn Filter leer, alle zeigen (fuer Verbrauchsmaterialien ohne preisTyp)
                ersatzteile = filtered.length > 0 ? filtered : ersatzteileRaw;
                console.log(`âœ… [FIX 12] Nach Filter: ${ersatzteile.length} Ersatzteile (von ${ersatzteileRaw.length})`);
            }

            if (!ersatzteile.length) {
                return { html: `<div class="no-data">Keine Ersatzteile hinterlegt</div>`, count: 0 };
            }

            // ðŸ†• FIX 3 (2025-12-07): Bestellungen fÃ¼r dieses Fahrzeug laden
            let bestellungen = [];
            try {
                const bestellungenSnap = await window.getCollection('bestellungen')
                    .where('fahrzeugId', '==', String(fahrzeug.id))
                    .get();
                bestellungen = bestellungenSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                console.log(`ðŸ“¦ [TEILE-TAB] ${bestellungen.length} Bestellungen fÃ¼r Fahrzeug ${fahrzeug.id} geladen`);
            } catch (e) {
                console.warn('âš ï¸ [TEILE-TAB] Bestellungen konnten nicht geladen werden:', e.message);
            }

            // Status-Badge Helper
            const getStatusBadge = (bezeichnung, etn) => {
                // Suche Bestellung nach ETN oder Bezeichnung
                const bestellung = bestellungen.find(b =>
                    (etn && etn !== '-' && etn !== 'k.A.' && b.etn === etn) ||
                    (b.bezeichnung && b.bezeichnung.toLowerCase() === bezeichnung.toLowerCase())
                );

                if (!bestellung) {
                    return '<span class="badge badge-gray" title="Noch nicht bestellt">â³ Offen</span>';
                }

                const formatDate = (d) => {
                    if (!d) return '';
                    if (d.toDate) d = d.toDate();
                    return new Date(d).toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit' });
                };

                switch(bestellung.status) {
                    case 'zu_bestellen':
                        return '<span class="badge badge-yellow" title="In Bestellliste">ðŸ“ Zu bestellen</span>';
                    case 'bestellt':
                        const bestellDatum = bestellung.bestelltAm ? ` (${formatDate(bestellung.bestelltAm)})` : '';
                        const lieferDatum = bestellung.erwarteteAnkunft ? `<br><small>ETA: ${formatDate(bestellung.erwarteteAnkunft)}</small>` : '';
                        return `<span class="badge badge-blue" title="Bestellt${bestellDatum}">ðŸ“¦ Bestellt${bestellDatum}</span>${lieferDatum}`;
                    case 'angeliefert':
                        const ankunftDatum = bestellung.angeliefertAm ? ` (${formatDate(bestellung.angeliefertAm)})` : '';
                        return `<span class="badge badge-green" title="Geliefert${ankunftDatum}">âœ… Da${ankunftDatum}</span>`;
                    default:
                        return '<span class="badge badge-gray">â“ Unbekannt</span>';
                }
            };

            // ðŸ†• FIX (2025-12-07): Normalisiere ersatzteile/materialien Format
            // kalkulation.html: {name, menge, einzelpreis, einheit} - VERBRAUCHSMATERIALIEN (kein ETN)
            // Erwartet hier: {bezeichnung, anzahl, preis} - ERSATZTEILE (mit ETN)
            // ðŸ†• FIX #2 (2025-12-07): Intelligentere ETN-Anzeige
            // - Verbrauchsmaterialien (einheit=Liter/kg/Set) â†’ kein ETN erwartet â†’ zeige "-"
            // - Echte Ersatzteile (einheit=StÃ¼ck oder etn vorhanden) â†’ zeige ETN oder "k.A."
            const normalizedTeile = ersatzteile.map(t => {
                // Detect if this is a consumable material (no ETN expected)
                const isConsumable = ['Liter', 'kg', 'Set', 'Pauschale', 'ml', 'g'].includes(t.einheit);
                const hasETN = t.etn || t.artikelnummer;

                return {
                    etn: hasETN ? (t.etn || t.artikelnummer) : (isConsumable ? '-' : 'k.A.'),
                    bezeichnung: t.bezeichnung || t.name || 'Material',
                    anzahl: t.anzahl || t.menge || 1,
                    preis: t.preis || t.einzelpreis || 0,
                    einheit: t.einheit || 'StÃ¼ck'
                };
            });

            const teileSumme = normalizedTeile.reduce((sum, t) => sum + (t.preis * t.anzahl), 0);
            const html = `
                <div class="ersatzteile-section">
                    <h4>Ersatzteile (${normalizedTeile.length} Positionen)</h4>
                    <table class="kalkulation-table">
                        <thead><tr><th>ETN</th><th>Bezeichnung</th><th>Anz.</th><th>Preis</th><th>Gesamt</th><th>Status</th></tr></thead>
                        <tbody>
                            ${normalizedTeile.map(t => `
                                <tr>
                                    <td>${t.etn}</td>
                                    <td>${t.bezeichnung}</td>
                                    <td>${t.anzahl}x</td>
                                    <td>${t.preis.toLocaleString('de-DE', {style: 'currency', currency: 'EUR'})}</td>
                                    <td>${(t.preis * t.anzahl).toLocaleString('de-DE', {style: 'currency', currency: 'EUR'})}</td>
                                    <td>${getStatusBadge(t.bezeichnung, t.etn)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot><tr><td colspan="5"><strong>Summe</strong></td><td><strong>${teileSumme.toLocaleString('de-DE', {style: 'currency', currency: 'EUR'})}</strong></td></tr></tfoot>
                    </table>
                </div>
            `;

            return { html, count: normalizedTeile.length };
        }

        // ============================================================
        // TAB 5: PDFs
        // ============================================================

        function generatePDFsTab(fahrzeug) {
            const pdfs = [];

            const formatDate = (d) => {
                if (!d) return 'N/A';
                if (d.toDate) d = d.toDate();
                return new Date(d).toLocaleDateString('de-DE', {
                    day: '2-digit', month: '2-digit', year: 'numeric'
                });
            };

            // 1. Annahme-PDF
            if (fahrzeug.pdfUrl) {
                pdfs.push({
                    name: 'Annahme-Formular',
                    url: fahrzeug.pdfUrl,
                    date: fahrzeug.pdfUploadedAt || fahrzeug.annahmeTimestamp || fahrzeug.createdAt,
                    icon: 'ðŸ“'
                });
            }

            // 2. Entwurf-PDF
            if (fahrzeug.entwurfPdfUrl) {
                pdfs.push({
                    name: 'Entwurf',
                    url: fahrzeug.entwurfPdfUrl,
                    date: fahrzeug.entwurfErstelltAm || fahrzeug.createdAt,
                    icon: 'ðŸ“‹'
                });
            }

            // 3. KVA-Angebot-PDF (beide Varianten wenn vorhanden)
            const kva = fahrzeug.kva || fahrzeug.kvaData || {};

            // ðŸ†• FIX 9 (2025-12-07): angebotPdfUrl auf Root-Level UND kva-Level pruefen
            // Alte Fahrzeuge haben angebotPdfUrl direkt auf Root, neue in kva.angebotPdfUrl
            const angebotPdfUrl = kva.angebotPdfUrl || fahrzeug.angebotPdfUrl;
            if (angebotPdfUrl) {
                pdfs.push({
                    name: 'KVA-Angebot',
                    url: angebotPdfUrl,
                    date: kva.erstelltAm || kva.createdAt || fahrzeug.createdAt,
                    icon: 'ðŸ’°'
                });
            }
            if (kva.angebotPdfUrl_variante1) {
                pdfs.push({
                    name: 'KVA Variante 1 (Original)',
                    url: kva.angebotPdfUrl_variante1,
                    date: kva.erstelltAm,
                    icon: 'ðŸ’°'
                });
            }
            if (kva.angebotPdfUrl_variante2) {
                pdfs.push({
                    name: 'KVA Variante 2 (Smart Repair)',
                    url: kva.angebotPdfUrl_variante2,
                    date: kva.erstelltAm,
                    icon: 'ðŸ’°'
                });
            }

            // 4. Rechnung-PDF
            if (fahrzeug.rechnungPdfUrl) {
                pdfs.push({
                    name: 'Rechnung',
                    url: fahrzeug.rechnungPdfUrl,
                    date: fahrzeug.rechnungErstelltAm,
                    icon: 'ðŸ§¾'
                });
            }

            // 5. Abnahme-PDF
            if (fahrzeug.abnahmePdfUrl) {
                pdfs.push({
                    name: 'Abnahme-Protokoll',
                    url: fahrzeug.abnahmePdfUrl,
                    date: fahrzeug.abnahmeTimestamp,
                    icon: 'âœ…'
                });
            }

            if (!pdfs.length) {
                return {
                    html: '<div class="no-data">Keine PDFs vorhanden</div>',
                    count: 0
                };
            }

            const html = `
                <div class="pdfs-section">
                    <h4>Dokumente (${pdfs.length})</h4>
                    <div class="pdf-list">
                        ${pdfs.map(pdf => `
                            <div class="pdf-item">
                                <span class="pdf-icon">${pdf.icon}</span>
                                <div class="pdf-info">
                                    <span class="pdf-name">${pdf.name}</span>
                                    <span class="pdf-date">${formatDate(pdf.date)}</span>
                                </div>
                                <a href="${pdf.url}" target="_blank" class="btn-download" title="PDF anzeigen">
                                    ðŸ“¥ Download
                                </a>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            return { html, count: pdfs.length };
        }

        // ============================================================
        // TAB-NAVIGATION
        // ============================================================

        function switchDetailTab(tabName) {
            document.querySelectorAll('.detail-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.detail-tab-content').forEach(content => content.classList.remove('active'));

            const tabButton = document.querySelector(`.detail-tab[data-tab="${tabName}"]`);
            const tabContent = document.getElementById(`tab-${tabName}`);

            if (tabButton) tabButton.classList.add('active');
            if (tabContent) tabContent.classList.add('active');
        }

        // ============================================================
        // LIGHTBOX FUNKTIONEN
        // ============================================================

        function openLightbox(index) {
            if (!currentLightboxPhotos.length) return;
            currentLightboxIndex = index;

            const lightbox = document.getElementById('lightboxOverlay');
            document.getElementById('lightboxImage').src = currentLightboxPhotos[index];
            document.getElementById('lightboxCounter').textContent = `${index + 1} / ${currentLightboxPhotos.length}`;

            lightbox.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeLightbox(event) {
            if (event && event.target !== document.getElementById('lightboxOverlay')) return;
            document.getElementById('lightboxOverlay').style.display = 'none';
            document.body.style.overflow = '';
        }

        function lightboxNavigate(direction) {
            if (!currentLightboxPhotos.length) return;
            currentLightboxIndex += direction;

            if (currentLightboxIndex < 0) currentLightboxIndex = currentLightboxPhotos.length - 1;
            if (currentLightboxIndex >= currentLightboxPhotos.length) currentLightboxIndex = 0;

            document.getElementById('lightboxImage').src = currentLightboxPhotos[currentLightboxIndex];
            document.getElementById('lightboxCounter').textContent = `${currentLightboxIndex + 1} / ${currentLightboxPhotos.length}`;
        }

        // Keyboard-Navigation fÃ¼r Lightbox
        document.addEventListener('keydown', (e) => {
            const lightbox = document.getElementById('lightboxOverlay');
            if (lightbox && lightbox.style.display === 'flex') {
                if (e.key === 'Escape') closeLightbox();
                if (e.key === 'ArrowLeft') lightboxNavigate(-1);
                if (e.key === 'ArrowRight') lightboxNavigate(1);
            }
        });

        // ============================================================
        // PRINT FUNKTION
        // ============================================================

        function printDetailModal() {
            window.print();
        }

        function closeModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        // Close modal on outside click
        document.getElementById('detailModal').addEventListener('click', (e) => {
            if (e.target.id === 'detailModal') closeModal();
        });

        // ============================================
        // STUNDEN-DETAILS POPUP
        // ============================================

        let currentEditFahrzeugId = null;

        // Helper: Queue-ID zu Label
        function getQueueLabel(queueType) {
            const labels = {
                'abhol_fahrt': 'Abhol-Fahrt',
                'liefer_fahrt': 'Liefer-Fahrt',
                'lackier': 'Lackierung',
                'mechanik': 'Mechanik',
                'reifen': 'Reifen'
            };
            return labels[queueType] || queueType;
        }

        function showHoursDetails(fahrzeugId, queueType = '') {
            const fahrzeug = allFahrzeuge.find(f => f.id === fahrzeugId);
            if (!fahrzeug) return;

            currentEditFahrzeugId = fahrzeugId;

            // Logistik-Queues haben Fahrzeit, keine KVA-Daten
            const logistikQueues = ['abhol_fahrt', 'liefer_fahrt'];
            const isLogistikQueue = queueType && logistikQueues.includes(queueType);

            // Titel setzen
            const queueLabel = isLogistikQueue ? getQueueLabel(queueType) : '';
            document.getElementById('hoursModalTitle').textContent =
                `Arbeitszeit: ${fahrzeug.kennzeichen || 'Fahrzeug'}${queueLabel ? ` (${queueLabel})` : ''}`;

            // AufschlÃ¼sselung erstellen
            let breakdownHtml = '';

            if (isLogistikQueue) {
                // Logistik-Queue: Fahrzeit anzeigen
                // PrioritÃ¤t: 1. Maps-Zeit, 2. geschaetzteStunden, 3. Default
                const mapsZeitMinuten = fahrzeug.logistikDetails?.travelTimeRoundTrip;
                const defaultFahrzeit = window.SERVICE_DEFAULT_HOURS?.[queueType] || 1.5;
                const actualHours = mapsZeitMinuten
                    ? (mapsZeitMinuten / 60)
                    : (fahrzeug.geschaetzteStunden || defaultFahrzeit);

                // Label und Icon je nach Quelle
                const istMapsZeit = !!mapsZeitMinuten;
                const zeitLabel = istMapsZeit ? 'ðŸ—ºï¸ Google Maps (Hin+RÃ¼ck)' : 'â±ï¸ GeschÃ¤tzte Fahrzeit';
                const bgColor = istMapsZeit ? 'rgba(34,197,94,0.1)' : 'rgba(59,130,246,0.1)';
                const textColor = istMapsZeit ? '#16a34a' : '#3b82f6';

                // Route-Details fÃ¼r Transparenz
                const routeOrigin = fahrzeug.logistikDetails?.routeOrigin || '';
                const routeDestination = fahrzeug.logistikDetails?.routeDestination || '';
                const distanceOneWay = fahrzeug.logistikDetails?.distanceKm || 0;

                breakdownHtml = `
                    <div class="hours-breakdown" style="background:${bgColor};">
                        <div style="color:${textColor};font-weight:600;margin-bottom:8px;">
                            ðŸš— Logistik-Aufgabe: ${queueLabel}
                        </div>
                        <div class="hours-breakdown-item">
                            <span>${zeitLabel}</span>
                            <span>${actualHours.toFixed(1)}h</span>
                        </div>
                        ${istMapsZeit ? `
                        <div style="font-size:12px;margin-top:12px;padding:8px;background:rgba(0,0,0,0.05);border-radius:6px;">
                            <div style="color:#6b7280;margin-bottom:6px;">ðŸ“ <strong>Route:</strong></div>
                            <div style="color:#374151;margin-left:16px;margin-bottom:4px;">
                                <strong>Von:</strong> ${routeOrigin || 'Werkstatt'}
                            </div>
                            <div style="color:#374151;margin-left:16px;">
                                <strong>Nach:</strong> ${routeDestination || 'Kunde'}
                            </div>
                        </div>
                        <div style="font-size:12px;color:#16a34a;margin-top:8px;">
                            âœ… ${Math.round(mapsZeitMinuten/2)} Min / ${distanceOneWay.toFixed(1)} km (einfach) Ã— 2 = ${Math.round(mapsZeitMinuten)} Min Hin+RÃ¼ck
                        </div>` : `
                        <div style="font-size:12px;color:#6b7280;margin-top:8px;">
                            ðŸ’¡ Zeit fÃ¼r An-/Abfahrt zum Kunden (Standardwert)
                        </div>`}
                    </div>`;
            } else {
                // Werkstatt-Queue: KVA-Daten oder Default
                const kvaHours = window.calculateKvaHours ? window.calculateKvaHours(fahrzeug) : null;

                if (kvaHours && fahrzeug.kalkulationData) {
                    // KVA vorhanden - zeige alle Positionen
                    breakdownHtml = '<div class="hours-breakdown">';
                    breakdownHtml += '<div style="color:#16a34a;font-weight:600;margin-bottom:8px;">âœ“ Aus KVA berechnet:</div>';

                    // Arbeitslohn-Positionen
                    const arbeitslohn = fahrzeug.kalkulationData.arbeitslohn || [];
                    arbeitslohn.forEach(pos => {
                        const stunden = parseFloat(pos.stunden) || 0;
                        if (stunden > 0) {
                            breakdownHtml += `
                                <div class="hours-breakdown-item">
                                    <span>${pos.art || pos.position || 'Arbeit'}</span>
                                    <span>${stunden.toFixed(1)}h</span>
                                </div>`;
                        }
                    });

                    // Lackierungs-Positionen
                    const lackierung = fahrzeug.kalkulationData.lackierung || [];
                    lackierung.forEach(pos => {
                        const stunden = parseFloat(pos.stunden) || 0;
                        if (stunden > 0) {
                            breakdownHtml += `
                                <div class="hours-breakdown-item">
                                    <span>Lackierung: ${pos.bereich || pos.art || ''}</span>
                                    <span>${stunden.toFixed(1)}h</span>
                                </div>`;
                        }
                    });

                    // Gesamt
                    breakdownHtml += `
                        <div class="hours-breakdown-item hours-breakdown-total">
                            <span>GESAMT</span>
                            <span>${kvaHours.toFixed(1)}h</span>
                        </div>`;
                    breakdownHtml += '</div>';
                } else {
                    // Kein KVA - Default erklÃ¤ren
                    const serviceConfig = window.SERVICE_TYPE_CONFIG?.[fahrzeug.serviceTyp] || {};
                    const defaultHours = window.SERVICE_DEFAULT_HOURS?.[fahrzeug.serviceTyp] || 1.0;

                    breakdownHtml = `
                        <div class="hours-breakdown" style="background:rgba(107,114,128,0.1);">
                            <div style="color:#6b7280;font-weight:600;margin-bottom:8px;">
                                âš ï¸ Keine KVA vorhanden - Standard-SchÃ¤tzwert:
                            </div>
                            <div class="hours-breakdown-item">
                                <span>${serviceConfig.label || fahrzeug.serviceTyp || 'Unbekannt'}</span>
                                <span>${defaultHours.toFixed(1)}h (Default)</span>
                            </div>
                            <div style="font-size:12px;color:#9ca3af;margin-top:8px;">
                                ðŸ’¡ FÃ¼r genaue Zeiten: KVA/Kalkulation erstellen
                            </div>
                        </div>`;
                }
            }

            // Falls manuell Ã¼berschrieben wurde
            if (fahrzeug.geschaetzteStunden && fahrzeug.geschaetzteStundenGeaendertVon) {
                breakdownHtml += `
                    <div style="font-size:12px;color:#3b82f6;margin-top:8px;padding:8px;background:rgba(59,130,246,0.05);border-radius:4px;">
                        âœï¸ Manuell angepasst auf ${fahrzeug.geschaetzteStunden.toFixed(1)}h
                        von ${fahrzeug.geschaetzteStundenGeaendertVon}
                    </div>`;
            }

            document.getElementById('hoursBreakdown').innerHTML = breakdownHtml;

            // Aktuellen Wert ins Input setzen
            const currentHours = window.getEstimatedHours ? window.getEstimatedHours(fahrzeug) : 1.0;
            document.getElementById('manualHoursInput').value = currentHours.toFixed(1);

            // Modal Ã¶ffnen
            document.getElementById('hoursModal').classList.add('active');
        }

        async function saveManualHours() {
            if (!currentEditFahrzeugId) return;

            const manualHours = parseFloat(document.getElementById('manualHoursInput').value);
            if (isNaN(manualHours) || manualHours < 0.5) {
                alert('Bitte geben Sie einen gÃ¼ltigen Wert ein (mind. 0.5h)');
                return;
            }

            try {
                // Disable button while saving
                const saveBtn = event.target;
                saveBtn.disabled = true;
                saveBtn.textContent = 'Speichern...';

                // In Firestore speichern
                const collectionName = window.getCollectionName ? window.getCollectionName('fahrzeuge') : 'fahrzeuge';
                await db.collection(collectionName).doc(currentEditFahrzeugId).update({
                    geschaetzteStunden: manualHours,
                    geschaetzteStundenGeaendertAm: firebase.firestore.FieldValue.serverTimestamp(),
                    geschaetzteStundenGeaendertVon: window.currentUser?.displayName || 'Werkstattleiter'
                });

                // Lokales Array aktualisieren
                const fahrzeug = allFahrzeuge.find(f => f.id === currentEditFahrzeugId);
                if (fahrzeug) {
                    fahrzeug.geschaetzteStunden = manualHours;
                    fahrzeug.geschaetzteStundenGeaendertVon = window.currentUser?.displayName || 'Werkstattleiter';
                }

                // Queue-KapazitÃ¤ten neu berechnen
                updateCapacityBar();

                // UI aktualisieren
                renderQueues();

                // Modal schlieÃŸen
                closeHoursModal();

                console.log(`âœ“ Stunden fÃ¼r ${currentEditFahrzeugId} auf ${manualHours}h gesetzt`);

                // Zeige kurze BestÃ¤tigung
                if (typeof toast !== 'undefined') {
                    toast.success(`Arbeitszeit auf ${manualHours}h geÃ¤ndert`);
                }
            } catch (error) {
                console.error('Fehler beim Speichern:', error);
                alert('Fehler beim Speichern der Stunden: ' + error.message);
            } finally {
                // Re-enable button
                const saveBtn = document.querySelector('#hoursModal .nav-btn.primary');
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Speichern';
                }
            }
        }

        function closeHoursModal() {
            document.getElementById('hoursModal').classList.remove('active');
            currentEditFahrzeugId = null;
        }

        // Close hours modal on outside click
        document.getElementById('hoursModal').addEventListener('click', (e) => {
            if (e.target.id === 'hoursModal') closeHoursModal();
        });

        // ============================================
        // HELPERS
        // ============================================

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // Warn before leaving with unsaved changes
        window.addEventListener('beforeunload', (e) => {
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>
