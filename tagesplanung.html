<!DOCTYPE html>
<html lang="de">
<head>
    <script>
        /// <reference path="js/types.js" />
        // window.werkstattId is set automatically after successful login
    </script>
    <script>
        window.DEBUG = (
            localStorage.getItem('DEBUG') === 'true' ||
            window.location.search.includes('debug=true') ||
            window.location.hostname === 'localhost' ||
            window.location.port === '8000'
        );
    </script>

    <!-- FOUC Prevention -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tagesplanung - Priorisierung | Auto-Lackierzentrum Mosbach</title>

    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- Design System -->
    <link rel="stylesheet" href="design-system.css?v=tagesplanung-v1">
    <link rel="stylesheet" href="liquid-glass.css?v=tagesplanung-v1">
    <link rel="stylesheet" href="animations.css?v=tagesplanung-v1">
    <link rel="stylesheet" href="mobile-first.css?v=tagesplanung-v1">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-system);
            background: var(--color-background);
            min-height: 100vh;
            padding: var(--space-4);
            color: var(--color-text-primary);
        }

        /* Header */
        .header {
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-2xl);
            padding: var(--space-4) var(--space-6);
            margin-bottom: var(--space-4);
            box-shadow: var(--shadow-xl);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: var(--space-3);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo { font-size: 36px; }

        .title h1 {
            color: var(--color-primary);
            font-size: 22px;
            margin: 0;
        }

        .title .subtitle {
            color: var(--color-text-secondary);
            font-size: 13px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .date-picker {
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            background: var(--color-surface);
            font-size: 14px;
            color: var(--color-text-primary);
        }

        .nav-btn {
            padding: var(--space-2) var(--space-4);
            background: linear-gradient(135deg, rgba(0, 191, 255, 0.8), rgba(0, 122, 255, 0.7));
            border: none;
            color: white;
            text-decoration: none;
            border-radius: var(--radius-lg);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .nav-btn.success {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.8), rgba(22, 163, 74, 0.7));
        }

        /* Main Layout */
        .main-container {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: var(--space-4);
            height: calc(100vh - 140px);
        }

        /* Ungeplant Section */
        .ungeplant-section {
            background: var(--color-surface);
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-xl);
            padding: var(--space-4);
            overflow-y: auto;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-3);
            padding-bottom: var(--space-2);
            border-bottom: 1px solid var(--color-border);
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .count-badge {
            background: var(--color-primary);
            color: white;
            padding: 2px 8px;
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 600;
        }

        .sort-select {
            padding: 4px 8px;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: 12px;
            background: var(--color-surface);
        }

        /* Fahrzeug Cards */
        .fahrzeug-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-3);
            margin-bottom: var(--space-2);
            cursor: grab;
            transition: all 0.2s;
            position: relative;
        }

        .fahrzeug-card:hover {
            border-color: var(--color-primary);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .fahrzeug-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .fahrzeug-card .kennzeichen {
            font-weight: 700;
            font-size: 15px;
            margin-bottom: 4px;
        }

        .fahrzeug-card .info {
            font-size: 12px;
            color: var(--color-text-secondary);
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .fahrzeug-card .service-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            border-radius: var(--radius-sm);
            font-size: 11px;
            font-weight: 500;
        }

        .fahrzeug-card .dringlichkeit {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .dringlichkeit.hoch { background: #ef4444; }
        .dringlichkeit.mittel { background: #f59e0b; }
        .dringlichkeit.niedrig { background: #6b7280; }

        /* Queue Sections - Logistik + Werkstatt */
        .queues-container {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
            overflow-y: auto;
        }

        .queue-group {
            background: var(--color-surface);
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-xl);
            padding: var(--space-4);
        }

        .queue-group-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: var(--space-3);
            padding-bottom: var(--space-2);
            border-bottom: 2px solid var(--color-border);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .queue-section {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-3);
        }

        .queue-section.werkstatt {
            grid-template-columns: repeat(6, 1fr);
        }

        .queue-column {
            background: var(--color-surface);
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-xl);
            padding: var(--space-3);
            min-height: 300px;
            display: flex;
            flex-direction: column;
        }

        .queue-header {
            text-align: center;
            padding-bottom: var(--space-2);
            margin-bottom: var(--space-2);
            border-bottom: 2px solid var(--color-border);
        }

        .queue-header .icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .queue-header .name {
            font-weight: 600;
            font-size: 14px;
        }

        .queue-header .queue-count {
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        .queue-items {
            flex: 1;
            overflow-y: auto;
            min-height: 100px;
            padding: var(--space-1);
            border: 2px dashed transparent;
            border-radius: var(--radius-lg);
            transition: all 0.2s;
        }

        .queue-items.drag-over {
            border-color: var(--color-primary);
            background: rgba(0, 122, 255, 0.05);
        }

        .queue-item {
            background: var(--color-background);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: var(--space-2);
            margin-bottom: var(--space-2);
            cursor: grab;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .queue-item:hover {
            border-color: var(--color-primary);
        }

        .queue-item.dragging {
            opacity: 0.5;
        }

        .queue-item .position {
            background: var(--color-primary);
            color: white;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .queue-item .kennzeichen {
            font-weight: 600;
            font-size: 13px;
            flex: 1;
        }

        .queue-item .remove-btn {
            background: none;
            border: none;
            color: var(--color-text-secondary);
            cursor: pointer;
            padding: 2px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .queue-item:hover .remove-btn {
            opacity: 1;
        }

        .queue-item .remove-btn:hover {
            color: #ef4444;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: var(--space-4);
            color: var(--color-text-secondary);
            font-size: 13px;
        }

        /* Stats Bar */
        .stats-bar {
            background: var(--color-surface);
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-xl);
            padding: var(--space-3) var(--space-4);
            margin-bottom: var(--space-4);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--space-3);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-item .label {
            font-size: 12px;
            color: var(--color-text-secondary);
        }

        .stat-item .value {
            font-size: 18px;
            font-weight: 700;
            color: var(--color-primary);
        }

        /* Service Colors */
        .service-lackier { background: rgba(239, 68, 68, 0.15); color: #dc2626; }
        .service-mechanik { background: rgba(59, 130, 246, 0.15); color: #2563eb; }
        .service-reifen { background: rgba(34, 197, 94, 0.15); color: #16a34a; }
        .service-pflege { background: rgba(168, 85, 247, 0.15); color: #9333ea; }
        .service-tuev { background: rgba(249, 115, 22, 0.15); color: #ea580c; }
        .service-default { background: rgba(107, 114, 128, 0.15); color: #4b5563; }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--color-border);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--color-surface);
            border-radius: var(--radius-xl);
            padding: var(--space-6);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h3 {
            margin-bottom: var(--space-4);
        }

        .modal-actions {
            display: flex;
            gap: var(--space-3);
            margin-top: var(--space-4);
            justify-content: flex-end;
        }

        /* Service Color Classes for all 12 types */
        .service-versicherung { background: rgba(139, 92, 246, 0.15); color: #7c3aed; }
        .service-glas { background: rgba(6, 182, 212, 0.15); color: #0891b2; }
        .service-klima { background: rgba(59, 130, 246, 0.15); color: #2563eb; }
        .service-dellen { background: rgba(245, 158, 11, 0.15); color: #d97706; }
        .service-folierung { background: rgba(236, 72, 153, 0.15); color: #db2777; }
        .service-steinschutz { background: rgba(20, 184, 166, 0.15); color: #0d9488; }
        .service-werbebeklebung { background: rgba(249, 115, 22, 0.15); color: #ea580c; }

        /* Logistik Queue Colors */
        .queue-column.logistik {
            border-color: rgba(59, 130, 246, 0.3);
            background: rgba(59, 130, 246, 0.05);
        }

        /* Info Button on Cards */
        .info-btn {
            position: absolute;
            top: 6px;
            right: 24px;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fahrzeug-card:hover .info-btn,
        .queue-item:hover .info-btn {
            opacity: 1;
        }

        /* Kapazit√§ts-Anzeige (Phase 2) */
        .queue-capacity {
            font-size: 11px;
            color: var(--color-text-secondary);
            font-weight: 500;
            margin-top: 2px;
        }

        .queue-capacity.warning {
            color: #f59e0b;
            font-weight: 600;
        }

        .queue-capacity.danger {
            color: #ef4444;
            font-weight: 700;
        }

        .capacity-bar {
            height: 4px;
            background: var(--color-border);
            border-radius: 2px;
            margin-top: 6px;
            overflow: hidden;
        }

        .capacity-fill {
            height: 100%;
            background: #22c55e;
            transition: width 0.3s ease, background 0.3s ease;
            border-radius: 2px;
        }

        .capacity-fill.warning {
            background: #f59e0b;
        }

        .capacity-fill.danger {
            background: #ef4444;
        }

        /* Stunden-Badge auf Queue-Items */
        .hours-badge {
            font-size: 10px;
            padding: 2px 5px;
            border-radius: var(--radius-sm);
            font-weight: 600;
            white-space: nowrap;
            cursor: help;
        }

        /* KVA-basierte Stunden = Gr√ºn (genau!) */
        .hours-badge.kva {
            background: rgba(34, 197, 94, 0.15);
            color: #16a34a;
        }

        /* Default-Sch√§tzung = Grau (unsicher) */
        .hours-badge.default {
            background: rgba(107, 114, 128, 0.15);
            color: #6b7280;
        }

        /* Klickbarer Badge */
        .hours-badge:hover {
            opacity: 0.8;
            transform: scale(1.05);
            cursor: pointer;
        }

        /* Stunden-Details Popup */
        .hours-breakdown {
            background: var(--color-surface-alt, #f8f9fa);
            border-radius: var(--radius-md, 8px);
            padding: var(--space-3, 12px);
            margin-bottom: var(--space-4, 16px);
        }

        .hours-breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid var(--color-border, #e5e7eb);
            font-size: 14px;
        }

        .hours-breakdown-item:last-child {
            border-bottom: none;
        }

        .hours-breakdown-total {
            font-weight: bold;
            margin-top: var(--space-2, 8px);
            padding-top: var(--space-2, 8px);
            border-top: 2px solid var(--color-border, #e5e7eb);
        }

        .hours-edit-section {
            display: flex;
            align-items: center;
            gap: var(--space-2, 8px);
            margin-top: var(--space-4, 16px);
            padding: var(--space-3, 12px);
            background: rgba(59, 130, 246, 0.1);
            border-radius: var(--radius-md, 8px);
        }

        .hours-edit-section label {
            font-weight: 500;
            white-space: nowrap;
        }

        .hours-edit-section input {
            width: 80px;
            padding: 8px;
            border: 1px solid var(--color-border, #d1d5db);
            border-radius: var(--radius-sm, 4px);
            font-size: 16px;
            text-align: center;
        }

        .hours-edit-section input:focus {
            outline: none;
            border-color: var(--color-primary, #3b82f6);
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        /* Mobile */
        @media (max-width: 1400px) {
            .queue-section.werkstatt {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 1200px) {
            .queue-section {
                grid-template-columns: repeat(2, 1fr);
            }
            .queue-section.werkstatt {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 900px) {
            .main-container {
                grid-template-columns: 1fr;
            }
            .queue-section,
            .queue-section.werkstatt {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .queue-section,
            .queue-section.werkstatt {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <span class="logo">üìÖ</span>
            <div class="title">
                <h1>Tagesplanung</h1>
                <span class="subtitle">Priorisierung & Abteilungs-Queues</span>
            </div>
        </div>
        <div class="header-right">
            <input type="date" class="date-picker" id="datePicker">
            <button class="nav-btn success" onclick="saveTagesplan()">
                <span>üíæ</span> Speichern
            </button>
            <a href="kanban.html" class="nav-btn">
                <span>üìä</span> Kanban
            </a>
            <a href="liste.html" class="nav-btn">
                <span>üìã</span> Liste
            </a>
        </div>
    </header>

    <!-- Stats Bar -->
    <div class="stats-bar">
        <div class="stat-item">
            <span class="label">Ungeplant:</span>
            <span class="value" id="statUngeplant">0</span>
        </div>
        <div class="stat-item">
            <span class="label">Geplant:</span>
            <span class="value" id="statGeplant">0</span>
        </div>
        <div class="stat-item">
            <span class="label">Heute f√§llig:</span>
            <span class="value" id="statHeuteFaellig">0</span>
        </div>
        <div class="stat-item">
            <span class="label">√úberf√§llig:</span>
            <span class="value" id="statUeberfaellig" style="color: #ef4444;">0</span>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Ungeplant Section -->
        <div class="ungeplant-section">
            <div class="section-header">
                <span class="section-title">
                    ‚ö†Ô∏è Ungeplant
                    <span class="count-badge" id="ungeplantCount">0</span>
                </span>
                <select class="sort-select" id="sortSelect" onchange="sortUngeplant()">
                    <option value="dringlichkeit">Nach Dringlichkeit</option>
                    <option value="datum">Nach Eingangsdatum</option>
                    <option value="termin">Nach Termin</option>
                </select>
            </div>
            <div id="ungeplantList">
                <!-- Fahrzeuge werden hier eingef√ºgt -->
            </div>
        </div>

        <!-- Queue Container -->
        <div class="queues-container">
            <!-- LOGISTIK QUEUES -->
            <div class="queue-group">
                <div class="queue-group-title">üöö Logistik</div>
                <div class="queue-section">
                    <div class="queue-column logistik" data-queue="abholen">
                        <div class="queue-header">
                            <div class="icon">üöö</div>
                            <div class="name">Fzg. abholen</div>
                            <div class="queue-count"><span id="queueCountAbholen">0</span></div>
                            <div class="queue-capacity" id="capacityAbholen">0/8h</div>
                            <div class="capacity-bar"><div class="capacity-fill" id="capacityFillAbholen"></div></div>
                        </div>
                        <div class="queue-items" id="queueAbholen" data-queue="abholen">
                            <div class="empty-state">Hierher ziehen</div>
                        </div>
                    </div>
                    <div class="queue-column logistik" data-queue="liefern">
                        <div class="queue-header">
                            <div class="icon">üè†</div>
                            <div class="name">Fzg. liefern</div>
                            <div class="queue-count"><span id="queueCountLiefern">0</span></div>
                            <div class="queue-capacity" id="capacityLiefern">0/8h</div>
                            <div class="capacity-bar"><div class="capacity-fill" id="capacityFillLiefern"></div></div>
                        </div>
                        <div class="queue-items" id="queueLiefern" data-queue="liefern">
                            <div class="empty-state">Hierher ziehen</div>
                        </div>
                    </div>
                    <div class="queue-column logistik" data-queue="leih_bringen">
                        <div class="queue-header">
                            <div class="icon">üöó</div>
                            <div class="name">Leih bringen</div>
                            <div class="queue-count"><span id="queueCountLeih_bringen">0</span></div>
                            <div class="queue-capacity" id="capacityLeih_bringen">0/8h</div>
                            <div class="capacity-bar"><div class="capacity-fill" id="capacityFillLeih_bringen"></div></div>
                        </div>
                        <div class="queue-items" id="queueLeih_bringen" data-queue="leih_bringen">
                            <div class="empty-state">Hierher ziehen</div>
                        </div>
                    </div>
                    <div class="queue-column logistik" data-queue="leih_abholen">
                        <div class="queue-header">
                            <div class="icon">üîô</div>
                            <div class="name">Leih abholen</div>
                            <div class="queue-count"><span id="queueCountLeih_abholen">0</span></div>
                            <div class="queue-capacity" id="capacityLeih_abholen">0/8h</div>
                            <div class="capacity-bar"><div class="capacity-fill" id="capacityFillLeih_abholen"></div></div>
                        </div>
                        <div class="queue-items" id="queueLeih_abholen" data-queue="leih_abholen">
                            <div class="empty-state">Hierher ziehen</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- WERKSTATT QUEUES -->
            <div class="queue-group">
                <div class="queue-group-title">üîß Werkstatt (12 Abteilungen)</div>
                <div class="queue-section werkstatt">
                    <!-- Zeile 1 -->
                    <div class="queue-column" data-queue="lackier">
                        <div class="queue-header">
                            <div class="icon">üé®</div>
                            <div class="name">Lackierung</div>
                            <div class="queue-count"><span id="queueCountLackier">0</span></div>
                            <div class="queue-capacity" id="capacityLackier">0/8h</div>
                            <div class="capacity-bar"><div class="capacity-fill" id="capacityFillLackier"></div></div>
                        </div>
                        <div class="queue-items" id="queueLackier" data-queue="lackier">
                            <div class="empty-state">Hierher ziehen</div>
                        </div>
                    </div>
                    <div class="queue-column" data-queue="mechanik">
                        <div class="queue-header">
                            <div class="icon">üîß</div>
                            <div class="name">Mechanik</div>
                            <div class="queue-count"><span id="queueCountMechanik">0</span></div>
                            <div class="queue-capacity" id="capacityMechanik">0/8h</div>
                            <div class="capacity-bar"><div class="capacity-fill" id="capacityFillMechanik"></div></div>
                        </div>
                        <div class="queue-items" id="queueMechanik" data-queue="mechanik">
                            <div class="empty-state">Hierher ziehen</div>
                        </div>
                    </div>
                    <div class="queue-column" data-queue="reifen">
                        <div class="queue-header">
                            <div class="icon">üõû</div>
                            <div class="name">Reifen</div>
                            <div class="queue-count"><span id="queueCountReifen">0</span></div>
                            <div class="queue-capacity" id="capacityReifen">0/8h</div>
                            <div class="capacity-bar"><div class="capacity-fill" id="capacityFillReifen"></div></div>
                        </div>
                        <div class="queue-items" id="queueReifen" data-queue="reifen">
                            <div class="empty-state">Hierher ziehen</div>
                        </div>
                    </div>
                    <div class="queue-column" data-queue="pflege">
                        <div class="queue-header">
                            <div class="icon">‚ú®</div>
                            <div class="name">Pflege</div>
                            <div class="queue-count"><span id="queueCountPflege">0</span></div>
                            <div class="queue-capacity" id="capacityPflege">0/8h</div>
                            <div class="capacity-bar"><div class="capacity-fill" id="capacityFillPflege"></div></div>
                        </div>
                        <div class="queue-items" id="queuePflege" data-queue="pflege">
                            <div class="empty-state">Hierher ziehen</div>
                        </div>
                    </div>
                    <div class="queue-column" data-queue="tuev">
                        <div class="queue-header">
                            <div class="icon">üìã</div>
                            <div class="name">T√úV/AU</div>
                            <div class="queue-count"><span id="queueCountTuev">0</span></div>
                            <div class="queue-capacity" id="capacityTuev">0/8h</div>
                            <div class="capacity-bar"><div class="capacity-fill" id="capacityFillTuev"></div></div>
                        </div>
                        <div class="queue-items" id="queueTuev" data-queue="tuev">
                            <div class="empty-state">Hierher ziehen</div>
                        </div>
                    </div>
                    <div class="queue-column" data-queue="versicherung">
                        <div class="queue-header">
                            <div class="icon">üõ°Ô∏è</div>
                            <div class="name">Versicherung</div>
                            <div class="queue-count"><span id="queueCountVersicherung">0</span></div>
                            <div class="queue-capacity" id="capacityVersicherung">0/8h</div>
                            <div class="capacity-bar"><div class="capacity-fill" id="capacityFillVersicherung"></div></div>
                        </div>
                        <div class="queue-items" id="queueVersicherung" data-queue="versicherung">
                            <div class="empty-state">Hierher ziehen</div>
                        </div>
                    </div>
                    <!-- Zeile 2 -->
                    <div class="queue-column" data-queue="glas">
                        <div class="queue-header">
                            <div class="icon">ü™ü</div>
                            <div class="name">Glas</div>
                            <div class="queue-count"><span id="queueCountGlas">0</span></div>
                            <div class="queue-capacity" id="capacityGlas">0/8h</div>
                            <div class="capacity-bar"><div class="capacity-fill" id="capacityFillGlas"></div></div>
                        </div>
                        <div class="queue-items" id="queueGlas" data-queue="glas">
                            <div class="empty-state">Hierher ziehen</div>
                        </div>
                    </div>
                    <div class="queue-column" data-queue="klima">
                        <div class="queue-header">
                            <div class="icon">‚ùÑÔ∏è</div>
                            <div class="name">Klima</div>
                            <div class="queue-count"><span id="queueCountKlima">0</span></div>
                            <div class="queue-capacity" id="capacityKlima">0/8h</div>
                            <div class="capacity-bar"><div class="capacity-fill" id="capacityFillKlima"></div></div>
                        </div>
                        <div class="queue-items" id="queueKlima" data-queue="klima">
                            <div class="empty-state">Hierher ziehen</div>
                        </div>
                    </div>
                    <div class="queue-column" data-queue="dellen">
                        <div class="queue-header">
                            <div class="icon">üî®</div>
                            <div class="name">Dellen</div>
                            <div class="queue-count"><span id="queueCountDellen">0</span></div>
                            <div class="queue-capacity" id="capacityDellen">0/8h</div>
                            <div class="capacity-bar"><div class="capacity-fill" id="capacityFillDellen"></div></div>
                        </div>
                        <div class="queue-items" id="queueDellen" data-queue="dellen">
                            <div class="empty-state">Hierher ziehen</div>
                        </div>
                    </div>
                    <div class="queue-column" data-queue="folierung">
                        <div class="queue-header">
                            <div class="icon">üåà</div>
                            <div class="name">Folierung</div>
                            <div class="queue-count"><span id="queueCountFolierung">0</span></div>
                            <div class="queue-capacity" id="capacityFolierung">0/8h</div>
                            <div class="capacity-bar"><div class="capacity-fill" id="capacityFillFolierung"></div></div>
                        </div>
                        <div class="queue-items" id="queueFolierung" data-queue="folierung">
                            <div class="empty-state">Hierher ziehen</div>
                        </div>
                    </div>
                    <div class="queue-column" data-queue="steinschutz">
                        <div class="queue-header">
                            <div class="icon">üõ°Ô∏è</div>
                            <div class="name">Steinschutz</div>
                            <div class="queue-count"><span id="queueCountSteinschutz">0</span></div>
                            <div class="queue-capacity" id="capacitySteinschutz">0/8h</div>
                            <div class="capacity-bar"><div class="capacity-fill" id="capacityFillSteinschutz"></div></div>
                        </div>
                        <div class="queue-items" id="queueSteinschutz" data-queue="steinschutz">
                            <div class="empty-state">Hierher ziehen</div>
                        </div>
                    </div>
                    <div class="queue-column" data-queue="werbebeklebung">
                        <div class="queue-header">
                            <div class="icon">üì¢</div>
                            <div class="name">Werbung</div>
                            <div class="queue-count"><span id="queueCountWerbebeklebung">0</span></div>
                            <div class="queue-capacity" id="capacityWerbebeklebung">0/8h</div>
                            <div class="capacity-bar"><div class="capacity-fill" id="capacityFillWerbebeklebung"></div></div>
                        </div>
                        <div class="queue-items" id="queueWerbebeklebung" data-queue="werbebeklebung">
                            <div class="empty-state">Hierher ziehen</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div class="modal-overlay" id="detailModal">
        <div class="modal">
            <h3 id="modalTitle">Fahrzeug Details</h3>
            <div id="modalContent"></div>
            <div class="modal-actions">
                <button class="nav-btn" onclick="closeModal()">Schlie√üen</button>
            </div>
        </div>
    </div>

    <!-- Stunden-Details Modal -->
    <div class="modal-overlay" id="hoursModal">
        <div class="modal">
            <h3 id="hoursModalTitle">Arbeitszeit-Details</h3>
            <div id="hoursBreakdown">
                <!-- Aufschl√ºsselung wird dynamisch eingef√ºgt -->
            </div>
            <div class="hours-edit-section">
                <label>Manuelle Anpassung:</label>
                <input type="number" id="manualHoursInput" step="0.5" min="0.5" max="100" placeholder="0.0">
                <span>Stunden</span>
            </div>
            <div class="modal-actions">
                <button class="nav-btn" onclick="closeHoursModal()">Abbrechen</button>
                <button class="nav-btn primary" onclick="saveManualHours()">Speichern</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <!-- App Scripts -->
    <script src="firebase-config.js"></script>
    <script src="listener-registry.js"></script>
    <script src="js/auth-manager.js"></script>
    <script src="js/service-types.js"></script>
    <script src="js/permissions-helper.js"></script>
    <script src="js/toast.js"></script>

    <script>
        // ============================================
        // TAGESPLANUNG - JavaScript
        // ============================================

        // Global State
        let allFahrzeuge = [];
        let ungeplanteFahrzeuge = [];

        // ALL 16 QUEUES: 4 Logistik + 12 Service
        const ALL_QUEUES = [
            // Logistik (4)
            'abholen', 'liefern', 'leih_bringen', 'leih_abholen',
            // Service (12)
            'lackier', 'mechanik', 'reifen', 'pflege', 'tuev', 'versicherung',
            'glas', 'klima', 'dellen', 'folierung', 'steinschutz', 'werbebeklebung'
        ];

        let queuedFahrzeuge = {};
        ALL_QUEUES.forEach(q => queuedFahrzeuge[q] = []);

        let selectedDate = new Date();
        let hasUnsavedChanges = false;

        // ============================================
        // INITIALIZATION
        // ============================================

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üìÖ Tagesplanung wird initialisiert...');

            // Set date picker to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('datePicker').value = today;
            document.getElementById('datePicker').addEventListener('change', onDateChange);

            // Wait for Firebase
            try {
                await window.firebaseInitialized;
                console.log('‚úÖ Firebase initialisiert, werkstattId:', window.werkstattId);

                // Check permissions - WAIT for Auth State (Race Condition Fix!)
                // firebase.auth().currentUser is null until onAuthStateChanged fires
                console.log('‚è≥ Warte auf Auth State...');
                const authUser = await new Promise((resolve) => {
                    const unsubscribe = firebase.auth().onAuthStateChanged((user) => {
                        unsubscribe();  // Only fire once
                        resolve(user);
                    });
                });

                if (!authUser) {
                    console.warn('‚ö†Ô∏è Nicht eingeloggt - Redirect zu index.html');
                    alert('Bitte zuerst einloggen.');
                    window.safeNavigate ? window.safeNavigate('index.html') : window.location.href = 'index.html';
                    return;
                }
                console.log('‚úÖ Auth User gefunden:', authUser.email);

                // Rolle aus Firestore laden (users Collection ist global, kein Suffix)
                const userDoc = await firebase.firestore().collection('users').doc(authUser.uid).get();
                const role = userDoc.exists ? userDoc.data().role : 'mitarbeiter';
                console.log('üë§ User Role:', role, '(UID:', authUser.uid, ')');

                // werkstattId aus userDoc setzen falls noch nicht vorhanden (Race Condition Fix!)
                if (!window.werkstattId && userDoc.exists && userDoc.data().werkstattId) {
                    window.werkstattId = userDoc.data().werkstattId;
                    console.log('üè¢ werkstattId aus userDoc gesetzt:', window.werkstattId);
                }

                // Fallback: Warte kurz auf auth-manager Restore (max 2 Sekunden)
                if (!window.werkstattId) {
                    console.log('‚è≥ Warte auf werkstattId...');
                    let attempts = 0;
                    while (!window.werkstattId && attempts < 20) {
                        await new Promise(r => setTimeout(r, 100));
                        attempts++;
                    }
                    if (window.werkstattId) {
                        console.log('‚úÖ werkstattId nach Polling verf√ºgbar:', window.werkstattId);
                    } else {
                        console.error('‚ùå werkstattId konnte nicht geladen werden!');
                        alert('Fehler: Werkstatt-ID nicht gefunden. Bitte neu einloggen.');
                        window.safeNavigate ? window.safeNavigate('index.html') : window.location.href = 'index.html';
                        return;
                    }
                }

                if (role !== 'admin' && role !== 'werkstatt') {
                    alert('Zugriff nur f√ºr Werkstattleiter und Admins.');
                    window.safeNavigate ? window.safeNavigate('kanban.html') : window.location.href = 'kanban.html';
                    return;
                }

                await loadFahrzeuge();
                setupDragAndDrop();
                hideLoading();

            } catch (error) {
                console.error('‚ùå Initialisierungsfehler:', error);
                hideLoading();
                alert('Fehler beim Laden. Bitte Seite neu laden.');
            }
        });

        // ============================================
        // DATA LOADING
        // ============================================

        async function loadFahrzeuge() {
            console.log('üì• Lade Fahrzeuge...');

            const db = firebase.firestore();
            // FIX: getCollectionName gibt String zur√ºck, getCollection gibt CollectionReference!
            const collectionName = window.getCollectionName ? window.getCollectionName('fahrzeuge') : `fahrzeuge_${window.werkstattId}`;

            try {
                // Load active vehicles (not abgeschlossen)
                const snapshot = await db.collection(collectionName)
                    .where('status', 'not-in', ['abgeschlossen', 'storniert'])
                    .get();

                allFahrzeuge = [];
                snapshot.forEach(doc => {
                    allFahrzeuge.push({ id: doc.id, ...doc.data() });
                });

                console.log(`‚úÖ ${allFahrzeuge.length} Fahrzeuge geladen`);

                // Calculate dringlichkeit scores
                allFahrzeuge.forEach(f => {
                    f.dringlichkeitsScore = calculateDringlichkeitsScore(f);
                });

                // Separate ungeplant vs queued
                categorizeVehicles();
                renderAll();
                updateStats();

            } catch (error) {
                console.error('‚ùå Fehler beim Laden:', error);
            }
        }

        function categorizeVehicles() {
            const dateStr = document.getElementById('datePicker').value;

            ungeplanteFahrzeuge = [];
            // Reset all 16 queues
            queuedFahrzeuge = {};
            ALL_QUEUES.forEach(q => queuedFahrzeuge[q] = []);

            allFahrzeuge.forEach(f => {
                // Check if already queued for this date (abteilungsQueue for Service, logistikQueue for Logistik)
                const queue = f.abteilungsQueue || f.logistikQueue;
                if (f.queueDatum && queue) {
                    const queueDate = f.queueDatum.toDate ? f.queueDatum.toDate() : new Date(f.queueDatum);
                    const queueDateStr = queueDate.toISOString().split('T')[0];

                    if (queueDateStr === dateStr && queuedFahrzeuge[queue] !== undefined) {
                        queuedFahrzeuge[queue].push(f);
                        return;
                    }
                }

                // Add to ungeplant
                ungeplanteFahrzeuge.push(f);
            });

            // Sort queues by position
            ALL_QUEUES.forEach(queue => {
                queuedFahrzeuge[queue].sort((a, b) => (a.queuePosition || 999) - (b.queuePosition || 999));
            });

            // Sort ungeplant by dringlichkeit
            sortUngeplant();
        }

        // ============================================
        // DRINGLICHKEIT SCORING
        // ============================================

        function calculateDringlichkeitsScore(fahrzeug) {
            let score = 0;

            // 1. Termin-Dringlichkeit (max 50 Punkte)
            if (fahrzeug.abholtermin || fahrzeug.geplantesAbnahmeDatum) {
                const deadline = fahrzeug.abholtermin || fahrzeug.geplantesAbnahmeDatum;
                const deadlineDate = deadline.toDate ? deadline.toDate() : new Date(deadline);
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const daysUntil = Math.ceil((deadlineDate - today) / (1000 * 60 * 60 * 24));

                if (daysUntil <= 0) score += 50;      // √úberf√§llig
                else if (daysUntil === 1) score += 40; // Heute
                else if (daysUntil === 2) score += 30; // Morgen
                else if (daysUntil <= 7) score += 15;
            }

            // 2. Wartezeit im System (max 30 Punkte)
            if (fahrzeug.erstelltAm || fahrzeug.createdAt) {
                const created = fahrzeug.erstelltAm || fahrzeug.createdAt;
                const createdDate = typeof created === 'number' ? new Date(created) :
                                   (created.toDate ? created.toDate() : new Date(created));
                const daysWaiting = Math.floor((new Date() - createdDate) / (1000 * 60 * 60 * 24));
                score += Math.min(daysWaiting * 3, 30);
            }

            // 3. Quick-Job Bonus (max 20 Punkte)
            if (['reifen', 'pflege', 'tuev'].includes(fahrzeug.serviceTyp)) {
                score += 20;
            }

            return score;
        }

        function getDringlichkeitLevel(score) {
            if (score >= 50) return 'hoch';
            if (score >= 25) return 'mittel';
            return 'niedrig';
        }

        // ============================================
        // RENDERING
        // ============================================

        function renderAll() {
            renderUngeplant();
            renderQueues();
        }

        function renderUngeplant() {
            const container = document.getElementById('ungeplantList');
            document.getElementById('ungeplantCount').textContent = ungeplanteFahrzeuge.length;

            if (ungeplanteFahrzeuge.length === 0) {
                container.innerHTML = '<div class="empty-state">Alle Fahrzeuge sind eingeplant! üéâ</div>';
                return;
            }

            container.innerHTML = ungeplanteFahrzeuge.map(f => createFahrzeugCard(f)).join('');
        }

        function createFahrzeugCard(fahrzeug) {
            const serviceTyp = fahrzeug.serviceTyp || 'default';
            const serviceConfig = window.SERVICE_TYPE_CONFIG?.[serviceTyp] || { label: serviceTyp, icon: 'üìã' };
            const dringlichkeit = getDringlichkeitLevel(fahrzeug.dringlichkeitsScore || 0);

            // Format deadline
            let deadlineText = '';
            if (fahrzeug.abholtermin || fahrzeug.geplantesAbnahmeDatum) {
                const deadline = fahrzeug.abholtermin || fahrzeug.geplantesAbnahmeDatum;
                const deadlineDate = deadline.toDate ? deadline.toDate() : new Date(deadline);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const daysUntil = Math.ceil((deadlineDate - today) / (1000 * 60 * 60 * 24));

                if (daysUntil <= 0) deadlineText = '‚ö†Ô∏è √úberf√§llig';
                else if (daysUntil === 1) deadlineText = '‚è∞ Heute';
                else if (daysUntil === 2) deadlineText = 'üìÖ Morgen';
                else deadlineText = `üìÖ ${deadlineDate.toLocaleDateString('de-DE')}`;
            }

            return `
                <div class="fahrzeug-card" draggable="true" data-id="${fahrzeug.id}" data-service="${serviceTyp}"
                     ondragstart="onDragStart(event)">
                    <div class="dringlichkeit ${dringlichkeit}" title="Dringlichkeit: ${dringlichkeit}"></div>
                    <button class="info-btn" onclick="event.stopPropagation(); showDetails('${fahrzeug.id}')" title="Details">‚ÑπÔ∏è</button>
                    <div class="kennzeichen">${fahrzeug.kennzeichen || 'N/A'}</div>
                    <div class="info">
                        <span class="service-badge service-${serviceTyp}">${serviceConfig.icon || 'üìã'} ${serviceConfig.displayName || serviceTyp}</span>
                        ${deadlineText ? `<span>${deadlineText}</span>` : ''}
                    </div>
                </div>
            `;
        }

        function renderQueues() {
            ALL_QUEUES.forEach(queue => {
                // Build element ID (handle underscore in queue names like leih_bringen)
                const elementId = queue.split('_').map((part, i) =>
                    i === 0 ? capitalizeFirst(part) : capitalizeFirst(part)
                ).join('_');

                const container = document.getElementById(`queue${elementId}`);
                const countElement = document.getElementById(`queueCount${elementId}`);
                const items = queuedFahrzeuge[queue] || [];

                if (countElement) {
                    countElement.textContent = items.length;
                }

                if (!container) {
                    console.warn(`Queue container not found: queue${elementId}`);
                    return;
                }

                if (items.length === 0) {
                    container.innerHTML = '<div class="empty-state">Hierher ziehen</div>';
                } else {
                    container.innerHTML = items.map((f, index) => createQueueItem(f, index + 1, queue)).join('');
                }

                // Update Kapazit√§tsanzeige
                updateQueueCapacity(queue, elementId);
            });
        }

        // ============================================
        // KAPAZIT√ÑTS-MANAGEMENT (Phase 2)
        // ============================================

        function updateQueueCapacity(queue, elementId) {
            const items = queuedFahrzeuge[queue] || [];
            let totalHours = 0;

            items.forEach(f => {
                const hours = window.getEstimatedHours ? window.getEstimatedHours(f, queue) :
                              (f.geschaetzteStunden ||
                               window.SERVICE_DEFAULT_HOURS?.[f.serviceTyp] ||
                               window.SERVICE_DEFAULT_HOURS?.[queue] || 1.0);
                totalHours += hours;
            });

            const capacity = window.QUEUE_DEFAULT_CAPACITY || 8.0;
            const percentage = (totalHours / capacity) * 100;

            // Update Text
            const capacityEl = document.getElementById(`capacity${elementId}`);
            if (capacityEl) {
                capacityEl.textContent = `${totalHours.toFixed(1)}/${capacity}h`;

                // Status-Klassen
                capacityEl.classList.remove('warning', 'danger');
                if (percentage > 100) {
                    capacityEl.classList.add('danger');
                } else if (percentage > 80) {
                    capacityEl.classList.add('warning');
                }
            }

            // Update Progress Bar
            const fillEl = document.getElementById(`capacityFill${elementId}`);
            if (fillEl) {
                fillEl.style.width = Math.min(percentage, 100) + '%';
                fillEl.classList.remove('warning', 'danger');
                if (percentage > 100) {
                    fillEl.classList.add('danger');
                } else if (percentage > 80) {
                    fillEl.classList.add('warning');
                }
            }

            return { totalHours, capacity, percentage };
        }

        function createQueueItem(fahrzeug, position, queueId = null) {
            // Pr√ºfe ob KVA-Stunden vorhanden (genau) oder nur Sch√§tzung
            const kvaHours = window.calculateKvaHours ? window.calculateKvaHours(fahrzeug) : null;
            const hours = kvaHours ||
                          fahrzeug.geschaetzteStunden ||
                          window.SERVICE_DEFAULT_HOURS?.[fahrzeug.serviceTyp] ||
                          window.SERVICE_DEFAULT_HOURS?.[queueId] || 1.0;

            // Badge-Unterscheidung: KVA (gr√ºn) vs Default (grau)
            const badgeClass = kvaHours ? 'hours-badge kva' : 'hours-badge default';
            const badgeTitle = kvaHours ? 'Klicken f√ºr Details (KVA)' : 'Klicken f√ºr Details (Sch√§tzwert)';

            return `
                <div class="queue-item" draggable="true" data-id="${fahrzeug.id}"
                     ondragstart="onDragStart(event)">
                    <span class="position">${position}</span>
                    <span class="kennzeichen">${fahrzeug.kennzeichen || 'N/A'}</span>
                    <span class="${badgeClass}" title="${badgeTitle}" onclick="event.stopPropagation(); showHoursDetails('${fahrzeug.id}')">${typeof hours === 'number' ? hours.toFixed(1) : hours}h</span>
                    <button class="info-btn" onclick="event.stopPropagation(); showDetails('${fahrzeug.id}')" title="Details" style="position:static; opacity:1; margin-left:auto;">‚ÑπÔ∏è</button>
                    <button class="remove-btn" onclick="removeFromQueue('${fahrzeug.id}')" title="Entfernen">‚úï</button>
                </div>
            `;
        }

        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        // ============================================
        // DRAG & DROP
        // ============================================

        function setupDragAndDrop() {
            const queueContainers = document.querySelectorAll('.queue-items');

            queueContainers.forEach(container => {
                container.addEventListener('dragover', onDragOver);
                container.addEventListener('dragleave', onDragLeave);
                container.addEventListener('drop', onDrop);
            });

            // Also allow dropping back to ungeplant
            const ungeplantList = document.getElementById('ungeplantList');
            ungeplantList.addEventListener('dragover', onDragOver);
            ungeplantList.addEventListener('dragleave', onDragLeave);
            ungeplantList.addEventListener('drop', onDropToUngeplant);
        }

        function onDragStart(event) {
            const id = event.target.dataset.id;
            event.dataTransfer.setData('text/plain', id);
            event.target.classList.add('dragging');
        }

        function onDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('drag-over');
        }

        function onDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }

        function onDrop(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');

            const fahrzeugId = event.dataTransfer.getData('text/plain');
            const targetQueue = event.currentTarget.dataset.queue;

            if (!fahrzeugId || !targetQueue) return;

            moveToQueue(fahrzeugId, targetQueue);
        }

        function onDropToUngeplant(event) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');

            const fahrzeugId = event.dataTransfer.getData('text/plain');
            if (!fahrzeugId) return;

            removeFromQueue(fahrzeugId);
        }

        // ============================================
        // QUEUE MANAGEMENT
        // ============================================

        // Logistik-Queue IDs
        const LOGISTIK_QUEUES = ['abholen', 'liefern', 'leih_bringen', 'leih_abholen'];

        function moveToQueue(fahrzeugId, targetQueue) {
            // Find vehicle
            let fahrzeug = ungeplanteFahrzeuge.find(f => f.id === fahrzeugId);
            let sourceQueue = null;

            // Check if already in a queue
            if (!fahrzeug) {
                ALL_QUEUES.forEach(queue => {
                    const found = queuedFahrzeuge[queue]?.find(f => f.id === fahrzeugId);
                    if (found) {
                        fahrzeug = found;
                        sourceQueue = queue;
                    }
                });
            }

            if (!fahrzeug) {
                console.error('Fahrzeug nicht gefunden:', fahrzeugId);
                return;
            }

            // ============================================
            // ABH√ÑNGIGKEITS-CHECK (Phase 2)
            // ============================================
            if (window.canMoveToQueue) {
                const check = window.canMoveToQueue(fahrzeug, targetQueue);
                if (!check.allowed) {
                    if (window.toast && typeof window.toast.warning === 'function') {
                        window.toast.warning(check.reason);
                    } else {
                        alert(check.reason);
                    }
                    console.warn(`‚ö†Ô∏è Abh√§ngigkeit nicht erf√ºllt: ${check.reason}`);
                    return;
                }
            }

            // Remove from source
            if (sourceQueue) {
                queuedFahrzeuge[sourceQueue] = queuedFahrzeuge[sourceQueue].filter(f => f.id !== fahrzeugId);
            } else {
                ungeplanteFahrzeuge = ungeplanteFahrzeuge.filter(f => f.id !== fahrzeugId);
            }

            // Clear old queue assignments
            delete fahrzeug.abteilungsQueue;
            delete fahrzeug.logistikQueue;

            // Add to target queue (distinguish between Logistik and Service)
            if (LOGISTIK_QUEUES.includes(targetQueue)) {
                fahrzeug.logistikQueue = targetQueue;
            } else {
                fahrzeug.abteilungsQueue = targetQueue;
            }
            fahrzeug.queuePosition = (queuedFahrzeuge[targetQueue]?.length || 0) + 1;
            queuedFahrzeuge[targetQueue].push(fahrzeug);

            hasUnsavedChanges = true;
            renderAll();
            updateStats();

            const queueType = LOGISTIK_QUEUES.includes(targetQueue) ? 'üöö' : 'üîß';
            console.log(`${queueType} ${fahrzeug.kennzeichen} ‚Üí ${targetQueue} (Position ${fahrzeug.queuePosition})`);
        }

        function removeFromQueue(fahrzeugId) {
            let fahrzeug = null;

            ALL_QUEUES.forEach(queue => {
                const found = queuedFahrzeuge[queue]?.find(f => f.id === fahrzeugId);
                if (found) {
                    fahrzeug = found;
                    queuedFahrzeuge[queue] = queuedFahrzeuge[queue].filter(f => f.id !== fahrzeugId);
                }
            });

            if (fahrzeug) {
                delete fahrzeug.abteilungsQueue;
                delete fahrzeug.logistikQueue;
                delete fahrzeug.queuePosition;
                ungeplanteFahrzeuge.push(fahrzeug);

                hasUnsavedChanges = true;
                sortUngeplant();
                renderAll();
                updateStats();

                console.log(`‚Ü©Ô∏è ${fahrzeug.kennzeichen} zur√ºck zu Ungeplant`);
            }
        }

        // ============================================
        // SORTING
        // ============================================

        function sortUngeplant() {
            const sortBy = document.getElementById('sortSelect').value;

            ungeplanteFahrzeuge.sort((a, b) => {
                switch (sortBy) {
                    case 'dringlichkeit':
                        return (b.dringlichkeitsScore || 0) - (a.dringlichkeitsScore || 0);

                    case 'datum':
                        const dateA = a.createdAt || a.erstelltAm || 0;
                        const dateB = b.createdAt || b.erstelltAm || 0;
                        return (typeof dateB === 'number' ? dateB : 0) - (typeof dateA === 'number' ? dateA : 0);

                    case 'termin':
                        const deadlineA = a.abholtermin || a.geplantesAbnahmeDatum || null;
                        const deadlineB = b.abholtermin || b.geplantesAbnahmeDatum || null;
                        if (!deadlineA && !deadlineB) return 0;
                        if (!deadlineA) return 1;
                        if (!deadlineB) return -1;
                        const dateObjA = deadlineA.toDate ? deadlineA.toDate() : new Date(deadlineA);
                        const dateObjB = deadlineB.toDate ? deadlineB.toDate() : new Date(deadlineB);
                        return dateObjA - dateObjB;

                    default:
                        return 0;
                }
            });

            renderUngeplant();
        }

        // ============================================
        // SAVE
        // ============================================

        async function saveTagesplan() {
            if (!hasUnsavedChanges) {
                if (window.toast) {
                    window.toast.info('Keine √Ñnderungen zum Speichern.');
                } else {
                    alert('Keine √Ñnderungen zum Speichern.');
                }
                return;
            }

            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<span>‚è≥</span> Speichert...';

            try {
                const db = firebase.firestore();
                const batch = db.batch();
                // FIX: getCollectionName gibt String zur√ºck, getCollection gibt CollectionReference!
            const collectionName = window.getCollectionName ? window.getCollectionName('fahrzeuge') : `fahrzeuge_${window.werkstattId}`;
                const dateStr = document.getElementById('datePicker').value;
                const queueDate = new Date(dateStr);

                // Update queued vehicles (both Logistik and Service)
                ALL_QUEUES.forEach(queue => {
                    const isLogistik = LOGISTIK_QUEUES.includes(queue);
                    (queuedFahrzeuge[queue] || []).forEach((f, index) => {
                        const ref = db.collection(collectionName).doc(f.id);
                        const updateData = {
                            queuePosition: index + 1,
                            queueDatum: firebase.firestore.Timestamp.fromDate(queueDate),
                            prioritaet: index + 1
                        };

                        // Set correct queue field based on type
                        if (isLogistik) {
                            updateData.logistikQueue = queue;
                            updateData.abteilungsQueue = firebase.firestore.FieldValue.delete();
                        } else {
                            updateData.abteilungsQueue = queue;
                            updateData.logistikQueue = firebase.firestore.FieldValue.delete();
                        }

                        batch.update(ref, updateData);
                    });
                });

                // Clear queue data for vehicles returned to ungeplant
                ungeplanteFahrzeuge.forEach(f => {
                    if (f.abteilungsQueue !== undefined || f.logistikQueue !== undefined) {
                        const ref = db.collection(collectionName).doc(f.id);
                        batch.update(ref, {
                            abteilungsQueue: firebase.firestore.FieldValue.delete(),
                            logistikQueue: firebase.firestore.FieldValue.delete(),
                            queuePosition: firebase.firestore.FieldValue.delete(),
                            queueDatum: firebase.firestore.FieldValue.delete(),
                            prioritaet: firebase.firestore.FieldValue.delete()
                        });
                    }
                });

                await batch.commit();

                hasUnsavedChanges = false;

                if (window.toast) {
                    window.toast.success('Tagesplan gespeichert!');
                } else {
                    alert('Tagesplan gespeichert!');
                }

                console.log('‚úÖ Tagesplan gespeichert');

            } catch (error) {
                console.error('‚ùå Fehler beim Speichern:', error);
                if (window.toast) {
                    window.toast.error('Fehler beim Speichern: ' + error.message);
                } else {
                    alert('Fehler beim Speichern: ' + error.message);
                }
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>üíæ</span> Speichern';
            }
        }

        // ============================================
        // STATS
        // ============================================

        function updateStats() {
            let totalGeplant = 0;
            Object.values(queuedFahrzeuge).forEach(queue => {
                totalGeplant += queue.length;
            });

            document.getElementById('statUngeplant').textContent = ungeplanteFahrzeuge.length;
            document.getElementById('statGeplant').textContent = totalGeplant;

            // Calculate heute f√§llig and √ºberf√§llig
            let heuteFaellig = 0;
            let ueberfaellig = 0;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            allFahrzeuge.forEach(f => {
                const deadline = f.abholtermin || f.geplantesAbnahmeDatum;
                if (deadline) {
                    const deadlineDate = deadline.toDate ? deadline.toDate() : new Date(deadline);
                    deadlineDate.setHours(0, 0, 0, 0);
                    const diff = deadlineDate - today;

                    if (diff < 0) ueberfaellig++;
                    else if (diff === 0) heuteFaellig++;
                }
            });

            document.getElementById('statHeuteFaellig').textContent = heuteFaellig;
            document.getElementById('statUeberfaellig').textContent = ueberfaellig;
        }

        // ============================================
        // DATE CHANGE
        // ============================================

        function onDateChange() {
            if (hasUnsavedChanges) {
                if (!confirm('Ungespeicherte √Ñnderungen gehen verloren. Fortfahren?')) {
                    document.getElementById('datePicker').value = selectedDate.toISOString().split('T')[0];
                    return;
                }
            }

            hasUnsavedChanges = false;
            selectedDate = new Date(document.getElementById('datePicker').value);
            categorizeVehicles();
            renderAll();
            updateStats();
        }

        // ============================================
        // DETAIL MODAL
        // ============================================

        function showDetails(fahrzeugId) {
            const fahrzeug = allFahrzeuge.find(f => f.id === fahrzeugId);
            if (!fahrzeug) return;

            const serviceConfig = window.SERVICE_TYPE_CONFIG?.[fahrzeug.serviceTyp] || {};

            document.getElementById('modalTitle').textContent = fahrzeug.kennzeichen || 'Fahrzeug Details';
            document.getElementById('modalContent').innerHTML = `
                <p><strong>Service:</strong> ${serviceConfig.label || fahrzeug.serviceTyp}</p>
                <p><strong>Status:</strong> ${fahrzeug.status || 'N/A'}</p>
                <p><strong>Kunde:</strong> ${fahrzeug.kundenname || 'N/A'}</p>
                <p><strong>Marke/Modell:</strong> ${fahrzeug.marke || ''} ${fahrzeug.modell || ''}</p>
                ${fahrzeug.notizen ? `<p><strong>Notizen:</strong> ${fahrzeug.notizen}</p>` : ''}
                <p><strong>Dringlichkeit Score:</strong> ${fahrzeug.dringlichkeitsScore || 0}/100</p>
            `;

            document.getElementById('detailModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        // Close modal on outside click
        document.getElementById('detailModal').addEventListener('click', (e) => {
            if (e.target.id === 'detailModal') closeModal();
        });

        // ============================================
        // STUNDEN-DETAILS POPUP
        // ============================================

        let currentEditFahrzeugId = null;

        function showHoursDetails(fahrzeugId) {
            const fahrzeug = allFahrzeuge.find(f => f.id === fahrzeugId);
            if (!fahrzeug) return;

            currentEditFahrzeugId = fahrzeugId;

            // Titel setzen
            document.getElementById('hoursModalTitle').textContent =
                `Arbeitszeit: ${fahrzeug.kennzeichen || 'Fahrzeug'}`;

            // Aufschl√ºsselung erstellen
            const kvaHours = window.calculateKvaHours ? window.calculateKvaHours(fahrzeug) : null;
            let breakdownHtml = '';

            if (kvaHours && fahrzeug.kalkulationData) {
                // KVA vorhanden - zeige alle Positionen
                breakdownHtml = '<div class="hours-breakdown">';
                breakdownHtml += '<div style="color:#16a34a;font-weight:600;margin-bottom:8px;">‚úì Aus KVA berechnet:</div>';

                // Arbeitslohn-Positionen
                const arbeitslohn = fahrzeug.kalkulationData.arbeitslohn || [];
                arbeitslohn.forEach(pos => {
                    const stunden = parseFloat(pos.stunden) || 0;
                    if (stunden > 0) {
                        breakdownHtml += `
                            <div class="hours-breakdown-item">
                                <span>${pos.art || pos.position || 'Arbeit'}</span>
                                <span>${stunden.toFixed(1)}h</span>
                            </div>`;
                    }
                });

                // Lackierungs-Positionen
                const lackierung = fahrzeug.kalkulationData.lackierung || [];
                lackierung.forEach(pos => {
                    const stunden = parseFloat(pos.stunden) || 0;
                    if (stunden > 0) {
                        breakdownHtml += `
                            <div class="hours-breakdown-item">
                                <span>Lackierung: ${pos.bereich || pos.art || ''}</span>
                                <span>${stunden.toFixed(1)}h</span>
                            </div>`;
                    }
                });

                // Gesamt
                breakdownHtml += `
                    <div class="hours-breakdown-item hours-breakdown-total">
                        <span>GESAMT</span>
                        <span>${kvaHours.toFixed(1)}h</span>
                    </div>`;
                breakdownHtml += '</div>';
            } else {
                // Kein KVA - Default erkl√§ren
                const serviceConfig = window.SERVICE_TYPE_CONFIG?.[fahrzeug.serviceTyp] || {};
                const defaultHours = window.SERVICE_DEFAULT_HOURS?.[fahrzeug.serviceTyp] || 1.0;

                breakdownHtml = `
                    <div class="hours-breakdown" style="background:rgba(107,114,128,0.1);">
                        <div style="color:#6b7280;font-weight:600;margin-bottom:8px;">
                            ‚ö†Ô∏è Keine KVA vorhanden - Standard-Sch√§tzwert:
                        </div>
                        <div class="hours-breakdown-item">
                            <span>${serviceConfig.label || fahrzeug.serviceTyp || 'Unbekannt'}</span>
                            <span>${defaultHours.toFixed(1)}h (Default)</span>
                        </div>
                        <div style="font-size:12px;color:#9ca3af;margin-top:8px;">
                            üí° F√ºr genaue Zeiten: KVA/Kalkulation erstellen
                        </div>
                    </div>`;
            }

            // Falls manuell √ºberschrieben wurde
            if (fahrzeug.geschaetzteStunden && fahrzeug.geschaetzteStundenGeaendertVon) {
                breakdownHtml += `
                    <div style="font-size:12px;color:#3b82f6;margin-top:8px;padding:8px;background:rgba(59,130,246,0.05);border-radius:4px;">
                        ‚úèÔ∏è Manuell angepasst auf ${fahrzeug.geschaetzteStunden.toFixed(1)}h
                        von ${fahrzeug.geschaetzteStundenGeaendertVon}
                    </div>`;
            }

            document.getElementById('hoursBreakdown').innerHTML = breakdownHtml;

            // Aktuellen Wert ins Input setzen
            const currentHours = window.getEstimatedHours ? window.getEstimatedHours(fahrzeug) : 1.0;
            document.getElementById('manualHoursInput').value = currentHours.toFixed(1);

            // Modal √∂ffnen
            document.getElementById('hoursModal').classList.add('active');
        }

        async function saveManualHours() {
            if (!currentEditFahrzeugId) return;

            const manualHours = parseFloat(document.getElementById('manualHoursInput').value);
            if (isNaN(manualHours) || manualHours < 0.5) {
                alert('Bitte geben Sie einen g√ºltigen Wert ein (mind. 0.5h)');
                return;
            }

            try {
                // Disable button while saving
                const saveBtn = event.target;
                saveBtn.disabled = true;
                saveBtn.textContent = 'Speichern...';

                // In Firestore speichern
                const collectionName = window.getCollectionName ? window.getCollectionName('fahrzeuge') : 'fahrzeuge';
                await db.collection(collectionName).doc(currentEditFahrzeugId).update({
                    geschaetzteStunden: manualHours,
                    geschaetzteStundenGeaendertAm: firebase.firestore.FieldValue.serverTimestamp(),
                    geschaetzteStundenGeaendertVon: window.currentUser?.displayName || 'Werkstattleiter'
                });

                // Lokales Array aktualisieren
                const fahrzeug = allFahrzeuge.find(f => f.id === currentEditFahrzeugId);
                if (fahrzeug) {
                    fahrzeug.geschaetzteStunden = manualHours;
                    fahrzeug.geschaetzteStundenGeaendertVon = window.currentUser?.displayName || 'Werkstattleiter';
                }

                // Queue-Kapazit√§ten neu berechnen
                updateAllQueueCapacities();

                // UI aktualisieren
                renderAllQueues();

                // Modal schlie√üen
                closeHoursModal();

                console.log(`‚úì Stunden f√ºr ${currentEditFahrzeugId} auf ${manualHours}h gesetzt`);

                // Zeige kurze Best√§tigung
                if (window.showToast) {
                    window.showToast(`Arbeitszeit auf ${manualHours}h ge√§ndert`, 'success');
                }
            } catch (error) {
                console.error('Fehler beim Speichern:', error);
                alert('Fehler beim Speichern der Stunden: ' + error.message);
            } finally {
                // Re-enable button
                const saveBtn = document.querySelector('#hoursModal .nav-btn.primary');
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Speichern';
                }
            }
        }

        function closeHoursModal() {
            document.getElementById('hoursModal').classList.remove('active');
            currentEditFahrzeugId = null;
        }

        // Close hours modal on outside click
        document.getElementById('hoursModal').addEventListener('click', (e) => {
            if (e.target.id === 'hoursModal') closeHoursModal();
        });

        // ============================================
        // HELPERS
        // ============================================

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // Warn before leaving with unsaved changes
        window.addEventListener('beforeunload', (e) => {
            if (hasUnsavedChanges) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>
</html>
