<!DOCTYPE html>
<html lang="de">
<head>
    <!-- werkstattId will be set dynamically by auth-manager.js after login -->
    <script>
        // window.werkstattId is set automatically after successful login
        // This ensures proper multi-tenant data isolation
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Fahrzeug-Abnahme | Auto-Lackierzentrum Mosbach</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Design System -->
    <link rel="stylesheet" href="design-system.css?v=af6b90f">
    <link rel="stylesheet" href="components.css?v=af6b90f">
    <link rel="stylesheet" href="animations.css?v=af6b90f">
    <link rel="stylesheet" href="mobile-first.css?v=af6b90f">
    <link rel="stylesheet" href="css/ai-chat-widget.css">
    <link rel="stylesheet" href="abnahme-styles.css?v=uifix001">

    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>

    <!-- GSAP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- jsPDF autoTable Plugin for Excel-Style Tables (Nov 21, 2025) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

    <!-- Firebase Konfiguration -->
    <script src="firebase-config.js?v=a4192c4"></script>

    <!-- Auth Manager f√ºr Multi-Tenant Support -->
    <script src="js/auth-manager.js"></script>
    <script src="js/settings-manager.js"></script>
    <script src="js/permissions-helper.js"></script>

    <!-- Image Optimizer -->
    <script src="image-optimizer.js"></script>

    <!-- Global Chat Notifications -->
    <link rel="stylesheet" href="global-chat-notifications.css">
    <script src="global-chat-notifications.js"></script>

    <style>
        /* ============================================
           üíé PREMIUM ABNAHME-SEITE STYLES
           Reveal-Erlebnis mit Cyan Brand (#26c6ff)
           ============================================ */

        /* üé® Feature 8: Premium Farbschema (Cyan Brand) */
        :root {
            --color-primary-premium: #26c6ff !important;
            --color-primary-hover-premium: #4dd4ff !important;
            --color-accent-premium: #97e2ff !important;
        }

        /* Override Design System Primary Colors */
        .btn-primary,
        .hero-card__header i {
            --color-primary: #26c6ff;
            --color-primary-hover: #4dd4ff;
        }

        /* üåü Feature 7: Globaler Licht-Layer */
        body::after {
            content: "";
            position: fixed;
            inset: 0;
            background: radial-gradient(
                circle at 40% 30%,
                rgba(255,255,255,0.05),
                transparent 60%
            );
            pointer-events: none;
            z-index: 0;
        }

        /* Alle Container m√ºssen √ºber Licht-Layer liegen */
        .container,
        .mobile-header,
        .theme-toggle,
        .accent-light,
        .bottom-nav {
            position: relative;
            z-index: 10;
        }

        /* üí´ Feature 1: Spotlight-Section f√ºr Foto-Vergleich */
        .photo-comparison-spotlight {
            background: radial-gradient(
                circle at 50% 20%,
                rgba(255,255,255,0.05),
                rgba(0,0,0,0.85)
            );
            border-radius: 24px;
            backdrop-filter: blur(35px) saturate(150%);
            -webkit-backdrop-filter: blur(35px) saturate(150%);
            box-shadow:
                inset 0 1px 2px rgba(255,255,255,0.15),
                0 12px 40px rgba(0,0,0,0.6);
            padding: 2rem;
            position: relative;
            overflow: hidden;
            margin-bottom: var(--space-6);
        }

        /* ‚úçÔ∏è Feature 3: Signature Panel (Haptisch) */
        .signature-card {
            background: rgba(255,255,255,0.07) !important;
            border: 1px solid rgba(255,255,255,0.15) !important;
            border-radius: 16px !important;
            box-shadow:
                inset 0 1px 3px rgba(255,255,255,0.25),
                inset 0 -2px 6px rgba(0,0,0,0.5),
                0 8px 24px rgba(0,0,0,0.4) !important;
            padding: 1.5rem !important;
        }

        #signatureCanvas {
            background: rgba(255,255,255,0.04) !important;
            border-radius: 12px !important;
            box-shadow: inset 0 1px 2px rgba(255,255,255,0.2) !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
        }

        /* ‚ö° Feature 4: Metall-Glow Buttons */
        .btn-primary {
            background: linear-gradient(
                135deg,
                rgba(38, 198, 255, 0.3),
                rgba(255,255,255,0.15)
            ) !important;
            border: 1px solid rgba(255,255,255,0.25) !important;
            box-shadow: 0 0 12px rgba(38, 198, 255, 0.25) !important;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: all 0.25s ease !important;
        }

        .btn-primary:hover {
            box-shadow: 0 0 24px rgba(38, 198, 255, 0.6) !important;
            transform: translateY(-2px) !important;
            background: linear-gradient(
                135deg,
                rgba(38, 198, 255, 0.5),
                rgba(255,255,255,0.2)
            ) !important;
        }

        /* üé¨ Feature 5: Success Animation */
        .success-flash {
            animation: flash 0.7s ease-out;
        }

        @keyframes flash {
            0% {
                background: rgba(255,255,255,0.3);
                box-shadow: 0 0 80px rgba(38, 198, 255, 0.8);
            }
            100% {
                background: transparent;
                box-shadow: none;
            }
        }

        .success-checkmark {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 120px;
            height: 120px;
            background: rgba(38, 198, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: checkmark-pop 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .success-checkmark svg {
            width: 64px;
            height: 64px;
            color: #26c6ff;
            filter: drop-shadow(0 0 20px rgba(38, 198, 255, 0.8));
        }

        @keyframes checkmark-pop {
            0% {
                transform: translate(-50%, -50%) scale(0) rotate(-180deg);
                opacity: 0;
            }
            100% {
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        /* üìä Feature 6: Progress Indicator */
        .progress-steps {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 3rem;
            margin-bottom: 2rem;
            padding: 1rem 0;
        }

        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            position: relative;
        }

        .progress-step__circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
            color: var(--color-text-secondary);
            transition: all 0.3s ease;
        }

        .progress-step__label {
            font-size: 12px;
            color: var(--color-text-tertiary);
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .progress-step--active .progress-step__circle {
            background: #26c6ff;
            border-color: #26c6ff;
            color: white;
            box-shadow: 0 0 20px rgba(38, 198, 255, 0.6);
            transform: scale(1.1);
        }

        .progress-step--active .progress-step__label {
            color: #26c6ff;
            font-weight: 600;
        }

        .progress-step--completed .progress-step__circle {
            background: rgba(38, 198, 255, 0.3);
            border-color: rgba(38, 198, 255, 0.5);
            color: #4dd4ff;
        }

        .progress-step--completed .progress-step__label {
            color: var(--color-text-secondary);
        }

        /* Line between steps */
        .progress-step:not(:last-child)::after {
            content: "";
            position: absolute;
            top: 20px;
            left: calc(100% + 0.5rem);
            width: 2rem;
            height: 2px;
            background: rgba(255,255,255,0.2);
        }

        .progress-step--completed:not(:last-child)::after {
            background: rgba(38, 198, 255, 0.5);
        }

        /* üé® Premium Shadow Tuning */
        .hero-card,
        .welcome-banner {
            box-shadow:
                0 12px 40px rgba(0, 20, 40, 0.7),
                0 0 20px rgba(38, 198, 255, 0.15) !important;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .progress-steps {
                gap: 1.5rem;
            }

            .progress-step__circle {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }

            .progress-step__label {
                font-size: 10px;
            }

            .progress-step:not(:last-child)::after {
                width: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- üì± MOBILE HEADER - Sticky Top (Mobile Only) -->
    <header class="mobile-header">
        <div class="mobile-header__logo">
            <i data-feather="check-circle"></i>
            <span>Fahrzeug-Abnahme</span>
        </div>
        <div class="mobile-header__actions">
            <button class="mobile-header__icon" aria-label="Benachrichtigungen">
                <i data-feather="bell"></i>
                <span class="mobile-header__badge">0</span>
            </button>
        </div>
    </header>

    <!-- THEME TOGGLE BUTTON - Fixed Top-Right -->
    <button id="themeToggle" class="theme-toggle" aria-label="Toggle Light/Dark Mode">
        <i data-feather="sun" class="theme-toggle__icon theme-toggle__icon--light"></i>
        <i data-feather="moon" class="theme-toggle__icon theme-toggle__icon--dark"></i>
    </button>

    <!-- ACCENT-LIGHT (Parallax) -->
    <div class="accent-light"></div>

    <!-- PAGE TRANSITION OVERLAY -->
    <div class="page-transition-overlay"></div>

    <!-- Hero Section -->
    <div class="hero">
        <h1 class="hero__title">Fahrzeug-Abnahme</h1>
        <p class="hero__subtitle">Auto-Lackierzentrum Mosbach</p>
        <div class="hero__version">
            <i data-feather="calendar"></i>
            Heute: <strong id="currentDate"></strong>
        </div>
    </div>

    <!-- üìä Progress Indicator (Feature 6) -->
    <div class="progress-steps">
        <div class="progress-step progress-step--completed">
            <div class="progress-step__circle">1</div>
            <span class="progress-step__label">Annahme</span>
        </div>
        <div class="progress-step progress-step--completed">
            <div class="progress-step__circle">2</div>
            <span class="progress-step__label">Fotos</span>
        </div>
        <div class="progress-step progress-step--active">
            <div class="progress-step__circle">3</div>
            <span class="progress-step__label">Abnahme</span>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">

        <!-- Welcome Banner -->
        <div class="welcome-banner">
            <div class="welcome-banner__icon">
                <i data-feather="info"></i>
            </div>
            <div class="welcome-banner__content">
                <h2>Fahrzeug-Abnahme</h2>
                <p>W√§hlen Sie ein Fahrzeug aus dem Dropdown oder geben Sie das Kennzeichen manuell ein. Machen Sie Nachher-Fotos aus den gleichen Winkeln wie die Vorher-Fotos.</p>
            </div>
        </div>

        <!-- Messages -->
        <div id="errorMessage" class="message message--error" style="display: none;">
            <i data-feather="alert-circle"></i>
            <span></span>
        </div>
        <div id="successMessage" class="message message--success" style="display: none;">
            <i data-feather="check-circle"></i>
            <span>Fahrzeug erfolgreich abgenommen!</span>
        </div>

        <!-- Vehicle Selection - Hero Card -->
        <div class="hero-card" id="selectionCard">
            <div class="shine-overlay"></div>
            <div class="hero-card__header">
                <i data-feather="truck"></i>
                <h3>Fahrzeug ausw√§hlen</h3>
            </div>

            <div class="form-group">
                <label for="vehicleDropdown" class="form-label">
                    Angenommene Fahrzeuge
                </label>
                <select id="vehicleDropdown" class="form-select" onchange="selectFromDropdown()">
                    <option value="">-- Fahrzeug ausw√§hlen --</option>
                </select>
            </div>

            <div class="divider-text">
                <span>ODER</span>
            </div>

            <div class="form-group">
                <label for="kennzeichenSearch" class="form-label">
                    Kennzeichen manuell eingeben
                </label>
                <div class="search-input-group">
                    <input type="text" id="kennzeichenSearch" class="form-input" placeholder="z.B. MOS-CG 123">
                    <button class="btn btn-primary" onclick="searchVehicle()">
                        <i data-feather="search"></i>
                        Suchen
                    </button>
                </div>
            </div>
        </div>

        <!-- Vehicle Info - Hero Card (dynamisch bef√ºllt) -->
        <div class="hero-card" id="vehicleInfo" style="display: none;">
            <div class="shine-overlay"></div>
            <!-- Content wird dynamisch via JavaScript eingef√ºgt -->
        </div>

        <!-- Photo Comparison - Hero Card (Feature 1: Spotlight) -->
        <div class="hero-card photo-comparison-spotlight" id="photoComparison" style="display: none;">
            <div class="shine-overlay"></div>
            <div class="hero-card__header">
                <i data-feather="camera"></i>
                <h3>Foto-Vergleich</h3>
            </div>

            <div class="photo-comparison-container">
                <!-- VORHER Spalte -->
                <div>
                    <h4 class="photo-column-header">
                        <i data-feather="arrow-left"></i>
                        VORHER (Annahme)
                    </h4>
                    <div class="photo-grid" id="vorherGrid"></div>
                </div>

                <!-- NACHHER Spalte -->
                <div>
                    <h4 class="photo-column-header">
                        <i data-feather="arrow-right"></i>
                        NACHHER (Abnahme)
                    </h4>
                    <div class="photo-grid" id="nachherGrid">
                        <div class="photo-item empty" onclick="document.getElementById('photoInput').click()">
                            <i data-feather="camera"></i>
                        </div>
                    </div>
                    <input type="file" id="photoInput" accept="image/*" capture="environment" multiple style="display: none;">
                </div>
            </div>
        </div>

        <!-- Signature Section - Hero Card (Feature 3: Haptisch) -->
        <div class="hero-card signature-card" id="signatureSection" style="display: none;">
            <div class="shine-overlay"></div>
            <div class="hero-card__header">
                <i data-feather="edit-3"></i>
                <h3>Unterschrift Kunde (Abnahme) *</h3>
            </div>

            <canvas id="signatureCanvas" width="800" height="400"></canvas>

            <div class="signature-buttons">
                <button type="button" class="btn btn-secondary" onclick="clearSignature()">
                    <i data-feather="trash-2"></i>
                    L√∂schen
                </button>
            </div>
        </div>

        <!-- Submit Button -->
        <button type="button" class="btn btn-primary btn-lg btn-full-width" id="submitBtn" onclick="submitAbnahme()" style="display: none;">
            <i data-feather="check-circle"></i>
            Abnahme abschlie√üen & PDF erstellen
        </button>
    </div>

    <script>
        // Firebase initialisieren
        let firebaseInitialized = false;
        let localFirebaseApp; // Lokale Kopie von window.firebaseApp (firebase-config.js hat bereits 'let firebaseApp' im globalen Scope)

        // Canvas-Variablen (MUSS vor Verwendung in searchVehicle() definiert sein!)
        const canvas = document.getElementById('signatureCanvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let hasDrawn = false;

        // ============================================
        // NACHBESTELLUNGEN √úBERTRAGEN (NEU 2025-11-12)
        // ============================================
        /**
         * √úbertr√§gt angelieferte Bestellungen beim Fahrzeug-Abschluss
         * @param {string} fahrzeugId - ID des Fahrzeugs
         * @returns {Promise<{angeliefert: number, offen: number}>} Statistik
         */
        async function transferNachbestellungenBeimAbschluss(fahrzeugId) {
            if (!window.firebaseInitialized || !window.db) {
                console.warn('‚ö†Ô∏è [NACHBESTELLUNGEN] Firebase nicht initialisiert');
                return { angeliefert: 0, offen: 0 };
            }

            try {
                // 1. Lade alle Bestellungen f√ºr dieses Fahrzeug
                const bestellungenSnapshot = await window.getCollection('bestellungen')
                    .where('fahrzeugId', '==', fahrzeugId)
                    .get();

                console.log(`üì¶ [NACHBESTELLUNGEN] ${bestellungenSnapshot.size} Bestellungen gefunden f√ºr Fahrzeug ${fahrzeugId}`);

                if (bestellungenSnapshot.empty) {
                    return { angeliefert: 0, offen: 0 };
                }

                const angelieferteBestellungen = [];
                const offeneBestellungen = [];

                bestellungenSnapshot.forEach(doc => {
                    const bestellung = doc.data();
                    if (bestellung.status === 'angeliefert') {
                        angelieferteBestellungen.push(bestellung);
                    } else if (bestellung.status === 'bestellt') {
                        offeneBestellungen.push(bestellung);
                    }
                });

                console.log(`üìä [NACHBESTELLUNGEN] Angeliefert: ${angelieferteBestellungen.length}, Offen: ${offeneBestellungen.length}`);

                // 2. √úbertrage angelieferte Bestellungen ins Fahrzeug
                if (angelieferteBestellungen.length > 0) {
                    const nachbestellungen = angelieferteBestellungen.map(b => ({
                        bestellungId: b.id,
                        etn: b.etn,
                        benennung: b.benennung,
                        menge: b.menge,
                        einzelpreis: b.einzelpreis,
                        preisTatsaechlich: b.preisTatsaechlich || b.einzelpreis,
                        gesamtpreis: b.menge * (b.preisTatsaechlich || b.einzelpreis),
                        angeliefertAm: b.angeliefertAm,
                        lieferant: b.lieferant || null
                    }));

                    // Update Fahrzeug mit nachbestellungen
                    await window.getCollection('fahrzeuge').doc(fahrzeugId).update({
                        nachbestellungen: nachbestellungen
                    });

                    console.log(`‚úÖ [NACHBESTELLUNGEN] ${nachbestellungen.length} Bestellungen in Fahrzeug √ºbertragen`);
                }

                return {
                    angeliefert: angelieferteBestellungen.length,
                    offen: offeneBestellungen.length
                };

            } catch (error) {
                console.error('‚ùå [NACHBESTELLUNGEN] Fehler:', error);
                throw error;
            }
        }

        window.addEventListener('load', async function() {
            // Feather Icons initialisieren
            if (typeof feather !== 'undefined') {
                feather.replace();
            }

            // Firebase initialisieren
            try {
                if (typeof initFirebase !== 'undefined') {
                    await initFirebase();
                    if (window.firebaseInitialized && window.firebaseApp) {
                        localFirebaseApp = window.firebaseApp;
                        firebaseInitialized = true;
                        console.log('‚úÖ Firebase f√ºr Abnahme initialisiert');

                        // Auth-Check f√ºr Multi-Tenant Support (Race Condition Fix)
                        console.log('üîê [ABNAHME] Pr√ºfe Auth State f√ºr Multi-Tenant...');
                        let currentUser = null;
                        let attempts = 0;
                        const maxAttempts = 20;

                        while (!currentUser && attempts < maxAttempts) {
                            currentUser = window.authManager?.getCurrentUser();
                            if (!currentUser) {
                                console.log(`‚è≥ [ABNAHME] Warte auf Auth State (${attempts + 1}/${maxAttempts})...`);
                                await new Promise(resolve => setTimeout(resolve, 250));
                                attempts++;
                            }
                        }

                        if (!currentUser) {
                            console.warn('‚ö†Ô∏è [ABNAHME] Kein User eingeloggt - verwende globale Collections');
                        } else {
                            console.log('‚úÖ [ABNAHME] Auth State geladen');
                            console.log('   User:', currentUser.name);
                            console.log('   WerkstattId:', currentUser.werkstattId);

                            // üÜï BUGFIX 2025-11-04 (FIX #41): Partner-Zugriff auf Werkstatt-Seiten blockieren
                            // Partner d√ºrfen nur das Partner-Portal nutzen, nicht Werkstatt-Seiten
                            const userRole = currentUser.rolle || currentUser.role; // Support both property names
                            if (userRole === 'partner') {
                                console.warn('üö´ Partner-Zugriff blockiert! Redirect zu Partner-Portal...');
                                window.location.href = './partner-app/meine-anfragen.html';
                                return; // Stop further execution
                            }
                        }
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Firebase nicht verf√ºgbar, verwende LocalStorage:', error);
            }

            // Dropdown mit angenommenen Fahrzeugen laden
            await loadDropdownVehicles();

            // GSAP Animations (Hero-Card kompatibel)
            if (typeof gsap !== 'undefined') {
                // Hero Section
                const hero = document.querySelector('.hero');
                if (hero) {
                    gsap.fromTo(hero,
                        { opacity: 0, y: -30 },
                        { opacity: 1, y: 0, duration: 0.6, ease: "power2.out" }
                    );
                }

                // Welcome Banner
                const welcomeBanner = document.querySelector('.welcome-banner');
                if (welcomeBanner) {
                    gsap.fromTo(welcomeBanner,
                        { opacity: 0, x: -20 },
                        { opacity: 1, x: 0, duration: 0.6, delay: 0.1, ease: "power2.out" }
                    );
                }

                // Hero Cards (staggered)
                const heroCards = document.querySelectorAll('.hero-card');
                if (heroCards.length > 0) {
                    gsap.fromTo(heroCards,
                        { opacity: 0, y: 40 },
                        { opacity: 1, y: 0, duration: 0.6, delay: 0.2, stagger: 0.1, ease: "power2.out" }
                    );
                }
            }
        });

        // Aktuelles Datum anzeigen
        const heute = new Date();
        document.getElementById('currentDate').textContent = heute.toLocaleDateString('de-DE', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });

        let currentVehicle = null;
        let nachherPhotos = [];

        // Dropdown mit angenommenen Fahrzeugen laden
        async function loadDropdownVehicles() {
            console.log('üîÑ loadDropdownVehicles() aufgerufen...');

            const dropdown = document.getElementById('vehicleDropdown');
            if (!dropdown) {
                console.error('‚ùå Dropdown-Element nicht gefunden!');
                return;
            }

            try {
                let vehicles = [];

                // Status-Filter: Nur Fahrzeuge die bereit zur Abnahme sind
                const readyStatuses = ['bereit', 'fertig', 'abholbereit'];

                if (firebaseInitialized && localFirebaseApp) {
                    const allVehicles = await localFirebaseApp.getAllFahrzeuge();
                    vehicles = allVehicles.filter(v =>
                        readyStatuses.includes(v.prozessStatus) &&
                        v.status !== 'abgeschlossen' &&
                        v.status !== 'storniert'
                    );
                    console.log('‚úÖ Dropdown geladen: ' + vehicles.length + ' Fahrzeuge (bereit zur Abnahme)');
                } else {
                    const fahrzeuge = JSON.parse(localStorage.getItem('fahrzeuge') || '[]');
                    vehicles = fahrzeuge.filter(v =>
                        readyStatuses.includes(v.prozessStatus) &&
                        v.status !== 'abgeschlossen' &&
                        v.status !== 'storniert'
                    );
                    console.log('‚úÖ Dropdown geladen (LocalStorage): ' + vehicles.length + ' Fahrzeuge (bereit zur Abnahme)');
                }

                // Migration: Alte baujahr-Werte konvertieren
                vehicles = vehicles.map(v => {
                    if (!v.baujahrVon && v.baujahr) {
                        v.baujahrVon = v.baujahr;
                        if (v.baujahr !== '√Ñlter') {
                            v.baujahrBis = v.baujahr;
                        }
                    }
                    return v;
                });

                // Dropdown leeren
                dropdown.innerHTML = '<option value="">-- Fahrzeug ausw√§hlen --</option>';

                // Fahrzeuge nach ID sortieren (neueste zuerst)
                vehicles.sort((a, b) => b.id - a.id);

                // Dropdown bef√ºllen (alle Fahrzeuge sind bereit zur Abnahme)
                vehicles.forEach(vehicle => {
                    const option = document.createElement('option');
                    option.value = vehicle.kennzeichen;
                    option.textContent = `${vehicle.kennzeichen} - ${vehicle.marke} ${vehicle.modell} - ${vehicle.kundenname}`;
                    dropdown.appendChild(option);
                });

                if (vehicles.length === 0) {
                    dropdown.innerHTML = '<option value="">Keine Fahrzeuge bereit zur Abnahme</option>';
                    dropdown.disabled = true;
                } else {
                    dropdown.disabled = false;
                }

            } catch (error) {
                console.error('‚ùå Fehler beim Laden des Dropdowns:', error);
                dropdown.innerHTML = '<option value="">Fehler beim Laden der Fahrzeuge</option>';
                dropdown.disabled = true;
            }
        }

        // Fahrzeug aus Dropdown ausw√§hlen
        async function selectFromDropdown() {
            const dropdown = document.getElementById('vehicleDropdown');
            const kennzeichen = dropdown.value;

            if (!kennzeichen) {
                resetForm();
                return;
            }

            document.getElementById('kennzeichenSearch').value = kennzeichen;
            await searchVehicle();
        }

        // Fahrzeug suchen
        async function searchVehicle() {
            const kennzeichen = document.getElementById('kennzeichenSearch').value.trim().toUpperCase();

            if (!kennzeichen) {
                showError('Bitte Kennzeichen eingeben!');
                return;
            }

            let vehicle = null;

            try {
                if (firebaseInitialized && localFirebaseApp) {
                    const allVehicles = await localFirebaseApp.getAllFahrzeuge();
                    vehicle = allVehicles.find(v => v.kennzeichen.toUpperCase() === kennzeichen && v.status !== 'abgeschlossen' && v.status !== 'storniert');
                } else {
                    const fahrzeuge = JSON.parse(localStorage.getItem('fahrzeuge') || '[]');
                    vehicle = fahrzeuge.find(v => v.kennzeichen.toUpperCase() === kennzeichen && v.status !== 'abgeschlossen' && v.status !== 'storniert');
                }
            } catch (error) {
                console.error('‚ùå Fehler beim Suchen:', error);
                const fahrzeuge = JSON.parse(localStorage.getItem('fahrzeuge') || '[]');
                vehicle = fahrzeuge.find(v => v.kennzeichen.toUpperCase() === kennzeichen && v.status !== 'abgeschlossen' && v.status !== 'storniert');
            }

            if (!vehicle) {
                showError(`Kein angenommenes Fahrzeug mit Kennzeichen "${kennzeichen}" gefunden!`);
                resetForm();
                return;
            }

            // Fotos aus Firestore nachladen
            if (firebaseInitialized && localFirebaseApp && (!vehicle.photos || vehicle.photos.length === 0)) {
                console.log('üì∏ Lade Fotos f√ºr Fahrzeug:', vehicle.id);
                try {
                    const allPhotos = await localFirebaseApp.loadAllPhotosFromFirestore(vehicle.id);
                    vehicle.photos = allPhotos.vorher || [];
                    vehicle.nachherPhotos = allPhotos.nachher || [];
                    console.log('‚úÖ Fotos aus Firestore geladen');
                } catch (e) {
                    console.error('‚ùå Fehler beim Laden der Fotos:', e);
                    vehicle.photos = [];
                    vehicle.nachherPhotos = [];
                }
            }

            currentVehicle = vehicle;
            displayVehicleInfo(vehicle);
            document.getElementById('photoComparison').style.display = 'block';
            document.getElementById('signatureSection').style.display = 'block';
            document.getElementById('submitBtn').style.display = 'flex';

            // Canvas initialisieren (nur einmal)
            if (!canvas.hasAttribute('data-initialized')) {
                setTimeout(() => {
                    initCanvas();
                    canvas.setAttribute('data-initialized', 'true');
                    feather.replace();
                }, 50);
            } else {
                feather.replace();
            }
        }

        // Fahrzeug-Infos anzeigen (Hero-Card kompatibel)
        function displayVehicleInfo(vehicle) {
            const infoDiv = document.getElementById('vehicleInfo');
            infoDiv.innerHTML = `
                <div class="hero-card__header">
                    <i data-feather="file-text"></i>
                    <h3>Fahrzeug-Informationen</h3>
                </div>
                <div class="hero-card__content" style="margin-top: var(--space-4);">
                    <p style="color: var(--color-text-primary); font-size: var(--font-size-sm); margin-bottom: var(--space-2);"><strong>Kennzeichen:</strong> <span>${vehicle.kennzeichen}</span></p>
                    <p style="color: var(--color-text-primary); font-size: var(--font-size-sm); margin-bottom: var(--space-2);"><strong>Kundenname:</strong> <span>${vehicle.kundenname}</span></p>
                    <p style="color: var(--color-text-primary); font-size: var(--font-size-sm); margin-bottom: var(--space-2);"><strong>Fahrzeug:</strong> <span>${vehicle.marke} ${vehicle.modell}${vehicle.baujahr ? ` (${vehicle.baujahr})` : ''}</span></p>
                    ${vehicle.kmstand ? `<p style="color: var(--color-text-primary); font-size: var(--font-size-sm); margin-bottom: var(--space-2);"><strong>KM-Stand:</strong> <span>${vehicle.kmstand} km</span></p>` : ''}
                    <div style="background: linear-gradient(135deg, rgba(255,149,0,0.1) 0%, rgba(255,59,48,0.1) 100%); border: 1px solid rgba(255,149,0,0.3); border-radius: var(--radius-md); padding: var(--space-4); margin-top: var(--space-3); display: flex; align-items: center; gap: var(--space-3);">
                        <i data-feather="droplet"></i>
                        <div>
                            <strong style="color: var(--color-warning); font-size: var(--font-size-lg);">FARBNUMMER: ${vehicle.farbnummer}</strong>
                            <div style="color: var(--color-text-secondary); font-size: var(--font-size-sm); margin-top: 4px;">${vehicle.lackart}</div>
                        </div>
                    </div>
                    ${vehicle.farbname ? `<p style="margin-top: var(--space-3); color: var(--color-text-primary); font-size: var(--font-size-sm);"><strong>Farbname:</strong> <span>${vehicle.farbname}</span></p>` : ''}
                    <p style="color: var(--color-text-primary); font-size: var(--font-size-sm); margin-bottom: var(--space-2); margin-top: var(--space-3);"><strong>Angenommen am:</strong> <span>${vehicle.datum} ${vehicle.zeit}</span></p>
                    ${vehicle.notizen ? `<p style="color: var(--color-text-primary); font-size: var(--font-size-sm);"><strong>Schadensbeschreibung:</strong> <span>${vehicle.notizen}</span></p>` : ''}
                </div>
            `;
            infoDiv.style.display = 'block';

            // Vorher-Fotos anzeigen
            const vorherGrid = document.getElementById('vorherGrid');
            vorherGrid.innerHTML = '';
            if (vehicle.photos && vehicle.photos.length > 0) {
                vehicle.photos.forEach(photo => {
                    const div = document.createElement('div');
                    div.className = 'photo-item';
                    div.innerHTML = `<img src="${photo}" alt="Vorher-Foto" loading="lazy" decoding="async">`;
                    vorherGrid.appendChild(div);
                });
            } else {
                vorherGrid.innerHTML = '<p style="color: var(--color-text-tertiary); text-align: center;">Keine Vorher-Fotos vorhanden</p>';
            }

            // Feather Icons aktualisieren
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        }

        // Nachher-Fotos
        const photoInput = document.getElementById('photoInput');
        const nachherGrid = document.getElementById('nachherGrid');

        // Bild komprimieren
        async function compressImage(base64Image, profileName = 'nachherFoto') {
            const result = await ImageOptimizer.compressImage(
                base64Image,
                profileName,
                (progress, message) => {
                    if (progress === 100) {
                        console.log(`‚úÖ ${message}`);
                    }
                }
            );
            console.log(`üìä Komprimierung: ${result.savings}% gespart (${(result.originalSize/1024).toFixed(0)}KB ‚Üí ${(result.compressedSize/1024).toFixed(0)}KB)`);
            return result.compressed;
        }

        const photoInputHandler = function(e) {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = async function(event) {
                    const compressed = await compressImage(event.target.result);
                    nachherPhotos.push(compressed);
                    updateNachherGrid();
                };
                reader.readAsDataURL(file);
            });
            e.target.value = '';
        };

        // Event Listener direkt registrieren (statt registerDOM wegen Race Condition)
        photoInput.addEventListener('change', photoInputHandler);

        function updateNachherGrid() {
            nachherGrid.innerHTML = '';
            nachherPhotos.forEach((photo, index) => {
                // Create wrapper div for photo + button
                const wrapper = document.createElement('div');
                wrapper.className = 'photo-wrapper';

                // Photo item
                const photoItem = document.createElement('div');
                photoItem.className = 'photo-item';
                photoItem.innerHTML = `<img src="${photo}" alt="Nachher-Foto ${index + 1}" loading="lazy" decoding="async">`;

                // Remove button
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-photo';
                removeBtn.onclick = () => removeNachherPhoto(index);
                removeBtn.innerHTML = `<i data-feather="trash-2"></i> L√∂schen`;

                wrapper.appendChild(photoItem);
                wrapper.appendChild(removeBtn);
                nachherGrid.appendChild(wrapper);
            });

            if (nachherPhotos.length < 10) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'photo-item empty';
                emptyDiv.onclick = () => photoInput.click();
                emptyDiv.innerHTML = '<i data-feather="camera"></i>';
                nachherGrid.appendChild(emptyDiv);
            }

            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        }

        function removeNachherPhoto(index) {
            nachherPhotos.splice(index, 1);
            updateNachherGrid();
        }

        // Unterschrift Canvas (Variablen jetzt oben im globalen Scope definiert)
        function initCanvas() {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * 2;
            canvas.height = rect.height * 2;
            ctx.scale(2, 2);

            // Dynamische Stroke Color basierend auf Theme
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
            ctx.strokeStyle = currentTheme === 'dark' ? '#ffffff' : '#000000';
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            if (!hasDrawn) {
                drawPlaceholder();
            }
        }

        function drawPlaceholder() {
            ctx.save();
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.fillStyle = '#8e8e93';
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('‚úçÔ∏è Hier unterschreiben', canvas.width / 2, canvas.height / 2);
            ctx.restore();
        }

        function getCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            if (e.touches && e.touches.length > 0) {
                return {
                    x: (e.touches[0].clientX - rect.left) * scaleX / 2,
                    y: (e.touches[0].clientY - rect.top) * scaleY / 2
                };
            } else {
                return {
                    x: (e.clientX - rect.left) * scaleX / 2,
                    y: (e.clientY - rect.top) * scaleY / 2
                };
            }
        }

        function startDrawing(e) {
            e.preventDefault();
            isDrawing = true;

            if (!hasDrawn) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                hasDrawn = true;
            }

            const coords = getCoordinates(e);
            ctx.beginPath();
            ctx.moveTo(coords.x, coords.y);
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();

            const coords = getCoordinates(e);
            ctx.lineTo(coords.x, coords.y);
            ctx.stroke();
        }

        function stopDrawing(e) {
            if (!isDrawing) return;
            e.preventDefault();
            isDrawing = false;
            ctx.closePath();
        }

        // Canvas Event Listeners (direkt registrieren wegen registerDOM Race Condition)
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseleave', stopDrawing);

        canvas.addEventListener('touchstart', startDrawing);
        canvas.addEventListener('touchmove', draw);
        canvas.addEventListener('touchend', stopDrawing);
        canvas.addEventListener('touchcancel', stopDrawing);

        function clearSignature() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            hasDrawn = false;
            drawPlaceholder();
        }

        // Hilfsfunktion: Firebase Storage Foto zu Base64 DataURL konvertieren
        async function fetchPhotoAsBase64(storagePath) {
            try {
                console.log('üîç [fetchPhotoAsBase64] START - storagePath:', storagePath, 'Type:', typeof storagePath);

                // VALIDATION: Storage Path pr√ºfen
                if (!storagePath || typeof storagePath !== 'string' || storagePath.trim() === '') {
                    console.error('‚ùå [fetchPhotoAsBase64] UNG√úLTIGER storagePath:', {
                        value: storagePath,
                        type: typeof storagePath,
                        isEmpty: !storagePath
                    });
                    throw new Error('Ung√ºltiger Storage Path: ' + storagePath);
                }
                console.log('‚úÖ [fetchPhotoAsBase64] Storage Path validiert');

                // FIREBASE CHECK: App initialisiert?
                if (!firebaseApp) {
                    console.error('‚ùå [fetchPhotoAsBase64] firebaseApp nicht verf√ºgbar!', {
                        firebaseInitialized: window.firebaseInitialized,
                        firebaseApp: !!firebaseApp
                    });
                    throw new Error('Firebase nicht initialisiert');
                }
                console.log('‚úÖ [fetchPhotoAsBase64] Firebase App verf√ºgbar');

                // STORAGE REF: Reference erstellen
                const storage = firebaseApp.storage();
                console.log('‚úÖ [fetchPhotoAsBase64] Storage Service erhalten');

                const storageRef = storage.ref(storagePath);
                console.log('‚úÖ [fetchPhotoAsBase64] Storage Ref erstellt f√ºr:', storageRef.fullPath);

                // üîß CORS-FIX: Image-Element mit crossOrigin statt getBytes()
                // Grund 1: fetch() wird von CORS blockiert (No 'Access-Control-Allow-Origin')
                // Grund 2: getBytes() existiert NUR in Firebase v9+ modular SDK, NICHT in v8 compat
                // L√∂sung: <img crossOrigin='anonymous'> ‚Üí Canvas ‚Üí Base64 DataURL

                // DOWNLOAD URL: Von Firebase holen
                const downloadURL = await storageRef.getDownloadURL();
                console.log('‚úÖ [fetchPhotoAsBase64] Download URL erhalten:', downloadURL.substring(0, 80) + '...');

                // IMAGE ELEMENT: Mit CORS laden (erlaubt von Firebase Storage)
                console.log('üñºÔ∏è [fetchPhotoAsBase64] Lade Image mit crossOrigin...');
                const img = new Image();
                img.crossOrigin = 'anonymous';  // ‚úÖ KRITISCH: Erlaubt CORS-safe Image-Laden
                img.src = downloadURL;

                // Warten bis Image geladen
                await new Promise((resolve, reject) => {
                    img.onload = () => {
                        console.log('‚úÖ [fetchPhotoAsBase64] Image geladen:', {
                            width: img.width,
                            height: img.height,
                            naturalWidth: img.naturalWidth,
                            naturalHeight: img.naturalHeight
                        });
                        resolve();
                    };
                    img.onerror = (error) => {
                        console.error('‚ùå [fetchPhotoAsBase64] Image Load Error:', error);
                        reject(new Error('Image konnte nicht geladen werden'));
                    };
                });

                // CANVAS: Image zu Canvas zeichnen
                console.log('üé® [fetchPhotoAsBase64] Konvertiere zu Canvas...');
                const canvas = document.createElement('canvas');
                canvas.width = img.naturalWidth;
                canvas.height = img.naturalHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0);
                console.log('‚úÖ [fetchPhotoAsBase64] Canvas erstellt:', {
                    width: canvas.width,
                    height: canvas.height
                });

                // BASE64: Canvas zu DataURL konvertieren
                const dataURL = canvas.toDataURL('image/jpeg', 0.95);  // 95% Qualit√§t
                console.log('‚úÖ [fetchPhotoAsBase64] Base64 DataURL erstellt:', {
                    length: dataURL.length,
                    sizeMB: (dataURL.length / 1024 / 1024).toFixed(2) + ' MB',
                    prefix: dataURL.substring(0, 50) + '...'
                });

                return dataURL;
            } catch (error) {
                console.error('‚ùå [fetchPhotoAsBase64] FEHLER:', {
                    storagePath: storagePath,
                    errorName: error.name,
                    errorMessage: error.message,
                    errorStack: error.stack
                });
                return null;  // Fallback: null wenn Foto nicht geladen werden kann
            }
        }

        // Form absenden
        // üÜï Helper: Service Status abrufen (Multi-Service Support)
        function getServiceStatus(fahrzeug, serviceTyp) {
            if (!fahrzeug || !serviceTyp) return 'neu';

            // 1. Priorit√§t: serviceStatuses Object (Multi-Service)
            if (fahrzeug.serviceStatuses && fahrzeug.serviceStatuses[serviceTyp]) {
                return fahrzeug.serviceStatuses[serviceTyp].status;
            }

            // 2. Fallback: prozessStatus (Single-Service / Backwards Compatibility)
            if (fahrzeug.prozessStatus && fahrzeug.serviceTyp === serviceTyp) {
                return fahrzeug.prozessStatus;
            }

            return 'neu';
        }

        // üÜï Validation: Kann Abnahme durchgef√ºhrt werden? (alle Services m√ºssen fertig sein)
        function canCompleteAbnahme(fahrzeug) {
            // Service Labels f√ºr Abnahme-Validation (ALLE 12 Services + Aliases)
            // ‚ö†Ô∏è WICHTIG: Liste muss VOLLST√ÑNDIG sein f√ºr korrekte Fehler-Anzeige!
            const serviceLabels = {
                // === AKTUELLE 12 SERVICES (2025) ===
                lackier: 'Lackierung',
                lackierung: 'Lackierung',              // Alias f√ºr Backward Compatibility
                reifen: 'Reifen-Service',
                mechanik: 'Mechanik',                  // ‚úÖ NEU HINZUGEF√úGT
                pflege: 'Fahrzeugpflege',              // ‚úÖ NEU HINZUGEF√úGT
                glas: 'Glas-Reparatur',
                klima: 'Klima-Service',
                tuev: 'T√úV/AU',
                tuv: 'T√úV/AU',                         // Alias (Legacy Support)
                folierung: 'Auto Folierung',
                dellen: 'Dellenentfernung',
                versicherung: 'Versicherungsschaden',  // ‚úÖ NEU HINZUGEF√úGT
                steinschutz: 'Steinschutzfolie',       // ‚úÖ NEU HINZUGEF√úGT
                werbebeklebung: 'Fahrzeugbeschriftung', // ‚úÖ NEU HINZUGEF√úGT

                // === VERALTETE SERVICES (Legacy Support) ===
                smartrepair: 'Smart-Repair',
                politur: 'Politur',
                unterboden: 'Unterbodenschutz',
                abholung: 'Abholung',
                sonstiges: 'Sonstiges'
            };

            const openServices = [];

            // Check Primary Service
            const primaryStatus = getServiceStatus(fahrzeug, fahrzeug.serviceTyp);
            if (primaryStatus !== 'fertig' && primaryStatus !== 'abholbereit' && primaryStatus !== 'abgeschlossen' && primaryStatus !== 'bereit') {
                openServices.push(serviceLabels[fahrzeug.serviceTyp] || fahrzeug.serviceTyp);
            }

            // Check Additional Services
            if (fahrzeug.additionalServices && Array.isArray(fahrzeug.additionalServices)) {
                fahrzeug.additionalServices.forEach(as => {
                    const status = getServiceStatus(fahrzeug, as.serviceTyp);
                    if (status !== 'fertig' && status !== 'abholbereit' && status !== 'abgeschlossen' && status !== 'bereit') {
                        openServices.push(serviceLabels[as.serviceTyp] || as.serviceTyp);
                    }
                });
            }

            return {
                canComplete: openServices.length === 0,
                openServices: openServices
            };
        }

        async function submitAbnahme() {
            console.log('üîÑ Submit gestartet');

            if (!currentVehicle) {
                showError('Kein Fahrzeug geladen!');
                return;
            }

            if (nachherPhotos.length === 0) {
                showError('Bitte mindestens 1 Nachher-Foto machen!');
                return;
            }

            if (!hasDrawn) {
                showError('Bitte Unterschrift des Kunden einholen!');
                return;
            }

            // üÜï VALIDATION: Multi-Service Check (alle Services m√ºssen fertig sein)
            const validation = canCompleteAbnahme(currentVehicle);
            if (!validation.canComplete) {
                const serviceList = validation.openServices.join(', ');
                showError(`‚ùå ABNAHME BLOCKIERT!\n\nFolgende Services sind noch nicht abgeschlossen:\n‚Ä¢ ${validation.openServices.join('\n‚Ä¢ ')}\n\nBitte schlie√üen Sie alle Services ab, bevor Sie die Abnahme durchf√ºhren.`);
                return;
            }

            const signatureData = canvas.toDataURL();
            const jetzt = new Date();
            const timestamp = Date.now();

            if (!currentVehicle.prozessTimestamps) {
                currentVehicle.prozessTimestamps = {};
            }
            currentVehicle.prozessTimestamps.abgeschlossen = timestamp;

            // ============================================
            // üõ°Ô∏è CRITICAL FIX: statusHistory Bloat Prevention
            // Problem: statusHistory contains 30+ entries with embedded base64 photos (80 KB each = 2.4 MB total!)
            // Firestore update() does MERGE (not REPLACE) ‚Üí old statusHistory stays in document ‚Üí 1.03 MB > 1 MB limit!
            // Solution: Create LIGHT version (keep status + timestamp, REMOVE embedded photos)
            // Photos are already saved in PDF, so no data loss for documentation!
            // ============================================
            const lightStatusHistory = (currentVehicle.statusHistory || []).map(entry => ({
                status: entry.status,           // ‚úÖ Keep status (wichtig f√ºr Audit-Trail)
                timestamp: entry.timestamp,     // ‚úÖ Keep timestamp
                notiz: entry.notiz || '',       // ‚úÖ Keep notes
                // ‚ùå foto EXCLUDED (das ist der 80 KB Bloat pro Entry!)
                // ‚ùå fotoRef EXCLUDED (nicht mehr relevant, Photos in PDF)
            }));
            console.log(`üìä [ABNAHME] statusHistory komprimiert: ${currentVehicle.statusHistory?.length || 0} Eintr√§ge, ${(currentVehicle.statusHistory?.length || 0) * 80} KB ‚Üí ${lightStatusHistory.length * 0.3} KB (-${((currentVehicle.statusHistory?.length || 0) * 80 - lightStatusHistory.length * 0.3).toFixed(0)} KB)`);

            // ============================================
            // FIX: Don't spread entire currentVehicle (includes statusHistory with photos = 2+ MB bloat!)
            // Instead: Build abnahmeData with ONLY needed scalar fields (reduces document from 1.02 MB ‚Üí ~50 KB)
            // ============================================
            const abnahmeData = {
                // Basis-Daten (8 fields)
                id: currentVehicle.id,
                kennzeichen: currentVehicle.kennzeichen,
                marke: currentVehicle.marke,
                modell: currentVehicle.modell,
                baujahrVon: currentVehicle.baujahrVon,
                baujahrBis: currentVehicle.baujahrBis,
                kmstand: currentVehicle.kmstand,
                vin: currentVehicle.vin,

                // Kunden-Daten (2 fields)
                kundenname: currentVehicle.kundenname,
                kundenId: currentVehicle.kundenId,

                // Service-Daten (6 fields) - Include small objects
                serviceTyp: currentVehicle.serviceTyp,
                serviceData: currentVehicle.serviceData,
                additionalServices: currentVehicle.additionalServices,
                serviceStatuses: currentVehicle.serviceStatuses,
                notizen: currentVehicle.notizen,
                schadenBeschreibung: currentVehicle.schadenBeschreibung,

                // Preis-Daten (7 fields)
                vereinbarterPreis: currentVehicle.vereinbarterPreis,
                originalPreis: currentVehicle.originalPreis,
                rabattAngewendet: currentVehicle.rabattAngewendet,
                rabattStufe: currentVehicle.rabattStufe,
                rabattBetrag: currentVehicle.rabattBetrag,
                kva: currentVehicle.kva,
                kalkulationData: currentVehicle.kalkulationData,

                // Status (5 fields) - statusHistory as LIGHT version (without photos)
                status: 'abgeschlossen',
                prozessStatus: 'abgeschlossen',
                prozessTimestamps: currentVehicle.prozessTimestamps,
                abgeschlossenAm: firebase.firestore.Timestamp.now(),  // üÜï BUGFIX 2025-11-18: For Steuerberater Bilanz period filtering
                statusHistory: lightStatusHistory,  // ‚úÖ Light version (~10 KB) statt FULL version (2.4 MB)

                // Partner Portal (7 fields)
                quelle: currentVehicle.quelle,
                partnerId: currentVehicle.partnerId,
                partnerName: currentVehicle.partnerName,
                partnerAnfrageId: currentVehicle.partnerAnfrageId,
                kundenEmail: currentVehicle.kundenEmail,
                kundenTelefon: currentVehicle.kundenTelefon,
                anliefertermin: currentVehicle.anliefertermin,

                // Datum/Zeit (8 fields)
                datum: currentVehicle.datum,
                zeit: currentVehicle.zeit,
                geplantesAbnahmeDatum: currentVehicle.geplantesAbnahmeDatum,
                abnahmeDatum: jetzt.toLocaleDateString('de-DE'),
                abnahmeZeit: jetzt.toLocaleTimeString('de-DE'),
                timestamp: currentVehicle.timestamp,
                lastModified: timestamp,
                erstelltAm: currentVehicle.erstelltAm,

                // Abholung (6 fields)
                fahrzeugAbholung: currentVehicle.fahrzeugAbholung,
                abholadresse: currentVehicle.abholadresse,
                abholdatum: currentVehicle.abholdatum,
                abholzeit: currentVehicle.abholzeit,
                abholtermin: currentVehicle.abholtermin,
                abholnotiz: currentVehicle.abholnotiz,

                // Farbe (5 fields)
                farbe: currentVehicle.farbe,
                farbname: currentVehicle.farbname,
                farbnummer: currentVehicle.farbnummer,
                farbvariante: currentVehicle.farbvariante,
                lackart: currentVehicle.lackart,

                // Payment (2 fields)
                bezahlt: false,
                rechnungGeschrieben: false,

                // Audit Trail (1 field)
                bearbeitungsHistory: currentVehicle.bearbeitungsHistory,

                // Original Annahme Signature (from Partner/Meister flow)
                signature: currentVehicle.signature,  // ‚úÖ Preserve from Firestore (for PDF display)

                // Abnahme-specific fields
                nachherPhotos,  // Will be removed before Firestore save
                abnahmeSignature: signatureData,  // Compressed base64 (OK size ~30-50 KB)

                // Rechnung (if exists)
                rechnung: currentVehicle.rechnung
            };

            try {
                if (firebaseInitialized && localFirebaseApp) {
                    console.log('üíæ Hybrid-Update: Status ‚Üí Firestore, Nachher-Fotos ‚Üí LocalStorage');

                    await localFirebaseApp.savePhotosToFirestore(currentVehicle.id, nachherPhotos, 'nachher');

                    // ============================================
                    // üõ°Ô∏è FIRESTORE FIX: Remove undefined values (Firestore doesn't allow them)
                    // Problem: Some fields in abnahmeData may be undefined (e.g., serviceData, kalkulationData)
                    // Firestore Rules: null ‚úÖ, missing fields ‚úÖ, undefined ‚ùå FORBIDDEN
                    // Solution: Filter out all undefined values before Firestore update
                    // ============================================
                    const dataForFirestore = Object.fromEntries(
                        Object.entries(abnahmeData)
                            .filter(([key, value]) => value !== undefined)
                    );

                    // Remove non-Firestore fields
                    delete dataForFirestore.nachherPhotos;

                    // DEBUG: Log which fields were filtered out due to undefined
                    const undefinedFields = Object.entries(abnahmeData)
                        .filter(([key, value]) => value === undefined)
                        .map(([key]) => key);
                    if (undefinedFields.length > 0) {
                        console.warn('‚ö†Ô∏è [ABNAHME] Gefilterte undefined Fields:', undefinedFields.join(', '));
                        console.warn('üí° Diese Felder werden aus dem Firestore-Update ausgelassen (Firestore erlaubt keine undefined values)');
                    }

                    await localFirebaseApp.updateFahrzeug(currentVehicle.id, dataForFirestore);
                    console.log('‚úÖ Status in Firestore aktualisiert');

                    // ============================================
                    // NACHBESTELLUNGEN √úBERTRAGEN (NEU 2025-11-12)
                    // ============================================
                    // Beim Fahrzeug-Abschluss: Angelieferte Bestellungen in fahrzeug.nachbestellungen √ºbertragen
                    console.log('üì¶ [ABSCHLUSS] Pr√ºfe Nachbestellungen f√ºr Fahrzeug:', currentVehicle.id);
                    try {
                        const nachbestellungen = await transferNachbestellungenBeimAbschluss(currentVehicle.id);
                        console.log(`‚úÖ [ABSCHLUSS] ${nachbestellungen.angeliefert} Nachbestellungen √ºbertragen, ${nachbestellungen.offen} noch offen`);

                        // Warnung falls noch offene Bestellungen existieren
                        if (nachbestellungen.offen > 0) {
                            console.warn(`‚ö†Ô∏è [ABSCHLUSS] ${nachbestellungen.offen} Bestellungen noch nicht angeliefert!`);
                            // Optional: Dialog anzeigen (f√ºr Phase 4)
                        }
                    } catch (error) {
                        console.error('‚ùå [ABSCHLUSS] Fehler beim √úbertragen der Nachbestellungen:', error);
                        // Nicht blockieren - Fahrzeug wird trotzdem abgeschlossen
                    }

                    // FIREBASE INIT GUARD: Sicherstellen dass Firebase bereit ist f√ºr Storage-Zugriff
                    if (!window.firebaseInitialized || !window.firebaseApp) {
                        console.warn('‚ö†Ô∏è Firebase nicht vollst√§ndig initialisiert - warte 2 Sekunden...');
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        console.log('‚úÖ Wartezeit abgelaufen - fahre fort mit PDF-Generierung');
                    } else {
                        console.log('‚úÖ Firebase bereits initialisiert - fahre fort');
                    }

                    const vorherPhotos = await localFirebaseApp.loadPhotosFromFirestore(currentVehicle.id, 'vorher');

                    // Prozess-Fotos aus statusHistory extrahieren
                    // NEUE L√ñSUNG: Komprimierte Fotos direkt in Firestore (entry.foto)
                    // FALLBACK: Alte Eintr√§ge mit fotoRef werden von Firebase Storage geladen
                    console.log('üì∏ [submitAbnahme] Lade Prozess-Fotos aus statusHistory:', {
                        totalEntries: currentVehicle.statusHistory?.length || 0,
                        entriesWithFoto: (currentVehicle.statusHistory || []).filter(e => e.foto || e.fotoRef).length
                    });

                    const prozessFotos = await Promise.all(
                        (currentVehicle.statusHistory || [])
                            .filter(entry => entry.foto || entry.fotoRef)  // Neue (foto) + alte (fotoRef) Eintr√§ge
                            .map(async (entry, index) => {
                                console.log(`üì∏ [submitAbnahme] Prozess-Foto ${index + 1}/${(currentVehicle.statusHistory || []).filter(e => e.foto || e.fotoRef).length}:`, {
                                    status: entry.status,
                                    hasFoto: !!entry.foto,
                                    hasFotoRef: !!entry.fotoRef,
                                    method: entry.foto ? 'DIREKT aus Firestore' : 'LEGACY von Storage laden'
                                });

                                // NEUE L√ñSUNG: entry.foto ist bereits komprimierte DataURL in Firestore
                                // FALLBACK: entry.fotoRef erfordert Storage-Download (f√ºr alte Daten)
                                let foto = entry.foto;  // Bevorzuge direkte DataURL

                                if (!foto && entry.fotoRef) {
                                    // Legacy-Fallback: Versuche von Storage zu laden (kann durch CORS fehlschlagen)
                                    console.log(`‚ö†Ô∏è [submitAbnahme] LEGACY: Lade Foto ${index + 1} von Storage (fotoRef)...`);
                                    foto = await fetchPhotoAsBase64(entry.fotoRef);
                                }

                                console.log(`${foto ? '‚úÖ' : '‚ùå'} [submitAbnahme] Prozess-Foto ${index + 1} geladen:`, {
                                    status: entry.status,
                                    fotoLoaded: !!foto,
                                    fotoLength: foto ? foto.length : 0,
                                    fotoSizeKB: foto ? (foto.length / 1024).toFixed(1) + ' KB' : 'N/A'
                                });

                                return {
                                    status: entry.status,
                                    timestamp: entry.timestamp,
                                    foto: foto,  // Kann null sein wenn fetchPhotoAsBase64 fehlschl√§gt (nur bei Legacy)
                                    notiz: entry.notiz || ''
                                };
                            })
                    );

                    // PROZESSFOTOS DEBUG: Zusammenfassung
                    const successCount = prozessFotos.filter(p => p.foto).length;
                    const failCount = prozessFotos.filter(p => !p.foto).length;
                    console.log('üìä [submitAbnahme] Prozess-Fotos Zusammenfassung:', {
                        total: prozessFotos.length,
                        success: successCount,
                        failed: failCount,
                        prozessFotos: prozessFotos.map(p => ({
                            status: p.status,
                            hasFoto: !!p.foto
                        }))
                    });

                    // üñºÔ∏è FIX: Nov 21, 2025 - Pattern 37: Convert Photo URLs to Base64 for PDF
                    console.log('üì∏ [ABNAHME] Konvertiere Fotos zu Base64 vor PDF-Generierung...');
                    const vorherPhotosBase64 = vorherPhotos && vorherPhotos.length > 0
                        ? await convertPhotoUrlsToBase64(vorherPhotos)
                        : [];
                    const nachherPhotosBase64 = nachherPhotos && nachherPhotos.length > 0
                        ? await convertPhotoUrlsToBase64(nachherPhotos)
                        : [];

                    console.log(`‚úÖ [ABNAHME] Fotos konvertiert: ${vorherPhotosBase64.length} VORHER, ${nachherPhotosBase64.length} NACHHER`);

                    const dataForPDF = {
                        ...abnahmeData,
                        photos: vorherPhotos,  // Keep original for reference
                        photosBase64: vorherPhotosBase64,  // ‚úÖ NEW: Base64 for PDF
                        nachherPhotos: nachherPhotos,  // Keep original for reference
                        nachherPhotosBase64: nachherPhotosBase64,  // ‚úÖ NEW: Base64 for PDF
                        prozessFotos: prozessFotos
                    };
                    await createPDF(dataForPDF);
                } else {
                    let fahrzeuge = JSON.parse(localStorage.getItem('fahrzeuge') || '[]');
                    const index = fahrzeuge.findIndex(v => window.compareIds(v.id, currentVehicle.id));
                    if (index !== -1) {
                        fahrzeuge[index] = abnahmeData;
                        localStorage.setItem('fahrzeuge', JSON.stringify(fahrzeuge));
                    }
                    console.log('‚ÑπÔ∏è Fahrzeug in LocalStorage aktualisiert');

                    // Prozess-Fotos aus statusHistory extrahieren & von Firebase Storage laden
                    console.log('üì∏ [submitAbnahme] [LocalStorage] Lade Prozess-Fotos aus statusHistory:', {
                        totalEntries: currentVehicle.statusHistory?.length || 0,
                        entriesWithFoto: (currentVehicle.statusHistory || []).filter(e => e.fotoRef || e.foto).length
                    });

                    const prozessFotos = await Promise.all(
                        (currentVehicle.statusHistory || [])
                            .filter(entry => entry.fotoRef || entry.foto)  // Neue + alte Eintr√§ge
                            .map(async (entry, index) => {
                                console.log(`üì∏ [submitAbnahme] [LocalStorage] Prozess-Foto ${index + 1}:`, {
                                    status: entry.status,
                                    hasFoto: !!entry.foto,
                                    hasFotoRef: !!entry.fotoRef,
                                    fotoRef: entry.fotoRef || 'N/A'
                                });

                                const foto = entry.foto || await fetchPhotoAsBase64(entry.fotoRef);

                                console.log(`${foto ? '‚úÖ' : '‚ùå'} [submitAbnahme] [LocalStorage] Prozess-Foto ${index + 1} geladen:`, {
                                    status: entry.status,
                                    fotoLoaded: !!foto,
                                    fotoLength: foto ? foto.length : 0
                                });

                                return {
                                    status: entry.status,
                                    timestamp: entry.timestamp,
                                    foto: foto,
                                    notiz: entry.notiz || ''
                                };
                            })
                    );

                    // PROZESSFOTOS DEBUG: Zusammenfassung
                    const successCount = prozessFotos.filter(p => p.foto).length;
                    const failCount = prozessFotos.filter(p => !p.foto).length;
                    console.log('üìä [submitAbnahme] [LocalStorage] Prozess-Fotos Zusammenfassung:', {
                        total: prozessFotos.length,
                        success: successCount,
                        failed: failCount
                    });

                    const dataForPDF = {
                        ...abnahmeData,
                        prozessFotos: prozessFotos
                    };

                    await createPDF(dataForPDF);
                }
            } catch (error) {
                console.error('‚ùå Fehler beim Aktualisieren:', error);
                let fahrzeuge = JSON.parse(localStorage.getItem('fahrzeuge') || '[]');
                const index = fahrzeuge.findIndex(v => window.compareIds(v.id, currentVehicle.id));
                if (index !== -1) {
                    fahrzeuge[index] = abnahmeData;
                    localStorage.setItem('fahrzeuge', JSON.stringify(fahrzeuge));
                }

                // Prozess-Fotos aus statusHistory extrahieren (nur Eintr√§ge mit Foto)
                const prozessFotos = (currentVehicle.statusHistory || [])
                    .filter(entry => entry.foto)
                    .map(entry => ({
                        status: entry.status,
                        timestamp: entry.timestamp,
                        foto: entry.foto,
                        notiz: entry.notiz || ''
                    }));

                const dataForPDF = {
                    ...abnahmeData,
                    prozessFotos: prozessFotos
                };

                await createPDF(dataForPDF);
            }

            showSuccess('Fahrzeug erfolgreich abgenommen!');

            // üé¨ Feature 5: Success Animation (Flash + Checkmark)
            document.body.classList.add('success-flash');
            const checkmark = document.createElement('div');
            checkmark.className = 'success-checkmark';
            checkmark.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
            document.body.appendChild(checkmark);

            setTimeout(() => {
                document.body.classList.remove('success-flash');
                checkmark.remove();
            }, 700);

            await loadDropdownVehicles();

            setTimeout(() => {
                window.location.href = 'liste.html';
            }, 2000);
        }

        // üñºÔ∏è PHOTO URL‚ÜíBASE64 CONVERTER (FIX: Nov 21, 2025 - Pattern 37: Abnahme-PDF Photo Bug)
        // Converts Firebase Storage URLs to Base64 for jsPDF embedding
        // COPIED FROM annahme.html Lines 6410-6457 (Pattern 35)
        async function convertPhotoUrlsToBase64(photoUrls) {
            if (!photoUrls || photoUrls.length === 0) return [];

            console.log(`üñºÔ∏è [ABNAHME-PDF] Konvertiere ${photoUrls.length} Fotos zu Base64...`);
            const base64Photos = [];

            for (let i = 0; i < photoUrls.length; i++) {
                const photoUrl = photoUrls[i];

                try {
                    const base64 = await new Promise((resolve, reject) => {
                        const img = new Image();
                        img.crossOrigin = 'Anonymous';

                        const timeout = setTimeout(() => {
                            reject(new Error(`Photo ${i+1} loading timeout`));
                        }, 10000);  // 10 seconds timeout

                        img.onload = () => {
                            clearTimeout(timeout);
                            const canvas = document.createElement('canvas');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0);
                            resolve(canvas.toDataURL('image/jpeg', 0.9));  // 90% quality
                        };

                        img.onerror = (error) => {
                            clearTimeout(timeout);
                            reject(error);
                        };

                        img.src = photoUrl;
                    });

                    base64Photos.push(base64);
                    console.log(`   ‚úÖ [ABNAHME] Foto ${i+1}/${photoUrls.length} konvertiert`);

                } catch (error) {
                    console.error(`   ‚ùå [ABNAHME] Foto ${i+1} konnte nicht geladen werden:`, error);
                    // Continue with remaining photos (graceful degradation)
                }
            }

            console.log(`‚úÖ [ABNAHME] ${base64Photos.length}/${photoUrls.length} Fotos erfolgreich konvertiert`);
            return base64Photos;
        }

        // PDF erstellen
        async function createPDF(data) {
            // Load Werkstatt Settings from Firestore
            let settings = null;
            try {
                settings = await window.settingsManager.loadSettings();
                console.log('‚úÖ Werkstatt-Settings geladen f√ºr PDF:', settings.profil.name);
            } catch (error) {
                console.warn('‚ö†Ô∏è Settings konnten nicht geladen werden, verwende Fallback:', error);
                // Fallback to hardcoded values
                settings = {
                    profil: {
                        name: 'Auto-Lackierzentrum Mosbach',
                        logoUrl: null,
                        adresse: 'Industriestra√üe 1, 74821 Mosbach',
                        telefon: '+49 6261 123456',
                        email: 'info@auto-lackierzentrum.de'
                    }
                };
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            let failedImages = 0;

            const safeAddImage = (imageData, format, x, y, width, height, label = 'Foto') => {
                try {
                    console.log(`üì∏ [safeAddImage] Versuche ${label} hinzuzuf√ºgen:`, {
                        hasData: !!imageData,
                        dataType: typeof imageData,
                        dataLength: imageData ? imageData.length : 0,
                        format, x, y, width, height
                    });

                    if (!imageData || imageData === '') {
                        throw new Error('Leeres Foto - imageData ist null oder leer');
                    }

                    if (typeof imageData !== 'string') {
                        throw new Error('Ung√ºltiger imageData Typ: ' + typeof imageData);
                    }

                    if (!imageData.startsWith('data:image/')) {
                        throw new Error('Ung√ºltiges DataURL Format: ' + imageData.substring(0, 50));
                    }

                    doc.addImage(imageData, format, x, y, width, height);
                    console.log(`‚úÖ [safeAddImage] ${label} erfolgreich hinzugef√ºgt`);
                    return true;
                } catch (error) {
                    console.error(`‚ùå [safeAddImage] FEHLER beim Hinzuf√ºgen (${label}):`, {
                        errorName: error.name,
                        errorMessage: error.message,
                        hasImageData: !!imageData,
                        imageDataType: typeof imageData,
                        imageDataLength: imageData ? imageData.length : 0,
                        imageDataPrefix: imageData ? imageData.substring(0, 50) : 'NULL',
                        format, x, y, width, height
                    });
                    failedImages++;

                    // Render Fallback: Grauer Platzhalter mit Fehlermeldung
                    doc.setFillColor(240, 240, 240);
                    doc.rect(x, y, width, height, 'F');
                    doc.setDrawColor(200, 200, 200);
                    doc.rect(x, y, width, height, 'S');

                    doc.setFontSize(10);
                    doc.setTextColor(150, 150, 150);
                    doc.text('‚ö†Ô∏è Foto konnte nicht', x + width/2, y + height/2 - 5, { align: 'center' });
                    doc.text('geladen werden', x + width/2, y + height/2 + 5, { align: 'center' });
                    doc.setTextColor(0, 0, 0);

                    return false;
                }
            };

            /**
             * üÜï BUG #6 FIX (Nov 13, 2025): Hilfsfunktion f√ºr Service-Detail Rendering
             *
             * Rendert service-spezifische Details im PDF f√ºr ALLE 12 Services.
             * Verwendet f√ºr Primary Service UND Additional Services.
             *
             * @param {jsPDF} doc - jsPDF Document Object
             * @param {string} serviceTyp - Service type (e.g., 'reifen', 'glas', etc.)
             * @param {Object} serviceDetails - Service-specific details object
             * @param {number} y - Current y-coordinate for rendering
             * @param {string} serviceName - Optional display name (for Additional Services)
             * @returns {number} Updated y-coordinate after rendering
             */
            const renderServiceDetails = (doc, serviceTyp, serviceDetails, y, serviceName = null) => {
                if (!serviceDetails || Object.keys(serviceDetails).length === 0) {
                    return y; // No details to render
                }

                // Service Names for Header
                const serviceNames = {
                    'reifen': 'REIFEN-SERVICE',
                    'glas': 'GLAS-REPARATUR',
                    'klima': 'KLIMA-SERVICE',
                    'dellen': 'DELLEN-REPARATUR',
                    'mechanik': 'MECHANIK-SERVICE',
                    'versicherung': 'VERSICHERUNGS-SCHADEN',
                    'pflege': 'FAHRZEUG-PFLEGE',
                    'tuev': 'T√úV/AU-PR√úFUNG',
                    'steinschutz': 'STEINSCHUTZ-FOLIE',
                    'folierung': 'FAHRZEUG-FOLIERUNG',
                    'werbebeklebung': 'WERBE-BEKLEBUNG',
                    'lackierung': 'LACKIERUNG'
                };

                // Header with Service Name
                y += 12;
                doc.setFillColor(156, 39, 176); // Lila f√ºr Service-Details
                doc.rect(15, y - 5, 180, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(13);
                doc.text(serviceName || serviceNames[serviceTyp] || 'SERVICE-DETAILS', 20, y);

                y += 10;
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);

                // Service-specific Fields Rendering
                switch(serviceTyp) {
                    // üÜï BUG #4 FIX (Nov 13, 2025): Lackierung als Additional Service
                    // Problem: Lackierung hatte keinen case in renderServiceDetails() ‚Üí kein PDF-Rendering f√ºr Additional Service
                    // L√∂sung: case 'lackierung'/'lackier' mit 4 Feldern hinzugef√ºgt
                    case 'lackierung':
                    case 'lackier':
                        if (serviceDetails.farbnummer) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Farbnummer:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(serviceDetails.farbnummer, 70, y);
                            y += 7;
                        }
                        if (serviceDetails.farbname) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Farbname:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(serviceDetails.farbname, 70, y);
                            y += 7;
                        }
                        if (serviceDetails.farbvariante) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Farbvariante:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(serviceDetails.farbvariante, 70, y);
                            y += 7;
                        }
                        if (serviceDetails.lackart) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Lackart:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(serviceDetails.lackart, 70, y);
                            y += 7;
                        }
                        break;

                    case 'reifen':
                        if (serviceDetails.reifengroesse) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Reifengr√∂√üe:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(serviceDetails.reifengroesse, 60, y);
                            y += 7;
                        }
                        if (serviceDetails.reifentyp) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Reifentyp:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(serviceDetails.reifentyp, 60, y);
                            y += 7;
                        }
                        if (serviceDetails.reifenanzahl) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Anzahl:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(serviceDetails.reifenanzahl + ' Reifen', 60, y);
                            y += 7;
                        }
                        break;

                    case 'glas':
                        if (serviceDetails.scheibentyp) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Scheibentyp:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(serviceDetails.scheibentyp, 60, y);
                            y += 7;
                        }
                        if (serviceDetails.schadensgroesse) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Schadensgr√∂√üe:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(serviceDetails.schadensgroesse, 60, y);
                            y += 7;
                        }
                        if (serviceDetails.glasposition) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Position:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(serviceDetails.glasposition, 60, y);
                            y += 7;
                        }
                        break;

                    case 'klima':
                        if (serviceDetails.klimaservice) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Service-Art:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(serviceDetails.klimaservice, 60, y);
                            y += 7;
                        }
                        if (serviceDetails.kaeltemittel) {
                            doc.setFont(undefined, 'bold');
                            doc.text('K√§ltemittel:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(serviceDetails.kaeltemittel, 60, y);
                            y += 7;
                        }
                        if (serviceDetails.klimaproblem) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Problem:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const klimaText = doc.splitTextToSize(serviceDetails.klimaproblem, 170);
                            doc.text(klimaText, 60, y);
                            y += klimaText.length * 5 + 2;
                        }
                        break;

                    case 'dellen':
                        if (serviceDetails.dellenanzahl) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Anzahl Dellen:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(serviceDetails.dellenanzahl, 60, y);
                            y += 7;
                        }
                        if (serviceDetails.dellengroesse) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Gr√∂√üe:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(serviceDetails.dellengroesse, 60, y);
                            y += 7;
                        }
                        if (serviceDetails.lackschaden) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Lackschaden:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(serviceDetails.lackschaden, 60, y);
                            y += 7;
                        }
                        if (serviceDetails.dellenpositionen) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Positionen:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const dellenText = doc.splitTextToSize(serviceDetails.dellenpositionen, 170);
                            doc.text(dellenText, 60, y);
                            y += dellenText.length * 5 + 2;
                        }
                        break;

                    case 'mechanik':
                        if (serviceDetails.problem) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Problem:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const problemText = doc.splitTextToSize(serviceDetails.problem, 170);
                            doc.text(problemText, 60, y);
                            y += problemText.length * 5 + 2;
                        }
                        if (serviceDetails.symptome) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Symptome:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const symptomeText = doc.splitTextToSize(serviceDetails.symptome, 170);
                            doc.text(symptomeText, 60, y);
                            y += symptomeText.length * 5 + 2;
                        }
                        break;

                    case 'versicherung':
                        if (serviceDetails.schadensnummer) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Schadensnummer:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(serviceDetails.schadensnummer, 70, y);
                            y += 7;
                        }
                        if (serviceDetails.versicherung) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Versicherung:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(serviceDetails.versicherung, 70, y);
                            y += 7;
                        }
                        if (serviceDetails.schadendatum) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Schadendatum:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const schadenDatum = new Date(serviceDetails.schadendatum).toLocaleDateString('de-DE');
                            doc.text(schadenDatum, 70, y);
                            y += 7;
                        }
                        if (serviceDetails.unfallhergang) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Unfallhergang:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const hergangText = doc.splitTextToSize(serviceDetails.unfallhergang, 170);
                            doc.text(hergangText, 70, y);
                            y += hergangText.length * 5 + 2;
                        }
                        break;

                    case 'pflege':
                        if (serviceDetails.paket) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Pflege-Paket:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(serviceDetails.paket, 60, y);
                            y += 7;
                        }
                        if (serviceDetails.zusatzleistungen) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Zusatzleistungen:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const zusatzText = doc.splitTextToSize(serviceDetails.zusatzleistungen, 170);
                            doc.text(zusatzText, 60, y);
                            y += zusatzText.length * 5 + 2;
                        }
                        break;

                    case 'tuev':
                        if (serviceDetails.pruefart) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Pr√ºfart:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(serviceDetails.pruefart, 60, y);
                            y += 7;
                        }
                        if (serviceDetails.faelligkeit) {
                            doc.setFont(undefined, 'bold');
                            doc.text('F√§lligkeit:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const faelligkeitDate = new Date(serviceDetails.faelligkeit + '-01');
                            const faelligkeitText = faelligkeitDate.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
                            doc.text(faelligkeitText, 60, y);
                            y += 7;
                        }
                        if (serviceDetails.bekannteMaengel) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Bekannte M√§ngel:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const maengelText = doc.splitTextToSize(serviceDetails.bekannteMaengel, 170);
                            doc.text(maengelText, 60, y);
                            y += maengelText.length * 5 + 2;
                        }
                        break;

                    case 'steinschutz':
                        if (serviceDetails.steinschutzUmfang) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Umfang:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const umfangLabels = {
                                'vollverklebung': 'Vollverklebung',
                                'frontpaket': 'Frontpaket',
                                'teilbereich': 'Teilbereich'
                            };
                            doc.text(umfangLabels[serviceDetails.steinschutzUmfang] || serviceDetails.steinschutzUmfang, 60, y);
                            y += 7;
                        }
                        if (serviceDetails.steinschutzMaterial) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Material:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const materialLabels = {
                                'standard': 'Standard',
                                'premium': 'Premium',
                                'high_end': 'High-End'
                            };
                            doc.text(materialLabels[serviceDetails.steinschutzMaterial] || serviceDetails.steinschutzMaterial, 60, y);
                            y += 7;
                        }
                        if (serviceDetails.steinschutzBereiche) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Bereiche:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const bereicheText = doc.splitTextToSize(serviceDetails.steinschutzBereiche, 170);
                            doc.text(bereicheText, 60, y);
                            y += bereicheText.length * 5 + 2;
                        }
                        if (serviceDetails.steinschutzInfo) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Zusatzinfo:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const infoText = doc.splitTextToSize(serviceDetails.steinschutzInfo, 170);
                            doc.text(infoText, 60, y);
                            y += infoText.length * 5 + 2;
                        }
                        break;

                    case 'folierung':
                        if (serviceDetails.folierungArt) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Folierungsart:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(serviceDetails.folierungArt, 70, y);
                            y += 7;
                        }
                        if (serviceDetails.folierungFarbe) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Farbe:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(serviceDetails.folierungFarbe, 70, y);
                            y += 7;
                        }
                        if (serviceDetails.folierungDesign) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Design:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const designText = doc.splitTextToSize(serviceDetails.folierungDesign, 170);
                            doc.text(designText, 70, y);
                            y += designText.length * 5 + 2;
                        }
                        // üÜï BUG #2 FIX (Nov 13, 2025): 4 fehlende Felder hinzugef√ºgt
                        // Problem: Nur 3 von 7 Feldern wurden im PDF gerendert
                        // L√∂sung: folierungMaterial, folierungSpezialTyp, folierungBereiche, folierungInfo hinzugef√ºgt
                        if (serviceDetails.folierungMaterial) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Materialqualit√§t:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const materialLabels = {
                                'standard': 'Standard (3-5 Jahre)',
                                'premium': 'Premium (5-7 Jahre)',
                                'high_end': 'High-End (7-10 Jahre)'
                            };
                            doc.text(materialLabels[serviceDetails.folierungMaterial] || serviceDetails.folierungMaterial, 70, y);
                            y += 7;
                        }
                        if (serviceDetails.folierungSpezialTyp) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Spezialtyp:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(serviceDetails.folierungSpezialTyp, 70, y);
                            y += 7;
                        }
                        if (serviceDetails.folierungBereiche && Array.isArray(serviceDetails.folierungBereiche) && serviceDetails.folierungBereiche.length > 0) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Bereiche:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const bereicheText = serviceDetails.folierungBereiche.join(', ');
                            const bereicheLines = doc.splitTextToSize(bereicheText, 150);
                            doc.text(bereicheLines, 70, y);
                            y += bereicheLines.length * 5 + 2;
                        }
                        if (serviceDetails.folierungInfo) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Zusatzinfo:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const infoText = doc.splitTextToSize(serviceDetails.folierungInfo, 170);
                            doc.text(infoText, 70, y);
                            y += infoText.length * 5 + 2;
                        }
                        break;

                    case 'werbebeklebung':
                        if (serviceDetails.werbebeklebungUmfang) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Umfang:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(serviceDetails.werbebeklebungUmfang, 60, y);
                            y += 7;
                        }
                        if (serviceDetails.werbebeklebungKomplexitaet) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Komplexit√§t:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const komplexLabels = {
                                'einfach': 'Einfach',
                                'mittel': 'Mittel',
                                'komplex': 'Komplex'
                            };
                            doc.text(komplexLabels[serviceDetails.werbebeklebungKomplexitaet] || serviceDetails.werbebeklebungKomplexitaet, 60, y);
                            y += 7;
                        }
                        // üÜï BUG #1 FIX (Nov 13, 2025): Korrekter Feldname
                        // Problem: PDF las werbebeklebungMotiv, aber annahme.html speichert werbebeklebungText
                        // L√∂sung: Feldname + Label korrigiert
                        if (serviceDetails.werbebeklebungText) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Beschriftungstext:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const textLines = doc.splitTextToSize(serviceDetails.werbebeklebungText, 170);
                            doc.text(textLines, 60, y);
                            y += textLines.length * 5 + 2;
                        }
                        // üÜï BUG #3 FIX (Nov 13, 2025): Fehlende Felder hinzugef√ºgt
                        // Problem: werbebeklebungFarbanzahl und werbebeklebungInfo fehlten im PDF
                        // L√∂sung: 2 Felder hinzugef√ºgt
                        if (serviceDetails.werbebeklebungFarbanzahl) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Anzahl Farben:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(serviceDetails.werbebeklebungFarbanzahl + ' Farbe(n)', 60, y);
                            y += 7;
                        }
                        if (serviceDetails.werbebeklebungInfo) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Zusatzinfo:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const infoText = doc.splitTextToSize(serviceDetails.werbebeklebungInfo, 170);
                            doc.text(infoText, 60, y);
                            y += infoText.length * 5 + 2;
                        }
                        break;
                }

                y += 5; // Extra spacing after service details
                return y;
            };

            // Header with Logo & Dynamic Werkstatt Name
            doc.setFillColor(0, 191, 255);
            doc.rect(0, 0, 210, 40, 'F');

            // Logo (left side if available)
            if (settings.profil.logoUrl) {
                try {
                    // ============================================
                    // FIX: Check if logo is base64 DataURL (jsPDF can't load remote URLs)
                    // ============================================
                    if (settings.profil.logoUrl.startsWith('data:image/')) {
                        // Detect format from DataURL
                        const format = settings.profil.logoUrl.includes('data:image/png') ? 'PNG' :
                                      settings.profil.logoUrl.includes('data:image/jpeg') || settings.profil.logoUrl.includes('data:image/jpg') ? 'JPEG' :
                                      'PNG';  // Default fallback
                        doc.addImage(settings.profil.logoUrl, format, 15, 10, 35, 20);
                        console.log('‚úÖ Werkstatt-Logo in PDF-Header eingef√ºgt');
                    } else {
                        console.warn('‚ö†Ô∏è Logo ist Firebase Storage URL (wird √ºbersprungen, PDF continues):', settings.profil.logoUrl.substring(0, 80));
                        console.warn('üí° Tipp: Logo sollte als base64 DataURL in Firestore gespeichert werden, nicht als Storage URL');
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Logo konnte nicht in PDF eingef√ºgt werden:', error);
                }
            }

            // üé® EXCEL-STYLE HEADER (FIX: Nov 21, 2025 - Pattern 38: Optimized Header)
            // Smaller title to prevent text overflow
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);  // Smaller: 24 ‚Üí 18
            doc.setFont(undefined, 'bold');
            const logoLoaded = settings.profil.logoUrl && settings.profil.logoUrl.startsWith('data:image/');
            doc.text('Abnahmeprotokoll', logoLoaded ? 115 : 105, 18, { align: logoLoaded ? 'left' : 'center' });

            // Werkstatt Name (dynamic from settings)
            doc.setFontSize(10);  // Smaller: 12 ‚Üí 10
            doc.setFont(undefined, 'normal');
            doc.text(settings.profil.name, logoLoaded ? 115 : 105, 26, { align: logoLoaded ? 'left' : 'center' });

            // üé® EXCEL-STYLE KUNDENDATEN TABLE (FIX: Nov 21, 2025 - Pattern 38)
            doc.setTextColor(0, 0, 0);
            let y = 48;

            doc.autoTable({
                startY: y,
                head: [['KUNDENDATEN', '']],
                body: [
                    ['Annahme', data.datum + ' ' + data.zeit],
                    ['Abnahme', data.abnahmeDatum + ' ' + data.abnahmeZeit],
                    ['Kennzeichen', data.kennzeichen],
                    ['Kundenname', data.kundenname],
                    ['Email', data.kundenEmail || 'Nicht angegeben']
                ],
                theme: 'grid',
                headStyles: {
                    fillColor: [0, 51, 102],
                    textColor: 255,
                    fontStyle: 'bold',
                    fontSize: 11
                },
                bodyStyles: { fontSize: 10 },
                columnStyles: {
                    0: { fontStyle: 'bold', cellWidth: 50 },
                    1: { cellWidth: 130 }
                },
                margin: { left: 15, right: 15 }
            });

            y = doc.lastAutoTable.finalY + 5;

            // SERVICE-TYP Section
            y += 15;
            const serviceIcons = {
                'lackierung': '[LACK]',
                'lackier': '[LACK]',
                'reifen': '[REIF]',
                'glas': '[GLAS]',
                'klima': '[KLIM]',
                'dellen': '[DELL]',
                'mechanik': '[MECH]',
                'versicherung': '[VERS]',
                'pflege': '[PFLG]',
                'tuev': '[TUEV]',
                'alle': '[ALL]',
                'folierung': '[FOLI]',
                'steinschutz': '[STEIN]',
                'werbebeklebung': '[WERB]'
            };
            const serviceColors = {
                'lackierung': [220, 53, 69],
                'lackier': [220, 53, 69],
                'reifen': [255, 152, 0],
                'glas': [3, 169, 244],
                'klima': [0, 188, 212],
                'dellen': [156, 39, 176],
                'mechanik': [96, 125, 139],
                'versicherung': [76, 175, 80],
                'pflege': [233, 30, 99],
                'tuev': [76, 175, 80],
                'alle': [63, 81, 181],
                'folierung': [255, 193, 7],
                'steinschutz': [121, 85, 72],
                'werbebeklebung': [103, 58, 183]
            };
            const serviceLabels = {
                'lackierung': 'LACKIERUNG',
                'lackier': 'LACKIERUNG',
                'reifen': 'REIFEN-SERVICE',
                'glas': 'GLAS-REPARATUR',
                'klima': 'KLIMA-SERVICE',
                'dellen': 'DELLEN-REPARATUR',
                'mechanik': 'MECHANIK-SERVICE',
                'versicherung': 'VERSICHERUNGS-SCHADEN',
                'pflege': 'FAHRZEUG-PFLEGE',
                'tuev': 'T√úV/AU-PR√úFUNG',
                'alle': 'ALLE SERVICES',
                'folierung': 'AUTO-FOLIERUNG',
                'steinschutz': 'STEINSCHUTZFOLIE',
                'werbebeklebung': 'FAHRZEUGBESCHRIFTUNG'
            };

            // üÜï MULTI-SERVICE: Render Primary Service
            const serviceTyp = data.serviceTyp || 'lackierung';
            const color = serviceColors[serviceTyp] || [63, 81, 181];
            const icon = serviceIcons[serviceTyp] || '[?]';
            const label = serviceLabels[serviceTyp] || 'SERVICE';

            doc.setFillColor(color[0], color[1], color[2]);
            doc.rect(15, y - 5, 180, 10, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont(undefined, 'bold');
            doc.setFontSize(14);
            doc.text(icon + ' SERVICE: ' + label, 20, y + 1);

            y += 12;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(11);

            // üÜï MULTI-SERVICE: Render Additional Services
            // üÜï BUG #6 FIX (Nov 13, 2025): Additional Services now show full details (not just icons)
            if (data.additionalServices && Array.isArray(data.additionalServices) && data.additionalServices.length > 0) {
                doc.setFont(undefined, 'bold');
                doc.text('+ Zus√§tzliche Services:', 20, y);
                doc.setFont(undefined, 'normal');
                y += 6;

                data.additionalServices.forEach((additionalService, index) => {
                    const addServiceTyp = additionalService.serviceTyp;
                    const addIcon = serviceIcons[addServiceTyp] || '[?]';
                    const addLabel = serviceLabels[addServiceTyp] || 'SERVICE';

                    // Summary line (Icon + Label)
                    doc.setFontSize(10);
                    doc.text(`   ${addIcon} ${addLabel}`, 25, y);
                    y += 5;

                    // üÜï BUG #6 FIX: Render service-specific details for Additional Service
                    if (additionalService.serviceDetails && Object.keys(additionalService.serviceDetails).length > 0) {
                        // Page-Break Check before rendering details
                        if (y > 240) {
                            doc.addPage();
                            y = 20;
                        }

                        // Use helper function to render details
                        const serviceName = `${addIcon} ${addLabel.toUpperCase()}`;
                        y = renderServiceDetails(doc, addServiceTyp, additionalService.serviceDetails, y, serviceName);

                        // Page-Break Check after rendering details
                        if (y > 240) {
                            doc.addPage();
                            y = 20;
                        }
                    }
                });

                y += 3; // Extra space after additional services
                doc.setFontSize(11);
            }

            // Geplantes vs Tats√§chliches Abnahmeda tum
            doc.setFont(undefined, 'bold');
            doc.text('Geplante Abnahme:', 20, y);
            doc.setFont(undefined, 'normal');
            const geplantFormatted = data.geplantesAbnahmeDatum
                ? new Date(data.geplantesAbnahmeDatum).toLocaleDateString('de-DE')
                : 'Nicht angegeben';
            doc.text(geplantFormatted, 70, y);

            y += 7;
            doc.setFont(undefined, 'bold');
            doc.text('Tats√§chliche Abnahme:', 20, y);
            doc.setFont(undefined, 'normal');
            doc.text(data.abnahmeDatum, 70, y);

            // FAHRZEUG-ABHOLUNG Section
            if (data.fahrzeugAbholung === 'ja') {
                y += 12;
                doc.setFillColor(255, 152, 0); // Orange f√ºr Abholung
                doc.rect(15, y - 5, 180, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(13);
                doc.text('[ABHOL] FAHRZEUG-ABHOLUNG', 20, y);

                y += 10;
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);

                if (data.abholadresse) {
                    doc.setFont(undefined, 'bold');
                    doc.text('Abholadresse:', 20, y);
                    doc.setFont(undefined, 'normal');
                    const adresseLines = doc.splitTextToSize(data.abholadresse, 130);
                    doc.text(adresseLines, 70, y);
                    y += adresseLines.length * 5 + 2;
                }

                if (data.abholdatum || data.abholzeit) {
                    doc.setFont(undefined, 'bold');
                    doc.text('Abholdatum/-zeit:', 20, y);
                    doc.setFont(undefined, 'normal');
                    let abholText = '';
                    if (data.abholdatum) {
                        abholText = new Date(data.abholdatum).toLocaleDateString('de-DE');
                    }
                    if (data.abholzeit) {
                        abholText += (abholText ? ' um ' : '') + data.abholzeit + ' Uhr';
                    }
                    doc.text(abholText, 70, y);
                    y += 7;
                }

                if (data.abholnotiz) {
                    doc.setFont(undefined, 'bold');
                    doc.text('Notiz:', 20, y);
                    doc.setFont(undefined, 'normal');
                    const notizLines = doc.splitTextToSize(data.abholnotiz, 130);
                    doc.text(notizLines, 70, y);
                    y += notizLines.length * 5 + 2;
                }
            }

            // SERVICE-DETAILS (f√ºr service-spezifische Felder)
            // üÜï BUG #6 FIX (Nov 13, 2025): Refactored to use renderServiceDetails() helper
            // Reduces code duplication: 230+ lines ‚Üí 2 lines
            if (data.serviceTyp && data.serviceTyp !== 'lackierung' && data.serviceDetails) {
                y = renderServiceDetails(doc, data.serviceTyp, data.serviceDetails, y);
            }

            // Fahrzeugdaten
            y += 12;
            // üé® EXCEL-STYLE FAHRZEUGDATEN TABLE (FIX: Nov 21, 2025 - Pattern 38)
            // Prepare Baujahr text
            const baujahrVon = data.baujahrVon || data.baujahr;
            const baujahrBis = data.baujahrBis || data.baujahr;
            let baujahrText = '';
            if (baujahrVon && baujahrBis) {
                if (baujahrVon === baujahrBis) {
                    baujahrText = baujahrVon;
                } else {
                    baujahrText = baujahrVon + ' - ' + baujahrBis;
                }
            } else if (baujahrVon) {
                baujahrText = 'ab ' + baujahrVon;
            } else if (baujahrBis) {
                baujahrText = 'bis ' + baujahrBis;
            } else {
                baujahrText = 'Nicht angegeben';
            }

            doc.autoTable({
                startY: y,
                head: [['FAHRZEUGDATEN', '']],
                body: [
                    ['Marke / Modell', `${data.marke} ${data.modell}`],
                    ['Baujahr', baujahrText],
                    ['KM-Stand', data.kmstand ? (data.kmstand + ' km') : 'Nicht angegeben'],
                    ['VIN/FIN', data.vin || 'Nicht angegeben']
                ],
                theme: 'grid',
                headStyles: {
                    fillColor: [0, 51, 102],
                    textColor: 255,
                    fontStyle: 'bold',
                    fontSize: 11
                },
                bodyStyles: { fontSize: 10 },
                columnStyles: {
                    0: { fontStyle: 'bold', cellWidth: 50 },
                    1: { cellWidth: 130 }
                },
                margin: { left: 15, right: 15 }
            });

            y = doc.lastAutoTable.finalY + 5;

            // LACKIER-INFO (NUR f√ºr Lackierung & Alle Services ODER wenn Lack-Felder ausgef√ºllt)
            const hasPaintData = data.farbnummer || data.farbname || data.farbvariante;
            if (data.serviceTyp === 'lackierung' || data.serviceTyp === 'lackier' || data.serviceTyp === 'alle' || hasPaintData) {
                y += 12;
                doc.setFillColor(245, 87, 108);
                doc.rect(15, y - 5, 180, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(13);
                doc.text('[!] LACKIER-INFORMATIONEN (FUER FARBKABINE)', 20, y);

                y += 10;
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);

                // Farbname
                doc.setFont(undefined, 'bold');
                doc.text('Farbname:', 20, y);
                doc.setFont(undefined, 'normal');
                doc.text(data.farbname || 'Nicht angegeben', 55, y);
                y += 7;

                // Farbvariante
                doc.setFont(undefined, 'bold');
                doc.text('Farbvariante:', 20, y);
                doc.setFont(undefined, 'normal');
                doc.text(data.farbvariante || 'Nicht angegeben', 55, y);
                y += 7;

                // FARBNUMMER GROSS
                doc.setFillColor(255, 243, 205);
                doc.rect(15, y - 3, 180, 12, 'F');
                doc.setFont(undefined, 'bold');
                doc.setFontSize(14);
                doc.setTextColor(199, 37, 78);
                doc.text('FARBNUMMER:', 20, y + 4);
                doc.setFontSize(18);
                doc.text(data.farbnummer || 'Nicht angegeben', 70, y + 4);

                y += 15;
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text('Lackart:', 20, y);
                doc.setFont(undefined, 'normal');
                doc.text(data.lackart || 'Standard', 55, y);

                y += 7; // Extra spacing after Lackier-Info
            }

            // Page-Break-Check vor Schadensbeschreibung (Fix: Erste Seite abgeschnitten)
            if (y > 230) {
                doc.addPage();
                y = 20;
            }

            // Notizen
            y += 12;
            doc.setFont(undefined, 'bold');
            doc.text('Schadensbeschreibung / Notizen:', 20, y);
            y += 7;
            doc.setFont(undefined, 'normal');
            if (data.notizen) {
                const notizen = doc.splitTextToSize(data.notizen, 170);
                doc.text(notizen, 20, y);
                y += notizen.length * 5 + 5;
            } else {
                doc.text('Keine Notizen angegeben', 20, y);
                y += 10;
            }

            // Page-Break-Check vor Partner-Anfragen (Fix: Erste Seite abgeschnitten)
            if (y > 220) {
                doc.addPage();
                y = 20;
            }

            // PREIS-KALKULATION (Partner-Anfrage mit KVA ODER einfacher Preis)
            // üí∞ PREISE-BERECHTIGUNG: Nur anzeigen wenn Berechtigung vorhanden
            const canShowPrices = typeof window.canViewPrices === 'function' ? window.canViewPrices() : true;

            if (canShowPrices && data.kva && data.kva.varianten && data.gewaehlteVariante) {
                // Partner-Anfrage: KVA-Details anzeigen
                y += 15;

                // Header
                doc.setFillColor(33, 150, 243);  // Blau f√ºr KVA
                doc.rect(15, y - 5, 180, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(13);
                doc.text('PREIS-KALKULATION (Partner-Anfrage)', 20, y);

                y += 10;
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);

                // Partner-Info
                if (data.quelle === 'Partner-Portal' && data.partnerName) {
                    doc.setFont(undefined, 'normal');
                    doc.text('Partner: ' + data.partnerName, 20, y);
                    y += 5;
                }

                y += 5;

                // Tabellen-Header
                doc.setFillColor(240, 240, 240);
                doc.rect(15, y - 3, 180, 7, 'F');
                doc.setFont(undefined, 'bold');
                doc.setFontSize(9);
                doc.text('Beschreibung', 20, y);
                doc.text('Menge', 140, y);
                doc.text('Einzelpreis', 160, y);
                doc.text('Gesamt', 185, y);

                y += 7;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);

                // üÜï MULTI-SERVICE BREAKDOWN RENDERING
                const variante = data.kva.varianten[data.gewaehlteVariante];

                if (data.kva.isMultiService && data.kva.breakdown) {
                    // Multi-Service: Render breakdown by service
                    console.log('üì¶ [PDF] Rendere Multi-Service Breakdown');

                    const breakdown = data.kva.breakdown;
                    const serviceLabels = data.kva.serviceLabels || {};
                    const serviceNames = {
                        'lackierung': 'üé® Lackierung',  // üîß FIX: lackierung (konsistent mit SERVICE_TEMPLATES)
                        'reifen': 'üõû Reifen-Service',
                        'mechanik': 'üîß Mechanik-Service',
                        'pflege': '‚ú® Fahrzeug-Pflege',
                        'tuev': 'üìã T√úV/AU',
                        'versicherung': 'üõ°Ô∏è Versicherung',
                        'glas': 'üîç Glas-Reparatur',
                        'klima': '‚ùÑÔ∏è Klima-Service',
                        'dellen': 'üî® Dellen-Reparatur',
                        'folierung': 'üåà Folierung',
                        'steinschutz': 'üõ°Ô∏è Steinschutz',
                        'werbebeklebung': 'üì¢ Fahrzeugbeschriftung'
                    };

                    // F√ºr jeden Service eine Section
                    Object.keys(breakdown).forEach((serviceTyp, index) => {
                        const service = breakdown[serviceTyp];

                        if (y > 240) {
                            doc.addPage();
                            y = 20;
                        }

                        // Service-√úberschrift
                        if (index > 0) y += 5; // Abstand zwischen Services
                        doc.setFillColor(230, 242, 253);
                        doc.rect(15, y - 3, 180, 7, 'F');
                        doc.setFont(undefined, 'bold');
                        doc.setFontSize(10);
                        doc.setTextColor(0, 51, 102);
                        doc.text(serviceNames[serviceTyp] || serviceTyp, 20, y);
                        doc.setTextColor(0, 0, 0);
                        y += 7;
                        doc.setFont(undefined, 'normal');
                        doc.setFontSize(9);

                        // Fields f√ºr diesen Service
                        service.fields.forEach(fieldName => {
                            const value = variante[fieldName] || 0;
                            if (value === 0) return; // Skip 0‚Ç¨ Felder

                            if (y > 250) {
                                doc.addPage();
                                y = 20;
                            }

                            const label = serviceLabels[fieldName] || fieldName;
                            const beschreibung = doc.splitTextToSize(label, 150);
                            doc.text(beschreibung, 20, y);
                            doc.setFont(undefined, 'bold');
                            doc.text(value.toFixed(2) + ' ‚Ç¨', 185, y);
                            doc.setFont(undefined, 'normal');

                            y += Math.max(5, beschreibung.length * 4);
                        });

                        // Service-Summe
                        y += 2;
                        doc.setFont(undefined, 'bold');
                        doc.setFontSize(10);
                        doc.text(`Summe ${serviceNames[serviceTyp] || serviceTyp}:`, 140, y);
                        doc.text(service.gesamt.toFixed(2) + ' ‚Ç¨', 185, y);
                        doc.setFont(undefined, 'normal');
                        doc.setFontSize(9);
                        y += 8;
                    });

                    y -= 3; // Korrektur nach letztem Service

                } else {
                    // Single-Service: Existing positionen logic
                    const positionen = variante.positionen || [];

                for (let i = 0; i < positionen.length; i++) {
                    const pos = positionen[i];

                    if (y > 250) {
                        doc.addPage();
                        y = 20;
                    }

                    const beschreibung = doc.splitTextToSize(pos.beschreibung || 'Position', 115);
                    doc.text(beschreibung, 20, y);

                    const menge = (pos.menge || 1).toString();
                    const einzelpreis = (pos.einzelpreis || 0).toFixed(2);
                    const gesamt = (pos.gesamt || (pos.menge * pos.einzelpreis) || 0).toFixed(2);

                    doc.text(menge + 'x', 140, y);
                    doc.text(einzelpreis + ' ‚Ç¨', 160, y);
                    doc.setFont(undefined, 'bold');
                    doc.text(gesamt + ' ‚Ç¨', 185, y);
                    doc.setFont(undefined, 'normal');

                    y += Math.max(5, beschreibung.length * 4);
                }

                y += 5;
                }  // üÜï Ende des else-Blocks (Single-Service)

                // Summen-Block
                doc.setDrawColor(200, 200, 200);
                doc.line(15, y, 195, y);
                y += 7;

                // Netto
                if (variante.netto) {
                    doc.setFont(undefined, 'normal');
                    doc.text('Netto:', 160, y);
                    doc.text((variante.netto || 0).toFixed(2) + ' EUR', 185, y);
                    y += 5;
                }

                // MwSt
                if (variante.mwst) {
                    doc.text('MwSt 19%:', 160, y);
                    doc.text((variante.mwst || 0).toFixed(2) + ' EUR', 185, y);
                    y += 5;
                }

                // Gesamt (fett & gr√ºn)
                y += 3;
                doc.setFillColor(76, 175, 80);
                doc.rect(155, y - 5, 40, 10, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(12);
                doc.text('GESAMT:', 160, y);
                doc.setFontSize(14);
                doc.text((variante.gesamt || data.vereinbarterPreis || 0).toFixed(2) + ' EUR', 185, y);

                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);
                y += 10;

            } else if (canShowPrices && data.vereinbarterPreis) {
                // Direkte Annahme: Einfacher Preis (wie bisher)
                y += 15;
                doc.setFillColor(76, 175, 80);
                doc.rect(15, y - 5, 180, 12, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(13);
                doc.text('>>> VEREINBARTER PREIS:', 20, y + 2);
                doc.setFontSize(16);
                doc.text(data.vereinbarterPreis.toFixed(2) + ' EUR', 90, y + 2);
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);
                y += 5;
            }

            // Vorher-Fotos
            doc.setFont(undefined, 'bold');
            doc.setFontSize(14);
            doc.text('VORHER-Fotos (Annahme):', 20, y);
            y += 10;

            // ‚úÖ FIX: Nov 21, 2025 - Pattern 37: Use pre-converted Base64 photos
            // Photos are converted BEFORE createPDF() using convertPhotoUrlsToBase64()
            const vorherPhotosBase64 = data.photosBase64 || [];
            console.log(`üì∏ [PDF] VORHER-Fotos: ${vorherPhotosBase64.length} Photos (Base64-konvertiert)`);

            for (let i = 0; i < vorherPhotosBase64.length; i += 2) {
                if (y > 240) {
                    doc.addPage();
                    y = 20;
                }

                const imgWidth = 80;
                const imgHeight = 60;

                safeAddImage(vorherPhotosBase64[i], 'JPEG', 20, y, imgWidth, imgHeight, `Vorher-Foto ${i+1}`);
                if (i + 1 < vorherPhotosBase64.length) {
                    safeAddImage(vorherPhotosBase64[i + 1], 'JPEG', 110, y, imgWidth, imgHeight, `Vorher-Foto ${i+2}`);
                }

                y += imgHeight + 10;
            }

            // PRODUKTIONSFORTSCHRITT (Prozess-Fotos aus Kanban)
            const prozessFotos = data.prozessFotos || [];
            if (prozessFotos.length > 0) {
                y += 15;

                // Check page overflow before header (Fix: Erste Seite abgeschnitten - von 240 auf 200 reduziert)
                if (y > 200) {
                    doc.addPage();
                    y = 20;
                }

                // Header mit lila Hintergrund
                doc.setFillColor(156, 39, 176);  // Lila
                doc.rect(15, y - 5, 180, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(13);
                doc.text('PRODUKTIONSFORTSCHRITT (Status-Updates)', 20, y);
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'normal');
                y += 10;

                // Status-Namen Mapping (Deutsch)
                const statusNames = {
                    'vorbereitung': 'Vorbereitung',
                    'lackierung': 'Lackierung',
                    'qualitaetskontrolle': 'Qualit√§tskontrolle',
                    'trocknung': 'Trocknung',
                    'reparatur': 'Reparatur',
                    'montage': 'Montage',
                    'wuchten': 'Wuchten',
                    'aufbereitung': 'Aufbereitung',
                    'qualitaet': 'Qualit√§t',
                    'pruefung': 'Pr√ºfung',
                    'diagnose': 'Diagnose'
                };

                // Prozess-Fotos rendern (2 Spalten wie Vorher/Nachher)
                for (let i = 0; i < prozessFotos.length; i += 2) {
                    // Check page overflow
                    if (y > 200) {
                        doc.addPage();
                        y = 20;
                    }

                    const imgWidth = 80;
                    const imgHeight = 60;

                    // Linke Spalte
                    const leftEntry = prozessFotos[i];
                    const leftStatusName = statusNames[leftEntry.status] || leftEntry.status.toUpperCase();
                    const leftDate = new Date(leftEntry.timestamp).toLocaleDateString('de-DE');
                    const leftTime = new Date(leftEntry.timestamp).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });

                    // Status + Datum √ºber Foto (links)
                    doc.setFont(undefined, 'bold');
                    doc.setFontSize(10);
                    doc.text(`${leftStatusName} - ${leftDate} ${leftTime}`, 20, y);
                    y += 5;

                    // Foto (links)
                    safeAddImage(leftEntry.foto, 'JPEG', 20, y, imgWidth, imgHeight, `Prozess-Foto ${i+1}`);

                    // Notiz unter Foto (links) - falls vorhanden
                    if (leftEntry.notiz && leftEntry.notiz.trim()) {
                        doc.setFont(undefined, 'normal');
                        doc.setFontSize(8);
                        doc.setTextColor(100, 100, 100);
                        const notizLines = doc.splitTextToSize(leftEntry.notiz, imgWidth - 4);
                        doc.text(notizLines, 22, y + imgHeight + 3);
                        doc.setTextColor(0, 0, 0);
                    }

                    // Rechte Spalte (falls vorhanden)
                    if (i + 1 < prozessFotos.length) {
                        const rightEntry = prozessFotos[i + 1];
                        const rightStatusName = statusNames[rightEntry.status] || rightEntry.status.toUpperCase();
                        const rightDate = new Date(rightEntry.timestamp).toLocaleDateString('de-DE');
                        const rightTime = new Date(rightEntry.timestamp).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });

                        // Status + Datum √ºber Foto (rechts)
                        doc.setFont(undefined, 'bold');
                        doc.setFontSize(10);
                        doc.text(`${rightStatusName} - ${rightDate} ${rightTime}`, 110, y - 5);

                        // Foto (rechts)
                        safeAddImage(rightEntry.foto, 'JPEG', 110, y, imgWidth, imgHeight, `Prozess-Foto ${i+2}`);

                        // Notiz unter Foto (rechts) - falls vorhanden
                        if (rightEntry.notiz && rightEntry.notiz.trim()) {
                            doc.setFont(undefined, 'normal');
                            doc.setFontSize(8);
                            doc.setTextColor(100, 100, 100);
                            const notizLines = doc.splitTextToSize(rightEntry.notiz, imgWidth - 4);
                            doc.text(notizLines, 112, y + imgHeight + 3);
                            doc.setTextColor(0, 0, 0);
                        }
                    }

                    y += imgHeight + 12;  // Extra Abstand f√ºr Timeline-Feeling
                }

                y += 5;
            }

            y += 10;
            doc.setFont(undefined, 'bold');
            doc.setFontSize(14);
            doc.text('NACHHER-Fotos (Abnahme):', 20, y);
            y += 10;

            // ‚úÖ FIX: Nov 21, 2025 - Pattern 37: Use pre-converted Base64 photos
            const nachherPhotosForPDF = data.nachherPhotosBase64 || [];
            console.log(`üì∏ [PDF] NACHHER-Fotos: ${nachherPhotosForPDF.length} Photos (Base64-konvertiert)`);

            for (let i = 0; i < nachherPhotosForPDF.length; i += 2) {
                if (y > 240) {
                    doc.addPage();
                    y = 20;
                }

                const imgWidth = 80;
                const imgHeight = 60;

                safeAddImage(nachherPhotosForPDF[i], 'JPEG', 20, y, imgWidth, imgHeight, `Nachher-Foto ${i+1}`);
                if (i + 1 < nachherPhotosForPDF.length) {
                    safeAddImage(nachherPhotosForPDF[i + 1], 'JPEG', 110, y, imgWidth, imgHeight, `Nachher-Foto ${i+2}`);
                }

                y += imgHeight + 10;
            }

            // Unterschriften
            if (y > 180) {
                doc.addPage();
                y = 20;
            }

            y += 10;
            doc.setFont(undefined, 'bold');
            doc.setFontSize(12);
            doc.text('Unterschrift Annahme:', 20, y);
            doc.text('Unterschrift Abnahme:', 110, y);
            y += 5;

            safeAddImage(data.signature, 'PNG', 20, y, 70, 25, 'Annahme-Unterschrift');
            safeAddImage(data.abnahmeSignature, 'PNG', 110, y, 70, 25, 'Abnahme-Unterschrift');

            // Footer with Contact Details
            const pageHeight = doc.internal.pageSize.height;
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            const footerText = `${settings.profil.adresse} | Tel: ${settings.profil.telefon} | Email: ${settings.profil.email}`;
            doc.text(footerText, 105, pageHeight - 10, { align: 'center' });
            console.log('‚úÖ Footer mit Kontaktdaten hinzugef√ºgt');

            // PDF speichern
            const filename = `Abnahme_${data.kennzeichen.replace(/\s/g, '_')}_${data.abnahmeDatum.replace(/\./g, '')}.pdf`;
            doc.save(filename);

            if (failedImages > 0) {
                console.warn(`‚ö†Ô∏è ${failedImages} Foto(s) konnten nicht geladen werden`);
                setTimeout(() => {
                    showToast(`‚ö†Ô∏è ${failedImages} Foto(s) konnten nicht geladen werden. PDF enth√§lt Platzhalter-Fotos.`, 'warning', 6000);
                }, 500);
            }
        }

        // Error/Success anzeigen
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.querySelector('span').textContent = message;
            errorDiv.style.display = 'flex';
            feather.replace();
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 4000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.querySelector('span').textContent = message;
            successDiv.style.display = 'flex';
            feather.replace();
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        function resetForm() {
            document.getElementById('vehicleInfo').style.display = 'none';
            document.getElementById('photoComparison').style.display = 'none';
            document.getElementById('signatureSection').style.display = 'none';
            document.getElementById('submitBtn').style.display = 'none';
            currentVehicle = null;
            nachherPhotos = [];
            updateNachherGrid();
            clearSignature();
        }

        // ============================================
        // üåì THEME TOGGLE SYSTEM (mit Feather Icons Stroke-Width Update)
        // ============================================

        (function initThemeToggle() {
            const themeToggle = document.getElementById('themeToggle');
            const html = document.documentElement;

            // Update Feather Icons stroke-width based on theme
            function updateFeatherIcons(theme) {
                const strokeWidth = theme === 'light' ? '2.5' : '2';
                document.querySelectorAll('i[data-feather]').forEach(icon => {
                    const svg = icon.querySelector('svg');
                    if (svg) {
                        svg.querySelectorAll('*[stroke]').forEach(element => {
                            element.setAttribute('stroke-width', strokeWidth);
                        });
                    }
                });
            }

            // Load theme from localStorage (default: dark)
            let currentTheme = localStorage.getItem('theme') || 'dark';
            html.setAttribute('data-theme', currentTheme);

            // Theme toggle on button click (direkt registrieren wegen registerDOM Race Condition)
            if (themeToggle) {
                const themeToggleHandler = () => {
                    currentTheme = currentTheme === 'light' ? 'dark' : 'light';
                    html.setAttribute('data-theme', currentTheme);
                    localStorage.setItem('theme', currentTheme);

                    // Update Signature Canvas Stroke Color basierend auf Theme
                    if (canvas && ctx) {
                        ctx.strokeStyle = currentTheme === 'dark' ? '#ffffff' : '#000000';
                        console.log(`üñäÔ∏è Canvas stroke color updated to: ${ctx.strokeStyle}`);
                    }

                    // Re-initialize Feather Icons with updated stroke-width
                    if (typeof feather !== 'undefined') {
                        feather.replace();
                        setTimeout(() => updateFeatherIcons(currentTheme), 50);
                    }

                    console.log(`‚úÖ Theme switched to: ${currentTheme}`);
                };
                themeToggle.addEventListener('click', themeToggleHandler);
            }

            // Initialize Feather Icons on load with correct stroke-width
            if (typeof feather !== 'undefined') {
                feather.replace();
                setTimeout(() => updateFeatherIcons(currentTheme), 50);
            }

            console.log(`üåì Theme loaded: ${currentTheme}`);
        })();
    </script>

    <!-- Error Handler & Storage Monitor -->
    <script src="error-handler.js"></script>
    <script src="listener-registry.js?v=6020c9e"></script>
    <script src="storage-monitor.js"></script>

    <!-- KI-Chat-Assistent -->
    <div id="aiChatWidget"></div>
    <script src="js/ai-agent-tools.js"></script>
    <script src="js/ai-agent-engine.js"></script>
    <script src="js/ai-chat-widget.js"></script>

    <!-- ============================================
         SERVICE WORKER REGISTRATION - Offline-Funktionalit√§t
         ============================================ -->
    <script>
        // Service Worker nur registrieren wenn:
        // 1. Browser unterst√ºtzt Service Worker
        // 2. NICHT in Playwright Tests (navigator.webdriver)
        // 3. NICHT auf Emulator-Port (8000)
        if ('serviceWorker' in navigator && !navigator.webdriver && window.location.port !== '8000') {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('./sw.js', {
                        scope: './'
                    });

                    console.log('‚úÖ [SW] Service Worker registriert:', registration.scope);

                    // Update-Handling: Neuen SW aktivieren wenn gefunden
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('üîÑ [SW] Update gefunden, installiere...');

                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                console.log('‚úÖ [SW] Update bereit! Seite neu laden f√ºr neue Version.');

                                // Optional: Auto-reload nach 3 Sekunden
                                // setTimeout(() => window.location.reload(), 3000);
                            }
                        });
                    });

                } catch (error) {
                    console.error('‚ùå [SW] Registrierung fehlgeschlagen:', error);
                }
            });
        } else {
            console.log('‚ÑπÔ∏è [SW] Service Worker nicht registriert (Test-Modus oder nicht unterst√ºtzt)');
        }
    </script>
</body>
</html>
