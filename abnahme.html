<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fahrzeug-Abnahme | Auto-Lackierzentrum Mosbach</title>

    <!-- Mobile-Responsive CSS Framework -->
    <link rel="stylesheet" href="mobile-responsive.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #11998e;
        }

        .header h1 {
            color: #11998e;
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #11998e;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .form-group input[type="text"],
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-group input[type="text"]:focus,
        .form-group select:focus {
            outline: none;
            border-color: #11998e;
            box-shadow: 0 0 10px rgba(17,153,142,0.1);
        }

        .vehicle-info {
            background: #f0f9ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            display: none;
        }

        .vehicle-info.show {
            display: block;
        }

        .vehicle-info h3 {
            color: #11998e;
            margin-bottom: 10px;
        }

        .vehicle-info p {
            margin: 5px 0;
            color: #333;
        }

        .photo-comparison {
            margin-bottom: 25px;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .photo-column {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
        }

        .photo-column h4 {
            color: #11998e;
            margin-bottom: 10px;
            text-align: center;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }

        .photo-item {
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-item.empty {
            border: 2px dashed #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .photo-item.empty:hover {
            border-color: #11998e;
            transform: scale(1.05);
        }

        .photo-item.empty::before {
            content: '📷';
            font-size: 30px;
        }

        .remove-photo {
            position: relative;
            width: 100%;
            padding: 5px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 5px;
        }

        #photoInput {
            display: none;
        }

        .signature-section {
            margin-bottom: 25px;
        }

        #signatureCanvas {
            width: 100%;
            height: 200px;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: crosshair;
            touch-action: none;
        }

        .signature-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-search {
            background: #11998e;
            color: white;
        }

        .btn-search:hover {
            background: #0e8074;
        }

        .btn-clear {
            background: #f5f5f5;
            color: #333;
            flex: 1;
        }

        .btn-clear:hover {
            background: #e0e0e0;
        }

        .btn-finish {
            background: #11998e;
            color: white;
            font-size: 18px;
            padding: 15px 30px;
            width: 100%;
            margin-top: 20px;
        }

        .btn-finish:hover {
            background: #0e8074;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(17,153,142,0.3);
        }

        .btn-finish:active {
            transform: translateY(0);
        }

        .info-box {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 25px;
            color: #11998e;
            font-size: 14px;
        }

        .error-message {
            display: none;
            background: #ff5252;
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
        }

        .success-message {
            display: none;
            background: #4caf50;
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .date-display {
            color: #666;
            font-size: 14px;
            text-align: right;
            margin-bottom: 20px;
        }

        .dropdown-section {
            margin-bottom: 20px;
        }

        .dropdown-section select {
            width: 100%;
            padding: 14px 15px;
            border: 2px solid #11998e;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            background: white;
            color: #333;
            cursor: pointer;
            transition: all 0.3s;
        }

        .dropdown-section select:hover {
            border-color: #0d7a6f;
            box-shadow: 0 0 15px rgba(17,153,142,0.2);
        }

        .dropdown-section select:focus {
            outline: none;
            border-color: #0d7a6f;
            box-shadow: 0 0 20px rgba(17,153,142,0.3);
        }

        .divider-text {
            text-align: center;
            margin: 25px 0;
            position: relative;
        }

        .divider-text::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #ddd;
        }

        .divider-text span {
            background: white;
            padding: 0 15px;
            position: relative;
            color: #999;
            font-size: 13px;
            font-weight: 600;
        }

        .search-section {
            margin-bottom: 20px;
        }

        /* Navigation Bar */
        .nav-bar {
            background: white;
            padding: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            border-bottom: 3px solid #11998e;
            margin-bottom: 20px;
            border-radius: 15px 15px 0 0;
        }

        .nav-btn {
            padding: 10px 20px;
            background: #11998e;
            color: white;
            text-decoration: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .nav-btn:hover {
            background: #0e8074;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(17,153,142,0.3);
        }

        .nav-btn.active {
            background: #0e8074;
        }

        @media (max-width: 768px) {
            .comparison-grid {
                grid-template-columns: 1fr;
            }

            .nav-bar {
                flex-direction: column;
                gap: 8px;
            }

            .nav-btn {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 24px;
            }

            .header p {
                font-size: 14px;
            }

            .nav-btn {
                padding: 10px 15px;
                font-size: 13px;
            }

            .form-group label {
                font-size: 13px;
            }

            .form-group select {
                font-size: 14px;
                padding: 10px;
                min-height: 44px;
            }

            .comparison-box h3 {
                font-size: 16px;
            }

            .photo-grid {
                grid-template-columns: 1fr;
            }

            .btn {
                padding: 12px;
                font-size: 14px;
                min-height: 44px;
            }

            .btn-photo {
                padding: 30px;
            }

            #signaturePad {
                height: 150px;
            }
        }

        @media (max-width: 320px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 20px;
            }

            .nav-btn {
                padding: 8px 12px;
                font-size: 12px;
            }

            .form-group label {
                font-size: 12px;
            }

            .form-group select {
                font-size: 13px;
            }

            .comparison-box h3 {
                font-size: 14px;
            }

            .btn {
                padding: 10px;
                font-size: 13px;
            }

            #signaturePad {
                height: 120px;
            }
        }
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <!-- Firebase Konfiguration -->
    <script src="firebase-config.js?v=002ceca"></script>

    <!-- Image Optimizer -->
    <script src="image-optimizer.js"></script>

    <!-- Global Chat Notifications -->
    <link rel="stylesheet" href="global-chat-notifications.css">
    <script src="global-chat-notifications.js"></script>
</head>
<body>
    <div class="container">
        <!-- Navigation -->
        <div class="nav-bar">
            <a href="index.html" class="nav-btn">🏠 Home</a>
            <a href="annahme.html" class="nav-btn">📋 Annahme</a>
            <a href="abnahme.html" class="nav-btn active">✅ Abnahme</a>
            <a href="liste.html" class="nav-btn">📊 Übersicht</a>
            <a href="kunden.html" class="nav-btn">👥 Kunden</a>
            <a href="kanban.html" class="nav-btn">🎯 Prozessüberwachung</a>
        </div>

        <div class="header">
            <h1>✅ Fahrzeug-Abnahme</h1>
            <p>Auto-Lackierzentrum Mosbach</p>
        </div>

        <div class="date-display">
            Datum: <strong id="currentDate"></strong>
        </div>

        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage">
            ✅ Fahrzeug erfolgreich abgenommen!
        </div>

        <div class="info-box">
            💡 <strong>Tipp:</strong> Wählen Sie ein Fahrzeug aus dem Dropdown oder geben Sie das Kennzeichen manuell ein. Machen Sie Nachher-Fotos aus den gleichen Winkeln wie die Vorher-Fotos.
        </div>

        <div class="dropdown-section">
            <label for="vehicleDropdown" style="font-weight: 600; color: #11998e; margin-bottom: 10px; display: block;">
                🚗 Fahrzeug auswählen (angenommene Fahrzeuge):
            </label>
            <select id="vehicleDropdown" onchange="selectFromDropdown()">
                <option value="">-- Fahrzeug auswählen --</option>
            </select>
        </div>

        <div class="divider-text">
            <span>ODER</span>
        </div>

        <div class="search-section">
            <label for="kennzeichenSearch" style="font-weight: 600; color: #11998e; margin-bottom: 10px; display: block;">
                ⌨️ Kennzeichen manuell eingeben:
            </label>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="kennzeichenSearch" placeholder="Kennzeichen eingeben (z.B. MOS-CG 123)" style="flex: 1;">
                <button class="btn btn-search" onclick="searchVehicle()">🔍 Suchen</button>
            </div>
        </div>

        <div class="vehicle-info" id="vehicleInfo"></div>

        <form id="abnahmeForm" style="display: none;">
            <div class="photo-comparison">
                <h3 style="color: #11998e; margin-bottom: 15px;">Foto-Vergleich</h3>
                <div class="comparison-grid">
                    <div class="photo-column">
                        <h4>⬅️ VORHER (Annahme)</h4>
                        <div class="photo-grid" id="vorherGrid"></div>
                    </div>
                    <div class="photo-column">
                        <h4>➡️ NACHHER (Abnahme)</h4>
                        <div class="photo-grid" id="nachherGrid">
                            <div class="photo-item empty" onclick="document.getElementById('photoInput').click()"></div>
                        </div>
                        <input type="file" id="photoInput" accept="image/*" capture="environment" multiple>
                    </div>
                </div>
            </div>

            <div class="signature-section">
                <label>Unterschrift Kunde (Abnahme) *</label>
                <canvas id="signatureCanvas" width="800" height="400"></canvas>
                <div class="signature-buttons">
                    <button type="button" class="btn btn-clear" onclick="clearSignature()">Löschen</button>
                </div>
            </div>

            <button type="submit" class="btn btn-finish">🎉 Abnahme abschließen & PDF erstellen</button>
        </form>
    </div>

    <script>
        // Firebase initialisieren
        let firebaseInitialized = false;
        // firebaseApp is provided by firebase-config.js as window.firebaseApp

        window.addEventListener('load', async function() {
            try {
                if (typeof initFirebase !== 'undefined') {
                    // ✅ BUG FIX: Prüfe window.firebaseInitialized
                    await initFirebase();
                    if (window.firebaseInitialized && window.firebaseApp) {
                        firebaseApp = window.firebaseApp;
                        firebaseInitialized = true;
                        console.log('✅ Firebase für Abnahme initialisiert');
                    }
                }
            } catch (error) {
                console.warn('⚠️ Firebase nicht verfügbar, verwende LocalStorage:', error);
            }

            // Dropdown mit angenommenen Fahrzeugen laden
            await loadDropdownVehicles();
        });

        // Aktuelles Datum anzeigen
        const heute = new Date();
        document.getElementById('currentDate').textContent = heute.toLocaleDateString('de-DE', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });

        let currentVehicle = null;
        let nachherPhotos = [];

        // Dropdown mit angenommenen Fahrzeugen laden
        async function loadDropdownVehicles() {
            console.log('🔄 loadDropdownVehicles() aufgerufen...');
            console.log('   Firebase initialized:', firebaseInitialized);
            console.log('   firebaseApp:', firebaseApp ? 'vorhanden' : 'null');

            const dropdown = document.getElementById('vehicleDropdown');
            if (!dropdown) {
                console.error('❌ Dropdown-Element nicht gefunden!');
                return;
            }

            try {
                let vehicles = [];

                if (firebaseInitialized && firebaseApp) {
                    // Firebase Firestore verwenden
                    console.log('   → Lade aus Firestore...');
                    const allVehicles = await firebaseApp.getAllFahrzeuge();
                    console.log('   → Alle Fahrzeuge:', allVehicles.length);
                    vehicles = allVehicles.filter(v => v.status === 'angenommen');
                    console.log('✅ Dropdown geladen: ' + vehicles.length + ' angenommene Fahrzeuge');
                } else {
                    // Fallback: LocalStorage verwenden
                    console.log('   → Lade aus LocalStorage...');
                    const fahrzeuge = JSON.parse(localStorage.getItem('fahrzeuge') || '[]');
                    console.log('   → Alle Fahrzeuge (LocalStorage):', fahrzeuge.length);
                    vehicles = fahrzeuge.filter(v => v.status === 'angenommen');
                    console.log('✅ Dropdown geladen (LocalStorage): ' + vehicles.length + ' angenommene Fahrzeuge');
                }

                // Migration: Alte baujahr-Werte in baujahrVon/baujahrBis konvertieren
                vehicles = vehicles.map(v => {
                    if (!v.baujahrVon && v.baujahr) {
                        v.baujahrVon = v.baujahr;
                        if (v.baujahr !== 'Älter') {
                            v.baujahrBis = v.baujahr;
                        }
                    }
                    return v;
                });

                // Dropdown leeren (außer Platzhalter)
                dropdown.innerHTML = '<option value="">-- Fahrzeug auswählen --</option>';

                // Fahrzeuge mit prozessStatus="bereit" zuerst anzeigen (PRIORISIERUNG)
                vehicles.sort((a, b) => {
                    const aBereit = (a.prozessStatus === 'bereit') ? 1 : 0;
                    const bBereit = (b.prozessStatus === 'bereit') ? 1 : 0;
                    if (aBereit !== bBereit) return bBereit - aBereit; // bereit zuerst
                    return b.id - a.id; // dann nach Datum (neueste zuerst)
                });

                // Dropdown befüllen
                vehicles.forEach(vehicle => {
                    const option = document.createElement('option');
                    option.value = vehicle.kennzeichen;
                    const bereitBadge = (vehicle.prozessStatus === 'bereit') ? ' 🎯 [BEREIT ZUR ABNAHME]' : '';
                    option.textContent = `${vehicle.kennzeichen} - ${vehicle.marke} ${vehicle.modell} - ${vehicle.kundenname}${bereitBadge}`;
                    dropdown.appendChild(option);
                });

                if (vehicles.length === 0) {
                    dropdown.innerHTML = '<option value="">Keine angenommenen Fahrzeuge vorhanden</option>';
                    dropdown.disabled = true;
                    console.log('ℹ️ Keine angenommenen Fahrzeuge gefunden');
                } else {
                    dropdown.disabled = false;
                    console.log('✅ Dropdown befüllt mit ' + vehicles.length + ' Fahrzeugen');
                }

            } catch (error) {
                console.error('❌ Fehler beim Laden des Dropdowns:', error);
                dropdown.innerHTML = '<option value="">Fehler beim Laden der Fahrzeuge</option>';
                dropdown.disabled = true;
            }
        }

        // Fahrzeug aus Dropdown auswählen
        async function selectFromDropdown() {
            const dropdown = document.getElementById('vehicleDropdown');
            const kennzeichen = dropdown.value;

            if (!kennzeichen) {
                // Zurücksetzen wenn "-- auswählen --" gewählt
                document.getElementById('vehicleInfo').classList.remove('show');
                document.getElementById('abnahmeForm').style.display = 'none';
                return;
            }

            // Kennzeichen in Suchfeld eintragen (für Konsistenz)
            document.getElementById('kennzeichenSearch').value = kennzeichen;

            // Fahrzeug laden mit bestehender searchVehicle Funktion
            await searchVehicle();
        }

        // Fahrzeug suchen
        async function searchVehicle() {
            const kennzeichen = document.getElementById('kennzeichenSearch').value.trim().toUpperCase();

            if (!kennzeichen) {
                showError('Bitte Kennzeichen eingeben!');
                return;
            }

            let vehicle = null;

            try {
                if (firebaseInitialized && firebaseApp) {
                    // Firebase Firestore verwenden
                    const allVehicles = await firebaseApp.getAllFahrzeuge();
                    vehicle = allVehicles.find(v => v.kennzeichen.toUpperCase() === kennzeichen && v.status === 'angenommen');
                    console.log('🔍 Suche in Firestore abgeschlossen');
                } else {
                    // Fallback: LocalStorage verwenden
                    const fahrzeuge = JSON.parse(localStorage.getItem('fahrzeuge') || '[]');
                    vehicle = fahrzeuge.find(v => v.kennzeichen.toUpperCase() === kennzeichen && v.status === 'angenommen');
                    console.log('🔍 Suche in LocalStorage abgeschlossen');
                }
            } catch (error) {
                console.error('❌ Fehler beim Suchen:', error);
                // Fallback zu LocalStorage bei Fehler
                const fahrzeuge = JSON.parse(localStorage.getItem('fahrzeuge') || '[]');
                vehicle = fahrzeuge.find(v => v.kennzeichen.toUpperCase() === kennzeichen && v.status === 'angenommen');
            }

            if (!vehicle) {
                showError(`Kein angenommenes Fahrzeug mit Kennzeichen "${kennzeichen}" gefunden!`);
                document.getElementById('vehicleInfo').classList.remove('show');
                document.getElementById('abnahmeForm').style.display = 'none';
                return;
            }

            // Fotos aus Firestore nachladen (falls nicht vorhanden)
            if (firebaseInitialized && firebaseApp && (!vehicle.photos || vehicle.photos.length === 0)) {
                try {
                    const photos = await firebaseApp.loadPhotosFromFirestore(vehicle.id, 'vorher');
                    vehicle.photos = photos;
                    console.log('🖼️ Vorher-Fotos aus Firestore geladen:', photos.length);
                } catch (e) {
                    // Fallback zu LocalStorage (für Migration)
                    const photos = firebaseApp.loadPhotosLocal(vehicle.id, 'vorher');
                    vehicle.photos = photos;
                    console.log('🖼️ Vorher-Fotos aus LocalStorage geladen (Fallback)');
                }
            }

            currentVehicle = vehicle;
            displayVehicleInfo(vehicle);
            document.getElementById('abnahmeForm').style.display = 'block';

            // Canvas NUR beim ersten Mal initialisieren
            // Danach nicht mehr, sonst wird Unterschrift gelöscht!
            if (!canvas.hasAttribute('data-initialized')) {
                setTimeout(() => {
                    initCanvas();
                    canvas.setAttribute('data-initialized', 'true');
                    console.log('✅ Canvas initialisiert für Unterschrift');
                }, 50);
            }
        }

        // Fahrzeug-Infos anzeigen
        function displayVehicleInfo(vehicle) {
            const infoDiv = document.getElementById('vehicleInfo');
            infoDiv.innerHTML = `
                <h3>📋 Fahrzeug-Informationen</h3>
                <p><strong>Kennzeichen:</strong> ${vehicle.kennzeichen}</p>
                <p><strong>Kundenname:</strong> ${vehicle.kundenname}</p>
                <p><strong>Fahrzeug:</strong> ${vehicle.marke} ${vehicle.modell}${vehicle.baujahr ? ` (${vehicle.baujahr})` : ''}</p>
                ${vehicle.kmstand ? `<p><strong>KM-Stand:</strong> ${vehicle.kmstand} km</p>` : ''}
                <p style="background: #fff3cd; padding: 10px; border-radius: 5px; margin-top: 10px;"><strong style="color: #c7254e;">🎨 FARBNUMMER:</strong> <span style="font-size: 18px; font-weight: bold; color: #c7254e;">${vehicle.farbnummer}</span> (${vehicle.lackart})</p>
                ${vehicle.farbname ? `<p><strong>Farbname:</strong> ${vehicle.farbname}</p>` : ''}
                <p><strong>Angenommen am:</strong> ${vehicle.datum} ${vehicle.zeit}</p>
                ${vehicle.notizen ? `<p><strong>Schadensbeschreibung:</strong> ${vehicle.notizen}</p>` : ''}
            `;
            infoDiv.classList.add('show');

            // Vorher-Fotos anzeigen
            const vorherGrid = document.getElementById('vorherGrid');
            vorherGrid.innerHTML = '';
            vehicle.photos.forEach(photo => {
                const div = document.createElement('div');
                div.className = 'photo-item';
                div.innerHTML = `<img src="${photo}" alt="Vorher-Foto">`;
                vorherGrid.appendChild(div);
            });
        }

        // Nachher-Fotos
        const photoInput = document.getElementById('photoInput');
        const nachherGrid = document.getElementById('nachherGrid');

        // Bild komprimieren mit ImageOptimizer (optimierte Speicher-Effizienz)
        async function compressImage(base64Image, profileName = 'nachherFoto') {
            // Nutze ImageOptimizer mit Fortschritts-Feedback
            const result = await ImageOptimizer.compressImage(
                base64Image,
                profileName,
                (progress, message) => {
                    // Optional: Zeige Progress in Console
                    if (progress === 100) {
                        console.log(`✅ ${message}`);
                    }
                }
            );

            // Statistiken ausgeben (für Debugging)
            console.log(`📊 Komprimierung: ${result.savings}% gespart (${(result.originalSize/1024).toFixed(0)}KB → ${(result.compressedSize/1024).toFixed(0)}KB)`);

            return result.compressed;
        }

        photoInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = async function(event) {
                    const compressed = await compressImage(event.target.result);
                    nachherPhotos.push(compressed);
                    updateNachherGrid();
                };
                reader.readAsDataURL(file);
            });
            e.target.value = '';
        });

        function updateNachherGrid() {
            nachherGrid.innerHTML = '';
            nachherPhotos.forEach((photo, index) => {
                const container = document.createElement('div');
                container.innerHTML = `
                    <div class="photo-item">
                        <img src="${photo}" alt="Nachher-Foto ${index + 1}">
                    </div>
                    <button class="remove-photo" onclick="removeNachherPhoto(${index})">❌ Löschen</button>
                `;
                nachherGrid.appendChild(container);
            });

            if (nachherPhotos.length < 10) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'photo-item empty';
                emptyDiv.onclick = () => photoInput.click();
                nachherGrid.appendChild(emptyDiv);
            }
        }

        function removeNachherPhoto(index) {
            nachherPhotos.splice(index, 1);
            updateNachherGrid();
        }

        // Unterschrift Canvas
        const canvas = document.getElementById('signatureCanvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let hasDrawn = false;

        // Canvas initialisieren
        function initCanvas() {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * 2;
            canvas.height = rect.height * 2;
            ctx.scale(2, 2);

            // Zeichenstil
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            // Platzhalter-Text
            if (!hasDrawn) {
                drawPlaceholder();
            }
        }

        function drawPlaceholder() {
            ctx.save();
            ctx.setTransform(1, 0, 0, 1, 0, 0); // Reset transformation
            ctx.fillStyle = '#ccc';
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('✍️ Hier unterschreiben', canvas.width / 2, canvas.height / 2);
            ctx.restore();
        }

        initCanvas();
        window.addEventListener('resize', initCanvas);

        function getCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            if (e.touches && e.touches.length > 0) {
                return {
                    x: (e.touches[0].clientX - rect.left) * scaleX / 2,
                    y: (e.touches[0].clientY - rect.top) * scaleY / 2
                };
            } else {
                return {
                    x: (e.clientX - rect.left) * scaleX / 2,
                    y: (e.clientY - rect.top) * scaleY / 2
                };
            }
        }

        function startDrawing(e) {
            e.preventDefault();
            isDrawing = true;

            // Lösche Platzhalter beim ersten Zeichnen
            if (!hasDrawn) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                hasDrawn = true;
            }

            const coords = getCoordinates(e);
            ctx.beginPath();
            ctx.moveTo(coords.x, coords.y);
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();

            const coords = getCoordinates(e);
            ctx.lineTo(coords.x, coords.y);
            ctx.stroke();
        }

        function stopDrawing(e) {
            if (!isDrawing) return;
            e.preventDefault();
            isDrawing = false;
            ctx.closePath();
        }

        // Mouse Events
        canvas.addEventListener('mousedown', startDrawing, false);
        canvas.addEventListener('mousemove', draw, false);
        canvas.addEventListener('mouseup', stopDrawing, false);
        canvas.addEventListener('mouseleave', stopDrawing, false);

        // Touch Events
        canvas.addEventListener('touchstart', startDrawing, { passive: false });
        canvas.addEventListener('touchmove', draw, { passive: false });
        canvas.addEventListener('touchend', stopDrawing, { passive: false });
        canvas.addEventListener('touchcancel', stopDrawing, { passive: false });

        function clearSignature() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            hasDrawn = false;
            drawPlaceholder();
        }

        // Form absenden
        document.getElementById('abnahmeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('🔄 Form Submit gestartet');

            if (!currentVehicle) {
                console.error('❌ Kein Fahrzeug geladen');
                showError('Kein Fahrzeug geladen!');
                return;
            }
            console.log('✅ Fahrzeug vorhanden:', currentVehicle.kennzeichen);

            if (nachherPhotos.length === 0) {
                console.error('❌ Keine Nachher-Fotos');
                showError('Bitte mindestens 1 Nachher-Foto machen!');
                return;
            }
            console.log('✅ Nachher-Fotos:', nachherPhotos.length);

            // Prüfe Unterschrift mit hasDrawn Flag (zuverlässiger!)
            if (!hasDrawn) {
                console.error('❌ Keine Unterschrift (hasDrawn=false)');
                showError('Bitte Unterschrift des Kunden einholen!');
                return;
            }
            console.log('✅ Unterschrift vorhanden');

            const signatureData = canvas.toDataURL();

            // Abnahme-Daten erstellen
            const jetzt = new Date(); // Aktuelle Zeit für Abnahme
            const timestamp = Date.now();

            // Prozess-Timestamps aktualisieren (Problem 7)
            if (!currentVehicle.prozessTimestamps) {
                currentVehicle.prozessTimestamps = {};
            }
            currentVehicle.prozessTimestamps.abgeschlossen = timestamp;

            const abnahmeData = {
                ...currentVehicle,
                abnahmeDatum: jetzt.toLocaleDateString('de-DE'),
                abnahmeZeit: jetzt.toLocaleTimeString('de-DE'),
                nachherPhotos,
                abnahmeSignature: signatureData,
                status: 'abgeschlossen',
                prozessStatus: 'abgeschlossen',  // FIX: Prozess-Status auch auf abgeschlossen setzen
                prozessTimestamps: currentVehicle.prozessTimestamps,
                lastModified: timestamp,  // Problem 10
                // 🔧 FIX BUG #3: bezahlt & rechnungGeschrieben initial setzen
                bezahlt: false,  // Initial unbezahlt (kann später in liste.html geändert werden)
                rechnungGeschrieben: false  // Initial keine Rechnung (kann später geändert werden)
            };

            // Hybrid-Update: Status in Firestore, Fotos in LocalStorage
            try {
                if (firebaseInitialized && firebaseApp) {
                    console.log('💾 Hybrid-Update: Status → Firestore, Nachher-Fotos → LocalStorage');

                    // 1. Nachher-Fotos in Firestore speichern (komprimiert)
                    await firebaseApp.savePhotosToFirestore(currentVehicle.id, nachherPhotos, 'nachher');

                    // 2. Status in Firestore aktualisieren
                    const dataForFirestore = {
                        ...abnahmeData
                    };
                    delete dataForFirestore.nachherPhotos;  // Fotos nicht in Firestore!

                    await firebaseApp.updateFahrzeug(currentVehicle.id, dataForFirestore);
                    console.log('✅ Status in Firestore aktualisiert (ohne Fotos)');
                    console.log('✅ Nachher-Fotos in LocalStorage gespeichert');

                    // 3. Vorher-Fotos aus Firestore laden für PDF
                    const vorherPhotos = await firebaseApp.loadPhotosFromFirestore(currentVehicle.id, 'vorher');

                    // 4. PDF mit beiden Fotos erstellen
                    const dataForPDF = {
                        ...abnahmeData,
                        photos: vorherPhotos,
                        nachherPhotos: nachherPhotos
                    };
                    await createPDF(dataForPDF);
                } else {
                    // Fallback: LocalStorage verwenden (mit Base64)
                    let fahrzeuge = JSON.parse(localStorage.getItem('fahrzeuge') || '[]');
                    const index = fahrzeuge.findIndex(v => v.id === currentVehicle.id);
                    if (index !== -1) {
                        fahrzeuge[index] = abnahmeData;
                        localStorage.setItem('fahrzeuge', JSON.stringify(fahrzeuge));
                    }
                    console.log('ℹ️ Fahrzeug in LocalStorage aktualisiert');

                    // PDF erstellen
                    await createPDF(abnahmeData);
                }
            } catch (error) {
                console.error('❌ Fehler beim Aktualisieren:', error);
                // Fallback zu LocalStorage bei Fehler
                let fahrzeuge = JSON.parse(localStorage.getItem('fahrzeuge') || '[]');
                const index = fahrzeuge.findIndex(v => v.id === currentVehicle.id);
                if (index !== -1) {
                    fahrzeuge[index] = abnahmeData;
                    localStorage.setItem('fahrzeuge', JSON.stringify(fahrzeuge));
                }
                console.log('⚠️ Fahrzeug in LocalStorage aktualisiert (Firestore-Fehler)');

                // PDF erstellen
                await createPDF(abnahmeData);
            }

            // Success
            document.getElementById('successMessage').style.display = 'block';

            // Dropdown aktualisieren (abgeschlossenes Fahrzeug entfernen)
            await loadDropdownVehicles();

            // Auto-Redirect zur Übersicht nach 2 Sekunden
            setTimeout(() => {
                console.log('→ Weiterleitung zur Übersicht...');
                window.location.href = 'liste.html';
            }, 2000);
        });

        // PDF erstellen
        async function createPDF(data) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Error-Counter für kaputte Fotos (Problem 9)
            let failedImages = 0;

            // Safe Image Add Function (Problem 9)
            const safeAddImage = (imageData, format, x, y, width, height, label = 'Foto') => {
                try {
                    if (!imageData || imageData === '') {
                        throw new Error('Leeres Foto');
                    }
                    doc.addImage(imageData, format, x, y, width, height);
                    return true;
                } catch (error) {
                    console.error(`❌ Fehler beim Hinzufügen des Bildes (${label}):`, error);
                    failedImages++;

                    // Fehlerfoto-Platzhalter einfügen
                    doc.setFillColor(240, 240, 240);
                    doc.rect(x, y, width, height, 'F');
                    doc.setDrawColor(200, 200, 200);
                    doc.rect(x, y, width, height, 'S');

                    doc.setFontSize(10);
                    doc.setTextColor(150, 150, 150);
                    doc.text('⚠️ Foto konnte nicht', x + width/2, y + height/2 - 5, { align: 'center' });
                    doc.text('geladen werden', x + width/2, y + height/2 + 5, { align: 'center' });
                    doc.setTextColor(0, 0, 0);

                    return false;
                }
            };

            // Header
            doc.setFillColor(17, 153, 142);
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.text('Fahrzeug-Abnahmeprotokoll', 105, 20, { align: 'center' });
            doc.setFontSize(12);
            doc.text('Auto-Lackierzentrum Mosbach', 105, 30, { align: 'center' });

            // Daten
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(12);
            let y = 55;

            doc.setFont(undefined, 'bold');
            doc.text('Annahme:', 20, y);
            doc.setFont(undefined, 'normal');
            doc.text(data.datum + ' ' + data.zeit, 60, y);

            y += 10;
            doc.setFont(undefined, 'bold');
            doc.text('Abnahme:', 20, y);
            doc.setFont(undefined, 'normal');
            doc.text(data.abnahmeDatum + ' ' + data.abnahmeZeit, 60, y);

            y += 10;
            doc.setFont(undefined, 'bold');
            doc.text('Kennzeichen:', 20, y);
            doc.setFont(undefined, 'normal');
            doc.text(data.kennzeichen, 60, y);

            y += 10;
            doc.setFont(undefined, 'bold');
            doc.text('Kundenname:', 20, y);
            doc.setFont(undefined, 'normal');
            doc.text(data.kundenname, 60, y);

            // Fahrzeugdaten
            y += 12;
            doc.setFillColor(17, 153, 142);
            doc.rect(15, y - 5, 180, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont(undefined, 'bold');
            doc.text('FAHRZEUGDATEN', 20, y);

            y += 10;
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'bold');
            doc.text('Marke:', 20, y);
            doc.setFont(undefined, 'normal');
            doc.text(data.marke, 50, y);
            doc.setFont(undefined, 'bold');
            doc.text('Modell:', 110, y);
            doc.setFont(undefined, 'normal');
            doc.text(data.modell, 140, y);

            y += 7;
            if (data.baujahr) {
                doc.setFont(undefined, 'bold');
                doc.text('Baujahr:', 20, y);
                doc.setFont(undefined, 'normal');
                doc.text(data.baujahr, 50, y);
            }
            if (data.kmstand) {
                doc.setFont(undefined, 'bold');
                doc.text('KM-Stand:', 110, y);
                doc.setFont(undefined, 'normal');
                doc.text(data.kmstand + ' km', 140, y);
            }

            // LACKIER-INFO
            y += 12;
            doc.setFillColor(245, 87, 108);
            doc.rect(15, y - 5, 180, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont(undefined, 'bold');
            doc.setFontSize(13);
            doc.text('[!] LACKIER-INFORMATIONEN', 20, y);

            y += 10;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(11);
            if (data.farbname) {
                doc.setFont(undefined, 'bold');
                doc.text('Farbname:', 20, y);
                doc.setFont(undefined, 'normal');
                doc.text(data.farbname, 55, y);
                y += 7;
            }

            // FARBNUMMER GROSS
            doc.setFillColor(255, 243, 205);
            doc.rect(15, y - 3, 180, 12, 'F');
            doc.setFont(undefined, 'bold');
            doc.setFontSize(14);
            doc.setTextColor(199, 37, 78);
            doc.text('FARBNUMMER:', 20, y + 4);
            doc.setFontSize(18);
            doc.text(data.farbnummer, 70, y + 4);

            y += 15;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('Lackart:', 20, y);
            doc.setFont(undefined, 'normal');
            doc.text(data.lackart, 55, y);

            if (data.notizen) {
                y += 12;
                doc.setFont(undefined, 'bold');
                doc.text('Notizen:', 20, y);
                y += 7;
                doc.setFont(undefined, 'normal');
                const notizen = doc.splitTextToSize(data.notizen, 170);
                doc.text(notizen, 20, y);
                y += notizen.length * 5 + 10;
            } else {
                y += 15;
            }

            // Vorher/Nachher Fotos
            doc.setFont(undefined, 'bold');
            doc.setFontSize(14);
            doc.text('VORHER-Fotos (Annahme):', 20, y);
            y += 10;

            for (let i = 0; i < data.photos.length; i += 2) {
                if (y > 240) {
                    doc.addPage();
                    y = 20;
                }

                const imgWidth = 80;
                const imgHeight = 60;

                safeAddImage(data.photos[i], 'JPEG', 20, y, imgWidth, imgHeight, `Vorher-Foto ${i+1}`);
                if (i + 1 < data.photos.length) {
                    safeAddImage(data.photos[i + 1], 'JPEG', 110, y, imgWidth, imgHeight, `Vorher-Foto ${i+2}`);
                }

                y += imgHeight + 10;
            }

            y += 10;
            doc.setFont(undefined, 'bold');
            doc.setFontSize(14);
            doc.text('NACHHER-Fotos (Abnahme):', 20, y);
            y += 10;

            // Nachher-Fotos (Base64 oder URLs)
            const nachherPhotosForPDF = data.nachherPhotosBase64 || data.nachherPhotos || [];

            for (let i = 0; i < nachherPhotosForPDF.length; i += 2) {
                if (y > 240) {
                    doc.addPage();
                    y = 20;
                }

                const imgWidth = 80;
                const imgHeight = 60;

                safeAddImage(nachherPhotosForPDF[i], 'JPEG', 20, y, imgWidth, imgHeight, `Nachher-Foto ${i+1}`);
                if (i + 1 < nachherPhotosForPDF.length) {
                    safeAddImage(nachherPhotosForPDF[i + 1], 'JPEG', 110, y, imgWidth, imgHeight, `Nachher-Foto ${i+2}`);
                }

                y += imgHeight + 10;
            }

            // Unterschriften
            if (y > 180) {
                doc.addPage();
                y = 20;
            }

            y += 10;
            doc.setFont(undefined, 'bold');
            doc.setFontSize(12);
            doc.text('Unterschrift Annahme:', 20, y);
            doc.text('Unterschrift Abnahme:', 110, y);
            y += 5;

            safeAddImage(data.signature, 'PNG', 20, y, 70, 25, 'Annahme-Unterschrift');
            safeAddImage(data.abnahmeSignature, 'PNG', 110, y, 70, 25, 'Abnahme-Unterschrift');

            // PDF speichern
            const filename = `Abnahme_${data.kennzeichen.replace(/\s/g, '_')}_${data.abnahmeDatum.replace(/\./g, '')}.pdf`;
            doc.save(filename);

            // Warnung bei fehlgeschlagenen Fotos (Problem 9)
            if (failedImages > 0) {
                console.warn(`⚠️ ${failedImages} Foto(s) konnten nicht geladen werden`);
                setTimeout(() => {
                    alert(`⚠️ HINWEIS\n\n${failedImages} Foto(s) konnten nicht geladen werden.\n\nDie PDF wurde trotzdem erstellt, aber enthält Platzhalter-Fotos.`);
                }, 500);
            }
        }

        // Error anzeigen
        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = '❌ ' + message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 4000);
        }
    </script>

    <!-- Error Handler & Storage Monitor -->
    <script src="error-handler.js"></script>
    <script src="storage-monitor.js"></script>
</body>
</html>
