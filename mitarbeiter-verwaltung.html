<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mitarbeiter-Verwaltung | Auto-Lackierzentrum Mosbach</title>

    <!-- Mobile-Responsive CSS Framework -->
    <link rel="stylesheet" href="mobile-responsive.css">

    <!-- Apple Liquid Glass Design System -->
    <link rel="stylesheet" href="design-system.css">
    <link rel="stylesheet" href="components.css">
    <link rel="stylesheet" href="animations.css">
    <link rel="stylesheet" href="mobile-first.css">
    <link rel="stylesheet" href="css/ai-chat-widget.css">

    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>

    <!-- GSAP Animation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', 'Inter', var(--font-system);
            background: var(--color-background);
            min-height: 100vh;
            padding: var(--space-6) var(--space-4) 100px;
            color: var(--color-text-primary);
            transition: background 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
            position: relative;
        }

        /* üé® Marken-Charakter: Dezentes Reflex-Pattern (Lack-Oberfl√§che) */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 50px,
                rgba(255, 255, 255, 0.02) 50px,
                rgba(255, 255, 255, 0.02) 51px
            );
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;

            /* Glassmorphismus - Apple Liquid Glass Style */
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);

            padding: var(--space-8);
            position: relative;
            overflow: hidden;

            /* ‚ú® Page-Transition: Slide-In beim Laden */
            animation: slideIn 0.4s cubic-bezier(0.22, 1, 0.36, 1);
        }

        /* üé¨ Page-Transition Animation */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Navigation Bar */
        .nav-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: var(--color-primary);
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            color: var(--color-text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 113, 227, 0.3);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: rgba(255, 0, 0, 0.2);
            border: 2px solid rgba(255, 0, 0, 0.5);
            color: #ff4444;
        }

        .btn-danger:hover {
            background: rgba(255, 0, 0, 0.3);
            transform: translateY(-2px);
        }

        /* Table */
        .mitarbeiter-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: var(--color-surface);
            border-radius: 12px;
            overflow: hidden;
        }

        .mitarbeiter-table thead {
            background: rgba(255, 255, 255, 0.1);
        }

        .mitarbeiter-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--color-text-primary);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .mitarbeiter-table td {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: var(--color-text-secondary);
        }

        .mitarbeiter-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
            border: 1px solid rgba(40, 167, 69, 0.4);
        }

        .badge-warning {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border: 1px solid rgba(255, 193, 7, 0.4);
        }

        .badge-danger {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.4);
        }

        .badge-info {
            background: rgba(0, 113, 227, 0.2);
            color: var(--color-primary);
            border: 1px solid rgba(0, 113, 227, 0.4);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--color-text-secondary);
        }

        .empty-state i {
            width: 64px;
            height: 64px;
            color: var(--color-text-secondary);
            opacity: 0.5;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
            color: var(--color-text-primary);
        }

        /* Theme Toggle Button */
        .theme-toggle {
            position: fixed;
            top: var(--space-4);
            right: var(--space-4);
            z-index: 10000;
            width: 56px;
            height: 56px;
            border-radius: var(--radius-full);
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            box-shadow: var(--shadow-lg), inset 0 1px 1px rgba(255,255,255,0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            border: none;
        }

        .theme-toggle:hover {
            transform: scale(1.1) rotate(15deg);
            box-shadow: var(--shadow-xl), inset 0 1px 1px rgba(255,255,255,0.2);
        }

        .theme-toggle__icon {
            position: absolute;
            width: 24px;
            height: 24px;
            color: var(--color-text-primary);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        /* Show sun icon in dark mode, moon in light mode */
        [data-theme="dark"] .theme-toggle__icon--light {
            opacity: 1;
            transform: rotate(0deg) scale(1);
        }

        [data-theme="dark"] .theme-toggle__icon--dark {
            opacity: 0;
            transform: rotate(180deg) scale(0);
        }

        :root .theme-toggle__icon--light,
        [data-theme="light"] .theme-toggle__icon--light {
            opacity: 0;
            transform: rotate(-180deg) scale(0);
        }

        :root .theme-toggle__icon--dark,
        [data-theme="light"] .theme-toggle__icon--dark {
            opacity: 1;
            transform: rotate(0deg) scale(1);
        }

        /* Dark Mode - Text & Borders */
        [data-theme="dark"] .mitarbeiter-table th,
        [data-theme="dark"] .mitarbeiter-table td {
            color: rgba(255, 255, 255, 0.9);
        }

        [data-theme="dark"] .header h1 {
            color: rgba(255, 255, 255, 0.95);
        }

        [data-theme="dark"] .nav-btn {
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.8);
            border-color: rgba(255, 255, 255, 0.2);
        }

        [data-theme="dark"] .nav-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #2ec8ff;
        }

        [data-theme="dark"] .nav-btn.active {
            background: rgba(46, 200, 255, 0.3);
            color: rgba(255, 255, 255, 1);
            border-color: rgba(46, 200, 255, 0.6);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .header h1 {
                font-size: 24px;
            }

            .header-actions {
                width: 100%;
            }

            .btn {
                flex: 1;
                justify-content: center;
            }

            .mitarbeiter-table {
                font-size: 14px;
            }

            .mitarbeiter-table th,
            .mitarbeiter-table td {
                padding: 10px;
            }

            .theme-toggle {
                width: 48px;
                height: 48px;
                top: var(--space-3);
                right: var(--space-3);
            }

            .theme-toggle__icon {
                width: 20px;
                height: 20px;
            }
        }

        /* üåô Dark Mode Fix f√ºr Edit Modal */
        [data-theme="dark"] #modalContent {
            background: #2a2a2d !important;
        }

        [data-theme="dark"] #newMitarbeiterModalContent {
            background: #2a2a2d !important;
        }

        /* ‚úÖ TOGGLE SWITCH CHECKBOXEN - iOS Style */
        .permission-checkbox {
            display: none; /* Hide original checkbox */
        }

        .permission-label {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .permission-label:hover {
            background: rgba(255,255,255,0.05);
        }

        /* Toggle Switch Container */
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 26px;
            background: rgba(255,255,255,0.15);
            border-radius: 13px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid rgba(255,255,255,0.2);
        }

        /* Toggle Slider */
        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Checked State */
        .permission-checkbox:checked + .permission-label .toggle-switch {
            background: linear-gradient(135deg, #34c759 0%, #30d158 100%); /* iOS Green */
            border-color: #34c759;
        }

        .permission-checkbox:checked + .permission-label .toggle-slider {
            transform: translateX(22px);
        }

        /* Permission Text */
        .permission-text {
            font-size: 14px;
            font-weight: 500;
            color: var(--color-text-secondary);
            transition: color 0.2s;
        }

        .permission-checkbox:checked + .permission-label .permission-text {
            color: var(--color-text-primary);
            font-weight: 600;
        }

        /* Hover Animation */
        .permission-label:hover .toggle-switch {
            transform: scale(1.05);
        }

        /* Active Animation (beim Klicken) */
        .permission-label:active .toggle-switch {
            transform: scale(0.95);
        }

        /* Dark Mode */
        [data-theme="dark"] .toggle-switch {
            background: rgba(255,255,255,0.1);
        }

        [data-theme="dark"] .toggle-slider {
            background: rgba(255,255,255,0.9);
        }

        /* Info Box Styles */
        .info-box {
            background: rgba(0, 113, 227, 0.1);
            border-left: 4px solid var(--color-primary);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info-box p {
            color: var(--color-text-primary);
            margin: 0;
        }

        .success-box {
            background: rgba(40, 167, 69, 0.1);
            border-left: 4px solid #28a745;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .success-box p {
            color: var(--color-text-primary);
            margin: 0;
        }
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

    <!-- jsPDF Library for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Firebase Konfiguration -->
    <script src="firebase-config.js?v=4412ea9"></script>

    <!-- Auth Manager -->
    <script src="js/auth-manager.js?v=20251027-multitenant"></script>

    <!-- Error Handler & Toast Notifications -->
    <script src="error-handler.js"></script>
</head>
<body>
    <!-- üåì THEME TOGGLE BUTTON - Fixed Top-Right -->
    <button id="themeToggle" class="theme-toggle" aria-label="Toggle Light/Dark Mode">
        <i data-feather="sun" class="theme-toggle__icon theme-toggle__icon--light"></i>
        <i data-feather="moon" class="theme-toggle__icon theme-toggle__icon--dark"></i>
    </button>

    <div class="container">
        <!-- Navigation -->
        <div class="nav-bar">
            <a href="index.html" class="nav-btn">Home</a>
            <a href="annahme.html" class="nav-btn">Annahme</a>
            <a href="abnahme.html" class="nav-btn">Abnahme</a>
            <a href="liste.html" class="nav-btn">√úbersicht</a>
            <a href="kunden.html" class="nav-btn">Kunden</a>
            <a href="kalender.html" class="nav-btn">Kalender</a>
            <a href="kanban.html" class="nav-btn">Prozess√ºberwachung</a>
            <a href="mitarbeiter-verwaltung.html" class="nav-btn active">Mitarbeiter</a>
        </div>

        <!-- Header -->
        <div class="header">
            <h1>
                üë• Mitarbeiter-Verwaltung
                <span id="werkstattName" style="font-size: 18px; color: var(--color-text-secondary); font-weight: 400;"></span>
            </h1>
            <div class="header-actions">
                <button class="btn btn-success" onclick="openNewMitarbeiterModal()">
                    ‚ûï Neuer Mitarbeiter
                </button>
                <button class="btn btn-primary" onclick="createTestData()" style="background: rgba(0, 113, 227, 0.3); border: 2px solid var(--color-primary);">
                    üß™ Test-Daten (3)
                </button>
                <!-- üÜï Phase 2.2: Dienstplan-Link -->
                <button class="btn btn-primary" onclick="window.location.href='dienstplan.html'" style="background: linear-gradient(135deg, #007aff, #0051d5);">
                    üìÖ Dienstplan
                </button>
            </div>
        </div>

        <!-- Success Info Box (MULTI-TENANT) -->
        <div class="success-box">
            <p>
                <strong>‚úÖ MULTI-TENANT READY!</strong><br>
                Diese Seite nutzt jetzt <code>mitarbeiter_{werkstattId}</code> Collection.<br>
                Mitarbeiter sind werkstatt-spezifisch isoliert! üè¢
            </p>
        </div>

        <!-- üÜï Phase 2.1: Tabs Navigation -->
        <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid rgba(255,255,255,0.1); padding-bottom: 0;">
            <button id="tabMitarbeiter" class="tab-button active" onclick="switchTab('mitarbeiter')" style="padding: 12px 24px; background: transparent; border: none; border-bottom: 3px solid var(--color-primary); color: var(--color-text-primary); font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                üë• Mitarbeiter
            </button>
            <button id="tabUrlaub" class="tab-button" onclick="switchTab('urlaub')" style="padding: 12px 24px; background: transparent; border: none; border-bottom: 3px solid transparent; color: var(--color-text-secondary); font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                üèñÔ∏è Urlaubs-Anfragen <span id="pendingCount" class="badge" style="display: inline-block; padding: 2px 8px; background: rgba(255, 59, 48, 0.8); border-radius: 12px; font-size: 12px; margin-left: 6px;">0</span>
            </button>
        </div>

        <!-- Tab Content: Mitarbeiter -->
        <div id="contentMitarbeiter" class="tab-content">
            <!-- Mitarbeiter Tabelle -->
        <table class="mitarbeiter-table">
            <thead>
                <tr>
                    <th>üë§ Name</th>
                    <th>üëî Rolle</th>
                    <th>üèñÔ∏è Urlaub</th>
                    <th>ü§í Krank</th>
                    <th>‚è±Ô∏è Stunden</th>
                    <th>üîë Passwort</th>
                    <th>‚úÖ Status</th>
                    <th>üîê Berechtigungen</th>
                    <th>‚öôÔ∏è Aktionen</th>
                </tr>
            </thead>
            <tbody id="mitarbeiterTableBody">
                <!-- Wird dynamisch gef√ºllt -->
                <tr>
                    <td colspan="9">
                        <div class="empty-state">
                            <i data-feather="users"></i>
                            <h3>L√§dt Mitarbeiter...</h3>
                            <p>Bitte warten...</p>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
        </div> <!-- End contentMitarbeiter -->

        <!-- Tab Content: Urlaubs-Anfragen -->
        <div id="contentUrlaub" class="tab-content" style="display: none;">
            <div style="margin-bottom: 20px;">
                <h2 style="color: var(--color-text-primary); margin: 0 0 10px 0;">üèñÔ∏è Urlaubs-Anfragen verwalten</h2>
                <p style="color: var(--color-text-secondary); font-size: 14px; margin: 0;">
                    Hier siehst du alle Urlaubs-Anfragen deiner Mitarbeiter. Genehmige oder lehne Anfragen ab.
                </p>
            </div>

            <!-- Pending Requests (Highlighted) -->
            <div id="pendingRequestsSection" style="margin-bottom: 30px;">
                <h3 style="color: var(--color-text-primary); margin: 0 0 15px 0; font-size: 18px;">
                    ‚è≥ Ausstehende Anfragen
                </h3>
                <div id="pendingRequestsList" style="display: grid; gap: 15px;">
                    <!-- Dynamically filled -->
                    <div style="padding: 20px; background: rgba(255,255,255,0.05); border-radius: 10px; text-align: center; color: var(--color-text-secondary);">
                        L√§dt Anfragen...
                    </div>
                </div>
            </div>

            <!-- Approved/Rejected Requests -->
            <div id="processedRequestsSection">
                <h3 style="color: var(--color-text-secondary); margin: 0 0 15px 0; font-size: 16px;">
                    ‚úÖ Bearbeitete Anfragen
                </h3>
                <div id="processedRequestsList" style="display: grid; gap: 15px;">
                    <!-- Dynamically filled -->
                </div>
            </div>
        </div>

        <!-- EDIT MODAL -->
        <div id="editModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10001; overflow-y: auto; padding: 20px;">
            <div id="modalContent" style="max-width: 700px; margin: 50px auto; background: #ffffff; border-radius: 12px; padding: 30px; box-shadow: 0 8px 32px rgba(0,0,0,0.4);">
                <!-- Modal Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: var(--color-text-primary); margin: 0;">‚úèÔ∏è Mitarbeiter bearbeiten</h2>
                    <button onclick="closeEditModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--color-text-secondary);">‚úï</button>
                </div>

                <!-- Form -->
                <form id="editForm" onsubmit="saveMitarbeiter(event); return false;">
                    <!-- Hidden ID -->
                    <input type="hidden" id="editId">

                    <!-- Name -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; color: var(--color-text-primary);">üë§ Name</label>
                        <input type="text" id="editName" required style="width: 100%; padding: 10px; border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: var(--color-text-primary); font-size: 14px;">
                    </div>

                    <!-- Status -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; color: var(--color-text-primary);">‚úÖ Status</label>
                        <select id="editStatus" required style="width: 100%; padding: 10px; border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: var(--color-text-primary); font-size: 14px;">
                            <option value="active">Aktiv</option>
                            <option value="inactive">Inaktiv</option>
                        </select>
                    </div>

                    <!-- Rolle -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; color: var(--color-text-primary);">üëî Rolle</label>
                        <select id="editRolle" required style="width: 100%; padding: 10px; border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: var(--color-text-primary); font-size: 14px;">
                            <option value="Lackierer">Lackierer</option>
                            <option value="Meister">Meister</option>
                            <option value="Lehrling">Lehrling</option>
                            <option value="Azubi">Azubi</option>
                            <option value="Karosseriebauer">Karosseriebauer</option>
                            <option value="Mechaniker">Mechaniker</option>
                            <option value="Servicetechniker">Servicetechniker</option>
                            <option value="B√ºrokraft">B√ºrokraft</option>
                            <option value="Werkstattleiter">Werkstattleiter</option>
                            <option value="Sonstige">Sonstige</option>
                        </select>
                    </div>

                    <!-- Urlaubstage pro Jahr -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; color: var(--color-text-primary);">üèñÔ∏è Urlaubstage pro Jahr</label>
                        <input type="number" id="editUrlaubstageJahr" value="30" min="0" max="50" required style="width: 100%; padding: 10px; border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: var(--color-text-primary); font-size: 14px;">
                    </div>

                    <!-- Readonly Statistics -->
                    <div style="margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
                        <label style="display: block; font-weight: 600; margin-bottom: 10px; color: var(--color-text-primary); font-size: 14px;">üìä Statistiken (automatisch berechnet)</label>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px;">
                            <div style="text-align: center; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px;">
                                <span style="color: var(--color-text-secondary); display: block; margin-bottom: 4px;">Urlaub verbraucht:</span>
                                <strong id="editUrlaubstageVerbraucht" style="color: #4CAF50; font-size: 16px;">0</strong> <span style="color: var(--color-text-secondary);">Tage</span>
                            </div>
                            <div style="text-align: center; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px;">
                                <span style="color: var(--color-text-secondary); display: block; margin-bottom: 4px;">Krankheitstage:</span>
                                <strong id="editKrankheitstage" style="color: #FF9800; font-size: 16px;">0</strong> <span style="color: var(--color-text-secondary);">Tage</span>
                            </div>
                            <div style="text-align: center; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px;">
                                <span style="color: var(--color-text-secondary); display: block; margin-bottom: 4px;">Stunden (Monat):</span>
                                <strong id="editMonatlicheStunden" style="color: #2196F3; font-size: 16px;">0</strong><span style="color: var(--color-text-secondary);">h</span>
                            </div>
                            <div style="text-align: center; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px;">
                                <span style="color: var(--color-text-secondary); display: block; margin-bottom: 4px;">Stunden (Gesamt):</span>
                                <strong id="editGesamtstunden" style="color: #2196F3; font-size: 16px;">0</strong><span style="color: var(--color-text-secondary);">h</span>
                            </div>
                        </div>
                        <div style="margin-top: 8px; padding: 8px; background: rgba(33, 150, 243, 0.1); border-radius: 4px; font-size: 12px; color: var(--color-text-secondary); text-align: center;">
                            ‚ÑπÔ∏è Diese Werte werden automatisch aus dem Dienstplan berechnet
                        </div>
                    </div>

                    <!-- Password -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; color: var(--color-text-primary);">üîë Neues Passwort (optional - leer lassen um beizubehalten)</label>
                        <input type="password" id="editPassword" style="width: 100%; padding: 10px; border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: var(--color-text-primary); font-size: 14px;" placeholder="Leer lassen f√ºr keine √Ñnderung">
                    </div>

                    <!-- Berechtigungen (14 Kacheln) - iOS Toggle Style -->
                    <div style="margin-bottom: 20px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                        <div style="display: block; font-weight: 600; margin-bottom: 15px; color: var(--color-text-primary); font-size: 16px;">üîê Berechtigungen f√ºr Kacheln</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <!-- Fahrzeug-Management -->
                            <div>
                                <input type="checkbox" id="editAnnahme" class="permission-checkbox">
                                <label for="editAnnahme" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üöó Annahme</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="editAbnahme" class="permission-checkbox">
                                <label for="editAbnahme" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">‚úÖ Abnahme</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="editListe" class="permission-checkbox">
                                <label for="editListe" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üìã √úbersicht</span>
                                </label>
                            </div>

                            <!-- Prozess-√úberwachung -->
                            <div>
                                <input type="checkbox" id="editKanban" class="permission-checkbox">
                                <label for="editKanban" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üìä Kanban</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="editKunden" class="permission-checkbox">
                                <label for="editKunden" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üë• Kunden</span>
                                </label>
                            </div>

                            <!-- Organisation & Partner -->
                            <div>
                                <input type="checkbox" id="editKalender" class="permission-checkbox">
                                <label for="editKalender" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üìÖ Kalender</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="editMaterial" class="permission-checkbox">
                                <label for="editMaterial" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üì¶ Material</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="editPartnerAnfragen" class="permission-checkbox">
                                <label for="editPartnerAnfragen" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üìß Partner-Anfragen</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="editPartnerPortal" class="permission-checkbox">
                                <label for="editPartnerPortal" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üîó Partner-Portal</span>
                                </label>
                            </div>

                            <!-- Admin-Funktionen -->
                            <div>
                                <input type="checkbox" id="editMitarbeiterVerwaltung" class="permission-checkbox">
                                <label for="editMitarbeiterVerwaltung" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üë§ Mitarbeiter-Verwaltung</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="editNutzerVerwaltung" class="permission-checkbox">
                                <label for="editNutzerVerwaltung" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üë• User-Verwaltung</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="editRegistrierung" class="permission-checkbox">
                                <label for="editRegistrierung" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üìù Registrierung</span>
                                </label>
                            </div>

                            <!-- KI-Assistent -->
                            <div>
                                <input type="checkbox" id="editKiChat" class="permission-checkbox">
                                <label for="editKiChat" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üí¨ KI-Chat</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="editKiSprache" class="permission-checkbox">
                                <label for="editKiSprache" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üé§ KI-Sprache</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" onclick="deleteMitarbeiter()" class="btn btn-danger">
                            üóëÔ∏è L√∂schen
                        </button>
                        <button type="button" onclick="closeEditModal()" class="btn" style="background: rgba(255,255,255,0.1); color: var(--color-text-primary);">
                            Abbrechen
                        </button>
                        <button type="submit" class="btn btn-primary">
                            üíæ Speichern
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- NEW MITARBEITER MODAL -->
        <div id="newMitarbeiterModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10001; overflow-y: auto; padding: 20px;">
            <div id="newMitarbeiterModalContent" style="max-width: 700px; margin: 50px auto; background: #ffffff; border-radius: 12px; padding: 30px; box-shadow: 0 8px 32px rgba(0,0,0,0.4);">
                <!-- Modal Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: var(--color-text-primary); margin: 0;">‚ûï Neuer Mitarbeiter</h2>
                    <button onclick="closeNewMitarbeiterModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--color-text-secondary);">‚úï</button>
                </div>

                <!-- Form -->
                <form id="newMitarbeiterForm" onsubmit="createNewMitarbeiter(event); return false;">
                    <!-- Name -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; color: var(--color-text-primary);">üë§ Name</label>
                        <input type="text" id="newName" required style="width: 100%; padding: 10px; border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: var(--color-text-primary); font-size: 14px;" placeholder="z.B. Max Mustermann">
                    </div>

                    <!-- Password -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; color: var(--color-text-primary);">üîë Passwort</label>
                        <input type="password" id="newPassword" required style="width: 100%; padding: 10px; border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: var(--color-text-primary); font-size: 14px;" placeholder="Mindestens 4 Zeichen" minlength="4">
                    </div>

                    <!-- Rolle -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; color: var(--color-text-primary);">üëî Rolle</label>
                        <select id="newRolle" required style="width: 100%; padding: 10px; border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: var(--color-text-primary); font-size: 14px; cursor: pointer;">
                            <option value="">Bitte w√§hlen...</option>
                            <option value="Lehrling">Lehrling</option>
                            <option value="Azubi">Azubi</option>
                            <option value="Geselle">Geselle</option>
                            <option value="Meister">Meister</option>
                            <option value="Lackierer">Lackierer</option>
                            <option value="Karosseriebauer">Karosseriebauer</option>
                            <option value="Mechaniker">Mechaniker</option>
                            <option value="Servicetechniker">Servicetechniker</option>
                            <option value="B√ºrokraft">B√ºrokraft</option>
                            <option value="Werkstattleiter">Werkstattleiter</option>
                            <option value="Sonstige">Sonstige</option>
                        </select>
                    </div>

                    <!-- Urlaubstage pro Jahr -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; color: var(--color-text-primary);">üèñÔ∏è Urlaubstage pro Jahr</label>
                        <input type="number" id="newUrlaubstageJahr" value="30" min="0" max="50" required style="width: 100%; padding: 10px; border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: var(--color-text-primary); font-size: 14px;">
                    </div>

                    <!-- Berechtigungen (14 Kacheln) - iOS Toggle Style -->
                    <div style="margin-bottom: 20px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                        <div style="display: block; font-weight: 600; margin-bottom: 15px; color: var(--color-text-primary); font-size: 16px;">üîê Berechtigungen f√ºr Kacheln</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <!-- Same 14 checkboxes as edit modal, but with "new" prefix -->
                            <div>
                                <input type="checkbox" id="newAnnahme" class="permission-checkbox">
                                <label for="newAnnahme" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üöó Annahme</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="newAbnahme" class="permission-checkbox">
                                <label for="newAbnahme" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">‚úÖ Abnahme</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="newListe" class="permission-checkbox">
                                <label for="newListe" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üìã √úbersicht</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="newKanban" class="permission-checkbox">
                                <label for="newKanban" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üìä Kanban</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="newKunden" class="permission-checkbox">
                                <label for="newKunden" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üë• Kunden</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="newKalender" class="permission-checkbox">
                                <label for="newKalender" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üìÖ Kalender</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="newMaterial" class="permission-checkbox">
                                <label for="newMaterial" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üì¶ Material</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="newPartnerAnfragen" class="permission-checkbox">
                                <label for="newPartnerAnfragen" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üìß Partner-Anfragen</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="newPartnerPortal" class="permission-checkbox">
                                <label for="newPartnerPortal" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üîó Partner-Portal</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="newMitarbeiterVerwaltung" class="permission-checkbox">
                                <label for="newMitarbeiterVerwaltung" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üë§ Mitarbeiter-Verwaltung</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="newNutzerVerwaltung" class="permission-checkbox">
                                <label for="newNutzerVerwaltung" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üë• User-Verwaltung</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="newRegistrierung" class="permission-checkbox">
                                <label for="newRegistrierung" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üìù Registrierung</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="newKiChat" class="permission-checkbox">
                                <label for="newKiChat" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üí¨ KI-Chat</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="newKiSprache" class="permission-checkbox">
                                <label for="newKiSprache" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üé§ KI-Sprache</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" onclick="closeNewMitarbeiterModal()" class="btn" style="background: rgba(255,255,255,0.1); color: var(--color-text-primary);">
                            Abbrechen
                        </button>
                        <button type="submit" class="btn btn-success">
                            ‚ûï Erstellen
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- STUNDENABRECHNUNG PDF MODAL -->
    <div id="stundenabrechnungModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10001; overflow-y: auto; padding: 20px;">
        <div style="max-width: 600px; margin: 50px auto; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 30px; box-shadow: 0 8px 32px rgba(0,0,0,0.4);">
            <h2 style="color: white; margin: 0 0 20px 0; font-size: 24px;">üìÑ Stundenabrechnung PDF</h2>

            <input type="hidden" id="pdfMitarbeiterId">

            <div style="margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: rgba(255,255,255,0.8); font-size: 13px;">Mitarbeiter:</label>
                <div id="pdfMitarbeiterName" style="font-size: 20px; color: white; font-weight: 600;"></div>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: white;">üìÖ Von Datum:</label>
                <input type="date" id="pdfStartDatum" required style="width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 14px; background: rgba(255,255,255,0.95);">
            </div>

            <div style="margin-bottom: 25px;">
                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: white;">üìÖ Bis Datum:</label>
                <input type="date" id="pdfEndDatum" required style="width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 14px; background: rgba(255,255,255,0.95);">
            </div>

            <div style="display: flex; gap: 10px;">
                <button onclick="generateStundenabrechnungPDF()" class="btn btn-success" style="flex: 1; padding: 12px; font-size: 15px;">
                    üì• PDF Erstellen
                </button>
                <button onclick="closeStundenabrechnungModal()" class="btn" style="flex: 1; padding: 12px; font-size: 15px; background: rgba(255,255,255,0.2); color: white; border: none;">
                    ‚ùå Abbrechen
                </button>
            </div>
        </div>
    </div>

    <!-- Initialize Feather Icons -->
    <script>
        feather.replace();
    </script>

    <!-- Theme Toggle Logic -->
    <script>
        (function initThemeToggle() {
            const themeToggle = document.getElementById('themeToggle');
            const html = document.documentElement;

            // Initialize theme (default: light)
            let currentTheme = localStorage.getItem('theme') || 'light';
            html.setAttribute('data-theme', currentTheme);
            console.log(`üåì Theme initialized: ${currentTheme}`);

            // Toggle theme on button click
            themeToggle.addEventListener('click', () => {
                currentTheme = currentTheme === 'light' ? 'dark' : 'light';
                html.setAttribute('data-theme', currentTheme);
                localStorage.setItem('theme', currentTheme);

                console.log(`üåì Theme switched to: ${currentTheme}`);

                // Re-initialize Feather Icons for theme change
                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
            });

            console.log('‚úÖ Theme Toggle initialized');
        })();
    </script>

    <!-- üÜï Phase 2.1: Urlaub Ablehnen Modal -->
    <div id="rejectVacationModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 100003; padding: 20px; overflow-y: auto;">
        <div style="max-width: 500px; margin: 100px auto; background: var(--color-surface); border-radius: 16px; padding: 40px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); backdrop-filter: blur(25px);">
            <!-- Header -->
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, #ff3b30, #dc143c); border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 40px;">
                    ‚ùå
                </div>
                <h2 style="color: var(--color-text-primary); margin: 0 0 10px 0; font-size: 24px; font-weight: 700;">Urlaub ablehnen</h2>
                <p id="rejectVacationInfo" style="color: var(--color-text-secondary); margin: 0; font-size: 14px;"></p>
            </div>

            <!-- Form -->
            <div style="display: flex; flex-direction: column; gap: 20px;">
                <!-- Ablehnungsgrund -->
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--color-text-primary);">üìù Ablehnungsgrund</label>
                    <textarea id="ablehnungsgrund" rows="4" required placeholder="Bitte gib einen Grund f√ºr die Ablehnung ein..." style="width: 100%; padding: 12px; border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: var(--color-text-primary); font-size: 14px; resize: vertical;"></textarea>
                </div>

                <!-- Buttons -->
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" onclick="closeRejectVacationModal()" style="padding: 14px 28px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; color: var(--color-text-primary); font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        Abbrechen
                    </button>
                    <button type="button" id="confirmRejectBtn" onclick="confirmRejectVacation()" style="padding: 14px 28px; background: linear-gradient(135deg, #ff3b30, #dc143c); border: none; border-radius: 10px; color: white; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px;">
                        ‚ùå Ablehnen
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MULTI-TENANT MITARBEITER-VERWALTUNG -->
    <script>
        // ============================================
        // PHASE 6: MULTI-TENANT MITARBEITER-VERWALTUNG
        // ============================================

        let mitarbeiterList = [];
        let currentWerkstattId = null;
        let currentWerkstattName = null;

        // Initialize App
        async function initApp() {
            console.log('üöÄ Initialisiere Multi-Tenant Mitarbeiter-Verwaltung...');

            // Wait for Firebase + Auth Manager
            await window.initFirebase();

            if (!window.firebaseInitialized || !window.authManager) {
                console.error('‚ùå Firebase oder Auth Manager nicht initialisiert!');
                showToast('‚ö†Ô∏è Fehler: Firebase konnte nicht initialisiert werden. Bitte Seite neu laden.', 'error', 6000);
                return;
            }

            // Check if user is logged in as werkstatt
            // ‚ö†Ô∏è WICHTIG: Warte auf Auth State Listener (Race Condition Fix)
            let currentUser = null;
            let attempts = 0;
            const maxAttempts = 20; // 20 * 250ms = 5 Sekunden max

            while (!currentUser && attempts < maxAttempts) {
                currentUser = window.authManager.getCurrentUser();
                if (!currentUser) {
                    console.log(`‚è≥ Warte auf Auth State Listener (Versuch ${attempts + 1}/${maxAttempts})...`);
                    await new Promise(resolve => setTimeout(resolve, 250)); // 250ms warten
                    attempts++;
                }
            }

            if (!currentUser) {
                console.error('‚ùå Auth Timeout: Kein User eingeloggt nach 5 Sekunden');
                showToast('‚ö†Ô∏è Bitte zuerst als Werkstatt einloggen!', 'warning', 3000);
                setTimeout(() => safeNavigate('index.html'), 1500);
                return;
            }

            console.log('‚úÖ Auth State erfolgreich geladen nach', attempts * 250, 'ms');

            // üÜï SECURITY FIX 2025-11-07: Partner-Accounts d√ºrfen Mitarbeiter-Verwaltung nicht aufrufen
            // Defense in Depth: 2-Layer Access Control (Page-Level + Firestore Rules)
            if (currentUser.role === 'partner') {
                console.error('‚ùå Partner-Login blockiert! Partner k√∂nnen Mitarbeiter-Verwaltung nicht aufrufen.');
                showToast('‚õî Partner-Accounts k√∂nnen diese Seite nicht aufrufen. Bitte nutzen Sie das Partner-Portal.', 'error', 5000);

                // Redirect to Partner Portal after 2 seconds
                setTimeout(() => {
                    window.location.href = 'partner-app/';
                }, 2000);
                return;
            }

            currentWerkstattId = currentUser.werkstattId;
            currentWerkstattName = currentUser.werkstattName || currentUser.name;

            if (!currentWerkstattId) {
                console.error('‚ùå User hat keine werkstattId!');
                showToast('‚ö†Ô∏è Fehler: Werkstatt-ID fehlt. Bitte neu einloggen.', 'error', 3000);
                setTimeout(() => safeNavigate('index.html'), 1500);
                return;
            }

            console.log('‚úÖ Eingeloggt als Werkstatt:', currentWerkstattName);
            console.log('   WerkstattID:', currentWerkstattId);

            // Update header
            document.getElementById('werkstattName').textContent = `(${currentWerkstattName})`;

            // Load mitarbeiter (werkstatt-specific)
            await loadMitarbeiter();

            console.log('‚úÖ App erfolgreich initialisiert');
        }

        // ============================================
        // PASSWORD HASHING (SHA-256)
        // ============================================

        /**
         * Hash password using SHA-256
         * Matches auth-manager.js implementation
         */
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        // ============================================
        // LOAD MITARBEITER (WERKSTATT-SPECIFIC)
        // ============================================

        async function loadMitarbeiter() {
            console.log('üì• Lade Mitarbeiter f√ºr werkstattId:', currentWerkstattId);

            try {
                // Use window.getCollection() helper from firebase-config.js
                const mitarbeiterCollection = window.getCollection('mitarbeiter');

                console.log('   Collection:', mitarbeiterCollection._delegate._path.segments.join('/'));

                // Setup realtime listener
                mitarbeiterCollection.onSnapshot((snapshot) => {
                    mitarbeiterList = snapshot.docs
                        .filter(doc => doc.id !== '_init') // Skip init doc
                        .map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));

                    console.log(`‚úÖ ${mitarbeiterList.length} Mitarbeiter geladen (Realtime Update)`);

                    // Render table
                    renderMitarbeiterTable();
                }, (error) => {
                    console.error('‚ùå Fehler beim Laden der Mitarbeiter:', error);
                    showToast('‚ùå Fehler beim Laden der Mitarbeiter. Siehe Console f√ºr Details.', 'error', 6000);
                });

            } catch (error) {
                console.error('‚ùå Fehler beim Setup des Listeners:', error);
                showToast('‚ùå Fehler beim Setup. Siehe Console f√ºr Details.', 'error', 6000);
            }
        }

        // ============================================
        // RENDER MITARBEITER TABLE
        // ============================================

        function renderMitarbeiterTable() {
            const tbody = document.getElementById('mitarbeiterTableBody');

            if (mitarbeiterList.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <i data-feather="users"></i>
                                <h3>Noch keine Mitarbeiter vorhanden</h3>
                                <p>Klicken Sie auf "Neuer Mitarbeiter" oder "Test-Daten (3)" um Mitarbeiter hinzuzuf√ºgen.</p>
                            </div>
                        </td>
                    </tr>
                `;
                feather.replace();
                return;
            }

            tbody.innerHTML = mitarbeiterList.map(user => {
                // Berechtigungen count (aus 14 m√∂glichen)
                const berechtigungenCount = user.berechtigungen
                    ? Object.values(user.berechtigungen).filter(v => v === true).length
                    : 0;

                // Berechtigung badge mit Farbe basierend auf Anzahl
                let badgeClass = 'badge-info';
                if (berechtigungenCount >= 10) {
                    badgeClass = 'badge-success'; // Gr√ºn f√ºr viele Berechtigungen
                } else if (berechtigungenCount >= 5) {
                    badgeClass = 'badge-warning'; // Gelb f√ºr mittlere Berechtigungen
                } else {
                    badgeClass = 'badge-danger'; // Rot f√ºr wenige Berechtigungen
                }

                // Status badge
                const statusBadge = user.status === 'active'
                    ? '<span class="badge badge-success">Aktiv</span>'
                    : '<span class="badge badge-danger">Inaktiv</span>';

                // Rolle badge mit Farbe basierend auf Rolle
                const rolle = user.rolle || 'Sonstige';
                let rolleBadgeClass = 'badge-info';
                if (rolle === 'Meister' || rolle === 'Werkstattleiter') {
                    rolleBadgeClass = 'badge-warning'; // Gold/Gelb f√ºr F√ºhrungskr√§fte
                } else if (rolle === 'Lehrling' || rolle === 'Azubi') {
                    rolleBadgeClass = 'badge-primary'; // Blau f√ºr Auszubildende
                }
                const rolleBadge = `<span class="badge ${rolleBadgeClass}">${rolle}</span>`;

                // üÜï Phase 2.1: Urlaubstage anzeigen
                const urlaubstageJahr = user.urlaubstageJahr || 30;
                const urlaubstageVerbraucht = user.urlaubstageVerbraucht || 0;
                const urlaubstageVerfuegbar = urlaubstageJahr - urlaubstageVerbraucht;

                const urlaubBadgeColor = urlaubstageVerfuegbar < 5 ? 'badge-danger' :
                                        urlaubstageVerfuegbar < 15 ? 'badge-warning' :
                                        'badge-success';

                const urlaubBadge = `<span class="badge ${urlaubBadgeColor}">${urlaubstageVerfuegbar}/${urlaubstageJahr}</span>`;

                // üÜï Krankheitstage
                const krankheitstage = user.krankheitstage || 0;
                const krankBadgeColor = krankheitstage > 10 ? 'badge-danger' :
                                        krankheitstage > 5 ? 'badge-warning' :
                                        'badge-success';
                const krankBadge = `<span class="badge ${krankBadgeColor}">${krankheitstage} Tage</span>`;

                // üÜï Gesamtstunden (Lifetime) und monatliche Stunden mit √úberstunden-Warnung
                const gesamtstunden = user.gesamtstunden || 0;
                const monatlicheStunden = user.monatlicheStunden || 0;

                // √úberstunden-Warnung: Gelb ab 160h/Monat, Rot ab 180h/Monat
                let monatlicheBadgeColor = 'badge-info'; // Blau = Normal
                if (monatlicheStunden >= 180) {
                    monatlicheBadgeColor = 'badge-danger'; // Rot = Kritische √úberstunden
                } else if (monatlicheStunden >= 160) {
                    monatlicheBadgeColor = 'badge-warning'; // Gelb/Orange = √úberstunden
                } else if (monatlicheStunden >= 120) {
                    monatlicheBadgeColor = 'badge-success'; // Gr√ºn = Gute Arbeitszeit
                }

                const stundenBadge = `<span class="badge badge-info">${gesamtstunden.toFixed(1)}h</span>`;
                const monatlicheBadge = `<span class="badge ${monatlicheBadgeColor}">${monatlicheStunden.toFixed(1)}h/Monat</span>`;

                return `
                    <tr>
                        <td><strong>${user.name}</strong></td>
                        <td>${rolleBadge}</td>
                        <td>${urlaubBadge}</td>
                        <td>${krankBadge}</td>
                        <td>
                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                ${monatlicheBadge}
                                <small style="opacity: 0.7;">${stundenBadge} gesamt</small>
                            </div>
                        </td>
                        <td>${user.passwordHash ? '<span style="color: #34c759;">‚úÖ Gesetzt</span>' : '<span style="color: #ff4444;">‚ùå Fehlt</span>'}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <span class="badge ${badgeClass}">${berechtigungenCount}/14 Kacheln</span>
                        </td>
                        <td>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <button class="btn btn-primary" style="padding: 8px 16px; font-size: 12px;" onclick="openEditModal('${user.id}')">
                                    ‚úèÔ∏è Bearbeiten
                                </button>
                                <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 12px;" onclick="openStundenabrechnungModal('${user.id}')" title="Stundenabrechnung PDF erstellen">
                                    üìÑ PDF
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            feather.replace();
            console.log('‚úÖ Tabelle gerendert mit', mitarbeiterList.length, 'Mitarbeitern');
        }

        // ============================================
        // MODAL FUNCTIONS
        // ============================================

        function openEditModal(userId) {
            const user = mitarbeiterList.find(u => String(u.id) === String(userId));
            if (!user) {
                console.error('‚ùå Mitarbeiter nicht gefunden:', userId);
                return;
            }

            console.log('üìù √ñffne Edit-Modal f√ºr:', user.name);

            // Populate form fields
            document.getElementById('editId').value = user.id;
            document.getElementById('editName').value = user.name;
            document.getElementById('editStatus').value = user.status || 'active';
            document.getElementById('editPassword').value = ''; // Never show password

            // Populate new fields
            document.getElementById('editRolle').value = user.rolle || 'Lackierer';
            document.getElementById('editUrlaubstageJahr').value = user.urlaubstageJahr || 30;

            // Populate readonly statistics
            document.getElementById('editUrlaubstageVerbraucht').textContent = user.urlaubstageVerbraucht || 0;
            document.getElementById('editKrankheitstage').textContent = user.krankheitstage || 0;
            document.getElementById('editMonatlicheStunden').textContent = (user.monatlicheStunden || 0).toFixed(2);
            document.getElementById('editGesamtstunden').textContent = (user.gesamtstunden || 0).toFixed(2);

            // Populate all checkboxes (14 berechtigungen)
            document.getElementById('editAnnahme').checked = user.berechtigungen?.annahme || false;
            document.getElementById('editAbnahme').checked = user.berechtigungen?.abnahme || false;
            document.getElementById('editListe').checked = user.berechtigungen?.liste || false;
            document.getElementById('editKanban').checked = user.berechtigungen?.kanban || false;
            document.getElementById('editKunden').checked = user.berechtigungen?.kunden || false;
            document.getElementById('editKalender').checked = user.berechtigungen?.kalender || false;
            document.getElementById('editMaterial').checked = user.berechtigungen?.material || false;
            document.getElementById('editPartnerAnfragen').checked = user.berechtigungen?.partnerAnfragen || false;
            document.getElementById('editPartnerPortal').checked = user.berechtigungen?.partnerPortal || false;
            document.getElementById('editMitarbeiterVerwaltung').checked = user.berechtigungen?.mitarbeiterVerwaltung || false;
            document.getElementById('editNutzerVerwaltung').checked = user.berechtigungen?.nutzerVerwaltung || false;
            document.getElementById('editRegistrierung').checked = user.berechtigungen?.registrierung || false;
            document.getElementById('editKiChat').checked = user.berechtigungen?.kiChat || false;
            document.getElementById('editKiSprache').checked = user.berechtigungen?.kiSprache || false;

            // Show modal
            document.getElementById('editModal').style.display = 'block';
        }

        function closeEditModal() {
            console.log('‚ùå Schlie√üe Edit-Modal');
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('editForm').reset();
        }

        async function saveMitarbeiter(event) {
            event.preventDefault();

            const userId = document.getElementById('editId').value;
            console.log('üíæ Speichere √Ñnderungen f√ºr:', userId);

            // Check if new password was entered
            const newPassword = document.getElementById('editPassword').value;
            let passwordHash = null;
            if (newPassword && newPassword.trim() !== '') {
                passwordHash = await hashPassword(newPassword);
                console.log('üîí Neues Passwort gehasht (SHA-256)');
            }

            const updates = {
                name: document.getElementById('editName').value,
                status: document.getElementById('editStatus').value,
                rolle: document.getElementById('editRolle').value,
                urlaubstageJahr: parseInt(document.getElementById('editUrlaubstageJahr').value, 10),
                berechtigungen: {
                    annahme: document.getElementById('editAnnahme').checked,
                    abnahme: document.getElementById('editAbnahme').checked,
                    liste: document.getElementById('editListe').checked,
                    kanban: document.getElementById('editKanban').checked,
                    kunden: document.getElementById('editKunden').checked,
                    kalender: document.getElementById('editKalender').checked,
                    material: document.getElementById('editMaterial').checked,
                    partnerAnfragen: document.getElementById('editPartnerAnfragen').checked,
                    partnerPortal: document.getElementById('editPartnerPortal').checked,
                    mitarbeiterVerwaltung: document.getElementById('editMitarbeiterVerwaltung').checked,
                    nutzerVerwaltung: document.getElementById('editNutzerVerwaltung').checked,
                    registrierung: document.getElementById('editRegistrierung').checked,
                    kiChat: document.getElementById('editKiChat').checked,
                    kiSprache: document.getElementById('editKiSprache').checked
                },
                lastModified: new Date().toISOString()
            };

            // Add password hash if new password was entered
            if (passwordHash) {
                updates.passwordHash = passwordHash;
            }

            try {
                const mitarbeiterCollection = window.getCollection('mitarbeiter');
                await mitarbeiterCollection.doc(userId).update(updates);
                console.log('‚úÖ Mitarbeiter erfolgreich aktualisiert:', userId);

                // Close modal (realtime listener will update table)
                closeEditModal();

                showToast('‚úÖ √Ñnderungen erfolgreich gespeichert!', 'success', 4000);
            } catch (error) {
                console.error('‚ùå Fehler beim Speichern:', error);
                showToast('‚ùå Fehler beim Speichern. Siehe Console f√ºr Details.', 'error', 5000);
            }
        }

        async function deleteMitarbeiter() {
            const userId = document.getElementById('editId').value;
            const userName = document.getElementById('editName').value;

            console.log('üîç Pr√ºfe Schichten f√ºr Mitarbeiter:', userId);

            try {
                // 1. Z√§hle Schichten des Mitarbeiters
                const schichtenCollection = window.getCollection('schichten');
                const schichtenSnapshot = await schichtenCollection
                    .where('mitarbeiterId', '==', userId)
                    .get();

                const schichtenCount = schichtenSnapshot.size;

                // 2. Erweiterte Best√§tigung mit Schicht-Warnung
                let confirmMessage = `‚ö†Ô∏è Mitarbeiter "${userName}" wirklich l√∂schen?\n\n`;

                if (schichtenCount > 0) {
                    confirmMessage += `üóìÔ∏è ACHTUNG: ${schichtenCount} Schicht(en) werden ebenfalls gel√∂scht!\n\n`;
                }

                confirmMessage += `Dieser Vorgang kann nicht r√ºckg√§ngig gemacht werden!`;

                if (!confirm(confirmMessage)) {
                    return;
                }

                console.log(`üóëÔ∏è L√∂sche Mitarbeiter: ${userId} (${schichtenCount} Schichten)`);

                // 3. CASCADE DELETE: Alle Schichten des Mitarbeiters l√∂schen
                const batch = db.batch();

                // Batch-Splitting f√ºr viele Schichten (max 500 ops pro Batch)
                const batchSize = 500;
                const schichtenDocs = schichtenSnapshot.docs;

                for (let i = 0; i < schichtenDocs.length; i += batchSize) {
                    const currentBatch = i === 0 ? batch : db.batch();
                    const chunk = schichtenDocs.slice(i, Math.min(i + batchSize, schichtenDocs.length));

                    chunk.forEach(doc => {
                        currentBatch.delete(doc.ref);
                    });

                    // Mitarbeiter nur im letzten Batch l√∂schen
                    if (i + batchSize >= schichtenDocs.length) {
                        const mitarbeiterCollection = window.getCollection('mitarbeiter');
                        currentBatch.delete(mitarbeiterCollection.doc(userId));
                    }

                    await currentBatch.commit();
                }

                // Falls keine Schichten: Mitarbeiter direkt l√∂schen
                if (schichtenCount === 0) {
                    const mitarbeiterCollection = window.getCollection('mitarbeiter');
                    await mitarbeiterCollection.doc(userId).delete();
                }

                console.log(`‚úÖ Mitarbeiter + ${schichtenCount} Schichten erfolgreich gel√∂scht`);

                // Close modal (realtime listener will update table)
                closeEditModal();

                const successMsg = schichtenCount > 0
                    ? `‚úÖ Mitarbeiter "${userName}" und ${schichtenCount} Schicht(en) erfolgreich gel√∂scht!`
                    : `‚úÖ Mitarbeiter "${userName}" erfolgreich gel√∂scht!`;

                showToast(successMsg, 'success', 4000);

            } catch (error) {
                console.error('‚ùå Fehler beim L√∂schen:', error);
                showToast('‚ùå Fehler beim L√∂schen: ' + error.message, 'error', 5000);
            }
        }

        // ============================================
        // NEW MITARBEITER MODAL
        // ============================================

        function openNewMitarbeiterModal() {
            console.log('‚ûï √ñffne Neuer-Mitarbeiter Modal');
            document.getElementById('newMitarbeiterModal').style.display = 'block';
        }

        function closeNewMitarbeiterModal() {
            console.log('‚ùå Schlie√üe Neuer-Mitarbeiter Modal');
            document.getElementById('newMitarbeiterModal').style.display = 'none';
            document.getElementById('newMitarbeiterForm').reset();
        }

        async function createNewMitarbeiter(event) {
            event.preventDefault();

            console.log('üíæ Erstelle neuen Mitarbeiter...');

            // Generate unique ID
            const userId = `user_${Date.now()}`;

            // Hash password
            const password = document.getElementById('newPassword').value;
            const passwordHash = await hashPassword(password);
            console.log('üîí Passwort gehasht (SHA-256)');

            const newUser = {
                name: document.getElementById('newName').value,
                passwordHash: passwordHash,
                status: 'active', // New users are active by default
                rolle: document.getElementById('newRolle').value, // üÜï Phase 1.1
                urlaubstageJahr: parseInt(document.getElementById('newUrlaubstageJahr').value) || 30, // üÜï Phase 1.1
                berechtigungen: {
                    annahme: document.getElementById('newAnnahme').checked,
                    abnahme: document.getElementById('newAbnahme').checked,
                    liste: document.getElementById('newListe').checked,
                    kanban: document.getElementById('newKanban').checked,
                    kunden: document.getElementById('newKunden').checked,
                    kalender: document.getElementById('newKalender').checked,
                    material: document.getElementById('newMaterial').checked,
                    partnerAnfragen: document.getElementById('newPartnerAnfragen').checked,
                    partnerPortal: document.getElementById('newPartnerPortal').checked,
                    mitarbeiterVerwaltung: document.getElementById('newMitarbeiterVerwaltung').checked,
                    nutzerVerwaltung: document.getElementById('newNutzerVerwaltung').checked,
                    registrierung: document.getElementById('newRegistrierung').checked,
                    kiChat: document.getElementById('newKiChat').checked,
                    kiSprache: document.getElementById('newKiSprache').checked
                },
                werkstattId: currentWerkstattId, // Add werkstattId for reference
                createdAt: new Date().toISOString(),
                createdBy: currentWerkstattName,
                lastLogin: null
            };

            try {
                const mitarbeiterCollection = window.getCollection('mitarbeiter');
                await mitarbeiterCollection.doc(userId).set(newUser);
                console.log('‚úÖ Neuer Mitarbeiter erfolgreich erstellt:', newUser.name);

                // Close modal (realtime listener will update table)
                closeNewMitarbeiterModal();

                showToast(`‚úÖ Mitarbeiter "${newUser.name}" erfolgreich erstellt!`, 'success', 4000);
            } catch (error) {
                console.error('‚ùå Fehler beim Erstellen:', error);
                showToast('‚ùå Fehler beim Erstellen. Siehe Console f√ºr Details.', 'error', 5000);
            }
        }

        // ============================================
        // STUNDENABRECHNUNG PDF EXPORT
        // ============================================

        function openStundenabrechnungModal(mitarbeiterId) {
            const mitarbeiter = mitarbeiterList.find(m => String(m.id) === String(mitarbeiterId));
            if (!mitarbeiter) {
                console.error('‚ùå Mitarbeiter nicht gefunden:', mitarbeiterId);
                return;
            }

            console.log('üìÑ √ñffne Stundenabrechnung-Modal f√ºr:', mitarbeiter.name);

            document.getElementById('pdfMitarbeiterId').value = mitarbeiterId;
            document.getElementById('pdfMitarbeiterName').textContent = mitarbeiter.name;

            // Set default date range (current month)
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);

            document.getElementById('pdfStartDatum').value = formatDate(startOfMonth, 'YYYY-MM-DD');
            document.getElementById('pdfEndDatum').value = formatDate(endOfMonth, 'YYYY-MM-DD');

            document.getElementById('stundenabrechnungModal').style.display = 'block';
        }

        function closeStundenabrechnungModal() {
            console.log('‚ùå Schlie√üe Stundenabrechnung-Modal');
            document.getElementById('stundenabrechnungModal').style.display = 'none';
        }

        async function generateStundenabrechnungPDF() {
            const mitarbeiterId = document.getElementById('pdfMitarbeiterId').value;
            const startDatum = document.getElementById('pdfStartDatum').value;
            const endDatum = document.getElementById('pdfEndDatum').value;

            if (!startDatum || !endDatum) {
                showToast('‚ö†Ô∏è Bitte Datumbereich ausw√§hlen', 'error', 3000);
                return;
            }

            if (new Date(startDatum) > new Date(endDatum)) {
                showToast('‚ö†Ô∏è Startdatum muss vor Enddatum liegen', 'error', 3000);
                return;
            }

            console.log('üìÑ Generiere Stundenabrechnung-PDF f√ºr:', mitarbeiterId, startDatum, 'bis', endDatum);

            try {
                // Load schichten for this mitarbeiter in date range
                const schichtenSnapshot = await window.getCollection('schichten')
                    .where('mitarbeiterId', '==', mitarbeiterId)
                    .where('datum', '>=', startDatum)
                    .where('datum', '<=', endDatum)
                    .get();

                const schichten = schichtenSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                console.log(`üìä ${schichten.length} Schichten gefunden`);

                // Load schichtTypen to get times
                const schichtTypenSnapshot = await window.getCollection('schichtTypen').get();
                const schichtTypen = schichtTypenSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Get mitarbeiter
                const mitarbeiter = mitarbeiterList.find(m => String(m.id) === String(mitarbeiterId));
                if (!mitarbeiter) {
                    showToast('‚ùå Mitarbeiter nicht gefunden', 'error', 3000);
                    return;
                }

                // Calculate totals
                let totalHours = 0;
                let urlaubTage = 0;
                let krankTage = 0;

                const regularShifts = [];

                for (const schicht of schichten) {
                    const schichtTyp = schichtTypen.find(st => String(st.id) === String(schicht.schichtTypId));
                    if (!schichtTyp) {
                        console.warn('‚ö†Ô∏è Schicht-Typ nicht gefunden f√ºr:', schicht.schichtTypId);
                        continue;
                    }

                    if (schichtTyp.isSpecial) {
                        if (schichtTyp.type === 'urlaub') urlaubTage++;
                        else if (schichtTyp.type === 'krank') krankTage++;
                    } else {
                        // Calculate hours for regular shift using same logic as dienstplan.html
                        const hours = calculateShiftHours(schichtTyp.startzeit, schichtTyp.endzeit);
                        totalHours += hours;
                        regularShifts.push({
                            datum: schicht.datum,
                            schichtTypName: schichtTyp.name,
                            startzeit: schichtTyp.startzeit,
                            endzeit: schichtTyp.endzeit,
                            hours: hours
                        });
                    }
                }

                // Sort by date
                regularShifts.sort((a, b) => a.datum.localeCompare(b.datum));

                console.log(`‚úÖ Auswertung: ${totalHours.toFixed(2)}h Arbeit, ${urlaubTage} Urlaubstage, ${krankTage} Krankheitstage`);

                // Generate PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Header
                doc.setFontSize(20);
                doc.text('Stundenabrechnung', 105, 20, { align: 'center' });

                doc.setFontSize(12);
                doc.text(`Mitarbeiter: ${mitarbeiter.name}`, 20, 35);
                doc.text(`Rolle: ${mitarbeiter.rolle || 'N/A'}`, 20, 42);
                doc.text(`Zeitraum: ${formatDate(new Date(startDatum), 'DD.MM.YYYY')} - ${formatDate(new Date(endDatum), 'DD.MM.YYYY')}`, 20, 49);

                // Summary
                doc.setFontSize(14);
                doc.text('Zusammenfassung', 20, 60);
                doc.setFontSize(11);
                doc.text(`Gesamtstunden (Arbeit): ${totalHours.toFixed(2)}h`, 20, 68);
                doc.text(`Urlaubstage: ${urlaubTage}`, 20, 75);
                doc.text(`Krankheitstage: ${krankTage}`, 20, 82);

                // Table header
                let y = 95;
                doc.setFontSize(14);
                doc.text('Arbeitstage', 20, y);
                y += 10;

                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('Datum', 20, y);
                doc.text('Schicht', 60, y);
                doc.text('Von', 120, y);
                doc.text('Bis', 145, y);
                doc.text('Stunden', 170, y);
                y += 7;

                doc.setFont(undefined, 'normal');

                // Table rows
                for (const shift of regularShifts) {
                    if (y > 270) {
                        doc.addPage();
                        y = 20;
                    }

                    doc.text(formatDate(new Date(shift.datum), 'DD.MM.YYYY'), 20, y);
                    doc.text(shift.schichtTypName, 60, y);
                    doc.text(shift.startzeit, 120, y);
                    doc.text(shift.endzeit, 145, y);
                    doc.text(shift.hours.toFixed(2) + 'h', 170, y);
                    y += 7;
                }

                // If no shifts, show message
                if (regularShifts.length === 0) {
                    doc.setFontSize(11);
                    doc.text('Keine Arbeitstage im ausgew√§hlten Zeitraum.', 20, y);
                }

                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.text(`Seite ${i} von ${pageCount}`, 105, 290, { align: 'center' });
                    doc.text(`Erstellt am: ${formatDate(new Date(), 'DD.MM.YYYY')} um ${new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })}`, 20, 290);
                }

                // Save
                const filename = `Stundenabrechnung_${mitarbeiter.name.replace(/\s+/g, '_')}_${startDatum}_${endDatum}.pdf`;
                doc.save(filename);

                showToast('‚úÖ PDF erfolgreich erstellt!', 'success', 4000);
                closeStundenabrechnungModal();

            } catch (error) {
                console.error('‚ùå Fehler beim Erstellen der PDF:', error);
                showToast('‚ùå Fehler beim Erstellen der PDF: ' + error.message, 'error', 5000);
            }
        }

        // Helper function to calculate shift hours (same logic as dienstplan.html)
        function calculateShiftHours(startzeit, endzeit) {
            if (!startzeit || !endzeit) return 0;

            // Parse "08:00" format
            const [startHour, startMin] = startzeit.split(':').map(Number);
            const [endHour, endMin] = endzeit.split(':').map(Number);

            // Calculate total minutes worked
            let totalMinutes = (endHour * 60 + endMin) - (startHour * 60 + startMin);

            // Handle overnight shifts (e.g., 22:00 to 06:00)
            if (totalMinutes < 0) {
                totalMinutes += 24 * 60;
            }

            let totalHours = totalMinutes / 60;

            // Subtract legal break time according to German labor law (Arbeitszeitgesetz)
            if (totalHours >= 9) {
                totalHours -= 0.75;  // 45 min break for 9+ hours
            } else if (totalHours >= 6) {
                totalHours -= 0.5;   // 30 min break for 6-9 hours
            }

            return Math.round(totalHours * 100) / 100;  // Round to 2 decimals
        }

        // Helper function for date formatting (used in PDF generation)
        function formatDate(date, format) {
            const d = new Date(date);
            const months = ['Januar', 'Februar', 'M√§rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
            const weekdays = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];

            const replacements = {
                'YYYY': d.getFullYear(),
                'MM': String(d.getMonth() + 1).padStart(2, '0'),
                'DD': String(d.getDate()).padStart(2, '0'),
                'HH': String(d.getHours()).padStart(2, '0'),
                'mm': String(d.getMinutes()).padStart(2, '0'),
                'MMMM': months[d.getMonth()],
                'dddd': weekdays[d.getDay()]
            };

            let result = format;
            for (const [key, value] of Object.entries(replacements)) {
                result = result.replace(key, value);
            }

            return result;
        }

        // ============================================
        // TEST DATA CREATION
        // ============================================

        async function createTestData() {
            if (!confirm('üß™ 3 Test-Mitarbeiter erstellen?\n\n- Max M√ºller (Vollzugriff)\n- Anna Schmidt (Teilzugriff)\n- Tom Weber (Basiszugriff)')) {
                return;
            }

            console.log('üß™ Erstelle Test-Mitarbeiter...');

            const testUsers = [
                {
                    id: `user_max_${Date.now()}`,
                    name: 'Max M√ºller (Vollzugriff)',
                    passwordHash: await hashPassword('1234'), // Test password: 1234
                    status: 'active',
                    berechtigungen: {
                        annahme: true,
                        abnahme: true,
                        liste: true,
                        kanban: true,
                        kunden: true,
                        kalender: true,
                        material: true,
                        partnerAnfragen: true,
                        partnerPortal: true,
                        mitarbeiterVerwaltung: true,
                        nutzerVerwaltung: true,
                        registrierung: true,
                        kiChat: true,
                        kiSprache: true
                    },
                    werkstattId: currentWerkstattId,
                    createdAt: new Date().toISOString(),
                    createdBy: 'Test-Daten Generator',
                    lastLogin: null
                },
                {
                    id: `user_anna_${Date.now()}`,
                    name: 'Anna Schmidt (Teilzugriff)',
                    passwordHash: await hashPassword('1234'),
                    status: 'active',
                    berechtigungen: {
                        annahme: true,
                        abnahme: true,
                        liste: true,
                        kanban: true,
                        kunden: false,
                        kalender: true,
                        material: true,
                        partnerAnfragen: false,
                        partnerPortal: false,
                        mitarbeiterVerwaltung: false,
                        nutzerVerwaltung: false,
                        registrierung: false,
                        kiChat: true,
                        kiSprache: false
                    },
                    werkstattId: currentWerkstattId,
                    createdAt: new Date().toISOString(),
                    createdBy: 'Test-Daten Generator',
                    lastLogin: null
                },
                {
                    id: `user_tom_${Date.now()}`,
                    name: 'Tom Weber (Basiszugriff)',
                    passwordHash: await hashPassword('1234'),
                    status: 'inactive', // Inactive for testing
                    berechtigungen: {
                        annahme: true,
                        abnahme: false,
                        liste: true,
                        kanban: true,
                        kunden: false,
                        kalender: false,
                        material: false,
                        partnerAnfragen: false,
                        partnerPortal: false,
                        mitarbeiterVerwaltung: false,
                        nutzerVerwaltung: false,
                        registrierung: false,
                        kiChat: false,
                        kiSprache: false
                    },
                    werkstattId: currentWerkstattId,
                    createdAt: new Date().toISOString(),
                    createdBy: 'Test-Daten Generator',
                    lastLogin: null
                }
            ];

            try {
                const mitarbeiterCollection = window.getCollection('mitarbeiter');

                for (const user of testUsers) {
                    await mitarbeiterCollection.doc(user.id).set(user);
                    console.log(`‚úÖ Test-Mitarbeiter erstellt: ${user.name}`);
                }

                showToast('‚úÖ 3 Test-Mitarbeiter erfolgreich erstellt! Passwort: 1234. Check Console f√ºr Details.', 'success', 6000);
                console.log('üìã Test-Mitarbeiter:\n‚Ä¢ Max M√ºller (Vollzugriff, Aktiv)\n‚Ä¢ Anna Schmidt (Teilzugriff, Aktiv)\n‚Ä¢ Tom Weber (Basiszugriff, Inaktiv)');
            } catch (error) {
                console.error('‚ùå Fehler beim Erstellen der Test-Daten:', error);
                showToast('‚ùå Fehler beim Erstellen. Siehe Console f√ºr Details.', 'error', 5000);
            }
        }

        // ============================================
        // INITIALIZE APP ON PAGE LOAD
        // ============================================

        window.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ DOMContentLoaded - starte App...');
            await initApp();
        });

        console.log('‚úÖ PHASE 6: Multi-Tenant Mitarbeiter-Verwaltung geladen');
    </script>

    <!-- KI-Chat-Assistent -->
    <div id="aiChatWidget"></div>
    <script src="js/ai-agent-tools.js"></script>
    <script src="js/ai-agent-engine.js"></script>
    <script src="js/ai-chat-widget.js"></script>

    <!-- ============================================
         SERVICE WORKER REGISTRATION - Offline-Funktionalit√§t
         ============================================ -->
    <script>
        // Service Worker nur registrieren wenn:
        // 1. Browser unterst√ºtzt Service Worker
        // 2. NICHT in Playwright Tests (navigator.webdriver)
        // 3. NICHT auf Emulator-Port (8000)
        if ('serviceWorker' in navigator && !navigator.webdriver && window.location.port !== '8000') {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('./sw.js', {
                        scope: './'
                    });

                    console.log('‚úÖ [SW] Service Worker registriert:', registration.scope);

                    // Update-Handling: Neuen SW aktivieren wenn gefunden
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('üîÑ [SW] Update gefunden, installiere...');

                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                console.log('‚úÖ [SW] Update bereit! Seite neu laden f√ºr neue Version.');

                                // Optional: Auto-reload nach 3 Sekunden
                                // setTimeout(() => window.location.reload(), 3000);
                            }
                        });
                    });

                } catch (error) {
                    console.error('‚ùå [SW] Registrierung fehlgeschlagen:', error);
                }
            });
        } else {
            console.log('‚ÑπÔ∏è [SW] Service Worker nicht registriert (Test-Modus oder nicht unterst√ºtzt)');
        }

        // ============================================
        // PHASE 2.1: URLAUBS-ANFRAGEN VERWALTUNG
        // ============================================

        let allUrlaubsAnfragen = [];
        let currentRejectAnfrageId = null;

        /**
         * Tab switching
         */
        function switchTab(tabName) {
            // Update tab buttons
            document.getElementById('tabMitarbeiter').classList.toggle('active', tabName === 'mitarbeiter');
            document.getElementById('tabUrlaub').classList.toggle('active', tabName === 'urlaub');

            // Update tab content
            document.getElementById('contentMitarbeiter').style.display = tabName === 'mitarbeiter' ? 'block' : 'none';
            document.getElementById('contentUrlaub').style.display = tabName === 'urlaub' ? 'block' : 'none';

            // Load vacation requests if switching to urlaub tab
            if (tabName === 'urlaub') {
                loadUrlaubsAnfragen();
            }

            console.log(`üìë Tab gewechselt: ${tabName}`);
        }

        /**
         * Load all vacation requests
         */
        async function loadUrlaubsAnfragen() {
            try {
                console.log('üèñÔ∏è Lade Urlaubs-Anfragen...');

                // Query all requests for current werkstatt
                const snapshot = await window.getCollection('urlaubsAnfragen')
                    .orderBy('createdAt', 'desc')
                    .get();

                allUrlaubsAnfragen = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                console.log(`‚úÖ ${allUrlaubsAnfragen.length} Anfragen geladen`);

                // Render lists
                renderUrlaubsAnfragen();

            } catch (error) {
                console.error('‚ùå Fehler beim Laden der Urlaubs-Anfragen:', error);
                showToast('‚ùå Fehler beim Laden der Anfragen', 'error', 3000);
            }
        }

        /**
         * Render vacation requests (pending + processed)
         */
        function renderUrlaubsAnfragen() {
            const pending = allUrlaubsAnfragen.filter(a => a.status === 'pending');
            const processed = allUrlaubsAnfragen.filter(a => a.status !== 'pending');

            // Update pending count badge
            document.getElementById('pendingCount').textContent = pending.length;

            // Render pending requests
            const pendingList = document.getElementById('pendingRequestsList');
            if (pending.length === 0) {
                pendingList.innerHTML = `
                    <div style="padding: 30px; background: rgba(255,255,255,0.05); border-radius: 10px; text-align: center; color: var(--color-text-secondary);">
                        ‚úÖ Keine ausstehenden Anfragen
                    </div>
                `;
            } else {
                pendingList.innerHTML = pending.map(anfrage => createAnfrageCard(anfrage, true)).join('');
            }

            // Render processed requests
            const processedList = document.getElementById('processedRequestsList');
            if (processed.length === 0) {
                processedList.innerHTML = `
                    <div style="padding: 20px; background: rgba(255,255,255,0.03); border-radius: 8px; text-align: center; color: var(--color-text-secondary); font-size: 14px;">
                        Noch keine bearbeiteten Anfragen
                    </div>
                `;
            } else {
                processedList.innerHTML = processed.map(anfrage => createAnfrageCard(anfrage, false)).join('');
            }
        }

        /**
         * Create HTML for vacation request card
         */
        function createAnfrageCard(anfrage, isPending) {
            const startDate = new Date(anfrage.startDatum);
            const endDate = new Date(anfrage.endDatum);
            const startFormatted = startDate.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const endFormatted = endDate.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });

            const statusBadge = {
                'pending': '<span style="padding: 4px 12px; background: rgba(255, 149, 0, 0.2); border-radius: 12px; font-size: 12px; font-weight: 600; color: #ff9500;">‚è≥ Ausstehend</span>',
                'approved': '<span style="padding: 4px 12px; background: rgba(52, 199, 89, 0.2); border-radius: 12px; font-size: 12px; font-weight: 600; color: #34c759;">‚úÖ Genehmigt</span>',
                'rejected': '<span style="padding: 4px 12px; background: rgba(255, 59, 48, 0.2); border-radius: 12px; font-size: 12px; font-weight: 600; color: #ff3b30;">‚ùå Abgelehnt</span>'
            }[anfrage.status];

            const actionButtons = isPending ? `
                <div style="display: flex; gap: 10px;">
                    <button onclick="approveVacation('${anfrage.id}')" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #34c759, #28a745); border: none; border-radius: 8px; color: white; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        ‚úÖ Genehmigen
                    </button>
                    <button onclick="openRejectVacationModal('${anfrage.id}')" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #ff3b30, #dc143c); border: none; border-radius: 8px; color: white; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        ‚ùå Ablehnen
                    </button>
                </div>
            ` : '';

            const ablehnungsgrundSection = anfrage.status === 'rejected' && anfrage.ablehnungsgrund ? `
                <div style="margin-top: 12px; padding: 10px; background: rgba(255, 59, 48, 0.1); border-left: 3px solid #ff3b30; border-radius: 4px;">
                    <p style="margin: 0; font-size: 12px; color: var(--color-text-secondary);"><strong>Ablehnungsgrund:</strong></p>
                    <p style="margin: 4px 0 0 0; font-size: 13px; color: var(--color-text-primary);">${anfrage.ablehnungsgrund}</p>
                </div>
            ` : '';

            const bearbeitetSection = anfrage.bearbeitetAm ? `
                <p style="margin: 4px 0 0 0; font-size: 12px; color: var(--color-text-secondary);">
                    Bearbeitet am ${new Date(anfrage.bearbeitetAm).toLocaleString('de-DE')}
                </p>
            ` : '';

            return `
                <div style="padding: 20px; background: ${isPending ? 'rgba(255, 149, 0, 0.05)' : 'rgba(255,255,255,0.03)'}; border: ${isPending ? '2px solid rgba(255, 149, 0, 0.3)' : '1px solid rgba(255,255,255,0.1)'}; border-radius: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                        <div>
                            <h4 style="margin: 0 0 6px 0; color: var(--color-text-primary); font-size: 18px;">${anfrage.mitarbeiterName}</h4>
                            <p style="margin: 0; font-size: 13px; color: var(--color-text-secondary);">
                                ${anfrage.mitarbeiterRolle || 'Sonstige'}
                            </p>
                        </div>
                        ${statusBadge}
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 12px;">
                        <div>
                            <p style="margin: 0 0 4px 0; font-size: 11px; color: var(--color-text-secondary); text-transform: uppercase; font-weight: 600;">Von</p>
                            <p style="margin: 0; font-size: 15px; color: var(--color-text-primary); font-weight: 600;">${startFormatted}</p>
                        </div>
                        <div>
                            <p style="margin: 0 0 4px 0; font-size: 11px; color: var(--color-text-secondary); text-transform: uppercase; font-weight: 600;">Bis</p>
                            <p style="margin: 0; font-size: 15px; color: var(--color-text-primary); font-weight: 600;">${endFormatted}</p>
                        </div>
                        <div>
                            <p style="margin: 0 0 4px 0; font-size: 11px; color: var(--color-text-secondary); text-transform: uppercase; font-weight: 600;">Tage</p>
                            <p style="margin: 0; font-size: 15px; color: var(--color-text-primary); font-weight: 600;">${anfrage.anzahlTage} Werktage</p>
                        </div>
                    </div>

                    ${anfrage.grund ? `
                        <div style="margin-bottom: 12px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px;">
                            <p style="margin: 0 0 4px 0; font-size: 11px; color: var(--color-text-secondary); text-transform: uppercase; font-weight: 600;">Grund</p>
                            <p style="margin: 0; font-size: 13px; color: var(--color-text-primary);">${anfrage.grund}</p>
                        </div>
                    ` : ''}

                    ${ablehnungsgrundSection}
                    ${bearbeitetSection}
                    ${actionButtons}
                </div>
            `;
        }

        /**
         * Approve vacation request
         */
        async function approveVacation(anfrageId) {
            if (!confirm('M√∂chtest du diese Urlaubs-Anfrage wirklich genehmigen?')) {
                return;
            }

            try {
                console.log(`‚úÖ Genehmige Urlaubs-Anfrage: ${anfrageId}`);

                const anfrage = allUrlaubsAnfragen.find(a => a.id === anfrageId);
                if (!anfrage) {
                    showToast('‚ùå Anfrage nicht gefunden', 'error', 3000);
                    return;
                }

                const currentUser = window.authManager.getCurrentUser();

                // Update anfrage status
                await window.getCollection('urlaubsAnfragen').doc(anfrageId).update({
                    status: 'approved',
                    bearbeitetVon: currentUser.uid,
                    bearbeitetAm: new Date().toISOString()
                });

                // üÜï Phase 2.1: Update urlaubstageVerbraucht in mitarbeiter document
                const mitarbeiterDoc = await window.getCollection('mitarbeiter').doc(anfrage.mitarbeiterId).get();
                const mitarbeiterData = mitarbeiterDoc.data();

                const urlaubstageVerbraucht = (mitarbeiterData.urlaubstageVerbraucht || 0) + anfrage.anzahlTage;

                await window.getCollection('mitarbeiter').doc(anfrage.mitarbeiterId).update({
                    urlaubstageVerbraucht: urlaubstageVerbraucht
                });

                console.log(`‚úÖ Urlaubstage aktualisiert: ${urlaubstageVerbraucht}`);

                showToast(`‚úÖ Urlaub genehmigt! ${anfrage.anzahlTage} Tage von ${anfrage.mitarbeiterName}`, 'success', 4000);

                // Reload anfragen
                await loadUrlaubsAnfragen();

                // Reload mitarbeiter table if on mitarbeiter tab
                if (typeof renderMitarbeiterTable === 'function') {
                    await loadMitarbeiter();
                }

            } catch (error) {
                console.error('‚ùå Fehler beim Genehmigen:', error);
                showToast('‚ùå Fehler beim Genehmigen der Anfrage', 'error', 3000);
            }
        }

        /**
         * Open reject vacation modal
         */
        function openRejectVacationModal(anfrageId) {
            const anfrage = allUrlaubsAnfragen.find(a => a.id === anfrageId);
            if (!anfrage) {
                showToast('‚ùå Anfrage nicht gefunden', 'error', 3000);
                return;
            }

            currentRejectAnfrageId = anfrageId;

            const startDate = new Date(anfrage.startDatum).toLocaleDateString('de-DE');
            const endDate = new Date(anfrage.endDatum).toLocaleDateString('de-DE');

            document.getElementById('rejectVacationInfo').textContent =
                `${anfrage.mitarbeiterName} ¬∑ ${anfrage.anzahlTage} Tage ¬∑ ${startDate} - ${endDate}`;
            document.getElementById('ablehnungsgrund').value = '';
            document.getElementById('rejectVacationModal').style.display = 'block';
        }

        /**
         * Close reject vacation modal
         */
        function closeRejectVacationModal() {
            document.getElementById('rejectVacationModal').style.display = 'none';
            currentRejectAnfrageId = null;
        }

        /**
         * Confirm reject vacation
         */
        async function confirmRejectVacation() {
            const grund = document.getElementById('ablehnungsgrund').value.trim();

            if (!grund) {
                showToast('‚ö†Ô∏è Bitte Ablehnungsgrund eingeben!', 'warning', 3000);
                return;
            }

            try {
                console.log(`‚ùå Lehne Urlaubs-Anfrage ab: ${currentRejectAnfrageId}`);

                const currentUser = window.authManager.getCurrentUser();

                // Update anfrage status
                await window.getCollection('urlaubsAnfragen').doc(currentRejectAnfrageId).update({
                    status: 'rejected',
                    bearbeitetVon: currentUser.uid,
                    bearbeitetAm: new Date().toISOString(),
                    ablehnungsgrund: grund
                });

                showToast('‚úÖ Urlaub abgelehnt', 'success', 3000);

                // Close modal
                closeRejectVacationModal();

                // Reload anfragen
                await loadUrlaubsAnfragen();

            } catch (error) {
                console.error('‚ùå Fehler beim Ablehnen:', error);
                showToast('‚ùå Fehler beim Ablehnen der Anfrage', 'error', 3000);
            }
        }

        // Auto-load vacation requests on page load (if werkstattId available)
        if (window.werkstattId) {
            // Initial load after 2 seconds (give time for mitarbeiter to load)
            setTimeout(() => {
                loadUrlaubsAnfragen();
            }, 2000);
        }
    </script>
</body>
</html>
