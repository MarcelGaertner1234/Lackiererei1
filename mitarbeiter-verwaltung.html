<!DOCTYPE html>
<html lang="de">
<head>
    <script>
        /// <reference path="js/types.js" />
    </script>
    <script>
        // ‚úÖ BUG #5 FIX: Global DEBUG flag for conditional logging
        window.DEBUG = (
            localStorage.getItem('DEBUG') === 'true' ||
            window.location.search.includes('debug=true') ||
            window.location.hostname === 'localhost' ||
            window.location.port === '8000'
        );
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mitarbeiter-Verwaltung | Auto-Lackierzentrum Mosbach</title>

    <!-- üåì FOUC Prevention: Load Theme BEFORE CSS -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>

    <!-- Mobile-Responsive CSS Framework -->
    <link rel="stylesheet" href="mobile-responsive.css">

    <!-- Apple Liquid Glass Design System -->
    <link rel="stylesheet" href="design-system.css">
    <link rel="stylesheet" href="components.css">
    <link rel="stylesheet" href="animations.css">
    <link rel="stylesheet" href="mobile-first.css">
    <link rel="stylesheet" href="css/ai-chat-widget.css">
    <link rel="stylesheet" href="css/quota-display.css">

    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>

    <!-- GSAP Animation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', 'Inter', var(--font-system);
            background: var(--color-background);
            min-height: 100vh;
            padding: var(--space-6) var(--space-4) 100px;
            color: var(--color-text-primary);
            transition: background 0.3s ease, color 0.3s ease;
            overflow-x: auto;
            position: relative;
        }

        /* üé® Marken-Charakter: Dezentes Reflex-Pattern (Lack-Oberfl√§che) */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 50px,
                rgba(255, 255, 255, 0.02) 50px,
                rgba(255, 255, 255, 0.02) 51px
            );
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;

            /* Glassmorphismus - Apple Liquid Glass Style */
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);

            padding: var(--space-8);
            position: relative;
            overflow: visible;

            /* ‚ú® Page-Transition: Slide-In beim Laden */
            animation: slideIn 0.4s cubic-bezier(0.22, 1, 0.36, 1);
        }

        /* üé¨ Page-Transition Animation */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Navigation Bar */
        .nav-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            padding: 15px;
            background: var(--color-surface);
            border-radius: 12px;
            border: 1px solid var(--color-border-glass);
        }

        .nav-btn {
            padding: 10px 20px;
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border-glass);
            border-radius: 8px;
            color: var(--color-text-primary);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
        }

        .nav-btn:hover {
            background: var(--color-surface-elevated);
            color: var(--color-primary);
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            color: var(--color-text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 113, 227, 0.3);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: rgba(255, 0, 0, 0.2);
            border: 2px solid rgba(255, 0, 0, 0.5);
            color: #ff4444;
        }

        .btn-danger:hover {
            background: rgba(255, 0, 0, 0.3);
            transform: translateY(-2px);
        }

        /* Fix for vacation request grid containers */
        #pendingRequestsList,
        #processedRequestsList {
            display: grid;
            gap: 15px;
            width: 100%;
            overflow: visible;
        }

        /* Ensure cards don't overflow */
        #pendingRequestsList > div,
        #processedRequestsList > div {
            min-width: 0;  /* Allow flex/grid children to shrink below content size */
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* Table */
        .mitarbeiter-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: var(--color-surface);
            border-radius: 12px;
            overflow: hidden;
        }

        .mitarbeiter-table thead {
            background: rgba(255, 255, 255, 0.1);
        }

        .mitarbeiter-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--color-text-primary);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .mitarbeiter-table td {
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: var(--color-text-secondary);
        }

        .mitarbeiter-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
            border: 1px solid rgba(40, 167, 69, 0.4);
        }

        .badge-warning {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border: 1px solid rgba(255, 193, 7, 0.4);
        }

        .badge-danger {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
            border: 1px solid rgba(220, 53, 69, 0.4);
        }

        .badge-info {
            background: rgba(0, 113, 227, 0.2);
            color: var(--color-primary);
            border: 1px solid rgba(0, 113, 227, 0.4);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--color-text-secondary);
        }

        .empty-state i {
            width: 64px;
            height: 64px;
            color: var(--color-text-secondary);
            opacity: 0.5;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 10px;
            color: var(--color-text-primary);
        }

        /* Theme Toggle Button */
        .theme-toggle {
            position: fixed;
            top: var(--space-4);
            right: var(--space-4);
            z-index: 10000;
            width: 56px;
            height: 56px;
            border-radius: var(--radius-full);
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            box-shadow: var(--shadow-lg), inset 0 1px 1px rgba(255,255,255,0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            border: none;
        }

        .theme-toggle:hover {
            transform: scale(1.1) rotate(15deg);
            box-shadow: var(--shadow-xl), inset 0 1px 1px rgba(255,255,255,0.2);
        }

        .theme-toggle__icon {
            position: absolute;
            width: 24px;
            height: 24px;
            color: var(--color-text-primary);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        /* Show sun icon in dark mode, moon in light mode */
        [data-theme="dark"] .theme-toggle__icon--light {
            opacity: 1;
            transform: rotate(0deg) scale(1);
        }

        [data-theme="dark"] .theme-toggle__icon--dark {
            opacity: 0;
            transform: rotate(180deg) scale(0);
        }

        :root .theme-toggle__icon--light,
        [data-theme="light"] .theme-toggle__icon--light {
            opacity: 0;
            transform: rotate(-180deg) scale(0);
        }

        :root .theme-toggle__icon--dark,
        [data-theme="light"] .theme-toggle__icon--dark {
            opacity: 1;
            transform: rotate(0deg) scale(1);
        }

        /* Dark Mode - Text & Borders */
        [data-theme="dark"] .mitarbeiter-table th,
        [data-theme="dark"] .mitarbeiter-table td {
            color: rgba(255, 255, 255, 0.9);
        }

        [data-theme="dark"] .header h1 {
            color: rgba(255, 255, 255, 0.95);
        }

        [data-theme="dark"] .nav-btn {
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.8);
            border-color: rgba(255, 255, 255, 0.2);
        }

        [data-theme="dark"] .nav-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            color: #2ec8ff;
        }

        [data-theme="dark"] .nav-btn.active {
            background: rgba(46, 200, 255, 0.3);
            color: rgba(255, 255, 255, 1);
            border-color: rgba(46, 200, 255, 0.6);
        }

        /* Desktop/Mobile View Toggle */
        .mitarbeiter-table-desktop {
            display: block;
        }

        .mitarbeiter-cards-mobile {
            display: none;
        }

        /* Mobile Employee Cards */
        .employee-card {
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border-glass);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }

        .employee-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .employee-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--color-border-glass);
        }

        .employee-card-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-text-primary);
            margin: 0;
        }

        .employee-card-role {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .employee-card-role.meister {
            background: rgba(255, 193, 7, 0.2);
            color: rgba(255, 193, 7, 1);
            border: 1px solid rgba(255, 193, 7, 0.4);
        }

        .employee-card-role.geselle {
            background: rgba(33, 150, 243, 0.2);
            color: rgba(33, 150, 243, 1);
            border: 1px solid rgba(33, 150, 243, 0.4);
        }

        .employee-card-role.sonstige {
            background: rgba(156, 39, 176, 0.2);
            color: rgba(156, 39, 176, 1);
            border: 1px solid rgba(156, 39, 176, 0.4);
        }

        .employee-card-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .employee-stat {
            background: rgba(255, 255, 255, 0.03);
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--color-border-glass);
        }

        .employee-stat-label {
            font-size: 11px;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .employee-stat-value {
            font-size: 16px;
            color: var(--color-text-primary);
            font-weight: 600;
        }

        .employee-stat-value.positive {
            color: rgba(52, 199, 89, 1);
        }

        .employee-stat-value.negative {
            color: rgba(255, 59, 48, 1);
        }

        .employee-card-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .employee-card-actions button {
            min-height: 48px;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        /* Desktop/Mobile Toggle for Stunden & Zeit Tables */
        .stunden-table-desktop,
        .zeit-table-desktop {
            display: block;
        }

        .stunden-cards-mobile,
        .zeit-cards-mobile {
            display: none;
        }

        /* Stundennachweise Mobile Cards */
        .stunden-card {
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border-glass);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }

        .stunden-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .stunden-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--color-border-glass);
        }

        .stunden-card-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .stunden-card-month {
            font-size: 14px;
            color: var(--color-text-secondary);
            background: rgba(255, 255, 255, 0.05);
            padding: 6px 12px;
            border-radius: 20px;
        }

        .stunden-card-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .stunden-stat {
            background: rgba(255, 255, 255, 0.03);
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--color-border-glass);
        }

        .stunden-stat-label {
            font-size: 11px;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .stunden-stat-value {
            font-size: 16px;
            color: var(--color-text-primary);
            font-weight: 600;
        }

        .stunden-stat-value.positive {
            color: rgba(52, 199, 89, 1);
        }

        .stunden-stat-value.negative {
            color: rgba(255, 59, 48, 1);
        }

        .stunden-card-actions {
            display: flex;
            gap: 12px;
        }

        .stunden-card-actions button {
            flex: 1;
            min-height: 48px;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        /* Zeiterfassung Mobile Cards */
        .zeit-card {
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border-glass);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
        }

        .zeit-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .zeit-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--color-border-glass);
        }

        .zeit-card-date {
            font-size: 18px;
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .zeit-card-status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .zeit-card-status.arbeitet {
            background: rgba(52, 199, 89, 0.2);
            color: rgba(52, 199, 89, 1);
            border: 1px solid rgba(52, 199, 89, 0.4);
        }

        .zeit-card-status.pause {
            background: rgba(255, 193, 7, 0.2);
            color: rgba(255, 193, 7, 1);
            border: 1px solid rgba(255, 193, 7, 0.4);
        }

        .zeit-card-status.abgeschlossen {
            background: rgba(10, 132, 255, 0.2);
            color: rgba(10, 132, 255, 1);
            border: 1px solid rgba(10, 132, 255, 0.4);
        }

        .zeit-card-timeline {
            display: flex;
            justify-content: space-between;
            margin-bottom: 16px;
            gap: 12px;
        }

        .zeit-timeline-item {
            flex: 1;
            background: rgba(255, 255, 255, 0.03);
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--color-border-glass);
        }

        .zeit-timeline-label {
            font-size: 11px;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .zeit-timeline-value {
            font-size: 14px;
            color: var(--color-text-primary);
            font-weight: 600;
        }

        .zeit-card-hours {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .zeit-hour-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 12px;
            border-radius: 10px;
            border: 1px solid var(--color-border-glass);
        }

        .zeit-hour-label {
            font-size: 11px;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .zeit-hour-value {
            font-size: 16px;
            color: var(--color-text-primary);
            font-weight: 600;
        }

        .zeit-card-actions {
            display: flex;
            gap: 12px;
        }

        .zeit-card-actions button {
            flex: 1;
            min-height: 48px;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            /* Switch from table to cards on mobile */
            .mitarbeiter-table-desktop {
                display: none !important;
            }

            .mitarbeiter-cards-mobile {
                display: block !important;
            }

            /* Switch Stundennachweise to cards */
            .stunden-table-desktop {
                display: none !important;
            }

            .stunden-cards-mobile {
                display: block !important;
            }

            /* Switch Zeiterfassung to cards */
            .zeit-table-desktop {
                display: none !important;
            }

            .zeit-cards-mobile {
                display: block !important;
            }

            .container {
                padding: 12px;  /* Further reduce padding on mobile */
            }

            body {
                padding: var(--space-3) var(--space-2) 100px;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .header h1 {
                font-size: 24px;
            }

            .header-actions {
                width: 100%;
            }

            .btn {
                flex: 1;
                justify-content: center;
            }

            .mitarbeiter-table {
                font-size: 14px;
            }

            .mitarbeiter-table th,
            .mitarbeiter-table td {
                padding: 10px;
            }

            .theme-toggle {
                width: 48px;
                height: 48px;
                top: var(--space-3);
                right: var(--space-3);
            }

            .theme-toggle__icon {
                width: 20px;
                height: 20px;
            }

            /* Touch-friendly buttons (min 48px) */
            .tab-button {
                min-height: 48px;
                padding: 14px 20px !important;
                font-size: 15px !important;
            }

            .header-actions .btn {
                min-height: 48px;
                padding: 14px 20px;
                font-size: 14px;
            }

            /* Tab navigation horizontal scroll */
            .tabs-container {
                display: flex;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                -ms-overflow-style: none;
                margin-bottom: 20px;
                gap: 8px;
            }

            .tabs-container::-webkit-scrollbar {
                display: none;
            }
        }

        /* üåô Dark Mode Fix f√ºr Edit Modal */
        [data-theme="dark"] #modalContent {
            background: #2a2a2d !important;
        }

        [data-theme="dark"] #newMitarbeiterModalContent {
            background: #2a2a2d !important;
        }

        /* üåô Dark Mode Fix f√ºr Zeiterfassung Edit Modal */
        [data-theme="dark"] #editZeitModal > div {
            background: #2a2a2d !important;
        }

        /* Dark Mode: Time Input Fields */
        [data-theme="dark"] #editZeitStart,
        [data-theme="dark"] #editZeitEnd,
        [data-theme="dark"] #editZeitPausenContainer input[type="time"] {
            background: rgba(255, 255, 255, 0.08) !important;
            color: rgba(255, 255, 255, 0.9) !important;
            border-color: rgba(255, 255, 255, 0.2) !important;
        }

        /* Dark Mode: Time Input Fields - Focus State */
        [data-theme="dark"] #editZeitStart:focus,
        [data-theme="dark"] #editZeitEnd:focus,
        [data-theme="dark"] #editZeitPausenContainer input[type="time"]:focus {
            background: rgba(255, 255, 255, 0.12) !important;
            border-color: #2ec8ff !important;
            outline: none;
        }

        /* Button Secondary (base styles - was missing) */
        .btn-secondary {
            background: rgba(128, 128, 128, 0.2);
            border: 2px solid rgba(128, 128, 128, 0.5);
            color: rgba(0, 0, 0, 0.7);
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-secondary:hover {
            background: rgba(128, 128, 128, 0.3);
            transform: translateY(-2px);
        }

        /* Dark Mode: Button Secondary */
        [data-theme="dark"] .btn-secondary {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.8);
        }

        [data-theme="dark"] .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 1);
        }

        /* Dark Mode: Close Button (‚úï) */
        [data-theme="dark"] #editZeitModal button[onclick="closeEditZeitModal()"] {
            color: rgba(255, 255, 255, 0.6) !important;
        }

        [data-theme="dark"] #editZeitModal button[onclick="closeEditZeitModal()"]:hover {
            color: rgba(255, 255, 255, 0.9) !important;
        }

        /* ‚úÖ TOGGLE SWITCH CHECKBOXEN - iOS Style */
        .permission-checkbox {
            display: none; /* Hide original checkbox */
        }

        .permission-label {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .permission-label:hover {
            background: rgba(255,255,255,0.05);
        }

        /* Toggle Switch Container */
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 26px;
            background: rgba(255,255,255,0.15);
            border-radius: 13px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid rgba(255,255,255,0.2);
        }

        /* Toggle Slider */
        .toggle-slider {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Checked State */
        .permission-checkbox:checked + .permission-label .toggle-switch {
            background: linear-gradient(135deg, #34c759 0%, #30d158 100%); /* iOS Green */
            border-color: #34c759;
        }

        .permission-checkbox:checked + .permission-label .toggle-slider {
            transform: translateX(22px);
        }

        /* Permission Text */
        .permission-text {
            font-size: 14px;
            font-weight: 500;
            color: var(--color-text-secondary);
            transition: color 0.2s;
        }

        .permission-checkbox:checked + .permission-label .permission-text {
            color: var(--color-text-primary);
            font-weight: 600;
        }

        /* Hover Animation */
        .permission-label:hover .toggle-switch {
            transform: scale(1.05);
        }

        /* Active Animation (beim Klicken) */
        .permission-label:active .toggle-switch {
            transform: scale(0.95);
        }

        /* Dark Mode */
        [data-theme="dark"] .toggle-switch {
            background: rgba(255,255,255,0.1);
        }

        [data-theme="dark"] .toggle-slider {
            background: rgba(255,255,255,0.9);
        }

        /* Info Box Styles */
        .info-box {
            background: rgba(0, 113, 227, 0.1);
            border-left: 4px solid var(--color-primary);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info-box p {
            color: var(--color-text-primary);
            margin: 0;
        }

        .success-box {
            background: rgba(40, 167, 69, 0.1);
            border-left: 4px solid #28a745;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .success-box p {
            color: var(--color-text-primary);
            margin: 0;
        }

        /* ============================================
         * LOHNABRECHNUNG: Modal Tab Navigation
         * ============================================ */
        .modal-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
            padding: 4px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 12px;
            overflow-x: auto;
        }

        .modal-tab {
            flex: 1;
            min-width: 100px;
            padding: 10px 16px;
            border: none;
            background: transparent;
            color: var(--color-text-secondary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .modal-tab:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--color-text-primary);
        }

        .modal-tab.active {
            background: var(--color-primary);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 113, 227, 0.3);
        }

        .modal-tab-content {
            display: none;
        }

        .modal-tab-content.active {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Form Field Groups */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--color-text-primary);
            font-size: 14px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: var(--color-text-primary);
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group select:focus {
            border-color: var(--color-primary);
            outline: none;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            .modal-tabs {
                flex-wrap: nowrap;
            }
            .modal-tab {
                min-width: 80px;
                padding: 8px 12px;
                font-size: 12px;
            }
        }

        /* Section Headers in Tabs */
        .section-header {
            font-size: 14px;
            font-weight: 700;
            color: var(--color-primary);
            margin: 20px 0 15px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid rgba(0, 113, 227, 0.2);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-header:first-child {
            margin-top: 0;
        }

        /* Info Box for Tab */
        .tab-info-box {
            background: rgba(0, 113, 227, 0.1);
            border-left: 4px solid var(--color-primary);
            padding: 12px 15px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 20px;
            font-size: 13px;
            color: var(--color-text-secondary);
        }

        /* üîô ZUR√úCK-BUTTON (Fixed Position) */
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--color-border, rgba(255,255,255,0.1));
            border-radius: 8px;
            color: var(--color-text-primary, #e0e0e0);
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .back-button:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(-2px);
        }
        [data-theme="light"] .back-button {
            background: rgba(255, 255, 255, 0.8);
            border-color: rgba(0, 0, 0, 0.1);
            color: #1a1a2e;
        }
        @media (max-width: 768px) {
            .back-button { top: 10px; left: 10px; padding: 8px; }
            .back-button span { display: none; }
        }
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

    <!-- jsPDF Library for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF AutoTable Plugin for professional tables -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <!-- Firebase Konfiguration -->
    <script src="firebase-config.js?v=4412ea9"></script>

    <!-- Auth Manager -->
    <script src="js/auth-manager.js?v=20251027-multitenant"></script>
    <script src="js/settings-manager.js"></script>
    <script src="js/permissions-helper.js"></script>

    <!-- Error Handler & Toast Notifications -->
    <script src="error-handler.js"></script>

    <!-- ‚úÖ FIX Bug #19 (2025-11-24): Listener Registry for safeNavigate() -->
    <!-- PROBLEM: safeNavigate() called in onclick handlers (Lines 1112, 2163, 2174, 2184) but not defined -->
    <!-- SOLUTION: Load listener-registry.js which defines window.safeNavigate -->
    <script src="listener-registry.js"></script>

    <!-- jsPDF f√ºr Lohnabrechnung PDF-Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Lohnabrechnung Module -->
    <script src="js/lohnberechnung.js"></script>
    <script src="js/lohnabrechnung-pdf.js"></script>
</head>
<body class="has-ai-features">
    <!-- üîô ZUR√úCK-BUTTON -->
    <button class="back-button" onclick="history.back()" title="Zur√ºck">
        <i data-feather="arrow-left"></i>
        <span>Zur√ºck</span>
    </button>

    <!-- üåì THEME TOGGLE BUTTON - Fixed Top-Right -->
    <button id="themeToggle" class="theme-toggle" aria-label="Toggle Light/Dark Mode">
        <i data-feather="sun" class="theme-toggle__icon theme-toggle__icon--light"></i>
        <i data-feather="moon" class="theme-toggle__icon theme-toggle__icon--dark"></i>
    </button>

    <div class="container">
        <!-- Navigation -->
        <div class="nav-bar">
            <a href="index.html" class="nav-btn">Home</a>
            <a href="annahme.html" class="nav-btn">Annahme</a>
            <a href="abnahme.html" class="nav-btn">Abnahme</a>
            <a href="liste.html" class="nav-btn">√úbersicht</a>
            <a href="kunden.html" class="nav-btn">Kunden</a>
            <a href="kalender.html" class="nav-btn">Kalender</a>
            <a href="kanban.html" class="nav-btn">Prozess√ºberwachung</a>
            <a href="mitarbeiter-verwaltung.html" class="nav-btn active">Mitarbeiter</a>
        </div>

        <!-- Header -->
        <div class="header">
            <!-- Werkstatt Logo (dynamisch geladen) -->
            <div id="werkstattLogo" style="display: inline-block; vertical-align: middle; margin-right: 12px;"></div>
            <h1 style="display: inline-block; vertical-align: middle;">
                üë• Mitarbeiter-Verwaltung
                <span id="werkstattName" style="font-size: 18px; color: var(--color-text-secondary); font-weight: 400;"></span>
            </h1>
            <div class="header-actions">
                <button class="btn btn-success" onclick="openNewMitarbeiterModal()">
                    ‚ûï Neuer Mitarbeiter
                </button>
                <button class="btn btn-primary" onclick="createTestData()" style="background: rgba(0, 113, 227, 0.3); border: 2px solid var(--color-primary);">
                    üß™ Test-Daten (3)
                </button>
                <!-- üÜï Phase 2.2: Dienstplan-Link -->
                <button class="btn btn-primary" onclick="safeNavigate('dienstplan.html')" style="background: linear-gradient(135deg, #007aff, #0051d5);">
                    üìÖ Dienstplan
                </button>
            </div>
        </div>

        <!-- Success Info Box (MULTI-TENANT) -->
        <div class="success-box">
            <p>
                <strong>‚úÖ MULTI-TENANT READY!</strong><br>
                Diese Seite nutzt jetzt <code>mitarbeiter_{werkstattId}</code> Collection.<br>
                Mitarbeiter sind werkstatt-spezifisch isoliert! üè¢
            </p>
        </div>

        <!-- üÜï Phase 2.1: Tabs Navigation -->
        <div class="tabs-container" style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid rgba(255,255,255,0.1); padding-bottom: 0;">
            <button id="tabMitarbeiter" class="tab-button active" onclick="switchTab('mitarbeiter')" style="padding: 12px 24px; background: transparent; border: none; border-bottom: 3px solid var(--color-primary); color: var(--color-text-primary); font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; flex-shrink: 0; white-space: nowrap;">
                üë• Mitarbeiter
            </button>
            <button id="tabUrlaub" class="tab-button" onclick="switchTab('urlaub')" style="padding: 12px 24px; background: transparent; border: none; border-bottom: 3px solid transparent; color: var(--color-text-secondary); font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; flex-shrink: 0; white-space: nowrap;">
                üèñÔ∏è Urlaubs-Anfragen <span id="pendingCount" class="badge" style="display: inline-block; padding: 2px 8px; background: rgba(255, 59, 48, 0.8); border-radius: 12px; font-size: 12px; margin-left: 6px;">0</span>
            </button>
            <button id="tabStunden" class="tab-button" onclick="switchTab('stunden')" style="padding: 12px 24px; background: transparent; border: none; border-bottom: 3px solid transparent; color: var(--color-text-secondary); font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; flex-shrink: 0; white-space: nowrap;">
                üìÑ Stundennachweise <span id="stundenCount" class="badge" style="display: inline-block; padding: 2px 8px; background: rgba(10, 132, 255, 0.8); border-radius: 12px; font-size: 12px; margin-left: 6px;">0</span>
            </button>
            <button id="tabZeiterfassung" class="tab-button" onclick="switchTab('zeiterfassung')" style="padding: 12px 24px; background: transparent; border: none; border-bottom: 3px solid transparent; color: var(--color-text-secondary); font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; flex-shrink: 0; white-space: nowrap;">
                ‚è±Ô∏è Zeiterfassung <span id="zeiterfassungCount" class="badge" style="display: inline-block; padding: 2px 8px; background: rgba(52, 199, 89, 0.8); border-radius: 12px; font-size: 12px; margin-left: 6px;">0</span>
            </button>
        </div>

        <!-- Tab Content: Mitarbeiter -->
        <div id="contentMitarbeiter" class="tab-content">
            <!-- Desktop: Mitarbeiter Tabelle -->
            <div class="mitarbeiter-table-desktop">
                <div style="overflow-x: auto; -webkit-overflow-scrolling: touch;">
            <table class="mitarbeiter-table">
                <thead>
                    <tr>
                        <th>üë§ Name</th>
                        <th>üëî Rolle</th>
                        <th>üèñÔ∏è Urlaub</th>
                        <th>ü§í Krank</th>
                        <th>‚è±Ô∏è SOLL-Stunden</th>
                        <th>‚è±Ô∏è IST-Stunden</th>
                        <th>üìä Differenz</th>
                        <th>üîë Passwort</th>
                        <th>‚úÖ Status</th>
                        <th>üîê Berechtigungen</th>
                        <th>‚öôÔ∏è Aktionen</th>
                    </tr>
                </thead>
                <tbody id="mitarbeiterTableBody">
                    <!-- Wird dynamisch gef√ºllt -->
                    <tr>
                        <td colspan="11">
                            <div class="empty-state">
                                <i data-feather="users"></i>
                                <h3>L√§dt Mitarbeiter...</h3>
                                <p>Bitte warten...</p>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
                </div>
            </div>

            <!-- Mobile: Mitarbeiter Karten -->
            <div class="mitarbeiter-cards-mobile" id="mitarbeiterCardsContainer">
                <!-- Wird dynamisch gef√ºllt mit JavaScript -->
                <div class="empty-state">
                    <i data-feather="users"></i>
                    <h3>L√§dt Mitarbeiter...</h3>
                    <p>Bitte warten...</p>
                </div>
            </div>
        </div> <!-- End contentMitarbeiter -->

        <!-- Tab Content: Urlaubs-Anfragen -->
        <div id="contentUrlaub" class="tab-content" style="display: none;">
            <div style="margin-bottom: 20px;">
                <h2 style="color: var(--color-text-primary); margin: 0 0 10px 0;">üèñÔ∏è Urlaubs-Anfragen verwalten</h2>
                <p style="color: var(--color-text-secondary); font-size: 14px; margin: 0;">
                    Hier siehst du alle Urlaubs-Anfragen deiner Mitarbeiter. Genehmige oder lehne Anfragen ab.
                </p>
            </div>

            <!-- Pending Requests (Highlighted) -->
            <div id="pendingRequestsSection" style="margin-bottom: 30px;">
                <h3 style="color: var(--color-text-primary); margin: 0 0 15px 0; font-size: 18px;">
                    ‚è≥ Ausstehende Anfragen
                </h3>
                <div id="pendingRequestsList" style="display: grid; gap: 15px;">
                    <!-- Dynamically filled -->
                    <div style="padding: 20px; background: rgba(255,255,255,0.05); border-radius: 10px; text-align: center; color: var(--color-text-secondary);">
                        L√§dt Anfragen...
                    </div>
                </div>
            </div>

            <!-- Approved/Rejected Requests -->
            <div id="processedRequestsSection">
                <h3 style="color: var(--color-text-secondary); margin: 0 0 15px 0; font-size: 16px;">
                    ‚úÖ Bearbeitete Anfragen
                </h3>
                <div id="processedRequestsList" style="display: grid; gap: 15px;">
                    <!-- Dynamically filled -->
                </div>
            </div>
        </div>

        <!-- Tab Content: Stundennachweise -->
        <div id="contentStunden" class="tab-content" style="display: none;">
            <div style="margin-bottom: 20px;">
                <h2 style="color: var(--color-text-primary); margin: 0 0 10px 0;">üìÑ Stundennachweise</h2>
                <p style="color: var(--color-text-secondary); font-size: 14px; margin: 0;">
                    Hier siehst du alle signierten Stundennachweise deiner Mitarbeiter.
                </p>
            </div>

            <!-- Desktop: Stundennachweise Tabelle -->
            <div class="stunden-table-desktop">
            <table class="mitarbeiter-table">
                <thead>
                    <tr>
                        <th>üë§ Mitarbeiter</th>
                        <th>üìÖ Monat/Jahr</th>
                        <th>üìÖ Zeitraum</th>
                        <th>‚è∞ Stunden</th>
                        <th>‚úçÔ∏è Signiert</th>
                        <th>üìã Anmerkungen</th>
                        <th>üïê Erstellt</th>
                    </tr>
                </thead>
                <tbody id="stundenTableBody">
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: var(--color-text-secondary);">
                            L√§dt Stundennachweise...
                        </td>
                    </tr>
                </tbody>
            </table>
            </div>

            <!-- Mobile: Stundennachweise Karten -->
            <div class="stunden-cards-mobile" id="stundenCardsContainer">
                <div style="text-align: center; padding: 40px; color: var(--color-text-secondary);">
                    L√§dt Stundennachweise...
                </div>
            </div>
        </div>

        <!-- Tab Content: Zeiterfassung -->
        <div id="contentZeiterfassung" class="tab-content" style="display: none;">
            <div style="margin-bottom: 20px;">
                <h2 style="color: var(--color-text-primary); margin: 0 0 10px 0;">‚è±Ô∏è Zeiterfassung bearbeiten</h2>
                <p style="color: var(--color-text-secondary); font-size: 14px; margin: 0;">
                    Hier kannst du die Zeiterfassungs-Eintr√§ge deiner Mitarbeiter manuell korrigieren, falls ein Mitarbeiter falsch gestempelt hat.
                    <strong>Achtung:</strong> Manuell bearbeitete Eintr√§ge werden im PDF mit einem * markiert.
                </p>
            </div>

            <!-- Filter Section -->
            <div style="margin-bottom: 20px; display: flex; gap: 15px; align-items: flex-end;">
                <div style="flex: 1;">
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; color: var(--color-text-primary);">üë§ Mitarbeiter filtern</label>
                    <select id="filterZeitMitarbeiter" onchange="filterZeiterfassung()" style="width: 100%; padding: 10px; border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: var(--color-text-primary); font-size: 14px;">
                        <option value="">Alle Mitarbeiter</option>
                        <!-- Dynamically filled -->
                    </select>
                </div>
                <div style="flex: 1;">
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; color: var(--color-text-primary);">üìÖ Zeitraum</label>
                    <select id="filterZeitRange" onchange="filterZeiterfassung()" style="width: 100%; padding: 10px; border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: var(--color-text-primary); font-size: 14px;">
                        <option value="current">Aktueller Monat</option>
                        <option value="last">Letzter Monat</option>
                        <option value="all">Alle Eintr√§ge</option>
                    </select>
                </div>
            </div>

            <!-- Desktop: Zeiterfassung Tabelle -->
            <div class="zeit-table-desktop">
            <table class="mitarbeiter-table">
                <thead>
                    <tr>
                        <th>üë§ Mitarbeiter</th>
                        <th>üìÖ Datum</th>
                        <th>‚è±Ô∏è Arbeitsbeginn</th>
                        <th>‚è∏Ô∏è Pausen</th>
                        <th>‚èπÔ∏è Feierabend</th>
                        <th>‚è∞ Stunden</th>
                        <th>‚úèÔ∏è Status</th>
                        <th>‚öôÔ∏è Aktionen</th>
                    </tr>
                </thead>
                <tbody id="zeiterfassungTableBody">
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: var(--color-text-secondary);">
                            L√§dt Zeiterfassungen...
                        </td>
                    </tr>
                </tbody>
            </table>
            </div>

            <!-- Mobile: Zeiterfassung Karten -->
            <div class="zeit-cards-mobile" id="zeitCardsContainer">
                <div style="text-align: center; padding: 40px; color: var(--color-text-secondary);">
                    L√§dt Zeiterfassungen...
                </div>
            </div>
        </div>

        <!-- EDIT MODAL -->
        <div id="editModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10001; overflow-y: auto; padding: 20px;">
            <div id="modalContent" style="max-width: 700px; margin: 50px auto; background: #ffffff; border-radius: 12px; padding: 30px; box-shadow: 0 8px 32px rgba(0,0,0,0.4);">
                <!-- Modal Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: var(--color-text-primary); margin: 0;">‚úèÔ∏è Mitarbeiter bearbeiten</h2>
                    <button onclick="closeEditModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--color-text-secondary);">‚úï</button>
                </div>

                <!-- Form -->
                <form id="editForm" onsubmit="saveMitarbeiter(event); return false;">
                    <!-- Hidden ID -->
                    <input type="hidden" id="editId">

                    <!-- Tab Navigation -->
                    <div class="modal-tabs">
                        <button type="button" class="modal-tab active" onclick="switchEditTab('stammdaten')">üë§ Stammdaten</button>
                        <button type="button" class="modal-tab" onclick="switchEditTab('lohn')">üí∞ Lohn & Steuer</button>
                        <button type="button" class="modal-tab" onclick="switchEditTab('sozialversicherung')">üè• Sozialvers.</button>
                        <button type="button" class="modal-tab" onclick="switchEditTab('bank')">üè¶ Bank</button>
                    </div>

                    <!-- ===================== TAB 1: STAMMDATEN ===================== -->
                    <div id="editTab-stammdaten" class="modal-tab-content active">
                        <!-- Name -->
                        <div class="form-group">
                            <label>üë§ Name</label>
                            <input type="text" id="editName" required>
                        </div>

                        <div class="form-row">
                            <!-- Status -->
                            <div class="form-group">
                                <label>‚úÖ Status</label>
                                <select id="editStatus" required>
                                    <option value="active">Aktiv</option>
                                    <option value="inactive">Inaktiv</option>
                                </select>
                            </div>

                            <!-- Rolle -->
                            <div class="form-group">
                                <label>üëî Rolle</label>
                                <select id="editRolle" required>
                                    <option value="Lackierer">Lackierer</option>
                                    <option value="Meister">Meister</option>
                                    <option value="Lehrling">Lehrling</option>
                                    <option value="Azubi">Azubi</option>
                                    <option value="Karosseriebauer">Karosseriebauer</option>
                                    <option value="Mechaniker">Mechaniker</option>
                                    <option value="Servicetechniker">Servicetechniker</option>
                                    <option value="B√ºrokraft">B√ºrokraft</option>
                                    <option value="Werkstattleiter">Werkstattleiter</option>
                                    <option value="Sonstige">Sonstige</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <!-- Urlaubstage pro Jahr -->
                            <div class="form-group">
                                <label>üèñÔ∏è Urlaubstage/Jahr</label>
                                <input type="number" id="editUrlaubstageJahr" value="30" min="0" max="50" required>
                            </div>

                            <!-- Eintrittsdatum -->
                            <div class="form-group">
                                <label>üìÖ Eintrittsdatum</label>
                                <input type="date" id="editEintrittsdatum">
                            </div>
                        </div>

                        <!-- Readonly Statistics -->
                        <div style="margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
                            <label style="display: block; font-weight: 600; margin-bottom: 10px; color: var(--color-text-primary); font-size: 14px;">üìä Statistiken (automatisch berechnet)</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px;">
                                <div style="text-align: center; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px;">
                                    <span style="color: var(--color-text-secondary); display: block; margin-bottom: 4px;">Urlaub verbraucht:</span>
                                    <strong id="editUrlaubstageVerbraucht" style="color: #4CAF50; font-size: 16px;">0</strong> <span style="color: var(--color-text-secondary);">Tage</span>
                                </div>
                                <div style="text-align: center; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px;">
                                    <span style="color: var(--color-text-secondary); display: block; margin-bottom: 4px;">Krankheitstage:</span>
                                    <strong id="editKrankheitstage" style="color: #FF9800; font-size: 16px;">0</strong> <span style="color: var(--color-text-secondary);">Tage</span>
                                </div>
                                <div style="text-align: center; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px;">
                                    <span style="color: var(--color-text-secondary); display: block; margin-bottom: 4px;">Stunden (Monat):</span>
                                    <strong id="editMonatlicheStunden" style="color: #2196F3; font-size: 16px;">0</strong><span style="color: var(--color-text-secondary);">h</span>
                                </div>
                                <div style="text-align: center; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px;">
                                    <span style="color: var(--color-text-secondary); display: block; margin-bottom: 4px;">Stunden (Gesamt):</span>
                                    <strong id="editGesamtstunden" style="color: #2196F3; font-size: 16px;">0</strong><span style="color: var(--color-text-secondary);">h</span>
                                </div>
                            </div>
                            <div style="margin-top: 8px; padding: 8px; background: rgba(33, 150, 243, 0.1); border-radius: 4px; font-size: 12px; color: var(--color-text-secondary); text-align: center;">
                                ‚ÑπÔ∏è Diese Werte werden automatisch aus dem Dienstplan berechnet
                            </div>
                        </div>

                        <!-- Password -->
                        <div class="form-group">
                            <label>üîë Neues Passwort (optional)</label>
                            <input type="password" id="editPassword" placeholder="Leer lassen f√ºr keine √Ñnderung">
                        </div>

                        <!-- Berechtigungen (17 Kacheln) - iOS Toggle Style -->
                        <div style="margin-bottom: 20px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                            <div style="display: block; font-weight: 600; margin-bottom: 15px; color: var(--color-text-primary); font-size: 16px;">üîê Berechtigungen f√ºr Kacheln</div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <!-- Fahrzeug-Management -->
                            <div>
                                <input type="checkbox" id="editAnnahme" class="permission-checkbox">
                                <label for="editAnnahme" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üöó Annahme</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="editAbnahme" class="permission-checkbox">
                                <label for="editAbnahme" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">‚úÖ Abnahme</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="editListe" class="permission-checkbox">
                                <label for="editListe" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üìã √úbersicht</span>
                                </label>
                            </div>

                            <!-- Prozess-√úberwachung -->
                            <div>
                                <input type="checkbox" id="editKanban" class="permission-checkbox">
                                <label for="editKanban" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üìä Kanban</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="editKunden" class="permission-checkbox">
                                <label for="editKunden" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üë• Kunden</span>
                                </label>
                            </div>

                            <!-- Organisation & Partner -->
                            <div>
                                <input type="checkbox" id="editKalender" class="permission-checkbox">
                                <label for="editKalender" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üìÖ Kalender</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="editMaterial" class="permission-checkbox">
                                <label for="editMaterial" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üì¶ Material</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="editPartnerAnfragen" class="permission-checkbox">
                                <label for="editPartnerAnfragen" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üìß Partner-Anfragen</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="editPartnerPortal" class="permission-checkbox">
                                <label for="editPartnerPortal" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üîó Partner-Portal</span>
                                </label>
                            </div>

                            <!-- Admin-Funktionen -->
                            <div>
                                <input type="checkbox" id="editMitarbeiterVerwaltung" class="permission-checkbox">
                                <label for="editMitarbeiterVerwaltung" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üë§ Mitarbeiter-Verwaltung</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="editNutzerVerwaltung" class="permission-checkbox">
                                <label for="editNutzerVerwaltung" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üë• User-Verwaltung</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="editRegistrierung" class="permission-checkbox">
                                <label for="editRegistrierung" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üìù Registrierung</span>
                                </label>
                            </div>

                            <!-- KI-Assistent -->
                            <div>
                                <input type="checkbox" id="editKiChat" class="permission-checkbox">
                                <label for="editKiChat" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üí¨ KI-Chat</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="editKiSprache" class="permission-checkbox">
                                <label for="editKiSprache" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üé§ KI-Sprache</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="editDienstplan" class="permission-checkbox">
                                <label for="editDienstplan" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üìÖ Dienstplan</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="editLager" class="permission-checkbox">
                                <label for="editLager" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üì¶ Lager</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="editRechnungen" class="permission-checkbox">
                                <label for="editRechnungen" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üßæ Rechnungen</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="editPreiseSichtbar" class="permission-checkbox">
                                <label for="editPreiseSichtbar" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üí∞ Preise sichtbar</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="editBestellungenVerwalten" class="permission-checkbox">
                                <label for="editBestellungenVerwalten" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üì¶ Bestellungen verwalten</span>
                                </label>
                            </div>
                        </div>
                        </div>
                    </div> <!-- End Tab 1: Stammdaten -->

                    <!-- ===================== TAB 2: LOHN & STEUER ===================== -->
                    <div id="editTab-lohn" class="modal-tab-content">
                        <div class="tab-info-box">
                            üí° Diese Daten werden f√ºr die automatische Lohnabrechnung verwendet.
                        </div>

                        <div class="section-header">üìß Kontakt</div>
                        <div class="form-group">
                            <label>üìß Email (f√ºr Lohnabrechnung)</label>
                            <input type="email" id="editExternalEmail" placeholder="mitarbeiter@email.de">
                        </div>

                        <div class="section-header">üí∞ Verg√ºtung</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>üìã Verg√ºtungsart</label>
                                <select id="editVerguetungsart" onchange="toggleVerguetungsFelder()">
                                    <option value="stundenlohn">Stundenlohn</option>
                                    <option value="monatsgehalt">Monatsgehalt</option>
                                </select>
                            </div>
                            <div class="form-group" id="editStundenlohnGroup">
                                <label>üíµ Stundenlohn (Brutto)</label>
                                <input type="number" id="editStundenlohn" step="0.01" min="0" placeholder="0.00">
                            </div>
                            <div class="form-group" id="editMonatsgehaltGroup" style="display:none;">
                                <label>üíµ Monatsgehalt (Brutto)</label>
                                <input type="number" id="editMonatsgehalt" step="0.01" min="0" placeholder="0.00">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>‚è∞ Wochenarbeitsstunden</label>
                            <input type="number" id="editWochenarbeitsstunden" value="40" min="1" max="60">
                        </div>

                        <div class="section-header">üìã Steuer-Daten</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>üè∑Ô∏è Steuerklasse</label>
                                <select id="editSteuerklasse">
                                    <option value="1">1 - Ledig ohne Kind</option>
                                    <option value="2">2 - Alleinerziehend</option>
                                    <option value="3">3 - Verheiratet (Alleinverdiener)</option>
                                    <option value="4">4 - Verheiratet (beide verdienen)</option>
                                    <option value="5">5 - Verheiratet (Zweitverdiener)</option>
                                    <option value="6">6 - Zweitjob</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>‚õ™ Kirchensteuer</label>
                                <select id="editKirchensteuer">
                                    <option value="keine">Keine</option>
                                    <option value="ev">Evangelisch</option>
                                    <option value="kath">Katholisch</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>üÜî Steuer-ID (11-stellig)</label>
                                <input type="text" id="editSteuerID" maxlength="11" pattern="[0-9]{11}" placeholder="12345678901">
                            </div>
                            <div class="form-group">
                                <label>üë∂ Kinderfreibetr√§ge</label>
                                <select id="editKinderfreibetraege">
                                    <option value="0">0</option>
                                    <option value="0.5">0,5</option>
                                    <option value="1">1</option>
                                    <option value="1.5">1,5</option>
                                    <option value="2">2</option>
                                    <option value="2.5">2,5</option>
                                    <option value="3">3</option>
                                    <option value="3.5">3,5</option>
                                    <option value="4">4+</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>üó∫Ô∏è Bundesland</label>
                            <select id="editBundesland">
                                <option value="BW">Baden-W√ºrttemberg (8%)</option>
                                <option value="BY">Bayern (8%)</option>
                                <option value="BE">Berlin (9%)</option>
                                <option value="BB">Brandenburg (9%)</option>
                                <option value="HB">Bremen (9%)</option>
                                <option value="HH">Hamburg (9%)</option>
                                <option value="HE">Hessen (9%)</option>
                                <option value="MV">Mecklenburg-Vorpommern (9%)</option>
                                <option value="NI">Niedersachsen (9%)</option>
                                <option value="NW">Nordrhein-Westfalen (9%)</option>
                                <option value="RP">Rheinland-Pfalz (9%)</option>
                                <option value="SL">Saarland (9%)</option>
                                <option value="SN">Sachsen (9%)</option>
                                <option value="ST">Sachsen-Anhalt (9%)</option>
                                <option value="SH">Schleswig-Holstein (9%)</option>
                                <option value="TH">Th√ºringen (9%)</option>
                            </select>
                        </div>
                    </div> <!-- End Tab 2: Lohn & Steuer -->

                    <!-- ===================== TAB 3: SOZIALVERSICHERUNG ===================== -->
                    <div id="editTab-sozialversicherung" class="modal-tab-content">
                        <div class="tab-info-box">
                            üè• Sozialversicherungsdaten f√ºr KV, RV, AV, PV Berechnung.
                        </div>

                        <div class="section-header">üìã SV-Status</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>üìã Besch√§ftigungsart</label>
                                <select id="editSvStatus" onchange="toggleSvFelder()">
                                    <option value="normal">Regul√§r (volle SV)</option>
                                    <option value="minijob">Minijob (bis 538‚Ç¨)</option>
                                    <option value="midijob">Midijob (538-2.000‚Ç¨)</option>
                                    <option value="werkstudent">Werkstudent</option>
                                    <option value="rentner">Rentner</option>
                                    <option value="befreit">Befreit</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>üÜî SV-Nummer</label>
                                <input type="text" id="editSvNummer" placeholder="12 010190 M 123">
                            </div>
                        </div>

                        <div class="section-header">üè• Krankenversicherung</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>üìã KV-Art</label>
                                <select id="editKrankenversicherung" onchange="toggleKvFelder()">
                                    <option value="gkv">Gesetzlich (GKV)</option>
                                    <option value="pkv">Privat (PKV)</option>
                                </select>
                            </div>
                            <div class="form-group" id="editKrankenkasseGroup">
                                <label>üè• Krankenkasse</label>
                                <input type="text" id="editKrankenkasseName" placeholder="z.B. AOK, TK, Barmer...">
                            </div>
                        </div>
                        <div class="form-row" id="editGkvGroup">
                            <div class="form-group">
                                <label>üìä KV-Zusatzbeitrag (%)</label>
                                <input type="number" id="editKvZusatzbeitrag" value="1.7" step="0.1" min="0" max="5">
                            </div>
                        </div>
                        <div class="form-row" id="editPkvGroup" style="display:none;">
                            <div class="form-group">
                                <label>üíµ PKV-Beitrag (mtl.)</label>
                                <input type="number" id="editPkvBeitrag" step="0.01" min="0" placeholder="0.00">
                            </div>
                            <div class="form-group">
                                <label>üíº AG-Zuschuss PKV</label>
                                <input type="number" id="editAgZuschussPKV" step="0.01" min="0" placeholder="0.00">
                            </div>
                        </div>

                        <div class="section-header">üë∂ Pflegeversicherung</div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="editKinderlos" style="width: auto;">
                                Kinderlos (ab 23 Jahre) ‚Üí +0,6% PV-Zuschlag
                            </label>
                        </div>

                        <div class="form-group">
                            <label>üéÇ Geburtsdatum</label>
                            <input type="date" id="editGeburtsdatum">
                        </div>
                    </div> <!-- End Tab 3: Sozialversicherung -->

                    <!-- ===================== TAB 4: BANKVERBINDUNG ===================== -->
                    <div id="editTab-bank" class="modal-tab-content">
                        <div class="tab-info-box">
                            üè¶ Bankdaten f√ºr die Gehalts√ºberweisung.
                        </div>

                        <div class="section-header">üè¶ Bankverbindung</div>
                        <div class="form-group">
                            <label>üè¶ IBAN</label>
                            <input type="text" id="editIban" placeholder="DE89 3704 0044 0532 0130 00" maxlength="27">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>üî¢ BIC</label>
                                <input type="text" id="editBic" placeholder="COBADEFFXXX" maxlength="11">
                            </div>
                            <div class="form-group">
                                <label>üèõÔ∏è Bank</label>
                                <input type="text" id="editBankName" placeholder="z.B. Commerzbank">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>üë§ Kontoinhaber (falls abweichend)</label>
                            <input type="text" id="editKontoinhaber" placeholder="Leer = Mitarbeitername">
                        </div>
                    </div> <!-- End Tab 4: Bankverbindung -->

                    <!-- Buttons -->
                    <div style="display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap;">
                        <button type="button" onclick="erstelleLohnabrechnungFuerMitarbeiter()" class="btn" style="background: linear-gradient(135deg, #27ae60, #2ecc71); color: white;">
                            üí∞ Lohnabrechnung
                        </button>
                        <button type="button" onclick="deleteMitarbeiter()" class="btn btn-danger">
                            üóëÔ∏è L√∂schen
                        </button>
                        <button type="button" onclick="closeEditModal()" class="btn" style="background: rgba(255,255,255,0.1); color: var(--color-text-primary);">
                            Abbrechen
                        </button>
                        <button type="submit" class="btn btn-primary">
                            üíæ Speichern
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- NEW MITARBEITER MODAL -->
        <div id="newMitarbeiterModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10001; overflow-y: auto; padding: 20px;">
            <div id="newMitarbeiterModalContent" style="max-width: 700px; margin: 50px auto; background: #ffffff; border-radius: 12px; padding: 30px; box-shadow: 0 8px 32px rgba(0,0,0,0.4);">
                <!-- Modal Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: var(--color-text-primary); margin: 0;">‚ûï Neuer Mitarbeiter</h2>
                    <button onclick="closeNewMitarbeiterModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--color-text-secondary);">‚úï</button>
                </div>

                <!-- Form -->
                <form id="newMitarbeiterForm" onsubmit="createNewMitarbeiter(event); return false;">
                    <!-- Name -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; color: var(--color-text-primary);">üë§ Name</label>
                        <input type="text" id="newName" required style="width: 100%; padding: 10px; border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: var(--color-text-primary); font-size: 14px;" placeholder="z.B. Max Mustermann">
                    </div>

                    <!-- Password -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; color: var(--color-text-primary);">üîë Passwort</label>
                        <input type="password" id="newPassword" required style="width: 100%; padding: 10px; border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: var(--color-text-primary); font-size: 14px;" placeholder="Mindestens 4 Zeichen" minlength="4">
                    </div>

                    <!-- Rolle -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; color: var(--color-text-primary);">üëî Rolle</label>
                        <select id="newRolle" required style="width: 100%; padding: 10px; border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: var(--color-text-primary); font-size: 14px; cursor: pointer;">
                            <option value="">Bitte w√§hlen...</option>
                            <option value="Lehrling">Lehrling</option>
                            <option value="Azubi">Azubi</option>
                            <option value="Geselle">Geselle</option>
                            <option value="Meister">Meister</option>
                            <option value="Lackierer">Lackierer</option>
                            <option value="Karosseriebauer">Karosseriebauer</option>
                            <option value="Mechaniker">Mechaniker</option>
                            <option value="Servicetechniker">Servicetechniker</option>
                            <option value="B√ºrokraft">B√ºrokraft</option>
                            <option value="Werkstattleiter">Werkstattleiter</option>
                            <option value="Sonstige">Sonstige</option>
                        </select>
                    </div>

                    <!-- Urlaubstage pro Jahr -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 5px; color: var(--color-text-primary);">üèñÔ∏è Urlaubstage pro Jahr</label>
                        <input type="number" id="newUrlaubstageJahr" value="30" min="0" max="50" required style="width: 100%; padding: 10px; border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: var(--color-text-primary); font-size: 14px;">
                    </div>

                    <!-- Berechtigungen (17 Kacheln) - iOS Toggle Style -->
                    <div style="margin-bottom: 20px; padding: 20px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                        <div style="display: block; font-weight: 600; margin-bottom: 15px; color: var(--color-text-primary); font-size: 16px;">üîê Berechtigungen f√ºr Kacheln</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <!-- Same 14 checkboxes as edit modal, but with "new" prefix -->
                            <div>
                                <input type="checkbox" id="newAnnahme" class="permission-checkbox">
                                <label for="newAnnahme" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üöó Annahme</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="newAbnahme" class="permission-checkbox">
                                <label for="newAbnahme" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">‚úÖ Abnahme</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="newListe" class="permission-checkbox">
                                <label for="newListe" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üìã √úbersicht</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="newKanban" class="permission-checkbox">
                                <label for="newKanban" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üìä Kanban</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="newKunden" class="permission-checkbox">
                                <label for="newKunden" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üë• Kunden</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="newKalender" class="permission-checkbox">
                                <label for="newKalender" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üìÖ Kalender</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="newMaterial" class="permission-checkbox">
                                <label for="newMaterial" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üì¶ Material</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="newPartnerAnfragen" class="permission-checkbox">
                                <label for="newPartnerAnfragen" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üìß Partner-Anfragen</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="newPartnerPortal" class="permission-checkbox">
                                <label for="newPartnerPortal" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üîó Partner-Portal</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="newMitarbeiterVerwaltung" class="permission-checkbox">
                                <label for="newMitarbeiterVerwaltung" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üë§ Mitarbeiter-Verwaltung</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="newNutzerVerwaltung" class="permission-checkbox">
                                <label for="newNutzerVerwaltung" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üë• User-Verwaltung</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="newRegistrierung" class="permission-checkbox">
                                <label for="newRegistrierung" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üìù Registrierung</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="newKiChat" class="permission-checkbox">
                                <label for="newKiChat" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üí¨ KI-Chat</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="newKiSprache" class="permission-checkbox">
                                <label for="newKiSprache" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üé§ KI-Sprache</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="newDienstplan" class="permission-checkbox">
                                <label for="newDienstplan" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üìÖ Dienstplan</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="newLager" class="permission-checkbox">
                                <label for="newLager" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üì¶ Lager</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="newRechnungen" class="permission-checkbox" checked>
                                <label for="newRechnungen" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üßæ Rechnungen</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="newPreiseSichtbar" class="permission-checkbox">
                                <label for="newPreiseSichtbar" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üí∞ Preise sichtbar</span>
                                </label>
                            </div>
                            <div>
                                <input type="checkbox" id="newBestellungenVerwalten" class="permission-checkbox">
                                <label for="newBestellungenVerwalten" class="permission-label">
                                    <div class="toggle-switch">
                                        <div class="toggle-slider"></div>
                                    </div>
                                    <span class="permission-text">üì¶ Bestellungen verwalten</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" onclick="closeNewMitarbeiterModal()" class="btn" style="background: rgba(255,255,255,0.1); color: var(--color-text-primary);">
                            Abbrechen
                        </button>
                        <button type="submit" class="btn btn-success">
                            ‚ûï Erstellen
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- STUNDENABRECHNUNG PDF MODAL -->
    <div id="stundenabrechnungModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10001; overflow-y: auto; padding: 20px;">
        <div style="max-width: 600px; margin: 50px auto; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 30px; box-shadow: 0 8px 32px rgba(0,0,0,0.4);">
            <h2 style="color: white; margin: 0 0 20px 0; font-size: 24px;">üìÑ Stundenabrechnung PDF</h2>

            <input type="hidden" id="pdfMitarbeiterId">

            <div style="margin-bottom: 20px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">
                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: rgba(255,255,255,0.8); font-size: 13px;">Mitarbeiter:</label>
                <div id="pdfMitarbeiterName" style="font-size: 20px; color: white; font-weight: 600;"></div>
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: white;">üìÖ Von Datum:</label>
                <input type="date" id="pdfStartDatum" required style="width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 14px; background: rgba(255,255,255,0.95);">
            </div>

            <div style="margin-bottom: 25px;">
                <label style="display: block; font-weight: 600; margin-bottom: 5px; color: white;">üìÖ Bis Datum:</label>
                <input type="date" id="pdfEndDatum" required style="width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 14px; background: rgba(255,255,255,0.95);">
            </div>

            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="generatePreviewPDF()" class="btn btn-primary" style="flex: 1; min-width: 140px; padding: 12px; font-size: 13px;">
                    üìÑ Vorschau<br><small style="opacity: 0.8; font-size: 10px;">(ohne Unterschrift)</small>
                </button>
                <button onclick="openAnnotationsModal()" class="btn" style="flex: 1; min-width: 140px; padding: 12px; font-size: 13px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none;">
                    üí¨ Anmerkungen<br><small style="opacity: 0.8; font-size: 10px;">(Fehler melden)</small>
                </button>
                <button onclick="generateStundenabrechnungPDF()" class="btn btn-success" style="flex: 1; min-width: 140px; padding: 12px; font-size: 13px;">
                    ‚úçÔ∏è Signieren<br><small style="opacity: 0.8; font-size: 10px;">(mit Unterschrift)</small>
                </button>
                <button onclick="closeStundenabrechnungModal()" class="btn" style="flex: 1; min-width: 140px; padding: 12px; font-size: 13px; background: rgba(255,255,255,0.2); color: white; border: none;">
                    ‚ùå Abbrechen
                </button>
            </div>
        </div>
    </div>

    <!-- SIGNATURE CANVAS MODAL -->
    <div id="signatureModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10002; overflow-y: auto; padding: 20px;">
        <div style="max-width: 550px; margin: 50px auto; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: 12px; padding: 30px; box-shadow: 0 8px 32px rgba(0,0,0,0.5);">
            <h2 style="color: white; margin: 0 0 15px 0; font-size: 24px;">‚úçÔ∏è Digitale Unterschrift</h2>
            <p style="color: rgba(255,255,255,0.9); margin-bottom: 20px; font-size: 14px;">
                Unterschreiben Sie mit der Maus oder per Touch auf dem Canvas
            </p>

            <div style="background: white; border-radius: 8px; padding: 10px; margin-bottom: 20px;">
                <canvas id="signatureCanvas" width="500" height="200" style="border: 2px dashed #ddd; border-radius: 6px; cursor: crosshair; display: block; touch-action: none;"></canvas>
            </div>

            <div style="display: flex; gap: 10px;">
                <button onclick="clearSignature()" class="btn" style="flex: 1; padding: 12px; font-size: 14px; background: rgba(255,255,255,0.2); color: white; border: none;">
                    üóëÔ∏è L√∂schen
                </button>
                <button onclick="cancelSignature()" class="btn" style="flex: 1; padding: 12px; font-size: 14px; background: rgba(255,255,255,0.2); color: white; border: none;">
                    ‚ùå Abbrechen
                </button>
                <button onclick="saveSignature()" class="btn btn-success" style="flex: 1; padding: 12px; font-size: 14px;">
                    ‚úÖ √úbernehmen
                </button>
            </div>
        </div>
    </div>

    <!-- ANNOTATIONS MODAL -->
    <div id="annotationsModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 10002; overflow-y: auto; padding: 20px;">
        <div style="max-width: 650px; margin: 50px auto; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 12px; padding: 30px; box-shadow: 0 8px 32px rgba(0,0,0,0.5);">
            <h2 style="color: white; margin: 0 0 10px 0; font-size: 24px;">üí¨ Anmerkungen hinzuf√ºgen</h2>
            <p style="color: rgba(255,255,255,0.9); margin-bottom: 20px; font-size: 14px;">
                Melden Sie Fehler in Ihrer Stundenerfassung (z.B. "3.11 - Zu wenig Stunden notiert")
            </p>

            <!-- Existing Annotations List -->
            <div id="annotationsList" style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 15px; margin-bottom: 20px; min-height: 100px; max-height: 250px; overflow-y: auto;">
                <p style="color: rgba(255,255,255,0.6); text-align: center; margin: 0;">Keine Anmerkungen hinzugef√ºgt</p>
            </div>

            <!-- Add New Annotation Form -->
            <div style="background: rgba(255,255,255,0.15); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: white; margin: 0 0 15px 0; font-size: 16px;">‚ûï Neue Anmerkung hinzuf√ºgen</h3>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; color: white; font-size: 13px;">
                        üìÖ Datum:
                    </label>
                    <input type="date" id="annotationDate" required
                           style="width: 100%; padding: 10px; border: none; border-radius: 6px; font-size: 13px;">
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; color: white; font-size: 13px;">
                        ‚ö†Ô∏è Fehlertyp:
                    </label>
                    <select id="annotationErrorType"
                            style="width: 100%; padding: 10px; border: none; border-radius: 6px; font-size: 13px;">
                        <option value="">-- Bitte w√§hlen --</option>
                        <option value="Zu wenig Stunden">Zu wenig Stunden notiert</option>
                        <option value="Zu viel Stunden">Zu viel Stunden notiert</option>
                        <option value="Falsche Schicht">Falsche Schicht eingetragen</option>
                        <option value="Fehlende Pause">Pause nicht ber√ºcksichtigt</option>
                        <option value="Falsches Datum">Falsches Datum</option>
                        <option value="Sonstiges">Sonstiges</option>
                    </select>
                </div>

                <div style="margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 5px; color: white; font-size: 13px;">
                        üìù Beschreibung:
                    </label>
                    <textarea id="annotationDescription" placeholder="z.B. Sollten 8 Stunden sein, aber nur 6 erfasst"
                              style="width: 100%; padding: 10px; border: none; border-radius: 6px; font-size: 13px; min-height: 70px; font-family: inherit; resize: vertical;"></textarea>
                </div>

                <button onclick="addAnnotation()" class="btn btn-success"
                        style="width: 100%; padding: 12px; font-size: 14px; margin-bottom: 0;">
                    ‚ûï Anmerkung hinzuf√ºgen
                </button>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; gap: 10px;">
                <button onclick="cancelAnnotations()" class="btn"
                        style="flex: 1; padding: 12px; font-size: 14px; background: rgba(255,255,255,0.2); color: white; border: none;">
                    ‚ùå Abbrechen
                </button>
                <button onclick="saveAnnotations()" class="btn btn-success"
                        style="flex: 1; padding: 12px; font-size: 14px;">
                    ‚úÖ Speichern & Zur√ºck
                </button>
            </div>
        </div>
    </div>

    <!-- EDIT ZEIT MODAL -->
    <div id="editZeitModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10003; overflow-y: auto; padding: 20px;">
        <div style="max-width: 700px; margin: 50px auto; background: #ffffff; border-radius: 12px; padding: 30px; box-shadow: 0 8px 32px rgba(0,0,0,0.4);">
            <!-- Modal Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div>
                    <h2 style="color: var(--color-text-primary); margin: 0 0 5px 0;">‚è±Ô∏è Zeiterfassung bearbeiten</h2>
                    <p style="color: var(--color-text-secondary); font-size: 13px; margin: 0;">
                        ‚ö†Ô∏è Korrigiere falsch gestempelte Zeiten. Bearbeitete Eintr√§ge werden mit * markiert.
                    </p>
                </div>
                <button onclick="closeEditZeitModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--color-text-secondary);">‚úï</button>
            </div>

            <!-- Info Box -->
            <div id="editZeitInfo" style="background: rgba(10, 132, 255, 0.1); border-left: 4px solid var(--color-primary); padding: 15px; border-radius: 6px; margin-bottom: 20px;">
                <p style="margin: 0; color: var(--color-text-primary); font-size: 13px;">
                    <strong>Mitarbeiter:</strong> <span id="editZeitMitarbeiterName">-</span><br>
                    <strong>Datum:</strong> <span id="editZeitDatum">-</span><br>
                    <strong>Stunden:</strong> <span id="editZeitStunden">-</span>h
                </p>
            </div>

            <!-- Events Form -->
            <div style="margin-bottom: 20px;">
                <h3 style="color: var(--color-text-primary); margin: 0 0 15px 0; font-size: 16px;">‚è±Ô∏è Uhrzeiten bearbeiten</h3>

                <!-- Start Event -->
                <div style="background: rgba(52, 199, 89, 0.1); border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--color-text-primary);">
                        ‚ñ∂Ô∏è Arbeitsbeginn
                    </label>
                    <input type="time" id="editZeitStart" required
                           style="width: 100%; padding: 10px; border: 2px solid rgba(52, 199, 89, 0.3); border-radius: 6px; font-size: 14px;">
                </div>

                <!-- Pause Events -->
                <div id="editZeitPausenContainer" style="margin-bottom: 15px;">
                    <!-- Dynamically filled with pause pairs -->
                </div>

                <!-- End Event -->
                <div style="background: rgba(255, 59, 48, 0.1); border-radius: 8px; padding: 15px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--color-text-primary);">
                        ‚èπÔ∏è Feierabend
                    </label>
                    <input type="time" id="editZeitEnd"
                           style="width: 100%; padding: 10px; border: 2px solid rgba(255, 59, 48, 0.3); border-radius: 6px; font-size: 14px;">
                    <p style="margin: 8px 0 0 0; color: var(--color-text-secondary); font-size: 12px;">
                        ‚ÑπÔ∏è Leer lassen, falls noch nicht abgeschlossen
                    </p>
                </div>
            </div>

            <!-- Action Buttons -->
            <div style="display: flex; gap: 10px;">
                <button onclick="closeEditZeitModal()" class="btn btn-secondary" style="flex: 1;">
                    ‚ùå Abbrechen
                </button>
                <button onclick="saveEditZeit()" class="btn btn-success" style="flex: 1;">
                    ‚úÖ Speichern
                </button>
            </div>
        </div>
    </div>

    <!-- Initialize Feather Icons -->
    <script>
        feather.replace();
    </script>

    <!-- Theme Toggle Logic -->
    <script>
        (function initThemeToggle() {
            const themeToggle = document.getElementById('themeToggle');
            const html = document.documentElement;

            // Initialize theme (default: light)
            let currentTheme = localStorage.getItem('theme') || 'light';
            html.setAttribute('data-theme', currentTheme);
            console.log(`üåì Theme initialized: ${currentTheme}`);

            // Toggle theme on button click
            themeToggle.addEventListener('click', () => {
                currentTheme = currentTheme === 'light' ? 'dark' : 'light';
                html.setAttribute('data-theme', currentTheme);
                localStorage.setItem('theme', currentTheme);

                console.log(`üåì Theme switched to: ${currentTheme}`);

                // Re-initialize Feather Icons for theme change
                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
            });

            console.log('‚úÖ Theme Toggle initialized');
        })();
    </script>

    <!-- üÜï Phase 2.1: Urlaub Ablehnen Modal -->
    <div id="rejectVacationModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 100003; padding: 20px; overflow-y: auto;">
        <div style="max-width: 500px; margin: 100px auto; background: var(--color-surface); border-radius: 16px; padding: 40px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); backdrop-filter: blur(25px);">
            <!-- Header -->
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, #ff3b30, #dc143c); border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 40px;">
                    ‚ùå
                </div>
                <h2 style="color: var(--color-text-primary); margin: 0 0 10px 0; font-size: 24px; font-weight: 700;">Urlaub ablehnen</h2>
                <p id="rejectVacationInfo" style="color: var(--color-text-secondary); margin: 0; font-size: 14px;"></p>
            </div>

            <!-- Form -->
            <div style="display: flex; flex-direction: column; gap: 20px;">
                <!-- Ablehnungsgrund -->
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--color-text-primary);">üìù Ablehnungsgrund</label>
                    <textarea id="ablehnungsgrund" rows="4" required placeholder="Bitte gib einen Grund f√ºr die Ablehnung ein..." style="width: 100%; padding: 12px; border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: var(--color-text-primary); font-size: 14px; resize: vertical;"></textarea>
                </div>

                <!-- Buttons -->
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" onclick="closeRejectVacationModal()" style="padding: 14px 28px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; color: var(--color-text-primary); font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        Abbrechen
                    </button>
                    <button type="button" id="confirmRejectBtn" onclick="confirmRejectVacation()" style="padding: 14px 28px; background: linear-gradient(135deg, #ff3b30, #dc143c); border: none; border-radius: 10px; color: white; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px;">
                        ‚ùå Ablehnen
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MULTI-TENANT MITARBEITER-VERWALTUNG -->
    <script>
        // ============================================
        // PHASE 6: MULTI-TENANT MITARBEITER-VERWALTUNG
        // ============================================

        let mitarbeiterList = [];
        let currentWerkstattId = null;
        let currentWerkstattName = null;

        // Initialize App
        async function initApp() {
            console.log('üöÄ Initialisiere Multi-Tenant Mitarbeiter-Verwaltung...');

            // Wait for Firebase + Auth Manager
            await window.initFirebase();

            if (!window.firebaseInitialized || !window.authManager) {
                console.error('‚ùå Firebase oder Auth Manager nicht initialisiert!');
                showToast('‚ö†Ô∏è Fehler: Firebase konnte nicht initialisiert werden. Bitte Seite neu laden.', 'error', 6000);
                return;
            }

            // Check if user is logged in as werkstatt
            // ‚ö†Ô∏è WICHTIG: Warte auf Auth State Listener (Race Condition Fix)
            let currentUser = null;
            let attempts = 0;
            const maxAttempts = 20; // 20 * 250ms = 5 Sekunden max

            while (!currentUser && attempts < maxAttempts) {
                currentUser = window.authManager.getCurrentUser();
                if (!currentUser) {
                    console.log(`‚è≥ Warte auf Auth State Listener (Versuch ${attempts + 1}/${maxAttempts})...`);
                    await new Promise(resolve => setTimeout(resolve, 250)); // 250ms warten
                    attempts++;
                }
            }

            if (!currentUser) {
                console.error('‚ùå Auth Timeout: Kein User eingeloggt nach 5 Sekunden');
                showToast('‚ö†Ô∏è Bitte zuerst als Werkstatt einloggen!', 'warning', 3000);
                setTimeout(() => safeNavigate('index.html'), 1500);
                return;
            }

            console.log('‚úÖ Auth State erfolgreich geladen nach', attempts * 250, 'ms');

            // üÜï BUGFIX 2025-11-15 (FIX #5): Partner-Zugriff auf Werkstatt-Seiten blockieren
            // Partner d√ºrfen nur das Partner-Portal nutzen, nicht Werkstatt-Seiten
            const userRole = currentUser.rolle || currentUser.role; // Support both property names
            if (userRole === 'partner') {
                console.warn('üö´ Partner-Zugriff blockiert! Redirect zu Partner-Portal...');
                safeNavigate('./partner-app/meine-anfragen.html');
                return; // Stop further execution
            }

            currentWerkstattId = currentUser.werkstattId;
            currentWerkstattName = currentUser.werkstattName || currentUser.name;

            if (!currentWerkstattId) {
                console.error('‚ùå User hat keine werkstattId!');
                showToast('‚ö†Ô∏è Fehler: Werkstatt-ID fehlt. Bitte neu einloggen.', 'error', 3000);
                setTimeout(() => safeNavigate('index.html'), 1500);
                return;
            }

            console.log('‚úÖ Eingeloggt als Werkstatt:', currentWerkstattName);
            console.log('   WerkstattID:', currentWerkstattId);

            // Update header
            document.getElementById('werkstattName').textContent = `(${currentWerkstattName})`;

            // Load Werkstatt-Logo & Branding
            try {
                const settings = await window.settingsManager.loadSettings();
                if (settings?.profil) {
                    // Update Page Title
                    document.title = `${settings.profil.name} | Mitarbeiter-Verwaltung`;

                    // Display Logo
                    if (settings.profil.logoUrl) {
                        const logoContainer = document.getElementById('werkstattLogo');
                        if (logoContainer) {
                            logoContainer.innerHTML = `
                                <img src="${settings.profil.logoUrl}"
                                     alt="${settings.profil.name}"
                                     style="height: 32px; width: auto; vertical-align: middle;">
                            `;
                            console.log('‚úÖ [MITARBEITER-VERWALTUNG] Werkstatt-Logo angezeigt:', settings.profil.name);
                        }
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è [MITARBEITER-VERWALTUNG] Werkstatt-Branding konnte nicht geladen werden:', error);
            }

            // Load mitarbeiter (werkstatt-specific)
            await loadMitarbeiter();

            console.log('‚úÖ App erfolgreich initialisiert');
        }

        // ============================================
        // PASSWORD HASHING (SHA-256)
        // ============================================

        /**
         * DEPRECATED: hashPassword() removed in favor of Firebase Authentication.
         *
         * Password changes now use Firebase Auth updatePassword() API.
         * Migration required: /migrate-mitarbeiter-to-firebase-auth.html
         *
         * Removed: 2025-11-21 (Bug #1 Fix - Firebase Auth Migration)
         */

        // ============================================
        // LOAD MITARBEITER (WERKSTATT-SPECIFIC)
        // ============================================

        async function loadMitarbeiter() {
            console.log('üì• Lade Mitarbeiter f√ºr werkstattId:', currentWerkstattId);

            try {
                // Use window.getCollection() helper from firebase-config.js
                const mitarbeiterCollection = window.getCollection('mitarbeiter');

                console.log('   Collection:', mitarbeiterCollection._delegate._path.segments.join('/'));

                // Setup realtime listener
                mitarbeiterCollection.onSnapshot((snapshot) => {
                    mitarbeiterList = snapshot.docs
                        .filter(doc => doc.id !== '_init') // Skip init doc
                        .map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));

                    console.log(`‚úÖ ${mitarbeiterList.length} Mitarbeiter geladen (Realtime Update)`);

                    // Render table (desktop) and cards (mobile)
                    renderMitarbeiterTable();
                    renderMitarbeiterCards();
                }, (error) => {
                    console.error('‚ùå Fehler beim Laden der Mitarbeiter:', error);
                    showToast('‚ùå Fehler beim Laden der Mitarbeiter. Siehe Console f√ºr Details.', 'error', 6000);
                });

            } catch (error) {
                console.error('‚ùå Fehler beim Setup des Listeners:', error);
                showToast('‚ùå Fehler beim Setup. Siehe Console f√ºr Details.', 'error', 6000);
            }
        }

        // ============================================
        // RENDER MITARBEITER TABLE
        // ============================================

        function renderMitarbeiterTable() {
            const tbody = document.getElementById('mitarbeiterTableBody');

            if (mitarbeiterList.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11">
                            <div class="empty-state">
                                <i data-feather="users"></i>
                                <h3>Noch keine Mitarbeiter vorhanden</h3>
                                <p>Klicken Sie auf "Neuer Mitarbeiter" oder "Test-Daten (3)" um Mitarbeiter hinzuzuf√ºgen.</p>
                            </div>
                        </td>
                    </tr>
                `;
                feather.replace();
                return;
            }

            tbody.innerHTML = mitarbeiterList.map(user => {
                // Berechtigungen count (aus 14 m√∂glichen)
                const berechtigungenCount = user.berechtigungen
                    ? Object.values(user.berechtigungen).filter(v => v === true).length
                    : 0;

                // Berechtigung badge mit Farbe basierend auf Anzahl
                let badgeClass = 'badge-info';
                if (berechtigungenCount >= 10) {
                    badgeClass = 'badge-success'; // Gr√ºn f√ºr viele Berechtigungen
                } else if (berechtigungenCount >= 5) {
                    badgeClass = 'badge-warning'; // Gelb f√ºr mittlere Berechtigungen
                } else {
                    badgeClass = 'badge-danger'; // Rot f√ºr wenige Berechtigungen
                }

                // Status badge
                const statusBadge = user.status === 'active'
                    ? '<span class="badge badge-success">Aktiv</span>'
                    : '<span class="badge badge-danger">Inaktiv</span>';

                // Rolle badge mit Farbe basierend auf Rolle
                const rolle = user.rolle || 'Sonstige';
                let rolleBadgeClass = 'badge-info';
                if (rolle === 'Meister' || rolle === 'Werkstattleiter') {
                    rolleBadgeClass = 'badge-warning'; // Gold/Gelb f√ºr F√ºhrungskr√§fte
                } else if (rolle === 'Lehrling' || rolle === 'Azubi') {
                    rolleBadgeClass = 'badge-primary'; // Blau f√ºr Auszubildende
                }
                const rolleBadge = `<span class="badge ${rolleBadgeClass}">${rolle}</span>`;

                // üÜï Phase 2.1: Urlaubstage anzeigen
                const urlaubstageJahr = user.urlaubstageJahr || 30;
                const urlaubstageVerbraucht = user.urlaubstageVerbraucht || 0;
                const urlaubstageVerfuegbar = urlaubstageJahr - urlaubstageVerbraucht;

                const urlaubBadgeColor = urlaubstageVerfuegbar < 5 ? 'badge-danger' :
                                        urlaubstageVerfuegbar < 15 ? 'badge-warning' :
                                        'badge-success';

                const urlaubBadge = `<span class="badge ${urlaubBadgeColor}">${urlaubstageVerfuegbar}/${urlaubstageJahr}</span>`;

                // üÜï Krankheitstage
                const krankheitstage = user.krankheitstage || 0;
                const krankBadgeColor = krankheitstage > 10 ? 'badge-danger' :
                                        krankheitstage > 5 ? 'badge-warning' :
                                        'badge-success';
                const krankBadge = `<span class="badge ${krankBadgeColor}">${krankheitstage} Tage</span>`;

                // üÜï Gesamtstunden (Lifetime) und monatliche Stunden mit √úberstunden-Warnung
                const gesamtstunden = user.gesamtstunden || 0;
                const monatlicheStunden = user.monatlicheStunden || 0;

                // √úberstunden-Warnung: Gelb ab 160h/Monat, Rot ab 180h/Monat
                let monatlicheBadgeColor = 'badge-info'; // Blau = Normal
                if (monatlicheStunden >= 180) {
                    monatlicheBadgeColor = 'badge-danger'; // Rot = Kritische √úberstunden
                } else if (monatlicheStunden >= 160) {
                    monatlicheBadgeColor = 'badge-warning'; // Gelb/Orange = √úberstunden
                } else if (monatlicheStunden >= 120) {
                    monatlicheBadgeColor = 'badge-success'; // Gr√ºn = Gute Arbeitszeit
                }

                const stundenBadge = `<span class="badge badge-info">${gesamtstunden.toFixed(1)}h</span>`;
                const monatlicheBadge = `<span class="badge ${monatlicheBadgeColor}">${monatlicheStunden.toFixed(1)}h/Monat</span>`;

                // IST-Stunden (actual hours from Zeiterfassung)
                const istStundenGesamt = user.istStundenGesamt || 0;
                const istStundenMonatlich = user.istStundenMonatlich || 0;

                const istStundenBadge = `<span class="badge badge-info">${istStundenGesamt.toFixed(1)}h</span>`;
                const istMonatlicheBadge = `<span class="badge badge-info">${istStundenMonatlich.toFixed(1)}h/Monat</span>`;

                // Differenz (IST - SOLL) mit Farbcodierung
                const differenzGesamt = user.differenzStunden || 0;
                const differenzMonatlich = user.differenzStundenMonatlich || 0;

                // Farbe basierend auf +/- Stunden
                let differenzBadgeColor = 'badge-info'; // Blau = Neutral (0)
                if (differenzMonatlich > 0) {
                    differenzBadgeColor = 'badge-success'; // Gr√ºn = √úberstunden
                } else if (differenzMonatlich < 0) {
                    differenzBadgeColor = 'badge-danger'; // Rot = Minusstunden
                }

                const differenzPrefix = differenzMonatlich > 0 ? '+' : '';
                const differenzGesamtPrefix = differenzGesamt > 0 ? '+' : '';

                const differenzMonatlichBadge = `<span class="badge ${differenzBadgeColor}">${differenzPrefix}${differenzMonatlich.toFixed(1)}h/Monat</span>`;
                const differenzGesamtBadge = `<span class="badge ${differenzBadgeColor}">${differenzGesamtPrefix}${differenzGesamt.toFixed(1)}h</span>`;

                return `
                    <tr>
                        <td><strong>${user.name}</strong></td>
                        <td>${rolleBadge}</td>
                        <td>${urlaubBadge}</td>
                        <td>${krankBadge}</td>
                        <td>
                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                ${monatlicheBadge}
                                <small style="opacity: 0.7;">${stundenBadge} gesamt</small>
                            </div>
                        </td>
                        <td>
                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                ${istMonatlicheBadge}
                                <small style="opacity: 0.7;">${istStundenBadge} gesamt</small>
                            </div>
                        </td>
                        <td>
                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                ${differenzMonatlichBadge}
                                <small style="opacity: 0.7;">${differenzGesamtBadge} gesamt</small>
                            </div>
                        </td>
                        <td>${user.passwordHash ? '<span style="color: #34c759;">‚úÖ Gesetzt</span>' : '<span style="color: #ff4444;">‚ùå Fehlt</span>'}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <span class="badge ${badgeClass}">${berechtigungenCount}/17 Kacheln</span>
                        </td>
                        <td>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <button class="btn btn-primary" style="padding: 8px 16px; font-size: 12px;" onclick="openEditModal('${user.id}')">
                                    ‚úèÔ∏è Bearbeiten
                                </button>
                                <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 12px;" onclick="openStundenabrechnungModal('${user.id}')" title="Stundenabrechnung PDF erstellen">
                                    üìÑ PDF
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            feather.replace();
            console.log('‚úÖ Tabelle gerendert mit', mitarbeiterList.length, 'Mitarbeitern');
        }

        // ============================================
        // MOBILE CARDS RENDERING
        // ============================================
        function renderMitarbeiterCards() {
            const cardsContainer = document.getElementById('mitarbeiterCardsContainer');

            if (mitarbeiterList.length === 0) {
                cardsContainer.innerHTML = `
                    <div class="empty-state">
                        <i data-feather="users"></i>
                        <h3>Noch keine Mitarbeiter vorhanden</h3>
                        <p>Klicken Sie auf "Neuer Mitarbeiter" oder "Test-Daten (3)" um Mitarbeiter hinzuzuf√ºgen.</p>
                    </div>
                `;
                feather.replace();
                return;
            }

            cardsContainer.innerHTML = mitarbeiterList.map(user => {
                // Rolle mit Styling
                const rolle = user.rolle || 'Sonstige';
                let rolleClass = 'sonstige';
                if (rolle === 'Meister' || rolle === 'Werkstattleiter') {
                    rolleClass = 'meister';
                } else if (rolle === 'Geselle' || rolle === 'Lehrling' || rolle === 'Azubi') {
                    rolleClass = 'geselle';
                }

                // Urlaubstage
                const urlaubstageJahr = user.urlaubstageJahr || 30;
                const urlaubstageVerbraucht = user.urlaubstageVerbraucht || 0;
                const urlaubstageVerfuegbar = urlaubstageJahr - urlaubstageVerbraucht;

                // Krankheitstage
                const krankheitstage = user.krankheitstage || 0;

                // SOLL/IST Stunden
                const monatlicheStunden = user.monatlicheStunden || 0;
                const istStundenMonatlich = user.istStundenMonatlich || 0;
                const differenzMonatlich = user.differenzStundenMonatlich || 0;

                // Differenz Styling
                const differenzClass = differenzMonatlich > 0 ? 'positive' : (differenzMonatlich < 0 ? 'negative' : '');
                const differenzPrefix = differenzMonatlich > 0 ? '+' : '';

                // Status
                const statusIcon = user.status === 'active' ? '‚úÖ' : '‚è∏Ô∏è';
                const statusText = user.status === 'active' ? 'Aktiv' : 'Inaktiv';

                return `
                    <div class="employee-card">
                        <div class="employee-card-header">
                            <h3 class="employee-card-name">${user.name}</h3>
                            <span class="employee-card-role ${rolleClass}">${rolle}</span>
                        </div>

                        <div class="employee-card-stats">
                            <div class="employee-stat">
                                <div class="employee-stat-label">üèñÔ∏è Urlaub</div>
                                <div class="employee-stat-value">${urlaubstageVerfuegbar}/${urlaubstageJahr}</div>
                            </div>
                            <div class="employee-stat">
                                <div class="employee-stat-label">ü§í Krank</div>
                                <div class="employee-stat-value">${krankheitstage} Tage</div>
                            </div>
                            <div class="employee-stat">
                                <div class="employee-stat-label">‚è±Ô∏è SOLL</div>
                                <div class="employee-stat-value">${monatlicheStunden.toFixed(1)}h</div>
                            </div>
                            <div class="employee-stat">
                                <div class="employee-stat-label">‚è±Ô∏è IST</div>
                                <div class="employee-stat-value">${istStundenMonatlich.toFixed(1)}h</div>
                            </div>
                            <div class="employee-stat">
                                <div class="employee-stat-label">üìä Differenz</div>
                                <div class="employee-stat-value ${differenzClass}">${differenzPrefix}${differenzMonatlich.toFixed(1)}h</div>
                            </div>
                            <div class="employee-stat">
                                <div class="employee-stat-label">‚úÖ Status</div>
                                <div class="employee-stat-value">${statusIcon} ${statusText}</div>
                            </div>
                        </div>

                        <div class="employee-card-actions">
                            <button class="btn btn-primary" onclick="openEditModal('${user.id}')">
                                ‚úèÔ∏è Bearbeiten
                            </button>
                            <button class="btn btn-secondary" onclick="openStundenabrechnungModal('${user.id}')">
                                üìÑ PDF
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            feather.replace();
            console.log('‚úÖ Mobile Cards gerendert mit', mitarbeiterList.length, 'Mitarbeitern');
        }

        // ============================================
        // MODAL FUNCTIONS
        // ============================================

        // ============================================
        // TAB SWITCHING & CONDITIONAL FIELDS
        // ============================================

        function switchEditTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.modal-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            // Deactivate all tab buttons
            document.querySelectorAll('.modal-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            // Show selected tab
            const selectedTab = document.getElementById('editTab-' + tabName);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            // Activate the clicked button
            event.target.classList.add('active');
            console.log('üìë Tab gewechselt zu:', tabName);
        }

        function toggleVerguetungsFelder() {
            const art = document.getElementById('editVerguetungsart').value;
            const stundenlohnGroup = document.getElementById('editStundenlohnGroup');
            const monatsgehaltGroup = document.getElementById('editMonatsgehaltGroup');

            if (art === 'stundenlohn') {
                stundenlohnGroup.style.display = 'block';
                monatsgehaltGroup.style.display = 'none';
            } else {
                stundenlohnGroup.style.display = 'none';
                monatsgehaltGroup.style.display = 'block';
            }
        }

        function toggleKvFelder() {
            const kv = document.getElementById('editKrankenversicherung').value;
            const gkvGroup = document.getElementById('editGkvGroup');
            const pkvGroup = document.getElementById('editPkvGroup');

            if (kv === 'gkv') {
                gkvGroup.style.display = 'flex';
                pkvGroup.style.display = 'none';
            } else {
                gkvGroup.style.display = 'none';
                pkvGroup.style.display = 'flex';
            }
        }

        function toggleSvFelder() {
            const status = document.getElementById('editSvStatus').value;
            // Show/hide fields based on SV status
            // Minijob: KV/RV optional, no AV/PV
            // Midijob: reduced rates
            // Werkstudent: no KV/PV
            // Rentner: no AV
            console.log('üìã SV-Status ge√§ndert zu:', status);
        }

        function openEditModal(userId) {
            const user = mitarbeiterList.find(u => String(u.id) === String(userId));
            if (!user) {
                console.error('‚ùå Mitarbeiter nicht gefunden:', userId);
                return;
            }

            console.log('üìù √ñffne Edit-Modal f√ºr:', user.name);

            // Populate form fields
            document.getElementById('editId').value = user.id;
            document.getElementById('editName').value = user.name;
            document.getElementById('editStatus').value = user.status || 'active';
            document.getElementById('editPassword').value = ''; // Never show password

            // Populate new fields
            document.getElementById('editRolle').value = user.rolle || 'Lackierer';
            document.getElementById('editUrlaubstageJahr').value = user.urlaubstageJahr || 30;

            // Populate readonly statistics
            document.getElementById('editUrlaubstageVerbraucht').textContent = user.urlaubstageVerbraucht || 0;
            document.getElementById('editKrankheitstage').textContent = user.krankheitstage || 0;
            document.getElementById('editMonatlicheStunden').textContent = (user.monatlicheStunden || 0).toFixed(2);
            document.getElementById('editGesamtstunden').textContent = (user.gesamtstunden || 0).toFixed(2);

            // Populate all checkboxes (14 berechtigungen)
            document.getElementById('editAnnahme').checked = user.berechtigungen?.annahme || false;
            document.getElementById('editAbnahme').checked = user.berechtigungen?.abnahme || false;
            document.getElementById('editListe').checked = user.berechtigungen?.liste || false;
            document.getElementById('editKanban').checked = user.berechtigungen?.kanban || false;
            document.getElementById('editKunden').checked = user.berechtigungen?.kunden || false;
            document.getElementById('editKalender').checked = user.berechtigungen?.kalender || false;
            document.getElementById('editMaterial').checked = user.berechtigungen?.material || false;
            document.getElementById('editPartnerAnfragen').checked = user.berechtigungen?.partnerAnfragen || false;
            document.getElementById('editPartnerPortal').checked = user.berechtigungen?.partnerPortal || false;
            document.getElementById('editMitarbeiterVerwaltung').checked = user.berechtigungen?.mitarbeiterVerwaltung || false;
            document.getElementById('editNutzerVerwaltung').checked = user.berechtigungen?.nutzerVerwaltung || false;
            document.getElementById('editRegistrierung').checked = user.berechtigungen?.registrierung || false;
            document.getElementById('editKiChat').checked = user.berechtigungen?.kiChat || false;
            document.getElementById('editKiSprache').checked = user.berechtigungen?.kiSprache || false;
            document.getElementById('editDienstplan').checked = user.berechtigungen?.dienstplan || false;
            document.getElementById('editLager').checked = user.berechtigungen?.lager || false;
            document.getElementById('editRechnungen').checked = user.berechtigungen?.rechnungen || false;
            document.getElementById('editPreiseSichtbar').checked = user.berechtigungen?.preiseSichtbar || false;
            document.getElementById('editBestellungenVerwalten').checked = user.berechtigungen?.bestellungenVerwalten || false;

            // ============================================
            // TAB 2: Lohn & Steuer
            // ============================================
            document.getElementById('editExternalEmail').value = user.externalEmail || '';
            document.getElementById('editVerguetungsart').value = user.verguetungsart || 'stundenlohn';
            document.getElementById('editStundenlohn').value = user.stundenlohn || '';
            document.getElementById('editMonatsgehalt').value = user.monatsgehalt || '';
            document.getElementById('editWochenarbeitsstunden').value = user.wochenarbeitsstunden || 40;
            document.getElementById('editSteuerklasse').value = user.steuerklasse || '1';
            document.getElementById('editKirchensteuer').value = user.kirchensteuer || 'keine';
            document.getElementById('editSteuerID').value = user.steuerID || '';
            document.getElementById('editKinderfreibetraege').value = user.kinderfreibetraege || '0';
            document.getElementById('editBundesland').value = user.bundesland || 'BW';
            document.getElementById('editEintrittsdatum').value = user.eintrittsdatum || '';

            // ============================================
            // TAB 3: Sozialversicherung
            // ============================================
            document.getElementById('editSvStatus').value = user.svStatus || 'normal';
            document.getElementById('editSvNummer').value = user.svNummer || '';
            document.getElementById('editKrankenversicherung').value = user.krankenversicherung || 'gkv';
            document.getElementById('editKrankenkasseName').value = user.krankenkasseName || '';
            document.getElementById('editKvZusatzbeitrag').value = user.kvZusatzbeitrag || 1.7;
            document.getElementById('editPkvBeitrag').value = user.pkvBeitrag || '';
            document.getElementById('editAgZuschussPKV').value = user.agZuschussPKV || '';
            document.getElementById('editKinderlos').checked = user.kinderlos || false;
            document.getElementById('editGeburtsdatum').value = user.geburtsdatum || '';

            // ============================================
            // TAB 4: Bankverbindung
            // ============================================
            document.getElementById('editIban').value = user.iban || '';
            document.getElementById('editBic').value = user.bic || '';
            document.getElementById('editBankName').value = user.bankName || '';
            document.getElementById('editKontoinhaber').value = user.kontoinhaber || '';

            // ============================================
            // Reset to first tab & apply conditional display
            // ============================================
            document.querySelectorAll('.modal-tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.modal-tab').forEach(btn => btn.classList.remove('active'));
            document.getElementById('editTab-stammdaten')?.classList.add('active');
            document.querySelector('.modal-tab')?.classList.add('active');

            // Apply conditional field visibility
            toggleVerguetungsFelder();
            toggleKvFelder();
            toggleSvFelder();

            // Show modal
            document.getElementById('editModal').style.display = 'block';
        }

        function closeEditModal() {
            console.log('‚ùå Schlie√üe Edit-Modal');
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('editForm').reset();
        }

        async function saveMitarbeiter(event) {
            event.preventDefault();

            // üÜï FIX (2025-11-29): Double-Click Protection
            const saveBtn = event.submitter || document.querySelector('#editForm button[type="submit"]');
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.textContent = '‚è≥ Speichert...';
            }

            const userId = document.getElementById('editId').value;
            console.log('üíæ Speichere √Ñnderungen f√ºr:', userId);

            // Check if new password was entered
            const newPassword = document.getElementById('editPassword').value;

            // Handle password change via Firebase Authentication
            if (newPassword && newPassword.trim() !== '') {
                // Get current mitarbeiter data to check migration status
                const mitarbeiterCollection = window.getCollection('mitarbeiter');
                const mitarbeiterDoc = await mitarbeiterCollection.doc(userId).get();
                const mitarbeiterData = mitarbeiterDoc.data();

                if (!mitarbeiterData.firebaseUid || !mitarbeiterData.email) {
                    showToast('‚ö†Ô∏è Mitarbeiter wurde noch nicht zu Firebase Auth migriert!\n\nBitte f√ºhren Sie zuerst die Migration durch:\n/migrate-mitarbeiter-to-firebase-auth.html', 'error', 8000);
                    return;
                }

                try {
                    console.log('üîê √Ñndere Passwort via Firebase Auth...');

                    // Update password via Firebase Admin SDK (requires Cloud Function)
                    // For now, we'll use a workaround: Force password reset
                    await mitarbeiterCollection.doc(userId).update({
                        mustResetPassword: true,
                        passwordResetRequestedAt: new Date().toISOString(),
                        passwordResetRequestedBy: window.authManager.getCurrentUser().name
                    });

                    showToast('‚ö†Ô∏è Passwort-√Ñnderung gespeichert!\n\nMitarbeiter muss sich neu einloggen und Passwort zur√ºcksetzen.', 'warning', 6000);
                    console.log('‚úÖ Password reset flag gesetzt');

                    // NOTE: For full password change without reset, deploy this Cloud Function:
                    // exports.adminUpdateMitarbeiterPassword = functions.https.onCall(async (data, context) => {
                    //   const { userId, newPassword } = data;
                    //   await admin.auth().updateUser(userId, { password: newPassword });
                    // });
                } catch (error) {
                    console.error('‚ùå Fehler beim Passwort-Update:', error);
                    showToast('‚ùå Fehler beim Passwort-Update. Siehe Console.', 'error', 5000);
                    return;
                }
            }

            const updates = {
                // ============================================
                // TAB 1: Stammdaten
                // ============================================
                name: document.getElementById('editName').value,
                status: document.getElementById('editStatus').value,
                rolle: document.getElementById('editRolle').value,
                // üÜï FIX (2025-11-29): Fallback auf 30 wenn leer (verhindert NaN)
                urlaubstageJahr: parseInt(document.getElementById('editUrlaubstageJahr').value, 10) || 30,
                eintrittsdatum: document.getElementById('editEintrittsdatum').value || null,

                // ============================================
                // TAB 2: Lohn & Steuer
                // ============================================
                externalEmail: document.getElementById('editExternalEmail').value || null,
                verguetungsart: document.getElementById('editVerguetungsart').value,
                stundenlohn: parseFloat(document.getElementById('editStundenlohn').value) || null,
                monatsgehalt: parseFloat(document.getElementById('editMonatsgehalt').value) || null,
                wochenarbeitsstunden: parseInt(document.getElementById('editWochenarbeitsstunden').value, 10) || 40,
                steuerklasse: document.getElementById('editSteuerklasse').value,
                kirchensteuer: document.getElementById('editKirchensteuer').value,
                steuerID: document.getElementById('editSteuerID').value || null,
                // üÜï FIX (2025-11-29): Als Float speichern f√ºr Lohnberechnungen
                kinderfreibetraege: parseFloat(document.getElementById('editKinderfreibetraege').value) || 0,
                bundesland: document.getElementById('editBundesland').value,

                // ============================================
                // TAB 3: Sozialversicherung
                // ============================================
                svStatus: document.getElementById('editSvStatus').value,
                svNummer: document.getElementById('editSvNummer').value || null,
                krankenversicherung: document.getElementById('editKrankenversicherung').value,
                krankenkasseName: document.getElementById('editKrankenkasseName').value || null,
                kvZusatzbeitrag: parseFloat(document.getElementById('editKvZusatzbeitrag').value) || 1.7,
                pkvBeitrag: parseFloat(document.getElementById('editPkvBeitrag').value) || null,
                agZuschussPKV: parseFloat(document.getElementById('editAgZuschussPKV').value) || null,
                kinderlos: document.getElementById('editKinderlos').checked,
                geburtsdatum: document.getElementById('editGeburtsdatum').value || null,

                // ============================================
                // TAB 4: Bankverbindung
                // ============================================
                iban: document.getElementById('editIban').value || null,
                bic: document.getElementById('editBic').value || null,
                bankName: document.getElementById('editBankName').value || null,
                kontoinhaber: document.getElementById('editKontoinhaber').value || null,

                // ============================================
                // Berechtigungen (Checkboxes)
                // ============================================
                berechtigungen: {
                    annahme: document.getElementById('editAnnahme').checked,
                    abnahme: document.getElementById('editAbnahme').checked,
                    liste: document.getElementById('editListe').checked,
                    kanban: document.getElementById('editKanban').checked,
                    kunden: document.getElementById('editKunden').checked,
                    kalender: document.getElementById('editKalender').checked,
                    material: document.getElementById('editMaterial').checked,
                    partnerAnfragen: document.getElementById('editPartnerAnfragen').checked,
                    partnerPortal: document.getElementById('editPartnerPortal').checked,
                    mitarbeiterVerwaltung: document.getElementById('editMitarbeiterVerwaltung').checked,
                    nutzerVerwaltung: document.getElementById('editNutzerVerwaltung').checked,
                    registrierung: document.getElementById('editRegistrierung').checked,
                    kiChat: document.getElementById('editKiChat').checked,
                    kiSprache: document.getElementById('editKiSprache').checked,
                    dienstplan: document.getElementById('editDienstplan').checked,
                    lager: document.getElementById('editLager').checked,
                    rechnungen: document.getElementById('editRechnungen').checked,
                    preiseSichtbar: document.getElementById('editPreiseSichtbar').checked,
                    bestellungenVerwalten: document.getElementById('editBestellungenVerwalten').checked
                },
                lastModified: new Date().toISOString()
            };

            // Password is now handled separately via Firebase Auth (see above)
            // No more passwordHash updates in Firestore

            try {
                const mitarbeiterCollection = window.getCollection('mitarbeiter');
                await mitarbeiterCollection.doc(userId).update(updates);
                console.log('‚úÖ Mitarbeiter erfolgreich aktualisiert:', userId);

                // Close modal (realtime listener will update table)
                closeEditModal();

                showToast('‚úÖ √Ñnderungen erfolgreich gespeichert!', 'success', 4000);
            } catch (error) {
                console.error('‚ùå Fehler beim Speichern:', error);
                showToast('‚ùå Fehler beim Speichern. Siehe Console f√ºr Details.', 'error', 5000);
            } finally {
                // üÜï FIX (2025-11-29): Re-enable button after save attempt
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'üíæ Speichern';
                }
            }
        }

        // ============================================
        // LOHNABRECHNUNG FUNCTIONS
        // ============================================

        /**
         * Erstellt Lohnabrechnung f√ºr den aktuell ge√∂ffneten Mitarbeiter
         * √ñffnet einen Auswahl-Dialog f√ºr Monat/Jahr
         */
        async function erstelleLohnabrechnungFuerMitarbeiter() {
            const userId = document.getElementById('editId').value;
            const user = mitarbeiterList.find(u => String(u.id) === String(userId));

            if (!user) {
                showToast('‚ùå Mitarbeiter nicht gefunden!', 'error', 3000);
                return;
            }

            // Pr√ºfen ob Lohnberechnung-Modul geladen ist
            if (!window.Lohnberechnung || !window.LohnabrechnungPDF) {
                showToast('‚ùå Lohnabrechnung-Module nicht geladen! Bitte Seite neu laden.', 'error', 5000);
                return;
            }

            // Pr√ºfen ob notwendige Daten vorhanden sind
            if (!user.stundenlohn && !user.monatsgehalt) {
                showToast('‚ö†Ô∏è Bitte erst Verg√ºtung (Stundenlohn/Monatsgehalt) im Tab "Lohn & Steuer" eintragen!', 'warning', 5000);
                switchEditTab('lohn');
                return;
            }

            // Monat/Jahr Auswahl
            const heute = new Date();
            const aktuellerMonat = heute.getMonth() + 1;
            const aktuellesJahr = heute.getFullYear();

            // Simple Prompt f√ºr Monat (sp√§ter kann ein Modal erstellt werden)
            const monatInput = prompt(
                `F√ºr welchen Monat soll die Lohnabrechnung erstellt werden?\n\n` +
                `Format: MM/YYYY (z.B. ${String(aktuellerMonat).padStart(2, '0')}/${aktuellesJahr})\n\n` +
                `Leer lassen f√ºr aktuellen Monat:`,
                `${String(aktuellerMonat).padStart(2, '0')}/${aktuellesJahr}`
            );

            if (monatInput === null) return; // Abgebrochen

            let monat, jahr;
            if (monatInput.trim() === '') {
                monat = aktuellerMonat;
                jahr = aktuellesJahr;
            } else {
                const parts = monatInput.split('/');
                monat = parseInt(parts[0], 10);
                jahr = parseInt(parts[1], 10);

                if (isNaN(monat) || isNaN(jahr) || monat < 1 || monat > 12) {
                    showToast('‚ùå Ung√ºltiges Format! Bitte MM/YYYY eingeben.', 'error', 3000);
                    return;
                }
            }

            showToast(`üí∞ Berechne Lohnabrechnung f√ºr ${user.name}...`, 'info', 2000);

            try {
                // 1. Zeiterfassung f√ºr den Monat laden (optional)
                let zeiterfassung = null;
                try {
                    const zeiterfassungCollection = window.getCollection('zeiterfassung');
                    const startDatum = `${jahr}-${String(monat).padStart(2, '0')}-01`;
                    const endDatum = monat === 12
                        ? `${jahr + 1}-01-01`
                        : `${jahr}-${String(monat + 1).padStart(2, '0')}-01`;

                    const zeitSnapshot = await zeiterfassungCollection
                        .where('mitarbeiterId', '==', userId)
                        .where('datum', '>=', startDatum)
                        .where('datum', '<', endDatum)
                        .get();

                    if (!zeitSnapshot.empty) {
                        let gesamtStunden = 0;
                        zeitSnapshot.forEach(doc => {
                            const data = doc.data();
                            gesamtStunden += parseFloat(data.stunden) || 0;
                        });
                        zeiterfassung = { gesamtStunden };
                        console.log(`üìä Zeiterfassung geladen: ${gesamtStunden} Stunden`);
                    }
                } catch (zeitError) {
                    console.warn('‚ö†Ô∏è Zeiterfassung konnte nicht geladen werden:', zeitError);
                }

                // 2. Lohnabrechnung berechnen
                const abrechnung = await window.Lohnberechnung.berechne(user, monat, jahr, zeiterfassung);

                // 3. Werkstatt-Daten laden
                let werkstatt = {
                    name: 'Auto-Lackierzentrum Mosbach',
                    strasse: 'Pfalzgraf-Otto-Str. 34',
                    plz: '74821',
                    ort: 'Mosbach',
                    telefon: '06261-8929866'
                };

                try {
                    // Multi-Tenant Helper f√ºr konsistenten Collection-Zugriff
                    const settingsDoc = await window.getCollection('einstellungen').doc('config').get();
                    if (settingsDoc.exists && settingsDoc.data()?.profil) {
                        const profil = settingsDoc.data().profil;
                        werkstatt = {
                            name: profil.name || werkstatt.name,
                            strasse: profil.strasse || werkstatt.strasse,
                            plz: profil.plz || werkstatt.plz,
                            ort: profil.ort || werkstatt.ort,
                            telefon: profil.telefon || werkstatt.telefon
                        };
                    }
                } catch (e) {
                    console.warn('‚ö†Ô∏è Werkstatt-Einstellungen nicht gefunden, nutze Defaults');
                }

                // 4. PDF generieren und √∂ffnen
                await window.LohnabrechnungPDF.oeffnen(abrechnung, werkstatt);

                // 5. Abrechnung in Firestore speichern
                const lohnabrechnungenCollection = window.getCollection('lohnabrechnungen');
                const docId = `${userId}_${jahr}_${String(monat).padStart(2, '0')}`;

                await lohnabrechnungenCollection.doc(docId).set({
                    ...abrechnung,
                    werkstattId: window.werkstattId,
                    createdAt: new Date().toISOString(),
                    createdBy: window.authManager?.getCurrentUser()?.name || 'System'
                });

                showToast(`‚úÖ Lohnabrechnung f√ºr ${window.LohnabrechnungPDF.MONATSNAMEN[monat - 1]} ${jahr} erstellt!`, 'success', 4000);

                console.log('‚úÖ Lohnabrechnung erstellt und gespeichert:', docId);

            } catch (error) {
                console.error('‚ùå Fehler bei Lohnabrechnung:', error);
                showToast(`‚ùå Fehler: ${error.message}`, 'error', 5000);
            }
        }

        async function deleteMitarbeiter() {
            const userId = document.getElementById('editId').value;
            const userName = document.getElementById('editName').value;

            if (window.DEBUG) console.log('üîç Pr√ºfe Schichten f√ºr Mitarbeiter:', userId);

            try {
                // 1. Z√§hle Schichten des Mitarbeiters
                const schichtenCollection = window.getCollection('schichten');
                const schichtenSnapshot = await schichtenCollection
                    .where('mitarbeiterId', '==', userId)
                    .get();

                const schichtenCount = schichtenSnapshot.size;

                // 2. Erweiterte Best√§tigung mit Schicht-Warnung
                let confirmMessage = `‚ö†Ô∏è Mitarbeiter "${userName}" wirklich l√∂schen?\n\n`;

                if (schichtenCount > 0) {
                    confirmMessage += `üóìÔ∏è ACHTUNG: ${schichtenCount} Schicht(en) werden ebenfalls gel√∂scht!\n\n`;
                }

                confirmMessage += `Dieser Vorgang kann nicht r√ºckg√§ngig gemacht werden!`;

                if (!confirm(confirmMessage)) {
                    return;
                }

                console.log(`üóëÔ∏è L√∂sche Mitarbeiter: ${userId} (${schichtenCount} Schichten)`);

                // 3. CASCADE DELETE: Alle Schichten des Mitarbeiters l√∂schen
                const batch = db.batch();

                // Batch-Splitting f√ºr viele Schichten (max 500 ops pro Batch)
                const batchSize = 500;
                const schichtenDocs = schichtenSnapshot.docs;

                for (let i = 0; i < schichtenDocs.length; i += batchSize) {
                    const currentBatch = i === 0 ? batch : db.batch();
                    const chunk = schichtenDocs.slice(i, Math.min(i + batchSize, schichtenDocs.length));

                    chunk.forEach(doc => {
                        currentBatch.delete(doc.ref);
                    });

                    // Mitarbeiter nur im letzten Batch l√∂schen
                    if (i + batchSize >= schichtenDocs.length) {
                        const mitarbeiterCollection = window.getCollection('mitarbeiter');
                        currentBatch.delete(mitarbeiterCollection.doc(userId));
                    }

                    await currentBatch.commit();
                }

                // Falls keine Schichten: Mitarbeiter direkt l√∂schen
                if (schichtenCount === 0) {
                    const mitarbeiterCollection = window.getCollection('mitarbeiter');
                    await mitarbeiterCollection.doc(userId).delete();
                }

                console.log(`‚úÖ Mitarbeiter + ${schichtenCount} Schichten erfolgreich gel√∂scht`);

                // Close modal (realtime listener will update table)
                closeEditModal();

                const successMsg = schichtenCount > 0
                    ? `‚úÖ Mitarbeiter "${userName}" und ${schichtenCount} Schicht(en) erfolgreich gel√∂scht!`
                    : `‚úÖ Mitarbeiter "${userName}" erfolgreich gel√∂scht!`;

                showToast(successMsg, 'success', 4000);

            } catch (error) {
                console.error('‚ùå Fehler beim L√∂schen:', error);
                showToast('‚ùå Fehler beim L√∂schen: ' + error.message, 'error', 5000);
            }
        }

        // ============================================
        // NEW MITARBEITER MODAL
        // ============================================

        function openNewMitarbeiterModal() {
            console.log('‚ûï √ñffne Neuer-Mitarbeiter Modal');

            // Set default permission: Dienstplan should be checked by default
            document.getElementById('newDienstplan').checked = true;

            document.getElementById('newMitarbeiterModal').style.display = 'block';
        }

        function closeNewMitarbeiterModal() {
            console.log('‚ùå Schlie√üe Neuer-Mitarbeiter Modal');
            document.getElementById('newMitarbeiterModal').style.display = 'none';
            document.getElementById('newMitarbeiterForm').reset();
        }

        async function createNewMitarbeiter(event) {
            event.preventDefault();

            // üÜï FIX (2025-11-29): Double-Click Protection
            const createBtn = event.submitter || document.querySelector('#newMitarbeiterForm button[type="submit"]');
            if (createBtn) {
                createBtn.disabled = true;
                createBtn.textContent = '‚è≥ Erstellt...';
            }

            console.log('üíæ Erstelle neuen Mitarbeiter...');

            // Generate unique ID
            const userId = `user_${Date.now()}`;

            // NOTE: Password handling changed to Firebase Authentication
            // New mitarbeiter will be created WITHOUT passwordHash
            // Run /migrate-mitarbeiter-to-firebase-auth.html after creation
            const password = document.getElementById('newPassword').value;
            console.log('‚ö†Ô∏è Passwort gespeichert - Migration zu Firebase Auth erforderlich');

            const newUser = {
                name: document.getElementById('newName').value,
                passwordHash: null, // Will be set by migration script
                tempPasswordForMigration: password, // Store temporarily for migration
                status: 'active', // New users are active by default
                rolle: document.getElementById('newRolle').value, // üÜï Phase 1.1
                urlaubstageJahr: parseInt(document.getElementById('newUrlaubstageJahr').value) || 30, // üÜï Phase 1.1
                berechtigungen: {
                    annahme: document.getElementById('newAnnahme').checked,
                    abnahme: document.getElementById('newAbnahme').checked,
                    liste: document.getElementById('newListe').checked,
                    kanban: document.getElementById('newKanban').checked,
                    kunden: document.getElementById('newKunden').checked,
                    kalender: document.getElementById('newKalender').checked,
                    material: document.getElementById('newMaterial').checked,
                    partnerAnfragen: document.getElementById('newPartnerAnfragen').checked,
                    partnerPortal: document.getElementById('newPartnerPortal').checked,
                    mitarbeiterVerwaltung: document.getElementById('newMitarbeiterVerwaltung').checked,
                    nutzerVerwaltung: document.getElementById('newNutzerVerwaltung').checked,
                    registrierung: document.getElementById('newRegistrierung').checked,
                    kiChat: document.getElementById('newKiChat').checked,
                    kiSprache: document.getElementById('newKiSprache').checked,
                    dienstplan: document.getElementById('newDienstplan').checked,
                    lager: document.getElementById('newLager').checked,
                    rechnungen: document.getElementById('newRechnungen').checked,
                    preiseSichtbar: document.getElementById('newPreiseSichtbar').checked,
                    bestellungenVerwalten: document.getElementById('newBestellungenVerwalten').checked
                },
                werkstattId: currentWerkstattId, // Add werkstattId for reference
                createdAt: new Date().toISOString(),
                createdBy: currentWerkstattName,
                lastLogin: null
            };

            try {
                const mitarbeiterCollection = window.getCollection('mitarbeiter');
                await mitarbeiterCollection.doc(userId).set(newUser);
                console.log('‚úÖ Neuer Mitarbeiter erfolgreich erstellt:', newUser.name);

                // Close modal (realtime listener will update table)
                closeNewMitarbeiterModal();

                showToast(`‚úÖ Mitarbeiter "${newUser.name}" erfolgreich erstellt!`, 'success', 4000);
            } catch (error) {
                console.error('‚ùå Fehler beim Erstellen:', error);
                showToast('‚ùå Fehler beim Erstellen. Siehe Console f√ºr Details.', 'error', 5000);
            } finally {
                // üÜï FIX (2025-11-29): Re-enable button after create attempt
                if (createBtn) {
                    createBtn.disabled = false;
                    createBtn.textContent = '‚ûï Mitarbeiter erstellen';
                }
            }
        }

        // ============================================
        // STUNDENABRECHNUNG PDF EXPORT
        // ============================================

        function openStundenabrechnungModal(mitarbeiterId) {
            const mitarbeiter = mitarbeiterList.find(m => String(m.id) === String(mitarbeiterId));
            if (!mitarbeiter) {
                console.error('‚ùå Mitarbeiter nicht gefunden:', mitarbeiterId);
                return;
            }

            console.log('üìÑ √ñffne Stundenabrechnung-Modal f√ºr:', mitarbeiter.name);

            document.getElementById('pdfMitarbeiterId').value = mitarbeiterId;
            document.getElementById('pdfMitarbeiterName').textContent = mitarbeiter.name;

            // Set default date range (current month)
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);

            document.getElementById('pdfStartDatum').value = formatDate(startOfMonth, 'YYYY-MM-DD');
            document.getElementById('pdfEndDatum').value = formatDate(endOfMonth, 'YYYY-MM-DD');

            document.getElementById('stundenabrechnungModal').style.display = 'block';
        }

        function closeStundenabrechnungModal() {
            console.log('‚ùå Schlie√üe Stundenabrechnung-Modal');
            document.getElementById('stundenabrechnungModal').style.display = 'none';
        }

        // ============================================
        // SIGNATURE CANVAS LOGIC
        // ============================================

        let signatureCanvas, signatureCtx;
        let isDrawing = false;
        let signatureData = null; // Stores the signature as Base64 PNG
        let currentAnnotations = []; // Stores annotations for the PDF

        function initSignatureCanvas() {
            signatureCanvas = document.getElementById('signatureCanvas');
            signatureCtx = signatureCanvas.getContext('2d');

            // Set drawing style
            signatureCtx.strokeStyle = '#000';
            signatureCtx.lineWidth = 2;
            signatureCtx.lineCap = 'round';
            signatureCtx.lineJoin = 'round';

            // Mouse events
            signatureCanvas.addEventListener('mousedown', startDrawing);
            signatureCanvas.addEventListener('mousemove', draw);
            signatureCanvas.addEventListener('mouseup', stopDrawing);
            signatureCanvas.addEventListener('mouseleave', stopDrawing);

            // Touch events for mobile
            signatureCanvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = signatureCanvas.getBoundingClientRect();
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;
                signatureCtx.beginPath();
                signatureCtx.moveTo(x, y);
                isDrawing = true;
            });

            signatureCanvas.addEventListener('touchmove', (e) => {
                if (!isDrawing) return;
                e.preventDefault();
                const touch = e.touches[0];
                const rect = signatureCanvas.getBoundingClientRect();
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;
                signatureCtx.lineTo(x, y);
                signatureCtx.stroke();
            });

            signatureCanvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                stopDrawing();
            });
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = signatureCanvas.getBoundingClientRect();
            signatureCtx.beginPath();
            signatureCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }

        function draw(e) {
            if (!isDrawing) return;
            const rect = signatureCanvas.getBoundingClientRect();
            signatureCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            signatureCtx.stroke();
        }

        function stopDrawing() {
            isDrawing = false;
            signatureCtx.closePath();
        }

        function clearSignature() {
            signatureCtx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
            console.log('üóëÔ∏è Signature cleared');
        }

        function cancelSignature() {
            console.log('‚ùå Signature cancelled');
            signatureData = null;
            clearSignature();
            document.getElementById('signatureModal').style.display = 'none';
        }

        function saveSignature() {
            // Check if canvas is empty
            const imageData = signatureCtx.getImageData(0, 0, signatureCanvas.width, signatureCanvas.height);
            const pixels = imageData.data;
            let isEmpty = true;

            for (let i = 0; i < pixels.length; i += 4) {
                // Check alpha channel (opacity)
                if (pixels[i + 3] !== 0) {
                    isEmpty = false;
                    break;
                }
            }

            if (isEmpty) {
                alert('‚ö†Ô∏è Bitte unterschreiben Sie zuerst!');
                return;
            }

            // Save signature as Base64 PNG
            signatureData = signatureCanvas.toDataURL('image/png');
            console.log('‚úÖ Signature saved:', signatureData.substring(0, 50) + '...');

            // Close modal and proceed to PDF generation
            document.getElementById('signatureModal').style.display = 'none';

            // Now generate the PDF with signature
            actuallyGeneratePDFNew(); // Use new professional version
        }

        function openSignatureModal() {
            console.log('‚úçÔ∏è Opening signature modal');

            // Initialize canvas FIRST if not done yet
            if (!signatureCanvas) {
                initSignatureCanvas();
            }

            // Now safe to clear (signatureCtx exists)
            clearSignature();

            // Show modal
            document.getElementById('signatureModal').style.display = 'block';
        }

        // ============================================
        // ANNOTATIONS MODAL LOGIC
        // ============================================

        function openAnnotationsModal() {
            console.log('üí¨ Opening annotations modal');

            // Get date range from PDF modal
            const startDatum = document.getElementById('pdfStartDatum').value;
            const endDatum = document.getElementById('pdfEndDatum').value;

            if (!startDatum || !endDatum) {
                showToast('‚ö†Ô∏è Bitte zuerst Datumbereich ausw√§hlen', 'error', 3000);
                return;
            }

            // Set min/max for annotation date picker
            document.getElementById('annotationDate').min = startDatum;
            document.getElementById('annotationDate').max = endDatum;
            document.getElementById('annotationDate').value = startDatum; // Default to start date

            // Render existing annotations
            renderAnnotationsList();

            // Show modal
            document.getElementById('annotationsModal').style.display = 'block';
        }

        function addAnnotation() {
            const date = document.getElementById('annotationDate').value;
            const errorType = document.getElementById('annotationErrorType').value;
            const description = document.getElementById('annotationDescription').value.trim();

            // Validate inputs
            if (!date) {
                showToast('‚ö†Ô∏è Bitte Datum ausw√§hlen', 'error', 3000);
                return;
            }

            if (!errorType) {
                showToast('‚ö†Ô∏è Bitte Fehlertyp ausw√§hlen', 'error', 3000);
                return;
            }

            if (!description) {
                showToast('‚ö†Ô∏è Bitte Beschreibung eingeben', 'error', 3000);
                return;
            }

            // Add to annotations array
            currentAnnotations.push({
                date: date,
                errorType: errorType,
                description: description,
                addedAt: Date.now()
            });

            console.log('‚úÖ Annotation added:', currentAnnotations[currentAnnotations.length - 1]);

            // Clear form
            document.getElementById('annotationDate').value = document.getElementById('pdfStartDatum').value;
            document.getElementById('annotationErrorType').value = '';
            document.getElementById('annotationDescription').value = '';

            // Re-render list
            renderAnnotationsList();

            showToast('‚úÖ Anmerkung hinzugef√ºgt', 'success', 2000);
        }

        function removeAnnotation(index) {
            if (confirm('Anmerkung wirklich l√∂schen?')) {
                currentAnnotations.splice(index, 1);
                console.log('üóëÔ∏è Annotation removed at index:', index);
                renderAnnotationsList();
                showToast('‚úÖ Anmerkung gel√∂scht', 'info', 2000);
            }
        }

        function renderAnnotationsList() {
            const container = document.getElementById('annotationsList');

            if (currentAnnotations.length === 0) {
                container.innerHTML = '<p style="color: rgba(255,255,255,0.6); text-align: center; margin: 0;">Keine Anmerkungen hinzugef√ºgt</p>';
                return;
            }

            // Sort by date (oldest first)
            const sortedAnnotations = [...currentAnnotations].sort((a, b) => a.date.localeCompare(b.date));

            container.innerHTML = sortedAnnotations.map((ann, idx) => {
                const originalIndex = currentAnnotations.indexOf(ann);
                const dateObj = new Date(ann.date + 'T00:00:00'); // Force local timezone
                const dateStr = dateObj.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });

                return `
                    <div style="background: rgba(255,255,255,0.15); padding: 12px; margin-bottom: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <strong style="color: white; font-size: 14px;">üìÖ ${dateStr}</strong>
                            <div style="color: rgba(255,255,255,0.9); font-size: 13px; margin-top: 4px;">
                                <strong>‚ö†Ô∏è ${ann.errorType}</strong>
                            </div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 12px; margin-top: 4px; line-height: 1.4;">
                                ${ann.description}
                            </div>
                        </div>
                        <button onclick="removeAnnotation(${originalIndex})"
                                style="background: rgba(255,255,255,0.2); border: none; color: #ff6b6b; cursor: pointer; font-size: 18px; padding: 5px 10px; border-radius: 4px; margin-left: 10px;">
                            üóëÔ∏è
                        </button>
                    </div>
                `;
            }).join('');
        }

        function saveAnnotations() {
            console.log('‚úÖ Annotations saved:', currentAnnotations.length, 'total');

            // Close modal and return to PDF modal
            document.getElementById('annotationsModal').style.display = 'none';

            if (currentAnnotations.length > 0) {
                showToast(`‚úÖ ${currentAnnotations.length} Anmerkung(en) gespeichert`, 'success', 3000);
            } else {
                showToast('‚ÑπÔ∏è Keine Anmerkungen hinzugef√ºgt', 'info', 2000);
            }
        }

        function cancelAnnotations() {
            console.log('‚ùå Annotations modal cancelled');

            // Ask for confirmation if there are unsaved annotations
            if (currentAnnotations.length > 0) {
                const confirmText = 'Wirklich abbrechen? Alle Anmerkungen werden verworfen.';
                if (!confirm(confirmText)) {
                    return;
                }
                // Clear annotations
                currentAnnotations = [];
            }

            // Close modal
            document.getElementById('annotationsModal').style.display = 'none';
        }

        // Preview PDF without signature (modal stays open)
        async function generatePreviewPDF() {
            const mitarbeiterId = document.getElementById('pdfMitarbeiterId').value;
            const startDatum = document.getElementById('pdfStartDatum').value;
            const endDatum = document.getElementById('pdfEndDatum').value;

            if (!startDatum || !endDatum) {
                showToast('‚ö†Ô∏è Bitte Datumbereich ausw√§hlen', 'error', 3000);
                return;
            }

            if (new Date(startDatum) > new Date(endDatum)) {
                showToast('‚ö†Ô∏è Startdatum muss vor Enddatum liegen', 'error', 3000);
                return;
            }

            console.log('üìÑ Generiere Vorschau-PDF (ohne Unterschrift)...');

            // Set signatureData to null for preview
            signatureData = null;

            // Generate PDF without signature, keep modal open
            await actuallyGeneratePDFNew(false); // closeModal = false

            // Inform user they can now sign if they want
            showToast('üìÑ Vorschau heruntergeladen. Pr√ºfen Sie die Stunden und klicken Sie "Signieren" wenn korrekt.', 'info', 6000);
        }

        // Step 1: Validate and open signature modal
        async function generateStundenabrechnungPDF() {
            const mitarbeiterId = document.getElementById('pdfMitarbeiterId').value;
            const startDatum = document.getElementById('pdfStartDatum').value;
            const endDatum = document.getElementById('pdfEndDatum').value;

            if (!startDatum || !endDatum) {
                showToast('‚ö†Ô∏è Bitte Datumbereich ausw√§hlen', 'error', 3000);
                return;
            }

            if (new Date(startDatum) > new Date(endDatum)) {
                showToast('‚ö†Ô∏è Startdatum muss vor Enddatum liegen', 'error', 3000);
                return;
            }

            console.log('üìÑ √ñffne Unterschriften-Modal...');

            // Close date modal and open signature modal
            closeStundenabrechnungModal();
            openSignatureModal();
        }

        // Step 2: Actually generate PDF with signature (renamed from old generateStundenabrechnungPDF)
        async function actuallyGeneratePDF() {
            const mitarbeiterId = document.getElementById('pdfMitarbeiterId').value;
            const startDatum = document.getElementById('pdfStartDatum').value;
            const endDatum = document.getElementById('pdfEndDatum').value;

            console.log('üìÑ Generiere Stundenabrechnung-PDF f√ºr:', mitarbeiterId, startDatum, 'bis', endDatum);

            try {
                // Load schichten for this mitarbeiter in date range
                const schichtenSnapshot = await window.getCollection('schichten')
                    .where('mitarbeiterId', '==', mitarbeiterId)
                    .where('datum', '>=', startDatum)
                    .where('datum', '<=', endDatum)
                    .get();

                const schichten = schichtenSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                console.log(`üìä ${schichten.length} Schichten gefunden`);

                // Load schichtTypen to get times
                const schichtTypenSnapshot = await window.getCollection('schichtTypen').get();
                const schichtTypen = schichtTypenSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                // Get mitarbeiter
                const mitarbeiter = mitarbeiterList.find(m => String(m.id) === String(mitarbeiterId));
                if (!mitarbeiter) {
                    showToast('‚ùå Mitarbeiter nicht gefunden', 'error', 3000);
                    return;
                }

                // Calculate totals
                let totalHours = 0;
                let urlaubTage = 0;
                let krankTage = 0;

                const regularShifts = [];

                for (const schicht of schichten) {
                    const schichtTyp = schichtTypen.find(st => String(st.id) === String(schicht.schichtTypId));
                    if (!schichtTyp) {
                        console.warn('‚ö†Ô∏è Schicht-Typ nicht gefunden f√ºr:', schicht.schichtTypId);
                        continue;
                    }

                    if (schichtTyp.isSpecial) {
                        if (schichtTyp.type === 'urlaub') urlaubTage++;
                        else if (schichtTyp.type === 'krank') krankTage++;
                    } else {
                        // Calculate hours for regular shift using same logic as dienstplan.html
                        const hours = calculateShiftHours(schichtTyp.startzeit, schichtTyp.endzeit);
                        totalHours += hours;
                        regularShifts.push({
                            datum: schicht.datum,
                            schichtTypName: schichtTyp.name,
                            startzeit: schichtTyp.startzeit,
                            endzeit: schichtTyp.endzeit,
                            hours: hours
                        });
                    }
                }

                // Sort by date
                regularShifts.sort((a, b) => a.datum.localeCompare(b.datum));

                console.log(`‚úÖ Auswertung: ${totalHours.toFixed(2)}h Arbeit, ${urlaubTage} Urlaubstage, ${krankTage} Krankheitstage`);

                // Generate PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Header
                doc.setFontSize(20);
                doc.text('Stundenabrechnung', 105, 20, { align: 'center' });

                doc.setFontSize(12);
                doc.text(`Mitarbeiter: ${mitarbeiter.name}`, 20, 35);
                doc.text(`Rolle: ${mitarbeiter.rolle || 'N/A'}`, 20, 42);
                doc.text(`Zeitraum: ${formatDate(new Date(startDatum), 'DD.MM.YYYY')} - ${formatDate(new Date(endDatum), 'DD.MM.YYYY')}`, 20, 49);

                // Summary
                doc.setFontSize(14);
                doc.text('Zusammenfassung', 20, 60);
                doc.setFontSize(11);
                doc.text(`Gesamtstunden (Arbeit): ${totalHours.toFixed(2)}h`, 20, 68);
                doc.text(`Urlaubstage: ${urlaubTage}`, 20, 75);
                doc.text(`Krankheitstage: ${krankTage}`, 20, 82);

                // Table header
                let y = 95;
                doc.setFontSize(14);
                doc.text('Arbeitstage', 20, y);
                y += 10;

                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('Datum', 20, y);
                doc.text('Schicht', 60, y);
                doc.text('Von', 120, y);
                doc.text('Bis', 145, y);
                doc.text('Stunden', 170, y);
                y += 7;

                doc.setFont(undefined, 'normal');

                // Table rows
                for (const shift of regularShifts) {
                    if (y > 270) {
                        doc.addPage();
                        y = 20;
                    }

                    doc.text(formatDate(new Date(shift.datum), 'DD.MM.YYYY'), 20, y);
                    doc.text(shift.schichtTypName, 60, y);
                    doc.text(shift.startzeit, 120, y);
                    doc.text(shift.endzeit, 145, y);
                    doc.text(shift.hours.toFixed(2) + 'h', 170, y);
                    y += 7;
                }

                // If no shifts, show message
                if (regularShifts.length === 0) {
                    doc.setFontSize(11);
                    doc.text('Keine Arbeitstage im ausgew√§hlten Zeitraum.', 20, y);
                }

                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.text(`Seite ${i} von ${pageCount}`, 105, 290, { align: 'center' });
                    doc.text(`Erstellt am: ${formatDate(new Date(), 'DD.MM.YYYY')} um ${new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })}`, 20, 290);
                }

                // Save
                const filename = `Stundenabrechnung_${mitarbeiter.name.replace(/\s+/g, '_')}_${startDatum}_${endDatum}.pdf`;
                doc.save(filename);

                showToast('‚úÖ PDF erfolgreich erstellt!', 'success', 4000);
                closeStundenabrechnungModal();

            } catch (error) {
                console.error('‚ùå Fehler beim Erstellen der PDF:', error);
                showToast('‚ùå Fehler beim Erstellen der PDF: ' + error.message, 'error', 5000);
            }
        }

        // ============================================
        // NEW PROFESSIONAL PDF GENERATION WITH AUTOTABLE
        // ============================================

        async function actuallyGeneratePDFNew(closeModal = true) {
            const mitarbeiterId = document.getElementById('pdfMitarbeiterId').value;
            const startDatum = document.getElementById('pdfStartDatum').value;
            const endDatum = document.getElementById('pdfEndDatum').value;

            console.log('üìÑ Generiere professionelle Stundenabrechnung-PDF f√ºr:', mitarbeiterId, startDatum, 'bis', endDatum);

            try {
                // Parse dates
                const startDate = new Date(startDatum);
                const endDate = new Date(endDatum);
                const year = startDate.getFullYear();
                const month = startDate.getMonth() + 1; // 1-12

                // Load all data in parallel
                const [schichtenSnapshot, schichtTypenSnapshot, mitarbeiterDoc] = await Promise.all([
                    window.getCollection('schichten')
                        .where('mitarbeiterId', '==', mitarbeiterId)
                        .where('datum', '>=', startDatum)
                        .where('datum', '<=', endDatum)
                        .get(),
                    window.getCollection('schichtTypen').get(),
                    window.getCollection('mitarbeiter').doc(mitarbeiterId).get()
                ]);

                const schichten = schichtenSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const schichtTypen = schichtTypenSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const mitarbeiter = { id: mitarbeiterDoc.id, ...mitarbeiterDoc.data() };

                // Create schicht lookup map for fast access
                const schichtenByDate = {};
                schichten.forEach(schicht => {
                    schichtenByDate[schicht.datum] = schicht;
                });

                // Get all days in month
                const allDays = getAllDaysInMonth(year, month);

                // Build table data
                const tableData = allDays.map(date => {
                    const dateStr = formatDate(date, 'YYYY-MM-DD');
                    const weekday = formatDate(date, 'dddd');
                    const schicht = schichtenByDate[dateStr];

                    if (!schicht) {
                        // Empty row for days without shifts
                        return [formatDate(date, 'DD.MM.YYYY'), weekday, '', '', '', ''];
                    }

                    const schichtTyp = schichtTypen.find(st => String(st.id) === String(schicht.schichtTypId));
                    if (!schichtTyp) {
                        return [formatDate(date, 'DD.MM.YYYY'), weekday, '', '', '', ''];
                    }

                    // For special shifts (Urlaub/Krank/Frei)
                    if (schichtTyp.isSpecial) {
                        return [
                            formatDate(date, 'DD.MM.YYYY'),
                            weekday,
                            schichtTyp.name,  // Show "Urlaub", "Krank", "Frei" in Start column
                            '',
                            '',
                            ''
                        ];
                    }

                    // For regular work shifts
                    const start = schichtTyp.startzeit || '';
                    const stop = schichtTyp.endzeit || '';
                    const totalHours = calculateShiftHours(start, stop);
                    const breakTime = getBreakTime(totalHours + getBreakTime(totalHours)); // Reverse calculation
                    const workTime = totalHours;

                    return [
                        formatDate(date, 'DD.MM.YYYY'),
                        weekday,
                        start,
                        stop,
                        breakTime > 0 ? `${(breakTime * 60).toFixed(0)} min` : '',
                        workTime > 0 ? `${workTime.toFixed(2)}h` : ''
                    ];
                });

                // Calculate totals
                const totalHours = schichten
                    .map(s => {
                        const st = schichtTypen.find(t => String(t.id) === String(s.schichtTypId));
                        return st && !st.isSpecial ? calculateShiftHours(st.startzeit, st.endzeit) : 0;
                    })
                    .reduce((sum, h) => sum + h, 0);

                const urlaubDays = schichten.filter(s => {
                    const st = schichtTypen.find(t => String(t.id) === String(s.schichtTypId));
                    return st && st.type === 'urlaub';
                }).length;

                const krankDays = schichten.filter(s => {
                    const st = schichtTypen.find(t => String(t.id) === String(s.schichtTypId));
                    return st && st.type === 'krank';
                }).length;

                // Create PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Header
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text('Arbeitszeiterfassung', 105, 20, { align: 'center' });

                // Employee info
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                const infoY = 35;
                doc.text(`Name: ${mitarbeiter.name || 'Unbekannt'}`, 20, infoY);
                doc.text(`Pers-Nr: ${mitarbeiter.id}`, 20, infoY + 6);
                doc.text(`Abteilung: ${mitarbeiter.rolle || 'N/A'}`, 20, infoY + 12);
                doc.text(`Vorgesetzte/r: Christopher G√§rtner`, 20, infoY + 18);
                doc.text(`Monat: ${formatDate(startDate, 'MMMM')}`, 20, infoY + 24);
                doc.text(`Jahr: ${year}`, 20, infoY + 30);

                // Summary box
                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text(`Stunden Total: ${totalHours.toFixed(2)}`, 20, infoY + 40);

                // Table with autoTable
                doc.autoTable({
                    startY: infoY + 48,
                    head: [['Datum', 'Wochentag', 'Start', 'Stop', 'Pause', 'Arbeitszeit']],
                    body: tableData,
                    theme: 'grid',
                    styles: {
                        fontSize: 9,
                        cellPadding: 3,
                        lineColor: [200, 200, 200],
                        lineWidth: 0.1
                    },
                    headStyles: {
                        fillColor: [50, 50, 50],
                        textColor: 255,
                        fontStyle: 'bold',
                        halign: 'center'
                    },
                    columnStyles: {
                        0: { halign: 'center', cellWidth: 28 },  // Datum
                        1: { halign: 'left', cellWidth: 30 },    // Wochentag
                        2: { halign: 'center', cellWidth: 22 },  // Start
                        3: { halign: 'center', cellWidth: 22 },  // Stop
                        4: { halign: 'center', cellWidth: 22 },  // Pause
                        5: { halign: 'center', cellWidth: 26 }   // Arbeitszeit
                    },
                    didDrawCell: (data) => {
                        // Highlight weekends (Saturday = 6, Sunday = 0)
                        if (data.section === 'body' && data.column.index === 1) {
                            const weekday = data.cell.text[0];
                            if (weekday === 'Samstag' || weekday === 'Sonntag') {
                                doc.setFillColor(240, 240, 240);
                                doc.rect(data.cell.x, data.cell.y, data.cell.width, data.cell.height, 'F');
                                // Redraw text
                                doc.setTextColor(100, 100, 100);
                                doc.text(weekday, data.cell.x + 2, data.cell.y + data.cell.height / 2 + 2);
                                doc.setTextColor(0, 0, 0);
                            }
                        }
                    }
                });

                // Signature section
                const finalY = doc.lastAutoTable.finalY + 15;

                // Add signature image if available
                if (signatureData) {
                    doc.setFontSize(10);
                    doc.text('Unterschrift Mitarbeiter:', 20, finalY);
                    doc.addImage(signatureData, 'PNG', 20, finalY + 2, 50, 15); // Signature image
                    doc.text(`Datum: ______________`, 120, finalY + 10);
                } else {
                    doc.setFontSize(10);
                    doc.text('Unterschrift Mitarbeiter: __________________________', 20, finalY);
                    doc.text(`Datum: ______________`, 120, finalY);
                }

                doc.text('Unterschrift Vorgesetzte/r: __________________________', 20, finalY + 25);
                doc.text(`Datum: ______________`, 120, finalY + 25);

                // Annotations section (if any)
                if (currentAnnotations && currentAnnotations.length > 0) {
                    let annotationsY = finalY + 45; // Start below signatures

                    // Check if we need a new page
                    if (annotationsY > 250) {
                        doc.addPage();
                        annotationsY = 20;
                    }

                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(200, 50, 50); // Red for attention
                    doc.text('üìã Anmerkungen und Korrekturen', 20, annotationsY);

                    doc.setFontSize(9);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(100, 100, 100);
                    doc.text('Der Mitarbeiter hat folgende Fehler in der Stundenerfassung gemeldet:', 20, annotationsY + 6);

                    annotationsY += 14;

                    // Sort annotations by date
                    const sortedAnnotations = [...currentAnnotations].sort((a, b) => a.date.localeCompare(b.date));

                    sortedAnnotations.forEach((ann, index) => {
                        // Check if we need a new page
                        if (annotationsY > 270) {
                            doc.addPage();
                            annotationsY = 20;
                        }

                        const dateObj = new Date(ann.date + 'T00:00:00');
                        const dateStr = dateObj.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });

                        // Light gray background box for each annotation
                        doc.setFillColor(245, 245, 245);
                        doc.rect(18, annotationsY - 4, 174, 18, 'F');

                        // Date and error type
                        doc.setFontSize(10);
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(50, 50, 50);
                        doc.text(`${index + 1}. ${dateStr} - ${ann.errorType}`, 20, annotationsY);

                        // Description
                        doc.setFontSize(9);
                        doc.setFont(undefined, 'normal');
                        doc.setTextColor(80, 80, 80);
                        const wrappedDescription = doc.splitTextToSize(ann.description, 170);
                        doc.text(wrappedDescription, 20, annotationsY + 5);

                        annotationsY += 18 + (wrappedDescription.length > 1 ? (wrappedDescription.length - 1) * 4 : 0) + 3;
                    });

                    console.log(`üìã ${currentAnnotations.length} Anmerkungen ins PDF eingef√ºgt`);
                }

                // Footer
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text(`Erstellt am: ${formatDate(new Date(), 'DD.MM.YYYY HH:mm')} Uhr`, 20, 285);
                doc.text('Seite 1 von 1', 170, 285);

                // Save
                const filename = `Arbeitszeiterfassung_${mitarbeiter.name.replace(/\s+/g, '_')}_${year}_${String(month).padStart(2, '0')}.pdf`;
                doc.save(filename);

                showToast('‚úÖ Professionelle Stundenabrechnung erfolgreich erstellt!', 'success', 5000);

                // Close modal only if requested (for signature workflow)
                if (closeModal) {
                    closeStundenabrechnungModal();
                }

            } catch (error) {
                console.error('‚ùå Fehler beim Erstellen der PDF:', error);
                showToast('‚ùå Fehler beim Erstellen der PDF: ' + error.message, 'error', 5000);
            }
        }

        // Helper function to get all days in a month (for full calendar PDF)
        function getAllDaysInMonth(year, month) {
            const days = [];
            const firstDay = new Date(year, month - 1, 1);
            const lastDay = new Date(year, month, 0);

            for (let day = 1; day <= lastDay.getDate(); day++) {
                days.push(new Date(year, month - 1, day));
            }

            return days;
        }

        // Helper function to get break time from total hours
        function getBreakTime(totalHours) {
            if (totalHours >= 9) return 0.75; // 45 min
            if (totalHours >= 6) return 0.5;  // 30 min
            return 0;
        }

        // Helper function to calculate shift hours (same logic as dienstplan.html)
        function calculateShiftHours(startzeit, endzeit) {
            if (!startzeit || !endzeit) return 0;

            // Parse "08:00" format
            const [startHour, startMin] = startzeit.split(':').map(Number);
            const [endHour, endMin] = endzeit.split(':').map(Number);

            // Calculate total minutes worked
            let totalMinutes = (endHour * 60 + endMin) - (startHour * 60 + startMin);

            // Handle overnight shifts (e.g., 22:00 to 06:00)
            if (totalMinutes < 0) {
                totalMinutes += 24 * 60;
            }

            let totalHours = totalMinutes / 60;

            // Subtract legal break time according to German labor law (Arbeitszeitgesetz)
            if (totalHours >= 9) {
                totalHours -= 0.75;  // 45 min break for 9+ hours
            } else if (totalHours >= 6) {
                totalHours -= 0.5;   // 30 min break for 6-9 hours
            }

            return Math.round(totalHours * 100) / 100;  // Round to 2 decimals
        }

        // Helper function for date formatting (used in PDF generation)
        function formatDate(date, format) {
            const d = new Date(date);
            const months = ['Januar', 'Februar', 'M√§rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];
            const weekdays = ['Sonntag', 'Montag', 'Dienstag', 'Mittwoch', 'Donnerstag', 'Freitag', 'Samstag'];

            const replacements = {
                'YYYY': d.getFullYear(),
                'MM': String(d.getMonth() + 1).padStart(2, '0'),
                'DD': String(d.getDate()).padStart(2, '0'),
                'HH': String(d.getHours()).padStart(2, '0'),
                'mm': String(d.getMinutes()).padStart(2, '0'),
                'MMMM': months[d.getMonth()],
                'dddd': weekdays[d.getDay()]
            };

            let result = format;
            for (const [key, value] of Object.entries(replacements)) {
                result = result.replace(key, value);
            }

            return result;
        }

        // ============================================
        // TEST DATA CREATION
        // ============================================

        async function createTestData() {
            if (!confirm('üß™ 3 Test-Mitarbeiter erstellen?\n\n- Max M√ºller (Vollzugriff)\n- Anna Schmidt (Teilzugriff)\n- Tom Weber (Basiszugriff)')) {
                return;
            }

            console.log('üß™ Erstelle Test-Mitarbeiter...');

            const testUsers = [
                {
                    id: `user_max_${Date.now()}`,
                    name: 'Max M√ºller (Vollzugriff)',
                    passwordHash: null, // Will be set by migration script
                    tempPasswordForMigration: '1234', // Test password for migration
                    status: 'active',
                    berechtigungen: {
                        annahme: true,
                        abnahme: true,
                        liste: true,
                        kanban: true,
                        kunden: true,
                        kalender: true,
                        material: true,
                        partnerAnfragen: true,
                        partnerPortal: true,
                        mitarbeiterVerwaltung: true,
                        nutzerVerwaltung: true,
                        registrierung: true,
                        kiChat: true,
                        kiSprache: true
                    },
                    werkstattId: currentWerkstattId,
                    createdAt: new Date().toISOString(),
                    createdBy: 'Test-Daten Generator',
                    lastLogin: null
                },
                {
                    id: `user_anna_${Date.now()}`,
                    name: 'Anna Schmidt (Teilzugriff)',
                    passwordHash: null, // Will be set by migration script
                    tempPasswordForMigration: '1234', // Test password for migration
                    status: 'active',
                    berechtigungen: {
                        annahme: true,
                        abnahme: true,
                        liste: true,
                        kanban: true,
                        kunden: false,
                        kalender: true,
                        material: true,
                        partnerAnfragen: false,
                        partnerPortal: false,
                        mitarbeiterVerwaltung: false,
                        nutzerVerwaltung: false,
                        registrierung: false,
                        kiChat: true,
                        kiSprache: false
                    },
                    werkstattId: currentWerkstattId,
                    createdAt: new Date().toISOString(),
                    createdBy: 'Test-Daten Generator',
                    lastLogin: null
                },
                {
                    id: `user_tom_${Date.now()}`,
                    name: 'Tom Weber (Basiszugriff)',
                    passwordHash: null, // Will be set by migration script
                    tempPasswordForMigration: '1234', // Test password for migration
                    status: 'inactive', // Inactive for testing
                    berechtigungen: {
                        annahme: true,
                        abnahme: false,
                        liste: true,
                        kanban: true,
                        kunden: false,
                        kalender: false,
                        material: false,
                        partnerAnfragen: false,
                        partnerPortal: false,
                        mitarbeiterVerwaltung: false,
                        nutzerVerwaltung: false,
                        registrierung: false,
                        kiChat: false,
                        kiSprache: false
                    },
                    werkstattId: currentWerkstattId,
                    createdAt: new Date().toISOString(),
                    createdBy: 'Test-Daten Generator',
                    lastLogin: null
                }
            ];

            try {
                const mitarbeiterCollection = window.getCollection('mitarbeiter');

                for (const user of testUsers) {
                    await mitarbeiterCollection.doc(user.id).set(user);
                    console.log(`‚úÖ Test-Mitarbeiter erstellt: ${user.name}`);
                }

                showToast('‚úÖ 3 Test-Mitarbeiter erfolgreich erstellt! Passwort: 1234. Check Console f√ºr Details.', 'success', 6000);
                console.log('üìã Test-Mitarbeiter:\n‚Ä¢ Max M√ºller (Vollzugriff, Aktiv)\n‚Ä¢ Anna Schmidt (Teilzugriff, Aktiv)\n‚Ä¢ Tom Weber (Basiszugriff, Inaktiv)');
            } catch (error) {
                console.error('‚ùå Fehler beim Erstellen der Test-Daten:', error);
                showToast('‚ùå Fehler beim Erstellen. Siehe Console f√ºr Details.', 'error', 5000);
            }
        }

        // ============================================
        // INITIALIZE APP ON PAGE LOAD
        // ============================================

        window.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ DOMContentLoaded - starte App...');
            await initApp();
        });

        console.log('‚úÖ PHASE 6: Multi-Tenant Mitarbeiter-Verwaltung geladen');
    </script>

    <!-- KI-Chat-Assistent -->
    <div id="aiChatWidget"></div>
    <script src="js/ai-agent-tools.js"></script>
    <script src="js/ai-agent-engine.js"></script>
    <script src="js/ai-chat-widget.js"></script>
    <script src="js/quota-display.js"></script>

    <!-- ============================================
         SERVICE WORKER REGISTRATION - Offline-Funktionalit√§t
         ============================================ -->
    <script>
        // Service Worker nur registrieren wenn:
        // 1. Browser unterst√ºtzt Service Worker
        // 2. NICHT in Playwright Tests (navigator.webdriver)
        // 3. NICHT auf Emulator-Port (8000)
        if ('serviceWorker' in navigator && !navigator.webdriver && window.location.port !== '8000') {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('./sw.js', {
                        scope: './'
                    });

                    console.log('‚úÖ [SW] Service Worker registriert:', registration.scope);

                    // Update-Handling: Neuen SW aktivieren wenn gefunden
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('üîÑ [SW] Update gefunden, installiere...');

                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                console.log('‚úÖ [SW] Update bereit! Seite neu laden f√ºr neue Version.');

                                // Optional: Auto-reload nach 3 Sekunden
                                // setTimeout(() => window.location.reload(), 3000);
                            }
                        });
                    });

                } catch (error) {
                    console.error('‚ùå [SW] Registrierung fehlgeschlagen:', error);
                }
            });
        } else {
            console.log('‚ÑπÔ∏è [SW] Service Worker nicht registriert (Test-Modus oder nicht unterst√ºtzt)');
        }

        // ============================================
        // PHASE 2.1: URLAUBS-ANFRAGEN VERWALTUNG
        // ============================================

        let allUrlaubsAnfragen = [];
        let allStundennachweise = [];
        let allZeiterfassungen = [];
        let currentRejectAnfrageId = null;
        let currentEditZeit = null;

        /**
         * Tab switching
         */
        function switchTab(tabName) {
            // Update tab buttons
            document.getElementById('tabMitarbeiter').classList.toggle('active', tabName === 'mitarbeiter');
            document.getElementById('tabUrlaub').classList.toggle('active', tabName === 'urlaub');
            document.getElementById('tabStunden').classList.toggle('active', tabName === 'stunden');
            document.getElementById('tabZeiterfassung').classList.toggle('active', tabName === 'zeiterfassung');

            // Update tab content
            document.getElementById('contentMitarbeiter').style.display = tabName === 'mitarbeiter' ? 'block' : 'none';
            document.getElementById('contentUrlaub').style.display = tabName === 'urlaub' ? 'block' : 'none';
            document.getElementById('contentStunden').style.display = tabName === 'stunden' ? 'block' : 'none';
            document.getElementById('contentZeiterfassung').style.display = tabName === 'zeiterfassung' ? 'block' : 'none';

            // Load data when switching tabs
            if (tabName === 'urlaub') {
                loadUrlaubsAnfragen();
            } else if (tabName === 'stunden') {
                loadStundennachweise();
            } else if (tabName === 'zeiterfassung') {
                loadZeiterfassungen();
            }

            console.log(`üìë Tab gewechselt: ${tabName}`);
        }

        /**
         * Load all vacation requests
         */
        async function loadUrlaubsAnfragen() {
            try {
                console.log('üèñÔ∏è Lade Urlaubs-Anfragen...');

                // Query all requests for current werkstatt
                const snapshot = await window.getCollection('urlaubsAnfragen')
                    .orderBy('createdAt', 'desc')
                    .get();

                allUrlaubsAnfragen = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                console.log(`‚úÖ ${allUrlaubsAnfragen.length} Anfragen geladen`);

                // Render lists
                renderUrlaubsAnfragen();

            } catch (error) {
                console.error('‚ùå Fehler beim Laden der Urlaubs-Anfragen:', error);
                showToast('‚ùå Fehler beim Laden der Anfragen', 'error', 3000);
            }
        }

        /**
         * Render vacation requests (pending + processed)
         */
        function renderUrlaubsAnfragen() {
            const pending = allUrlaubsAnfragen.filter(a => a.status === 'pending');
            const processed = allUrlaubsAnfragen.filter(a => a.status !== 'pending');

            // Update pending count badge
            document.getElementById('pendingCount').textContent = pending.length;

            // Render pending requests
            const pendingList = document.getElementById('pendingRequestsList');
            if (pending.length === 0) {
                pendingList.innerHTML = `
                    <div style="padding: 30px; background: rgba(255,255,255,0.05); border-radius: 10px; text-align: center; color: var(--color-text-secondary);">
                        ‚úÖ Keine ausstehenden Anfragen
                    </div>
                `;
            } else {
                pendingList.innerHTML = pending.map(anfrage => createAnfrageCard(anfrage, true)).join('');
            }

            // Render processed requests
            const processedList = document.getElementById('processedRequestsList');
            if (processed.length === 0) {
                processedList.innerHTML = `
                    <div style="padding: 20px; background: rgba(255,255,255,0.03); border-radius: 8px; text-align: center; color: var(--color-text-secondary); font-size: 14px;">
                        Noch keine bearbeiteten Anfragen
                    </div>
                `;
            } else {
                processedList.innerHTML = processed.map(anfrage => createAnfrageCard(anfrage, false)).join('');
            }
        }

        /**
         * Create HTML for vacation request card
         */
        function createAnfrageCard(anfrage, isPending) {
            const startDate = new Date(anfrage.startDatum);
            const endDate = new Date(anfrage.endDatum);
            const startFormatted = startDate.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const endFormatted = endDate.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' });

            const statusBadge = {
                'pending': '<span style="padding: 4px 12px; background: rgba(255, 149, 0, 0.2); border-radius: 12px; font-size: 12px; font-weight: 600; color: #ff9500;">‚è≥ Ausstehend</span>',
                'approved': '<span style="padding: 4px 12px; background: rgba(52, 199, 89, 0.2); border-radius: 12px; font-size: 12px; font-weight: 600; color: #34c759;">‚úÖ Genehmigt</span>',
                'rejected': '<span style="padding: 4px 12px; background: rgba(255, 59, 48, 0.2); border-radius: 12px; font-size: 12px; font-weight: 600; color: #ff3b30;">‚ùå Abgelehnt</span>'
            }[anfrage.status];

            const actionButtons = isPending ? `
                <div style="display: flex; gap: 10px;">
                    <button onclick="approveVacation('${anfrage.id}')" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #34c759, #28a745); border: none; border-radius: 8px; color: white; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        ‚úÖ Genehmigen
                    </button>
                    <button onclick="openRejectVacationModal('${anfrage.id}')" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #ff3b30, #dc143c); border: none; border-radius: 8px; color: white; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        ‚ùå Ablehnen
                    </button>
                </div>
            ` : '';

            const ablehnungsgrundSection = anfrage.status === 'rejected' && anfrage.ablehnungsgrund ? `
                <div style="margin-top: 12px; padding: 10px; background: rgba(255, 59, 48, 0.1); border-left: 3px solid #ff3b30; border-radius: 4px;">
                    <p style="margin: 0; font-size: 12px; color: var(--color-text-secondary);"><strong>Ablehnungsgrund:</strong></p>
                    <p style="margin: 4px 0 0 0; font-size: 13px; color: var(--color-text-primary);">${anfrage.ablehnungsgrund}</p>
                </div>
            ` : '';

            const bearbeitetSection = anfrage.bearbeitetAm ? `
                <p style="margin: 4px 0 0 0; font-size: 12px; color: var(--color-text-secondary);">
                    Bearbeitet am ${new Date(anfrage.bearbeitetAm).toLocaleString('de-DE')}
                </p>
            ` : '';

            return `
                <div style="padding: 20px; background: ${isPending ? 'rgba(255, 149, 0, 0.05)' : 'rgba(255,255,255,0.03)'}; border: ${isPending ? '2px solid rgba(255, 149, 0, 0.3)' : '1px solid rgba(255,255,255,0.1)'}; border-radius: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                        <div>
                            <h4 style="margin: 0 0 6px 0; color: var(--color-text-primary); font-size: 18px;">${anfrage.mitarbeiterName}</h4>
                            <p style="margin: 0; font-size: 13px; color: var(--color-text-secondary);">
                                ${anfrage.mitarbeiterRolle || 'Sonstige'}
                            </p>
                        </div>
                        ${statusBadge}
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 12px;">
                        <div>
                            <p style="margin: 0 0 4px 0; font-size: 11px; color: var(--color-text-secondary); text-transform: uppercase; font-weight: 600;">Von</p>
                            <p style="margin: 0; font-size: 15px; color: var(--color-text-primary); font-weight: 600;">${startFormatted}</p>
                        </div>
                        <div>
                            <p style="margin: 0 0 4px 0; font-size: 11px; color: var(--color-text-secondary); text-transform: uppercase; font-weight: 600;">Bis</p>
                            <p style="margin: 0; font-size: 15px; color: var(--color-text-primary); font-weight: 600;">${endFormatted}</p>
                        </div>
                        <div>
                            <p style="margin: 0 0 4px 0; font-size: 11px; color: var(--color-text-secondary); text-transform: uppercase; font-weight: 600;">Tage</p>
                            <p style="margin: 0; font-size: 15px; color: var(--color-text-primary); font-weight: 600;">${anfrage.anzahlTage} Werktage</p>
                        </div>
                    </div>

                    ${anfrage.grund ? `
                        <div style="margin-bottom: 12px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 6px;">
                            <p style="margin: 0 0 4px 0; font-size: 11px; color: var(--color-text-secondary); text-transform: uppercase; font-weight: 600;">Grund</p>
                            <p style="margin: 0; font-size: 13px; color: var(--color-text-primary);">${anfrage.grund}</p>
                        </div>
                    ` : ''}

                    ${ablehnungsgrundSection}
                    ${bearbeitetSection}
                    ${actionButtons}
                </div>
            `;
        }

        /**
         * Approve vacation request
         */
        async function approveVacation(anfrageId) {
            if (!confirm('M√∂chtest du diese Urlaubs-Anfrage wirklich genehmigen?')) {
                return;
            }

            try {
                console.log(`‚úÖ Genehmige Urlaubs-Anfrage: ${anfrageId}`);

                const anfrage = allUrlaubsAnfragen.find(a => a.id === anfrageId);
                if (!anfrage) {
                    showToast('‚ùå Anfrage nicht gefunden', 'error', 3000);
                    return;
                }

                const currentUser = window.authManager.getCurrentUser();

                // Update anfrage status
                await window.getCollection('urlaubsAnfragen').doc(anfrageId).update({
                    status: 'approved',
                    bearbeitetVon: currentUser.werkstattId,
                    bearbeitetAm: new Date().toISOString()
                });

                // üÜï Phase 2.1: Update urlaubstageVerbraucht in mitarbeiter document
                const mitarbeiterDoc = await window.getCollection('mitarbeiter').doc(anfrage.mitarbeiterId).get();
                const mitarbeiterData = mitarbeiterDoc.data();

                const urlaubstageVerbraucht = (mitarbeiterData.urlaubstageVerbraucht || 0) + anfrage.anzahlTage;

                await window.getCollection('mitarbeiter').doc(anfrage.mitarbeiterId).update({
                    urlaubstageVerbraucht: urlaubstageVerbraucht
                });

                console.log(`‚úÖ Urlaubstage aktualisiert: ${urlaubstageVerbraucht}`);

                // üÜï Phase 2.2: Create "Urlaub" shifts in Dienstplan for each vacation day
                try {
                    // Load all schichtTypen to find "Urlaub" type
                    const schichtTypenSnapshot = await window.getCollection('schichtTypen').get();
                    const allSchichtTypen = schichtTypenSnapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));

                    // Find "Urlaub" schichtTyp
                    const urlaubTyp = allSchichtTypen.find(st => st.name === 'Urlaub');
                    if (!urlaubTyp) {
                        console.error('‚ùå Urlaub schicht type not found');
                        showToast('‚ö†Ô∏è Warnung: Urlaub-Schicht-Typ nicht gefunden', 'warning', 3000);
                    } else {
                        // Loop through date range and create schichten
                        const startDate = new Date(anfrage.startDatum);
                        const endDate = new Date(anfrage.endDatum);
                        const currentDate = new Date(startDate);

                        let urlaubsSchichtenErstellt = 0;

                        while (currentDate <= endDate) {
                            // Skip Sundays (day 0) - bereits als "Frei" markiert
                            if (currentDate.getDay() !== 0) {
                                const dateStr = currentDate.toISOString().split('T')[0];  // YYYY-MM-DD

                                // Check if schicht already exists for this day (duplicate prevention)
                                const existingShift = await window.getCollection('schichten')
                                    .where('mitarbeiterId', '==', anfrage.mitarbeiterId)
                                    .where('datum', '==', dateStr)
                                    .get();

                                if (existingShift.empty) {
                                    // Create "Urlaub" schicht for this day
                                    await window.getCollection('schichten').add({
                                        mitarbeiterId: anfrage.mitarbeiterId,
                                        mitarbeiterName: anfrage.mitarbeiterName,
                                        datum: dateStr,
                                        schichtTypId: urlaubTyp.id,
                                        schichtTypName: urlaubTyp.name,
                                        status: 'active',
                                        erstelltVon: 'system',
                                        erstelltAm: new Date().toISOString(),
                                        werkstattId: window.werkstattId
                                    });
                                    urlaubsSchichtenErstellt++;
                                }
                            }

                            // Move to next day
                            currentDate.setDate(currentDate.getDate() + 1);
                        }

                        console.log(`‚úÖ ${urlaubsSchichtenErstellt} Urlaubs-Schichten im Dienstplan erstellt`);
                    }
                } catch (error) {
                    console.error('‚ùå Fehler beim Erstellen der Urlaubs-Schichten:', error);
                    // Continue anyway - approval already succeeded
                }

                showToast(`‚úÖ Urlaub genehmigt! ${anfrage.anzahlTage} Tage von ${anfrage.mitarbeiterName}`, 'success', 4000);

                // Reload anfragen
                await loadUrlaubsAnfragen();

                // Reload mitarbeiter table if on mitarbeiter tab
                if (typeof renderMitarbeiterTable === 'function') {
                    await loadMitarbeiter();
                }

            } catch (error) {
                console.error('‚ùå Fehler beim Genehmigen:', error);
                showToast('‚ùå Fehler beim Genehmigen der Anfrage', 'error', 3000);
            }
        }

        /**
         * Open reject vacation modal
         */
        function openRejectVacationModal(anfrageId) {
            const anfrage = allUrlaubsAnfragen.find(a => a.id === anfrageId);
            if (!anfrage) {
                showToast('‚ùå Anfrage nicht gefunden', 'error', 3000);
                return;
            }

            currentRejectAnfrageId = anfrageId;

            const startDate = new Date(anfrage.startDatum).toLocaleDateString('de-DE');
            const endDate = new Date(anfrage.endDatum).toLocaleDateString('de-DE');

            document.getElementById('rejectVacationInfo').textContent =
                `${anfrage.mitarbeiterName} ¬∑ ${anfrage.anzahlTage} Tage ¬∑ ${startDate} - ${endDate}`;
            document.getElementById('ablehnungsgrund').value = '';
            document.getElementById('rejectVacationModal').style.display = 'block';
        }

        /**
         * Close reject vacation modal
         */
        function closeRejectVacationModal() {
            document.getElementById('rejectVacationModal').style.display = 'none';
            currentRejectAnfrageId = null;
        }

        /**
         * Confirm reject vacation
         */
        async function confirmRejectVacation() {
            const grund = document.getElementById('ablehnungsgrund').value.trim();

            if (!grund) {
                showToast('‚ö†Ô∏è Bitte Ablehnungsgrund eingeben!', 'warning', 3000);
                return;
            }

            try {
                console.log(`‚ùå Lehne Urlaubs-Anfrage ab: ${currentRejectAnfrageId}`);

                const currentUser = window.authManager.getCurrentUser();

                // Update anfrage status
                await window.getCollection('urlaubsAnfragen').doc(currentRejectAnfrageId).update({
                    status: 'rejected',
                    bearbeitetVon: currentUser.werkstattId,
                    bearbeitetAm: new Date().toISOString(),
                    ablehnungsgrund: grund
                });

                showToast('‚úÖ Urlaub abgelehnt', 'success', 3000);

                // Close modal
                closeRejectVacationModal();

                // Reload anfragen
                await loadUrlaubsAnfragen();

            } catch (error) {
                console.error('‚ùå Fehler beim Ablehnen:', error);
                showToast('‚ùå Fehler beim Ablehnen der Anfrage', 'error', 3000);
            }
        }

        // ============================================
        // PHASE 2: STUNDENNACHWEISE VERWALTUNG
        // ============================================

        /**
         * Load all stundennachweise
         */
        async function loadStundennachweise() {
            try {
                console.log('üìÑ Lade Stundennachweise...');

                // Query all stundennachweise for current werkstatt
                const snapshot = await window.getCollection('stundennachweise')
                    .orderBy('createdAt', 'desc')
                    .get();

                allStundennachweise = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                console.log(`‚úÖ ${allStundennachweise.length} Stundennachweise geladen`);

                // Update badge counter
                document.getElementById('stundenCount').textContent = allStundennachweise.length;

                // Render table (desktop) and cards (mobile)
                renderStundennachweise();
                renderStundenCards();

            } catch (error) {
                console.error('‚ùå Fehler beim Laden der Stundennachweise:', error);
                showToast('‚ùå Fehler beim Laden der Stundennachweise', 'error', 3000);
            }
        }

        /**
         * Render stundennachweise table
         */
        function renderStundennachweise() {
            const tbody = document.getElementById('stundenTableBody');

            if (allStundennachweise.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: var(--color-text-secondary);">
                            Keine Stundennachweise vorhanden
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = allStundennachweise.map(nachweis => {
                const datum = new Date(nachweis.createdAt);
                const datumStr = datum.toLocaleDateString('de-DE', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const signaturBadge = nachweis.signiert
                    ? '<span style="color: #4CAF50; font-weight: 600;">‚úÖ Ja</span>'
                    : '<span style="color: #999; font-weight: 600;">‚ùå Nein</span>';

                const anmerkungenCount = (nachweis.anmerkungen || []).length;
                const anmerkungenBadge = anmerkungenCount > 0
                    ? `<span style="background: rgba(255,152,0,0.2); color: #FF9800; padding: 4px 8px; border-radius: 4px; font-weight: 600;">${anmerkungenCount}</span>`
                    : '<span style="color: #999;">-</span>';

                return `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <td>${nachweis.mitarbeiterName}</td>
                        <td>${nachweis.monat}/${nachweis.jahr}</td>
                        <td>${nachweis.zeitraum}</td>
                        <td>${nachweis.stundenGesamt.toFixed(1)}h</td>
                        <td>${signaturBadge}</td>
                        <td>${anmerkungenBadge}</td>
                        <td style="color: var(--color-text-secondary); font-size: 13px;">${datumStr}</td>
                    </tr>
                `;
            }).join('');
        }

        // ============================================
        // STUNDENNACHWEISE MOBILE CARDS
        // ============================================
        function renderStundenCards() {
            const cardsContainer = document.getElementById('stundenCardsContainer');

            if (allStundennachweise.length === 0) {
                cardsContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--color-text-secondary);">
                        Keine Stundennachweise vorhanden
                    </div>
                `;
                return;
            }

            cardsContainer.innerHTML = allStundennachweise.map(nachweis => {
                const datum = new Date(nachweis.createdAt);
                const datumStr = datum.toLocaleDateString('de-DE', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const signiert = nachweis.signiert;
                const anmerkungenCount = (nachweis.anmerkungen || []).length;

                return `
                    <div class="stunden-card">
                        <div class="stunden-card-header">
                            <div class="stunden-card-name">${nachweis.mitarbeiterName}</div>
                            <div class="stunden-card-month">${nachweis.monat}/${nachweis.jahr}</div>
                        </div>

                        <div class="stunden-card-stats">
                            <div class="stunden-stat">
                                <div class="stunden-stat-label">üìÖ Zeitraum</div>
                                <div class="stunden-stat-value">${nachweis.zeitraum}</div>
                            </div>
                            <div class="stunden-stat">
                                <div class="stunden-stat-label">‚è∞ Stunden</div>
                                <div class="stunden-stat-value">${nachweis.stundenGesamt.toFixed(1)}h</div>
                            </div>
                            <div class="stunden-stat">
                                <div class="stunden-stat-label">‚úçÔ∏è Signiert</div>
                                <div class="stunden-stat-value ${signiert ? 'positive' : ''}">${signiert ? '‚úÖ Ja' : '‚ùå Nein'}</div>
                            </div>
                            <div class="stunden-stat">
                                <div class="stunden-stat-label">üìã Anmerkungen</div>
                                <div class="stunden-stat-value ${anmerkungenCount > 0 ? 'positive' : ''}">${anmerkungenCount > 0 ? anmerkungenCount : '-'}</div>
                            </div>
                            <div class="stunden-stat" style="grid-column: 1 / -1;">
                                <div class="stunden-stat-label">üïê Erstellt am</div>
                                <div class="stunden-stat-value" style="font-size: 14px;">${datumStr}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            console.log('‚úÖ Stunden Mobile Cards gerendert mit', allStundennachweise.length, 'Eintr√§gen');
        }

        // ============================================
        // ZEITERFASSUNG VERWALTUNG
        // ============================================

        /**
         * Load all zeiterfassung records
         */
        async function loadZeiterfassungen() {
            try {
                console.log('‚è±Ô∏è Lade Zeiterfassungen...');

                // Query all zeiterfassung for current werkstatt
                const snapshot = await window.getCollection('zeiterfassung')
                    .orderBy('datum', 'desc')
                    .get();

                allZeiterfassungen = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                console.log(`‚úÖ ${allZeiterfassungen.length} Zeiterfassungen geladen`);

                // Update badge counter
                document.getElementById('zeiterfassungCount').textContent = allZeiterfassungen.length;

                // Populate mitarbeiter filter dropdown
                populateZeitMitarbeiterFilter();

                // Render table
                filterZeiterfassung();

            } catch (error) {
                console.error('‚ùå Fehler beim Laden der Zeiterfassungen:', error);
                showToast('‚ùå Fehler beim Laden der Zeiterfassungen', 'error', 3000);
            }
        }

        /**
         * Populate mitarbeiter filter dropdown
         */
        function populateZeitMitarbeiterFilter() {
            const filter = document.getElementById('filterZeitMitarbeiter');

            // Get unique mitarbeiter from zeiterfassung records
            const uniqueMitarbeiter = {};
            allZeiterfassungen.forEach(zeit => {
                if (zeit.mitarbeiterId && zeit.mitarbeiterName) {
                    uniqueMitarbeiter[zeit.mitarbeiterId] = zeit.mitarbeiterName;
                }
            });

            // Build options
            let options = '<option value="">Alle Mitarbeiter</option>';
            Object.entries(uniqueMitarbeiter).forEach(([id, name]) => {
                options += `<option value="${id}">${name}</option>`;
            });

            filter.innerHTML = options;
        }

        /**
         * Filter and render zeiterfassung table
         */
        function filterZeiterfassung() {
            const selectedMitarbeiterId = document.getElementById('filterZeitMitarbeiter').value;
            const selectedRange = document.getElementById('filterZeitRange').value;

            // Get current month boundaries
            const now = new Date();
            const currentMonthStart = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
            const lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1).toISOString().split('T')[0];
            const lastMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0).toISOString().split('T')[0];

            // Filter records
            let filtered = allZeiterfassungen.filter(zeit => {
                // Filter by mitarbeiter
                if (selectedMitarbeiterId && String(zeit.mitarbeiterId) !== String(selectedMitarbeiterId)) {
                    return false;
                }

                // Filter by date range
                if (selectedRange === 'current' && zeit.datum < currentMonthStart) {
                    return false;
                } else if (selectedRange === 'last' && (zeit.datum < lastMonthStart || zeit.datum > lastMonthEnd)) {
                    return false;
                }

                return true;
            });

            // Render table (desktop) and cards (mobile)
            renderZeiterfassung(filtered);
            renderZeitCards(filtered);
        }

        /**
         * Render zeiterfassung table
         */
        function renderZeiterfassung(zeiterfassungen) {
            const tbody = document.getElementById('zeiterfassungTableBody');

            if (zeiterfassungen.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: var(--color-text-secondary);">
                            Keine Zeiterfassungen gefunden
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = zeiterfassungen.map(zeit => {
                const events = zeit.events || [];

                // Extract event times
                const startEvent = events.find(e => e.type === 'start');
                const pauseEvents = events.filter(e => e.type === 'pause_start' || e.type === 'pause_end');
                const endEvent = events.find(e => e.type === 'end');

                const startTime = startEvent ? new Date(startEvent.timestamp).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }) : '-';
                const endTime = endEvent ? new Date(endEvent.timestamp).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }) : '-';

                // Format pause times
                let pauseText = '-';
                if (pauseEvents.length > 0) {
                    const pausePairs = [];
                    for (let i = 0; i < pauseEvents.length; i += 2) {
                        if (pauseEvents[i] && pauseEvents[i + 1]) {
                            const pStart = new Date(pauseEvents[i].timestamp).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                            const pEnd = new Date(pauseEvents[i + 1].timestamp).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                            pausePairs.push(`${pStart}-${pEnd}`);
                        }
                    }
                    if (pausePairs.length > 0) {
                        pauseText = pausePairs.join(', ');
                    }
                }

                // Status badge
                const status = zeit.status || 'unknown';
                const statusBadge = status === 'completed'
                    ? '<span class="badge badge-success">Abgeschlossen</span>'
                    : '<span class="badge badge-warning">In Arbeit</span>';

                // Manually edited marker
                const manuallyEdited = zeit.manuallyEdited || false;
                const editMarker = manuallyEdited ? ' <span style="color: #FF9800;">*</span>' : '';

                // Hours
                const hours = zeit.calculatedHours || 0;

                return `
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <td>${zeit.mitarbeiterName}${editMarker}</td>
                        <td>${zeit.datum}</td>
                        <td>${startTime}</td>
                        <td style="font-size: 12px;">${pauseText}</td>
                        <td>${endTime}</td>
                        <td><span class="badge badge-info">${hours.toFixed(2)}h</span></td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" style="padding: 6px 12px; font-size: 12px;" onclick="openEditZeitModal('${zeit.id}')">
                                ‚úèÔ∏è Bearbeiten
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ============================================
        // ZEITERFASSUNG MOBILE CARDS
        // ============================================
        function renderZeitCards(zeiterfassungen) {
            const cardsContainer = document.getElementById('zeitCardsContainer');

            if (zeiterfassungen.length === 0) {
                cardsContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--color-text-secondary);">
                        Keine Zeiterfassungen gefunden
                    </div>
                `;
                return;
            }

            cardsContainer.innerHTML = zeiterfassungen.map(zeit => {
                const events = zeit.events || [];

                // Extract event times
                const startEvent = events.find(e => e.type === 'start');
                const pauseEvents = events.filter(e => e.type === 'pause_start' || e.type === 'pause_end');
                const endEvent = events.find(e => e.type === 'end');

                const startTime = startEvent ? new Date(startEvent.timestamp).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }) : '-';
                const endTime = endEvent ? new Date(endEvent.timestamp).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }) : '-';

                // Format pause times
                let pauseText = '-';
                if (pauseEvents.length > 0) {
                    const pausePairs = [];
                    for (let i = 0; i < pauseEvents.length; i += 2) {
                        if (pauseEvents[i] && pauseEvents[i + 1]) {
                            const pStart = new Date(pauseEvents[i].timestamp).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                            const pEnd = new Date(pauseEvents[i + 1].timestamp).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
                            pausePairs.push(`${pStart}-${pEnd}`);
                        }
                    }
                    if (pausePairs.length > 0) {
                        pauseText = pausePairs.join(', ');
                    }
                }

                // Status
                const status = zeit.status || 'unknown';
                let statusClass = 'abgeschlossen';
                let statusText = '‚úì Abgeschlossen';
                if (status === 'working') {
                    statusClass = 'arbeitet';
                    statusText = 'üíº Arbeitet';
                } else if (status === 'pause') {
                    statusClass = 'pause';
                    statusText = '‚è∏Ô∏è Pause';
                }

                // Manually edited marker
                const manuallyEdited = zeit.manuallyEdited || false;
                const editMarker = manuallyEdited ? ' *' : '';

                // Hours
                const hours = zeit.calculatedHours || 0;

                // Format date
                const datumFormatted = new Date(zeit.datum).toLocaleDateString('de-DE', {
                    weekday: 'short',
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });

                return `
                    <div class="zeit-card">
                        <div class="zeit-card-header">
                            <div class="zeit-card-date">${datumFormatted}</div>
                            <div class="zeit-card-status ${statusClass}">${statusText}</div>
                        </div>

                        <div style="margin-bottom: 12px; padding: 10px; background: rgba(255, 255, 255, 0.03); border-radius: 8px; border: 1px solid var(--color-border-glass);">
                            <div style="font-size: 11px; color: var(--color-text-secondary); text-transform: uppercase; font-weight: 600; margin-bottom: 4px;">üë§ Mitarbeiter</div>
                            <div style="font-size: 16px; color: var(--color-text-primary); font-weight: 600;">${zeit.mitarbeiterName}${editMarker}</div>
                        </div>

                        <div class="zeit-card-timeline">
                            <div class="zeit-timeline-item">
                                <div class="zeit-timeline-label">‚è±Ô∏è Start</div>
                                <div class="zeit-timeline-value">${startTime}</div>
                            </div>
                            <div class="zeit-timeline-item">
                                <div class="zeit-timeline-label">‚èπÔ∏è Ende</div>
                                <div class="zeit-timeline-value">${endTime}</div>
                            </div>
                        </div>

                        <div class="zeit-card-hours">
                            <div class="zeit-hour-item">
                                <div class="zeit-hour-label">‚è∏Ô∏è Pausen</div>
                                <div class="zeit-hour-value" style="font-size: 13px;">${pauseText}</div>
                            </div>
                            <div class="zeit-hour-item">
                                <div class="zeit-hour-label">‚è∞ Gesamt</div>
                                <div class="zeit-hour-value">${hours.toFixed(2)}h</div>
                            </div>
                        </div>

                        <div class="zeit-card-actions">
                            <button class="btn btn-primary" onclick="openEditZeitModal('${zeit.id}')">
                                ‚úèÔ∏è Bearbeiten
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            console.log('‚úÖ Zeit Mobile Cards gerendert mit', zeiterfassungen.length, 'Eintr√§gen');
        }

        /**
         * Open edit modal for zeiterfassung
         */
        function openEditZeitModal(zeitId) {
            const zeit = allZeiterfassungen.find(z => String(z.id) === String(zeitId));
            if (!zeit) {
                showToast('‚ùå Zeiterfassung nicht gefunden', 'error', 3000);
                return;
            }

            currentEditZeit = zeit;

            // Populate info
            document.getElementById('editZeitMitarbeiterName').textContent = zeit.mitarbeiterName || '-';
            document.getElementById('editZeitDatum').textContent = zeit.datum || '-';
            document.getElementById('editZeitStunden').textContent = (zeit.calculatedHours || 0).toFixed(2);

            // Extract events
            const events = zeit.events || [];
            const startEvent = events.find(e => e.type === 'start');
            const endEvent = events.find(e => e.type === 'end');
            const pauseEvents = events.filter(e => e.type === 'pause_start' || e.type === 'pause_end');

            // Populate start time
            if (startEvent) {
                const startTime = new Date(startEvent.timestamp);
                document.getElementById('editZeitStart').value =
                    `${String(startTime.getHours()).padStart(2, '0')}:${String(startTime.getMinutes()).padStart(2, '0')}`;
            }

            // Populate end time
            if (endEvent) {
                const endTime = new Date(endEvent.timestamp);
                document.getElementById('editZeitEnd').value =
                    `${String(endTime.getHours()).padStart(2, '0')}:${String(endTime.getMinutes()).padStart(2, '0')}`;
            } else {
                document.getElementById('editZeitEnd').value = '';
            }

            // Populate pause events
            const pausenContainer = document.getElementById('editZeitPausenContainer');
            pausenContainer.innerHTML = '';

            if (pauseEvents.length > 0) {
                for (let i = 0; i < pauseEvents.length; i += 2) {
                    if (pauseEvents[i] && pauseEvents[i + 1]) {
                        const pauseStart = new Date(pauseEvents[i].timestamp);
                        const pauseEnd = new Date(pauseEvents[i + 1].timestamp);

                        const pauseDiv = document.createElement('div');
                        pauseDiv.style.cssText = 'background: rgba(255, 152, 0, 0.1); border-radius: 8px; padding: 15px; margin-bottom: 10px;';
                        pauseDiv.innerHTML = `
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--color-text-primary);">
                                ‚è∏Ô∏è Pause ${Math.floor(i / 2) + 1}
                            </label>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <div style="flex: 1;">
                                    <label style="font-size: 12px; color: var(--color-text-secondary);">Start</label>
                                    <input type="time" id="editZeitPauseStart${i}" data-pause-index="${i}"
                                           value="${String(pauseStart.getHours()).padStart(2, '0')}:${String(pauseStart.getMinutes()).padStart(2, '0')}"
                                           style="width: 100%; padding: 8px; border: 2px solid rgba(255, 152, 0, 0.3); border-radius: 6px; font-size: 14px;">
                                </div>
                                <div style="flex: 1;">
                                    <label style="font-size: 12px; color: var(--color-text-secondary);">Ende</label>
                                    <input type="time" id="editZeitPauseEnd${i}" data-pause-index="${i}"
                                           value="${String(pauseEnd.getHours()).padStart(2, '0')}:${String(pauseEnd.getMinutes()).padStart(2, '0')}"
                                           style="width: 100%; padding: 8px; border: 2px solid rgba(255, 152, 0, 0.3); border-radius: 6px; font-size: 14px;">
                                </div>
                            </div>
                        `;
                        pausenContainer.appendChild(pauseDiv);
                    }
                }
            }

            // Show modal
            document.getElementById('editZeitModal').style.display = 'block';
        }

        /**
         * Close edit zeit modal
         */
        function closeEditZeitModal() {
            document.getElementById('editZeitModal').style.display = 'none';
            currentEditZeit = null;
        }

        /**
         * Save edited zeiterfassung
         */
        async function saveEditZeit() {
            if (!currentEditZeit) return;

            try {
                const datum = currentEditZeit.datum;

                // Parse edited times
                const startTimeStr = document.getElementById('editZeitStart').value;
                const endTimeStr = document.getElementById('editZeitEnd').value;

                if (!startTimeStr) {
                    showToast('‚ùå Arbeitsbeginn ist erforderlich', 'error', 3000);
                    return;
                }

                // Build new events array
                const newEvents = [];

                // Start event
                const [startH, startM] = startTimeStr.split(':').map(Number);
                const startTimestamp = new Date(`${datum}T${startTimeStr}:00`).getTime();
                newEvents.push({
                    type: 'start',
                    timestamp: startTimestamp
                });

                // Pause events
                const pauseInputs = document.getElementById('editZeitPausenContainer').querySelectorAll('input[type="time"]');
                for (let i = 0; i < pauseInputs.length; i += 2) {
                    const pauseStartInput = pauseInputs[i];
                    const pauseEndInput = pauseInputs[i + 1];

                    if (pauseStartInput && pauseEndInput && pauseStartInput.value && pauseEndInput.value) {
                        newEvents.push({
                            type: 'pause_start',
                            timestamp: new Date(`${datum}T${pauseStartInput.value}:00`).getTime()
                        });
                        newEvents.push({
                            type: 'pause_end',
                            timestamp: new Date(`${datum}T${pauseEndInput.value}:00`).getTime()
                        });
                    }
                }

                // End event
                if (endTimeStr) {
                    const endTimestamp = new Date(`${datum}T${endTimeStr}:00`).getTime();
                    newEvents.push({
                        type: 'end',
                        timestamp: endTimestamp
                    });
                }

                // Recalculate hours
                const calculatedHours = calculateHoursFromEvents(newEvents);

                // Update Firestore
                await window.getCollection('zeiterfassung').doc(currentEditZeit.id).update({
                    events: newEvents,
                    calculatedHours: calculatedHours,
                    manuallyEdited: true, // Mark as manually edited
                    lastEditedAt: new Date().toISOString(),
                    lastEditedBy: window.currentUser?.uid || 'admin'
                });

                showToast('‚úÖ Zeiterfassung erfolgreich aktualisiert', 'success', 3000);

                // Reload zeiterfassungen
                await loadZeiterfassungen();

                // Update mitarbeiter IST hours if this is a completed entry
                if (currentEditZeit.status === 'completed') {
                    await updateMitarbeiterIstStundenAdmin(currentEditZeit.mitarbeiterId);
                }

                closeEditZeitModal();

            } catch (error) {
                console.error('‚ùå Fehler beim Speichern der Zeiterfassung:', error);
                showToast('‚ùå Fehler beim Speichern: ' + error.message, 'error', 5000);
            }
        }

        /**
         * Calculate hours from events array (same logic as in mitarbeiter-dienstplan.html)
         */
        function calculateHoursFromEvents(events) {
            let totalWorkedMs = 0;
            let totalBreakMs = 0;
            let lastEventTime = null;
            let lastEventType = null;

            for (const event of events) {
                const eventTime = event.timestamp;

                if (event.type === 'start') {
                    lastEventTime = eventTime;
                    lastEventType = 'working';
                } else if (event.type === 'pause_start') {
                    if (lastEventType === 'working') {
                        totalWorkedMs += eventTime - lastEventTime;
                    }
                    lastEventTime = eventTime;
                    lastEventType = 'break';
                } else if (event.type === 'pause_end') {
                    if (lastEventType === 'break') {
                        totalBreakMs += eventTime - lastEventTime;
                    }
                    lastEventTime = eventTime;
                    lastEventType = 'working';
                } else if (event.type === 'end') {
                    if (lastEventType === 'working') {
                        totalWorkedMs += eventTime - lastEventTime;
                    }
                    lastEventTime = eventTime;
                    lastEventType = 'ended';
                }
            }

            return Math.round((totalWorkedMs / (1000 * 60 * 60)) * 100) / 100;
        }

        /**
         * Update mitarbeiter IST hours after admin edit
         */
        async function updateMitarbeiterIstStundenAdmin(mitarbeiterId) {
            try {
                // Load mitarbeiter document
                const mitarbeiterDoc = await window.getCollection('mitarbeiter').doc(String(mitarbeiterId)).get();
                if (!mitarbeiterDoc.exists) {
                    console.warn('Mitarbeiter nicht gefunden:', mitarbeiterId);
                    return;
                }

                const mitarbeiterData = mitarbeiterDoc.data();
                const sollStundenGesamt = mitarbeiterData.gesamtstunden || 0;
                const sollStundenMonatlich = mitarbeiterData.monatlicheStunden || 0;

                // Load ALL completed zeiterfassung for this mitarbeiter
                const zeitSnapshot = await window.getCollection('zeiterfassung')
                    .where('mitarbeiterId', '==', String(mitarbeiterId))
                    .where('status', '==', 'completed')
                    .get();

                let istStundenGesamt = 0;
                let istStundenMonatlich = 0;

                const now = new Date();
                const currentMonthStart = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];

                zeitSnapshot.docs.forEach(doc => {
                    const zeitData = doc.data();
                    const hours = zeitData.calculatedHours || 0;
                    istStundenGesamt += hours;

                    if (zeitData.datum >= currentMonthStart) {
                        istStundenMonatlich += hours;
                    }
                });

                // Calculate differenz
                const differenzGesamt = istStundenGesamt - sollStundenGesamt;
                const differenzMonatlich = istStundenMonatlich - sollStundenMonatlich;

                // Update mitarbeiter document
                await window.getCollection('mitarbeiter').doc(String(mitarbeiterId)).update({
                    istStundenGesamt,
                    istStundenMonatlich,
                    differenzStunden: differenzGesamt,
                    differenzStundenMonatlich: differenzMonatlich,
                    lastIstUpdate: new Date().toISOString()
                });

                console.log(`‚úÖ Mitarbeiter ${mitarbeiterId} IST-Stunden aktualisiert`);

            } catch (error) {
                console.error('‚ùå Fehler beim Update der IST-Stunden:', error);
            }
        }

        // Auto-load vacation requests on page load (if werkstattId available)
        if (window.werkstattId) {
            // Initial load after 2 seconds (give time for mitarbeiter to load)
            setTimeout(() => {
                loadUrlaubsAnfragen();
            }, 2000);
        }
    </script>
</body>
</html>
