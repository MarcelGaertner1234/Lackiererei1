<!DOCTYPE html>
<html lang="de">
<head>
    <!-- werkstattId will be set dynamically by auth-manager.js after login -->
    <script>
        // window.werkstattId is set automatically after successful login
        // This ensures proper multi-tenant data isolation
    </script>
    <script>
        // âœ… BUG #5 FIX: Global DEBUG flag for conditional logging
        window.DEBUG = (
            localStorage.getItem('DEBUG') === 'true' ||
            window.location.search.includes('debug=true') ||
            window.location.hostname === 'localhost' ||
            window.location.port === '8000'
        );
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kundenverwaltung | Auto-Lackierzentrum Mosbach</title>

    <!-- Mobile-Responsive CSS Framework -->
    <link rel="stylesheet" href="mobile-responsive.css">

    <!-- Apple Liquid Glass Design System -->
    <link rel="stylesheet" href="design-system.css">
    <link rel="stylesheet" href="components.css">
    <link rel="stylesheet" href="animations.css">
    <link rel="stylesheet" href="mobile-first.css">
    <link rel="stylesheet" href="css/ai-chat-widget.css">
    <link rel="stylesheet" href="css/quota-display.css">
    <link rel="stylesheet" href="css/skeleton.css"> <!-- ðŸ†• Skeleton Loaders -->

    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>

    <!-- GSAP Animation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', 'Inter', var(--font-system);
            background: var(--color-background);
            min-height: 100vh;
            padding: var(--space-6) var(--space-4) 100px;
            color: var(--color-text-primary);
            transition: background 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
            position: relative;
        }

        /* ðŸŽ¨ Marken-Charakter: Dezentes Reflex-Pattern (Lack-OberflÃ¤che) */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 50px,
                rgba(255, 255, 255, 0.02) 50px,
                rgba(255, 255, 255, 0.02) 51px
            );
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;

            /* Glassmorphismus - Apple Liquid Glass Style */
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);

            padding: var(--space-8);
            position: relative;
            overflow: hidden;

            /* âœ¨ Page-Transition: Slide-In beim Laden */
            animation: slideIn 0.4s cubic-bezier(0.22, 1, 0.36, 1);
        }

        /* ðŸŽ¬ Page-Transition Animation */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ðŸŽ¬ Page-Transition Overlay (fÃ¼r Navigation) */
        .page-transition-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 9999;
        }

        .page-transition-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        /* Top Shine Effect (Apple-Style Specular Highlight) */
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%);
            opacity: 0.5;
        }

        /* ðŸ“± MOBILE MINIMIZATION - 20-30% kleiner! */
        @media (max-width: 768px) {
            /* Body & Container - kompakter */
            body {
                padding: 8px;  /* 10px â†’ 8px (20% kleiner) */
            }

            .container {
                padding: 12px;  /* 15px â†’ 12px (20% kleiner) */
                border-radius: 12px;  /* 15px â†’ 12px */
            }

            /* ðŸ“Š Stats Cards - AGGRESSIV minimiert! */
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));  /* 160px â†’ 140px */
                gap: 8px;  /* var(--space-2) â†’ 8px (kleiner) */
                margin-bottom: 16px;  /* Kompakter */
            }

            .hero-card--stat {
                min-height: 90px;  /* 120px â†’ 90px (25% kleiner!) */
                padding: 10px;  /* 12px â†’ 10px (17% kleiner) */
            }

            /* Icon - kleiner */
            .hero-card__icon i {
                width: 16px;  /* 20px â†’ 16px (20% kleiner) */
                height: 16px;
            }

            /* Stat Number - deutlich kleiner */
            .stat-number {
                font-size: 28px;  /* 36px â†’ 28px (22% kleiner!) */
                line-height: 1;
            }

            /* Label - kleiner */
            .stat-label {
                font-size: 11px;  /* 13px â†’ 11px (15% kleiner) */
                margin-top: 3px;  /* 4px â†’ 3px */
            }

            /* Subtitle - minimalistisch */
            .stat-subtitle {
                font-size: 10px;  /* 11px â†’ 10px */
            }

            /* ðŸ“‘ Header - kompakter */
            .header {
                margin-bottom: 20px;  /* 30px â†’ 20px (33% kleiner) */
                padding-bottom: 12px;  /* 20px â†’ 12px (40% kleiner) */
                gap: 10px;  /* 15px â†’ 10px */
            }

            .header h1 {
                font-size: 22px;  /* 28px â†’ 22px (21% kleiner!) */
            }

            /* ðŸ”˜ Buttons - kleiner */
            .btn,
            .nav-btn {
                padding: 8px 14px;  /* 10px 18px â†’ 8px 14px (20% kleiner) */
                font-size: 12px;  /* 14px â†’ 12px (14% kleiner) */
            }

            .btn-primary,
            .btn-secondary,
            .btn-success {
                padding: 8px 14px;
                font-size: 12px;
            }

            /* View Toggle Buttons - kleiner */
            .view-toggle {
                gap: 6px;  /* 8px â†’ 6px */
            }

            .view-toggle button {
                padding: 6px 10px;  /* 8px 14px â†’ 6px 10px (25% kleiner) */
                font-size: 12px;  /* 13px â†’ 12px */
            }

            .view-toggle button i {
                width: 14px;  /* 16px â†’ 14px */
                height: 14px;
            }

            /* Filter/Search - kompakter */
            .filters,
            .search-box {
                gap: 8px;  /* 10px â†’ 8px */
            }

            .search-box input {
                padding: 8px 12px;  /* 10px 15px â†’ 8px 12px */
                font-size: 13px;  /* 14px â†’ 13px */
            }

            /* Modal - kompakter */
            .modal-content {
                padding: 16px;  /* 20px â†’ 16px (20% kleiner) */
                max-width: calc(100vw - 24px);  /* Mehr sichtbarer Rand */
            }

            .modal h2 {
                font-size: 20px;  /* 24px â†’ 20px (17% kleiner) */
                margin-bottom: 12px;  /* 16px â†’ 12px */
            }
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #003366;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            color: #003366;
            font-size: 28px;
            font-weight: 500;                /* âœ¨ Apple-Style: leichter */
            letter-spacing: 0.3px;           /* âœ¨ Apple-typisch */
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }

        /* âœ¨ Logo-Glare-Sweep (beim Laden) */
        .header h1::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 50px;
            height: 100%;
            background: linear-gradient(90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent
            );
            animation: glare-sweep 1.5s ease-out 0.5s;
        }

        @keyframes glare-sweep {
            0% { left: -100%; }
            100% { left: 200%; }
        }

        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.22, 1, 0.36, 1); /* âœ¨ Apple-Schwung! */
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px) scale(1.02);  /* âœ¨ ZusÃ¤tzlich: scale */
            box-shadow: 0 10px 25px rgba(102,126,234,0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px) scale(1.02);  /* âœ¨ ZusÃ¤tzlich: scale */
            box-shadow: 0 10px 25px rgba(17,153,142,0.4);
        }

        /* ðŸŽ´ Stats Cards Grid - ULTRA-KOMPAKT & MINIMALISTISCH */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: var(--space-2); /* ULTRA-KOMPAKT! */
            margin-bottom: var(--space-8);
        }

        /* ðŸ“Š Modifier: Stat Card - ULTRA-MINIMAL DESIGN */
        .hero-card--stat {
            padding: var(--space-3); /* 12px - ULTRA-KOMPAKT! */
            text-align: center;
            cursor: default;
            min-height: 120px; /* 120px - MINIMAL! */
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* Icon Container (minimal) */
        .hero-card__icon {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: var(--space-1); /* Minimaler Abstand */
        }

        .hero-card__icon i {
            width: 20px;  /* Klein & fein */
            height: 20px;
            color: var(--color-primary);
            filter: drop-shadow(0 2px 4px rgba(0,191,255,0.3));
        }

        /* Stat Value Container - ganz eng */
        .stat-value {
            margin: var(--space-1) 0 0 0; /* Minimaler Abstand */
        }

        /* Stat-Zahl - kompakt & lesbar */
        .stat-number {
            font-size: 36px; /* 36px - perfekte Balance */
            font-weight: 600;                /* âœ¨ 700â†’600: Apple-Style leichter */
            letter-spacing: 0.3px;           /* âœ¨ Headlines-Spacing */
            color: var(--color-text-primary);
            display: block;
            line-height: 1.1;
        }

        /* Label unter der Zahl */
        .stat-label {
            font-size: 13px; /* Etwas kleiner */
            font-weight: 600;
            color: var(--color-text-secondary);
            opacity: 0.8;
            margin-top: 4px; /* Fester Mini-Wert */
        }

        /* Kleingedruckte Zusatzinfo */
        .stat-subtitle {
            font-size: 11px; /* Kleiner */
            color: var(--color-text-secondary);
            opacity: 0.6;
            margin-top: 2px; /* Minimal! */
        }

        /* ðŸŒ™ DARK MODE: Stats Cards heller & besser sichtbar */
        [data-theme="dark"] .hero-card--stat {
            background: rgba(255, 255, 255, 0.12); /* Heller als Default 0.08 */
            border: 1px solid rgba(255, 255, 255, 0.2); /* StÃ¤rkerer Border */
            box-shadow:
                inset 0 1px 0 rgba(255,255,255,0.3),
                0 8px 24px rgba(0,0,0,0.5); /* StÃ¤rkere Schatten */
        }

        [data-theme="dark"] .hero-card--stat:hover {
            background: rgba(255, 255, 255, 0.16); /* Noch heller beim Hover */
            box-shadow:
                inset 0 1px 0 rgba(255,255,255,0.35),
                0 12px 32px rgba(0,0,0,0.6);
        }

        /* Icon-Glow im Dark Mode */
        [data-theme="dark"] .hero-card__icon i {
            filter: drop-shadow(0 2px 6px rgba(46, 200, 255, 0.5)); /* StÃ¤rkerer Glow */
        }

        .umsatz-filter {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 15px;
            background: #fff;
            border-radius: 10px;
            border: 2px solid #003366;
        }

        .umsatz-filter .filter-btn {
            padding: 8px 15px;
            border: 2px solid #003366;
            background: white;
            color: #003366;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .umsatz-filter .filter-btn:hover {
            background: #003366;
            color: white;
            transform: translateY(-2px);
        }

        .umsatz-filter .filter-btn.active {
            background: #003366;
            color: white;
        }

        /* âŒ Removed old .stat-number and .stat-label - now using Hero Card styles */

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102,126,234,0.2);
        }

        .kunden-table {
            width: 100%;
            min-width: 900px; /* Tabelle darf grÃ¶ÃŸer als Container sein fÃ¼r Scroll */
            border-collapse: collapse;
            margin-top: 20px;
        }

        .kunden-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .kunden-table th {
            padding: 10px; /* Reduziert von 15px fÃ¼r mehr Platz */
            text-align: left;
            font-weight: 600;
            white-space: nowrap; /* Verhindert Umbruch in Header */
        }

        .kunden-table td {
            padding: 10px; /* Reduziert von 15px fÃ¼r mehr Platz */
            border-bottom: 1px solid #eee;
        }

        /* Kritische Spalten: Kein Umbruch */
        .kunden-table td:nth-child(1), /* Kundenname */
        .kunden-table td:nth-child(5)  /* Letzter Besuch */
        {
            white-space: nowrap;
        }

        .kunden-table tbody tr {
            transition: all 0.3s;
        }

        .kunden-table tbody tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .action-btns {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .modal-header h2 {
            color: #003366;
            font-size: 24px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 30px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: #f0f0f0;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #003366;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102,126,234,0.1);
        }

        .historie-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }

        .historie-section h3 {
            color: #003366;
            margin-bottom: 15px;
        }

        .historie-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .historie-date {
            color: #666;
            font-size: 13px;
            margin-bottom: 5px;
        }

        .historie-details {
            color: #333;
            font-weight: 500;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        /* Table Container - Horizontal Scroll fÃ¼r breite Tabellen */
        .kunden-table-container {
            overflow-x: auto;
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        /* Custom Scrollbar Styling */
        .kunden-table-container::-webkit-scrollbar {
            height: 8px;
        }

        .kunden-table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .kunden-table-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        .kunden-table-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Tabelle ohne extra margin-top (wird vom Container Ã¼bernommen) */
        .kunden-table-container .kunden-table {
            margin-top: 0;
        }

        /* ðŸŒ™ DARK MODE: Modal Styles fÃ¼r Kunden-Details */
        [data-theme="dark"] .modal-content {
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
        }

        [data-theme="dark"] .modal-header {
            border-bottom-color: rgba(255, 255, 255, 0.1);
        }

        [data-theme="dark"] .modal-header h2 {
            color: rgba(255, 255, 255, 0.95);
        }

        [data-theme="dark"] .close-btn {
            color: rgba(255, 255, 255, 0.7);
        }

        [data-theme="dark"] .close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.95);
        }

        [data-theme="dark"] .form-group label {
            color: rgba(255, 255, 255, 0.9);
        }

        [data-theme="dark"] .form-group input,
        [data-theme="dark"] .form-group textarea {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.9);
        }

        [data-theme="dark"] .form-group input:focus,
        [data-theme="dark"] .form-group textarea:focus {
            border-color: rgba(102, 126, 234, 0.6);
            background: rgba(255, 255, 255, 0.08);
        }

        [data-theme="dark"] .form-group p {
            color: rgba(255, 255, 255, 0.85);
        }

        [data-theme="dark"] .form-group p strong {
            color: rgba(255, 255, 255, 0.95);
        }

        [data-theme="dark"] .historie-section {
            border-top-color: rgba(255, 255, 255, 0.1);
        }

        [data-theme="dark"] .historie-section h3 {
            color: rgba(255, 255, 255, 0.95);
        }

        [data-theme="dark"] .historie-item {
            background: rgba(255, 255, 255, 0.05);
            border-left-color: rgba(102, 126, 234, 0.8);
        }

        [data-theme="dark"] .historie-date {
            color: rgba(255, 255, 255, 0.6);
        }

        [data-theme="dark"] .historie-details {
            color: rgba(255, 255, 255, 0.85);
        }

        [data-theme="dark"] .empty-state {
            color: rgba(255, 255, 255, 0.5);
        }

        /* ðŸŒ™ DARK MODE: Partner-Code Section */
        [data-theme="dark"] #partnerAccessInfo {
            background: rgba(65, 105, 225, 0.1) !important;
            border-color: rgba(65, 105, 225, 0.4) !important;
        }

        [data-theme="dark"] #partnerAccessInfo label {
            color: rgba(135, 206, 250, 0.95) !important;
        }

        [data-theme="dark"] .partner-access-box {
            background: rgba(255, 255, 255, 0.05) !important;
        }

        [data-theme="dark"] .partner-access-box p {
            color: rgba(255, 255, 255, 0.7) !important;
        }

        [data-theme="dark"] .partner-access-box strong {
            color: rgba(255, 255, 255, 0.9) !important;
        }

        [data-theme="dark"] .partner-access-box span {
            color: rgba(255, 255, 255, 0.85) !important;
        }

        [data-theme="dark"] #partnerPasswordNotChanged {
            background: rgba(255, 193, 7, 0.15) !important;
            border-left-color: rgba(255, 193, 7, 0.6) !important;
        }

        [data-theme="dark"] #partnerPasswordNotChanged p {
            color: rgba(255, 215, 115, 0.95) !important;
        }

        [data-theme="dark"] #partnerPasswordNotChanged code {
            background: rgba(255, 255, 255, 0.08) !important;
            border-color: rgba(255, 193, 7, 0.4) !important;
            color: rgba(255, 255, 255, 0.95) !important;
        }

        [data-theme="dark"] #partnerPasswordChanged {
            background: rgba(40, 167, 69, 0.15) !important;
            border-left-color: rgba(40, 167, 69, 0.6) !important;
        }

        [data-theme="dark"] #partnerPasswordChanged p {
            color: rgba(144, 238, 144, 0.95) !important;
        }

        [data-theme="dark"] #partnerAccountNotCreated {
            background: rgba(33, 150, 243, 0.15) !important;
            border-left-color: rgba(33, 150, 243, 0.6) !important;
        }

        [data-theme="dark"] #partnerAccountNotCreated p {
            color: rgba(135, 206, 250, 0.95) !important;
        }

        /* ðŸŒ™ DARK MODE: B2B Rabatt-Konditionen Container */
        [data-theme="dark"] .form-group[style*="border-top: 2px solid"] {
            border-top-color: rgba(255, 255, 255, 0.1) !important;
        }

        /* Rabatt-Stufen Container (grauer Hintergrund) */
        [data-theme="dark"] .form-group > div[style*="background: #f5f5f5"] {
            background: rgba(255, 255, 255, 0.03) !important;
        }

        /* Rabatt-Stufen Boxen (weiÃŸe Karten) */
        [data-theme="dark"] .form-group > div[style*="background: #f5f5f5"] > div > div[style*="background: white"] {
            background: rgba(255, 255, 255, 0.05) !important;
        }

        /* Stufen-Titel (STUFE 1, STUFE 2, STUFE 3) */
        [data-theme="dark"] .form-group > div[style*="background: #f5f5f5"] > div > div[style*="background: white"] > div[style*="font-weight: 600"] {
            color: rgba(255, 255, 255, 0.8) !important;
        }

        /* STUFE 2 (Stammkunde) - grÃ¼ner Text bleibt grÃ¼n */
        [data-theme="dark"] .form-group > div[style*="background: #f5f5f5"] > div > div[style*="border: 2px solid #4caf50"] > div[style*="color: #4caf50"] {
            color: rgba(76, 175, 80, 0.95) !important;
        }

        /* STUFE 3 (VIP) - oranger Text bleibt orange */
        [data-theme="dark"] .form-group > div[style*="background: #f5f5f5"] > div > div[style*="border: 2px solid #ff9800"] > div[style*="color: #ff9800"] {
            color: rgba(255, 152, 0, 0.95) !important;
        }

        /* Spans innerhalb der Rabatt-Boxen (%, â‚¬/Monat, etc.) */
        [data-theme="dark"] .form-group > div[style*="background: #f5f5f5"] span {
            color: rgba(255, 255, 255, 0.75) !important;
        }

        /* Input Fields innerhalb der Rabatt-Boxen */
        [data-theme="dark"] #rabattStufe1Prozent,
        [data-theme="dark"] #rabattStufe1Ab,
        [data-theme="dark"] #rabattStufe1Bonus,
        [data-theme="dark"] #rabattStufe2Prozent,
        [data-theme="dark"] #rabattStufe2Ab,
        [data-theme="dark"] #rabattStufe2Bonus,
        [data-theme="dark"] #rabattStufe3Prozent,
        [data-theme="dark"] #rabattStufe3Ab,
        [data-theme="dark"] #rabattStufe3Bonus {
            background: rgba(255, 255, 255, 0.08) !important;
            border-color: rgba(255, 255, 255, 0.2) !important;
            color: rgba(255, 255, 255, 0.95) !important;
        }

        /* Hinweis-Box (gelber Hintergrund) */
        [data-theme="dark"] .form-group > div[style*="background: #f5f5f5"] > div[style*="background: #fff3cd"] {
            background: rgba(255, 193, 7, 0.15) !important;
            color: rgba(255, 215, 115, 0.95) !important;
        }

        /* Konditionen-Box (orange Border) */
        [data-theme="dark"] .form-group > div[style*="background: #fff3e0"] {
            background: rgba(255, 152, 0, 0.1) !important;
            border-color: rgba(255, 152, 0, 0.4) !important;
        }

        [data-theme="dark"] .form-group > div[style*="background: #fff3e0"] label span {
            color: rgba(255, 183, 77, 0.95) !important;
        }

        [data-theme="dark"] .form-group > div[style*="background: #fff3e0"] p {
            color: rgba(255, 255, 255, 0.8) !important;
        }

        [data-theme="dark"] #konditionenDatum {
            background: rgba(255, 255, 255, 0.08) !important;
            border-color: rgba(255, 255, 255, 0.2) !important;
            color: rgba(255, 255, 255, 0.95) !important;
        }

        /* Warning Box unter Rabatt-Konditionen */
        [data-theme="dark"] .form-group > div[style*="background: #ffebee"] {
            background: rgba(255, 59, 48, 0.1) !important;
            border-color: rgba(255, 59, 48, 0.4) !important;
        }

        [data-theme="dark"] .form-group > div[style*="background: #ffebee"] p {
            color: rgba(255, 100, 100, 0.95) !important;
        }

        /* Small hints/info text */
        [data-theme="dark"] small[style*="color: #666"],
        [data-theme="dark"] small[style*="color: #999"] {
            color: rgba(255, 255, 255, 0.6) !important;
        }

        /* ðŸŒ™ DARK MODE: Tabellen dunkler & besser lesbar */
        [data-theme="dark"] .kunden-table-container {
            background: rgba(255, 255, 255, 0.06); /* Sehr dunkler Container */
            border-color: rgba(255, 255, 255, 0.15);
            box-shadow: 0 2px 8px rgba(0,0,0,0.6);
        }

        [data-theme="dark"] .kunden-table {
            background: rgba(255, 255, 255, 0.08); /* Dunkler Tabellen-Hintergrund */
        }

        [data-theme="dark"] .kunden-table thead {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3) 0%, rgba(118, 75, 162, 0.3) 100%);
            color: rgba(255, 255, 255, 0.95);
        }

        [data-theme="dark"] .kunden-table th {
            color: rgba(255, 255, 255, 0.9);
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        }

        [data-theme="dark"] .kunden-table td {
            color: rgba(255, 255, 255, 0.85);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Scrollbar Dark Mode */
        [data-theme="dark"] .kunden-table-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        [data-theme="dark"] .kunden-table-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
        }

        [data-theme="dark"] .kunden-table-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Responsive: Kleinere Schrift auf mittelgroÃŸen Screens */
        @media (max-width: 1200px) {
            .kunden-table {
                font-size: 13px;
            }

            .kunden-table th,
            .kunden-table td {
                padding: 8px; /* Noch kompakter auf kleineren Screens */
            }

            .kunden-table th {
                font-size: 12px;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .kunden-table {
                font-size: 14px;
            }

            .kunden-table th,
            .kunden-table td {
                padding: 10px;
            }

            .nav-bar {
                flex-direction: column;
                gap: 8px;
            }

            .nav-btn {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            /* Container kompakter */
            .container {
                padding: 12px; /* Reduziert von 15px */
            }

            body {
                padding: 8px; /* Reduziert von 10px */
            }

            /* Ãœberschriften kleiner */
            h1 {
                font-size: 18px; /* Reduziert von 24px */
            }

            .header h1 {
                font-size: 20px; /* Reduziert */
            }

            /* Navigation kompakter */
            .nav-btn {
                padding: 8px 10px; /* Reduziert von 10px 12px */
                font-size: 11px; /* Reduziert von 12px */
            }

            /* Statistik-Karten VIEL kompakter */
            .stats {
                grid-template-columns: 1fr;
                gap: 8px; /* Reduziert von 10px */
            }

            .stat-card {
                padding: 10px; /* Reduziert von 15px */
            }

            .stat-number {
                font-size: 20px !important; /* Reduziert von 28px - VIEL KLEINER! */
            }

            .stat-label {
                font-size: 11px; /* Reduziert von 12px */
            }

            .umsatz-filter {
                flex-direction: column;
                align-items: stretch;
            }

            .umsatz-filter .filter-btn {
                width: 100%;
                font-size: 13px;
            }

            /* Tabelle stacken fÃ¼r Mobile */
            .kunden-table-container {
                overflow-x: visible;
            }

            .kunden-table thead {
                display: none;
            }

            /* Kunden-Cards kompakter */
            .kunden-table tbody tr {
                display: block;
                border: 2px solid #003366;
                margin-bottom: 15px; /* Reduziert von 20px */
                padding: 12px; /* Reduziert von 15px */
                border-radius: 10px; /* Reduziert von 12px */
                background: #f9f9f9;
                box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            }

            .kunden-table tbody td {
                display: block;
                text-align: left;
                padding: 7px 0; /* Reduziert von 10px 0 */
                border: none;
                position: relative;
                padding-left: 110px; /* Reduziert von 130px */
                min-height: 30px; /* Reduziert von 40px */
                font-size: 13px; /* Explizit kleiner */
            }

            .kunden-table tbody td::before {
                content: attr(data-label);
                position: absolute;
                left: 0;
                width: 100px; /* Reduziert von 120px */
                font-weight: bold;
                color: #003366;
                font-size: 12px; /* Reduziert von 13px */
            }

            .kunden-table tbody td:last-child {
                padding-left: 0;
                text-align: center;
                margin-top: 10px;
                padding-top: 15px;
                border-top: 1px solid #ddd;
            }

            .kunden-table tbody td:last-child::before {
                display: none;
            }

            /* Buttons kompakter */
            .btn {
                padding: 10px 16px; /* Reduziert von 12px 24px */
                font-size: 13px; /* Reduziert von 16px */
            }

            .btn-small {
                width: 100%;
                min-height: 38px; /* Reduziert von 44px */
                padding: 8px; /* Reduziert von 10px */
                font-size: 12px; /* Reduziert von 13px */
                margin-bottom: 6px; /* Reduziert von 8px */
            }

            /* Charts responsive - kompakter */
            .chart-container {
                position: relative;
                height: 250px; /* Reduziert von 300px */
                margin-bottom: 15px; /* Reduziert von 20px */
            }

            .chart-container canvas {
                max-height: 250px; /* Reduziert von 300px */
            }

            /* Modal kompakter */
            .modal-content {
                width: 95%;
                padding: 15px; /* Reduziert von 20px */
            }

            .kunde-info-item {
                font-size: 12px; /* Reduziert von 13px */
            }
        }

        /* ============================================
           ðŸ“± BOTTOM NAVIGATION BAR (Mobile)
           ============================================ */

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 70px;
            display: none; /* Versteckt auf Desktop */

            /* Apple-Dock-Effekt: Glassmorphismus */
            background: var(--color-surface);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);

            /* Inset Border (Soft-Edge) */
            border-top: 1px solid var(--color-border-glass);
            box-shadow:
                inset 0 1px 0 rgba(255,255,255,0.1),
                0 -4px 16px rgba(0,0,0,0.2);

            /* Layout */
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 0 var(--space-4);
            z-index: 1000;
        }

        .bottom-nav__item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: var(--space-2);
            min-width: 60px;
            text-decoration: none;
            color: var(--color-text-secondary);
            transition: all 0.25s cubic-bezier(0.22, 1, 0.36, 1);
            border-radius: var(--radius-md);
        }

        .bottom-nav__item i {
            width: 24px;
            height: 24px;
        }

        .bottom-nav__item span {
            font-size: 11px;
            font-weight: 500;
        }

        .bottom-nav__item--active {
            color: var(--color-primary);
            background: rgba(46, 200, 255, 0.1);
        }

        .bottom-nav__item:hover {
            color: var(--color-primary);
            transform: translateY(-2px);
        }

        /* ============================================
           âœ¨ FLOATING ACTION BUTTON (Mobile)
           ============================================ */

        .fab {
            position: fixed;
            bottom: 85px; /* Ãœber der Bottom-Nav */
            right: var(--space-4);
            width: 58px;
            height: 58px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: none; /* Versteckt auf Desktop */

            /* Halbtransparent + Glow */
            background: var(--color-primary);
            box-shadow:
                0 4px 16px rgba(46, 200, 255, 0.4),
                0 0 40px rgba(46, 200, 255, 0.2);

            /* Icon */
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;

            /* Animation */
            transition: all 0.25s cubic-bezier(0.22, 1, 0.36, 1);
            z-index: 999;
        }

        .fab i {
            width: 24px;
            height: 24px;
        }

        .fab:hover {
            transform: scale(1.1);
            box-shadow:
                0 6px 20px rgba(46, 200, 255, 0.5),
                0 0 50px rgba(46, 200, 255, 0.3);
        }

        .fab:active {
            transform: scale(0.95);
        }

        /* Touch-Feedback fÃ¼r Cards */
        .hero-card:active,
        .kunde-card:active {
            transform: scale(0.98);
            background: rgba(255,255,255,0.12);
        }

        /* ============================================
           ðŸŒ“ THEME TOGGLE BUTTON (Light/Dark Mode)
           ============================================ */

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;

            /* Glassmorphismus */
            background: var(--color-surface);
            backdrop-filter: blur(12px) saturate(180%);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            border: 1px solid var(--color-border-glass);
            box-shadow: var(--shadow-md);

            /* Interaction */
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.22, 1, 0.36, 1);
            z-index: 9998;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-lg);
        }

        .theme-toggle:active {
            transform: scale(0.95);
        }

        .theme-toggle__icon {
            width: 20px;
            height: 20px;
            color: var(--color-text-primary);
            position: absolute;
            transition: all 0.3s ease;
        }

        /* Light Mode: Zeige Mond-Icon */
        [data-theme="light"] .theme-toggle__icon--light {
            opacity: 0;
            transform: rotate(180deg) scale(0);
        }

        [data-theme="light"] .theme-toggle__icon--dark {
            opacity: 1;
            transform: rotate(0) scale(1);
        }

        /* Dark Mode: Zeige Sonnen-Icon */
        [data-theme="dark"] .theme-toggle__icon--light {
            opacity: 1;
            transform: rotate(0) scale(1);
        }

        [data-theme="dark"] .theme-toggle__icon--dark {
            opacity: 0;
            transform: rotate(-180deg) scale(0);
        }

        /* Zeige Bottom-Nav + FAB nur auf Mobile */
        @media (max-width: 768px) {
            .bottom-nav,
            .fab {
                display: flex;
            }

            /* ðŸŽ¯ HIDE Desktop Navigation on Mobile */
            .nav-bar {
                display: none !important; /* âœ… Ãœberschreibt Desktop-Regel (Zeile 1252) */
            }

            /* Mehr Platz unten fÃ¼r Bottom-Nav (kompakter) */
            body {
                padding-bottom: 75px;  /* 90px â†’ 75px (17% kleiner) */
            }

            /* ðŸŽ¯ BOTTOM-NAV - Minimiert! */
            .bottom-nav {
                height: 60px;  /* 70px â†’ 60px (14% kleiner) */
                padding: 0 var(--space-3);  /* Etwas weniger Padding */
            }

            .bottom-nav__item {
                gap: 3px;  /* 4px â†’ 3px */
                padding: 6px;  /* var(--space-2) â†’ 6px (kleiner) */
                min-width: 54px;  /* 60px â†’ 54px (10% kleiner) */
            }

            .bottom-nav__item i {
                width: 20px;  /* 24px â†’ 20px (17% kleiner!) */
                height: 20px;
            }

            .bottom-nav__item span {
                font-size: 10px;  /* 11px â†’ 10px (9% kleiner) */
            }

            /* âœ¨ FAB - Minimiert! */
            .fab {
                width: 48px;  /* 58px â†’ 48px (17% kleiner!) */
                height: 48px;
                bottom: 75px;  /* 85px â†’ 75px (angepasst an kleinere Bottom-Nav) */
                right: var(--space-3);  /* Etwas nÃ¤her zum Rand */
            }

            .fab i {
                width: 20px;  /* 24px â†’ 20px (17% kleiner!) */
                height: 20px;
            }

            /* Theme Toggle kleiner auf Mobile */
            .theme-toggle {
                width: 40px;
                height: 40px;
                top: 12px;
                right: 12px;
            }

            .theme-toggle__icon {
                width: 18px;
                height: 18px;
            }
        }

        @media (max-width: 320px) {
            .container {
                padding: 10px;
            }

            h1 {
                font-size: 20px;
            }

            .nav-btn {
                padding: 8px 10px;
                font-size: 11px;
            }

            .stat-number {
                font-size: 24px;
            }

            .stat-label {
                font-size: 11px;
            }

            .umsatz-filter .filter-btn {
                padding: 8px 12px;
                font-size: 12px;
            }

            .kunden-table {
                font-size: 11px;
                min-width: 500px;
            }

            .kunden-table th,
            .kunden-table td {
                padding: 6px 4px;
            }

            .btn-small {
                padding: 5px 8px;
                font-size: 10px;
            }

            .modal-content {
                padding: 15px;
            }

            .kunde-info-item {
                font-size: 12px;
            }
        }

        /* Navigation Bar */
        .nav-bar {
            background: var(--color-surface-elevated); /* âœ… CSS Variable statt white */
            padding: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            border-bottom: 3px solid var(--color-primary); /* âœ… CSS Variable statt #4facfe */
            margin-bottom: 20px;
            border-radius: 15px 15px 0 0;
        }

        .nav-btn {
            padding: 10px 20px;
            background: var(--color-primary); /* âœ… CSS Variable statt #4facfe */
            color: white;
            text-decoration: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .nav-btn:hover {
            background: var(--color-primary-hover); /* âœ… CSS Variable statt #2196F3 */
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79,172,254,0.3);
        }

        .nav-btn.active {
            background: var(--color-primary-dark); /* âœ… CSS Variable statt #2196F3 */
        }

        /* ðŸŒ™ DARK MODE: Navigation Bar */
        [data-theme="dark"] .nav-bar {
            background: rgba(255, 255, 255, 0.08);
            border-bottom-color: var(--color-primary); /* TÃ¼rkis-Blau */
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }

        [data-theme="dark"] .nav-btn {
            background: rgba(46, 200, 255, 0.2); /* GedÃ¤mpfter Cyan-Hintergrund */
            color: rgba(46, 200, 255, 1); /* Leuchtender Cyan-Text */
        }

        [data-theme="dark"] .nav-btn:hover {
            background: rgba(46, 200, 255, 0.3);
            box-shadow: 0 5px 15px rgba(46, 200, 255, 0.4);
        }

        [data-theme="dark"] .nav-btn.active {
            background: rgba(46, 200, 255, 0.4);
            box-shadow: 0 0 20px rgba(46, 200, 255, 0.5);
        }

        /* ============================================
           ðŸŒ™ DARK MODE: ALLE TEXTE KONSISTENT WEIáºž
           ============================================ */

        /* 1. HauptÃ¼berschriften */
        [data-theme="dark"] .header h1 {
            color: rgba(255, 255, 255, 0.95) !important;
        }

        /* 2. Stats Cards - Labels & Subtitles */
        [data-theme="dark"] .stat-label {
            color: rgba(255, 255, 255, 0.9) !important;
            opacity: 1 !important; /* Override 0.8 */
        }

        [data-theme="dark"] .stat-subtitle {
            color: rgba(255, 255, 255, 0.75) !important;
            opacity: 1 !important; /* Override 0.6 */
        }

        /* 3. Charts Section Ãœberschriften */
        [data-theme="dark"] .charts-section h2 {
            color: rgba(255, 255, 255, 0.95) !important;
        }

        [data-theme="dark"] .chart-card h3 {
            color: rgba(255, 255, 255, 0.95) !important;
        }

        /* 4. Stat-Cards-Large (bunte Boxen) */
        [data-theme="dark"] .stat-card-large h4 {
            color: rgba(255, 255, 255, 1) !important;
            opacity: 1 !important; /* Override 0.9 */
        }

        [data-theme="dark"] .stat-card-large .stat-value {
            color: rgba(255, 255, 255, 1) !important;
        }

        [data-theme="dark"] .stat-card-large .stat-subtitle {
            color: rgba(255, 255, 255, 0.9) !important;
            opacity: 1 !important; /* Override 0.8 */
        }

        /* 5. Modal Ãœberschriften */
        [data-theme="dark"] .modal-header h2 {
            color: rgba(255, 255, 255, 0.95) !important;
        }

        /* 6. Formular Labels */
        [data-theme="dark"] .form-group label {
            color: rgba(255, 255, 255, 0.9) !important;
        }

        /* 7. Historie Section */
        [data-theme="dark"] .historie-section h3 {
            color: rgba(255, 255, 255, 0.95) !important;
        }

        /* 8. Tag Filter Labels */
        [data-theme="dark"] .tag-filter-bar .filter-label {
            color: rgba(255, 255, 255, 0.9) !important;
        }

        /* 9. Kunden Card Name */
        [data-theme="dark"] .kunde-card-name {
            color: rgba(255, 255, 255, 0.95) !important;
        }

        /* 10. Advanced Filters */
        [data-theme="dark"] .advanced-filters-header h3 {
            color: rgba(255, 255, 255, 0.95) !important;
        }

        [data-theme="dark"] .filter-group label {
            color: rgba(255, 255, 255, 0.9) !important;
        }

        /* 11. Umsatz Filter Label (Inline Style Override) */
        [data-theme="dark"] .umsatz-filter span {
            color: rgba(255, 255, 255, 0.9) !important;
        }

        /* 12. Pagination Label (Inline Style Override) */
        [data-theme="dark"] .page-size-selector label {
            color: rgba(255, 255, 255, 0.9) !important;
        }

        /* 13. Filter Buttons */
        [data-theme="dark"] .umsatz-filter .filter-btn {
            color: rgba(255, 255, 255, 0.9);
            border-color: rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.08);
        }

        [data-theme="dark"] .umsatz-filter .filter-btn.active {
            background: rgba(46, 200, 255, 0.3);
            color: rgba(255, 255, 255, 1);
            border-color: rgba(46, 200, 255, 0.6);
        }

        [data-theme="dark"] .umsatz-filter .filter-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        /* 14. Pagination Buttons */
        [data-theme="dark"] .pagination-btn {
            color: rgba(255, 255, 255, 0.9);
            border-color: rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.08);
        }

        [data-theme="dark"] .pagination-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.15);
        }

        [data-theme="dark"] .pagination-btn:disabled {
            color: rgba(255, 255, 255, 0.3);
        }

        /* 15. Sortier-Icons in Tabelle */
        [data-theme="dark"] .kunden-table th.sortable.sort-asc::after,
        [data-theme="dark"] .kunden-table th.sortable.sort-desc::after {
            color: rgba(46, 200, 255, 1) !important; /* TÃ¼rkis statt dunkelblau */
        }

        /* 16. View Toggle Buttons */
        [data-theme="dark"] .view-toggle .btn-secondary {
            color: rgba(255, 255, 255, 0.9);
            border-color: rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.08);
        }

        [data-theme="dark"] .view-toggle .btn-secondary.active {
            background: rgba(46, 200, 255, 0.3);
            color: rgba(255, 255, 255, 1);
            border-color: rgba(46, 200, 255, 0.6);
        }

        /* 17. Chart Toggle Button */
        [data-theme="dark"] .chart-toggle-btn {
            color: rgba(255, 255, 255, 0.95);
            background: rgba(46, 200, 255, 0.2);
            border: 1px solid rgba(46, 200, 255, 0.4);
        }

        [data-theme="dark"] .chart-toggle-btn:hover {
            background: rgba(46, 200, 255, 0.3);
        }

        /* 18. Pagination Info Text */
        [data-theme="dark"] .pagination-info {
            color: rgba(255, 255, 255, 0.8);
        }

        /* ============================================
           ðŸŒ™ DARK MODE: FEHLENDE KLASSEN & INLINE-STYLES
           ============================================ */

        /* 19. Modal Close Button */
        [data-theme="dark"] .modal-close {
            color: rgba(255, 255, 255, 0.8) !important;
        }

        [data-theme="dark"] .modal-close:hover {
            color: rgba(255, 255, 255, 1) !important;
        }

        /* 20. Badge Warning */
        [data-theme="dark"] .badge-warning {
            background: rgba(255, 200, 100, 0.2) !important;
            color: rgba(255, 200, 100, 1) !important;
        }

        /* 21. Historie Date */
        [data-theme="dark"] .historie-date {
            color: rgba(255, 255, 255, 0.7) !important;
        }

        /* 22. Empty State */
        [data-theme="dark"] .empty-state {
            color: rgba(255, 255, 255, 0.6) !important;
        }

        /* ============================================
           ðŸŽ¯ INLINE-STYLES ÃœBERSCHREIBEN (Attribut-Selektoren)
           ============================================ */

        /* #003366 (Dunkelblau) â†’ WeiÃŸ */
        [data-theme="dark"] span[style*="color: #003366"],
        [data-theme="dark"] label[style*="color: #003366"],
        [data-theme="dark"] div[style*="color: #003366"] {
            color: rgba(255, 255, 255, 0.9) !important;
        }

        /* #666 (Dunkelgrau) â†’ HellweiÃŸ */
        [data-theme="dark"] span[style*="color: #666"],
        [data-theme="dark"] label[style*="color: #666"],
        [data-theme="dark"] small[style*="color: #666"],
        [data-theme="dark"] div[style*="color: #666"] {
            color: rgba(255, 255, 255, 0.8) !important;
        }

        /* #999 (Mittelgrau) â†’ GedÃ¤mpftes WeiÃŸ */
        [data-theme="dark"] span[style*="color: #999"],
        [data-theme="dark"] p[style*="color: #999"],
        [data-theme="dark"] small[style*="color: #999"] {
            color: rgba(255, 255, 255, 0.6) !important;
        }

        /* #2196f3 (Blau) â†’ Helles Cyan */
        [data-theme="dark"] label[style*="color: #2196f3"],
        [data-theme="dark"] div[style*="color: #2196f3"] {
            color: rgba(46, 200, 255, 1) !important;
        }

        /* #4caf50 (GrÃ¼n) â†’ Helles GrÃ¼n */
        [data-theme="dark"] div[style*="color: #4caf50"] {
            color: rgba(76, 217, 100, 1) !important;
        }

        /* #ff9800 (Orange) â†’ Helles Orange */
        [data-theme="dark"] div[style*="color: #ff9800"],
        [data-theme="dark"] strong[style*="color: #ff9800"] {
            color: rgba(255, 159, 10, 1) !important;
        }

        /* #e65100 (Dunkelorange) â†’ Orange */
        [data-theme="dark"] span[style*="color: #e65100"] {
            color: rgba(255, 149, 0, 1) !important;
        }

        /* #856404 (Braun - Badge Warning) â†’ Gelb */
        [data-theme="dark"] div[style*="color: #856404"] {
            background: rgba(255, 200, 100, 0.15) !important;
            color: rgba(255, 215, 0, 0.95) !important;
            border-color: rgba(255, 200, 100, 0.3) !important;
        }

        /* #1565c0 (Blau - Info Box) â†’ Helles Cyan */
        [data-theme="dark"] div[style*="color: #1565c0"] {
            background: rgba(46, 200, 255, 0.15) !important;
            color: rgba(46, 200, 255, 1) !important;
            border-color: rgba(46, 200, 255, 0.4) !important;
        }

        /* ============================================
           ðŸ”„ FALLBACK-REGELN (fÃ¼r Tags ohne Klasse)
           ============================================ */

        /* Alle <small> Tags */
        [data-theme="dark"] small {
            color: rgba(255, 255, 255, 0.75);
        }

        /* Alle <span> ohne Klasse in spezifischen Containern */
        [data-theme="dark"] .form-group span:not([class]):not([data-feather]),
        [data-theme="dark"] .umsatz-filter span:not([class]):not([data-feather]),
        [data-theme="dark"] .tag-filter-bar span:not([class]):not([data-feather]),
        [data-theme="dark"] .page-size-selector span:not([class]):not([data-feather]) {
            color: rgba(255, 255, 255, 0.9);
        }

        /* Alle Labels ohne Klasse */
        [data-theme="dark"] label:not([class]) {
            color: rgba(255, 255, 255, 0.9);
        }

        /* Alle <p> ohne Klasse */
        [data-theme="dark"] p:not([class]) {
            color: rgba(255, 255, 255, 0.85);
        }

        /* ========================================
           ðŸŒ™ PHASE 13: Container & Input-Felder
           ======================================== */

        /* 1ï¸âƒ£ Umsatz-Filter Container */
        [data-theme="dark"] .umsatz-filter {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.2);
        }

        /* 2ï¸âƒ£ Such-Eingabefeld */
        [data-theme="dark"] .search-box input {
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.9);
            border-color: rgba(255, 255, 255, 0.2);
        }

        [data-theme="dark"] .search-box input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        [data-theme="dark"] .search-box input:focus {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(46, 200, 255, 0.6);
            box-shadow: 0 0 10px rgba(46, 200, 255, 0.3);
        }

        /* 3ï¸âƒ£ Erweiterte Filter Container */
        [data-theme="dark"] .advanced-filters {
            background: rgba(255, 255, 255, 0.06);
            border-color: rgba(255, 255, 255, 0.1);
        }

        /* 4ï¸âƒ£ Filter Input-Felder */
        [data-theme="dark"] .filter-group input {
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.9);
            border-color: rgba(255, 255, 255, 0.2);
        }

        [data-theme="dark"] .filter-group input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        [data-theme="dark"] .filter-group input:focus {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(46, 200, 255, 0.6);
        }

        /* 5ï¸âƒ£ Tabellen-Hover-Effekt */
        [data-theme="dark"] .kunden-table tbody tr:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        /* ========================================
           ðŸŒ™ PHASE 16: Kunden-Karten Dark Mode
           ======================================== */

        /* 1ï¸âƒ£ Hauptkarte - Glassmorphism Dark */
        [data-theme="dark"] .kunde-card {
            background: rgba(255, 255, 255, 0.08);
            border-left-color: rgba(46, 200, 255, 0.6);
            box-shadow:
                0 2px 8px rgba(0,0,0,0.4),
                inset 0 1px 0 rgba(255,255,255,0.1);
        }

        /* 2ï¸âƒ£ Info-Labels (ðŸ“ž Telefon:, ðŸ“§ Email:, etc.) */
        [data-theme="dark"] .info-label {
            color: rgba(255, 255, 255, 0.7);
        }

        /* 3ï¸âƒ£ Info-Values (Telefonnummer, Email, etc.) */
        [data-theme="dark"] .info-value {
            color: rgba(255, 255, 255, 0.95);
        }

        /* 4ï¸âƒ£ Badge - Stammkunde (grÃ¼n) */
        [data-theme="dark"] .kunde-badge-green {
            background: rgba(40, 167, 69, 0.2);
            color: rgba(76, 217, 100, 0.95);
            border: 1px solid rgba(40, 167, 69, 0.4);
        }

        /* 5ï¸âƒ£ Badge - Neukunde (blau) */
        [data-theme="dark"] .kunde-badge-blue {
            background: rgba(33, 150, 243, 0.2);
            color: rgba(100, 181, 246, 0.95);
            border: 1px solid rgba(33, 150, 243, 0.4);
        }

        /* 6ï¸âƒ£ Header <h3> in Karte */
        [data-theme="dark"] .kunde-card-header h3 {
            color: rgba(255, 255, 255, 0.95);
        }

        /* 7ï¸âƒ£ Card Body */
        [data-theme="dark"] .kunde-card-body {
            color: rgba(255, 255, 255, 0.85);
        }

        /* ========================================
           ITERATION 1: Mobile-First & Tag-System
           ======================================== */

        /* CSS-Variablen fÃ¼r Tags */
        :root {
            --tag-vip: #ffc107;
            --tag-vip-bg: #fff3cd;
            --tag-vip-text: #856404;
            --tag-stammkunde: #28a745;
            --tag-stammkunde-bg: #d4edda;
            --tag-stammkunde-text: #155724;
            --tag-neukunde: #6c757d;
            --tag-neukunde-bg: #f8f9fa;
            --tag-neukunde-text: #495057;
            --tag-flotte: #007bff;
            --tag-flotte-bg: #d1ecf1;
            --tag-flotte-text: #004085;
            --tag-gewerbe: #fd7e14;
            --tag-gewerbe-bg: #fff3cd;
            --tag-gewerbe-text: #856404;
            --tag-privat: #6f42c1;
            --tag-privat-bg: #e7e3f5;
            --tag-privat-text: #4a2682;

            --toast-success: #28a745;
            --toast-error: #dc3545;
            --toast-warning: #ffc107;
            --toast-info: #17a2b8;
        }

        /* Tag-Chips */
        .tag-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            border: 2px solid;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 36px;
            background: var(--color-surface-elevated); /* âœ… CSS Variable statt white */
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .tag-chip:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .tag-chip:active {
            transform: scale(0.95);
        }

        .tag-chip.active {
            font-weight: 700;
            box-shadow: 0 0 0 3px rgba(0,0,0,0.1);
        }

        .tag-chip-vip {
            background: var(--tag-vip-bg);
            border-color: var(--tag-vip);
            color: var(--tag-vip-text);
        }

        .tag-chip-stammkunde {
            background: var(--tag-stammkunde-bg);
            border-color: var(--tag-stammkunde);
            color: var(--tag-stammkunde-text);
        }

        .tag-chip-neukunde {
            background: var(--tag-neukunde-bg);
            border-color: var(--tag-neukunde);
            color: var(--tag-neukunde-text);
        }

        .tag-chip-flotte {
            background: var(--tag-flotte-bg);
            border-color: var(--tag-flotte);
            color: var(--tag-flotte-text);
        }

        .tag-chip-gewerbe {
            background: var(--tag-gewerbe-bg);
            border-color: var(--tag-gewerbe);
            color: var(--tag-gewerbe-text);
        }

        .tag-chip-privat {
            background: var(--tag-privat-bg);
            border-color: var(--tag-privat);
            color: var(--tag-privat-text);
        }

        /* ðŸŒ™ DARK MODE: Tag-Chips gedÃ¤mpftere Farben */
        [data-theme="dark"] .tag-chip {
            background: rgba(255, 255, 255, 0.08); /* Dunkler Hintergrund */
            opacity: 0.9; /* Leicht gedÃ¤mpft */
        }

        [data-theme="dark"] .tag-chip:hover {
            opacity: 1; /* Volle Deckkraft beim Hover */
            background: rgba(255, 255, 255, 0.12);
        }

        /* VIP - Gelb gedÃ¤mpft */
        [data-theme="dark"] .tag-chip-vip {
            border-color: rgba(255, 215, 0, 0.6);
            background: rgba(255, 215, 0, 0.1);
            color: rgba(255, 215, 0, 0.95);
        }

        /* Stammkunde - GrÃ¼n gedÃ¤mpft */
        [data-theme="dark"] .tag-chip-stammkunde {
            border-color: rgba(40, 167, 69, 0.6);
            background: rgba(40, 167, 69, 0.1);
            color: rgba(76, 217, 100, 0.95);
        }

        /* Neukunde - Cyan gedÃ¤mpft */
        [data-theme="dark"] .tag-chip-neukunde {
            border-color: rgba(0, 191, 255, 0.6);
            background: rgba(0, 191, 255, 0.1);
            color: rgba(46, 200, 255, 0.95);
        }

        /* Flotte - Rot gedÃ¤mpft */
        [data-theme="dark"] .tag-chip-flotte {
            border-color: rgba(220, 53, 69, 0.6);
            background: rgba(220, 53, 69, 0.1);
            color: rgba(255, 69, 58, 0.95);
        }

        /* Gewerbe - Orange gedÃ¤mpft */
        [data-theme="dark"] .tag-chip-gewerbe {
            border-color: rgba(255, 149, 0, 0.6);
            background: rgba(255, 149, 0, 0.1);
            color: rgba(255, 159, 10, 0.95);
        }

        /* Privat - Lila gedÃ¤mpft */
        [data-theme="dark"] .tag-chip-privat {
            border-color: rgba(142, 68, 173, 0.6);
            background: rgba(142, 68, 173, 0.1);
            color: rgba(191, 148, 228, 0.95);
        }

        /* Tag-Filter-Bar */
        .tag-filter-bar {
            margin-bottom: 20px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
            padding: 15px;
            background: var(--color-surface-elevated); /* âœ… CSS Variable statt #f8f9fa */
            border-radius: 10px;
        }

        /* Tag-Filter-Bar Dark Mode */
        [data-theme="dark"] .tag-filter-bar {
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tag-filter-bar .filter-label {
            font-weight: 600;
            color: #003366;
            margin-right: 8px;
        }

        /* Tag Checkbox (for form) */
        .tag-checkbox {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            position: relative;
        }

        .tag-checkbox input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .tag-checkbox .tag-chip {
            opacity: 0.5;
            border-style: dashed;
            transition: all 0.2s;
        }

        .tag-checkbox input[type="checkbox"]:checked + .tag-chip {
            opacity: 1;
            border-style: solid;
            font-weight: 700;
            transform: scale(1.05);
        }

        .tag-checkbox:hover .tag-chip {
            opacity: 0.8;
            transform: translateY(-2px);
        }

        /* Mobile Card Layout */
        .kunde-card {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #003366;
            transition: all 0.3s;
            position: relative;
        }

        .kunde-card:active {
            transform: scale(0.98);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .kunde-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .kunde-card-name {
            font-size: 18px;
            font-weight: 700;
            color: #003366;
            margin-bottom: 4px;
        }

        .kunde-card-tags {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .kunde-card-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }

        .kunde-card-info-item {
            font-size: 14px;
        }

        .kunde-card-info-label {
            color: #6c757d;
            font-size: 12px;
            margin-bottom: 2px;
        }

        .kunde-card-info-value {
            font-weight: 600;
            color: #212529;
        }

        .kunde-card-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            z-index: 10000;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 40px);
            max-width: 500px;
            pointer-events: none;
        }

        @media (min-width: 769px) {
            .toast-container {
                top: 80px;
                right: 20px;
                bottom: auto;
                left: auto;
                transform: none;
                width: auto;
                max-width: 400px;
            }
        }

        .toast {
            background: white;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-left: 4px solid;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: all;
            cursor: pointer;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast-success {
            border-left-color: var(--toast-success);
        }

        .toast-error {
            border-left-color: var(--toast-error);
        }

        .toast-warning {
            border-left-color: var(--toast-warning);
        }

        .toast-info {
            border-left-color: var(--toast-info);
        }

        .toast-icon {
            font-size: 20px;
            line-height: 1;
        }

        .toast-message {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
            color: #212529;
        }

        .toast-close {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Touch-optimierte Buttons */
        .btn, .tag-chip, .filter-btn, .nav-btn {
            min-height: 48px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .btn-small {
            min-height: 40px;
        }

        /* View-Toggle */
        .view-toggle {
            text-align: right;
            margin-bottom: 15px;
        }

        .view-toggle .btn-secondary {
            background: #f0f0f0;
            border: 2px solid #dee2e6;
        }

        .view-toggle .btn-secondary.active {
            background: #003366;
            color: white;
            border-color: #003366;
        }

        /* Mobile Responsive - Cards statt Tabelle */
        @media (max-width: 768px) {
            .kunden-table {
                display: none !important;
            }

            .kunde-card {
                display: block;
            }

            .view-toggle {
                display: none;
            }

            .tag-filter-bar {
                padding: 12px;
            }

            .tag-chip {
                font-size: 12px;
                padding: 5px 10px;
                min-height: 32px;
            }

            .kunde-card-info {
                grid-template-columns: 1fr;
                gap: 8px;
            }
        }

        /* Desktop - Tabelle Standard, Cards optional */
        @media (min-width: 769px) {
            .kunde-card {
                display: none;
            }

            .kunden-table {
                display: table;
            }

            body.view-cards .kunden-table {
                display: none !important;
            }

            body.view-cards .kunde-card {
                display: block;
            }
        }

        /* Pagination Controls */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .pagination-info {
            font-size: 14px;
            color: #666;
        }

        .pagination-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .pagination-btn {
            padding: 8px 16px;
            border: 2px solid #003366;
            background: white;
            color: #003366;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            min-height: 40px;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #003366;
            color: white;
            transform: translateY(-1px);
        }

        .pagination-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: #003366;
            color: white;
        }

        .page-size-selector {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .page-size-selector select {
            padding: 8px 12px;
            border: 2px solid #003366;
            border-radius: 6px;
            background: white;
            color: #003366;
            font-weight: 600;
            cursor: pointer;
            min-height: 40px;
        }

        /* Advanced Filters */
        .advanced-filters {
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }

        .advanced-filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
            user-select: none;
        }

        .advanced-filters-header h3 {
            margin: 0;
            color: #003366;
            font-size: 16px;
        }

        .advanced-filters-content {
            display: none;
            gap: 15px;
            flex-wrap: wrap;
        }

        .advanced-filters-content.active {
            display: flex;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            font-weight: 600;
            color: #003366;
            font-size: 14px;
        }

        .filter-group input {
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .filter-group input:focus {
            outline: none;
            border-color: #003366;
        }

        .filter-actions {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }

        /* Sortable Table Headers */
        .kunden-table th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 25px;
        }

        .kunden-table th.sortable:hover {
            background: #f0f0f0;
        }

        .kunden-table th.sortable::after {
            content: 'â†•ï¸';
            position: absolute;
            right: 8px;
            opacity: 0.3;
            font-size: 12px;
        }

        .kunden-table th.sortable.sort-asc::after {
            content: 'â†‘';
            opacity: 1;
            color: #003366;
        }

        .kunden-table th.sortable.sort-desc::after {
            content: 'â†“';
            opacity: 1;
            color: #003366;
        }

        /* Charts Section */
        .charts-section {
            margin-top: 30px;
            margin-bottom: 30px;
        }

        .charts-section h2 {
            color: var(--color-text-primary); /* âœ… CSS Variable statt #003366 */
            margin-bottom: 20px;
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-card {
            background: var(--color-surface-elevated); /* âœ… CSS Variable statt white */
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid var(--color-primary); /* âœ… CSS Variable statt #003366 */
        }

        .chart-card h3 {
            color: var(--color-text-primary); /* âœ… CSS Variable statt #003366 */
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ðŸŒ™ DARK MODE: Charts dunkler & besser lesbar */
        [data-theme="dark"] .chart-card {
            background: rgba(255, 255, 255, 0.1); /* Dunkler Container */
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            border-left-color: var(--color-primary); /* TÃ¼rkis-Blau Border */
        }

        [data-theme="dark"] .chart-card h3 {
            color: rgba(255, 255, 255, 0.95); /* Hellerer Text */
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .chart-container canvas {
            max-height: 100%;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card-large {
            background: linear-gradient(135deg, #003366 0%, #0055aa 100%);
            border-radius: 12px;
            padding: 20px;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .stat-card-large h4 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .stat-card-large .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-card-large .stat-subtitle {
            font-size: 12px;
            opacity: 0.8;
        }

        .chart-toggle-btn {
            padding: 10px 20px;
            background: #003366;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            margin-bottom: 20px;
        }

        .chart-toggle-btn:hover {
            background: #0055aa;
            transform: translateY(-2px);
        }

        .charts-section.collapsed .charts-grid {
            display: none;
        }

        .charts-section.collapsed .stats-cards {
            display: none;
        }

        /* Utility Classes */
        .mobile-only {
            display: block;
        }

        .desktop-only {
            display: none;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }

            .chart-container {
                height: 200px;
            }

            .stats-cards {
                grid-template-columns: 1fr; /* Nur 1 Spalte auf Mobile */
            }

            .stat-card-large {
                padding: 15px;
            }

            .stat-card-large .stat-value {
                font-size: 24px; /* Kleinerer Text auf Mobile */
            }

            .stat-card-large h4 {
                font-size: 13px;
            }

            .stat-card-large .stat-subtitle {
                font-size: 11px;
            }
            .pagination-container {
                flex-direction: column;
                align-items: stretch;
            }

            .pagination-controls {
                justify-content: center;
            }

            .page-size-selector {
                justify-content: center;
            }

            .advanced-filters-content {
                flex-direction: column;
            }

            .filter-group {
                min-width: 100%;
            }

            /* Header Mobile */
            .header h1 {
                font-size: 22px;
            }

            .header-actions {
                width: 100%;
                justify-content: stretch;
            }

            .header-actions .btn {
                flex: 1;
                font-size: 13px;
                padding: 10px 12px;
            }

            /* Charts Section Mobile */
            .charts-section h2 {
                font-size: 20px;
            }

            .chart-card h3 {
                font-size: 16px;
            }

            .chart-toggle-btn {
                width: 100%;
                font-size: 14px;
            }

            /* Tag Filter Bar Mobile */
            .tag-filter-bar {
                gap: 6px;
                padding: 12px;
            }

            .tag-chip {
                font-size: 11px;
                padding: 5px 10px;
                min-height: 32px;
            }

            /* View Toggle Mobile */
            .view-toggle {
                margin-bottom: 15px;
            }

            .toggle-btn {
                font-size: 13px;
                padding: 8px 12px;
            }
        }

        @media (min-width: 769px) {
            .mobile-only {
                display: none;
            }

            .desktop-only {
                display: block;
            }
        }
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

    <!-- Firebase Konfiguration -->
    <script src="firebase-config.js?v=a4192c4"></script>

    <!-- Error Handler & Toast Notifications -->
    <script src="error-handler.js"></script>

    <!-- Listener Registry - Memory Leak Prevention -->
    <script src="listener-registry.js"></script>

    <!-- Auth Manager fÃ¼r Multi-Tenant Support -->
    <script src="js/auth-manager.js"></script>
    <script src="js/settings-manager.js"></script>

    <!-- Event System fÃ¼r Real-Time Updates (Phase 3) -->
    <script src="js/app-events.js"></script>

    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Global Chat Notifications -->
    <link rel="stylesheet" href="global-chat-notifications.css">
    <script src="global-chat-notifications.js"></script>

    <!-- Phase 3: Event Listeners for Real-Time UI Updates -->
    <script>
        // ========================================
        // ðŸ”§ BUG #9 FIX (2025-11-20): EMAIL VALIDATION FUNCTION
        // PROBLEM: Line 5275 calls window.validateEmail() but it was undefined â†’ Runtime error!
        // LÃ–SUNG: Define function globally for use in neuerKundeFormSubmit()
        // ========================================
        window.validateEmail = function(email) {
            // RFC 5322 simplified email regex
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

            if (!email || email.trim() === '') {
                return { valid: false, error: 'âŒ Email-Adresse ist erforderlich' };
            }

            if (!emailRegex.test(email)) {
                return { valid: false, error: 'âŒ UngÃ¼ltige Email-Adresse. Bitte geben Sie eine gÃ¼ltige Email ein.' };
            }

            return { valid: true, error: null };
        };

        /**
         * Setup event listeners for AI Agent actions
         * Enables real-time UI updates when AI creates/updates customers
         */
        function setupKundenEventListeners() {
            // Check if event system is available
            if (!window.appEvents) {
                console.warn('âš ï¸ [KUNDEN] Event system not available yet, will retry...');
                // Retry after a short delay
                setTimeout(setupKundenEventListeners, 500);
                return;
            }

            console.log('ðŸ‘‚ [KUNDEN] Setting up event listeners...');

            // Listen for kunde created
            window.appEvents.on('kundeCreated', async (data) => {
                console.log('ðŸ¤– [KUNDEN] AI created customer:', data.kunde.name);
                // Reload customer data to show new customer
                if (typeof loadKunden === 'function') {
                    await loadKunden();
                    console.log('âœ… [KUNDEN] Customer list refreshed after kundeCreated');
                }
                // Update statistics
                if (typeof updateStats === 'function') {
                    updateStats();
                }
            });

            // Listen for kunde updated
            window.appEvents.on('kundeUpdated', async (data) => {
                console.log('ðŸ¤– [KUNDEN] AI updated customer:', data.kundeId);
                // Reload customer data to show updated customer
                if (typeof loadKunden === 'function') {
                    await loadKunden();
                    console.log('âœ… [KUNDEN] Customer list refreshed after kundeUpdated');
                }
                // Update statistics
                if (typeof updateStats === 'function') {
                    updateStats();
                }
            });

            // Listen for fahrzeug created (affects customer stats)
            window.appEvents.on('fahrzeugCreated', async (data) => {
                console.log('ðŸ¤– [KUNDEN] AI created vehicle:', data.fahrzeug.kennzeichen);
                // Reload fahrzeuge data (affects customer visit counts)
                if (typeof loadFahrzeuge === 'function') {
                    await loadFahrzeuge();
                    console.log('âœ… [KUNDEN] Vehicle data refreshed after fahrzeugCreated');
                }
                // Update statistics
                if (typeof updateStats === 'function') {
                    updateStats();
                }
            });

            console.log('âœ… [KUNDEN] Event listeners registered successfully');
        }

        // Initialize event listeners when page loads
        if (document.readyState === 'loading') {
            window.listenerRegistry.registerDOM(document, 'DOMContentLoaded', setupKundenEventListeners, 'document DOMContentLoaded');
        } else {
            // DOM already loaded
            setupKundenEventListeners();
        }
    </script>
</head>
<body class="has-ai-features">
    <!-- ðŸŒ“ THEME TOGGLE BUTTON - Fixed Top-Right -->
    <button id="themeToggle" class="theme-toggle" aria-label="Toggle Light/Dark Mode">
        <i data-feather="sun" class="theme-toggle__icon theme-toggle__icon--light"></i>
        <i data-feather="moon" class="theme-toggle__icon theme-toggle__icon--dark"></i>
    </button>

    <!-- âœ¨ ACCENT LIGHT - Parallax Glow (Background Effect) -->
    <div class="accent-light"></div>

    <!-- ðŸŽ¬ PAGE TRANSITION OVERLAY - Blur beim Navigieren -->
    <div class="page-transition-overlay"></div>

    <div class="container">
        <div class="header">
            <!-- Werkstatt Logo (dynamisch geladen) -->
            <div id="werkstattLogo" style="display: inline-block; vertical-align: middle; margin-right: 12px;"></div>
            <h1 style="display: inline-block; vertical-align: middle;">ðŸ‘¥ Kundenverwaltung</h1>
            <div class="header-actions">
                <button class="btn btn-success" onclick="openNeuerKundeModal()">âž• Neuer Kunde</button>
                <button class="btn btn-primary" onclick="exportKundenToCSV()" style="background: #4caf50;">ðŸ“Š CSV Export</button>
            </div>
        </div>

        <!-- ðŸŽ´ STATS CARDS GRID - Apple Liquid Glass Style (Kompakt) -->
        <div class="stats-grid">
            <!-- Card 1: Gesamt Kunden -->
            <div class="hero-card hero-card--stat">
                <div class="shine-overlay"></div>
                <div class="hero-card__icon">
                    <i data-feather="users"></i>
                </div>
                <div class="stat-value">
                    <span class="stat-number" id="totalKunden">0</span>
                </div>
                <div class="stat-label">Gesamt Kunden</div>
            </div>

            <!-- Card 2: Stammkunden -->
            <div class="hero-card hero-card--stat">
                <div class="shine-overlay"></div>
                <div class="hero-card__icon">
                    <i data-feather="star"></i>
                </div>
                <div class="stat-value">
                    <span class="stat-number" id="stammkunden">0</span>
                </div>
                <div class="stat-label">Stammkunden</div>
                <div class="stat-subtitle">2+ Besuche</div>
            </div>

            <!-- Card 3: Neukunden -->
            <div class="hero-card hero-card--stat">
                <div class="shine-overlay"></div>
                <div class="hero-card__icon">
                    <i data-feather="user-plus"></i>
                </div>
                <div class="stat-value">
                    <span class="stat-number" id="neukunden">0</span>
                </div>
                <div class="stat-label">Neukunden</div>
                <div class="stat-subtitle">1 Besuch</div>
            </div>

            <!-- Card 4: Gesamtumsatz -->
            <div class="hero-card hero-card--stat">
                <div class="shine-overlay"></div>
                <div class="hero-card__icon">
                    <i data-feather="trending-up"></i>
                </div>
                <div class="stat-value">
                    <span class="stat-number" id="totalUmsatz">0,00 â‚¬</span>
                </div>
                <div class="stat-label" id="umsatzLabel">Gesamtumsatz</div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section" id="chartsSection">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>ðŸ“Š Analysen & Statistiken</h2>
                <button class="chart-toggle-btn" onclick="toggleCharts()" id="chartToggleBtn">
                    ðŸ“‰ Charts ausblenden
                </button>
            </div>

            <!-- Statistics Cards -->
            <div class="stats-cards">
                <div class="stat-card-large">
                    <h4>ðŸ’° Durchschnittlicher Umsatz</h4>
                    <div class="stat-value" id="avgUmsatz">0,00 â‚¬</div>
                    <div class="stat-subtitle">Pro Kunde</div>
                </div>
                <div class="stat-card-large" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                    <h4>â­ Top Kunde</h4>
                    <div class="stat-value" id="topKundeName" style="font-size: 20px;">-</div>
                    <div class="stat-subtitle" id="topKundeUmsatz">0,00 â‚¬ Umsatz</div>
                </div>
                <div class="stat-card-large" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);">
                    <h4>ðŸ·ï¸ Meist genutzter Tag</h4>
                    <div class="stat-value" id="topTag" style="font-size: 20px;">-</div>
                    <div class="stat-subtitle" id="topTagCount">0 Kunden</div>
                </div>
                <div class="stat-card-large" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
                    <h4>ðŸ“ˆ Wachstumsrate</h4>
                    <div class="stat-value" id="growthRate">+0%</div>
                    <div class="stat-subtitle">Neue Kunden diesen Monat</div>
                </div>
            </div>

            <!-- Charts Grid -->
            <div class="charts-grid">
                <!-- Top 10 Kunden Chart -->
                <div class="chart-card">
                    <h3>ðŸ’° Top 10 Kunden nach Umsatz</h3>
                    <div class="chart-container">
                        <canvas id="topKundenChart"></canvas>
                    </div>
                </div>

                <!-- Tag Distribution Chart -->
                <div class="chart-card">
                    <h3>ðŸ·ï¸ Kunden nach Tags</h3>
                    <div class="chart-container">
                        <canvas id="tagDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="umsatz-filter">
            <span style="font-weight: 600; color: #003366; margin-right: 10px;">Umsatz-Zeitraum:</span>
            <button class="filter-btn active" onclick="setUmsatzFilter('gesamt')">ðŸ“Š Gesamt</button>
            <button class="filter-btn" onclick="setUmsatzFilter('jahr')">ðŸ“… Jahr</button>
            <button class="filter-btn" onclick="setUmsatzFilter('monat')">ðŸ“† Monat</button>
        </div>

        <!-- Tag Filter Bar -->
        <div class="tag-filter-bar">
            <span style="font-weight: 600; color: #003366; margin-right: 10px;">Tags filtern:</span>
            <div class="tag-chip tag-chip-vip" onclick="toggleTagFilter('vip')">
                â­ VIP
            </div>
            <div class="tag-chip tag-chip-stammkunde" onclick="toggleTagFilter('stammkunde')">
                ðŸ’š Stammkunde
            </div>
            <div class="tag-chip tag-chip-neukunde" onclick="toggleTagFilter('neukunde')">
                âœ¨ Neukunde
            </div>
            <div class="tag-chip tag-chip-flotte" onclick="toggleTagFilter('flotte')">
                ðŸš— Flotte
            </div>
            <div class="tag-chip tag-chip-gewerbe" onclick="toggleTagFilter('gewerbe')">
                ðŸ¢ Gewerbe
            </div>
            <div class="tag-chip tag-chip-privat" onclick="toggleTagFilter('privat')">
                ðŸ‘¤ Privat
            </div>
            <button class="btn btn-sm" onclick="clearTagFilters()" style="margin-left: 10px; padding: 8px 16px;">
                ðŸ”„ Filter zurÃ¼cksetzen
            </button>
        </div>

        <!-- View Toggle (Desktop only) -->
        <div class="view-toggle desktop-only">
            <button class="toggle-btn active" onclick="setViewMode('table')" id="viewTableBtn">
                ðŸ“‹ Tabelle
            </button>
            <button class="toggle-btn" onclick="setViewMode('cards')" id="viewCardsBtn">
                ðŸ“± Karten
            </button>
        </div>

        <div class="search-box">
            <input type="text" id="searchInput" placeholder="ðŸ” Kunde suchen (Name, Telefon, Email)..." oninput="filterKunden()">
        </div>

        <!-- Advanced Filters -->
        <div class="advanced-filters">
            <div class="advanced-filters-header" onclick="toggleAdvancedFilters()">
                <h3>ðŸ” Erweiterte Filter</h3>
                <span id="advancedFiltersToggle">â–¼</span>
            </div>
            <div class="advanced-filters-content" id="advancedFiltersContent">
                <div class="filter-group">
                    <label for="umsatzMin">ðŸ’° Umsatz Min (â‚¬)</label>
                    <input type="number" id="umsatzMin" placeholder="z.B. 1000" step="100" min="0">
                </div>
                <div class="filter-group">
                    <label for="umsatzMax">ðŸ’° Umsatz Max (â‚¬)</label>
                    <input type="number" id="umsatzMax" placeholder="z.B. 10000" step="100" min="0">
                </div>
                <div class="filter-group">
                    <label for="dateFrom">ðŸ“… Besuch Von</label>
                    <input type="date" id="dateFrom">
                </div>
                <div class="filter-group">
                    <label for="dateTo">ðŸ“… Besuch Bis</label>
                    <input type="date" id="dateTo">
                </div>
                <div class="filter-actions">
                    <button class="btn btn-primary" onclick="applyAdvancedFilters()" style="min-height: 40px;">
                        âœ… Filter anwenden
                    </button>
                    <button class="btn" onclick="resetAdvancedFilters()" style="background: #6c757d; color: white; min-height: 40px;">
                        ðŸ”„ ZurÃ¼cksetzen
                    </button>
                </div>
            </div>
        </div>

        <!-- ðŸ¦´ SKELETON LOADER (shown while loading data) -->
        <div id="kundenSkeleton" class="skeleton-table" role="status" aria-live="polite" aria-label="Lade Kunden...">
            <!-- Skeleton Row 1 -->
            <div class="skeleton-table-row skeleton-stagger" style="--row-index: 0">
                <div class="skeleton skeleton-table-cell"></div>
                <div class="skeleton skeleton-table-cell"></div>
                <div class="skeleton skeleton-table-cell"></div>
                <div class="skeleton skeleton-table-cell"></div>
                <div class="skeleton skeleton-table-cell"></div>
                <div class="skeleton skeleton-table-cell"></div>
            </div>
            <!-- Skeleton Row 2 -->
            <div class="skeleton-table-row skeleton-stagger" style="--row-index: 1">
                <div class="skeleton skeleton-table-cell"></div>
                <div class="skeleton skeleton-table-cell"></div>
                <div class="skeleton skeleton-table-cell"></div>
                <div class="skeleton skeleton-table-cell"></div>
                <div class="skeleton skeleton-table-cell"></div>
                <div class="skeleton skeleton-table-cell"></div>
            </div>
            <!-- Skeleton Row 3 -->
            <div class="skeleton-table-row skeleton-stagger" style="--row-index: 2">
                <div class="skeleton skeleton-table-cell"></div>
                <div class="skeleton skeleton-table-cell"></div>
                <div class="skeleton skeleton-table-cell"></div>
                <div class="skeleton skeleton-table-cell"></div>
                <div class="skeleton skeleton-table-cell"></div>
                <div class="skeleton skeleton-table-cell"></div>
            </div>
            <!-- Skeleton Row 4 -->
            <div class="skeleton-table-row skeleton-stagger" style="--row-index: 3">
                <div class="skeleton skeleton-table-cell"></div>
                <div class="skeleton skeleton-table-cell"></div>
                <div class="skeleton skeleton-table-cell"></div>
                <div class="skeleton skeleton-table-cell"></div>
                <div class="skeleton skeleton-table-cell"></div>
                <div class="skeleton skeleton-table-cell"></div>
            </div>
            <!-- Skeleton Row 5 -->
            <div class="skeleton-table-row skeleton-stagger" style="--row-index: 4">
                <div class="skeleton skeleton-table-cell"></div>
                <div class="skeleton skeleton-table-cell"></div>
                <div class="skeleton skeleton-table-cell"></div>
                <div class="skeleton skeleton-table-cell"></div>
                <div class="skeleton skeleton-table-cell"></div>
                <div class="skeleton skeleton-table-cell"></div>
            </div>
            <!-- Skeleton Row 6 -->
            <div class="skeleton-table-row skeleton-stagger" style="--row-index: 5">
                <div class="skeleton skeleton-table-cell"></div>
                <div class="skeleton skeleton-table-cell"></div>
                <div class="skeleton skeleton-table-cell"></div>
                <div class="skeleton skeleton-table-cell"></div>
                <div class="skeleton skeleton-table-cell"></div>
                <div class="skeleton skeleton-table-cell"></div>
            </div>
        </div>

        <!-- Table Container mit horizontal scroll -->
        <div class="kunden-table-container table-container" style="display: none;">
            <table class="kunden-table">
                <thead>
                    <tr>
                        <th class="sortable" onclick="sortTable('name')">Kundenname</th>
                        <th>Kontakt</th>
                        <th class="sortable" onclick="sortTable('besuche')">Besuche</th>
                        <th class="sortable" onclick="sortTable('umsatz')">Umsatz</th>
                        <th class="sortable" onclick="sortTable('letzterBesuch')">Letzter Besuch</th>
                        <th>Status</th>
                        <th>Tags</th>
                        <th>Aktionen</th>
                    </tr>
                </thead>
                <tbody id="kundenTableBody">
                    <!-- Dynamisch gefÃ¼llt -->
                </tbody>
            </table>
        </div>

        <!-- âœ¨ KUNDEN CARDS CONTAINER - Responsive (Mobile + Desktop Cards Mode) -->
        <div id="kundenCardsContainer">
            <!-- Sichtbarkeit wird via JavaScript gesteuert (renderKundenCards / renderKundenTable) -->
        </div>

        <!-- Pagination Controls -->
        <div class="pagination-container" id="paginationContainer">
            <div class="pagination-info" id="paginationInfo">
                <!-- Dynamisch gefÃ¼llt: "Zeige 1-25 von 100 Kunden" -->
            </div>

            <div class="pagination-controls">
                <button class="pagination-btn" id="firstPageBtn" onclick="goToPage(1)">
                    â®ï¸ Erste
                </button>
                <button class="pagination-btn" id="prevPageBtn" onclick="goToPage(currentPage - 1)">
                    â—€ï¸ ZurÃ¼ck
                </button>
                <span id="pageNumbers" style="display: flex; gap: 4px;">
                    <!-- Dynamisch gefÃ¼llt mit Seitenzahlen -->
                </span>
                <button class="pagination-btn" id="nextPageBtn" onclick="goToPage(currentPage + 1)">
                    Weiter â–¶ï¸
                </button>
                <button class="pagination-btn" id="lastPageBtn" onclick="goToPage(Math.ceil(totalFilteredKunden / itemsPerPage))">
                    Letzte â­ï¸
                </button>
            </div>

            <div class="page-size-selector">
                <label for="itemsPerPageSelect" style="font-weight: 600; color: #003366;">Pro Seite:</label>
                <select id="itemsPerPageSelect" onchange="changeItemsPerPage(this.value)">
                    <option value="10">10</option>
                    <option value="25" selected>25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
        </div>

        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="empty-state-icon">ðŸ‘¤</div>
            <h3>Noch keine Kunden vorhanden</h3>
            <p>Klicke auf "Neuer Kunde" um den ersten Kunden anzulegen.</p>
        </div>
    </div>

    <!-- Modal: Neuer Kunde -->
    <div id="neuerKundeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>âž• Neuer Kunde</h2>
                <button class="close-btn" onclick="closeNeuerKundeModal()">&times;</button>
            </div>
            <form id="neuerKundeForm">
                <div class="form-group">
                    <label for="kundenName">Name *</label>
                    <input type="text" id="kundenName" placeholder="z.B. Max Mustermann" required>
                </div>
                <div class="form-group">
                    <label for="kundenTelefon">Telefon</label>
                    <input type="tel" id="kundenTelefon" placeholder="z.B. 0123456789">
                </div>
                <div class="form-group">
                    <label for="kundenEmail">Email</label>
                    <input type="email" id="kundenEmail" placeholder="z.B. max@example.com">
                </div>
                <div class="form-group">
                    <label for="kundenNotizen">Notizen</label>
                    <textarea id="kundenNotizen" rows="3" placeholder="z.B. Stammkunde seit 2020, bevorzugt Premium-Lack..."></textarea>
                </div>
                <div class="form-group">
                    <label for="partnerCode">ðŸ¤ Partner-Code (B2B)</label>
                    <input type="text" id="partnerCode" placeholder="z.B. VW-BUCHEN-2024 (fÃ¼r AutohÃ¤user/Partner mit Portal-Zugang)">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        â„¹ï¸ Wenn dieser Kunde ein B2B-Partner mit Portal-Zugang ist, gib hier seinen Partner-Code ein.
                        Rabatt-Konditionen werden dann automatisch im Partner-Portal synchronisiert.
                    </small>
                </div>

                <!-- ========== PARTNER-ZUGANG INFO (Read-Only, nur beim Bearbeiten) ========== -->
                <div id="partnerAccessInfo" class="form-group" style="display: none; background: #f0f8ff; border: 2px solid #4169e1; border-radius: 10px; padding: 15px; margin-top: 15px;">
                    <label style="font-weight: 600; color: #4169e1; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; font-size: 15px;">
                        ðŸ” Partner Portal-Zugang
                    </label>

                    <div class="partner-access-box" style="background: white; padding: 12px; border-radius: 8px;">
                        <p style="margin: 6px 0; font-size: 14px; color: #666;">
                            <strong style="color: #333;">Email:</strong>
                            <span id="partnerAccessEmail" style="color: #000; font-family: monospace;"></span>
                        </p>

                        <!-- Passwort noch nicht geÃ¤ndert -->
                        <div id="partnerPasswordNotChanged" style="display: none; margin-top: 10px; padding: 10px; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107;">
                            <p style="margin: 4px 0; font-size: 13px; color: #856404;">
                                <strong>âš ï¸ Status:</strong> Passwort noch nicht geÃ¤ndert
                            </p>
                            <p style="margin: 8px 0 4px 0; font-size: 13px; color: #856404;">
                                <strong>Initial-Passwort:</strong>
                            </p>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <code id="partnerInitialPw" style="flex: 1; background: white; padding: 8px 10px; border: 1px solid #ffc107; border-radius: 4px; font-size: 14px; font-family: 'Courier New', monospace;"></code>
                                <button type="button" onclick="copyPartnerPassword()" class="btn-sm" style="background: #ffc107; color: #000; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 14px;">ðŸ“‹ Kopieren</button>
                            </div>
                            <p style="margin: 8px 0 0 0; font-size: 11px; color: #856404;">
                                Partner muss beim ersten Login das Passwort Ã¤ndern.
                            </p>
                        </div>

                        <!-- Passwort wurde geÃ¤ndert -->
                        <div id="partnerPasswordChanged" style="display: none; margin-top: 10px; padding: 10px; background: #d4edda; border-radius: 6px; border-left: 4px solid #28a745;">
                            <p style="margin: 0; font-size: 13px; color: #155724;">
                                âœ… <strong>Passwort geÃ¤ndert am:</strong> <span id="pwChangedDate"></span>
                            </p>
                        </div>

                        <!-- Account noch nicht erstellt -->
                        <div id="partnerAccountNotCreated" style="display: none; margin-top: 10px; padding: 10px; background: #e7f3ff; border-radius: 6px; border-left: 4px solid #2196f3;">
                            <p style="margin: 0; font-size: 13px; color: #0c5460;">
                                â„¹ï¸ Firebase Auth Account wird beim Speichern automatisch erstellt.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label style="font-weight: 600; color: #003366; margin-bottom: 10px; display: block;">ðŸ·ï¸ Tags</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <label class="tag-checkbox">
                            <input type="checkbox" id="tagVip" value="vip">
                            <span class="tag-chip tag-chip-vip" style="margin: 0;">â­ VIP</span>
                        </label>
                        <label class="tag-checkbox">
                            <input type="checkbox" id="tagStammkunde" value="stammkunde">
                            <span class="tag-chip tag-chip-stammkunde" style="margin: 0;">ðŸ’š Stammkunde</span>
                        </label>
                        <label class="tag-checkbox">
                            <input type="checkbox" id="tagNeukunde" value="neukunde">
                            <span class="tag-chip tag-chip-neukunde" style="margin: 0;">âœ¨ Neukunde</span>
                        </label>
                        <label class="tag-checkbox">
                            <input type="checkbox" id="tagFlotte" value="flotte">
                            <span class="tag-chip tag-chip-flotte" style="margin: 0;">ðŸš— Flotte</span>
                        </label>
                        <label class="tag-checkbox">
                            <input type="checkbox" id="tagGewerbe" value="gewerbe">
                            <span class="tag-chip tag-chip-gewerbe" style="margin: 0;">ðŸ¢ Gewerbe</span>
                        </label>
                        <label class="tag-checkbox">
                            <input type="checkbox" id="tagPrivat" value="privat">
                            <span class="tag-chip tag-chip-privat" style="margin: 0;">ðŸ‘¤ Privat</span>
                        </label>
                    </div>
                </div>

                <!-- RABATT-KONDITIONEN (NEU) -->
                <div class="form-group" style="border-top: 2px solid #e0e0e0; padding-top: 20px; margin-top: 20px;">
                    <label style="font-weight: 600; color: #2196f3; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; font-size: 16px;">
                        ðŸŽ Individuelle Rabatt-Konditionen (B2B)
                    </label>

                    <!-- Rabatt-Stufen -->
                    <div style="background: #f5f5f5; padding: 15px; border-radius: 10px; margin-bottom: 12px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 10px;">
                            <!-- Stufe 1 -->
                            <div style="background: white; padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0;">
                                <div style="font-weight: 600; color: #666; margin-bottom: 8px; font-size: 12px;">STUFE 1 (Einstieg)</div>

                                <!-- Zeile 1: Laufender Rabatt -->
                                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                    <input type="number" id="rabattStufe1Prozent" placeholder="5" min="0" max="100" step="0.5"
                                           style="width: 60px; padding: 6px; border: 1px solid #ddd; border-radius: 6px; text-align: center;">
                                    <span style="align-self: center; font-weight: 600; font-size: 12px;">%</span>
                                    <span style="align-self: center; color: #666; font-size: 12px;">ab</span>
                                    <input type="number" id="rabattStufe1Ab" placeholder="2000" min="0" step="100"
                                           style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 6px; text-align: right;">
                                    <span style="align-self: center; font-weight: 600; font-size: 12px;">â‚¬/Monat</span>
                                </div>

                                <!-- Zeile 2: Einmal-Bonus -->
                                <div style="display: flex; gap: 8px; padding-top: 8px; border-top: 1px solid #eee;">
                                    <span style="align-self: center; color: #666; font-size: 11px; width: 50px;">ðŸŽ Bonus:</span>
                                    <input type="number" id="rabattStufe1Bonus" placeholder="100" min="0" step="10"
                                           style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 6px; text-align: right;">
                                    <span style="align-self: center; font-weight: 600; font-size: 12px;">â‚¬</span>
                                    <span style="align-self: center; color: #999; font-size: 10px;">(1x)*</span>
                                </div>
                            </div>

                            <!-- Stufe 2 -->
                            <div style="background: white; padding: 12px; border-radius: 8px; border: 2px solid #4caf50;">
                                <div style="font-weight: 600; color: #4caf50; margin-bottom: 8px; font-size: 12px;">STUFE 2 (Stammkunde)</div>

                                <!-- Zeile 1: Laufender Rabatt -->
                                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                    <input type="number" id="rabattStufe2Prozent" placeholder="10" min="0" max="100" step="0.5"
                                           style="width: 60px; padding: 6px; border: 1px solid #ddd; border-radius: 6px; text-align: center;">
                                    <span style="align-self: center; font-weight: 600; font-size: 12px;">%</span>
                                    <span style="align-self: center; color: #666; font-size: 12px;">ab</span>
                                    <input type="number" id="rabattStufe2Ab" placeholder="5000" min="0" step="100"
                                           style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 6px; text-align: right;">
                                    <span style="align-self: center; font-weight: 600; font-size: 12px;">â‚¬/Monat</span>
                                </div>

                                <!-- Zeile 2: Einmal-Bonus -->
                                <div style="display: flex; gap: 8px; padding-top: 8px; border-top: 1px solid #eee;">
                                    <span style="align-self: center; color: #666; font-size: 11px; width: 50px;">ðŸŽ Bonus:</span>
                                    <input type="number" id="rabattStufe2Bonus" placeholder="500" min="0" step="50"
                                           style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 6px; text-align: right;">
                                    <span style="align-self: center; font-weight: 600; font-size: 12px;">â‚¬</span>
                                    <span style="align-self: center; color: #999; font-size: 10px;">(1x)*</span>
                                </div>
                            </div>

                            <!-- Stufe 3 -->
                            <div style="background: white; padding: 12px; border-radius: 8px; border: 2px solid #ff9800;">
                                <div style="font-weight: 600; color: #ff9800; margin-bottom: 8px; font-size: 12px;">STUFE 3 (VIP)</div>

                                <!-- Zeile 1: Laufender Rabatt -->
                                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                    <input type="number" id="rabattStufe3Prozent" placeholder="15" min="0" max="100" step="0.5"
                                           style="width: 60px; padding: 6px; border: 1px solid #ddd; border-radius: 6px; text-align: center;">
                                    <span style="align-self: center; font-weight: 600; font-size: 12px;">%</span>
                                    <span style="align-self: center; color: #666; font-size: 12px;">ab</span>
                                    <input type="number" id="rabattStufe3Ab" placeholder="10000" min="0" step="100"
                                           style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 6px; text-align: right;">
                                    <span style="align-self: center; font-weight: 600; font-size: 12px;">â‚¬/Monat</span>
                                </div>

                                <!-- Zeile 2: Einmal-Bonus -->
                                <div style="display: flex; gap: 8px; padding-top: 8px; border-top: 1px solid #eee;">
                                    <span style="align-self: center; color: #666; font-size: 11px; width: 50px;">ðŸŽ Bonus:</span>
                                    <input type="number" id="rabattStufe3Bonus" placeholder="1500" min="0" step="100"
                                           style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 6px; text-align: right;">
                                    <span style="align-self: center; font-weight: 600; font-size: 12px;">â‚¬</span>
                                    <span style="align-self: center; color: #999; font-size: 10px;">(1x)*</span>
                                </div>
                            </div>
                        </div>

                        <!-- Hinweis -->
                        <div style="margin-top: 10px; padding: 8px; background: #fff3cd; border-radius: 6px; font-size: 11px; color: #856404;">
                            <strong>Hinweis:</strong> Laufender Rabatt wird automatisch angewendet. * Einmal-Bonus wird in Phase 2 implementiert (Auszahlung nach erstmaligem Erreichen der Stufe).
                        </div>
                    </div>

                    <!-- Konditionen telefonisch geklÃ¤rt -->
                    <div style="background: #fff3e0; border: 2px solid #ff9800; border-radius: 10px; padding: 15px; margin-bottom: 12px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 10px;">
                            <input type="checkbox" id="konditionenGeprueft"
                                   style="width: 20px; height: 20px; cursor: pointer;"
                                   onchange="document.getElementById('konditionenDatum').disabled = !this.checked;">
                            <span style="font-weight: 600; color: #e65100;">âœ… Konditionen telefonisch geklÃ¤rt</span>
                        </label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="color: #666; font-size: 14px;">Datum:</label>
                            <input type="date" id="konditionenDatum" disabled
                                   style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 6px; background: white;">
                        </div>
                    </div>

                    <!-- Hinweis -->
                    <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 12px; border-radius: 6px; font-size: 13px; color: #1565c0; line-height: 1.6;">
                        <strong>âš ï¸ Wichtig:</strong> Rabatt-Konditionen mÃ¼ssen telefonisch mit dem Kunden vereinbart werden, bevor Rabatte gewÃ¤hrt werden.
                        Dies gilt nur fÃ¼r B2B-Kunden (AutohÃ¤user, Flotten, Gewerbetreibende).
                    </div>
                </div>

                <button type="submit" class="btn btn-success" style="width: 100%;">ðŸ’¾ Kunde speichern</button>
            </form>
        </div>
    </div>

    <!-- Modal: Kunden-Details -->
    <div id="kundenDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="kundenDetailName">ðŸ‘¤ Kundendetails</h2>
                <button class="close-btn" onclick="closeKundenDetailModal()">&times;</button>
            </div>

            <div id="kundenDetailContent">
                <!-- Dynamisch gefÃ¼llt -->
            </div>

            <div class="historie-section">
                <h3>ðŸ“‹ Auftragshistorie</h3>
                <div id="kundenHistorie">
                    <!-- Dynamisch gefÃ¼llt -->
                </div>
            </div>
        </div>
    </div>

    <!-- ========== PARTNER-PASSWORT-MODAL (NEU) ========== -->
    <div id="partnerPasswordModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h2 style="margin: 0;">âœ… Partner-Account erstellt</h2>
                <button class="close-btn" onclick="closePartnerPasswordModal()" style="color: white; opacity: 0.9;">&times;</button>
            </div>

            <div class="password-box" style="background: #f8f9fa; padding: 25px; border-radius: 8px; margin: 20px 0;">
                <div style="margin-bottom: 20px;">
                    <p style="margin: 8px 0; font-size: 14px; color: #666;">
                        <strong style="color: #333;">Partner-Name:</strong> <span id="pwModalName" style="color: #000;"></span>
                    </p>
                    <p style="margin: 8px 0; font-size: 14px; color: #666;">
                        <strong style="color: #333;">Email:</strong> <span id="pwModalEmail" style="color: #000;"></span>
                    </p>
                    <p style="margin: 8px 0; font-size: 14px; color: #666;">
                        <strong style="color: #333;">Partner-ID:</strong> <span id="pwModalPartnerId" style="color: #000;"></span>
                    </p>
                </div>

                <hr style="border: none; border-top: 2px solid #dee2e6; margin: 20px 0;">

                <div style="margin-bottom: 15px;">
                    <p style="font-weight: 600; color: #495057; margin-bottom: 10px; font-size: 15px;">ðŸ” Initial-Passwort:</p>
                    <div class="password-display" style="display: flex; gap: 10px; align-items: center;">
                        <code id="pwModalPassword" style="flex: 1; background: white; padding: 12px 15px; border: 2px solid #667eea; border-radius: 6px; font-size: 18px; font-family: 'Courier New', monospace; letter-spacing: 1px; color: #2d3748;"></code>
                        <button onclick="copyPasswordToClipboard()" class="btn-icon" style="background: #667eea; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-size: 18px; transition: all 0.2s;" title="In Zwischenablage kopieren">ðŸ“‹</button>
                    </div>
                </div>

                <div class="alert alert-warning" style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 12px 15px; border-radius: 6px; margin-top: 15px;">
                    <p style="margin: 0; font-size: 13px; line-height: 1.6; color: #856404;">
                        <strong>âš ï¸ Wichtig:</strong> Dieses Passwort wird nur EINMAL angezeigt!<br>
                        Der Partner muss es beim ersten Login Ã¤ndern.<br>
                        <strong>Bitte notieren oder direkt an Partner weiterleiten.</strong>
                    </p>
                </div>
            </div>

            <button onclick="closePartnerPasswordModal()" class="btn btn-primary" style="width: 100%; padding: 12px; font-size: 16px; font-weight: 600;">Verstanden</button>
        </div>
    </div>

    <script>
        /// <reference path="js/types.js" />

        /**
         * All customers (cached from Firestore)
         * @type {Kunde[]}
         */
        let allKunden = [];

        /**
         * All vehicles (cached from Firestore)
         * @type {Fahrzeug[]}
         */
        let allFahrzeuge = [];

        /**
         * Firebase initialization status
         * @type {boolean}
         */
        let firebaseInitialized = false;

        // firebaseApp is provided by firebase-config.js as window.firebaseApp

        /**
         * Currently selected customer ID (for edit modal)
         * @type {string|null}
         */
        let currentKundeId = null;

        /**
         * Current revenue filter timeframe
         * @type {'gesamt'|'jahr'|'monat'}
         */
        let currentUmsatzFilter = 'gesamt'; // gesamt, jahr, monat

        // ================== TAG SYSTEM ==================
        const AVAILABLE_TAGS = {
            vip: {
                id: 'vip',
                name: 'VIP',
                icon: 'â­',
                color: '#ffc107',
                bgColor: '#fff3cd',
                textColor: '#856404',
                description: 'VIP-Kunde mit hoher PrioritÃ¤t'
            },
            stammkunde: {
                id: 'stammkunde',
                name: 'Stammkunde',
                icon: 'ðŸ’š',
                color: '#28a745',
                bgColor: '#d4edda',
                textColor: '#155724',
                description: 'RegelmÃ¤ÃŸiger Kunde (3+ Besuche)'
            },
            neukunde: {
                id: 'neukunde',
                name: 'Neukunde',
                icon: 'âœ¨',
                color: '#17a2b8',
                bgColor: '#d1ecf1',
                textColor: '#0c5460',
                description: 'Neuer Kunde (1-2 Besuche)'
            },
            flotte: {
                id: 'flotte',
                name: 'Flotte',
                icon: 'ðŸš—',
                color: '#6f42c1',
                bgColor: '#e2d9f3',
                textColor: '#4a2c7a',
                description: 'Flottenkunde mit mehreren Fahrzeugen'
            },
            gewerbe: {
                id: 'gewerbe',
                name: 'Gewerbe',
                icon: 'ðŸ¢',
                color: '#fd7e14',
                bgColor: '#ffe5d0',
                textColor: '#8a3f00',
                description: 'Gewerblicher Kunde'
            },
            privat: {
                id: 'privat',
                name: 'Privat',
                icon: 'ðŸ‘¤',
                color: '#6c757d',
                bgColor: '#e2e3e5',
                textColor: '#383d41',
                description: 'Privatkunde'
            }
        };

        let activeTagFilters = new Set(); // Aktive Tag-Filter
        let currentViewMode = 'table'; // 'table' oder 'cards'

        // ================== PAGINATION & SORTING ==================
        let currentPage = 1;
        let itemsPerPage = 25; // Default: 25 pro Seite
        let sortColumn = 'letzterBesuch'; // Default: Sortierung nach letztem Besuch
        let sortDirection = 'desc'; // 'asc' oder 'desc'

        // Advanced Filters
        let advancedFilters = {
            umsatzMin: null,
            umsatzMax: null,
            dateFrom: null,
            dateTo: null
        };

        // ================== TAG FUNCTIONS ==================

        // Tag zu Kunde hinzufÃ¼gen
        function addTagToKunde(kundeId, tagId) {
            const kunde = allKunden.find(k => window.compareIds(k.id, kundeId));
            if (!kunde) return;

            if (!kunde.tags) kunde.tags = [];
            if (!kunde.tags.includes(tagId)) {
                kunde.tags.push(tagId);
                saveKundeToFirebase(kunde);
                showSuccessToast(`Tag "${AVAILABLE_TAGS[tagId].name}" hinzugefÃ¼gt`);
            }
        }

        // Tag von Kunde entfernen
        function removeTagFromKunde(kundeId, tagId) {
            const kunde = allKunden.find(k => window.compareIds(k.id, kundeId));
            if (!kunde) return;

            if (kunde.tags) {
                kunde.tags = kunde.tags.filter(t => t !== tagId);
                saveKundeToFirebase(kunde);
                showSuccessToast(`Tag "${AVAILABLE_TAGS[tagId].name}" entfernt`);
            }
        }

        // Auto-assign Tags basierend auf GeschÃ¤ftsregeln
        function autoAssignTags(kunde) {
            if (!kunde.tags) kunde.tags = [];

            const besuchsAnzahl = kunde.besuchsAnzahl || 0;
            const umsatz = calculateKundenUmsatz(kunde.id, currentUmsatzFilter);

            // VIP: Umsatz Ã¼ber 5000â‚¬
            if (umsatz >= 5000 && !kunde.tags.includes('vip')) {
                kunde.tags.push('vip');
            }

            // Stammkunde: 3+ Besuche
            if (besuchsAnzahl >= 3 && !kunde.tags.includes('stammkunde')) {
                kunde.tags.push('stammkunde');
                // Entferne Neukunde wenn Stammkunde
                kunde.tags = kunde.tags.filter(t => t !== 'neukunde');
            }

            // Neukunde: 1-2 Besuche
            if (besuchsAnzahl >= 1 && besuchsAnzahl <= 2 && !kunde.tags.includes('neukunde') && !kunde.tags.includes('stammkunde')) {
                kunde.tags.push('neukunde');
            }

            // Flotte: 5+ Fahrzeuge
            const kundenFahrzeuge = allFahrzeuge.filter(f => f.kundenName?.toLowerCase() === kunde.name?.toLowerCase());
            if (kundenFahrzeuge.length >= 5 && !kunde.tags.includes('flotte')) {
                kunde.tags.push('flotte');
            }

            return kunde.tags;
        }

        // Rendere Tag-Chips (fÃ¼r Tabelle/Cards)
        function renderTagChips(tags) {
            if (!tags || tags.length === 0) {
                return '<span style="color: #999; font-size: 12px;">Keine Tags</span>';
            }

            return tags.map(tagId => {
                const tag = AVAILABLE_TAGS[tagId];
                if (!tag) return '';
                return `<span class="tag-chip tag-chip-${tagId}" style="font-size: 11px; padding: 4px 10px; margin: 2px;">${tag.icon} ${tag.name}</span>`;
            }).join(' ');
        }

        // Toggle Tag Filter
        function toggleTagFilter(tagId) {
            const chipElement = document.querySelector(`.tag-filter-bar .tag-chip-${tagId}`);

            if (activeTagFilters.has(tagId)) {
                activeTagFilters.delete(tagId);
                chipElement?.classList.remove('active');
            } else {
                activeTagFilters.add(tagId);
                chipElement?.classList.add('active');
            }

            renderKundenView();
        }

        // Clear all tag filters
        function clearTagFilters() {
            activeTagFilters.clear();
            document.querySelectorAll('.tag-filter-bar .tag-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            renderKundenView();
        }

        // ================== PAGINATION FUNCTIONS ==================

        let totalFilteredKunden = 0; // Wird in getFilteredKunden() aktualisiert

        function goToPage(page) {
            const totalPages = Math.ceil(totalFilteredKunden / itemsPerPage);
            if (page < 1 || page > totalPages) return;

            currentPage = page;
            renderKundenView();
            updatePaginationControls();

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function changeItemsPerPage(newSize) {
            itemsPerPage = parseInt(newSize);
            currentPage = 1; // Reset to first page
            renderKundenView();
            updatePaginationControls();
        }

        function updatePaginationControls() {
            const totalPages = Math.ceil(totalFilteredKunden / itemsPerPage);
            const startItem = totalFilteredKunden === 0 ? 0 : (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, totalFilteredKunden);

            // Update info text
            const infoEl = document.getElementById('paginationInfo');
            if (infoEl) {
                infoEl.textContent = `Zeige ${startItem}-${endItem} von ${totalFilteredKunden} Kunden`;
            }

            // Update button states
            const firstBtn = document.getElementById('firstPageBtn');
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            const lastBtn = document.getElementById('lastPageBtn');

            if (firstBtn) firstBtn.disabled = currentPage === 1;
            if (prevBtn) prevBtn.disabled = currentPage === 1;
            if (nextBtn) nextBtn.disabled = currentPage === totalPages || totalPages === 0;
            if (lastBtn) lastBtn.disabled = currentPage === totalPages || totalPages === 0;

            // Render page numbers
            renderPageNumbers(totalPages);

            // Hide pagination if only 1 page
            const paginationContainer = document.getElementById('paginationContainer');
            if (paginationContainer) {
                paginationContainer.style.display = totalPages <= 1 ? 'none' : 'flex';
            }
        }

        function renderPageNumbers(totalPages) {
            const pageNumbersEl = document.getElementById('pageNumbers');
            if (!pageNumbersEl) return;

            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            // Adjust if we're near the end
            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            let html = '';
            for (let i = startPage; i <= endPage; i++) {
                const activeClass = i === currentPage ? 'active' : '';
                html += `<button class="pagination-btn ${activeClass}" onclick="goToPage(${i})">${i}</button>`;
            }

            pageNumbersEl.innerHTML = html;
        }

        // ================== SORTING FUNCTIONS ==================

        function sortTable(column) {
            // Toggle direction if same column clicked
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            // Update UI
            document.querySelectorAll('.kunden-table th.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });

            const headerMap = {
                'name': 0,
                'besuche': 2,
                'umsatz': 3,
                'letzterBesuch': 4
            };

            const thIndex = headerMap[column];
            if (thIndex !== undefined) {
                const th = document.querySelectorAll('.kunden-table th.sortable')[Object.keys(headerMap).indexOf(column)];
                if (th) {
                    th.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            }

            renderKundenView();
        }

        function sortKunden(kunden) {
            return kunden.sort((a, b) => {
                let valueA, valueB;

                switch (sortColumn) {
                    case 'name':
                        valueA = a.name?.toLowerCase() || '';
                        valueB = b.name?.toLowerCase() || '';
                        break;
                    case 'besuche':
                        valueA = a.anzahlBesuche || 0;
                        valueB = b.anzahlBesuche || 0;
                        break;
                    case 'umsatz':
                        valueA = calculateKundenUmsatz(a.id, currentUmsatzFilter);
                        valueB = calculateKundenUmsatz(b.id, currentUmsatzFilter);
                        break;
                    case 'letzterBesuch':
                        valueA = a.letzterBesuch ? new Date(a.letzterBesuch) : new Date(0);
                        valueB = b.letzterBesuch ? new Date(b.letzterBesuch) : new Date(0);
                        break;
                    default:
                        return 0;
                }

                if (valueA < valueB) return sortDirection === 'asc' ? -1 : 1;
                if (valueA > valueB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
        }

        // ================== ADVANCED FILTERS ==================

        function toggleAdvancedFilters() {
            const content = document.getElementById('advancedFiltersContent');
            const toggle = document.getElementById('advancedFiltersToggle');

            if (content && toggle) {
                const isActive = content.classList.toggle('active');
                toggle.textContent = isActive ? 'â–²' : 'â–¼';
            }
        }

        function applyAdvancedFilters() {
            advancedFilters.umsatzMin = parseFloat(document.getElementById('umsatzMin')?.value) || null;
            advancedFilters.umsatzMax = parseFloat(document.getElementById('umsatzMax')?.value) || null;
            advancedFilters.dateFrom = document.getElementById('dateFrom')?.value || null;
            advancedFilters.dateTo = document.getElementById('dateTo')?.value || null;

            currentPage = 1; // Reset to first page
            renderKundenView();
            showSuccessToast('Filter angewendet!');
        }

        function resetAdvancedFilters() {
            advancedFilters = {
                umsatzMin: null,
                umsatzMax: null,
                dateFrom: null,
                dateTo: null
            };

            document.getElementById('umsatzMin').value = '';
            document.getElementById('umsatzMax').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';

            currentPage = 1;
            renderKundenView();
            showInfoToast('Filter zurÃ¼ckgesetzt');
        }

        // ================== CHARTS & ANALYTICS ==================

        let topKundenChart = null;
        let tagDistributionChart = null;

        function toggleCharts() {
            const section = document.getElementById('chartsSection');
            const btn = document.getElementById('chartToggleBtn');

            if (section && btn) {
                const isCollapsed = section.classList.toggle('collapsed');
                btn.textContent = isCollapsed ? 'ðŸ“ˆ Charts einblenden' : 'ðŸ“‰ Charts ausblenden';
            }
        }

        // ============================================
        //  ðŸŽ¨ THEME-HELPER FÃœR CHARTS (Dark Mode)
        // ============================================

        // Erkennt ob Dark Mode aktiv ist
        function isDarkMode() {
            return document.documentElement.getAttribute('data-theme') === 'dark';
        }

        // Gibt Chart-Farben basierend auf Theme zurÃ¼ck
        function getChartColors() {
            const isDark = isDarkMode();
            return {
                textColor: isDark ? 'rgba(255, 255, 255, 0.9)' : '#666',
                gridColor: isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)',
                borderColor: isDark ? 'rgba(255, 255, 255, 0.2)' : '#fff'
            };
        }

        function renderCharts() {
            renderTopKundenChart();
            renderTagDistributionChart();
            updateAdvancedStats();
        }

        function renderTopKundenChart() {
            const ctx = document.getElementById('topKundenChart');
            if (!ctx) return;

            // Get top 10 customers by revenue
            const kundenMitUmsatz = allKunden.map(kunde => ({
                name: kunde.name,
                umsatz: calculateKundenUmsatz(kunde.id, currentUmsatzFilter)
            })).filter(k => k.umsatz > 0)
              .sort((a, b) => b.umsatz - a.umsatz)
              .slice(0, 10);

            if (kundenMitUmsatz.length === 0) {
                if (topKundenChart) {
                    topKundenChart.destroy();
                    topKundenChart = null;
                }
                return;
            }

            const labels = kundenMitUmsatz.map(k => k.name);
            const data = kundenMitUmsatz.map(k => k.umsatz);

            // Destroy existing chart
            if (topKundenChart) {
                topKundenChart.destroy();
            }

            // âœ… Get colors based on theme
            const colors = getChartColors();

            topKundenChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Umsatz (â‚¬)',
                        data: data,
                        backgroundColor: 'rgba(0, 51, 102, 0.8)',
                        borderColor: 'rgba(0, 51, 102, 1)',
                        borderWidth: 2,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Umsatz: ' + context.parsed.y.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' â‚¬';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: colors.textColor, // âœ… Dark Mode Support
                                callback: function(value) {
                                    return value.toLocaleString('de-DE') + ' â‚¬';
                                }
                            },
                            grid: {
                                color: colors.gridColor // âœ… Dark Mode Support
                            }
                        },
                        x: {
                            ticks: {
                                color: colors.textColor, // âœ… Dark Mode Support
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                color: colors.gridColor // âœ… Dark Mode Support
                            }
                        }
                    }
                }
            });
        }

        function renderTagDistributionChart() {
            const ctx = document.getElementById('tagDistributionChart');
            if (!ctx) return;

            // Count tags
            const tagCounts = {};
            Object.keys(AVAILABLE_TAGS).forEach(tagId => {
                tagCounts[tagId] = 0;
            });

            allKunden.forEach(kunde => {
                if (kunde.tags && kunde.tags.length > 0) {
                    kunde.tags.forEach(tagId => {
                        if (tagCounts[tagId] !== undefined) {
                            tagCounts[tagId]++;
                        }
                    });
                }
            });

            const labels = [];
            const data = [];
            const tagColors = []; // Renamed to avoid conflict with getChartColors()

            Object.keys(tagCounts).forEach(tagId => {
                if (tagCounts[tagId] > 0) {
                    const tag = AVAILABLE_TAGS[tagId];
                    labels.push(tag.icon + ' ' + tag.name);
                    data.push(tagCounts[tagId]);
                    tagColors.push(tag.color);
                }
            });

            if (data.length === 0) {
                if (tagDistributionChart) {
                    tagDistributionChart.destroy();
                    tagDistributionChart = null;
                }
                return;
            }

            // Destroy existing chart
            if (tagDistributionChart) {
                tagDistributionChart.destroy();
            }

            // âœ… Get colors based on theme
            const chartColors = getChartColors();

            tagDistributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: tagColors,
                        borderWidth: 2,
                        borderColor: chartColors.borderColor // âœ… Dark Mode Support
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12
                                },
                                color: chartColors.textColor // âœ… Dark Mode Support
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return context.label + ': ' + context.parsed + ' Kunden (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateAdvancedStats() {
            // Average Revenue
            const totalRevenue = allKunden.reduce((sum, kunde) => {
                return sum + calculateKundenUmsatz(kunde.id, currentUmsatzFilter);
            }, 0);
            const avgRevenue = allKunden.length > 0 ? totalRevenue / allKunden.length : 0;
            document.getElementById('avgUmsatz').textContent = avgRevenue.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' â‚¬';

            // Top Customer
            const topKunde = allKunden.map(k => ({
                name: k.name,
                umsatz: calculateKundenUmsatz(k.id, currentUmsatzFilter)
            })).sort((a, b) => b.umsatz - a.umsatz)[0];

            if (topKunde) {
                document.getElementById('topKundeName').textContent = topKunde.name;
                document.getElementById('topKundeUmsatz').textContent = topKunde.umsatz.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' â‚¬ Umsatz';
            } else {
                document.getElementById('topKundeName').textContent = '-';
                document.getElementById('topKundeUmsatz').textContent = '0,00 â‚¬ Umsatz';
            }

            // Most Used Tag
            const tagCounts = {};
            Object.keys(AVAILABLE_TAGS).forEach(tagId => tagCounts[tagId] = 0);
            allKunden.forEach(kunde => {
                if (kunde.tags) kunde.tags.forEach(tagId => {
                    if (tagCounts[tagId] !== undefined) tagCounts[tagId]++;
                });
            });

            const topTagEntry = Object.entries(tagCounts).sort((a, b) => b[1] - a[1])[0];
            if (topTagEntry && topTagEntry[1] > 0) {
                const tag = AVAILABLE_TAGS[topTagEntry[0]];
                document.getElementById('topTag').textContent = tag.icon + ' ' + tag.name;
                document.getElementById('topTagCount').textContent = topTagEntry[1] + ' Kunden';
            } else {
                document.getElementById('topTag').textContent = '-';
                document.getElementById('topTagCount').textContent = '0 Kunden';
            }

            // Growth Rate (new customers this month)
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            const newThisMonth = allKunden.filter(kunde => {
                if (!kunde.erstbesuch) return false;
                const erstbesuch = new Date(kunde.erstbesuch);
                return erstbesuch.getMonth() === currentMonth && erstbesuch.getFullYear() === currentYear;
            }).length;

            const lastMonth = new Date(now);
            lastMonth.setMonth(lastMonth.getMonth() - 1);
            const lastMonthCount = allKunden.filter(kunde => {
                if (!kunde.erstbesuch) return false;
                const erstbesuch = new Date(kunde.erstbesuch);
                return erstbesuch.getMonth() === lastMonth.getMonth() && erstbesuch.getFullYear() === lastMonth.getFullYear();
            }).length;

            const growthRate = lastMonthCount > 0 ? ((newThisMonth - lastMonthCount) / lastMonthCount * 100) : (newThisMonth > 0 ? 100 : 0);
            const growthSign = growthRate > 0 ? '+' : '';
            document.getElementById('growthRate').textContent = growthSign + growthRate.toFixed(0) + '%';
        }

        // ================== TOAST NOTIFICATIONS ==================

        function showToast(message, type = 'info', duration = 3000) {
            const toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) return;

            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;

            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                warning: 'âš ï¸',
                info: 'â„¹ï¸'
            };

            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || icons.info}</div>
                <div class="toast-message">${message}</div>
            `;

            toastContainer.appendChild(toast);

            // Animate in
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateY(0)';
            }, 10);

            // Remove after duration
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px)';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        function showSuccessToast(message) {
            showToast(message, 'success', 2500);
        }

        function showErrorToast(message) {
            showToast(message, 'error', 4000);
        }

        function showWarningToast(message) {
            showToast(message, 'warning', 3500);
        }

        function showInfoToast(message) {
            showToast(message, 'info', 3000);
        }

        // ================== VIEW MODE & RESPONSIVE ==================

        // Set view mode (table or cards)
        function setViewMode(mode) {
            currentViewMode = mode;

            const tableBtn = document.getElementById('viewTableBtn');
            const cardsBtn = document.getElementById('viewCardsBtn');

            if (mode === 'table') {
                tableBtn?.classList.add('active');
                cardsBtn?.classList.remove('active');
                document.body.classList.remove('view-cards');
            } else {
                cardsBtn?.classList.add('active');
                tableBtn?.classList.remove('active');
                document.body.classList.add('view-cards');
            }

            renderKundenView();
        }

        // Detect responsive breakpoint
        function isMobileView() {
            return window.innerWidth <= 768;
        }

        // Update view mode on resize
        const resizeHandler = debounce(() => {
            renderKundenView();
        }, 250);
        window.listenerRegistry.registerDOM(window, 'resize', resizeHandler, 'Kunden View Resize Handler');

        // Hauptfunktion: Entscheidet zwischen Tabelle und Cards
        function renderKundenView() {
            if (isMobileView()) {
                // Mobile: IMMER Cards
                renderKundenCards();
            } else if (currentViewMode === 'cards') {
                // Desktop + Karten-Modus aktiv: Cards
                renderKundenCards();
            } else {
                // Desktop + Tabellen-Modus (Standard): Table
                renderKundenTable();
            }
        }

        // Debounce utility
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ================== MOBILE CARD RENDERING ==================

        // Rendere Kunden als Cards (Mobile)
        function renderKundenCards() {
            const container = document.getElementById('kundenCardsContainer');
            const tableContainer = document.querySelector('.kunden-table');
            const emptyState = document.getElementById('emptyState');

            if (!container) return;

            // ðŸ¦´ SKELETON LOADER: Hide skeleton when cards render
            const skeleton = document.getElementById('kundenSkeleton');
            if (skeleton && skeleton.style.display !== 'none') {
                skeleton.style.display = 'none';
                console.log('âœ… [SKELETON] Skeleton hidden, kunden cards visible');
            }

            // âœ… Filter Kunden with pagination
            let filteredKunden = getFilteredKunden(true);

            if (totalFilteredKunden === 0) {
                container.innerHTML = '';
                container.style.display = 'none'; // âœ… Cards Container verstecken (leer)
                if (tableContainer) tableContainer.style.display = 'none';
                if (emptyState) emptyState.style.display = 'block';
                updatePaginationControls(); // Update even when empty
                return;
            }

            if (emptyState) emptyState.style.display = 'none';
            if (tableContainer) tableContainer.style.display = 'none';
            container.style.display = 'block'; // âœ… Cards Container sichtbar machen!

            container.innerHTML = filteredKunden.map(kunde => {
                const umsatz = calculateKundenUmsatz(kunde.id, currentUmsatzFilter);
                const besuchsAnzahl = kunde.besuchsAnzahl || 0;
                const status = besuchsAnzahl >= 2 ? 'ðŸ’š Stammkunde' : 'âœ¨ Neukunde';
                const statusClass = besuchsAnzahl >= 2 ? 'green' : 'blue';

                return `
                    <div class="kunde-card">
                        <div class="kunde-card-header">
                            <h3>${kunde.name || 'Unbekannt'}</h3>
                            <span class="kunde-badge kunde-badge-${statusClass}">${status}</span>
                        </div>

                        <div class="kunde-card-body">
                            <div class="kunde-info-row">
                                <span class="info-label">ðŸ“ž Telefon:</span>
                                <span class="info-value">${kunde.telefon || 'Nicht angegeben'}</span>
                            </div>
                            <div class="kunde-info-row">
                                <span class="info-label">ðŸ“§ Email:</span>
                                <span class="info-value">${kunde.email || 'Nicht angegeben'}</span>
                            </div>
                            <div class="kunde-info-row">
                                <span class="info-label">ðŸš— Besuche:</span>
                                <span class="info-value"><strong>${besuchsAnzahl}</strong></span>
                            </div>
                            <div class="kunde-info-row">
                                <span class="info-label">ðŸ’° Umsatz:</span>
                                <span class="info-value"><strong>${umsatz.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} â‚¬</strong></span>
                            </div>
                            <div class="kunde-info-row">
                                <span class="info-label">ðŸ·ï¸ Tags:</span>
                                <div style="flex: 1;">${renderTagChips(kunde.tags)}</div>
                            </div>
                        </div>

                        <div class="kunde-card-footer">
                            <button class="btn btn-sm btn-primary" onclick="openKundenDetail('${kunde.id}')" style="flex: 1;">
                                ðŸ‘ï¸ Details
                            </button>
                            <button class="btn btn-sm" onclick="deleteKunde('${kunde.id}')" style="background: #dc3545; color: white;">
                                ðŸ—‘ï¸
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            // âœ… Update pagination controls after rendering
            updatePaginationControls();
        }

        // Get filtered customers (search + tags)
        function getFilteredKunden(withPagination = false) {
            let filtered = [...allKunden];

            // Tag filter
            if (activeTagFilters.size > 0) {
                filtered = filtered.filter(kunde => {
                    if (!kunde.tags || kunde.tags.length === 0) return false;
                    return Array.from(activeTagFilters).some(tagId => kunde.tags.includes(tagId));
                });
            }

            // Search filter
            const searchTerm = document.getElementById('searchInput')?.value?.toLowerCase() || '';
            if (searchTerm) {
                filtered = filtered.filter(kunde => {
                    return kunde.name?.toLowerCase().includes(searchTerm) ||
                           kunde.telefon?.toLowerCase().includes(searchTerm) ||
                           kunde.email?.toLowerCase().includes(searchTerm);
                });
            }

            // âœ… Advanced Filters: Umsatz Range
            if (advancedFilters.umsatzMin !== null || advancedFilters.umsatzMax !== null) {
                filtered = filtered.filter(kunde => {
                    const umsatz = calculateKundenUmsatz(kunde.id, currentUmsatzFilter);
                    if (advancedFilters.umsatzMin !== null && umsatz < advancedFilters.umsatzMin) return false;
                    if (advancedFilters.umsatzMax !== null && umsatz > advancedFilters.umsatzMax) return false;
                    return true;
                });
            }

            // âœ… Advanced Filters: Date Range
            if (advancedFilters.dateFrom || advancedFilters.dateTo) {
                filtered = filtered.filter(kunde => {
                    if (!kunde.letzterBesuch) return false;
                    const besuchDate = new Date(kunde.letzterBesuch);

                    if (advancedFilters.dateFrom) {
                        const fromDate = new Date(advancedFilters.dateFrom);
                        if (besuchDate < fromDate) return false;
                    }

                    if (advancedFilters.dateTo) {
                        const toDate = new Date(advancedFilters.dateTo);
                        toDate.setHours(23, 59, 59, 999); // End of day
                        if (besuchDate > toDate) return false;
                    }

                    return true;
                });
            }

            // âœ… Update total count for pagination
            totalFilteredKunden = filtered.length;

            // âœ… Apply sorting
            filtered = sortKunden(filtered);

            // âœ… Apply pagination
            if (withPagination) {
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                filtered = filtered.slice(startIndex, endIndex);
            }

            return filtered;
        }

        // Firebase Initialisierung
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                if (typeof initFirebase !== 'undefined') {
                    // âœ… BUG FIX: PrÃ¼fe window.firebaseInitialized
                    await initFirebase();
                    if (window.firebaseInitialized && window.firebaseApp) {
                        firebaseApp = window.firebaseApp;
                        firebaseInitialized = true;
                        console.log('âœ… Firebase fÃ¼r Kunden initialisiert');

                        // Auth-Check fÃ¼r Multi-Tenant Support (Race Condition Fix)
                        console.log('ðŸ” [KUNDEN] PrÃ¼fe Auth State fÃ¼r Multi-Tenant...');
                        let currentUser = null;
                        let attempts = 0;
                        const maxAttempts = 20;

                        while (!currentUser && attempts < maxAttempts) {
                            currentUser = window.authManager?.getCurrentUser();
                            if (!currentUser) {
                                console.log(`â³ [KUNDEN] Warte auf Auth State (${attempts + 1}/${maxAttempts})...`);
                                await new Promise(resolve => setTimeout(resolve, 250));
                                attempts++;
                            }
                        }

                        if (!currentUser) {
                            console.warn('âš ï¸ [KUNDEN] Kein User eingeloggt - verwende globale Collections');
                        } else {
                            console.log('âœ… [KUNDEN] Auth State geladen');
                            console.log('   User:', currentUser.name);
                            console.log('   WerkstattId:', currentUser.werkstattId);

                            // ðŸ†• BUGFIX 2025-11-04 (FIX #41): Partner-Zugriff auf Werkstatt-Seiten blockieren
                            // Partner dÃ¼rfen nur das Partner-Portal nutzen, nicht Werkstatt-Seiten
                            const userRole = currentUser.rolle || currentUser.role; // Support both property names
                            if (userRole === 'partner') {
                                console.warn('ðŸš« Partner-Zugriff blockiert! Redirect zu Partner-Portal...');
                                window.location.href = './partner-app/meine-anfragen.html';
                                return; // Stop further execution
                            }
                        }

                        // Load Werkstatt-Logo & Branding
                        try {
                            const settings = await window.settingsManager.loadSettings();
                            if (settings?.profil) {
                                // Update Page Title
                                document.title = `${settings.profil.name} | Kundenverwaltung`;

                                // Display Logo
                                if (settings.profil.logoUrl) {
                                    const logoContainer = document.getElementById('werkstattLogo');
                                    if (logoContainer) {
                                        logoContainer.innerHTML = `
                                            <img src="${settings.profil.logoUrl}"
                                                 alt="${settings.profil.name}"
                                                 style="height: 32px; width: auto; vertical-align: middle;">
                                        `;
                                        console.log('âœ… [KUNDEN] Werkstatt-Logo angezeigt:', settings.profil.name);
                                    }
                                }
                            }
                        } catch (error) {
                            console.warn('âš ï¸ [KUNDEN] Werkstatt-Branding konnte nicht geladen werden:', error);
                        }
                    }
                }
            } catch (error) {
                console.warn('âš ï¸ Firebase nicht verfÃ¼gbar, verwende LocalStorage:', error);
            }

            // âœ… FIX: Parallel laden statt sequenziell fÃ¼r bessere Performance
            try {
                await Promise.all([
                    loadKunden(),
                    loadFahrzeuge()
                ]);

                // Jetzt sind BEIDE vollstÃ¤ndig geladen - Stats aktualisieren
                console.log('âœ… Kunden und Fahrzeuge vollstÃ¤ndig geladen');
                updateStats();

                // âœ… Auto-assign Tags fÃ¼r alle Kunden
                allKunden.forEach(kunde => {
                    autoAssignTags(kunde);
                });

                // âœ… NEW: Use responsive view rendering (table or cards based on screen size)
                renderKundenView();
                console.log('âœ… Ansicht gerendert mit korrekten Werten (responsive)');

                // âœ… Render Charts & Analytics
                renderCharts();
                console.log('âœ… Charts gerendert');
            } catch (error) {
                console.error('âŒ Fehler beim Laden der Daten:', error);
                // Fallback: Stats trotzdem aktualisieren (mit leeren Daten)
                updateStats();
                renderKundenView();
                renderCharts();
            }
        });

        // Kunden laden (Firebase + LocalStorage zusammenfÃ¼hren)
        async function loadKunden() {
            try {
                let firebaseKunden = [];
                let localKunden = [];

                // Firebase laden
                if (firebaseInitialized && firebaseApp) {
                    try {
                        firebaseKunden = await firebaseApp.getAllKunden();
                        console.log(`ðŸ“¦ ${firebaseKunden.length} Kunden aus Firebase geladen`);
                    } catch (error) {
                        console.warn('âš ï¸ Firebase Kunden konnten nicht geladen werden:', error);
                    }
                }

                // LocalStorage laden
                try {
                    localKunden = JSON.parse(localStorage.getItem('kunden') || '[]');
                    console.log(`ðŸ’¾ ${localKunden.length} Kunden aus LocalStorage geladen`);
                } catch (error) {
                    console.warn('âš ï¸ LocalStorage Kunden konnten nicht geladen werden:', error);
                    localKunden = [];
                }

                // ZusammenfÃ¼hren: Firebase hat Vorrang, keine Duplikate
                const firebaseIds = new Set(firebaseKunden.map(k => k.id));
                const uniqueLocalKunden = localKunden.filter(k => !firebaseIds.has(k.id));

                allKunden = [...firebaseKunden, ...uniqueLocalKunden];

                console.log(`âœ… ${allKunden.length} Kunden gesamt (${firebaseKunden.length} Firebase + ${uniqueLocalKunden.length} nur LocalStorage)`);
                // âœ… FIX: renderKundenTable() NICHT hier aufrufen - erst nach loadFahrzeuge()!
            } catch (error) {
                console.error('âŒ Fehler beim Laden der Kunden:', error);
                allKunden = [];
            }
        }

        // Fahrzeuge laden
        async function loadFahrzeuge() {
            try {
                if (firebaseInitialized && firebaseApp) {
                    allFahrzeuge = await firebaseApp.getAllFahrzeuge();
                } else {
                    allFahrzeuge = JSON.parse(localStorage.getItem('fahrzeuge') || '[]');
                }

                console.log(`âœ… ${allFahrzeuge.length} Fahrzeuge geladen`);
            } catch (error) {
                console.error('âŒ Fehler beim Laden der Fahrzeuge:', error);
                allFahrzeuge = [];
            }
        }

        // Statistiken aktualisieren
        function updateStats() {
            const total = allKunden.length;
            const stammkunden = allKunden.filter(k => k.anzahlBesuche >= 2).length;
            const neukunden = allKunden.filter(k => k.anzahlBesuche === 1).length;

            document.getElementById('totalKunden').textContent = total;
            document.getElementById('stammkunden').textContent = stammkunden;
            document.getElementById('neukunden').textContent = neukunden;

            // Umsatz aktualisieren
            updateUmsatzStats();
        }

        // Umsatz-Filter setzen
        function setUmsatzFilter(filter) {
            currentUmsatzFilter = filter;

            // Filter-Buttons aktualisieren
            document.querySelectorAll('.umsatz-filter .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Label aktualisieren
            const labels = {
                'gesamt': 'Gesamtumsatz',
                'jahr': 'Umsatz ' + new Date().getFullYear(),
                'monat': 'Umsatz ' + new Date().toLocaleDateString('de-DE', { month: 'long', year: 'numeric' })
            };
            document.getElementById('umsatzLabel').textContent = labels[filter];

            // Stats und Cards aktualisieren
            updateUmsatzStats();
            renderKundenCardsGrid();
        }

        // Umsatz-Statistik aktualisieren
        function updateUmsatzStats() {
            const gesamtumsatz = calculateGesamtumsatz(currentUmsatzFilter);
            document.getElementById('totalUmsatz').textContent = gesamtumsatz.toFixed(2) + ' â‚¬';
            console.log(`ðŸ“Š Umsatz aktualisiert (${currentUmsatzFilter}):`, gesamtumsatz.toFixed(2) + ' â‚¬', `(basierend auf ${allFahrzeuge.length} Fahrzeugen)`);
        }

        // Gesamtumsatz berechnen
        function calculateGesamtumsatz(filter) {
            // âœ… FIX: Validierung dass Daten geladen sind
            if (!allKunden || allKunden.length === 0) {
                console.log('âš ï¸ Keine Kunden geladen - Umsatz = 0');
                return 0;
            }
            if (!allFahrzeuge || allFahrzeuge.length === 0) {
                console.log('âš ï¸ Keine Fahrzeuge geladen - Umsatz = 0');
                return 0;
            }

            let sum = 0;
            for (const kunde of allKunden) {
                sum += calculateKundenUmsatz(kunde.id, filter);
            }
            return sum;
        }

        // Umsatz pro Kunde berechnen
        function calculateKundenUmsatz(kundeId, filter) {
            // Fahrzeuge des Kunden finden
            const kundenFahrzeuge = allFahrzeuge.filter(f =>
                f.kundenId === kundeId ||
                (f.kundenname && allKunden.find(k => window.compareIds(k.id, kundeId) && k.name === f.kundenname))
            );

            // Nach Zeitraum filtern
            const heute = new Date();
            const filteredFahrzeuge = kundenFahrzeuge.filter(f => {
                if (!f.datum) return true; // Kein Datum = inkludieren

                // Datum parsen (Format: "DD.MM.YYYY")
                const [tag, monat, jahr] = f.datum.split('.');
                const fahrzeugDatum = new Date(parseInt(jahr), parseInt(monat) - 1, parseInt(tag));

                if (filter === 'gesamt') {
                    return true;
                } else if (filter === 'jahr') {
                    return fahrzeugDatum.getFullYear() === heute.getFullYear();
                } else if (filter === 'monat') {
                    return fahrzeugDatum.getFullYear() === heute.getFullYear() &&
                           fahrzeugDatum.getMonth() === heute.getMonth();
                }
                return true;
            });

            // Preise summieren - unterstÃ¼tzt vereinbarterPreis UND KVA-Varianten (Partner Portal)
            let sum = 0;
            for (const fahrzeug of filteredFahrzeuge) {
                let preis = 0;

                // Preis-Ermittlung mit Validierung (0-Check!)
                if (fahrzeug.vereinbarterPreis && fahrzeug.vereinbarterPreis > 0) {
                    preis = parseFloat(fahrzeug.vereinbarterPreis);
                } else if (fahrzeug.kva?.varianten && fahrzeug.kva.gewaehlteVariante) {
                    preis = parseFloat(fahrzeug.kva.varianten[fahrzeug.kva.gewaehlteVariante]?.gesamt) || 0;
                } else if (fahrzeug.kva?.varianten?.original) {
                    preis = parseFloat(fahrzeug.kva.varianten.original.gesamt) || 0;
                } else if (fahrzeug.kva?.gesamt) {
                    preis = parseFloat(fahrzeug.kva.gesamt) || 0;
                }

                if (preis > 0) {
                    sum += preis;
                }
            }

            return sum;
        }

        // Kunden-Tabelle rendern
        function renderKundenTable(filterText = '') {
            const tbody = document.getElementById('kundenTableBody');
            const tableContainer = document.querySelector('.kunden-table');
            const tableWrapper = document.querySelector('.kunden-table-container');
            const cardsContainer = document.getElementById('kundenCardsContainer');
            const emptyState = document.getElementById('emptyState');

            // ðŸ¦´ SKELETON LOADER: Hide skeleton, show table
            const skeleton = document.getElementById('kundenSkeleton');
            if (skeleton && skeleton.style.display !== 'none') {
                skeleton.style.display = 'none';
                if (tableWrapper) tableWrapper.style.display = 'block';
                console.log('âœ… [SKELETON] Skeleton hidden, kunden table visible');
            }

            // âœ… Use unified filtering with pagination
            let filteredKunden = getFilteredKunden(true);

            if (totalFilteredKunden === 0) {
                tbody.innerHTML = '';
                if (tableContainer) tableContainer.style.display = 'none';
                if (tableWrapper) tableWrapper.style.display = 'none';
                if (cardsContainer) {
                    cardsContainer.innerHTML = '';
                    cardsContainer.style.display = 'none'; // âœ… Cards Container verstecken (leer)
                }
                emptyState.style.display = 'block';
                updatePaginationControls(); // Update even when empty
                return;
            }

            emptyState.style.display = 'none';
            if (tableContainer) tableContainer.style.display = 'table';
            if (tableWrapper) tableWrapper.style.display = 'block';
            if (cardsContainer) {
                cardsContainer.innerHTML = '';
                cardsContainer.style.display = 'none'; // âœ… Cards Container verstecken!
            }

            // âœ… Sorting is now handled in getFilteredKunden()

            tbody.innerHTML = filteredKunden.map(kunde => {
                const kontakt = [];
                if (kunde.telefon) kontakt.push(`ðŸ“ž ${kunde.telefon}`);
                if (kunde.email) kontakt.push(`ðŸ“§ ${kunde.email}`);
                const kontaktText = kontakt.length > 0 ? kontakt.join('<br>') : '<span style="color: #999;">-</span>';

                const besuche = kunde.anzahlBesuche || 0;
                const umsatz = calculateKundenUmsatz(kunde.id, currentUmsatzFilter);
                const letzterBesuch = kunde.letzterBesuch
                    ? new Date(kunde.letzterBesuch).toLocaleDateString('de-DE')
                    : '<span style="color: #999;">-</span>';

                const statusBadge = besuche >= 2
                    ? '<span class="badge badge-success">â­ Stammkunde</span>'
                    : '<span class="badge badge-info">ðŸ†• Neukunde</span>';

                // âœ… Add tags column
                const tagsHtml = renderTagChips(kunde.tags);

                return `
                    <tr>
                        <td data-label="Name"><strong>${kunde.name}</strong></td>
                        <td data-label="Kontakt">${kontaktText}</td>
                        <td data-label="Besuche"><strong>${besuche}</strong></td>
                        <td data-label="Umsatz"><strong style="color: #ff9800;">${umsatz.toFixed(2)} â‚¬</strong></td>
                        <td data-label="Letzter Besuch">${letzterBesuch}</td>
                        <td data-label="Status">${statusBadge}</td>
                        <td data-label="Tags">${tagsHtml}</td>
                        <td>
                            <div class="action-btns">
                                <button class="btn btn-info btn-small btn-kunde-detail" data-kunde-id="${kunde.id}">
                                    ðŸ‘ï¸ Details
                                </button>
                                <button class="btn btn-warning btn-small btn-kunde-edit" data-kunde-id="${kunde.id}">
                                    âœï¸ Bearbeiten
                                </button>
                                <button class="btn btn-small btn-kunde-delete" data-kunde-id="${kunde.id}" style="background: #dc3545; color: white;">
                                    ðŸ—‘ï¸ LÃ¶schen
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            // âœ… Update pagination controls after rendering
            updatePaginationControls();
        }

        // ============================================
        // ðŸŽ´ KUNDEN CARDS GRID RENDERER (Apple Liquid Glass Style)
        // ============================================
        function renderKundenCardsGrid(filterText = '') {
            console.log('ðŸŽ´ renderKundenCardsGrid() aufgerufen');
            console.log('ðŸ“Š allKunden:', allKunden.length);
            console.log('ðŸ“Š totalFilteredKunden:', totalFilteredKunden);

            const cardsContainer = document.getElementById('kundenCardsContainer');
            const tableContainer = document.querySelector('.table-container');
            const emptyState = document.getElementById('emptyState');

            if (window.DEBUG) console.log('ðŸ” cardsContainer:', cardsContainer);
            if (window.DEBUG) console.log('ðŸ” tableContainer:', tableContainer);
            if (window.DEBUG) console.log('ðŸ” emptyState:', emptyState);

            // âŒ CRITICAL FIX: Check if container exists
            if (!cardsContainer) {
                console.error('âŒ kundenCardsContainer nicht gefunden!');
                return;
            }

            // âœ… Use unified filtering with pagination
            let filteredKunden = getFilteredKunden(true);
            if (window.DEBUG) console.log('ðŸ” filteredKunden:', filteredKunden.length, filteredKunden);

            if (totalFilteredKunden === 0) {
                cardsContainer.innerHTML = '';
                if (tableContainer) tableContainer.style.display = 'none';
                if (emptyState) emptyState.style.display = 'block';
                updatePaginationControls();
                console.log('âš ï¸ Keine Kunden zu rendern (totalFilteredKunden = 0)');
                return;
            }

            if (emptyState) emptyState.style.display = 'none';
            if (tableContainer) tableContainer.style.display = 'none'; // Verstecke Tabelle

            console.log('ðŸŽ¨ Starte Rendering von', filteredKunden.length, 'Kunden...');

            // Render Cards
            cardsContainer.innerHTML = filteredKunden.map(kunde => {
                const besuche = kunde.anzahlBesuche || 0;
                const umsatz = calculateKundenUmsatz(kunde.id, currentUmsatzFilter);
                const letzterBesuch = kunde.letzterBesuch
                    ? new Date(kunde.letzterBesuch).toLocaleDateString('de-DE')
                    : '-';
                const statusBadge = besuche >= 2
                    ? '<span class="badge badge-success">â­ Stammkunde</span>'
                    : '<span class="badge badge-info">ðŸ†• Neukunde</span>';
                const tagsHtml = kunde.tags && kunde.tags.length > 0 ? renderTagChips(kunde.tags) : '';

                return `
                    <div class="kunde-card hero-card">
                        <div class="shine-overlay"></div>

                        <!-- Header: Name + Status -->
                        <div class="kunde-card__header">
                            <h3 class="kunde-name">${kunde.name}</h3>
                            ${statusBadge}
                        </div>

                        <!-- Stats: Besuche + Umsatz -->
                        <div class="kunde-card__stats">
                            <div class="stat-item">
                                <i data-feather="repeat"></i>
                                <span class="stat-value">${besuche}</span>
                                <span class="stat-label">Besuche</span>
                            </div>
                            <div class="stat-item">
                                <i data-feather="dollar-sign"></i>
                                <span class="stat-value">${umsatz.toFixed(2)} â‚¬</span>
                                <span class="stat-label">Umsatz</span>
                            </div>
                        </div>

                        <!-- Contact Info -->
                        ${kunde.telefon || kunde.email ? `
                        <div class="kunde-card__contact">
                            ${kunde.telefon ? `
                            <div class="contact-item">
                                <i data-feather="phone"></i>
                                <span>${kunde.telefon}</span>
                            </div>` : ''}
                            ${kunde.email ? `
                            <div class="contact-item">
                                <i data-feather="mail"></i>
                                <span>${kunde.email}</span>
                            </div>` : ''}
                        </div>
                        ` : ''}

                        <!-- Letzter Besuch -->
                        <div class="kunde-card__meta">
                            <i data-feather="calendar"></i>
                            <span>Letzter Besuch: ${letzterBesuch}</span>
                        </div>

                        <!-- Tags -->
                        ${tagsHtml ? `
                        <div class="kunde-card__tags">
                            ${tagsHtml}
                        </div>
                        ` : ''}

                        <!-- Actions -->
                        <div class="kunde-card__actions">
                            <button class="btn btn-info btn-kunde-detail" data-kunde-id="${kunde.id}">
                                <i data-feather="eye"></i> Details
                            </button>
                            <button class="btn btn-warning btn-kunde-edit" data-kunde-id="${kunde.id}">
                                <i data-feather="edit"></i> Edit
                            </button>
                            <button class="btn btn-danger btn-kunde-delete" data-kunde-id="${kunde.id}">
                                <i data-feather="trash-2"></i> LÃ¶schen
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            console.log('âœ… HTML gerendert, LÃ¤nge:', cardsContainer.innerHTML.length);
            console.log('âœ… Anzahl Cards im DOM:', cardsContainer.querySelectorAll('.kunde-card').length);

            // âœ… Re-initialize Feather Icons
            if (typeof feather !== 'undefined') {
                feather.replace();
                console.log('âœ… Feather Icons re-initialized');
            }

            // âœ… Update pagination controls
            updatePaginationControls();
            console.log('âœ… renderKundenCardsGrid() abgeschlossen!');
        }

        // Event Delegation fÃ¼r Kunden-Buttons
        const kundenButtonClickHandler = function(e) {
            // Finde nÃ¤chsten Button (auch wenn auf Text/Emoji geklickt wurde)
            const button = e.target.closest('button');
            if (!button) return;

            const kundeId = button.dataset.kundeId;
            if (!kundeId) return;

            if (button.classList.contains('btn-kunde-detail')) {
                e.preventDefault();
                if (window.DEBUG) console.log('ðŸ” Detail-Button geklickt fÃ¼r Kunde:', kundeId);
                openKundenDetail(kundeId);
            } else if (button.classList.contains('btn-kunde-edit')) {
                e.preventDefault();
                console.log('âœï¸ Bearbeiten-Button geklickt fÃ¼r Kunde:', kundeId);
                editKunde(kundeId);
            } else if (button.classList.contains('btn-kunde-delete')) {
                e.preventDefault();
                console.log('ðŸ—‘ï¸ LÃ¶schen-Button geklickt fÃ¼r Kunde:', kundeId);
                deleteKunde(kundeId);
            }
        };
        window.listenerRegistry.registerDOM(document, 'click', kundenButtonClickHandler, 'Kunden Button Click Delegation');

        // Filter Kunden
        function filterKunden() {
            // âœ… Use unified rendering (supports responsive view switching)
            renderKundenView();
        }

        // Neuer Kunde Modal Ã¶ffnen
        function openNeuerKundeModal() {
            document.getElementById('neuerKundeModal').classList.add('active');
            document.getElementById('neuerKundeForm').reset();
            currentKundeId = null;
        }

        // Neuer Kunde Modal schlieÃŸen
        function closeNeuerKundeModal() {
            document.getElementById('neuerKundeModal').classList.remove('active');
            document.getElementById('neuerKundeForm').reset();
            currentKundeId = null;

            // âœ… Rabatt-Konditionen Felder zurÃ¼cksetzen (inkl. Bonus-Felder)
            document.getElementById('rabattStufe1Prozent').value = '';
            document.getElementById('rabattStufe1Ab').value = '';
            document.getElementById('rabattStufe1Bonus').value = '';
            document.getElementById('rabattStufe2Prozent').value = '';
            document.getElementById('rabattStufe2Ab').value = '';
            document.getElementById('rabattStufe2Bonus').value = '';
            document.getElementById('rabattStufe3Prozent').value = '';
            document.getElementById('rabattStufe3Ab').value = '';
            document.getElementById('rabattStufe3Bonus').value = '';
            document.getElementById('konditionenGeprueft').checked = false;
            document.getElementById('konditionenDatum').value = '';
            document.getElementById('konditionenDatum').disabled = true;
        }

        // ========== PARTNER-PASSWORT-MODAL FUNKTIONEN (NEU) ==========

        /**
         * Zeigt das Partner-Passwort-Modal mit den generierten Zugangsdaten an
         * @param {Object} data - { email, password, partnerId, name }
         */
        function showPartnerPasswordModal(data) {
            console.log('ðŸ“‹ Zeige Partner-Passwort-Modal:', data);
            document.getElementById('pwModalName').textContent = data.name || 'N/A';
            document.getElementById('pwModalEmail').textContent = data.email || 'N/A';
            document.getElementById('pwModalPartnerId').textContent = data.partnerId || 'N/A';
            document.getElementById('pwModalPassword').textContent = data.password || 'ERROR';

            // Modal anzeigen
            const modal = document.getElementById('partnerPasswordModal');
            modal.style.display = 'flex';

            // Nach 100ms die 'active' Klasse hinzufÃ¼gen fÃ¼r Animation (falls vorhanden)
            setTimeout(() => {
                modal.classList.add('active');
            }, 100);
        }

        /**
         * SchlieÃŸt das Partner-Passwort-Modal
         */
        function closePartnerPasswordModal() {
            const modal = document.getElementById('partnerPasswordModal');
            modal.classList.remove('active');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300); // Wait for animation
            console.log('âœ… Partner-Passwort-Modal geschlossen');
        }

        /**
         * Kopiert das Passwort in die Zwischenablage
         */
        function copyPasswordToClipboard() {
            const password = document.getElementById('pwModalPassword').textContent;

            if (!password || password === 'ERROR') {
                alert('âŒ Kein Passwort zum Kopieren vorhanden!');
                return;
            }

            // Modern Clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(password).then(() => {
                    console.log('âœ… Passwort in Zwischenablage kopiert (LÃ¤nge:', password?.length || 0, 'Zeichen)');

                    // Visual Feedback
                    const button = event.target;
                    const originalText = button.textContent;
                    button.textContent = 'âœ“';
                    button.style.background = '#28a745';

                    setTimeout(() => {
                        button.textContent = originalText;
                        button.style.background = '#667eea';
                    }, 2000);

                    alert('âœ… Passwort in Zwischenablage kopiert!');
                }).catch(err => {
                    console.error('âŒ Fehler beim Kopieren:', err);
                    fallbackCopyToClipboard(password);
                });
            } else {
                // Fallback fÃ¼r Ã¤ltere Browser
                fallbackCopyToClipboard(password);
            }
        }

        /**
         * Fallback-Methode zum Kopieren (Ã¤ltere Browser)
         */
        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.select();

            try {
                document.execCommand('copy');
                alert('âœ… Passwort in Zwischenablage kopiert!');
                // ðŸ†• FIX #3: Passwort nicht mehr loggen (Security) - 2025-11-15
                console.log('âœ… Passwort in Zwischenablage kopiert (Fallback-Methode, LÃ¤nge:', text?.length || 0, 'Zeichen)');
            } catch (err) {
                alert('âŒ Fehler beim Kopieren. Bitte manuell kopieren: ' + text);
                console.error('âŒ Fallback Kopieren fehlgeschlagen:', err);
            }

            document.body.removeChild(textArea);
        }

        /**
         * LÃ¤dt Partner-Zugangs-Informationen aus Firestore und zeigt sie im Edit-Modal an
         * @param {string} partnerCode - Partner-ID
         */
        async function loadPartnerAccessInfo(partnerCode) {
            console.log('ðŸ“¥ Lade Partner-Zugangs-Info fÃ¼r:', partnerCode);

            try {
                // Reset: Alle Status-Boxen verstecken
                document.getElementById('partnerPasswordNotChanged').style.display = 'none';
                document.getElementById('partnerPasswordChanged').style.display = 'none';
                document.getElementById('partnerAccountNotCreated').style.display = 'none';

                // Versuche Partner-Dokument aus partners_mosbach zu laden
                if (!window.getCollection) {
                    console.error('âŒ window.getCollection nicht verfÃ¼gbar!');
                    return;
                }

                const partnerRef = window.getCollection('partners').doc(partnerCode);
                const partnerDoc = await partnerRef.get();

                if (!partnerDoc.exists) {
                    console.warn('âš ï¸ Partner-Dokument nicht gefunden fÃ¼r:', partnerCode);
                    // Zeige "Account wird erstellt" Info
                    document.getElementById('partnerAccessEmail').textContent = 'N/A (wird beim Speichern erstellt)';
                    document.getElementById('partnerAccountNotCreated').style.display = 'block';
                    document.getElementById('partnerAccessInfo').style.display = 'block';
                    return;
                }

                const partnerData = partnerDoc.data();
                console.log('âœ… Partner-Daten geladen:', partnerData);

                // Email anzeigen
                document.getElementById('partnerAccessEmail').textContent = partnerData.email || 'N/A';

                // Status prÃ¼fen
                if (partnerData.initialPassword && partnerData.requiresPasswordChange !== false) {
                    // Passwort noch nicht geÃ¤ndert
                    document.getElementById('partnerInitialPw').textContent = partnerData.initialPassword;
                    document.getElementById('partnerPasswordNotChanged').style.display = 'block';
                    console.log('âš ï¸ Partner-Passwort noch nicht geÃ¤ndert');
                } else if (partnerData.passwordChangedAt) {
                    // Passwort wurde geÃ¤ndert
                    const changeDate = new Date(partnerData.passwordChangedAt);
                    document.getElementById('pwChangedDate').textContent = changeDate.toLocaleDateString('de-DE', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    document.getElementById('partnerPasswordChanged').style.display = 'block';
                    console.log('âœ… Partner-Passwort wurde geÃ¤ndert am:', partnerData.passwordChangedAt);
                } else {
                    // Account existiert, aber kein Passwort-Status
                    document.getElementById('partnerAccountNotCreated').style.display = 'block';
                    console.log('â„¹ï¸ Partner-Account existiert, aber kein Passwort-Status vorhanden');
                }

                // Partner-Zugang-Info anzeigen
                document.getElementById('partnerAccessInfo').style.display = 'block';

            } catch (error) {
                console.error('âŒ Fehler beim Laden der Partner-Zugangs-Info:', error);
                // Zeige trotzdem die Box mit "Account wird erstellt"
                document.getElementById('partnerAccessEmail').textContent = 'Fehler beim Laden';
                document.getElementById('partnerAccountNotCreated').style.display = 'block';
                document.getElementById('partnerAccessInfo').style.display = 'block';
            }
        }

        /**
         * Kopiert das Partner-Initial-Passwort in die Zwischenablage (aus Edit-Modal)
         */
        function copyPartnerPassword() {
            const password = document.getElementById('partnerInitialPw').textContent;

            if (!password || password === '') {
                alert('âŒ Kein Passwort zum Kopieren vorhanden!');
                return;
            }

            // Modern Clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(password).then(() => {
                    console.log('âœ… Partner-Passwort in Zwischenablage kopiert');

                    // Visual Feedback
                    const button = event.target;
                    const originalText = button.textContent;
                    const originalBg = button.style.background;
                    button.textContent = 'âœ“ Kopiert';
                    button.style.background = '#28a745';

                    setTimeout(() => {
                        button.textContent = originalText;
                        button.style.background = originalBg;
                    }, 2000);

                }).catch(err => {
                    console.error('âŒ Fehler beim Kopieren:', err);
                    alert('âŒ Fehler beim Kopieren. Bitte manuell kopieren: ' + password);
                });
            } else {
                // Fallback
                alert('Passwort: ' + password + '\n\nBitte manuell kopieren.');
            }
        }

        // ========== ENDE PARTNER-PASSWORT-MODAL FUNKTIONEN ==========

        // Neuer Kunde Form Submit
        const neuerKundeFormSubmit = async function(e) {
            e.preventDefault();

            // âœ… Collect selected tags from checkboxes
            const selectedTags = [];
            ['vip', 'stammkunde', 'neukunde', 'flotte', 'gewerbe', 'privat'].forEach(tagId => {
                const checkbox = document.getElementById(`tag${tagId.charAt(0).toUpperCase() + tagId.slice(1)}`);
                if (checkbox && checkbox.checked) {
                    selectedTags.push(tagId);
                }
            });

            // âœ… Rabatt-Konditionen sammeln (inkl. Bonus-Felder)
            const rabattKonditionen = {};
            const stufe1Prozent = parseFloat(document.getElementById('rabattStufe1Prozent').value);
            const stufe1Ab = parseFloat(document.getElementById('rabattStufe1Ab').value);
            const stufe1Bonus = parseFloat(document.getElementById('rabattStufe1Bonus').value);
            const stufe2Prozent = parseFloat(document.getElementById('rabattStufe2Prozent').value);
            const stufe2Ab = parseFloat(document.getElementById('rabattStufe2Ab').value);
            const stufe2Bonus = parseFloat(document.getElementById('rabattStufe2Bonus').value);
            const stufe3Prozent = parseFloat(document.getElementById('rabattStufe3Prozent').value);
            const stufe3Ab = parseFloat(document.getElementById('rabattStufe3Ab').value);
            const stufe3Bonus = parseFloat(document.getElementById('rabattStufe3Bonus').value);

            if (!isNaN(stufe1Prozent) && !isNaN(stufe1Ab) && stufe1Ab > 0) {
                rabattKonditionen.stufe1 = {
                    rabatt: stufe1Prozent,
                    ab: stufe1Ab,
                    einmalBonus: !isNaN(stufe1Bonus) ? stufe1Bonus : 0,
                    bonusErhalten: false  // Phase 2: Tracking ob Bonus schon ausgezahlt
                };
            }
            if (!isNaN(stufe2Prozent) && !isNaN(stufe2Ab) && stufe2Ab > 0) {
                rabattKonditionen.stufe2 = {
                    rabatt: stufe2Prozent,
                    ab: stufe2Ab,
                    einmalBonus: !isNaN(stufe2Bonus) ? stufe2Bonus : 0,
                    bonusErhalten: false
                };
            }
            if (!isNaN(stufe3Prozent) && !isNaN(stufe3Ab) && stufe3Ab > 0) {
                rabattKonditionen.stufe3 = {
                    rabatt: stufe3Prozent,
                    ab: stufe3Ab,
                    einmalBonus: !isNaN(stufe3Bonus) ? stufe3Bonus : 0,
                    bonusErhalten: false
                };
            }

            const konditionenGeprueft = document.getElementById('konditionenGeprueft').checked;
            const konditionenDatum = document.getElementById('konditionenDatum').value;

            // ============================================
            // INPUT VALIDATION (Phase 1 Quick Wins)
            // ============================================

            const kundenName = document.getElementById('kundenName').value.trim();
            let kundenEmail = document.getElementById('kundenEmail').value.trim();
            const kundenTelefon = document.getElementById('kundenTelefon').value.trim();

            // Validate Kundenname (required)
            if (!kundenName) {
                showToast('Bitte Kundenname eingeben!', 'error');
                document.getElementById('kundenName').focus();
                return;
            }

            // âœ… FALLBACK: Wenn Email-Feld leer, aber Name enthÃ¤lt @ â†’ Verwende Name als Email
            // HÃ¤ufiger Fall: User trÃ¤gt "marcel@test.de" ins Name-Feld ein statt ins Email-Feld
            if (!kundenEmail && kundenName && kundenName.includes('@')) {
                kundenEmail = kundenName;
                console.log(`ðŸ“§ Verwende Name als Email (Email-Feld leer): "${kundenEmail}"`);
            }

            // Validate Email (optional, but if provided must be valid)
            if (kundenEmail) {
                const emailResult = window.validateEmail(kundenEmail);
                if (!emailResult.valid) {
                    showToast(emailResult.error, 'error');
                    document.getElementById('kundenEmail').focus();
                    return;
                }
                kundenEmail = emailResult.value; // Use normalized value
            }

            // Validate Telefon (optional, but if provided must be valid)
            if (kundenTelefon) {
                const phoneResult = window.validatePhone(kundenTelefon);
                if (!phoneResult.valid) {
                    showToast(phoneResult.error, 'error');
                    document.getElementById('kundenTelefon').focus();
                    return;
                }
            }

            // âœ… AUTO-GENERATE Partner-Code aus Email (wenn nicht manuell eingegeben)
            const partnerCodeInput = document.getElementById('partnerCode').value.trim();

            let partnerCode = partnerCodeInput;

            // Wenn kein Partner-Code eingegeben, aber Email vorhanden â†’ Auto-generiere aus Email
            // Beispiel: "marcel@test.de" â†’ "marcel"
            // â†’ Konsistent mit Partner Portal Login (index.html:389 verwendet email.split('@')[0])
            if (!partnerCode && kundenEmail && kundenEmail.includes('@')) {
                partnerCode = kundenEmail.split('@')[0].toLowerCase();
                console.log(`ðŸ¤– Auto-generierter Partner-Code aus Email: "${kundenEmail}" â†’ "${partnerCode}"`);
            }

            // Fallback: Bei Edit existierenden Partner-Code Ã¼bernehmen (falls Email geÃ¤ndert wurde)
            if (!partnerCode && currentKundeId) {
                partnerCode = allKunden.find(k => window.compareIds(k.id, currentKundeId))?.partnerCode || null;
                if (partnerCode) {
                    console.log(`â™»ï¸ Verwende existierenden Partner-Code: "${partnerCode}"`);
                }
            }

            const kundeData = {
                id: currentKundeId || 'kunde_' + Date.now(),
                name: document.getElementById('kundenName').value.trim(),
                telefon: document.getElementById('kundenTelefon').value.trim(),
                email: document.getElementById('kundenEmail').value.trim(),
                notizen: document.getElementById('kundenNotizen').value.trim(),
                tags: selectedTags, // âœ… Add tags
                partnerCode: partnerCode || null, // âœ… Partner-Code fÃ¼r B2B-Kunden
                // âœ… Rabatt-Konditionen (NEU)
                rabattKonditionen: Object.keys(rabattKonditionen).length > 0 ? rabattKonditionen : null,
                konditionenGeprueft: konditionenGeprueft,
                konditionenDatum: konditionenDatum || null,
                // âœ… FIX: Nur bei neuem Kunden hinzufÃ¼gen (verhindert undefined in Firebase)
                ...(!currentKundeId ? {
                    erstbesuch: new Date().toISOString(),
                    anzahlBesuche: 0,
                    letzterBesuch: null
                } : {})
            };

            try {
                if (currentKundeId) {
                    // Update
                    if (firebaseInitialized && firebaseApp) {
                        await firebaseApp.updateKunde(currentKundeId, kundeData);
                    } else {
                        const index = allKunden.findIndex(k => window.compareIds(k.id, currentKundeId));
                        if (index !== -1) {
                            allKunden[index] = { ...allKunden[index], ...kundeData };
                            localStorage.setItem('kunden', JSON.stringify(allKunden));
                        }
                    }
                    console.log('âœ… Kunde aktualisiert:', kundeData.name);
                    showSuccessToast(`Kunde "${kundeData.name}" aktualisiert!`);
                } else {
                    // Neu erstellen
                    if (firebaseInitialized && firebaseApp) {
                        await firebaseApp.saveKunde(kundeData);
                    } else {
                        allKunden.push(kundeData);
                        localStorage.setItem('kunden', JSON.stringify(allKunden));
                    }
                    console.log('âœ… Neuer Kunde erstellt:', kundeData.name);
                    showSuccessToast(`Neuer Kunde "${kundeData.name}" erstellt!`);
                }

                // âœ… DEBUG: SYNC Check vor AusfÃ¼hrung
                if (window.DEBUG) console.log('ðŸ” SYNC-Check:', {
                    partnerCode: partnerCode,
                    dbVerfuegbar: !!db,
                    windowDbVerfuegbar: !!window.db,
                    rabattKonditionenVorhanden: !!kundeData.rabattKonditionen,
                    syncWirdAusgefuehrt: !!(partnerCode && db)
                });

                // âœ… SYNC zu Partner Collection (wenn Partner-Code vorhanden)
                // ðŸ› BUG #14 DEBUG: Erweiterte Logs fÃ¼r Partner-Sync
                console.log('\nðŸ” ========== PARTNER-SYNC DEBUG ==========');
                console.log('   partnerCode:', partnerCode || 'FEHLT! âŒ');
                console.log('   db vorhanden:', !!db);
                console.log('   Sync wird ausgefÃ¼hrt:', !!(partnerCode && db));
                console.log('   Kunde-Email:', kundeData.email);
                console.log('   rabattKonditionen:', kundeData.rabattKonditionen ? 'JA âœ…' : 'NEIN âŒ');
                console.log('   konditionenGeprueft:', kundeData.konditionenGeprueft ? 'JA âœ…' : 'NEIN âŒ');

                if (partnerCode && db) {
                    try {
                        console.log(`ðŸ”„ Synce Rabatt-Konditionen zu Partner "${partnerCode}"...`);
                        const partnerRef = window.getCollection('partners').doc(partnerCode);

                        const syncData = {
                            name: kundeData.name,  // âœ… Partner-Name fÃ¼r Anzeige
                            email: kundeData.email,  // âœ… Email fÃ¼r Kommunikation
                            rabattKonditionen: kundeData.rabattKonditionen,
                            konditionenGeprueft: kundeData.konditionenGeprueft,
                            konditionenDatum: kundeData.konditionenDatum,
                            lastSync: new Date().toISOString()  // âœ… Sync-Timestamp
                        };

                        await partnerRef.set(syncData, { merge: true });
                        console.log(`âœ… Rabatt-Konditionen zu Partner "${partnerCode}" synchronisiert!`);
                        console.log('   ðŸ“Š Daten:', syncData);
                        console.log('   ðŸ“Š Partner-Dokument ID:', partnerCode);

                        // ðŸ†• AUTO-ACCOUNT-ERSTELLUNG: Firebase Auth Account fÃ¼r Partner anlegen
                        try {
                            console.log(`ðŸ” PrÃ¼fe Firebase Auth Account fÃ¼r Partner "${partnerCode}"...`);
                            // âœ… FIX: Use window.functions (europe-west3) instead of firebase.functions() (us-central1)
                            const ensureFn = window.functions.httpsCallable('ensurePartnerAccount');
                            const accountResult = await ensureFn({
                                email: kundeData.email,
                                kundenname: kundeData.name,
                                werkstattId: window.werkstattId
                            });

                            console.log('âœ… Partner-Account-Check abgeschlossen:', accountResult.data);

                            // Passwort temporÃ¤r in Firestore speichern (NUR bei neuen Partnern)
                            if (accountResult.data.isNewPartner && accountResult.data.generatedPassword) {
                                console.log('ðŸ†• Neuer Partner erstellt - speichere Initial-Passwort');
                                await partnerRef.update({
                                    initialPassword: accountResult.data.generatedPassword,
                                    requiresPasswordChange: true,
                                    accountCreatedAt: new Date().toISOString(),
                                    accountCreatedBy: window.currentUserEmail || 'system'
                                });

                                // Modal mit Passwort anzeigen
                                showPartnerPasswordModal({
                                    email: kundeData.email,
                                    password: accountResult.data.generatedPassword,
                                    partnerId: accountResult.data.partnerId,
                                    name: kundeData.name
                                });
                            } else {
                                console.log('â„¹ï¸ Partner-Account existiert bereits');
                            }

                        } catch (accountError) {
                            console.error('âš ï¸ Fehler bei Account-Erstellung:', accountError);
                            // Nicht kritisch - Kunde ist bereits gespeichert
                            alert(`âš ï¸ Warnung: Kunde wurde gespeichert, aber Firebase Auth Account konnte nicht erstellt werden.\n\nFehler: ${accountError.message}\n\nBitte versuchen Sie es spÃ¤ter erneut oder kontaktieren Sie den Support.`);
                        }
                    } catch (syncError) {
                        console.warn('âš ï¸ Fehler beim Sync zu Partner Collection:', syncError);
                        // Nicht kritisch - Kunde wurde bereits gespeichert
                    }
                } else {
                    console.warn('âš ï¸ Partner-Sync ÃœBERSPRUNGEN!');
                    if (!partnerCode) console.warn('   Grund: partnerCode fehlt! âŒ');
                    if (!db) console.warn('   Grund: Firebase DB nicht verfÃ¼gbar! âŒ');
                    console.warn('   âš ï¸ ACHTUNG: Rabatt-Konditionen werden NICHT zu Partner Collection synchronisiert!');
                    console.warn('   âš ï¸ RESULTAT: meine-anfragen.html wird KEINE Rabatte anzeigen! ðŸ›');
                }
                console.log('========== PARTNER-SYNC DEBUG ENDE ==========\n');

                closeNeuerKundeModal();
                await loadKunden();
                updateStats();
                renderKundenView(); // âœ… Use new rendering
            } catch (error) {
                console.error('âŒ Fehler beim Speichern:', error);
                showErrorToast('Fehler beim Speichern des Kunden!');
            }
        };
        window.listenerRegistry.registerDOM(document.getElementById('neuerKundeForm'), 'submit', neuerKundeFormSubmit, 'Neuer Kunde Form Submit');

        // Kunde bearbeiten
        function editKunde(kundeId) {
            const kunde = allKunden.find(k => window.compareIds(k.id, kundeId));
            if (!kunde) return;

            currentKundeId = kundeId;
            document.getElementById('kundenName').value = kunde.name || '';
            document.getElementById('kundenTelefon').value = kunde.telefon || '';
            document.getElementById('kundenEmail').value = kunde.email || '';
            document.getElementById('kundenNotizen').value = kunde.notizen || '';
            document.getElementById('partnerCode').value = kunde.partnerCode || '';

            // âœ… Set tag checkboxes based on kunde.tags
            ['vip', 'stammkunde', 'neukunde', 'flotte', 'gewerbe', 'privat'].forEach(tagId => {
                const checkbox = document.getElementById(`tag${tagId.charAt(0).toUpperCase() + tagId.slice(1)}`);
                if (checkbox) {
                    checkbox.checked = kunde.tags && kunde.tags.includes(tagId);
                }
            });

            // âœ… Rabatt-Konditionen laden (inkl. Bonus-Felder)
            if (kunde.rabattKonditionen) {
                const stufe1 = kunde.rabattKonditionen.stufe1;
                const stufe2 = kunde.rabattKonditionen.stufe2;
                const stufe3 = kunde.rabattKonditionen.stufe3;

                document.getElementById('rabattStufe1Prozent').value = stufe1 ? stufe1.rabatt : '';
                document.getElementById('rabattStufe1Ab').value = stufe1 ? stufe1.ab : '';
                document.getElementById('rabattStufe1Bonus').value = stufe1 ? stufe1.einmalBonus : '';
                document.getElementById('rabattStufe2Prozent').value = stufe2 ? stufe2.rabatt : '';
                document.getElementById('rabattStufe2Ab').value = stufe2 ? stufe2.ab : '';
                document.getElementById('rabattStufe2Bonus').value = stufe2 ? stufe2.einmalBonus : '';
                document.getElementById('rabattStufe3Prozent').value = stufe3 ? stufe3.rabatt : '';
                document.getElementById('rabattStufe3Ab').value = stufe3 ? stufe3.ab : '';
                document.getElementById('rabattStufe3Bonus').value = stufe3 ? stufe3.einmalBonus : '';
            } else {
                // Felder leeren wenn keine Konditionen
                document.getElementById('rabattStufe1Prozent').value = '';
                document.getElementById('rabattStufe1Ab').value = '';
                document.getElementById('rabattStufe1Bonus').value = '';
                document.getElementById('rabattStufe2Prozent').value = '';
                document.getElementById('rabattStufe2Ab').value = '';
                document.getElementById('rabattStufe2Bonus').value = '';
                document.getElementById('rabattStufe3Prozent').value = '';
                document.getElementById('rabattStufe3Ab').value = '';
                document.getElementById('rabattStufe3Bonus').value = '';
            }

            // Konditionen-Checkbox und Datum
            const konditionenGeprueft = kunde.konditionenGeprueft || false;
            document.getElementById('konditionenGeprueft').checked = konditionenGeprueft;
            document.getElementById('konditionenDatum').value = kunde.konditionenDatum || '';
            document.getElementById('konditionenDatum').disabled = !konditionenGeprueft;

            // ðŸ†• Partner-Zugang-Info laden (wenn Partner-Code vorhanden)
            if (kunde.partnerCode) {
                loadPartnerAccessInfo(kunde.partnerCode);
            } else {
                // Partner-Zugang verstecken wenn kein Partner-Code
                document.getElementById('partnerAccessInfo').style.display = 'none';
            }

            document.getElementById('neuerKundeModal').classList.add('active');
        }

        // Kunde lÃ¶schen
        async function deleteKunde(kundeId) {
            const kunde = allKunden.find(k => window.compareIds(k.id, kundeId));
            if (!kunde) return;

            // PrÃ¼fe ob Fahrzeuge fÃ¼r diesen Kunden existieren
            let kundenFahrzeuge = [];
            try {
                if (firebaseInitialized && firebaseApp) {
                    const allFahrzeuge = await firebaseApp.getAllFahrzeuge();
                    kundenFahrzeuge = allFahrzeuge.filter(f => f.kundenId === kundeId || f.kundenname === kunde.name);
                } else {
                    const fahrzeuge = JSON.parse(localStorage.getItem('fahrzeuge') || '[]');
                    kundenFahrzeuge = fahrzeuge.filter(f => f.kundenId === kundeId || f.kundenname === kunde.name);
                }
            } catch (error) {
                console.error('âŒ Fehler beim PrÃ¼fen der Fahrzeuge:', error);
            }

            // Warnung wenn Fahrzeuge existieren
            let confirmMsg = `Kunde "${kunde.name}" wirklich lÃ¶schen?`;
            if (kundenFahrzeuge.length > 0) {
                confirmMsg = `âš ï¸ ACHTUNG: Kunde "${kunde.name}" hat ${kundenFahrzeuge.length} Fahrzeug(e)!\n\n` +
                             `Fahrzeuge werden NICHT gelÃ¶scht, verlieren aber die KundenverknÃ¼pfung.\n\n` +
                             `Trotzdem lÃ¶schen?`;
            }

            if (!confirm(confirmMsg)) return;

            try {
                if (firebaseInitialized && firebaseApp) {
                    await firebaseApp.deleteKunde(kundeId);
                    console.log('âœ… Kunde aus Firestore gelÃ¶scht:', kundeId);
                } else {
                    const index = allKunden.findIndex(k => window.compareIds(k.id, kundeId));
                    if (index !== -1) {
                        allKunden.splice(index, 1);
                        localStorage.setItem('kunden', JSON.stringify(allKunden));
                    }
                    console.log('âœ… Kunde aus LocalStorage gelÃ¶scht:', kundeId);
                }

                await loadKunden();
                updateStats();
                showToast('Kunde erfolgreich gelÃ¶scht!', 'success');
            } catch (error) {
                console.error('âŒ Fehler beim LÃ¶schen:', error);
                showToast('Fehler beim LÃ¶schen des Kunden!', 'error');
            }
        }

        // Kunden-Detail Modal Ã¶ffnen
        function openKundenDetail(kundeId) {
            const kunde = allKunden.find(k => window.compareIds(k.id, kundeId));
            if (!kunde) return;

            document.getElementById('kundenDetailName').textContent = `ðŸ‘¤ ${kunde.name}`;

            const kontakt = [];
            if (kunde.telefon) kontakt.push(`ðŸ“ž ${kunde.telefon}`);
            if (kunde.email) kontakt.push(`ðŸ“§ ${kunde.email}`);

            const detailContent = `
                <div class="form-group">
                    <label>Kontaktdaten:</label>
                    <p>${kontakt.length > 0 ? kontakt.join('<br>') : '<span style="color: #999;">Keine Kontaktdaten hinterlegt</span>'}</p>
                </div>
                ${kunde.notizen ? `
                <div class="form-group">
                    <label>Notizen:</label>
                    <p>${kunde.notizen}</p>
                </div>
                ` : ''}
                <div class="form-group">
                    <label>Statistik:</label>
                    <p>
                        <strong>Anzahl Besuche:</strong> ${kunde.anzahlBesuche || 0}<br>
                        <strong>Erster Besuch:</strong> ${kunde.erstbesuch ? new Date(kunde.erstbesuch).toLocaleDateString('de-DE') : '-'}<br>
                        <strong>Letzter Besuch:</strong> ${kunde.letzterBesuch ? new Date(kunde.letzterBesuch).toLocaleDateString('de-DE') : '-'}
                    </p>
                </div>
            `;

            document.getElementById('kundenDetailContent').innerHTML = detailContent;

            // Historie laden
            // BUGFIX 2025-11-04: Remove name-based fallback (fragile if customer name is edited)
            const kundenFahrzeuge = allFahrzeuge.filter(f => window.compareIds(f.kundenId, kundeId));

            const historieHTML = kundenFahrzeuge.length > 0
                ? kundenFahrzeuge.map(f => {
                    const datum = f.annahmeDatum || '-';
                    const status = f.status === 'abgeschlossen' ? 'âœ…' : f.status === 'angenommen' ? 'â³' : 'ðŸ“‹';

                    return `
                        <div class="historie-item">
                            <div class="historie-date">${status} ${datum}</div>
                            <div class="historie-details">
                                <strong>${f.kennzeichen}</strong> - ${f.marke} ${f.modell}<br>
                                ${f.notizen ? `<small style="color: #666;">${f.notizen}</small>` : ''}
                            </div>
                        </div>
                    `;
                }).join('')
                : '<p style="color: #999; text-align: center; padding: 20px;">Noch keine AuftrÃ¤ge fÃ¼r diesen Kunden</p>';

            document.getElementById('kundenHistorie').innerHTML = historieHTML;
            document.getElementById('kundenDetailModal').classList.add('active');
        }

        // Kunden-Detail Modal schlieÃŸen
        function closeKundenDetailModal() {
            document.getElementById('kundenDetailModal').classList.remove('active');
        }

        // Kunden exportieren als CSV
        function exportKundenToCSV() {
            try {
                if (allKunden.length === 0) {
                    showToast('Keine Kunden zum Exportieren vorhanden!', 'warning');
                    return;
                }

                // CSV Header
                const headers = [
                    'Kunden-ID', 'Name', 'Telefon', 'Email',
                    'Anzahl Besuche', 'Erster Besuch', 'Letzter Besuch', 'Notizen'
                ];

                // CSV Rows
                const rows = allKunden.map(k => [
                    k.id || '',
                    k.name || '',
                    k.telefon || '',
                    k.email || '',
                    k.anzahlBesuche || 0,
                    k.erstbesuch ? new Date(k.erstbesuch).toLocaleDateString('de-DE') : '',
                    k.letzterBesuch ? new Date(k.letzterBesuch).toLocaleDateString('de-DE') : '',
                    (k.notizen || '').replace(/"/g, '""') // Escape quotes
                ].map(field => `"${field}"`).join(','));

                // CSV zusammenbauen
                const csv = [
                    headers.map(h => `"${h}"`).join(','),
                    ...rows
                ].join('\n');

                // Download
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);

                const heute = new Date();
                const dateiname = `Kunden_${heute.toLocaleDateString('de-DE').replace(/\./g, '')}.csv`;

                link.setAttribute('href', url);
                link.setAttribute('download', dateiname);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                console.log(`âœ… ${allKunden.length} Kunden exportiert: ${dateiname}`);
                showToast(`${allKunden.length} Kunden erfolgreich exportiert!`, 'success');
            } catch (error) {
                console.error('âŒ Fehler beim Export:', error);
                showToast('Fehler beim Exportieren der Kunden!', 'error');
            }
        }

        // Modal bei Klick auÃŸerhalb schlieÃŸen
        window.onclick = function(event) {
            const neuerKundeModal = document.getElementById('neuerKundeModal');
            const detailModal = document.getElementById('kundenDetailModal');

            if (event.target === neuerKundeModal) {
                closeNeuerKundeModal();
            }
            if (event.target === detailModal) {
                closeKundenDetailModal();
            }
        }
    </script>

    <!-- âœ¨ Initialize Feather Icons (CRITICAL for Stats Cards!) -->
    <script>
        if (typeof feather !== 'undefined') {
            feather.replace();
            console.log('âœ… Feather Icons initialized');
        } else {
            console.error('âŒ Feather Icons library not loaded!');
        }
    </script>

    <!-- ðŸŒ™ THEME TOGGLE FUNCTIONALITY (Dark Mode) -->
    <script>
        // âœ… Initialize theme from localStorage on page load
        (function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            console.log(`ðŸŽ¨ Theme initialized: ${savedTheme}`);
        })();

        // âœ… Theme Toggle Event Listener
        document.addEventListener('DOMContentLoaded', function() {
            const themeToggle = document.getElementById('themeToggle');

            if (themeToggle) {
                const themeToggleHandler = function() {
                    const currentTheme = document.documentElement.getAttribute('data-theme');
                    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

                    // Update DOM
                    document.documentElement.setAttribute('data-theme', newTheme);

                    // Save to localStorage
                    localStorage.setItem('theme', newTheme);

                    // âœ… Re-render Charts mit neuen Theme-Farben
                    renderTopKundenChart();
                    renderTagDistributionChart();

                    console.log(`ðŸŽ¨ Theme switched: ${currentTheme} â†’ ${newTheme}`);

                    // âœ¨ Optional: Kurzes visuelles Feedback
                    themeToggle.style.transform = 'scale(0.9)';
                    setTimeout(() => {
                        themeToggle.style.transform = 'scale(1)';
                    }, 150);
                };
                window.listenerRegistry.registerDOM(themeToggle, 'click', themeToggleHandler, 'Theme Toggle Button');

                console.log('âœ… Theme Toggle initialized');
            } else {
                console.warn('âš ï¸ Theme Toggle button not found!');
            }
        });
    </script>

    <!-- Toast Container (for notifications) -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- ðŸ“± BOTTOM NAVIGATION BAR (Mobile) -->
    <nav class="bottom-nav">
        <a href="index.html" class="bottom-nav__item">
            <i data-feather="home"></i>
            <span>Home</span>
        </a>
        <a href="liste.html" class="bottom-nav__item">
            <i data-feather="list"></i>
            <span>Fahrzeuge</span>
        </a>
        <a href="kanban.html" class="bottom-nav__item">
            <i data-feather="columns"></i>
            <span>Kanban</span>
        </a>
        <a href="kunden.html" class="bottom-nav__item bottom-nav__item--active">
            <i data-feather="users"></i>
            <span>Kunden</span>
        </a>
    </nav>

    <!-- âœ¨ FLOATING ACTION BUTTON (Mobile) -->
    <button class="fab" onclick="openNeuerKundeModal()" title="Neuer Kunde">
        <i data-feather="plus"></i>
    </button>

    <!-- KI-Chat-Assistent -->
    <div id="aiChatWidget"></div>
    <script src="js/ai-agent-tools.js"></script>
    <script src="js/ai-agent-engine.js"></script>
    <script src="js/ai-chat-widget.js"></script>
    <script src="js/quota-display.js"></script>

    <!-- ============================================
         SERVICE WORKER REGISTRATION - Offline-FunktionalitÃ¤t
         ============================================ -->
    <script>
        // Service Worker nur registrieren wenn:
        // 1. Browser unterstÃ¼tzt Service Worker
        // 2. NICHT in Playwright Tests (navigator.webdriver)
        // 3. NICHT auf Emulator-Port (8000)
        if ('serviceWorker' in navigator && !navigator.webdriver && window.location.port !== '8000') {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('./sw.js', {
                        scope: './'
                    });

                    console.log('âœ… [SW] Service Worker registriert:', registration.scope);

                    // Update-Handling: Neuen SW aktivieren wenn gefunden
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('ðŸ”„ [SW] Update gefunden, installiere...');

                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                console.log('âœ… [SW] Update bereit! Seite neu laden fÃ¼r neue Version.');

                                // Optional: Auto-reload nach 3 Sekunden
                                // setTimeout(() => window.location.reload(), 3000);
                            }
                        });
                    });

                } catch (error) {
                    console.error('âŒ [SW] Registrierung fehlgeschlagen:', error);
                }
            });
        } else {
            console.log('â„¹ï¸ [SW] Service Worker nicht registriert (Test-Modus oder nicht unterstÃ¼tzt)');
        }
    </script>
</body>
</html>
