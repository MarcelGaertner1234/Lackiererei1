<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kundenverwaltung | Auto-Lackierzentrum Mosbach</title>

    <!-- Mobile-Responsive CSS Framework -->
    <link rel="stylesheet" href="mobile-responsive.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }

        /* Mobile: Reduce padding to prevent overflow */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
                border-radius: 15px;
            }
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #003366;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            color: #003366;
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102,126,234,0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(17,153,142,0.4);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-card.green {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .stat-card.blue {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .stat-card.orange {
            background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%);
        }

        .umsatz-filter {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 15px;
            background: #fff;
            border-radius: 10px;
            border: 2px solid #003366;
        }

        .umsatz-filter .filter-btn {
            padding: 8px 15px;
            border: 2px solid #003366;
            background: white;
            color: #003366;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .umsatz-filter .filter-btn:hover {
            background: #003366;
            color: white;
            transform: translateY(-2px);
        }

        .umsatz-filter .filter-btn.active {
            background: #003366;
            color: white;
        }

        .stat-number {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102,126,234,0.2);
        }

        .kunden-table {
            width: 100%;
            min-width: 900px; /* Tabelle darf größer als Container sein für Scroll */
            border-collapse: collapse;
            margin-top: 20px;
        }

        .kunden-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .kunden-table th {
            padding: 10px; /* Reduziert von 15px für mehr Platz */
            text-align: left;
            font-weight: 600;
            white-space: nowrap; /* Verhindert Umbruch in Header */
        }

        .kunden-table td {
            padding: 10px; /* Reduziert von 15px für mehr Platz */
            border-bottom: 1px solid #eee;
        }

        /* Kritische Spalten: Kein Umbruch */
        .kunden-table td:nth-child(1), /* Kundenname */
        .kunden-table td:nth-child(5)  /* Letzter Besuch */
        {
            white-space: nowrap;
        }

        .kunden-table tbody tr {
            transition: all 0.3s;
        }

        .kunden-table tbody tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .action-btns {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .modal-header h2 {
            color: #003366;
            font-size: 24px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 30px;
            cursor: pointer;
            color: #999;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: #f0f0f0;
            color: #333;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #003366;
            margin-bottom: 8px;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102,126,234,0.1);
        }

        .historie-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }

        .historie-section h3 {
            color: #003366;
            margin-bottom: 15px;
        }

        .historie-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .historie-date {
            color: #666;
            font-size: 13px;
            margin-bottom: 5px;
        }

        .historie-details {
            color: #333;
            font-weight: 500;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        /* Table Container - Horizontal Scroll für breite Tabellen */
        .kunden-table-container {
            overflow-x: auto;
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        /* Custom Scrollbar Styling */
        .kunden-table-container::-webkit-scrollbar {
            height: 8px;
        }

        .kunden-table-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .kunden-table-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }

        .kunden-table-container::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Tabelle ohne extra margin-top (wird vom Container übernommen) */
        .kunden-table-container .kunden-table {
            margin-top: 0;
        }

        /* Responsive: Kleinere Schrift auf mittelgroßen Screens */
        @media (max-width: 1200px) {
            .kunden-table {
                font-size: 13px;
            }

            .kunden-table th,
            .kunden-table td {
                padding: 8px; /* Noch kompakter auf kleineren Screens */
            }

            .kunden-table th {
                font-size: 12px;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .kunden-table {
                font-size: 14px;
            }

            .kunden-table th,
            .kunden-table td {
                padding: 10px;
            }

            .nav-bar {
                flex-direction: column;
                gap: 8px;
            }

            .nav-btn {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            /* Container kompakter */
            .container {
                padding: 12px; /* Reduziert von 15px */
            }

            body {
                padding: 8px; /* Reduziert von 10px */
            }

            /* Überschriften kleiner */
            h1 {
                font-size: 18px; /* Reduziert von 24px */
            }

            .header h1 {
                font-size: 20px; /* Reduziert */
            }

            /* Navigation kompakter */
            .nav-btn {
                padding: 8px 10px; /* Reduziert von 10px 12px */
                font-size: 11px; /* Reduziert von 12px */
            }

            /* Statistik-Karten VIEL kompakter */
            .stats {
                grid-template-columns: 1fr;
                gap: 8px; /* Reduziert von 10px */
            }

            .stat-card {
                padding: 10px; /* Reduziert von 15px */
            }

            .stat-number {
                font-size: 20px !important; /* Reduziert von 28px - VIEL KLEINER! */
            }

            .stat-label {
                font-size: 11px; /* Reduziert von 12px */
            }

            .umsatz-filter {
                flex-direction: column;
                align-items: stretch;
            }

            .umsatz-filter .filter-btn {
                width: 100%;
                font-size: 13px;
            }

            /* Tabelle stacken für Mobile */
            .kunden-table-container {
                overflow-x: visible;
            }

            .kunden-table thead {
                display: none;
            }

            /* Kunden-Cards kompakter */
            .kunden-table tbody tr {
                display: block;
                border: 2px solid #003366;
                margin-bottom: 15px; /* Reduziert von 20px */
                padding: 12px; /* Reduziert von 15px */
                border-radius: 10px; /* Reduziert von 12px */
                background: #f9f9f9;
                box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            }

            .kunden-table tbody td {
                display: block;
                text-align: left;
                padding: 7px 0; /* Reduziert von 10px 0 */
                border: none;
                position: relative;
                padding-left: 110px; /* Reduziert von 130px */
                min-height: 30px; /* Reduziert von 40px */
                font-size: 13px; /* Explizit kleiner */
            }

            .kunden-table tbody td::before {
                content: attr(data-label);
                position: absolute;
                left: 0;
                width: 100px; /* Reduziert von 120px */
                font-weight: bold;
                color: #003366;
                font-size: 12px; /* Reduziert von 13px */
            }

            .kunden-table tbody td:last-child {
                padding-left: 0;
                text-align: center;
                margin-top: 10px;
                padding-top: 15px;
                border-top: 1px solid #ddd;
            }

            .kunden-table tbody td:last-child::before {
                display: none;
            }

            /* Buttons kompakter */
            .btn {
                padding: 10px 16px; /* Reduziert von 12px 24px */
                font-size: 13px; /* Reduziert von 16px */
            }

            .btn-small {
                width: 100%;
                min-height: 38px; /* Reduziert von 44px */
                padding: 8px; /* Reduziert von 10px */
                font-size: 12px; /* Reduziert von 13px */
                margin-bottom: 6px; /* Reduziert von 8px */
            }

            /* Charts responsive - kompakter */
            .chart-container {
                position: relative;
                height: 250px; /* Reduziert von 300px */
                margin-bottom: 15px; /* Reduziert von 20px */
            }

            .chart-container canvas {
                max-height: 250px; /* Reduziert von 300px */
            }

            /* Modal kompakter */
            .modal-content {
                width: 95%;
                padding: 15px; /* Reduziert von 20px */
            }

            .kunde-info-item {
                font-size: 12px; /* Reduziert von 13px */
            }
        }

        @media (max-width: 320px) {
            .container {
                padding: 10px;
            }

            h1 {
                font-size: 20px;
            }

            .nav-btn {
                padding: 8px 10px;
                font-size: 11px;
            }

            .stat-number {
                font-size: 24px;
            }

            .stat-label {
                font-size: 11px;
            }

            .umsatz-filter .filter-btn {
                padding: 8px 12px;
                font-size: 12px;
            }

            .kunden-table {
                font-size: 11px;
                min-width: 500px;
            }

            .kunden-table th,
            .kunden-table td {
                padding: 6px 4px;
            }

            .btn-small {
                padding: 5px 8px;
                font-size: 10px;
            }

            .modal-content {
                padding: 15px;
            }

            .kunde-info-item {
                font-size: 12px;
            }
        }

        /* Navigation Bar */
        .nav-bar {
            background: white;
            padding: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            border-bottom: 3px solid #4facfe;
            margin-bottom: 20px;
            border-radius: 15px 15px 0 0;
        }

        .nav-btn {
            padding: 10px 20px;
            background: #4facfe;
            color: white;
            text-decoration: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .nav-btn:hover {
            background: #2196F3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79,172,254,0.3);
        }

        .nav-btn.active {
            background: #2196F3;
        }

        /* ========================================
           ITERATION 1: Mobile-First & Tag-System
           ======================================== */

        /* CSS-Variablen für Tags */
        :root {
            --tag-vip: #ffc107;
            --tag-vip-bg: #fff3cd;
            --tag-vip-text: #856404;
            --tag-stammkunde: #28a745;
            --tag-stammkunde-bg: #d4edda;
            --tag-stammkunde-text: #155724;
            --tag-neukunde: #6c757d;
            --tag-neukunde-bg: #f8f9fa;
            --tag-neukunde-text: #495057;
            --tag-flotte: #007bff;
            --tag-flotte-bg: #d1ecf1;
            --tag-flotte-text: #004085;
            --tag-gewerbe: #fd7e14;
            --tag-gewerbe-bg: #fff3cd;
            --tag-gewerbe-text: #856404;
            --tag-privat: #6f42c1;
            --tag-privat-bg: #e7e3f5;
            --tag-privat-text: #4a2682;

            --toast-success: #28a745;
            --toast-error: #dc3545;
            --toast-warning: #ffc107;
            --toast-info: #17a2b8;
        }

        /* Tag-Chips */
        .tag-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            border: 2px solid;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 36px;
            background: white;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .tag-chip:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .tag-chip:active {
            transform: scale(0.95);
        }

        .tag-chip.active {
            font-weight: 700;
            box-shadow: 0 0 0 3px rgba(0,0,0,0.1);
        }

        .tag-chip-vip {
            background: var(--tag-vip-bg);
            border-color: var(--tag-vip);
            color: var(--tag-vip-text);
        }

        .tag-chip-stammkunde {
            background: var(--tag-stammkunde-bg);
            border-color: var(--tag-stammkunde);
            color: var(--tag-stammkunde-text);
        }

        .tag-chip-neukunde {
            background: var(--tag-neukunde-bg);
            border-color: var(--tag-neukunde);
            color: var(--tag-neukunde-text);
        }

        .tag-chip-flotte {
            background: var(--tag-flotte-bg);
            border-color: var(--tag-flotte);
            color: var(--tag-flotte-text);
        }

        .tag-chip-gewerbe {
            background: var(--tag-gewerbe-bg);
            border-color: var(--tag-gewerbe);
            color: var(--tag-gewerbe-text);
        }

        .tag-chip-privat {
            background: var(--tag-privat-bg);
            border-color: var(--tag-privat);
            color: var(--tag-privat-text);
        }

        /* Tag-Filter-Bar */
        .tag-filter-bar {
            margin-bottom: 20px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .tag-filter-bar .filter-label {
            font-weight: 600;
            color: #003366;
            margin-right: 8px;
        }

        /* Tag Checkbox (for form) */
        .tag-checkbox {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            position: relative;
        }

        .tag-checkbox input[type="checkbox"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .tag-checkbox .tag-chip {
            opacity: 0.5;
            border-style: dashed;
            transition: all 0.2s;
        }

        .tag-checkbox input[type="checkbox"]:checked + .tag-chip {
            opacity: 1;
            border-style: solid;
            font-weight: 700;
            transform: scale(1.05);
        }

        .tag-checkbox:hover .tag-chip {
            opacity: 0.8;
            transform: translateY(-2px);
        }

        /* Mobile Card Layout */
        .kunde-card {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #003366;
            transition: all 0.3s;
            position: relative;
        }

        .kunde-card:active {
            transform: scale(0.98);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .kunde-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .kunde-card-name {
            font-size: 18px;
            font-weight: 700;
            color: #003366;
            margin-bottom: 4px;
        }

        .kunde-card-tags {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .kunde-card-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 15px;
        }

        .kunde-card-info-item {
            font-size: 14px;
        }

        .kunde-card-info-label {
            color: #6c757d;
            font-size: 12px;
            margin-bottom: 2px;
        }

        .kunde-card-info-value {
            font-weight: 600;
            color: #212529;
        }

        .kunde-card-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            z-index: 10000;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 40px);
            max-width: 500px;
            pointer-events: none;
        }

        @media (min-width: 769px) {
            .toast-container {
                top: 80px;
                right: 20px;
                bottom: auto;
                left: auto;
                transform: none;
                width: auto;
                max-width: 400px;
            }
        }

        .toast {
            background: white;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-left: 4px solid;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: all;
            cursor: pointer;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast-success {
            border-left-color: var(--toast-success);
        }

        .toast-error {
            border-left-color: var(--toast-error);
        }

        .toast-warning {
            border-left-color: var(--toast-warning);
        }

        .toast-info {
            border-left-color: var(--toast-info);
        }

        .toast-icon {
            font-size: 20px;
            line-height: 1;
        }

        .toast-message {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
            color: #212529;
        }

        .toast-close {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Touch-optimierte Buttons */
        .btn, .tag-chip, .filter-btn, .nav-btn {
            min-height: 48px;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        .btn-small {
            min-height: 40px;
        }

        /* View-Toggle */
        .view-toggle {
            text-align: right;
            margin-bottom: 15px;
        }

        .view-toggle .btn-secondary {
            background: #f0f0f0;
            border: 2px solid #dee2e6;
        }

        .view-toggle .btn-secondary.active {
            background: #003366;
            color: white;
            border-color: #003366;
        }

        /* Mobile Responsive - Cards statt Tabelle */
        @media (max-width: 768px) {
            .kunden-table {
                display: none !important;
            }

            .kunde-card {
                display: block;
            }

            .view-toggle {
                display: none;
            }

            .tag-filter-bar {
                padding: 12px;
            }

            .tag-chip {
                font-size: 12px;
                padding: 5px 10px;
                min-height: 32px;
            }

            .kunde-card-info {
                grid-template-columns: 1fr;
                gap: 8px;
            }
        }

        /* Desktop - Tabelle Standard, Cards optional */
        @media (min-width: 769px) {
            .kunde-card {
                display: none;
            }

            .kunden-table {
                display: table;
            }

            body.view-cards .kunden-table {
                display: none !important;
            }

            body.view-cards .kunde-card {
                display: block;
            }
        }

        /* Pagination Controls */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .pagination-info {
            font-size: 14px;
            color: #666;
        }

        .pagination-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .pagination-btn {
            padding: 8px 16px;
            border: 2px solid #003366;
            background: white;
            color: #003366;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            min-height: 40px;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #003366;
            color: white;
            transform: translateY(-1px);
        }

        .pagination-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: #003366;
            color: white;
        }

        .page-size-selector {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .page-size-selector select {
            padding: 8px 12px;
            border: 2px solid #003366;
            border-radius: 6px;
            background: white;
            color: #003366;
            font-weight: 600;
            cursor: pointer;
            min-height: 40px;
        }

        /* Advanced Filters */
        .advanced-filters {
            margin-bottom: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }

        .advanced-filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            cursor: pointer;
            user-select: none;
        }

        .advanced-filters-header h3 {
            margin: 0;
            color: #003366;
            font-size: 16px;
        }

        .advanced-filters-content {
            display: none;
            gap: 15px;
            flex-wrap: wrap;
        }

        .advanced-filters-content.active {
            display: flex;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            font-weight: 600;
            color: #003366;
            font-size: 14px;
        }

        .filter-group input {
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .filter-group input:focus {
            outline: none;
            border-color: #003366;
        }

        .filter-actions {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }

        /* Sortable Table Headers */
        .kunden-table th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 25px;
        }

        .kunden-table th.sortable:hover {
            background: #f0f0f0;
        }

        .kunden-table th.sortable::after {
            content: '↕️';
            position: absolute;
            right: 8px;
            opacity: 0.3;
            font-size: 12px;
        }

        .kunden-table th.sortable.sort-asc::after {
            content: '↑';
            opacity: 1;
            color: #003366;
        }

        .kunden-table th.sortable.sort-desc::after {
            content: '↓';
            opacity: 1;
            color: #003366;
        }

        /* Charts Section */
        .charts-section {
            margin-top: 30px;
            margin-bottom: 30px;
        }

        .charts-section h2 {
            color: #003366;
            margin-bottom: 20px;
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #003366;
        }

        .chart-card h3 {
            color: #003366;
            margin-bottom: 15px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .chart-container canvas {
            max-height: 100%;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card-large {
            background: linear-gradient(135deg, #003366 0%, #0055aa 100%);
            border-radius: 12px;
            padding: 20px;
            color: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .stat-card-large h4 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .stat-card-large .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-card-large .stat-subtitle {
            font-size: 12px;
            opacity: 0.8;
        }

        .chart-toggle-btn {
            padding: 10px 20px;
            background: #003366;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            margin-bottom: 20px;
        }

        .chart-toggle-btn:hover {
            background: #0055aa;
            transform: translateY(-2px);
        }

        .charts-section.collapsed .charts-grid {
            display: none;
        }

        .charts-section.collapsed .stats-cards {
            display: none;
        }

        /* Utility Classes */
        .mobile-only {
            display: block;
        }

        .desktop-only {
            display: none;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }

            .chart-container {
                height: 200px;
            }

            .stats-cards {
                grid-template-columns: 1fr; /* Nur 1 Spalte auf Mobile */
            }

            .stat-card-large {
                padding: 15px;
            }

            .stat-card-large .stat-value {
                font-size: 24px; /* Kleinerer Text auf Mobile */
            }

            .stat-card-large h4 {
                font-size: 13px;
            }

            .stat-card-large .stat-subtitle {
                font-size: 11px;
            }
            .pagination-container {
                flex-direction: column;
                align-items: stretch;
            }

            .pagination-controls {
                justify-content: center;
            }

            .page-size-selector {
                justify-content: center;
            }

            .advanced-filters-content {
                flex-direction: column;
            }

            .filter-group {
                min-width: 100%;
            }

            /* Header Mobile */
            .header h1 {
                font-size: 22px;
            }

            .header-actions {
                width: 100%;
                justify-content: stretch;
            }

            .header-actions .btn {
                flex: 1;
                font-size: 13px;
                padding: 10px 12px;
            }

            /* Charts Section Mobile */
            .charts-section h2 {
                font-size: 20px;
            }

            .chart-card h3 {
                font-size: 16px;
            }

            .chart-toggle-btn {
                width: 100%;
                font-size: 14px;
            }

            /* Tag Filter Bar Mobile */
            .tag-filter-bar {
                gap: 6px;
                padding: 12px;
            }

            .tag-chip {
                font-size: 11px;
                padding: 5px 10px;
                min-height: 32px;
            }

            /* View Toggle Mobile */
            .view-toggle {
                margin-bottom: 15px;
            }

            .toggle-btn {
                font-size: 13px;
                padding: 8px 12px;
            }
        }

        @media (min-width: 769px) {
            .mobile-only {
                display: none;
            }

            .desktop-only {
                display: block;
            }
        }
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <!-- Firebase Konfiguration -->
    <script src="firebase-config.js?v=20251021-name-fallback"></script>

    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Global Chat Notifications -->
    <link rel="stylesheet" href="global-chat-notifications.css">
    <script src="global-chat-notifications.js"></script>
</head>
<body>
    <div class="container">
        <!-- Navigation -->
        <div class="nav-bar">
            <a href="index.html" class="nav-btn">Home</a>
            <a href="annahme.html" class="nav-btn">Annahme</a>
            <a href="abnahme.html" class="nav-btn">Abnahme</a>
            <a href="liste.html" class="nav-btn">Übersicht</a>
            <a href="kunden.html" class="nav-btn active">Kunden</a>
            <a href="kalender.html" class="nav-btn">Kalender</a>
            <a href="kanban.html" class="nav-btn">Prozessüberwachung</a>
        </div>

        <div class="header">
            <h1>👥 Kundenverwaltung</h1>
            <div class="header-actions">
                <button class="btn btn-success" onclick="openNeuerKundeModal()">➕ Neuer Kunde</button>
                <button class="btn btn-primary" onclick="exportKundenToCSV()" style="background: #4caf50;">📊 CSV Export</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalKunden">0</div>
                <div class="stat-label">Gesamt Kunden</div>
            </div>
            <div class="stat-card green">
                <div class="stat-number" id="stammkunden">0</div>
                <div class="stat-label">Stammkunden (2+ Besuche)</div>
            </div>
            <div class="stat-card blue">
                <div class="stat-number" id="neukunden">0</div>
                <div class="stat-label">Neukunden (1 Besuch)</div>
            </div>
            <div class="stat-card orange">
                <div class="stat-number" id="totalUmsatz">0,00 €</div>
                <div class="stat-label" id="umsatzLabel">Gesamtumsatz</div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section" id="chartsSection">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>📊 Analysen & Statistiken</h2>
                <button class="chart-toggle-btn" onclick="toggleCharts()" id="chartToggleBtn">
                    📉 Charts ausblenden
                </button>
            </div>

            <!-- Statistics Cards -->
            <div class="stats-cards">
                <div class="stat-card-large">
                    <h4>💰 Durchschnittlicher Umsatz</h4>
                    <div class="stat-value" id="avgUmsatz">0,00 €</div>
                    <div class="stat-subtitle">Pro Kunde</div>
                </div>
                <div class="stat-card-large" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                    <h4>⭐ Top Kunde</h4>
                    <div class="stat-value" id="topKundeName" style="font-size: 20px;">-</div>
                    <div class="stat-subtitle" id="topKundeUmsatz">0,00 € Umsatz</div>
                </div>
                <div class="stat-card-large" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);">
                    <h4>🏷️ Meist genutzter Tag</h4>
                    <div class="stat-value" id="topTag" style="font-size: 20px;">-</div>
                    <div class="stat-subtitle" id="topTagCount">0 Kunden</div>
                </div>
                <div class="stat-card-large" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
                    <h4>📈 Wachstumsrate</h4>
                    <div class="stat-value" id="growthRate">+0%</div>
                    <div class="stat-subtitle">Neue Kunden diesen Monat</div>
                </div>
            </div>

            <!-- Charts Grid -->
            <div class="charts-grid">
                <!-- Top 10 Kunden Chart -->
                <div class="chart-card">
                    <h3>💰 Top 10 Kunden nach Umsatz</h3>
                    <div class="chart-container">
                        <canvas id="topKundenChart"></canvas>
                    </div>
                </div>

                <!-- Tag Distribution Chart -->
                <div class="chart-card">
                    <h3>🏷️ Kunden nach Tags</h3>
                    <div class="chart-container">
                        <canvas id="tagDistributionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="umsatz-filter">
            <span style="font-weight: 600; color: #003366; margin-right: 10px;">Umsatz-Zeitraum:</span>
            <button class="filter-btn active" onclick="setUmsatzFilter('gesamt')">📊 Gesamt</button>
            <button class="filter-btn" onclick="setUmsatzFilter('jahr')">📅 Jahr</button>
            <button class="filter-btn" onclick="setUmsatzFilter('monat')">📆 Monat</button>
        </div>

        <!-- Tag Filter Bar -->
        <div class="tag-filter-bar">
            <span style="font-weight: 600; color: #003366; margin-right: 10px;">Tags filtern:</span>
            <div class="tag-chip tag-chip-vip" onclick="toggleTagFilter('vip')">
                ⭐ VIP
            </div>
            <div class="tag-chip tag-chip-stammkunde" onclick="toggleTagFilter('stammkunde')">
                💚 Stammkunde
            </div>
            <div class="tag-chip tag-chip-neukunde" onclick="toggleTagFilter('neukunde')">
                ✨ Neukunde
            </div>
            <div class="tag-chip tag-chip-flotte" onclick="toggleTagFilter('flotte')">
                🚗 Flotte
            </div>
            <div class="tag-chip tag-chip-gewerbe" onclick="toggleTagFilter('gewerbe')">
                🏢 Gewerbe
            </div>
            <div class="tag-chip tag-chip-privat" onclick="toggleTagFilter('privat')">
                👤 Privat
            </div>
            <button class="btn btn-sm" onclick="clearTagFilters()" style="margin-left: 10px; padding: 8px 16px;">
                🔄 Filter zurücksetzen
            </button>
        </div>

        <!-- View Toggle (Desktop only) -->
        <div class="view-toggle desktop-only">
            <button class="toggle-btn active" onclick="setViewMode('table')" id="viewTableBtn">
                📋 Tabelle
            </button>
            <button class="toggle-btn" onclick="setViewMode('cards')" id="viewCardsBtn">
                📱 Karten
            </button>
        </div>

        <div class="search-box">
            <input type="text" id="searchInput" placeholder="🔍 Kunde suchen (Name, Telefon, Email)..." oninput="filterKunden()">
        </div>

        <!-- Advanced Filters -->
        <div class="advanced-filters">
            <div class="advanced-filters-header" onclick="toggleAdvancedFilters()">
                <h3>🔍 Erweiterte Filter</h3>
                <span id="advancedFiltersToggle">▼</span>
            </div>
            <div class="advanced-filters-content" id="advancedFiltersContent">
                <div class="filter-group">
                    <label for="umsatzMin">💰 Umsatz Min (€)</label>
                    <input type="number" id="umsatzMin" placeholder="z.B. 1000" step="100" min="0">
                </div>
                <div class="filter-group">
                    <label for="umsatzMax">💰 Umsatz Max (€)</label>
                    <input type="number" id="umsatzMax" placeholder="z.B. 10000" step="100" min="0">
                </div>
                <div class="filter-group">
                    <label for="dateFrom">📅 Besuch Von</label>
                    <input type="date" id="dateFrom">
                </div>
                <div class="filter-group">
                    <label for="dateTo">📅 Besuch Bis</label>
                    <input type="date" id="dateTo">
                </div>
                <div class="filter-actions">
                    <button class="btn btn-primary" onclick="applyAdvancedFilters()" style="min-height: 40px;">
                        ✅ Filter anwenden
                    </button>
                    <button class="btn" onclick="resetAdvancedFilters()" style="background: #6c757d; color: white; min-height: 40px;">
                        🔄 Zurücksetzen
                    </button>
                </div>
            </div>
        </div>

        <!-- Table Container mit horizontal scroll -->
        <div class="kunden-table-container">
            <table class="kunden-table">
                <thead>
                    <tr>
                        <th class="sortable" onclick="sortTable('name')">Kundenname</th>
                        <th>Kontakt</th>
                        <th class="sortable" onclick="sortTable('besuche')">Besuche</th>
                        <th class="sortable" onclick="sortTable('umsatz')">Umsatz</th>
                        <th class="sortable" onclick="sortTable('letzterBesuch')">Letzter Besuch</th>
                        <th>Status</th>
                        <th>Tags</th>
                        <th>Aktionen</th>
                    </tr>
                </thead>
                <tbody id="kundenTableBody">
                    <!-- Dynamisch gefüllt -->
                </tbody>
            </table>
        </div>

        <!-- Mobile Cards Container -->
        <div id="kundenCardsContainer" class="mobile-only">
            <!-- Dynamisch gefüllt mit kunde-card Elementen -->
        </div>

        <!-- Pagination Controls -->
        <div class="pagination-container" id="paginationContainer">
            <div class="pagination-info" id="paginationInfo">
                <!-- Dynamisch gefüllt: "Zeige 1-25 von 100 Kunden" -->
            </div>

            <div class="pagination-controls">
                <button class="pagination-btn" id="firstPageBtn" onclick="goToPage(1)">
                    ⏮️ Erste
                </button>
                <button class="pagination-btn" id="prevPageBtn" onclick="goToPage(currentPage - 1)">
                    ◀️ Zurück
                </button>
                <span id="pageNumbers" style="display: flex; gap: 4px;">
                    <!-- Dynamisch gefüllt mit Seitenzahlen -->
                </span>
                <button class="pagination-btn" id="nextPageBtn" onclick="goToPage(currentPage + 1)">
                    Weiter ▶️
                </button>
                <button class="pagination-btn" id="lastPageBtn" onclick="goToPage(Math.ceil(totalFilteredKunden / itemsPerPage))">
                    Letzte ⏭️
                </button>
            </div>

            <div class="page-size-selector">
                <label for="itemsPerPageSelect" style="font-weight: 600; color: #003366;">Pro Seite:</label>
                <select id="itemsPerPageSelect" onchange="changeItemsPerPage(this.value)">
                    <option value="10">10</option>
                    <option value="25" selected>25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
        </div>

        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="empty-state-icon">👤</div>
            <h3>Noch keine Kunden vorhanden</h3>
            <p>Klicke auf "Neuer Kunde" um den ersten Kunden anzulegen.</p>
        </div>
    </div>

    <!-- Modal: Neuer Kunde -->
    <div id="neuerKundeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>➕ Neuer Kunde</h2>
                <button class="close-btn" onclick="closeNeuerKundeModal()">&times;</button>
            </div>
            <form id="neuerKundeForm">
                <div class="form-group">
                    <label for="kundenName">Name *</label>
                    <input type="text" id="kundenName" placeholder="z.B. Max Mustermann" required>
                </div>
                <div class="form-group">
                    <label for="kundenTelefon">Telefon</label>
                    <input type="tel" id="kundenTelefon" placeholder="z.B. 0123456789">
                </div>
                <div class="form-group">
                    <label for="kundenEmail">Email</label>
                    <input type="email" id="kundenEmail" placeholder="z.B. max@example.com">
                </div>
                <div class="form-group">
                    <label for="kundenNotizen">Notizen</label>
                    <textarea id="kundenNotizen" rows="3" placeholder="z.B. Stammkunde seit 2020, bevorzugt Premium-Lack..."></textarea>
                </div>
                <div class="form-group">
                    <label for="partnerCode">🤝 Partner-Code (B2B)</label>
                    <input type="text" id="partnerCode" placeholder="z.B. VW-BUCHEN-2024 (für Autohäuser/Partner mit Portal-Zugang)">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        ℹ️ Wenn dieser Kunde ein B2B-Partner mit Portal-Zugang ist, gib hier seinen Partner-Code ein.
                        Rabatt-Konditionen werden dann automatisch im Partner-Portal synchronisiert.
                    </small>
                </div>
                <div class="form-group">
                    <label style="font-weight: 600; color: #003366; margin-bottom: 10px; display: block;">🏷️ Tags</label>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        <label class="tag-checkbox">
                            <input type="checkbox" id="tagVip" value="vip">
                            <span class="tag-chip tag-chip-vip" style="margin: 0;">⭐ VIP</span>
                        </label>
                        <label class="tag-checkbox">
                            <input type="checkbox" id="tagStammkunde" value="stammkunde">
                            <span class="tag-chip tag-chip-stammkunde" style="margin: 0;">💚 Stammkunde</span>
                        </label>
                        <label class="tag-checkbox">
                            <input type="checkbox" id="tagNeukunde" value="neukunde">
                            <span class="tag-chip tag-chip-neukunde" style="margin: 0;">✨ Neukunde</span>
                        </label>
                        <label class="tag-checkbox">
                            <input type="checkbox" id="tagFlotte" value="flotte">
                            <span class="tag-chip tag-chip-flotte" style="margin: 0;">🚗 Flotte</span>
                        </label>
                        <label class="tag-checkbox">
                            <input type="checkbox" id="tagGewerbe" value="gewerbe">
                            <span class="tag-chip tag-chip-gewerbe" style="margin: 0;">🏢 Gewerbe</span>
                        </label>
                        <label class="tag-checkbox">
                            <input type="checkbox" id="tagPrivat" value="privat">
                            <span class="tag-chip tag-chip-privat" style="margin: 0;">👤 Privat</span>
                        </label>
                    </div>
                </div>

                <!-- RABATT-KONDITIONEN (NEU) -->
                <div class="form-group" style="border-top: 2px solid #e0e0e0; padding-top: 20px; margin-top: 20px;">
                    <label style="font-weight: 600; color: #2196f3; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; font-size: 16px;">
                        🎁 Individuelle Rabatt-Konditionen (B2B)
                    </label>

                    <!-- Rabatt-Stufen -->
                    <div style="background: #f5f5f5; padding: 15px; border-radius: 10px; margin-bottom: 12px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 10px;">
                            <!-- Stufe 1 -->
                            <div style="background: white; padding: 12px; border-radius: 8px; border: 2px solid #e0e0e0;">
                                <div style="font-weight: 600; color: #666; margin-bottom: 8px; font-size: 12px;">STUFE 1 (Einstieg)</div>

                                <!-- Zeile 1: Laufender Rabatt -->
                                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                    <input type="number" id="rabattStufe1Prozent" placeholder="5" min="0" max="100" step="0.5"
                                           style="width: 60px; padding: 6px; border: 1px solid #ddd; border-radius: 6px; text-align: center;">
                                    <span style="align-self: center; font-weight: 600; font-size: 12px;">%</span>
                                    <span style="align-self: center; color: #666; font-size: 12px;">ab</span>
                                    <input type="number" id="rabattStufe1Ab" placeholder="2000" min="0" step="100"
                                           style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 6px; text-align: right;">
                                    <span style="align-self: center; font-weight: 600; font-size: 12px;">€/Monat</span>
                                </div>

                                <!-- Zeile 2: Einmal-Bonus -->
                                <div style="display: flex; gap: 8px; padding-top: 8px; border-top: 1px solid #eee;">
                                    <span style="align-self: center; color: #666; font-size: 11px; width: 50px;">🎁 Bonus:</span>
                                    <input type="number" id="rabattStufe1Bonus" placeholder="100" min="0" step="10"
                                           style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 6px; text-align: right;">
                                    <span style="align-self: center; font-weight: 600; font-size: 12px;">€</span>
                                    <span style="align-self: center; color: #999; font-size: 10px;">(1x)*</span>
                                </div>
                            </div>

                            <!-- Stufe 2 -->
                            <div style="background: white; padding: 12px; border-radius: 8px; border: 2px solid #4caf50;">
                                <div style="font-weight: 600; color: #4caf50; margin-bottom: 8px; font-size: 12px;">STUFE 2 (Stammkunde)</div>

                                <!-- Zeile 1: Laufender Rabatt -->
                                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                    <input type="number" id="rabattStufe2Prozent" placeholder="10" min="0" max="100" step="0.5"
                                           style="width: 60px; padding: 6px; border: 1px solid #ddd; border-radius: 6px; text-align: center;">
                                    <span style="align-self: center; font-weight: 600; font-size: 12px;">%</span>
                                    <span style="align-self: center; color: #666; font-size: 12px;">ab</span>
                                    <input type="number" id="rabattStufe2Ab" placeholder="5000" min="0" step="100"
                                           style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 6px; text-align: right;">
                                    <span style="align-self: center; font-weight: 600; font-size: 12px;">€/Monat</span>
                                </div>

                                <!-- Zeile 2: Einmal-Bonus -->
                                <div style="display: flex; gap: 8px; padding-top: 8px; border-top: 1px solid #eee;">
                                    <span style="align-self: center; color: #666; font-size: 11px; width: 50px;">🎁 Bonus:</span>
                                    <input type="number" id="rabattStufe2Bonus" placeholder="500" min="0" step="50"
                                           style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 6px; text-align: right;">
                                    <span style="align-self: center; font-weight: 600; font-size: 12px;">€</span>
                                    <span style="align-self: center; color: #999; font-size: 10px;">(1x)*</span>
                                </div>
                            </div>

                            <!-- Stufe 3 -->
                            <div style="background: white; padding: 12px; border-radius: 8px; border: 2px solid #ff9800;">
                                <div style="font-weight: 600; color: #ff9800; margin-bottom: 8px; font-size: 12px;">STUFE 3 (VIP)</div>

                                <!-- Zeile 1: Laufender Rabatt -->
                                <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                    <input type="number" id="rabattStufe3Prozent" placeholder="15" min="0" max="100" step="0.5"
                                           style="width: 60px; padding: 6px; border: 1px solid #ddd; border-radius: 6px; text-align: center;">
                                    <span style="align-self: center; font-weight: 600; font-size: 12px;">%</span>
                                    <span style="align-self: center; color: #666; font-size: 12px;">ab</span>
                                    <input type="number" id="rabattStufe3Ab" placeholder="10000" min="0" step="100"
                                           style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 6px; text-align: right;">
                                    <span style="align-self: center; font-weight: 600; font-size: 12px;">€/Monat</span>
                                </div>

                                <!-- Zeile 2: Einmal-Bonus -->
                                <div style="display: flex; gap: 8px; padding-top: 8px; border-top: 1px solid #eee;">
                                    <span style="align-self: center; color: #666; font-size: 11px; width: 50px;">🎁 Bonus:</span>
                                    <input type="number" id="rabattStufe3Bonus" placeholder="1500" min="0" step="100"
                                           style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 6px; text-align: right;">
                                    <span style="align-self: center; font-weight: 600; font-size: 12px;">€</span>
                                    <span style="align-self: center; color: #999; font-size: 10px;">(1x)*</span>
                                </div>
                            </div>
                        </div>

                        <!-- Hinweis -->
                        <div style="margin-top: 10px; padding: 8px; background: #fff3cd; border-radius: 6px; font-size: 11px; color: #856404;">
                            <strong>Hinweis:</strong> Laufender Rabatt wird automatisch angewendet. * Einmal-Bonus wird in Phase 2 implementiert (Auszahlung nach erstmaligem Erreichen der Stufe).
                        </div>
                    </div>

                    <!-- Konditionen telefonisch geklärt -->
                    <div style="background: #fff3e0; border: 2px solid #ff9800; border-radius: 10px; padding: 15px; margin-bottom: 12px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 10px;">
                            <input type="checkbox" id="konditionenGeprueft"
                                   style="width: 20px; height: 20px; cursor: pointer;"
                                   onchange="document.getElementById('konditionenDatum').disabled = !this.checked;">
                            <span style="font-weight: 600; color: #e65100;">✅ Konditionen telefonisch geklärt</span>
                        </label>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="color: #666; font-size: 14px;">Datum:</label>
                            <input type="date" id="konditionenDatum" disabled
                                   style="padding: 6px 10px; border: 1px solid #ddd; border-radius: 6px; background: white;">
                        </div>
                    </div>

                    <!-- Hinweis -->
                    <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 12px; border-radius: 6px; font-size: 13px; color: #1565c0; line-height: 1.6;">
                        <strong>⚠️ Wichtig:</strong> Rabatt-Konditionen müssen telefonisch mit dem Kunden vereinbart werden, bevor Rabatte gewährt werden.
                        Dies gilt nur für B2B-Kunden (Autohäuser, Flotten, Gewerbetreibende).
                    </div>
                </div>

                <button type="submit" class="btn btn-success" style="width: 100%;">💾 Kunde speichern</button>
            </form>
        </div>
    </div>

    <!-- Modal: Kunden-Details -->
    <div id="kundenDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="kundenDetailName">👤 Kundendetails</h2>
                <button class="close-btn" onclick="closeKundenDetailModal()">&times;</button>
            </div>

            <div id="kundenDetailContent">
                <!-- Dynamisch gefüllt -->
            </div>

            <div class="historie-section">
                <h3>📋 Auftragshistorie</h3>
                <div id="kundenHistorie">
                    <!-- Dynamisch gefüllt -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let allKunden = [];
        let allFahrzeuge = [];
        let firebaseInitialized = false;
        // firebaseApp is provided by firebase-config.js as window.firebaseApp
        let currentKundeId = null;
        let currentUmsatzFilter = 'gesamt'; // gesamt, jahr, monat

        // ================== TAG SYSTEM ==================
        const AVAILABLE_TAGS = {
            vip: {
                id: 'vip',
                name: 'VIP',
                icon: '⭐',
                color: '#ffc107',
                bgColor: '#fff3cd',
                textColor: '#856404',
                description: 'VIP-Kunde mit hoher Priorität'
            },
            stammkunde: {
                id: 'stammkunde',
                name: 'Stammkunde',
                icon: '💚',
                color: '#28a745',
                bgColor: '#d4edda',
                textColor: '#155724',
                description: 'Regelmäßiger Kunde (3+ Besuche)'
            },
            neukunde: {
                id: 'neukunde',
                name: 'Neukunde',
                icon: '✨',
                color: '#17a2b8',
                bgColor: '#d1ecf1',
                textColor: '#0c5460',
                description: 'Neuer Kunde (1-2 Besuche)'
            },
            flotte: {
                id: 'flotte',
                name: 'Flotte',
                icon: '🚗',
                color: '#6f42c1',
                bgColor: '#e2d9f3',
                textColor: '#4a2c7a',
                description: 'Flottenkunde mit mehreren Fahrzeugen'
            },
            gewerbe: {
                id: 'gewerbe',
                name: 'Gewerbe',
                icon: '🏢',
                color: '#fd7e14',
                bgColor: '#ffe5d0',
                textColor: '#8a3f00',
                description: 'Gewerblicher Kunde'
            },
            privat: {
                id: 'privat',
                name: 'Privat',
                icon: '👤',
                color: '#6c757d',
                bgColor: '#e2e3e5',
                textColor: '#383d41',
                description: 'Privatkunde'
            }
        };

        let activeTagFilters = new Set(); // Aktive Tag-Filter
        let currentViewMode = 'table'; // 'table' oder 'cards'

        // ================== PAGINATION & SORTING ==================
        let currentPage = 1;
        let itemsPerPage = 25; // Default: 25 pro Seite
        let sortColumn = 'letzterBesuch'; // Default: Sortierung nach letztem Besuch
        let sortDirection = 'desc'; // 'asc' oder 'desc'

        // Advanced Filters
        let advancedFilters = {
            umsatzMin: null,
            umsatzMax: null,
            dateFrom: null,
            dateTo: null
        };

        // ================== TAG FUNCTIONS ==================

        // Tag zu Kunde hinzufügen
        function addTagToKunde(kundeId, tagId) {
            const kunde = allKunden.find(k => k.id === kundeId);
            if (!kunde) return;

            if (!kunde.tags) kunde.tags = [];
            if (!kunde.tags.includes(tagId)) {
                kunde.tags.push(tagId);
                saveKundeToFirebase(kunde);
                showSuccessToast(`Tag "${AVAILABLE_TAGS[tagId].name}" hinzugefügt`);
            }
        }

        // Tag von Kunde entfernen
        function removeTagFromKunde(kundeId, tagId) {
            const kunde = allKunden.find(k => k.id === kundeId);
            if (!kunde) return;

            if (kunde.tags) {
                kunde.tags = kunde.tags.filter(t => t !== tagId);
                saveKundeToFirebase(kunde);
                showSuccessToast(`Tag "${AVAILABLE_TAGS[tagId].name}" entfernt`);
            }
        }

        // Auto-assign Tags basierend auf Geschäftsregeln
        function autoAssignTags(kunde) {
            if (!kunde.tags) kunde.tags = [];

            const besuchsAnzahl = kunde.besuchsAnzahl || 0;
            const umsatz = calculateKundenUmsatz(kunde.id, currentUmsatzFilter);

            // VIP: Umsatz über 5000€
            if (umsatz >= 5000 && !kunde.tags.includes('vip')) {
                kunde.tags.push('vip');
            }

            // Stammkunde: 3+ Besuche
            if (besuchsAnzahl >= 3 && !kunde.tags.includes('stammkunde')) {
                kunde.tags.push('stammkunde');
                // Entferne Neukunde wenn Stammkunde
                kunde.tags = kunde.tags.filter(t => t !== 'neukunde');
            }

            // Neukunde: 1-2 Besuche
            if (besuchsAnzahl >= 1 && besuchsAnzahl <= 2 && !kunde.tags.includes('neukunde') && !kunde.tags.includes('stammkunde')) {
                kunde.tags.push('neukunde');
            }

            // Flotte: 5+ Fahrzeuge
            const kundenFahrzeuge = allFahrzeuge.filter(f => f.kundenName?.toLowerCase() === kunde.name?.toLowerCase());
            if (kundenFahrzeuge.length >= 5 && !kunde.tags.includes('flotte')) {
                kunde.tags.push('flotte');
            }

            return kunde.tags;
        }

        // Rendere Tag-Chips (für Tabelle/Cards)
        function renderTagChips(tags) {
            if (!tags || tags.length === 0) {
                return '<span style="color: #999; font-size: 12px;">Keine Tags</span>';
            }

            return tags.map(tagId => {
                const tag = AVAILABLE_TAGS[tagId];
                if (!tag) return '';
                return `<span class="tag-chip tag-chip-${tagId}" style="font-size: 11px; padding: 4px 10px; margin: 2px;">${tag.icon} ${tag.name}</span>`;
            }).join(' ');
        }

        // Toggle Tag Filter
        function toggleTagFilter(tagId) {
            const chipElement = document.querySelector(`.tag-filter-bar .tag-chip-${tagId}`);

            if (activeTagFilters.has(tagId)) {
                activeTagFilters.delete(tagId);
                chipElement?.classList.remove('active');
            } else {
                activeTagFilters.add(tagId);
                chipElement?.classList.add('active');
            }

            renderKundenView();
        }

        // Clear all tag filters
        function clearTagFilters() {
            activeTagFilters.clear();
            document.querySelectorAll('.tag-filter-bar .tag-chip').forEach(chip => {
                chip.classList.remove('active');
            });
            renderKundenView();
        }

        // ================== PAGINATION FUNCTIONS ==================

        let totalFilteredKunden = 0; // Wird in getFilteredKunden() aktualisiert

        function goToPage(page) {
            const totalPages = Math.ceil(totalFilteredKunden / itemsPerPage);
            if (page < 1 || page > totalPages) return;

            currentPage = page;
            renderKundenView();
            updatePaginationControls();

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function changeItemsPerPage(newSize) {
            itemsPerPage = parseInt(newSize);
            currentPage = 1; // Reset to first page
            renderKundenView();
            updatePaginationControls();
        }

        function updatePaginationControls() {
            const totalPages = Math.ceil(totalFilteredKunden / itemsPerPage);
            const startItem = totalFilteredKunden === 0 ? 0 : (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, totalFilteredKunden);

            // Update info text
            const infoEl = document.getElementById('paginationInfo');
            if (infoEl) {
                infoEl.textContent = `Zeige ${startItem}-${endItem} von ${totalFilteredKunden} Kunden`;
            }

            // Update button states
            const firstBtn = document.getElementById('firstPageBtn');
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            const lastBtn = document.getElementById('lastPageBtn');

            if (firstBtn) firstBtn.disabled = currentPage === 1;
            if (prevBtn) prevBtn.disabled = currentPage === 1;
            if (nextBtn) nextBtn.disabled = currentPage === totalPages || totalPages === 0;
            if (lastBtn) lastBtn.disabled = currentPage === totalPages || totalPages === 0;

            // Render page numbers
            renderPageNumbers(totalPages);

            // Hide pagination if only 1 page
            const paginationContainer = document.getElementById('paginationContainer');
            if (paginationContainer) {
                paginationContainer.style.display = totalPages <= 1 ? 'none' : 'flex';
            }
        }

        function renderPageNumbers(totalPages) {
            const pageNumbersEl = document.getElementById('pageNumbers');
            if (!pageNumbersEl) return;

            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            // Adjust if we're near the end
            if (endPage - startPage < maxVisiblePages - 1) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            let html = '';
            for (let i = startPage; i <= endPage; i++) {
                const activeClass = i === currentPage ? 'active' : '';
                html += `<button class="pagination-btn ${activeClass}" onclick="goToPage(${i})">${i}</button>`;
            }

            pageNumbersEl.innerHTML = html;
        }

        // ================== SORTING FUNCTIONS ==================

        function sortTable(column) {
            // Toggle direction if same column clicked
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            // Update UI
            document.querySelectorAll('.kunden-table th.sortable').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });

            const headerMap = {
                'name': 0,
                'besuche': 2,
                'umsatz': 3,
                'letzterBesuch': 4
            };

            const thIndex = headerMap[column];
            if (thIndex !== undefined) {
                const th = document.querySelectorAll('.kunden-table th.sortable')[Object.keys(headerMap).indexOf(column)];
                if (th) {
                    th.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            }

            renderKundenView();
        }

        function sortKunden(kunden) {
            return kunden.sort((a, b) => {
                let valueA, valueB;

                switch (sortColumn) {
                    case 'name':
                        valueA = a.name?.toLowerCase() || '';
                        valueB = b.name?.toLowerCase() || '';
                        break;
                    case 'besuche':
                        valueA = a.anzahlBesuche || 0;
                        valueB = b.anzahlBesuche || 0;
                        break;
                    case 'umsatz':
                        valueA = calculateKundenUmsatz(a.id, currentUmsatzFilter);
                        valueB = calculateKundenUmsatz(b.id, currentUmsatzFilter);
                        break;
                    case 'letzterBesuch':
                        valueA = a.letzterBesuch ? new Date(a.letzterBesuch) : new Date(0);
                        valueB = b.letzterBesuch ? new Date(b.letzterBesuch) : new Date(0);
                        break;
                    default:
                        return 0;
                }

                if (valueA < valueB) return sortDirection === 'asc' ? -1 : 1;
                if (valueA > valueB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
        }

        // ================== ADVANCED FILTERS ==================

        function toggleAdvancedFilters() {
            const content = document.getElementById('advancedFiltersContent');
            const toggle = document.getElementById('advancedFiltersToggle');

            if (content && toggle) {
                const isActive = content.classList.toggle('active');
                toggle.textContent = isActive ? '▲' : '▼';
            }
        }

        function applyAdvancedFilters() {
            advancedFilters.umsatzMin = parseFloat(document.getElementById('umsatzMin')?.value) || null;
            advancedFilters.umsatzMax = parseFloat(document.getElementById('umsatzMax')?.value) || null;
            advancedFilters.dateFrom = document.getElementById('dateFrom')?.value || null;
            advancedFilters.dateTo = document.getElementById('dateTo')?.value || null;

            currentPage = 1; // Reset to first page
            renderKundenView();
            showSuccessToast('Filter angewendet!');
        }

        function resetAdvancedFilters() {
            advancedFilters = {
                umsatzMin: null,
                umsatzMax: null,
                dateFrom: null,
                dateTo: null
            };

            document.getElementById('umsatzMin').value = '';
            document.getElementById('umsatzMax').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';

            currentPage = 1;
            renderKundenView();
            showInfoToast('Filter zurückgesetzt');
        }

        // ================== CHARTS & ANALYTICS ==================

        let topKundenChart = null;
        let tagDistributionChart = null;

        function toggleCharts() {
            const section = document.getElementById('chartsSection');
            const btn = document.getElementById('chartToggleBtn');

            if (section && btn) {
                const isCollapsed = section.classList.toggle('collapsed');
                btn.textContent = isCollapsed ? '📈 Charts einblenden' : '📉 Charts ausblenden';
            }
        }

        function renderCharts() {
            renderTopKundenChart();
            renderTagDistributionChart();
            updateAdvancedStats();
        }

        function renderTopKundenChart() {
            const ctx = document.getElementById('topKundenChart');
            if (!ctx) return;

            // Get top 10 customers by revenue
            const kundenMitUmsatz = allKunden.map(kunde => ({
                name: kunde.name,
                umsatz: calculateKundenUmsatz(kunde.id, currentUmsatzFilter)
            })).filter(k => k.umsatz > 0)
              .sort((a, b) => b.umsatz - a.umsatz)
              .slice(0, 10);

            if (kundenMitUmsatz.length === 0) {
                if (topKundenChart) {
                    topKundenChart.destroy();
                    topKundenChart = null;
                }
                return;
            }

            const labels = kundenMitUmsatz.map(k => k.name);
            const data = kundenMitUmsatz.map(k => k.umsatz);

            // Destroy existing chart
            if (topKundenChart) {
                topKundenChart.destroy();
            }

            topKundenChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Umsatz (€)',
                        data: data,
                        backgroundColor: 'rgba(0, 51, 102, 0.8)',
                        borderColor: 'rgba(0, 51, 102, 1)',
                        borderWidth: 2,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Umsatz: ' + context.parsed.y.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' €';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('de-DE') + ' €';
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        function renderTagDistributionChart() {
            const ctx = document.getElementById('tagDistributionChart');
            if (!ctx) return;

            // Count tags
            const tagCounts = {};
            Object.keys(AVAILABLE_TAGS).forEach(tagId => {
                tagCounts[tagId] = 0;
            });

            allKunden.forEach(kunde => {
                if (kunde.tags && kunde.tags.length > 0) {
                    kunde.tags.forEach(tagId => {
                        if (tagCounts[tagId] !== undefined) {
                            tagCounts[tagId]++;
                        }
                    });
                }
            });

            const labels = [];
            const data = [];
            const colors = [];

            Object.keys(tagCounts).forEach(tagId => {
                if (tagCounts[tagId] > 0) {
                    const tag = AVAILABLE_TAGS[tagId];
                    labels.push(tag.icon + ' ' + tag.name);
                    data.push(tagCounts[tagId]);
                    colors.push(tag.color);
                }
            });

            if (data.length === 0) {
                if (tagDistributionChart) {
                    tagDistributionChart.destroy();
                    tagDistributionChart = null;
                }
                return;
            }

            // Destroy existing chart
            if (tagDistributionChart) {
                tagDistributionChart.destroy();
            }

            tagDistributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return context.label + ': ' + context.parsed + ' Kunden (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateAdvancedStats() {
            // Average Revenue
            const totalRevenue = allKunden.reduce((sum, kunde) => {
                return sum + calculateKundenUmsatz(kunde.id, currentUmsatzFilter);
            }, 0);
            const avgRevenue = allKunden.length > 0 ? totalRevenue / allKunden.length : 0;
            document.getElementById('avgUmsatz').textContent = avgRevenue.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' €';

            // Top Customer
            const topKunde = allKunden.map(k => ({
                name: k.name,
                umsatz: calculateKundenUmsatz(k.id, currentUmsatzFilter)
            })).sort((a, b) => b.umsatz - a.umsatz)[0];

            if (topKunde) {
                document.getElementById('topKundeName').textContent = topKunde.name;
                document.getElementById('topKundeUmsatz').textContent = topKunde.umsatz.toLocaleString('de-DE', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' € Umsatz';
            } else {
                document.getElementById('topKundeName').textContent = '-';
                document.getElementById('topKundeUmsatz').textContent = '0,00 € Umsatz';
            }

            // Most Used Tag
            const tagCounts = {};
            Object.keys(AVAILABLE_TAGS).forEach(tagId => tagCounts[tagId] = 0);
            allKunden.forEach(kunde => {
                if (kunde.tags) kunde.tags.forEach(tagId => {
                    if (tagCounts[tagId] !== undefined) tagCounts[tagId]++;
                });
            });

            const topTagEntry = Object.entries(tagCounts).sort((a, b) => b[1] - a[1])[0];
            if (topTagEntry && topTagEntry[1] > 0) {
                const tag = AVAILABLE_TAGS[topTagEntry[0]];
                document.getElementById('topTag').textContent = tag.icon + ' ' + tag.name;
                document.getElementById('topTagCount').textContent = topTagEntry[1] + ' Kunden';
            } else {
                document.getElementById('topTag').textContent = '-';
                document.getElementById('topTagCount').textContent = '0 Kunden';
            }

            // Growth Rate (new customers this month)
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            const newThisMonth = allKunden.filter(kunde => {
                if (!kunde.erstbesuch) return false;
                const erstbesuch = new Date(kunde.erstbesuch);
                return erstbesuch.getMonth() === currentMonth && erstbesuch.getFullYear() === currentYear;
            }).length;

            const lastMonth = new Date(now);
            lastMonth.setMonth(lastMonth.getMonth() - 1);
            const lastMonthCount = allKunden.filter(kunde => {
                if (!kunde.erstbesuch) return false;
                const erstbesuch = new Date(kunde.erstbesuch);
                return erstbesuch.getMonth() === lastMonth.getMonth() && erstbesuch.getFullYear() === lastMonth.getFullYear();
            }).length;

            const growthRate = lastMonthCount > 0 ? ((newThisMonth - lastMonthCount) / lastMonthCount * 100) : (newThisMonth > 0 ? 100 : 0);
            const growthSign = growthRate > 0 ? '+' : '';
            document.getElementById('growthRate').textContent = growthSign + growthRate.toFixed(0) + '%';
        }

        // ================== TOAST NOTIFICATIONS ==================

        function showToast(message, type = 'info', duration = 3000) {
            const toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) return;

            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;

            const icons = {
                success: '✅',
                error: '❌',
                warning: '⚠️',
                info: 'ℹ️'
            };

            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || icons.info}</div>
                <div class="toast-message">${message}</div>
            `;

            toastContainer.appendChild(toast);

            // Animate in
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateY(0)';
            }, 10);

            // Remove after duration
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(20px)';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        function showSuccessToast(message) {
            showToast(message, 'success', 2500);
        }

        function showErrorToast(message) {
            showToast(message, 'error', 4000);
        }

        function showWarningToast(message) {
            showToast(message, 'warning', 3500);
        }

        function showInfoToast(message) {
            showToast(message, 'info', 3000);
        }

        // ================== VIEW MODE & RESPONSIVE ==================

        // Set view mode (table or cards)
        function setViewMode(mode) {
            currentViewMode = mode;

            const tableBtn = document.getElementById('viewTableBtn');
            const cardsBtn = document.getElementById('viewCardsBtn');

            if (mode === 'table') {
                tableBtn?.classList.add('active');
                cardsBtn?.classList.remove('active');
                document.body.classList.remove('view-cards');
            } else {
                cardsBtn?.classList.add('active');
                tableBtn?.classList.remove('active');
                document.body.classList.add('view-cards');
            }

            renderKundenView();
        }

        // Detect responsive breakpoint
        function isMobileView() {
            return window.innerWidth <= 768;
        }

        // Update view mode on resize
        window.addEventListener('resize', debounce(() => {
            renderKundenView();
        }, 250));

        // Debounce utility
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ================== MOBILE CARD RENDERING ==================

        // Hauptfunktion: Entscheidet zwischen Tabelle und Cards
        function renderKundenView() {
            const mobile = isMobileView();
            const viewMode = mobile ? 'cards' : currentViewMode;

            if (viewMode === 'cards') {
                renderKundenCards();
            } else {
                renderKundenTable();
            }
        }

        // Rendere Kunden als Cards (Mobile)
        function renderKundenCards() {
            const container = document.getElementById('kundenCardsContainer');
            const tableContainer = document.querySelector('.kunden-table');
            const emptyState = document.getElementById('emptyState');

            if (!container) return;

            // ✅ Filter Kunden with pagination
            let filteredKunden = getFilteredKunden(true);

            if (totalFilteredKunden === 0) {
                container.innerHTML = '';
                if (tableContainer) tableContainer.style.display = 'none';
                if (emptyState) emptyState.style.display = 'block';
                updatePaginationControls(); // Update even when empty
                return;
            }

            if (emptyState) emptyState.style.display = 'none';
            if (tableContainer) tableContainer.style.display = 'none';

            container.innerHTML = filteredKunden.map(kunde => {
                const umsatz = calculateKundenUmsatz(kunde.id, currentUmsatzFilter);
                const besuchsAnzahl = kunde.besuchsAnzahl || 0;
                const status = besuchsAnzahl >= 2 ? '💚 Stammkunde' : '✨ Neukunde';
                const statusClass = besuchsAnzahl >= 2 ? 'green' : 'blue';

                return `
                    <div class="kunde-card">
                        <div class="kunde-card-header">
                            <h3>${kunde.name || 'Unbekannt'}</h3>
                            <span class="kunde-badge kunde-badge-${statusClass}">${status}</span>
                        </div>

                        <div class="kunde-card-body">
                            <div class="kunde-info-row">
                                <span class="info-label">📞 Telefon:</span>
                                <span class="info-value">${kunde.telefon || 'Nicht angegeben'}</span>
                            </div>
                            <div class="kunde-info-row">
                                <span class="info-label">📧 Email:</span>
                                <span class="info-value">${kunde.email || 'Nicht angegeben'}</span>
                            </div>
                            <div class="kunde-info-row">
                                <span class="info-label">🚗 Besuche:</span>
                                <span class="info-value"><strong>${besuchsAnzahl}</strong></span>
                            </div>
                            <div class="kunde-info-row">
                                <span class="info-label">💰 Umsatz:</span>
                                <span class="info-value"><strong>${umsatz.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} €</strong></span>
                            </div>
                            <div class="kunde-info-row">
                                <span class="info-label">🏷️ Tags:</span>
                                <div style="flex: 1;">${renderTagChips(kunde.tags)}</div>
                            </div>
                        </div>

                        <div class="kunde-card-footer">
                            <button class="btn btn-sm btn-primary" onclick="openKundenDetail('${kunde.id}')" style="flex: 1;">
                                👁️ Details
                            </button>
                            <button class="btn btn-sm" onclick="deleteKunde('${kunde.id}')" style="background: #dc3545; color: white;">
                                🗑️
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            // ✅ Update pagination controls after rendering
            updatePaginationControls();
        }

        // Get filtered customers (search + tags)
        function getFilteredKunden(withPagination = false) {
            let filtered = [...allKunden];

            // Tag filter
            if (activeTagFilters.size > 0) {
                filtered = filtered.filter(kunde => {
                    if (!kunde.tags || kunde.tags.length === 0) return false;
                    return Array.from(activeTagFilters).some(tagId => kunde.tags.includes(tagId));
                });
            }

            // Search filter
            const searchTerm = document.getElementById('searchInput')?.value?.toLowerCase() || '';
            if (searchTerm) {
                filtered = filtered.filter(kunde => {
                    return kunde.name?.toLowerCase().includes(searchTerm) ||
                           kunde.telefon?.toLowerCase().includes(searchTerm) ||
                           kunde.email?.toLowerCase().includes(searchTerm);
                });
            }

            // ✅ Advanced Filters: Umsatz Range
            if (advancedFilters.umsatzMin !== null || advancedFilters.umsatzMax !== null) {
                filtered = filtered.filter(kunde => {
                    const umsatz = calculateKundenUmsatz(kunde.id, currentUmsatzFilter);
                    if (advancedFilters.umsatzMin !== null && umsatz < advancedFilters.umsatzMin) return false;
                    if (advancedFilters.umsatzMax !== null && umsatz > advancedFilters.umsatzMax) return false;
                    return true;
                });
            }

            // ✅ Advanced Filters: Date Range
            if (advancedFilters.dateFrom || advancedFilters.dateTo) {
                filtered = filtered.filter(kunde => {
                    if (!kunde.letzterBesuch) return false;
                    const besuchDate = new Date(kunde.letzterBesuch);

                    if (advancedFilters.dateFrom) {
                        const fromDate = new Date(advancedFilters.dateFrom);
                        if (besuchDate < fromDate) return false;
                    }

                    if (advancedFilters.dateTo) {
                        const toDate = new Date(advancedFilters.dateTo);
                        toDate.setHours(23, 59, 59, 999); // End of day
                        if (besuchDate > toDate) return false;
                    }

                    return true;
                });
            }

            // ✅ Update total count for pagination
            totalFilteredKunden = filtered.length;

            // ✅ Apply sorting
            filtered = sortKunden(filtered);

            // ✅ Apply pagination
            if (withPagination) {
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                filtered = filtered.slice(startIndex, endIndex);
            }

            return filtered;
        }

        // Firebase Initialisierung
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                if (typeof initFirebase !== 'undefined') {
                    // ✅ BUG FIX: Prüfe window.firebaseInitialized
                    await initFirebase();
                    if (window.firebaseInitialized && window.firebaseApp) {
                        firebaseApp = window.firebaseApp;
                        firebaseInitialized = true;
                        console.log('✅ Firebase für Kunden initialisiert');
                    }
                }
            } catch (error) {
                console.warn('⚠️ Firebase nicht verfügbar, verwende LocalStorage:', error);
            }

            // ✅ FIX: Parallel laden statt sequenziell für bessere Performance
            try {
                await Promise.all([
                    loadKunden(),
                    loadFahrzeuge()
                ]);

                // Jetzt sind BEIDE vollständig geladen - Stats aktualisieren
                console.log('✅ Kunden und Fahrzeuge vollständig geladen');
                updateStats();

                // ✅ Auto-assign Tags für alle Kunden
                allKunden.forEach(kunde => {
                    autoAssignTags(kunde);
                });

                // ✅ NEW: Use responsive view rendering (table or cards based on screen size)
                renderKundenView();
                console.log('✅ Ansicht gerendert mit korrekten Werten (responsive)');

                // ✅ Render Charts & Analytics
                renderCharts();
                console.log('✅ Charts gerendert');
            } catch (error) {
                console.error('❌ Fehler beim Laden der Daten:', error);
                // Fallback: Stats trotzdem aktualisieren (mit leeren Daten)
                updateStats();
                renderKundenView();
                renderCharts();
            }
        });

        // Kunden laden (Firebase + LocalStorage zusammenführen)
        async function loadKunden() {
            try {
                let firebaseKunden = [];
                let localKunden = [];

                // Firebase laden
                if (firebaseInitialized && firebaseApp) {
                    try {
                        firebaseKunden = await firebaseApp.getAllKunden();
                        console.log(`📦 ${firebaseKunden.length} Kunden aus Firebase geladen`);
                    } catch (error) {
                        console.warn('⚠️ Firebase Kunden konnten nicht geladen werden:', error);
                    }
                }

                // LocalStorage laden
                try {
                    localKunden = JSON.parse(localStorage.getItem('kunden') || '[]');
                    console.log(`💾 ${localKunden.length} Kunden aus LocalStorage geladen`);
                } catch (error) {
                    console.warn('⚠️ LocalStorage Kunden konnten nicht geladen werden:', error);
                    localKunden = [];
                }

                // Zusammenführen: Firebase hat Vorrang, keine Duplikate
                const firebaseIds = new Set(firebaseKunden.map(k => k.id));
                const uniqueLocalKunden = localKunden.filter(k => !firebaseIds.has(k.id));

                allKunden = [...firebaseKunden, ...uniqueLocalKunden];

                console.log(`✅ ${allKunden.length} Kunden gesamt (${firebaseKunden.length} Firebase + ${uniqueLocalKunden.length} nur LocalStorage)`);
                // ✅ FIX: renderKundenTable() NICHT hier aufrufen - erst nach loadFahrzeuge()!
            } catch (error) {
                console.error('❌ Fehler beim Laden der Kunden:', error);
                allKunden = [];
            }
        }

        // Fahrzeuge laden
        async function loadFahrzeuge() {
            try {
                if (firebaseInitialized && firebaseApp) {
                    allFahrzeuge = await firebaseApp.getAllFahrzeuge();
                } else {
                    allFahrzeuge = JSON.parse(localStorage.getItem('fahrzeuge') || '[]');
                }

                console.log(`✅ ${allFahrzeuge.length} Fahrzeuge geladen`);
            } catch (error) {
                console.error('❌ Fehler beim Laden der Fahrzeuge:', error);
                allFahrzeuge = [];
            }
        }

        // Statistiken aktualisieren
        function updateStats() {
            const total = allKunden.length;
            const stammkunden = allKunden.filter(k => k.anzahlBesuche >= 2).length;
            const neukunden = allKunden.filter(k => k.anzahlBesuche === 1).length;

            document.getElementById('totalKunden').textContent = total;
            document.getElementById('stammkunden').textContent = stammkunden;
            document.getElementById('neukunden').textContent = neukunden;

            // Umsatz aktualisieren
            updateUmsatzStats();
        }

        // Umsatz-Filter setzen
        function setUmsatzFilter(filter) {
            currentUmsatzFilter = filter;

            // Filter-Buttons aktualisieren
            document.querySelectorAll('.umsatz-filter .filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Label aktualisieren
            const labels = {
                'gesamt': 'Gesamtumsatz',
                'jahr': 'Umsatz ' + new Date().getFullYear(),
                'monat': 'Umsatz ' + new Date().toLocaleDateString('de-DE', { month: 'long', year: 'numeric' })
            };
            document.getElementById('umsatzLabel').textContent = labels[filter];

            // Stats und Tabelle aktualisieren
            updateUmsatzStats();
            renderKundenTable();
        }

        // Umsatz-Statistik aktualisieren
        function updateUmsatzStats() {
            const gesamtumsatz = calculateGesamtumsatz(currentUmsatzFilter);
            document.getElementById('totalUmsatz').textContent = gesamtumsatz.toFixed(2) + ' €';
            console.log(`📊 Umsatz aktualisiert (${currentUmsatzFilter}):`, gesamtumsatz.toFixed(2) + ' €', `(basierend auf ${allFahrzeuge.length} Fahrzeugen)`);
        }

        // Gesamtumsatz berechnen
        function calculateGesamtumsatz(filter) {
            // ✅ FIX: Validierung dass Daten geladen sind
            if (!allKunden || allKunden.length === 0) {
                console.log('⚠️ Keine Kunden geladen - Umsatz = 0');
                return 0;
            }
            if (!allFahrzeuge || allFahrzeuge.length === 0) {
                console.log('⚠️ Keine Fahrzeuge geladen - Umsatz = 0');
                return 0;
            }

            let sum = 0;
            for (const kunde of allKunden) {
                sum += calculateKundenUmsatz(kunde.id, filter);
            }
            return sum;
        }

        // Umsatz pro Kunde berechnen
        function calculateKundenUmsatz(kundeId, filter) {
            // Fahrzeuge des Kunden finden
            const kundenFahrzeuge = allFahrzeuge.filter(f =>
                f.kundenId === kundeId ||
                (f.kundenname && allKunden.find(k => k.id === kundeId && k.name === f.kundenname))
            );

            // Nach Zeitraum filtern
            const heute = new Date();
            const filteredFahrzeuge = kundenFahrzeuge.filter(f => {
                if (!f.datum) return true; // Kein Datum = inkludieren

                // Datum parsen (Format: "DD.MM.YYYY")
                const [tag, monat, jahr] = f.datum.split('.');
                const fahrzeugDatum = new Date(parseInt(jahr), parseInt(monat) - 1, parseInt(tag));

                if (filter === 'gesamt') {
                    return true;
                } else if (filter === 'jahr') {
                    return fahrzeugDatum.getFullYear() === heute.getFullYear();
                } else if (filter === 'monat') {
                    return fahrzeugDatum.getFullYear() === heute.getFullYear() &&
                           fahrzeugDatum.getMonth() === heute.getMonth();
                }
                return true;
            });

            // Preise summieren - unterstützt vereinbarterPreis UND KVA-Varianten (Partner Portal)
            let sum = 0;
            for (const fahrzeug of filteredFahrzeuge) {
                let preis = 0;

                // Preis-Ermittlung mit Validierung (0-Check!)
                if (fahrzeug.vereinbarterPreis && fahrzeug.vereinbarterPreis > 0) {
                    preis = parseFloat(fahrzeug.vereinbarterPreis);
                } else if (fahrzeug.kva?.varianten && fahrzeug.kva.gewaehlteVariante) {
                    preis = parseFloat(fahrzeug.kva.varianten[fahrzeug.kva.gewaehlteVariante]?.gesamt) || 0;
                } else if (fahrzeug.kva?.varianten?.original) {
                    preis = parseFloat(fahrzeug.kva.varianten.original.gesamt) || 0;
                } else if (fahrzeug.kva?.gesamt) {
                    preis = parseFloat(fahrzeug.kva.gesamt) || 0;
                }

                if (preis > 0) {
                    sum += preis;
                }
            }

            return sum;
        }

        // Kunden-Tabelle rendern
        function renderKundenTable(filterText = '') {
            const tbody = document.getElementById('kundenTableBody');
            const tableContainer = document.querySelector('.kunden-table');
            const cardsContainer = document.getElementById('kundenCardsContainer');
            const emptyState = document.getElementById('emptyState');

            // ✅ Use unified filtering with pagination
            let filteredKunden = getFilteredKunden(true);

            if (totalFilteredKunden === 0) {
                tbody.innerHTML = '';
                if (tableContainer) tableContainer.style.display = 'none';
                if (cardsContainer) cardsContainer.innerHTML = '';
                emptyState.style.display = 'block';
                updatePaginationControls(); // Update even when empty
                return;
            }

            emptyState.style.display = 'none';
            if (tableContainer) tableContainer.style.display = 'table';
            if (cardsContainer) cardsContainer.innerHTML = '';

            // ✅ Sorting is now handled in getFilteredKunden()

            tbody.innerHTML = filteredKunden.map(kunde => {
                const kontakt = [];
                if (kunde.telefon) kontakt.push(`📞 ${kunde.telefon}`);
                if (kunde.email) kontakt.push(`📧 ${kunde.email}`);
                const kontaktText = kontakt.length > 0 ? kontakt.join('<br>') : '<span style="color: #999;">-</span>';

                const besuche = kunde.anzahlBesuche || 0;
                const umsatz = calculateKundenUmsatz(kunde.id, currentUmsatzFilter);
                const letzterBesuch = kunde.letzterBesuch
                    ? new Date(kunde.letzterBesuch).toLocaleDateString('de-DE')
                    : '<span style="color: #999;">-</span>';

                const statusBadge = besuche >= 2
                    ? '<span class="badge badge-success">⭐ Stammkunde</span>'
                    : '<span class="badge badge-info">🆕 Neukunde</span>';

                // ✅ Add tags column
                const tagsHtml = renderTagChips(kunde.tags);

                return `
                    <tr>
                        <td data-label="Name"><strong>${kunde.name}</strong></td>
                        <td data-label="Kontakt">${kontaktText}</td>
                        <td data-label="Besuche"><strong>${besuche}</strong></td>
                        <td data-label="Umsatz"><strong style="color: #ff9800;">${umsatz.toFixed(2)} €</strong></td>
                        <td data-label="Letzter Besuch">${letzterBesuch}</td>
                        <td data-label="Status">${statusBadge}</td>
                        <td data-label="Tags">${tagsHtml}</td>
                        <td>
                            <div class="action-btns">
                                <button class="btn btn-info btn-small btn-kunde-detail" data-kunde-id="${kunde.id}">
                                    👁️ Details
                                </button>
                                <button class="btn btn-warning btn-small btn-kunde-edit" data-kunde-id="${kunde.id}">
                                    ✏️ Bearbeiten
                                </button>
                                <button class="btn btn-small btn-kunde-delete" data-kunde-id="${kunde.id}" style="background: #dc3545; color: white;">
                                    🗑️ Löschen
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            // ✅ Update pagination controls after rendering
            updatePaginationControls();
        }

        // Event Delegation für Kunden-Buttons
        document.addEventListener('click', function(e) {
            // Finde nächsten Button (auch wenn auf Text/Emoji geklickt wurde)
            const button = e.target.closest('button');
            if (!button) return;

            const kundeId = button.dataset.kundeId;
            if (!kundeId) return;

            if (button.classList.contains('btn-kunde-detail')) {
                e.preventDefault();
                console.log('🔍 Detail-Button geklickt für Kunde:', kundeId);
                openKundenDetail(kundeId);
            } else if (button.classList.contains('btn-kunde-edit')) {
                e.preventDefault();
                console.log('✏️ Bearbeiten-Button geklickt für Kunde:', kundeId);
                editKunde(kundeId);
            } else if (button.classList.contains('btn-kunde-delete')) {
                e.preventDefault();
                console.log('🗑️ Löschen-Button geklickt für Kunde:', kundeId);
                deleteKunde(kundeId);
            }
        });

        // Filter Kunden
        function filterKunden() {
            // ✅ Use unified rendering (supports responsive view switching)
            renderKundenView();
        }

        // Neuer Kunde Modal öffnen
        function openNeuerKundeModal() {
            document.getElementById('neuerKundeModal').classList.add('active');
            document.getElementById('neuerKundeForm').reset();
            currentKundeId = null;
        }

        // Neuer Kunde Modal schließen
        function closeNeuerKundeModal() {
            document.getElementById('neuerKundeModal').classList.remove('active');
            document.getElementById('neuerKundeForm').reset();
            currentKundeId = null;

            // ✅ Rabatt-Konditionen Felder zurücksetzen (inkl. Bonus-Felder)
            document.getElementById('rabattStufe1Prozent').value = '';
            document.getElementById('rabattStufe1Ab').value = '';
            document.getElementById('rabattStufe1Bonus').value = '';
            document.getElementById('rabattStufe2Prozent').value = '';
            document.getElementById('rabattStufe2Ab').value = '';
            document.getElementById('rabattStufe2Bonus').value = '';
            document.getElementById('rabattStufe3Prozent').value = '';
            document.getElementById('rabattStufe3Ab').value = '';
            document.getElementById('rabattStufe3Bonus').value = '';
            document.getElementById('konditionenGeprueft').checked = false;
            document.getElementById('konditionenDatum').value = '';
            document.getElementById('konditionenDatum').disabled = true;
        }

        // Neuer Kunde Form Submit
        document.getElementById('neuerKundeForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // ✅ Collect selected tags from checkboxes
            const selectedTags = [];
            ['vip', 'stammkunde', 'neukunde', 'flotte', 'gewerbe', 'privat'].forEach(tagId => {
                const checkbox = document.getElementById(`tag${tagId.charAt(0).toUpperCase() + tagId.slice(1)}`);
                if (checkbox && checkbox.checked) {
                    selectedTags.push(tagId);
                }
            });

            // ✅ Rabatt-Konditionen sammeln (inkl. Bonus-Felder)
            const rabattKonditionen = {};
            const stufe1Prozent = parseFloat(document.getElementById('rabattStufe1Prozent').value);
            const stufe1Ab = parseFloat(document.getElementById('rabattStufe1Ab').value);
            const stufe1Bonus = parseFloat(document.getElementById('rabattStufe1Bonus').value);
            const stufe2Prozent = parseFloat(document.getElementById('rabattStufe2Prozent').value);
            const stufe2Ab = parseFloat(document.getElementById('rabattStufe2Ab').value);
            const stufe2Bonus = parseFloat(document.getElementById('rabattStufe2Bonus').value);
            const stufe3Prozent = parseFloat(document.getElementById('rabattStufe3Prozent').value);
            const stufe3Ab = parseFloat(document.getElementById('rabattStufe3Ab').value);
            const stufe3Bonus = parseFloat(document.getElementById('rabattStufe3Bonus').value);

            if (!isNaN(stufe1Prozent) && !isNaN(stufe1Ab) && stufe1Ab > 0) {
                rabattKonditionen.stufe1 = {
                    rabatt: stufe1Prozent,
                    ab: stufe1Ab,
                    einmalBonus: !isNaN(stufe1Bonus) ? stufe1Bonus : 0,
                    bonusErhalten: false  // Phase 2: Tracking ob Bonus schon ausgezahlt
                };
            }
            if (!isNaN(stufe2Prozent) && !isNaN(stufe2Ab) && stufe2Ab > 0) {
                rabattKonditionen.stufe2 = {
                    rabatt: stufe2Prozent,
                    ab: stufe2Ab,
                    einmalBonus: !isNaN(stufe2Bonus) ? stufe2Bonus : 0,
                    bonusErhalten: false
                };
            }
            if (!isNaN(stufe3Prozent) && !isNaN(stufe3Ab) && stufe3Ab > 0) {
                rabattKonditionen.stufe3 = {
                    rabatt: stufe3Prozent,
                    ab: stufe3Ab,
                    einmalBonus: !isNaN(stufe3Bonus) ? stufe3Bonus : 0,
                    bonusErhalten: false
                };
            }

            const konditionenGeprueft = document.getElementById('konditionenGeprueft').checked;
            const konditionenDatum = document.getElementById('konditionenDatum').value;

            // ✅ AUTO-GENERATE Partner-Code aus Email (wenn nicht manuell eingegeben)
            const partnerCodeInput = document.getElementById('partnerCode').value.trim();
            let kundenEmail = document.getElementById('kundenEmail').value.trim();
            const kundenName = document.getElementById('kundenName').value.trim();

            // ✅ FALLBACK: Wenn Email-Feld leer, aber Name enthält @ → Verwende Name als Email
            // Häufiger Fall: User trägt "marcel@test.de" ins Name-Feld ein statt ins Email-Feld
            if (!kundenEmail && kundenName && kundenName.includes('@')) {
                kundenEmail = kundenName;
                console.log(`📧 Verwende Name als Email (Email-Feld leer): "${kundenEmail}"`);
            }

            let partnerCode = partnerCodeInput;

            // Wenn kein Partner-Code eingegeben, aber Email vorhanden → Auto-generiere aus Email
            // Beispiel: "marcel@test.de" → "marcel"
            // → Konsistent mit Partner Portal Login (index.html:389 verwendet email.split('@')[0])
            if (!partnerCode && kundenEmail && kundenEmail.includes('@')) {
                partnerCode = kundenEmail.split('@')[0].toLowerCase();
                console.log(`🤖 Auto-generierter Partner-Code aus Email: "${kundenEmail}" → "${partnerCode}"`);
            }

            // Fallback: Bei Edit existierenden Partner-Code übernehmen (falls Email geändert wurde)
            if (!partnerCode && currentKundeId) {
                partnerCode = allKunden.find(k => k.id === currentKundeId)?.partnerCode || null;
                if (partnerCode) {
                    console.log(`♻️ Verwende existierenden Partner-Code: "${partnerCode}"`);
                }
            }

            const kundeData = {
                id: currentKundeId || 'kunde_' + Date.now(),
                name: document.getElementById('kundenName').value.trim(),
                telefon: document.getElementById('kundenTelefon').value.trim(),
                email: document.getElementById('kundenEmail').value.trim(),
                notizen: document.getElementById('kundenNotizen').value.trim(),
                tags: selectedTags, // ✅ Add tags
                partnerCode: partnerCode || null, // ✅ Partner-Code für B2B-Kunden
                // ✅ Rabatt-Konditionen (NEU)
                rabattKonditionen: Object.keys(rabattKonditionen).length > 0 ? rabattKonditionen : null,
                konditionenGeprueft: konditionenGeprueft,
                konditionenDatum: konditionenDatum || null,
                // ✅ FIX: Nur bei neuem Kunden hinzufügen (verhindert undefined in Firebase)
                ...(!currentKundeId ? {
                    erstbesuch: new Date().toISOString(),
                    anzahlBesuche: 0,
                    letzterBesuch: null
                } : {})
            };

            try {
                if (currentKundeId) {
                    // Update
                    if (firebaseInitialized && firebaseApp) {
                        await firebaseApp.updateKunde(currentKundeId, kundeData);
                    } else {
                        const index = allKunden.findIndex(k => k.id === currentKundeId);
                        if (index !== -1) {
                            allKunden[index] = { ...allKunden[index], ...kundeData };
                            localStorage.setItem('kunden', JSON.stringify(allKunden));
                        }
                    }
                    console.log('✅ Kunde aktualisiert:', kundeData.name);
                    showSuccessToast(`Kunde "${kundeData.name}" aktualisiert!`);
                } else {
                    // Neu erstellen
                    if (firebaseInitialized && firebaseApp) {
                        await firebaseApp.saveKunde(kundeData);
                    } else {
                        allKunden.push(kundeData);
                        localStorage.setItem('kunden', JSON.stringify(allKunden));
                    }
                    console.log('✅ Neuer Kunde erstellt:', kundeData.name);
                    showSuccessToast(`Neuer Kunde "${kundeData.name}" erstellt!`);
                }

                // ✅ DEBUG: SYNC Check vor Ausführung
                console.log('🔍 SYNC-Check:', {
                    partnerCode: partnerCode,
                    dbVerfuegbar: !!db,
                    windowDbVerfuegbar: !!window.db,
                    rabattKonditionenVorhanden: !!kundeData.rabattKonditionen,
                    syncWirdAusgefuehrt: !!(partnerCode && db)
                });

                // ✅ SYNC zu Partner Collection (wenn Partner-Code vorhanden)
                // 🐛 BUG #14 DEBUG: Erweiterte Logs für Partner-Sync
                console.log('\n🔍 ========== PARTNER-SYNC DEBUG ==========');
                console.log('   partnerCode:', partnerCode || 'FEHLT! ❌');
                console.log('   db vorhanden:', !!db);
                console.log('   Sync wird ausgeführt:', !!(partnerCode && db));
                console.log('   Kunde-Email:', kundeData.email);
                console.log('   rabattKonditionen:', kundeData.rabattKonditionen ? 'JA ✅' : 'NEIN ❌');
                console.log('   konditionenGeprueft:', kundeData.konditionenGeprueft ? 'JA ✅' : 'NEIN ❌');

                if (partnerCode && db) {
                    try {
                        console.log(`🔄 Synce Rabatt-Konditionen zu Partner "${partnerCode}"...`);
                        const partnerRef = db.collection('partner').doc(partnerCode);

                        const syncData = {
                            name: kundeData.name,  // ✅ Partner-Name für Anzeige
                            email: kundeData.email,  // ✅ Email für Kommunikation
                            rabattKonditionen: kundeData.rabattKonditionen,
                            konditionenGeprueft: kundeData.konditionenGeprueft,
                            konditionenDatum: kundeData.konditionenDatum,
                            lastSync: new Date().toISOString()  // ✅ Sync-Timestamp
                        };

                        await partnerRef.set(syncData, { merge: true });
                        console.log(`✅ Rabatt-Konditionen zu Partner "${partnerCode}" synchronisiert!`);
                        console.log('   📊 Daten:', syncData);
                        console.log('   📊 Partner-Dokument ID:', partnerCode);
                    } catch (syncError) {
                        console.warn('⚠️ Fehler beim Sync zu Partner Collection:', syncError);
                        // Nicht kritisch - Kunde wurde bereits gespeichert
                    }
                } else {
                    console.warn('⚠️ Partner-Sync ÜBERSPRUNGEN!');
                    if (!partnerCode) console.warn('   Grund: partnerCode fehlt! ❌');
                    if (!db) console.warn('   Grund: Firebase DB nicht verfügbar! ❌');
                    console.warn('   ⚠️ ACHTUNG: Rabatt-Konditionen werden NICHT zu Partner Collection synchronisiert!');
                    console.warn('   ⚠️ RESULTAT: meine-anfragen.html wird KEINE Rabatte anzeigen! 🐛');
                }
                console.log('========== PARTNER-SYNC DEBUG ENDE ==========\n');

                closeNeuerKundeModal();
                await loadKunden();
                updateStats();
                renderKundenView(); // ✅ Use new rendering
            } catch (error) {
                console.error('❌ Fehler beim Speichern:', error);
                showErrorToast('Fehler beim Speichern des Kunden!');
            }
        });

        // Kunde bearbeiten
        function editKunde(kundeId) {
            const kunde = allKunden.find(k => k.id === kundeId);
            if (!kunde) return;

            currentKundeId = kundeId;
            document.getElementById('kundenName').value = kunde.name || '';
            document.getElementById('kundenTelefon').value = kunde.telefon || '';
            document.getElementById('kundenEmail').value = kunde.email || '';
            document.getElementById('kundenNotizen').value = kunde.notizen || '';
            document.getElementById('partnerCode').value = kunde.partnerCode || '';

            // ✅ Set tag checkboxes based on kunde.tags
            ['vip', 'stammkunde', 'neukunde', 'flotte', 'gewerbe', 'privat'].forEach(tagId => {
                const checkbox = document.getElementById(`tag${tagId.charAt(0).toUpperCase() + tagId.slice(1)}`);
                if (checkbox) {
                    checkbox.checked = kunde.tags && kunde.tags.includes(tagId);
                }
            });

            // ✅ Rabatt-Konditionen laden (inkl. Bonus-Felder)
            if (kunde.rabattKonditionen) {
                const stufe1 = kunde.rabattKonditionen.stufe1;
                const stufe2 = kunde.rabattKonditionen.stufe2;
                const stufe3 = kunde.rabattKonditionen.stufe3;

                document.getElementById('rabattStufe1Prozent').value = stufe1 ? stufe1.rabatt : '';
                document.getElementById('rabattStufe1Ab').value = stufe1 ? stufe1.ab : '';
                document.getElementById('rabattStufe1Bonus').value = stufe1 ? stufe1.einmalBonus : '';
                document.getElementById('rabattStufe2Prozent').value = stufe2 ? stufe2.rabatt : '';
                document.getElementById('rabattStufe2Ab').value = stufe2 ? stufe2.ab : '';
                document.getElementById('rabattStufe2Bonus').value = stufe2 ? stufe2.einmalBonus : '';
                document.getElementById('rabattStufe3Prozent').value = stufe3 ? stufe3.rabatt : '';
                document.getElementById('rabattStufe3Ab').value = stufe3 ? stufe3.ab : '';
                document.getElementById('rabattStufe3Bonus').value = stufe3 ? stufe3.einmalBonus : '';
            } else {
                // Felder leeren wenn keine Konditionen
                document.getElementById('rabattStufe1Prozent').value = '';
                document.getElementById('rabattStufe1Ab').value = '';
                document.getElementById('rabattStufe1Bonus').value = '';
                document.getElementById('rabattStufe2Prozent').value = '';
                document.getElementById('rabattStufe2Ab').value = '';
                document.getElementById('rabattStufe2Bonus').value = '';
                document.getElementById('rabattStufe3Prozent').value = '';
                document.getElementById('rabattStufe3Ab').value = '';
                document.getElementById('rabattStufe3Bonus').value = '';
            }

            // Konditionen-Checkbox und Datum
            const konditionenGeprueft = kunde.konditionenGeprueft || false;
            document.getElementById('konditionenGeprueft').checked = konditionenGeprueft;
            document.getElementById('konditionenDatum').value = kunde.konditionenDatum || '';
            document.getElementById('konditionenDatum').disabled = !konditionenGeprueft;

            document.getElementById('neuerKundeModal').classList.add('active');
        }

        // Kunde löschen
        async function deleteKunde(kundeId) {
            const kunde = allKunden.find(k => k.id === kundeId);
            if (!kunde) return;

            // Prüfe ob Fahrzeuge für diesen Kunden existieren
            let kundenFahrzeuge = [];
            try {
                if (firebaseInitialized && firebaseApp) {
                    const allFahrzeuge = await firebaseApp.getAllFahrzeuge();
                    kundenFahrzeuge = allFahrzeuge.filter(f => f.kundenId === kundeId || f.kundenname === kunde.name);
                } else {
                    const fahrzeuge = JSON.parse(localStorage.getItem('fahrzeuge') || '[]');
                    kundenFahrzeuge = fahrzeuge.filter(f => f.kundenId === kundeId || f.kundenname === kunde.name);
                }
            } catch (error) {
                console.error('❌ Fehler beim Prüfen der Fahrzeuge:', error);
            }

            // Warnung wenn Fahrzeuge existieren
            let confirmMsg = `Kunde "${kunde.name}" wirklich löschen?`;
            if (kundenFahrzeuge.length > 0) {
                confirmMsg = `⚠️ ACHTUNG: Kunde "${kunde.name}" hat ${kundenFahrzeuge.length} Fahrzeug(e)!\n\n` +
                             `Fahrzeuge werden NICHT gelöscht, verlieren aber die Kundenverknüpfung.\n\n` +
                             `Trotzdem löschen?`;
            }

            if (!confirm(confirmMsg)) return;

            try {
                if (firebaseInitialized && firebaseApp) {
                    await firebaseApp.deleteKunde(kundeId);
                    console.log('✅ Kunde aus Firestore gelöscht:', kundeId);
                } else {
                    const index = allKunden.findIndex(k => k.id === kundeId);
                    if (index !== -1) {
                        allKunden.splice(index, 1);
                        localStorage.setItem('kunden', JSON.stringify(allKunden));
                    }
                    console.log('✅ Kunde aus LocalStorage gelöscht:', kundeId);
                }

                await loadKunden();
                updateStats();
                alert('✅ Kunde erfolgreich gelöscht!');
            } catch (error) {
                console.error('❌ Fehler beim Löschen:', error);
                alert('❌ Fehler beim Löschen des Kunden!');
            }
        }

        // Kunden-Detail Modal öffnen
        function openKundenDetail(kundeId) {
            const kunde = allKunden.find(k => k.id === kundeId);
            if (!kunde) return;

            document.getElementById('kundenDetailName').textContent = `👤 ${kunde.name}`;

            const kontakt = [];
            if (kunde.telefon) kontakt.push(`📞 ${kunde.telefon}`);
            if (kunde.email) kontakt.push(`📧 ${kunde.email}`);

            const detailContent = `
                <div class="form-group">
                    <label>Kontaktdaten:</label>
                    <p>${kontakt.length > 0 ? kontakt.join('<br>') : '<span style="color: #999;">Keine Kontaktdaten hinterlegt</span>'}</p>
                </div>
                ${kunde.notizen ? `
                <div class="form-group">
                    <label>Notizen:</label>
                    <p>${kunde.notizen}</p>
                </div>
                ` : ''}
                <div class="form-group">
                    <label>Statistik:</label>
                    <p>
                        <strong>Anzahl Besuche:</strong> ${kunde.anzahlBesuche || 0}<br>
                        <strong>Erster Besuch:</strong> ${kunde.erstbesuch ? new Date(kunde.erstbesuch).toLocaleDateString('de-DE') : '-'}<br>
                        <strong>Letzter Besuch:</strong> ${kunde.letzterBesuch ? new Date(kunde.letzterBesuch).toLocaleDateString('de-DE') : '-'}
                    </p>
                </div>
            `;

            document.getElementById('kundenDetailContent').innerHTML = detailContent;

            // Historie laden
            const kundenFahrzeuge = allFahrzeuge.filter(f => f.kundenId === kundeId || f.kundenname === kunde.name);

            const historieHTML = kundenFahrzeuge.length > 0
                ? kundenFahrzeuge.map(f => {
                    const datum = f.annahmeDatum || '-';
                    const status = f.status === 'abgeschlossen' ? '✅' : f.status === 'angenommen' ? '⏳' : '📋';

                    return `
                        <div class="historie-item">
                            <div class="historie-date">${status} ${datum}</div>
                            <div class="historie-details">
                                <strong>${f.kennzeichen}</strong> - ${f.marke} ${f.modell}<br>
                                ${f.notizen ? `<small style="color: #666;">${f.notizen}</small>` : ''}
                            </div>
                        </div>
                    `;
                }).join('')
                : '<p style="color: #999; text-align: center; padding: 20px;">Noch keine Aufträge für diesen Kunden</p>';

            document.getElementById('kundenHistorie').innerHTML = historieHTML;
            document.getElementById('kundenDetailModal').classList.add('active');
        }

        // Kunden-Detail Modal schließen
        function closeKundenDetailModal() {
            document.getElementById('kundenDetailModal').classList.remove('active');
        }

        // Kunden exportieren als CSV
        function exportKundenToCSV() {
            try {
                if (allKunden.length === 0) {
                    alert('⚠️ Keine Kunden zum Exportieren vorhanden!');
                    return;
                }

                // CSV Header
                const headers = [
                    'Kunden-ID', 'Name', 'Telefon', 'Email',
                    'Anzahl Besuche', 'Erster Besuch', 'Letzter Besuch', 'Notizen'
                ];

                // CSV Rows
                const rows = allKunden.map(k => [
                    k.id || '',
                    k.name || '',
                    k.telefon || '',
                    k.email || '',
                    k.anzahlBesuche || 0,
                    k.erstbesuch ? new Date(k.erstbesuch).toLocaleDateString('de-DE') : '',
                    k.letzterBesuch ? new Date(k.letzterBesuch).toLocaleDateString('de-DE') : '',
                    (k.notizen || '').replace(/"/g, '""') // Escape quotes
                ].map(field => `"${field}"`).join(','));

                // CSV zusammenbauen
                const csv = [
                    headers.map(h => `"${h}"`).join(','),
                    ...rows
                ].join('\n');

                // Download
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);

                const heute = new Date();
                const dateiname = `Kunden_${heute.toLocaleDateString('de-DE').replace(/\./g, '')}.csv`;

                link.setAttribute('href', url);
                link.setAttribute('download', dateiname);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                console.log(`✅ ${allKunden.length} Kunden exportiert: ${dateiname}`);
                alert(`✅ ${allKunden.length} Kunden erfolgreich exportiert!`);
            } catch (error) {
                console.error('❌ Fehler beim Export:', error);
                alert('❌ Fehler beim Exportieren der Kunden!');
            }
        }

        // Modal bei Klick außerhalb schließen
        window.onclick = function(event) {
            const neuerKundeModal = document.getElementById('neuerKundeModal');
            const detailModal = document.getElementById('kundenDetailModal');

            if (event.target === neuerKundeModal) {
                closeNeuerKundeModal();
            }
            if (event.target === detailModal) {
                closeKundenDetailModal();
            }
        }
    </script>

    <!-- Toast Container (for notifications) -->
    <div class="toast-container" id="toastContainer"></div>
</body>
</html>
