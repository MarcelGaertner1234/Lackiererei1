<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Fahrzeugannahme-App | Auto-Lackierzentrum Mosbach</title>

    <!-- Google Fonts - Inter (SF Pro Display Fallback) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Apple Liquid Glass Dark Mode Design System -->
    <link rel="stylesheet" href="design-system.css?v=af6b90f">
    <link rel="stylesheet" href="components.css?v=af6b90f">
    <link rel="stylesheet" href="animations.css?v=af6b90f">
    <link rel="stylesheet" href="mobile-first.css?v=af6b90f">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="firebase-config.js?v=002ceca"></script>
    <script src="js/auth-manager.js"></script>

    <!-- Global Chat Notifications -->
    <link rel="stylesheet" href="global-chat-notifications.css">
    <script src="global-chat-notifications.js"></script>

    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>

    <!-- GSAP Animation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

    <style>
        /* ============================================
           🌙 PREMIUM DARK GLASS DASHBOARD
           Apple Liquid Glass Dark Mode - UX Optimiert
           + Apple UX-Details: Blur-Overlays, Haptic, Parallax, Pulse+Shine
           ============================================ */

        body {
            /* THEME-AWARE: Light Mode = White, Dark Mode = Black */
            min-height: 100vh;
            padding: var(--space-6);
            padding-bottom: calc(80px + var(--space-6));
            font-family: 'SF Pro Display', 'Inter', var(--font-system);
            position: relative;
            overflow-x: hidden;
        }

        /* All content above atmosphere */
        .hero, .container, .bottom-nav {
            position: relative;
            z-index: 1;
        }

        /* ============================================
           🎨 APPLE UX FEATURE 1: ACCENT-LIGHT (Parallax-fähig)
           Moved from body::before to allow JS manipulation
           ============================================ */
        .accent-light {
            content: '';
            position: fixed;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            /* THEME-AWARE: Golden Glow (Light) / Cyan Glow (Dark) */
            background: radial-gradient(circle, var(--accent-light-color) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
            animation: pulse 8s ease-in-out infinite;
            /* GPU-Acceleration für smooth Parallax */
            transform: translate3d(0, 0, 0);
            will-change: transform;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 0.8; }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ============================================
           🎨 APPLE UX FEATURE 2: PAGE TRANSITION OVERLAY
           Blur-Overlay beim Seitenwechsel
           ============================================ */
        .page-transition-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: rgba(11, 11, 12, 0.4);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-out;
        }

        .page-transition-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        /* Hero Section - Dark Glass */
        .hero {
            max-width: 1200px;
            margin: 0 auto var(--space-12);
            text-align: center;
        }

        .hero__title {
            font-size: clamp(48px, 7vw, 72px);
            font-weight: 800;
            letter-spacing: -0.02em;
            line-height: 1;
            margin-bottom: var(--space-6);

            /* Gradient with Light Reflex */
            background: linear-gradient(135deg, #fff 0%, #00bfff 50%, #66d9ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero__subtitle {
            font-size: var(--font-size-lg);
            color: rgba(255,255,255,0.7);
            font-weight: var(--font-weight-regular);
            line-height: 1.6;
            max-width: 600px;
            margin: 0 auto var(--space-8);
        }

        .hero__version {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-5);

            /* Enhanced Glassmorphism */
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(25px) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(25px) saturate(var(--glass-saturation));
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-full);

            /* Doppelte Schatten */
            box-shadow:
                inset 0 1px 1px rgba(255,255,255,0.2),
                0 8px 32px rgba(0,0,0,0.35);

            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
            color: var(--color-primary);
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Welcome Banner */
        .welcome-banner {
            display: flex;
            align-items: center;
            gap: var(--space-6);
            padding: var(--space-8);
            margin-bottom: var(--space-12);
            background: linear-gradient(135deg, rgba(0, 191, 255, 0.15), rgba(255, 255, 255, 0.05));
            border: 1px solid rgba(0, 191, 255, 0.3);
            border-radius: var(--radius-xl);
            box-shadow:
                inset 0 1px 1px rgba(255,255,255,0.2),
                0 8px 32px rgba(0,0,0,0.35);
            position: relative;
            overflow: hidden;
        }

        .welcome-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 30%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.15), transparent);
            pointer-events: none;
        }

        .welcome-banner__icon {
            width: 64px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 191, 255, 0.2);
            border-radius: var(--radius-full);
            flex-shrink: 0;
        }

        .welcome-banner__icon i {
            width: 32px;
            height: 32px;
            color: var(--color-primary);
            filter: drop-shadow(0 2px 8px rgba(0,191,255,0.5));
        }

        .welcome-banner__content h2 {
            font-size: clamp(20px, 4vw, 28px);
            font-weight: var(--font-weight-bold);
            color: rgba(255,255,255,0.95);
            margin-bottom: var(--space-2);
        }

        .welcome-banner__content p {
            font-size: var(--font-size-sm);
            color: rgba(255,255,255,0.7);
            line-height: 1.6;
        }

        /* Section Title */
        .section-title {
            text-align: center;
            font-size: var(--font-size-4xl);
            font-weight: var(--font-weight-bold);
            color: rgba(255,255,255,0.95);
            margin-bottom: var(--space-12);
            letter-spacing: -0.01em;
        }

        /* Hero Cards Grid */
        .hero-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: var(--space-8);
            margin-bottom: var(--space-16);
        }

        /* ============================================
           🎨 APPLE UX FEATURE 3 & 4: HERO CARD (Pulse + Shine)
           ============================================ */
        .hero-card {
            padding: var(--space-10);
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(25px) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(25px) saturate(var(--glass-saturation));
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: var(--radius-2xl);
            box-shadow:
                inset 0 1px 1px rgba(255,255,255,0.2),
                0 8px 32px rgba(0,0,0,0.35);
            transition: all var(--duration-base) var(--ease-out);
            position: relative;
            overflow: hidden;
            opacity: 1;
            cursor: pointer;
            /* GPU-Acceleration */
            transform: translate3d(0, 0, 0);
        }

        /* Shine Overlay for Click Animation */
        .shine-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(255, 255, 255, 0.4) 50%,
                transparent 100%
            );
            transform: translateX(-100%);
            pointer-events: none;
            z-index: 10;
        }

        /* Shine Effect (Static top gradient) */
        .hero-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 40%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.15), transparent);
            border-radius: inherit;
            pointer-events: none;
            opacity: 0.3;
        }

        .hero-card:hover {
            transform: translateY(-4px);
            box-shadow:
                inset 0 1px 1px rgba(255,255,255,0.25),
                0 0 40px rgba(0,191,255,0.3),
                0 12px 40px rgba(0,0,0,0.45);
        }

        .hero-card--primary {
            background: linear-gradient(135deg, rgba(0, 191, 255, 0.18), rgba(255, 255, 255, 0.08));
            border-color: rgba(0, 191, 255, 0.3);
        }

        .hero-card__header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
            position: relative;
            z-index: 2;
        }

        .hero-card__header i {
            width: 32px;
            height: 32px;
            color: var(--color-primary);
            filter: drop-shadow(0 2px 4px rgba(0,191,255,0.3));
        }

        .hero-card__header h3 {
            flex: 1;
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
            color: rgba(255,255,255,0.95);
            letter-spacing: 0.3px;
        }

        .hero-card__desc {
            font-size: var(--font-size-sm);
            color: rgba(255,255,255,0.65);
            margin-bottom: var(--space-6);
            line-height: 1.6;
            position: relative;
            z-index: 2;
        }

        .hero-card__actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: var(--space-3);
            position: relative;
            z-index: 2;
        }

        /* Quick Link */
        .quick-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-4);
            min-height: 48px;
            min-width: 48px;
            background: rgba(0, 191, 255, 0.08);
            border: 1px solid rgba(0, 191, 255, 0.2);
            border-radius: var(--radius-lg);
            text-decoration: none;
            color: rgba(255,255,255,0.8);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
            transition: all var(--duration-base) var(--ease-out);
        }

        .quick-link:hover {
            background: rgba(0, 191, 255, 0.15);
            border-color: var(--color-primary);
            color: var(--color-primary);
            transform: scale(1.05);
        }

        .quick-link i {
            width: 20px;
            height: 20px;
        }

        /* Status Badge */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-1) var(--space-3);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
            white-space: nowrap;
        }

        .badge--count {
            background: rgba(0, 191, 255, 0.2);
            color: var(--color-primary);
            border-color: rgba(0, 191, 255, 0.4);
        }

        .badge--warning {
            background: rgba(255, 149, 0, 0.2);
            color: var(--color-warning);
            border-color: rgba(255, 149, 0, 0.4);
        }

        .badge--info {
            background: rgba(0, 113, 227, 0.2);
            color: var(--color-info);
            border-color: rgba(0, 113, 227, 0.4);
        }

        /* CTA Section */
        .cta-section {
            text-align: center;
            margin: var(--space-16) 0;
        }

        .btn-cta {
            display: inline-flex;
            align-items: center;
            gap: var(--space-4);
            padding: var(--space-6) var(--space-12);
            min-height: 56px;
            background: linear-gradient(135deg, #00bfff, #0099cc);
            color: white;
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            border: none;
            border-radius: var(--radius-full);
            box-shadow:
                0 8px 32px rgba(0, 191, 255, 0.4),
                0 4px 12px rgba(0,0,0,0.3);
            text-decoration: none;
            transition: all var(--duration-base) var(--ease-out);
            cursor: pointer;
        }

        .btn-cta:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow:
                0 12px 48px rgba(0, 191, 255, 0.5),
                0 8px 20px rgba(0,0,0,0.4);
        }

        .btn-cta:active {
            transform: translateY(-2px) scale(1.02);
        }

        .btn-cta i:first-child {
            width: 24px;
            height: 24px;
        }

        .btn-cta i:last-child {
            width: 20px;
            height: 20px;
        }

        /* Features Section */
        .features {
            max-width: 900px;
            margin: 0 auto var(--space-20);
            position: relative;

            /* Enhanced Glassmorphism */
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: var(--radius-2xl);
            padding: var(--space-10);

            /* Doppelte Schatten */
            box-shadow:
                inset 0 1px 1px rgba(255,255,255,0.2),
                0 8px 32px rgba(0,0,0,0.35);
            overflow: hidden;
        }

        /* Shine Effect */
        .features::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 30%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.15), transparent);
            pointer-events: none;
        }

        .features__title {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-semibold);
            color: rgba(255,255,255,0.95);
            margin-bottom: var(--space-6);
            letter-spacing: 0.3px;
        }

        .features__list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-4);
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .features__item {
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
            font-size: var(--font-size-base);
            color: rgba(255,255,255,0.7);
            line-height: var(--line-height-relaxed);
        }

        .features__item i {
            color: var(--color-primary);
            flex-shrink: 0;
            width: 20px;
            height: 20px;
            stroke-width: 2.5;
            filter: drop-shadow(0 0 8px rgba(0,191,255,0.4));
        }

        /* Premium Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: var(--z-fixed);

            /* Enhanced Glassmorphism */
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(32px) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(32px) saturate(var(--glass-saturation));
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.4);

            padding: var(--space-3) var(--space-4);
            display: flex;
            justify-content: center;
            gap: var(--space-2);
        }

        .bottom-nav__item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-2) var(--space-4);
            min-width: 60px;
            min-height: 48px;
            text-decoration: none;
            color: rgba(255,255,255,0.6);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
            border-radius: var(--radius-md);
            transition: all var(--duration-base) var(--ease-out);
            position: relative;
        }

        .bottom-nav__item i {
            width: 20px;
            height: 20px;
            stroke-width: 2;
        }

        .bottom-nav__item:hover {
            color: var(--color-primary);
            background: rgba(0, 191, 255, 0.1);
        }

        /* Active State with Top-Border Glow */
        .bottom-nav__item--active {
            color: var(--color-primary);
            background: rgba(0, 191, 255, 0.15);
        }

        .bottom-nav__item--active::before {
            content: '';
            position: absolute;
            top: -3px;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00bfff, transparent);
            box-shadow: 0 0 10px rgba(0,191,255,0.8);
        }

        /* Footer */
        .footer {
            max-width: 900px;
            margin: 0 auto;
            padding: var(--space-8) var(--space-4);
            text-align: center;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255,255,255,0.5);
            font-size: var(--font-size-sm);
        }

        .footer__link {
            color: var(--color-primary);
            text-decoration: none;
            font-weight: var(--font-weight-semibold);
            transition: all var(--duration-base) var(--ease-out);
        }

        .footer__link:hover {
            color: var(--color-primary-hover);
            transform: scale(1.05);
            text-shadow: 0 0 10px rgba(0,191,255,0.5);
        }

        .footer__company {
            margin-top: var(--space-3);
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            body {
                padding: var(--space-4);
                padding-bottom: calc(70px + var(--space-4));
            }

            .hero-cards-grid {
                grid-template-columns: 1fr;
                gap: var(--space-6);
            }

            .welcome-banner {
                flex-direction: column;
                text-align: center;
                padding: var(--space-6);
            }

            .features {
                padding: var(--space-6);
            }

            .features__list {
                grid-template-columns: 1fr;
                gap: var(--space-3);
            }

            .bottom-nav {
                padding: var(--space-2) var(--space-2);
            }

            .bottom-nav__item {
                min-width: 50px;
                padding: var(--space-2);
                font-size: 10px;
            }

            .btn-cta {
                padding: var(--space-5) var(--space-8);
                font-size: var(--font-size-lg);
            }
        }

        /* Touch Feedback (Mobile) */
        @media (hover: none) and (pointer: coarse) {
            .hero-card:active {
                transform: scale(0.98);
                box-shadow:
                    inset 0 2px 4px rgba(0,0,0,0.2),
                    0 0 20px rgba(0,191,255,0.5);
            }

            .quick-link:active {
                transform: scale(0.95);
                background: rgba(0, 191, 255, 0.25);
            }

            .btn-cta:active {
                transform: scale(0.97);
            }
        }

        /* ============================================
           🌓 THEME TOGGLE BUTTON
           Fixed Top-Right Corner - Apple Style
           ============================================ */
        .theme-toggle {
            position: fixed;
            top: var(--space-4);
            right: var(--space-4);
            z-index: 10000; /* Above everything */
            width: 56px;
            height: 56px;
            border-radius: var(--radius-full);
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            box-shadow: var(--shadow-lg), inset 0 1px 1px rgba(255,255,255,0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            border: none;
        }

        .theme-toggle:hover {
            transform: scale(1.1) rotate(15deg);
            box-shadow: var(--shadow-xl), inset 0 1px 1px rgba(255,255,255,0.2);
        }

        .theme-toggle:active {
            transform: scale(0.95);
        }

        .theme-toggle__icon {
            position: absolute;
            width: 24px;
            height: 24px;
            color: var(--color-text-primary);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        /* Show sun icon in dark mode, moon in light mode */
        [data-theme="dark"] .theme-toggle__icon--light {
            opacity: 1;
            transform: rotate(0deg) scale(1);
        }

        [data-theme="dark"] .theme-toggle__icon--dark {
            opacity: 0;
            transform: rotate(180deg) scale(0);
        }

        :root .theme-toggle__icon--light,
        [data-theme="light"] .theme-toggle__icon--light {
            opacity: 0;
            transform: rotate(-180deg) scale(0);
        }

        :root .theme-toggle__icon--dark,
        [data-theme="light"] .theme-toggle__icon--dark {
            opacity: 1;
            transform: rotate(0deg) scale(1);
        }

        /* Mobile: Smaller toggle button */
        @media (max-width: 768px) {
            .theme-toggle {
                width: 48px;
                height: 48px;
                top: var(--space-3);
                right: var(--space-3);
            }

            .theme-toggle__icon {
                width: 20px;
                height: 20px;
            }
        }

        /* ============================================
           ☀️ LIGHT MODE READABILITY OPTIMIZATIONS
           CRITICAL FIX: Glassmorphismus deaktivieren + Opake Backgrounds
           ============================================ */

        /* GLASSMORPHISMUS FÜR LIGHT MODE DEAKTIVIEREN */
        [data-theme="light"] .hero-card,
        [data-theme="light"] .bottom-nav,
        [data-theme="light"] .welcome-banner,
        [data-theme="light"] .cta-section,
        [data-theme="light"] .glass,
        [data-theme="light"] .glass-strong {
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            background: rgba(255, 255, 255, 1.0) !important; /* KOMPLETT OPAK! */
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.12) !important; /* Schatten für Tiefe */
        }

        /* Hero-Cards: Darker icons and stronger text + Text-Shadow */
        [data-theme="light"] .hero-card__icon i {
            color: rgba(0, 0, 0, 0.85);
            stroke-width: 2.5;
        }

        [data-theme="light"] .hero-card__title {
            color: #000000;
            font-weight: var(--font-weight-semibold);
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
        }

        [data-theme="light"] .hero-card__description {
            color: rgba(0, 0, 0, 0.75);
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.3);
        }

        /* Status-Badges: Colored backgrounds for Light Mode */
        [data-theme="light"] .badge--success {
            background: rgba(52, 199, 89, 0.15);
            color: #1b7e34;
            border-color: rgba(52, 199, 89, 0.4);
            font-weight: var(--font-weight-semibold);
        }

        [data-theme="light"] .badge--warning {
            background: rgba(255, 149, 0, 0.15);
            color: #8c5700;
            border-color: rgba(255, 149, 0, 0.4);
            font-weight: var(--font-weight-semibold);
        }

        [data-theme="light"] .badge--error {
            background: rgba(255, 59, 48, 0.15);
            color: #c41e14;
            border-color: rgba(255, 59, 48, 0.4);
            font-weight: var(--font-weight-semibold);
        }

        [data-theme="light"] .badge--info {
            background: rgba(0, 122, 255, 0.15);
            color: #0051a0;
            border-color: rgba(0, 122, 255, 0.4);
            font-weight: var(--font-weight-semibold);
        }

        /* Bottom Navigation: Stronger active state + Text-Shadow */
        [data-theme="light"] .bottom-nav {
            background: rgba(255, 255, 255, 1.0) !important;
            box-shadow: 0 -2px 12px rgba(0, 0, 0, 0.12) !important;
        }

        [data-theme="light"] .bottom-nav__item {
            color: rgba(0, 0, 0, 0.75);
        }

        [data-theme="light"] .bottom-nav__item.active {
            color: var(--color-primary);
            font-weight: var(--font-weight-semibold);
            background: rgba(0, 122, 255, 0.12);
        }

        [data-theme="light"] .bottom-nav__item.active i {
            stroke-width: 2.5;
        }

        [data-theme="light"] .bottom-nav__label {
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.5);
        }

        /* Welcome Banner: Better icon and text contrast + Text-Shadow */
        [data-theme="light"] .welcome-banner__icon i {
            color: rgba(0, 0, 0, 0.85);
            stroke-width: 2.5;
        }

        [data-theme="light"] .welcome-banner h2 {
            color: #000000;
            font-weight: var(--font-weight-semibold);
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
        }

        [data-theme="light"] .welcome-banner p {
            color: rgba(0, 0, 0, 0.75);
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.3);
        }

        /* CTA-Button: Stronger in Light Mode */
        [data-theme="light"] .cta-section .btn-primary {
            box-shadow: 0 4px 16px rgba(0, 122, 255, 0.3);
        }

        [data-theme="light"] .cta-section .btn-primary:hover {
            box-shadow: 0 6px 24px rgba(0, 122, 255, 0.4);
        }

        /* Feather Icons: Global stroke-width adjustment for Light Mode */
        [data-theme="light"] i[data-feather] {
            stroke-width: 2.5;
        }

        /* Global Text Shadow für alle wichtigen Elemente */
        [data-theme="light"] h1,
        [data-theme="light"] h2,
        [data-theme="light"] h3 {
            color: #000000;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
        }

        [data-theme="light"] p,
        [data-theme="light"] span,
        [data-theme="light"] a {
            color: rgba(0, 0, 0, 0.85);
        }

        /* Mobile: Further optimizations for small screens */
        @media (max-width: 768px) {
            [data-theme="light"] .hero-card,
            [data-theme="light"] .bottom-nav,
            [data-theme="light"] .welcome-banner {
                background: rgba(255, 255, 255, 1.0) !important; /* Komplett opak */
                box-shadow: 0 2px 16px rgba(0, 0, 0, 0.15) !important; /* Stärkerer Schatten */
            }

            [data-theme="light"] body {
                /* Pure black text on mobile */
                color: #000000;
            }

            [data-theme="light"] h1,
            [data-theme="light"] h2,
            [data-theme="light"] h3 {
                font-weight: var(--font-weight-semibold);
            }
        }

        /* ============================================
           📱 MOBILE HEADER - Sticky Top
           ============================================ */

        .mobile-header {
            /* Position */
            position: sticky;
            top: 0;
            z-index: var(--z-sticky);

            /* Layout */
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-4);
            padding-top: calc(var(--space-4) + env(safe-area-inset-top));

            /* Glass Effect */
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border-bottom: 1px solid var(--color-border-glass);
            box-shadow: var(--shadow-sm);
        }

        .mobile-header__logo {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
        }

        .mobile-header__logo i {
            width: 28px;
            height: 28px;
            color: var(--color-primary);
        }

        .mobile-header__actions {
            display: flex;
            gap: var(--space-2);
        }

        .mobile-header__icon {
            position: relative;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            border-radius: var(--radius-md);
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: all var(--duration-base) var(--ease-out);
        }

        .mobile-header__icon:active {
            transform: scale(0.9);
            background: rgba(0, 0, 0, 0.05);
        }

        [data-theme="light"] .mobile-header__icon:active {
            background: rgba(0, 0, 0, 0.05);
        }

        [data-theme="dark"] .mobile-header__icon:active {
            background: rgba(255, 255, 255, 0.1);
        }

        .mobile-header__badge {
            position: absolute;
            top: 4px;
            right: 4px;
            min-width: 18px;
            height: 18px;
            padding: 0 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-error);
            color: white;
            font-size: 10px;
            font-weight: var(--font-weight-semibold);
            border-radius: var(--radius-full);
            border: 2px solid var(--color-background);
        }

        /* Desktop: Header ausblenden */
        @media (min-width: 768px) {
            .mobile-header {
                display: none;
            }
        }

        /* ============================================
           🎯 FLOATING ACTION BUTTON (FAB)
           ============================================ */

        .fab {
            /* Position: Zentriert über Bottom Nav */
            position: fixed;
            bottom: calc(80px + var(--space-4));
            left: 50%;
            transform: translateX(-50%);
            z-index: calc(var(--z-fixed) + 1);

            /* Layout */
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;

            /* Styling */
            background: var(--color-primary);
            color: white;
            border-radius: var(--radius-full);
            box-shadow: var(--shadow-xl), 0 0 0 4px var(--color-background);
            font-size: 28px;
            text-decoration: none;

            /* Interaction */
            cursor: pointer;
            transition: all var(--duration-base) var(--ease-spring);
        }

        .fab:hover {
            transform: translateX(-50%) scale(1.1);
            box-shadow: var(--shadow-2xl), 0 0 0 4px var(--color-background);
        }

        .fab:active {
            transform: translateX(-50%) scale(0.95);
        }

        .fab i {
            width: 28px;
            height: 28px;
            stroke-width: 3;
        }

        /* Desktop: FAB rechts unten */
        @media (min-width: 768px) {
            .fab {
                right: var(--space-6);
                left: auto;
                bottom: var(--space-6);
                transform: none;
            }

            .fab:hover {
                transform: scale(1.1);
            }

            .fab:active {
                transform: scale(0.95);
            }
        }

        /* ============================================
           📱 HERO SECTION - Mobile Optimized
           ============================================ */

        @media (max-width: 768px) {
            .hero {
                padding: var(--space-6) var(--space-4);
                text-align: center;
            }

            .hero__title {
                font-size: var(--font-size-3xl);
            }

            .hero__subtitle {
                font-size: var(--font-size-base);
                max-width: 90%;
                margin: 0 auto;
            }

            .hero__version {
                display: none;
            }
        }

        /* ============================================
           🎴 HERO CARDS - Mobile 1-Spalten-Layout
           ============================================ */

        @media (max-width: 768px) {
            .hero-cards-grid {
                grid-template-columns: 1fr !important;
                gap: var(--space-4);
                padding: 0;
            }

            .hero-card {
                padding: var(--space-5);
            }

            .hero-card__header {
                flex-direction: row;
                align-items: center;
                gap: var(--space-3);
            }

            .hero-card__header i {
                width: 32px;
                height: 32px;
                flex-shrink: 0;
            }

            .hero-card__header h3 {
                font-size: var(--font-size-lg);
                margin-bottom: 0;
            }

            .hero-card__desc {
                font-size: var(--font-size-sm);
                margin: var(--space-2) 0;
            }

            .hero-card__actions {
                grid-template-columns: repeat(2, 1fr);
                gap: var(--space-2);
            }

            .quick-link {
                padding: var(--space-3);
                font-size: var(--font-size-sm);
            }
        }

        /* ============================================
           🧭 BOTTOM NAVIGATION - Mobile Touch-Optimized
           ============================================ */

        @media (max-width: 768px) {
            .bottom-nav {
                padding: var(--space-4) var(--space-2);
                padding-bottom: calc(var(--space-4) + env(safe-area-inset-bottom));
            }

            .bottom-nav__item {
                min-width: 60px;
                min-height: 44px;
                padding: var(--space-2);
                gap: var(--space-1);
            }

            .bottom-nav__item i {
                width: 24px;
                height: 24px;
            }

            .bottom-nav__item span {
                font-size: 11px;
                font-weight: var(--font-weight-medium);
            }

            .bottom-nav__item--active {
                background: rgba(0, 122, 255, 0.15);
                font-weight: var(--font-weight-semibold);
            }

            [data-theme="dark"] .bottom-nav__item--active {
                background: rgba(0, 191, 255, 0.15);
            }

            .bottom-nav__item:active {
                transform: scale(0.92);
            }
        }

        /* ============================================
           📦 CONTAINER - Mobile Spacing
           ============================================ */

        @media (max-width: 768px) {
            .container {
                padding: var(--space-4);
                padding-bottom: calc(120px + var(--space-4));
            }

            .welcome-banner {
                padding: var(--space-4);
                margin-bottom: var(--space-4);
            }

            .welcome-banner__icon {
                width: 36px;
                height: 36px;
            }

            .welcome-banner h2 {
                font-size: var(--font-size-xl);
            }

            .welcome-banner p {
                font-size: var(--font-size-sm);
            }
        }

        /* ============================================
           ♿ BARRIEREFREIHEIT - Reduced Motion
           ============================================ */

        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }

            .accent-light {
                animation: none;
                opacity: 0.3;
            }

            .shine-overlay {
                display: none;
            }

            .page-transition-overlay {
                display: none !important;
            }

            .fab:hover,
            .fab:active {
                transform: translateX(-50%) !important;
            }

            @media (min-width: 768px) {
                .fab:hover,
                .fab:active {
                    transform: none !important;
                }
            }
        }
    </style>
</head>
<body>
    <!-- 📱 MOBILE HEADER - Sticky Top (Mobile Only) -->
    <header class="mobile-header">
        <div class="mobile-header__logo">
            <i data-feather="zap"></i>
            <span>Fahrzeugannahme</span>
        </div>
        <div class="mobile-header__actions">
            <!-- Benachrichtigungs-Badge -->
            <button class="mobile-header__icon" aria-label="Benachrichtigungen">
                <i data-feather="bell"></i>
                <span class="mobile-header__badge">3</span>
            </button>
        </div>
    </header>

    <!-- THEME TOGGLE BUTTON - Fixed Top-Right -->
    <button id="themeToggle" class="theme-toggle" aria-label="Toggle Light/Dark Mode">
        <i data-feather="sun" class="theme-toggle__icon theme-toggle__icon--light"></i>
        <i data-feather="moon" class="theme-toggle__icon theme-toggle__icon--dark"></i>
    </button>

    <!-- APPLE UX FEATURE 1: Accent-Light (Parallax-fähig) -->
    <div class="accent-light"></div>

    <!-- APPLE UX FEATURE 2: Page Transition Overlay -->
    <div class="page-transition-overlay"></div>

    <!-- SVG Gradient Definition for Icons -->
    <svg width="0" height="0" style="position: absolute;">
        <defs>
            <linearGradient id="iconGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#00bfff;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#66d9ff;stop-opacity:1" />
            </linearGradient>
        </defs>
    </svg>

    <!-- Hero Section -->
    <div class="hero">
        <h1 class="hero__title">Fahrzeugannahme-App</h1>
        <p class="hero__subtitle">Fahrzeuge erfassen in unter 2 Minuten</p>
        <div class="hero__version">Version 2.0 - Premium Dark Glass Edition</div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Welcome Banner -->
        <div class="welcome-banner">
            <div class="welcome-banner__icon">
                <i data-feather="zap"></i>
            </div>
            <div class="welcome-banner__content">
                <h2 id="welcomeTitle">Willkommen im Dashboard</h2>
                <p id="welcomeSubtitle">Verwalten Sie Fahrzeuge, Kunden und Partner-Anfragen professionell und effizient</p>
                <div id="userActions" style="display: none; margin-top: 10px; gap: 10px; flex-wrap: wrap;">
                    <button id="btnSwitchUser" style="padding: 8px 16px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: var(--color-text-secondary); cursor: pointer; font-size: 14px; transition: all 0.2s;">
                        🔄 Benutzer wechseln
                    </button>
                    <button id="btnLogout" style="padding: 8px 16px; background: rgba(255,0,0,0.1); border: 1px solid rgba(255,0,0,0.3); border-radius: 8px; color: rgba(255,100,100,0.9); cursor: pointer; font-size: 14px; transition: all 0.2s;">
                        📤 Abmelden
                    </button>
                </div>
            </div>
        </div>

        <!-- Core Features -->
        <h2 class="section-title">Hauptfunktionen</h2>
        <div class="hero-cards-grid">
            <!-- GRUPPE 1: Fahrzeug-Management -->
            <div class="hero-card hero-card--primary">
                <!-- APPLE UX FEATURE 4: Shine Overlay -->
                <div class="shine-overlay"></div>
                <div class="hero-card__header">
                    <i data-feather="truck"></i>
                    <h3>Fahrzeug-Management</h3>
                    <span class="badge badge--count" id="badge-fahrzeuge">0 offen</span>
                </div>
                <p class="hero-card__desc">Erfassen, übergeben & verwalten</p>

                <div class="hero-card__actions">
                    <a href="annahme.html" class="quick-link" data-permission="annahme">
                        <i data-feather="file-plus"></i>
                        <span>Annahme</span>
                    </a>
                    <a href="abnahme.html" class="quick-link" data-permission="abnahme">
                        <i data-feather="check-circle"></i>
                        <span>Abnahme</span>
                    </a>
                    <a href="liste.html" class="quick-link" data-permission="liste">
                        <i data-feather="list"></i>
                        <span>Übersicht</span>
                    </a>
                </div>
            </div>

            <!-- GRUPPE 2: Prozess-Überwachung -->
            <div class="hero-card">
                <!-- APPLE UX FEATURE 4: Shine Overlay -->
                <div class="shine-overlay"></div>
                <div class="hero-card__header">
                    <i data-feather="activity"></i>
                    <h3>Prozess-Überwachung</h3>
                    <span class="badge badge--warning" id="badge-prozess">0 in Arbeit</span>
                </div>
                <p class="hero-card__desc">Kanban Board & Kundenverwaltung</p>

                <div class="hero-card__actions">
                    <a href="kanban.html" class="quick-link" data-permission="kanban">
                        <i data-feather="trello"></i>
                        <span>Kanban</span>
                    </a>
                    <a href="kunden.html" class="quick-link" data-permission="kunden">
                        <i data-feather="users"></i>
                        <span>Kunden</span>
                    </a>
                </div>
            </div>

            <!-- GRUPPE 3: Organisation & Partner -->
            <div class="hero-card">
                <!-- APPLE UX FEATURE 4: Shine Overlay -->
                <div class="shine-overlay"></div>
                <div class="hero-card__header">
                    <i data-feather="briefcase"></i>
                    <h3>Organisation & Partner</h3>
                    <span class="badge badge--info" id="badge-partner">0 Anfragen</span>
                </div>
                <p class="hero-card__desc">Termine, Material & Partner-Anfragen</p>

                <div class="hero-card__actions">
                    <a href="kalender.html" class="quick-link" data-permission="kalender">
                        <i data-feather="calendar"></i>
                        <span>Kalender</span>
                    </a>
                    <a href="material.html" class="quick-link" data-permission="material">
                        <i data-feather="package"></i>
                        <span>Material</span>
                    </a>
                    <a href="partner-app/admin-anfragen.html" class="quick-link" data-permission="partnerAnfragen">
                        <i data-feather="mail"></i>
                        <span>Partner</span>
                    </a>
                    <a href="partner-landing.html" class="quick-link" data-permission="partnerPortal">
                        <i data-feather="link"></i>
                        <span>Portal</span>
                    </a>
                </div>
            </div>

            <!-- GRUPPE 4: Admin-Funktionen (NEU - Phase 5) -->
            <div class="hero-card">
                <!-- APPLE UX FEATURE 4: Shine Overlay -->
                <div class="shine-overlay"></div>
                <div class="hero-card__header">
                    <i data-feather="shield"></i>
                    <h3>Admin-Funktionen</h3>
                    <span class="badge badge--info">Coming Soon</span>
                </div>
                <p class="hero-card__desc">Verwaltung & Berechtigungen</p>

                <div class="hero-card__actions">
                    <a href="mitarbeiter-verwaltung.html" class="quick-link" data-permission="mitarbeiterVerwaltung">
                        <i data-feather="users"></i>
                        <span>Mitarbeiter</span>
                    </a>
                    <a href="nutzer-verwaltung.html" class="quick-link" data-permission="nutzerVerwaltung">
                        <i data-feather="user-check"></i>
                        <span>User-Verwaltung</span>
                    </a>
                    <a href="registrierung.html" class="quick-link" data-permission="registrierung">
                        <i data-feather="user-plus"></i>
                        <span>Registrierung</span>
                    </a>
                </div>
            </div>

            <!-- GRUPPE 5: KI-Assistent (NEU - Phase 5) -->
            <div class="hero-card">
                <!-- APPLE UX FEATURE 4: Shine Overlay -->
                <div class="shine-overlay"></div>
                <div class="hero-card__header">
                    <i data-feather="cpu"></i>
                    <h3>KI-Assistent</h3>
                    <span class="badge badge--count">Beta</span>
                </div>
                <p class="hero-card__desc">Intelligente Unterstützung per Sprache</p>

                <div class="hero-card__actions">
                    <a href="#" onclick="alert('KI-Chat wird in Kürze verfügbar sein! Features:\n- Anfragen per Sprache erstellen\n- Status-Abfragen\n- Automatische Benachrichtigungen'); return false;" class="quick-link" data-permission="kiChat">
                        <i data-feather="message-circle"></i>
                        <span>Chat</span>
                    </a>
                    <a href="#" onclick="alert('Sprach-Assistent kommt bald!'); return false;" class="quick-link" data-permission="kiSprache">
                        <i data-feather="mic"></i>
                        <span>Sprache</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Primary CTA -->
        <div class="cta-section">
            <a href="annahme.html" class="btn-cta">
                <i data-feather="truck"></i>
                <span>🚗 Neues Fahrzeug anlegen</span>
                <i data-feather="arrow-right"></i>
            </a>
        </div>

        <!-- Features Section -->
        <div class="features">
            <h3 class="features__title">Was kann diese App?</h3>
            <ul class="features__list">
                <li class="features__item">
                    <i data-feather="camera"></i>
                    <span>Fotos direkt mit Kamera aufnehmen</span>
                </li>
                <li class="features__item">
                    <i data-feather="edit-3"></i>
                    <span>Digitale Unterschrift des Kunden</span>
                </li>
                <li class="features__item">
                    <i data-feather="file-text"></i>
                    <span>Automatische PDF-Erstellung</span>
                </li>
                <li class="features__item">
                    <i data-feather="git-compare"></i>
                    <span>Vorher/Nachher-Vergleich bei Abnahme</span>
                </li>
                <li class="features__item">
                    <i data-feather="trello"></i>
                    <span>Kanban Board für Produktionsübersicht</span>
                </li>
                <li class="features__item">
                    <i data-feather="users"></i>
                    <span>Kundenverwaltung mit Statistiken</span>
                </li>
                <li class="features__item">
                    <i data-feather="send"></i>
                    <span>Partner-Anfragen direkt bearbeiten</span>
                </li>
                <li class="features__item">
                    <i data-feather="wifi-off"></i>
                    <span>Funktioniert offline - kein Internet nötig</span>
                </li>
                <li class="features__item">
                    <i data-feather="download"></i>
                    <span>Keine Installation erforderlich</span>
                </li>
                <li class="features__item">
                    <i data-feather="smartphone"></i>
                    <span>Mobile-optimiert für Tablet & Smartphone</span>
                </li>
            </ul>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>Ausführliche Anleitung: <a href="README.md" target="_blank" class="footer__link">README öffnen</a></p>
            <p class="footer__company">Auto-Lackierzentrum Mosbach | info@auto-lackierzentrum.de</p>
        </div>
    </div>

    <!-- 🎯 FLOATING ACTION BUTTON - Neues Fahrzeug -->
    <a href="annahme.html" class="fab" aria-label="Neues Fahrzeug anlegen">
        <i data-feather="plus"></i>
    </a>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="index.html" class="bottom-nav__item bottom-nav__item--active">
            <i data-feather="home"></i>
            <span>Home</span>
        </a>
        <a href="annahme.html" class="bottom-nav__item">
            <i data-feather="file-plus"></i>
            <span>Annahme</span>
        </a>
        <a href="liste.html" class="bottom-nav__item">
            <i data-feather="list"></i>
            <span>Übersicht</span>
        </a>
        <a href="kanban.html" class="bottom-nav__item">
            <i data-feather="trello"></i>
            <span>Kanban</span>
        </a>
    </nav>

    <!-- Initialize Feather Icons -->
    <script>
        feather.replace();
    </script>

    <!-- ============================================
         🎨 APPLE UX FEATURES - JavaScript Implementation
         ============================================ -->
    <script>
        // ============================================
        // FEATURE 1: Blur-Overlays beim Seitenwechsel
        // ============================================
        function initPageTransitions() {
            const overlay = document.querySelector('.page-transition-overlay');
            const internalLinks = document.querySelectorAll('a[href]:not([href^="http"]):not([href^="mailto"]):not([target="_blank"])');

            internalLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    const href = link.getAttribute('href');

                    // Ignore # links and javascript: links
                    if (!href || href === '#' || href.startsWith('javascript:')) {
                        return;
                    }

                    e.preventDefault();

                    // Activate overlay
                    overlay.classList.add('active');

                    // Navigate after transition
                    setTimeout(() => {
                        window.location.href = href;
                    }, 300);
                });
            });

            console.log('✅ Page Transitions initialized (' + internalLinks.length + ' links)');
        }

        // ============================================
        // FEATURE 2: Haptisches Feedback (nur Mobile)
        // ============================================
        function initHapticFeedback() {
            // Check if vibration API available and touch device
            const isTouch = window.matchMedia('(hover: none) and (pointer: coarse)').matches;
            const canVibrate = 'vibrate' in navigator;

            if (!canVibrate || !isTouch) {
                console.log('ℹ️ Haptic Feedback: Not available or not touch device');
                return;
            }

            // Debounce helper
            let lastVibration = 0;
            function vibrate(duration) {
                const now = Date.now();
                if (now - lastVibration > 100) { // Max 1x per 100ms
                    navigator.vibrate(duration);
                    lastVibration = now;
                }
            }

            // Hero-Cards: 10ms (leicht)
            document.querySelectorAll('.hero-card').forEach(card => {
                card.addEventListener('touchstart', () => vibrate(10), { passive: true });
            });

            // Buttons/CTAs: 15ms (mittel)
            document.querySelectorAll('.btn, .btn-cta').forEach(btn => {
                btn.addEventListener('touchstart', () => vibrate(15), { passive: true });
            });

            // Bottom-Nav: 8ms (sehr leicht)
            document.querySelectorAll('.bottom-nav__item').forEach(item => {
                item.addEventListener('touchstart', () => vibrate(8), { passive: true });
            });

            console.log('✅ Haptic Feedback initialized (Touch device)');
        }

        // ============================================
        // FEATURE 3: Parallax Light beim Scrollen
        // ============================================
        function initParallaxLight() {
            const accentLight = document.querySelector('.accent-light');
            let ticking = false;

            function updateParallax() {
                const scrollY = window.scrollY || window.pageYOffset;
                const parallaxY = scrollY * 0.3; // 30% der Scroll-Distanz

                accentLight.style.transform = `translateY(${parallaxY}px)`;
                ticking = false;
            }

            window.addEventListener('scroll', function() {
                if (!ticking) {
                    requestAnimationFrame(updateParallax);
                    ticking = true;
                }
            }, { passive: true });

            console.log('✅ Parallax Light initialized');
        }

        // ============================================
        // FEATURE 4: Hero-Card Animations (Pulse + Shine)
        // ============================================
        function initHeroCardAnimations() {
            // Check if GSAP loaded
            if (typeof gsap === 'undefined') {
                console.warn('⚠️ GSAP not loaded - Hero-Card animations disabled');
                return;
            }

            document.querySelectorAll('.hero-card').forEach(card => {
                const shineOverlay = card.querySelector('.shine-overlay');

                card.addEventListener('click', function(e) {
                    // Don't animate if clicking on a link
                    if (e.target.closest('a')) {
                        return;
                    }

                    // PULSE Animation (Scale)
                    gsap.timeline()
                        .to(card, {
                            scale: 0.95,
                            duration: 0.1,
                            ease: "power2.out"
                        })
                        .to(card, {
                            scale: 1.02,
                            duration: 0.15,
                            ease: "power2.out"
                        })
                        .to(card, {
                            scale: 1,
                            duration: 0.1,
                            ease: "power2.out"
                        });

                    // SHINE Animation (Light Sweep)
                    gsap.fromTo(shineOverlay,
                        { x: '-100%' },
                        {
                            x: '100%',
                            duration: 0.6,
                            ease: "power2.out"
                        }
                    );
                });
            });

            console.log('✅ Hero-Card Animations initialized (Pulse + Shine)');
        }

        // ============================================
        // Initialize all Apple UX Features on load
        // ============================================
        window.addEventListener('DOMContentLoaded', function() {
            initPageTransitions();
            initHapticFeedback();
            initParallaxLight();
            initHeroCardAnimations();

            console.log('🎨 All Apple UX Features initialized!');
        });

        // ============================================
        // 📱 FAB SCROLL HIDE/SHOW (Mobile)
        // ============================================
        function initFABScrollBehavior() {
            const fab = document.querySelector('.fab');
            if (!fab) return;

            let lastScrollY = window.scrollY;
            let ticking = false;

            function updateFAB() {
                const currentScrollY = window.scrollY;

                // Check if on mobile (< 768px)
                const isMobile = window.innerWidth < 768;

                if (isMobile) {
                    if (currentScrollY > lastScrollY && currentScrollY > 100) {
                        // Scrolling down - hide FAB
                        fab.style.transform = 'translateX(-50%) translateY(120px)';
                        fab.style.opacity = '0';
                        fab.style.pointerEvents = 'none';
                    } else {
                        // Scrolling up - show FAB
                        fab.style.transform = 'translateX(-50%) translateY(0)';
                        fab.style.opacity = '1';
                        fab.style.pointerEvents = 'auto';
                    }
                } else {
                    // Desktop: Always visible
                    fab.style.transform = 'none';
                    fab.style.opacity = '1';
                    fab.style.pointerEvents = 'auto';
                }

                lastScrollY = currentScrollY;
                ticking = false;
            }

            window.addEventListener('scroll', () => {
                if (!ticking) {
                    window.requestAnimationFrame(updateFAB);
                    ticking = true;
                }
            });

            // Update on resize
            window.addEventListener('resize', updateFAB);

            console.log('✅ FAB Scroll Behavior initialized');
        }

        // Initialize FAB on load
        document.addEventListener('DOMContentLoaded', () => {
            initFABScrollBehavior();
        });

        // ============================================
        // 🌓 LIGHT/DARK MODE TOGGLE
        // ============================================
        (function initThemeToggle() {
            const themeToggle = document.getElementById('themeToggle');
            const html = document.documentElement;

            // Function to update Feather Icons stroke-width based on theme
            function updateFeatherIcons(theme) {
                const strokeWidth = theme === 'light' ? '2.5' : '2';

                // Update all Feather Icons SVGs
                document.querySelectorAll('i[data-feather]').forEach(icon => {
                    const svg = icon.querySelector('svg');
                    if (svg) {
                        // Update stroke-width on all paths and shapes
                        svg.querySelectorAll('*[stroke]').forEach(element => {
                            element.setAttribute('stroke-width', strokeWidth);
                        });
                    }
                });

                console.log(`🎨 Feather Icons stroke-width updated to ${strokeWidth} for ${theme} mode`);
            }

            // Initialize theme (default: light)
            let currentTheme = localStorage.getItem('theme') || 'light';
            html.setAttribute('data-theme', currentTheme);
            console.log(`🌓 Theme initialized: ${currentTheme}`);

            // Toggle theme on button click
            themeToggle.addEventListener('click', () => {
                currentTheme = currentTheme === 'light' ? 'dark' : 'light';
                html.setAttribute('data-theme', currentTheme);
                localStorage.setItem('theme', currentTheme);

                console.log(`🌓 Theme switched to: ${currentTheme}`);

                // Re-initialize Feather Icons for theme change
                if (typeof feather !== 'undefined') {
                    feather.replace();
                    // Wait for feather.replace() to finish, then update stroke-width
                    setTimeout(() => updateFeatherIcons(currentTheme), 50);
                }
            });

            // Initialize Feather Icons on load
            if (typeof feather !== 'undefined') {
                feather.replace();
                // Wait for feather.replace() to finish, then update stroke-width
                setTimeout(() => {
                    updateFeatherIcons(currentTheme);
                    console.log('✅ Feather Icons initialized');
                }, 50);
            }
        })();
    </script>

    <!-- GSAP Premium Animations -->
    <script>
        // Firebase Status Badges Update
        async function updateStatusBadges() {
            try {
                if (typeof firebaseApp !== 'undefined' && firebaseApp.getAllFahrzeuge) {
                    const fahrzeuge = await firebaseApp.getAllFahrzeuge();

                    // Zähle offene Fahrzeuge
                    const offen = fahrzeuge.filter(f => f.status !== 'abgeschlossen').length;
                    document.getElementById('badge-fahrzeuge').textContent = `${offen} offen`;

                    // Zähle in Arbeit
                    const inArbeit = fahrzeuge.filter(f => f.prozessStatus && f.prozessStatus !== 'angenommen' && f.status !== 'abgeschlossen').length;
                    document.getElementById('badge-prozess').textContent = `${inArbeit} in Arbeit`;

                    console.log('✅ Status-Badges aktualisiert:', { offen, inArbeit });
                } else {
                    // Fallback: Verwende LocalStorage
                    const fahrzeuge = JSON.parse(localStorage.getItem('fahrzeuge') || '[]');
                    const offen = fahrzeuge.filter(f => f.status !== 'abgeschlossen').length;
                    const inArbeit = fahrzeuge.filter(f => f.prozessStatus && f.prozessStatus !== 'angenommen' && f.status !== 'abgeschlossen').length;

                    document.getElementById('badge-fahrzeuge').textContent = `${offen} offen`;
                    document.getElementById('badge-prozess').textContent = `${inArbeit} in Arbeit`;
                }
            } catch (error) {
                console.warn('⚠️ Status-Badges konnten nicht aktualisiert werden:', error);
                // Behalte Dummy-Werte
            }
        }

        // Wait for ALL resources (including GSAP CDN) to load
        window.addEventListener('load', async function() {

            // Update Status Badges
            await updateStatusBadges();

            // Check if GSAP loaded successfully
            if (typeof gsap === 'undefined') {
                console.warn('⚠️ GSAP not loaded - animations disabled, but page works!');
                return;
            }

            // Fade-in body on page load
            gsap.fromTo("body",
                { opacity: 0 },
                { opacity: 1, duration: 0.6, ease: "power2.out" }
            );

            // Hero section entrance
            gsap.fromTo(".hero",
                { opacity: 0, y: 20 },
                { opacity: 1, y: 0, duration: 0.8, delay: 0.2, ease: "power2.out" }
            );

            // Hero title pulse (subtle, continuous)
            gsap.to(".hero__title", {
                textShadow: "0 0 20px rgba(0,191,255,0.4)",
                duration: 2,
                repeat: -1,
                yoyo: true,
                ease: "sine.inOut"
            });

            // Welcome Banner entrance
            gsap.fromTo(".welcome-banner",
                { opacity: 0, scale: 0.95, y: 20 },
                { opacity: 1, scale: 1, y: 0, duration: 0.8, delay: 0.3, ease: "back.out(1.2)" }
            );

            // Stagger animation for hero cards
            gsap.fromTo(".hero-card",
                // FROM: Start-Werte
                {
                    opacity: 0,
                    scale: 0.9,
                    y: 30
                },
                // TO: Explizite Ziel-Werte
                {
                    opacity: 1,
                    scale: 1,
                    y: 0,
                    duration: 0.7,
                    stagger: 0.15,
                    delay: 0.5,
                    ease: "back.out(1.4)",
                    onComplete: function() {
                        // Markiere Cards als animiert
                        document.querySelectorAll('.hero-card').forEach(card => {
                            card.classList.add('gsap-animated');
                        });
                    }
                }
            );

            // CTA Button entrance
            gsap.fromTo(".btn-cta",
                { opacity: 0, scale: 0.8, y: 20 },
                { opacity: 1, scale: 1, y: 0, duration: 0.6, delay: 1.2, ease: "back.out(1.7)" }
            );

            // Features section entrance
            gsap.fromTo(".features",
                { opacity: 0, y: 30 },
                { opacity: 1, y: 0, duration: 0.8, delay: 1.5, ease: "power2.out" }
            );

            // Features items stagger
            gsap.fromTo(".features__item",
                { opacity: 0, x: -20 },
                { opacity: 1, x: 0, duration: 0.5, stagger: 0.05, delay: 1.7, ease: "power2.out" }
            );

            // Bottom nav entrance
            gsap.fromTo(".bottom-nav",
                { y: 100, opacity: 0 },
                { y: 0, opacity: 1, duration: 0.6, delay: 0.8, ease: "power2.out" }
            );

            // Hover animations for hero cards
            document.querySelectorAll('.hero-card').forEach(card => {
                card.addEventListener('mouseenter', function() {
                    gsap.to(card, {
                        y: -8,
                        boxShadow: "inset 0 1px 1px rgba(255,255,255,0.25), 0 0 50px rgba(0,191,255,0.4), 0 16px 48px rgba(0,0,0,0.45)",
                        duration: 0.3,
                        ease: "power2.out"
                    });
                });

                card.addEventListener('mouseleave', function() {
                    gsap.to(card, {
                        y: 0,
                        boxShadow: "inset 0 1px 1px rgba(255,255,255,0.2), 0 8px 32px rgba(0,0,0,0.35)",
                        duration: 0.3,
                        ease: "power2.out"
                    });
                });
            });

            // Hover animations for quick links
            document.querySelectorAll('.quick-link').forEach(link => {
                link.addEventListener('mouseenter', function() {
                    gsap.to(link, {
                        scale: 1.08,
                        boxShadow: "0 0 20px rgba(0,191,255,0.4)",
                        duration: 0.2,
                        ease: "power2.out"
                    });
                });

                link.addEventListener('mouseleave', function() {
                    gsap.to(link, {
                        scale: 1,
                        boxShadow: "none",
                        duration: 0.2,
                        ease: "power2.out"
                    });
                });
            });

            // Bottom nav item hover
            document.querySelectorAll('.bottom-nav__item').forEach(item => {
                item.addEventListener('mouseenter', function() {
                    if (!item.classList.contains('bottom-nav__item--active')) {
                        gsap.to(item, {
                            scale: 1.1,
                            y: -3,
                            duration: 0.2,
                            ease: "power2.out"
                        });
                    }
                });

                item.addEventListener('mouseleave', function() {
                    if (!item.classList.contains('bottom-nav__item--active')) {
                        gsap.to(item, {
                            scale: 1,
                            y: 0,
                            duration: 0.2,
                            ease: "power2.out"
                        });
                    }
                });
            });
        });
    </script>

    <!-- LOGIN MODAL (Firebase Auth) -->
    <div id="loginModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 100000; padding: 20px; overflow-y: auto;">
        <div style="max-width: 500px; margin: 100px auto; background: var(--color-surface); border-radius: 16px; padding: 40px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); backdrop-filter: blur(25px);">
            <!-- Header -->
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, var(--color-primary), var(--color-primary-hover)); border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 40px;">
                    🔐
                </div>
                <h2 style="color: var(--color-text-primary); margin: 0 0 10px 0; font-size: 28px; font-weight: 700;">Anmelden</h2>
                <p style="color: var(--color-text-secondary); margin: 0; font-size: 14px;">Bitte melden Sie sich mit Ihren Zugangsdaten an</p>
            </div>

            <!-- Login Form -->
            <form id="loginForm" onsubmit="login(event)">
                <!-- Email -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--color-text-secondary); font-size: 14px; font-weight: 600;">📧 E-Mail</label>
                    <input
                        type="email"
                        id="loginEmail"
                        required
                        placeholder="ihre.email@beispiel.de"
                        style="width: 100%; padding: 14px; border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; background: rgba(255,255,255,0.05); color: var(--color-text-primary); font-size: 16px; transition: all 0.2s;"
                        onfocus="this.style.borderColor='var(--color-primary)'"
                        onblur="this.style.borderColor='rgba(255,255,255,0.2)'">
                </div>

                <!-- Password -->
                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--color-text-secondary); font-size: 14px; font-weight: 600;">🔑 Passwort</label>
                    <input
                        type="password"
                        id="loginPassword"
                        required
                        placeholder="Passwort eingeben"
                        style="width: 100%; padding: 14px; border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; background: rgba(255,255,255,0.05); color: var(--color-text-primary); font-size: 16px; transition: all 0.2s;"
                        onfocus="this.style.borderColor='var(--color-primary)'"
                        onblur="this.style.borderColor='rgba(255,255,255,0.2)'">
                </div>

                <!-- Error Message -->
                <div id="loginError" style="display: none; background: rgba(255, 59, 48, 0.1); border: 1px solid rgba(255, 59, 48, 0.3); border-radius: 8px; padding: 12px; color: #ff3b30; font-size: 14px; margin-bottom: 20px;"></div>

                <!-- Login Button -->
                <button
                    type="submit"
                    id="loginBtn"
                    style="width: 100%; padding: 16px; background: linear-gradient(135deg, var(--color-primary), var(--color-primary-hover)); border: none; border-radius: 10px; color: white; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <i data-feather="log-in"></i>
                    Anmelden
                </button>
            </form>

            <!-- Alternative Actions -->
            <div style="margin-top: 20px; text-align: center; font-size: 14px; color: var(--color-text-secondary);">
                <p style="margin: 10px 0;">
                    Noch kein Account?
                    <a href="registrierung.html" style="color: var(--color-primary); text-decoration: none; font-weight: 600;">Jetzt registrieren</a>
                </p>
            </div>
        </div>
    </div>

    <!-- MITARBEITER AUSWAHL MODAL (Stage 2 Login) -->
    <div id="mitarbeiterModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 100001; padding: 20px; overflow-y: auto;">
        <div style="max-width: 500px; margin: 100px auto; background: var(--color-surface); border-radius: 16px; padding: 40px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); backdrop-filter: blur(25px);">
            <!-- Header -->
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, var(--color-primary), var(--color-primary-hover)); border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 40px;">
                    👤
                </div>
                <h2 style="color: var(--color-text-primary); margin: 0 0 10px 0; font-size: 28px; font-weight: 700;">Mitarbeiter auswählen</h2>
                <p style="color: var(--color-text-secondary); margin: 0; font-size: 14px;">Bitte wählen Sie Ihren Mitarbeiter-Account</p>
            </div>

            <!-- Mitarbeiter Selection Form -->
            <form id="mitarbeiterForm" onsubmit="submitMitarbeiterLogin(event)">
                <!-- Mitarbeiter Dropdown -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--color-text-secondary); font-size: 14px; font-weight: 600;">👤 Mitarbeiter</label>
                    <select
                        id="mitarbeiterSelect"
                        required
                        style="width: 100%; padding: 14px; border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; background: rgba(255,255,255,0.05); color: var(--color-text-primary); font-size: 16px; transition: all 0.2s; cursor: pointer;"
                        onfocus="this.style.borderColor='var(--color-primary)'"
                        onblur="this.style.borderColor='rgba(255,255,255,0.2)'">
                        <option value="" disabled selected>Mitarbeiter auswählen...</option>
                    </select>
                </div>

                <!-- Password -->
                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--color-text-secondary); font-size: 14px; font-weight: 600;">🔑 Passwort</label>
                    <input
                        type="password"
                        id="mitarbeiterPassword"
                        required
                        placeholder="Mitarbeiter-Passwort eingeben"
                        style="width: 100%; padding: 14px; border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; background: rgba(255,255,255,0.05); color: var(--color-text-primary); font-size: 16px; transition: all 0.2s;"
                        onfocus="this.style.borderColor='var(--color-primary)'"
                        onblur="this.style.borderColor='rgba(255,255,255,0.2)'">
                </div>

                <!-- Error Message -->
                <div id="mitarbeiterError" style="display: none; background: rgba(255, 59, 48, 0.1); border: 1px solid rgba(255, 59, 48, 0.3); border-radius: 8px; padding: 12px; color: #ff3b30; font-size: 14px; margin-bottom: 20px;"></div>

                <!-- Test-Daten Button (nur anzeigen wenn keine Mitarbeiter) -->
                <div id="testDataButtonContainer" style="display: none; margin-bottom: 20px;">
                    <button
                        type="button"
                        onclick="createTestMitarbeiterFromModal()"
                        style="width: 100%; padding: 14px; background: rgba(52, 199, 89, 0.15); border: 2px solid rgba(52, 199, 89, 0.4); border-radius: 10px; color: #34c759; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;"
                        onmouseover="this.style.background='rgba(52, 199, 89, 0.25)'"
                        onmouseout="this.style.background='rgba(52, 199, 89, 0.15)'">
                        <i data-feather="users"></i>
                        🧪 3 Test-Mitarbeiter erstellen (Passwort: 1234)
                    </button>
                </div>

                <!-- Login Button -->
                <button
                    type="submit"
                    id="mitarbeiterBtn"
                    style="width: 100%; padding: 16px; background: linear-gradient(135deg, var(--color-primary), var(--color-primary-hover)); border: none; border-radius: 10px; color: white; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 10px;">
                    <i data-feather="user-check"></i>
                    Als Mitarbeiter anmelden
                </button>

                <!-- Cancel Button (continue as werkstatt) -->
                <button
                    type="button"
                    onclick="closeMitarbeiterModal()"
                    style="width: 100%; padding: 16px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; color: var(--color-text-primary); font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                    Als Werkstatt fortfahren
                </button>
            </form>

            <!-- Info -->
            <div style="margin-top: 20px; text-align: center; font-size: 13px; color: var(--color-text-secondary); line-height: 1.6;">
                <p style="margin: 0;">
                    💡 <strong>Hinweis:</strong><br>
                    Die Mitarbeiter-Auswahl ermöglicht individuelle Berechtigungen.<br>
                    Sie können auch ohne Mitarbeiter-Auswahl als Werkstatt fortfahren (voller Zugriff).
                </p>
            </div>
        </div>
    </div>

    <!-- USER MANAGEMENT & TILE LOCKING SCRIPT -->
    <script>
        // ============================================
        // USER MANAGEMENT SYSTEM
        // ============================================

        let currentUser = null;
        let usersList = [];

        // ============================================
        // PASSWORD HASHING (SHA-256)
        // ============================================

        /**
         * Hash password using SHA-256
         * @param {string} password - Plain text password
         * @returns {Promise<string>} - Hex string hash
         */
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        // Open Login Modal (Firebase Auth)
        function openLoginModal() {
            document.getElementById('loginModal').style.display = 'block';
            // Focus email field
            setTimeout(() => {
                document.getElementById('loginEmail').focus();
            }, 100);
        }

        // Close Login Modal
        function closeLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
            // Reset form
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginError').style.display = 'none';
        }

        // ============================================
        // MITARBEITER MODAL (Stage 2 Login)
        // ============================================

        // Open Mitarbeiter Modal and load employees
        async function openMitarbeiterModal() {
            console.log('👤 Öffne Mitarbeiter-Auswahl Modal...');

            document.getElementById('mitarbeiterModal').style.display = 'block';

            // Load employees from Firestore
            await loadMitarbeiterDropdown();

            // Focus dropdown
            setTimeout(() => {
                document.getElementById('mitarbeiterSelect').focus();
            }, 100);

            // Re-render feather icons
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        }

        // Close Mitarbeiter Modal
        function closeMitarbeiterModal() {
            console.log('👤 Schließe Mitarbeiter-Auswahl Modal (fortfahren als Werkstatt)');

            document.getElementById('mitarbeiterModal').style.display = 'none';

            // Reset form
            document.getElementById('mitarbeiterSelect').value = '';
            document.getElementById('mitarbeiterPassword').value = '';
            document.getElementById('mitarbeiterError').style.display = 'none';
        }

        // Load Mitarbeiter Dropdown from Firestore
        async function loadMitarbeiterDropdown() {
            console.log('📥 Lade Mitarbeiter für Dropdown...');

            try {
                // Get werkstattId from currentUser
                if (!currentUser || !currentUser.werkstattId) {
                    console.error('❌ Keine werkstattId vorhanden!');
                    return;
                }

                const werkstattId = currentUser.werkstattId;
                console.log('   WerkstattID:', werkstattId);

                // Get mitarbeiter collection using helper function
                const mitarbeiterCollection = window.getCollection('mitarbeiter');
                const mitarbeiterSnapshot = await mitarbeiterCollection.get();

                const dropdown = document.getElementById('mitarbeiterSelect');

                // Clear existing options (except placeholder)
                dropdown.innerHTML = '<option value="" disabled selected>Mitarbeiter auswählen...</option>';

                // Add mitarbeiter to dropdown (only active employees)
                let activeCount = 0;
                mitarbeiterSnapshot.forEach((doc) => {
                    if (doc.id === '_init') return; // Skip init doc

                    const data = doc.data();

                    // Only show active employees
                    if (data.status === 'active') {
                        const option = document.createElement('option');
                        option.value = doc.id;
                        option.textContent = data.name;
                        dropdown.appendChild(option);
                        activeCount++;
                    }
                });

                console.log(`✅ ${activeCount} aktive Mitarbeiter geladen`);

                // If no employees found, show message + Test-Daten Button
                if (activeCount === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Keine Mitarbeiter gefunden';
                    option.disabled = true;
                    dropdown.appendChild(option);

                    document.getElementById('mitarbeiterError').textContent = '⚠️ Es wurden keine aktiven Mitarbeiter gefunden. Klicken Sie unten auf den Button um Test-Mitarbeiter zu erstellen.';
                    document.getElementById('mitarbeiterError').style.display = 'block';

                    // Show Test-Daten Button
                    document.getElementById('testDataButtonContainer').style.display = 'block';
                } else {
                    // Hide Test-Daten Button if employees exist
                    document.getElementById('testDataButtonContainer').style.display = 'none';
                }

            } catch (error) {
                console.error('❌ Fehler beim Laden der Mitarbeiter:', error);
                document.getElementById('mitarbeiterError').textContent = '❌ Fehler beim Laden der Mitarbeiter: ' + error.message;
                document.getElementById('mitarbeiterError').style.display = 'block';
            }
        }

        // Submit Mitarbeiter Login (Stage 2)
        async function submitMitarbeiterLogin(event) {
            event.preventDefault();

            const mitarbeiterId = document.getElementById('mitarbeiterSelect').value;
            const password = document.getElementById('mitarbeiterPassword').value;
            const errorDiv = document.getElementById('mitarbeiterError');
            const submitBtn = document.getElementById('mitarbeiterBtn');

            // Validation
            if (!mitarbeiterId || !password) {
                errorDiv.textContent = '⚠️ Bitte Mitarbeiter und Passwort eingeben!';
                errorDiv.style.display = 'block';
                return;
            }

            // Disable button during login
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i data-feather="loader"></i> Anmeldung läuft...';
            errorDiv.style.display = 'none';

            if (typeof feather !== 'undefined') {
                feather.replace();
            }

            try {
                console.log('🔐 STAGE 2: Mitarbeiter-Login:', mitarbeiterId);

                // Call authManager.loginMitarbeiter()
                const mitarbeiter = await window.authManager.loginMitarbeiter(mitarbeiterId, password);

                console.log('✅ Stage 2 erfolgreich:', mitarbeiter);

                // Update current user with mitarbeiter data
                currentUser = window.authManager.getCurrentUser();

                console.log('✅ Current User aktualisiert:', currentUser);
                console.log('   Login Stage:', currentUser.loginStage);
                console.log('   Rolle:', currentUser.role);
                console.log('   Berechtigungen:', currentUser.berechtigungen);

                // Update Welcome Banner with mitarbeiter name
                updateWelcomeBanner();

                // Re-lock tiles based on mitarbeiter permissions
                lockTiles();

                // Close modal
                closeMitarbeiterModal();

                // Success message
                alert(`✅ Willkommen, ${currentUser.name}!\n\nSie sind jetzt als Mitarbeiter angemeldet.\n\nBerechtigungen wurden aktualisiert.`);

            } catch (error) {
                console.error('❌ Mitarbeiter-Login fehlgeschlagen:', error);

                // Show error message
                errorDiv.textContent = error.message || '❌ Anmeldung fehlgeschlagen! Bitte prüfen Sie Mitarbeiter und Passwort.';
                errorDiv.style.display = 'block';

                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i data-feather="user-check"></i> Als Mitarbeiter anmelden';

                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
            }
        }

        // Create Test Mitarbeiter from Modal (ohne zu mitarbeiter-verwaltung.html zu wechseln)
        async function createTestMitarbeiterFromModal() {
            console.log('🧪 Erstelle Test-Mitarbeiter aus Modal...');

            const errorDiv = document.getElementById('mitarbeiterError');
            const testBtn = document.getElementById('testDataButtonContainer').querySelector('button');

            // Disable button during creation
            testBtn.disabled = true;
            testBtn.innerHTML = '<i data-feather="loader"></i> Erstelle Test-Daten...';
            errorDiv.style.display = 'none';

            if (typeof feather !== 'undefined') {
                feather.replace();
            }

            try {
                // Get werkstattId from currentUser
                if (!currentUser || !currentUser.werkstattId) {
                    throw new Error('Keine werkstattId vorhanden!');
                }

                const werkstattId = currentUser.werkstattId;
                console.log('   WerkstattID:', werkstattId);

                // Get mitarbeiter collection
                const mitarbeiterCollection = window.getCollection('mitarbeiter');

                // Hash für Passwort "1234"
                const passwordHash = await window.authManager.hashPassword('1234');

                // Test-Mitarbeiter Daten
                const testUsers = [
                    {
                        id: `user_max_${Date.now()}`,
                        name: 'Max Müller (Vollzugriff)',
                        passwordHash: passwordHash,
                        status: 'active',
                        berechtigungen: {
                            annahme: true,
                            abnahme: true,
                            liste: true,
                            kanban: true,
                            kunden: true,
                            kalender: true,
                            material: true,
                            partner: true,
                            mitarbeiterVerwaltung: true,
                            einstellungen: true,
                            backup: true,
                            statistiken: true,
                            admin: true,
                            entwickler: true
                        },
                        werkstattId: werkstattId,
                        createdAt: new Date().toISOString(),
                        createdBy: 'Test-Daten Generator (Modal)',
                        lastLogin: null
                    },
                    {
                        id: `user_anna_${Date.now() + 1}`,
                        name: 'Anna Schmidt (Teilzugriff)',
                        passwordHash: passwordHash,
                        status: 'active',
                        berechtigungen: {
                            annahme: true,
                            abnahme: true,
                            liste: true,
                            kanban: true,
                            kunden: false,
                            kalender: true,
                            material: false,
                            partner: false,
                            mitarbeiterVerwaltung: false,
                            einstellungen: false,
                            backup: false,
                            statistiken: false,
                            admin: false,
                            entwickler: false
                        },
                        werkstattId: werkstattId,
                        createdAt: new Date().toISOString(),
                        createdBy: 'Test-Daten Generator (Modal)',
                        lastLogin: null
                    },
                    {
                        id: `user_tom_${Date.now() + 2}`,
                        name: 'Tom Weber (Basiszugriff)',
                        passwordHash: passwordHash,
                        status: 'active', // Active so it appears in dropdown
                        berechtigungen: {
                            annahme: true,
                            abnahme: false,
                            liste: true,
                            kanban: false,
                            kunden: false,
                            kalender: false,
                            material: false,
                            partner: false,
                            mitarbeiterVerwaltung: false,
                            einstellungen: false,
                            backup: false,
                            statistiken: false,
                            admin: false,
                            entwickler: false
                        },
                        werkstattId: werkstattId,
                        createdAt: new Date().toISOString(),
                        createdBy: 'Test-Daten Generator (Modal)',
                        lastLogin: null
                    }
                ];

                // Create all test users
                for (const user of testUsers) {
                    await mitarbeiterCollection.doc(user.id).set(user);
                    console.log(`✅ Mitarbeiter erstellt: ${user.name}`);
                }

                console.log('✅ Alle Test-Mitarbeiter erfolgreich erstellt!');

                // Show success message
                alert('✅ 3 Test-Mitarbeiter erfolgreich erstellt!\n\nPasswort für alle: 1234\n\n• Max Müller (Vollzugriff)\n• Anna Schmidt (Teilzugriff)\n• Tom Weber (Basiszugriff)\n\nBitte wähle jetzt einen Mitarbeiter aus.');

                // Reload dropdown
                await loadMitarbeiterDropdown();

                // Re-render feather icons
                if (typeof feather !== 'undefined') {
                    feather.replace();
                }

            } catch (error) {
                console.error('❌ Fehler beim Erstellen der Test-Mitarbeiter:', error);
                errorDiv.textContent = '❌ Fehler beim Erstellen: ' + error.message;
                errorDiv.style.display = 'block';

                // Re-enable button
                testBtn.disabled = false;
                testBtn.innerHTML = '<i data-feather="users"></i> 🧪 3 Test-Mitarbeiter erstellen (Passwort: 1234)';

                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
            }
        }

        // ============================================
        // LOGIN FUNCTIONS
        // ============================================

        // Firebase Login (E-Mail + Password)
        async function login(event) {
            event.preventDefault(); // Prevent form submission reload

            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            const loginBtn = document.getElementById('loginBtn');

            // Validation
            if (!email || !password) {
                errorDiv.textContent = '⚠️ Bitte E-Mail und Passwort eingeben!';
                errorDiv.style.display = 'block';
                return;
            }

            // Disable button during login
            loginBtn.disabled = true;
            loginBtn.textContent = 'Anmeldung läuft...';
            errorDiv.style.display = 'none';

            try {
                console.log('🔐 Firebase Login:', email);

                // Call authManager.loginWithFirebase()
                const user = await window.authManager.loginWithFirebase(email, password);

                console.log('✅ Login erfolgreich:', user);
                console.log('   Rolle:', user.role);
                console.log('   WerkstattID:', user.werkstattId);

                // Set current user
                currentUser = user;

                // Update Welcome Banner
                updateWelcomeBanner();

                // Lock/Unlock tiles based on role and permissions
                lockTiles();

                // Close login modal
                closeLoginModal();

                // ⚠️ WICHTIG: Für Werkstatt-Rolle → öffne Mitarbeiter-Auswahl Modal
                if (user.role === 'werkstatt') {
                    console.log('👤 Werkstatt-Login erkannt → öffne Mitarbeiter-Auswahl');

                    // Open mitarbeiter modal after a short delay
                    setTimeout(() => {
                        openMitarbeiterModal();
                    }, 300);

                } else {
                    // For other roles (admin, partner, kunde) → show welcome animation
                    showWelcomeAnimation();
                }

            } catch (error) {
                console.error('❌ Login fehlgeschlagen:', error);

                // Show error message
                errorDiv.textContent = error.message || '❌ Anmeldung fehlgeschlagen! Bitte prüfe deine E-Mail und Passwort.';
                errorDiv.style.display = 'block';

                // Re-enable button
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i data-feather="log-in"></i> Anmelden';
                feather.replace(); // Re-render icons
            }
        }

        // Show welcome animation
        function showWelcomeAnimation() {
            const banner = document.querySelector('.welcome-banner');
            banner.style.animation = 'none';
            setTimeout(() => {
                banner.style.animation = 'fadeIn 0.5s ease-out';
            }, 10);

            alert(`✅ Willkommen, ${currentUser.name}!\n\nAngemeldet um ${currentUser.loginTimeFormatted} Uhr`);
        }

        // Update Welcome Banner
        function updateWelcomeBanner() {
            if (!currentUser) return;

            const titleEl = document.getElementById('welcomeTitle');
            const subtitleEl = document.getElementById('welcomeSubtitle');
            const actionsEl = document.getElementById('userActions');

            // Update title
            titleEl.textContent = `Hallo ${currentUser.name}!`;

            // Update subtitle with login time
            if (currentUser.loginTimeFormatted) {
                subtitleEl.textContent = `Angemeldet seit ${currentUser.loginTimeFormatted} Uhr`;
                subtitleEl.style.fontSize = '14px';
                subtitleEl.style.color = 'var(--color-text-secondary)';
            }

            // Show action buttons
            actionsEl.style.display = 'flex';
        }

        // Logout User (Firebase Auth)
        async function logoutUser() {
            if (!currentUser) return;

            const userName = currentUser.name;

            if (!confirm(`Möchtest du dich wirklich abmelden?\n\nAngemeldet als: ${userName}`)) {
                return;
            }

            try {
                // Firebase Logout
                await window.authManager.logout();
                currentUser = null;

                console.log(`👋 ${userName} abgemeldet`);

                // Show goodbye message
                alert(`👋 Bis bald, ${userName}!\n\nDas Tablet ist jetzt bereit für den nächsten Benutzer.`);

                // Reset Welcome Banner
                document.getElementById('welcomeTitle').textContent = 'Willkommen im Dashboard';
                document.getElementById('welcomeSubtitle').textContent = 'Verwalten Sie Fahrzeuge, Kunden und Partner-Anfragen professionell und effizient';
                document.getElementById('userActions').style.display = 'none';

                // Reset all tiles to locked state
                resetTiles();

                // Open login modal
                setTimeout(() => {
                    openLoginModal();
                }, 300);

            } catch (error) {
                console.error('❌ Logout fehlgeschlagen:', error);
                alert('⚠️ Fehler beim Abmelden!');
            }
        }

        // Load Current User from Firebase Auth
        async function loadCurrentUser() {
            // ⚠️ WICHTIG: Warte auf Auth State Listener (Race Condition Fix)
            // Identisch mit mitarbeiter-verwaltung.html Polling-Mechanismus
            let user = null;
            let attempts = 0;
            const maxAttempts = 20; // 20 * 250ms = 5 Sekunden max

            while (!user && attempts < maxAttempts) {
                user = window.authManager.getCurrentUser();
                if (!user) {
                    console.log(`⏳ Warte auf Auth State Listener (Versuch ${attempts + 1}/${maxAttempts})...`);
                    await new Promise(resolve => setTimeout(resolve, 250)); // 250ms warten
                    attempts++;
                }
            }

            if (user) {
                currentUser = user;
                console.log('✅ Firebase Auth User geladen:', currentUser.name);
                console.log('   Rolle:', currentUser.role);
                console.log('   Login Stage:', currentUser.loginStage);
                updateWelcomeBanner();
                lockTiles();
            } else {
                // Nach 5 Sekunden: Timeout → kein User eingeloggt
                console.log('⚠️ Kein Benutzer eingeloggt nach 5 Sekunden → öffne Login-Modal');
                setTimeout(() => {
                    openLoginModal();
                }, 500);
            }
        }

        // ============================================
        // TILE LOCKING SYSTEM
        // ============================================

        function lockTiles() {
            if (!currentUser) {
                console.warn('⚠️ Kein Benutzer eingeloggt');
                return;
            }

            console.log('🔒 Prüfe Kachel-Berechtigungen für Rolle:', currentUser.role);

            const links = document.querySelectorAll('a[data-permission]');

            // Admin hat immer vollen Zugriff - alle Kacheln freischalten
            if (currentUser.role === 'admin') {
                console.log('✅ Admin-Rolle: Alle Kacheln freigeschaltet');
                links.forEach(link => {
                    link.style.opacity = '1';
                    link.style.pointerEvents = 'auto';
                    link.style.filter = 'none';
                    const lockIcon = link.querySelector('.lock-icon');
                    if (lockIcon) lockIcon.remove();
                });
                return;
            }

            // Für Mitarbeiter: Berechtigungen prüfen
            if (currentUser.role === 'mitarbeiter') {
                if (!currentUser.berechtigungen) {
                    console.warn('⚠️ Mitarbeiter hat keine Berechtigungen definiert');
                    return;
                }

                const permissions = currentUser.berechtigungen;

            links.forEach(link => {
                const requiredPermission = link.getAttribute('data-permission');
                const hasPermission = permissions[requiredPermission] === true;

                if (hasPermission) {
                    // UNLOCK: Remove lock
                    link.style.opacity = '1';
                    link.style.pointerEvents = 'auto';
                    link.style.filter = 'none';

                    // Remove lock icon if exists
                    const lockIcon = link.querySelector('.lock-icon');
                    if (lockIcon) lockIcon.remove();

                } else {
                    // LOCK: Add lock styling
                    link.style.opacity = '0.5';
                    link.style.pointerEvents = 'none';
                    link.style.filter = 'grayscale(1)';

                    // Add lock icon
                    if (!link.querySelector('.lock-icon')) {
                        const lockIcon = document.createElement('i');
                        lockIcon.setAttribute('data-feather', 'lock');
                        lockIcon.className = 'lock-icon';
                        lockIcon.style.position = 'absolute';
                        lockIcon.style.top = '5px';
                        lockIcon.style.right = '5px';
                        lockIcon.style.width = '16px';
                        lockIcon.style.height = '16px';
                        lockIcon.style.color = '#ff4444';

                        link.style.position = 'relative';
                        link.appendChild(lockIcon);

                        // Refresh feather icons
                        feather.replace();
                    }

                    // Prevent click
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        alert(`🔒 Zugriff verweigert!\n\nDu hast keine Berechtigung für "${link.textContent.trim()}".`);
                        return false;
                    });
                }
            });

                console.log('✅ Kachel-Berechtigungen angewendet (Mitarbeiter)');
                return;
            }

            // Für Werkstatt: Voller Zugriff (wie Admin)
            if (currentUser.role === 'werkstatt') {
                console.log('✅ Werkstatt-Rolle: Alle Kacheln freigeschaltet');
                links.forEach(link => {
                    link.style.opacity = '1';
                    link.style.pointerEvents = 'auto';
                    link.style.filter = 'none';
                    const lockIcon = link.querySelector('.lock-icon');
                    if (lockIcon) lockIcon.remove();
                });
                return;
            }

            // Für Partner und Kunde: Aktuell keine Kacheln in index.html
            // (Partner nutzen partner-app, Kunde nutzt Kunde-Portal)
            console.log('ℹ️ Rolle:', currentUser.role, '- Keine spezifischen Kachel-Berechtigungen');
        }

        // Reset all tiles to locked state (after logout)
        function resetTiles() {
            console.log('🔄 Setze alle Kacheln zurück...');

            const links = document.querySelectorAll('a[data-permission]');

            links.forEach(link => {
                // LOCK all tiles
                link.style.opacity = '0.5';
                link.style.pointerEvents = 'none';
                link.style.filter = 'grayscale(1)';

                // Add lock icon if not exists
                if (!link.querySelector('.lock-icon')) {
                    const lockIcon = document.createElement('i');
                    lockIcon.setAttribute('data-feather', 'lock');
                    lockIcon.className = 'lock-icon';
                    lockIcon.style.position = 'absolute';
                    lockIcon.style.top = '5px';
                    lockIcon.style.right = '5px';
                    lockIcon.style.width = '16px';
                    lockIcon.style.height = '16px';
                    lockIcon.style.color = '#ff4444';

                    link.style.position = 'relative';
                    link.appendChild(lockIcon);

                    // Refresh feather icons
                    feather.replace();
                }
            });

            console.log('✅ Alle Kacheln gesperrt');
        }

        // ============================================
        // INITIALIZE ON PAGE LOAD
        // ============================================

        window.addEventListener('DOMContentLoaded', async () => {
            // Wait for Firebase to initialize
            await window.firebaseInitialized;

            // Attach event listeners to user action buttons
            const btnSwitchUser = document.getElementById('btnSwitchUser');
            if (btnSwitchUser) {
                btnSwitchUser.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('🖱️ Benutzer-wechseln-Button geklickt!');
                    logoutUser(); // Logout current user and open login modal
                });
                console.log('✅ Switch-User-Button Event Listener attached');
            }

            const btnLogout = document.getElementById('btnLogout');
            if (btnLogout) {
                btnLogout.addEventListener('click', function(e) {
                    e.preventDefault();
                    console.log('🖱️ Abmelden-Button geklickt!');
                    logoutUser();
                });
                console.log('✅ Logout-Button Event Listener attached');
            }

            // Load current user
            loadCurrentUser();

            console.log('✅ User Management System initialized');
        });
    </script>

    <!-- Error Handler & Storage Monitor -->
    <script src="error-handler.js"></script>
    <script src="storage-monitor.js"></script>
</body>
</html>
