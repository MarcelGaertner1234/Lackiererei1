<!DOCTYPE html>
<html lang="de">
<head>
    <!-- werkstattId will be set dynamically by auth-manager.js after login -->
    <script>
        // window.werkstattId is set automatically after successful login
        // This ensures proper multi-tenant data isolation

        // ‚úÖ BUG #5 FIX: Global DEBUG flag for conditional logging
        // Enables debug logs via localStorage or URL parameter
        window.DEBUG = (
            localStorage.getItem('DEBUG') === 'true' ||
            window.location.search.includes('debug=true') ||
            window.location.hostname === 'localhost' ||
            window.location.port === '8000'
        );
        if (window.DEBUG) console.log('üêõ DEBUG MODE ENABLED');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Fahrzeugannahme-App | Auto-Lackierzentrum Mosbach</title>

    <!-- Aggressive No-Cache Headers (Cache-Fix f√ºr v=a4192c4) -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- üåì FOUC Prevention: Load Theme BEFORE CSS to prevent flash -->
    <script>
        (function() {
            // Load saved theme from localStorage (default: light)
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            console.log(`üåì Theme pre-loaded in <head>: ${savedTheme} (FOUC Prevention)`);
        })();
    </script>

    <!-- Google Fonts - Inter (SF Pro Display Fallback) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Apple Liquid Glass Dark Mode Design System -->
    <link rel="stylesheet" href="design-system.css?v=af6b90f">
    <link rel="stylesheet" href="components.css?v=af6b90f">
    <link rel="stylesheet" href="animations.css?v=af6b90f">
    <link rel="stylesheet" href="mobile-first.css?v=af6b90f">

    <!-- Light Mode Readability Optimizations -->
    <link rel="stylesheet" href="css/light-mode.css?v=nov9">

    <!-- AI Chat Widget -->
    <link rel="stylesheet" href="css/ai-chat-widget.css">
    <link rel="stylesheet" href="css/quota-display.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>
    <script src="firebase-config.js?v=a4192c4"></script>
    <script src="js/auth-manager.js"></script>
    <script src="js/settings-manager.js"></script>

    <!-- ‚úÖ BUG #7 FIX: Service Type Normalization Registry -->
    <script src="js/service-types.js?v=bug7-normalization"></script>

    <!-- Event System f√ºr Real-Time Updates (Phase 3) -->
    <script src="js/app-events.js"></script>

    <!-- Global Chat Notifications -->
    <link rel="stylesheet" href="global-chat-notifications.css">
    <script src="global-chat-notifications.js"></script>

    <!-- Mitarbeiter Notifications -->
    <script src="js/mitarbeiter-notifications.js"></script>

    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>

    <!-- Listener Registry - Load early for inline scripts (BUGFIX 2025-11-04) -->
    <script src="listener-registry.js?v=6020c9e"></script>

    <!-- GSAP Animation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

    <style>
        /* ============================================
           üåô PREMIUM DARK GLASS DASHBOARD
           Apple Liquid Glass Dark Mode - UX Optimiert
           + Apple UX-Details: Blur-Overlays, Haptic, Parallax, Pulse+Shine
           ============================================ */

        /* Screen Reader Only Text (Accessibility) */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* ============================================
           üé® SMOOTH THEME TRANSITIONS
           ============================================ */

        /* Global smooth transitions for theme changes */
        :root {
            transition: background-color var(--duration-base) var(--ease-out),
                        color var(--duration-base) var(--ease-out);
        }

        body,
        .hero-card,
        .bottom-nav,
        .welcome-banner,
        .cta-section,
        .glass,
        .glass-strong,
        .badge,
        .btn,
        .theme-toggle {
            transition: background var(--duration-base) var(--ease-out),
                        background-color var(--duration-base) var(--ease-out),
                        color var(--duration-base) var(--ease-out),
                        border-color var(--duration-base) var(--ease-out),
                        box-shadow var(--duration-base) var(--ease-out),
                        backdrop-filter var(--duration-base) var(--ease-out);
        }

        /* Smooth icon transitions */
        i[data-feather],
        .hero-card__icon i,
        .bottom-nav__item i {
            transition: color var(--duration-base) var(--ease-out),
                        stroke-width var(--duration-base) var(--ease-out),
                        transform var(--duration-base) var(--ease-out);
        }

        /* Smooth text transitions */
        h1, h2, h3, h4, h5, h6,
        p, span, a, label {
            transition: color var(--duration-base) var(--ease-out),
                        text-shadow var(--duration-base) var(--ease-out);
        }

        body {
            /* THEME-AWARE: Light Mode = White, Dark Mode = Black */
            min-height: 100vh;
            padding: var(--space-6);
            padding-bottom: calc(80px + var(--space-6));
            font-family: 'SF Pro Display', 'Inter', var(--font-system);
            position: relative;
            overflow-x: hidden;
        }

        /* All content above atmosphere */
        .hero, .container, .bottom-nav {
            position: relative;
            z-index: 1;
        }

        /* ============================================
           üé® APPLE UX FEATURE 1: ACCENT-LIGHT (Parallax-f√§hig)
           Moved from body::before to allow JS manipulation
           ============================================ */
        .accent-light {
            content: '';
            position: fixed;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            /* THEME-AWARE: Golden Glow (Light) / Cyan Glow (Dark) */
            background: radial-gradient(circle, var(--accent-light-color) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
            animation: pulse 8s ease-in-out infinite;
            /* GPU-Acceleration f√ºr smooth Parallax */
            transform: translate3d(0, 0, 0);
            will-change: transform;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 0.8; }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ============================================
           üé® APPLE UX FEATURE 2: PAGE TRANSITION OVERLAY
           Blur-Overlay beim Seitenwechsel
           ============================================ */
        .page-transition-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: rgba(11, 11, 12, 0.4);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-out;
        }

        .page-transition-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        /* Hero Section - Dark Glass */
        .hero {
            max-width: 1200px;
            margin: 0 auto var(--space-12);
            text-align: center;
        }

        .hero__title {
            font-size: clamp(48px, 7vw, 72px);
            font-weight: 800;
            letter-spacing: -0.02em;
            line-height: 1;
            margin-bottom: var(--space-6);

            /* Gradient with Light Reflex */
            background: linear-gradient(135deg, #fff 0%, #00bfff 50%, #66d9ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .hero__subtitle {
            font-size: var(--font-size-lg);
            color: rgba(255,255,255,0.7);
            font-weight: var(--font-weight-regular);
            line-height: 1.6;
            max-width: 600px;
            margin: 0 auto var(--space-8);
        }

        .hero__version {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-5);

            /* Enhanced Glassmorphism */
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(25px) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(25px) saturate(var(--glass-saturation));
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-full);

            /* Doppelte Schatten */
            box-shadow:
                inset 0 1px 1px rgba(255,255,255,0.2),
                0 8px 32px rgba(0,0,0,0.35);

            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
            color: var(--color-primary);
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Welcome Banner */
        .welcome-banner {
            display: flex;
            align-items: center;
            gap: var(--space-6);
            padding: var(--space-8);
            margin-bottom: var(--space-12);
            background: linear-gradient(135deg, rgba(0, 191, 255, 0.15), rgba(255, 255, 255, 0.05));
            border: 1px solid rgba(0, 191, 255, 0.3);
            border-radius: var(--radius-xl);
            box-shadow:
                inset 0 1px 1px rgba(255,255,255,0.2),
                0 8px 32px rgba(0,0,0,0.35);
            position: relative;
            overflow: hidden;
        }

        .welcome-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 30%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.15), transparent);
            pointer-events: none;
        }

        .welcome-banner__icon {
            width: 64px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 191, 255, 0.2);
            border-radius: var(--radius-full);
            flex-shrink: 0;
        }

        .welcome-banner__icon i {
            width: 32px;
            height: 32px;
            color: var(--color-primary);
            filter: drop-shadow(0 2px 8px rgba(0,191,255,0.5));
        }

        .welcome-banner__content h2 {
            font-size: clamp(20px, 4vw, 28px);
            font-weight: var(--font-weight-bold);
            color: rgba(255,255,255,0.95);
            margin-bottom: var(--space-2);
        }

        .welcome-banner__content p {
            font-size: var(--font-size-sm);
            color: rgba(255,255,255,0.7);
            line-height: 1.6;
        }

        /* Section Title */
        .section-title {
            text-align: center;
            font-size: var(--font-size-4xl);
            font-weight: var(--font-weight-bold);
            color: rgba(255,255,255,0.95);
            margin-bottom: var(--space-12);
            letter-spacing: -0.01em;
        }

        /* Hero Cards Grid */
        .hero-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: var(--space-8);
            margin-bottom: var(--space-16);
        }

        /* ============================================
           üé® APPLE UX FEATURE 3 & 4: HERO CARD (Pulse + Shine)
           ============================================ */
        .hero-card {
            padding: var(--space-10);
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(25px) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(25px) saturate(var(--glass-saturation));
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: var(--radius-2xl);
            box-shadow:
                inset 0 1px 1px rgba(255,255,255,0.2),
                0 8px 32px rgba(0,0,0,0.35);
            transition: all var(--duration-base) var(--ease-out);
            position: relative;
            overflow: hidden;
            opacity: 1;
            cursor: pointer;
            /* GPU-Acceleration */
            transform: translate3d(0, 0, 0);
        }

        /* Shine Overlay for Click Animation */
        .shine-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(255, 255, 255, 0.4) 50%,
                transparent 100%
            );
            transform: translateX(-100%);
            pointer-events: none;
            z-index: 10;
        }

        /* Shine Effect (Static top gradient) */
        .hero-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 40%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.15), transparent);
            border-radius: inherit;
            pointer-events: none;
            opacity: 0.3;
        }

        .hero-card:hover {
            transform: translateY(-4px);
            box-shadow:
                inset 0 1px 1px rgba(255,255,255,0.25),
                0 0 40px rgba(0,191,255,0.3),
                0 12px 40px rgba(0,0,0,0.45);
        }

        .hero-card--primary {
            background: linear-gradient(135deg, rgba(0, 191, 255, 0.18), rgba(255, 255, 255, 0.08));
            border-color: rgba(0, 191, 255, 0.3);
        }

        .hero-card__header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
            position: relative;
            z-index: 2;
        }

        .hero-card__header i {
            width: 32px;
            height: 32px;
            color: var(--color-primary);
            filter: drop-shadow(0 2px 4px rgba(0,191,255,0.3));
        }

        .hero-card__header h3 {
            flex: 1;
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
            color: rgba(255,255,255,0.95);
            letter-spacing: 0.3px;
        }

        .hero-card__desc {
            font-size: var(--font-size-sm);
            color: rgba(255,255,255,0.65);
            margin-bottom: var(--space-6);
            line-height: 1.6;
            position: relative;
            z-index: 2;
        }

        .hero-card__actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: var(--space-3);
            position: relative;
            z-index: 2;
        }

        /* Quick Link */
        .quick-link {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-4);
            min-height: 48px;
            min-width: 48px;
            background: rgba(0, 191, 255, 0.08);
            border: 1px solid rgba(0, 191, 255, 0.2);
            border-radius: var(--radius-lg);
            text-decoration: none;
            color: rgba(255,255,255,0.8);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
            transition: all var(--duration-base) var(--ease-out);
        }

        .quick-link:hover {
            background: rgba(0, 191, 255, 0.15);
            border-color: var(--color-primary);
            color: var(--color-primary);
            transform: scale(1.05);
        }

        .quick-link i {
            width: 20px;
            height: 20px;
        }

        /* Status Badge */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-1) var(--space-3);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
            white-space: nowrap;
        }

        .badge--count {
            background: rgba(0, 191, 255, 0.2);
            color: var(--color-primary);
            border-color: rgba(0, 191, 255, 0.4);
        }

        .badge--warning {
            background: rgba(255, 149, 0, 0.2);
            color: var(--color-warning);
            border-color: rgba(255, 149, 0, 0.4);
        }

        .badge--info {
            background: rgba(0, 113, 227, 0.2);
            color: var(--color-info);
            border-color: rgba(0, 113, 227, 0.4);
        }

        /* CTA Section */
        .cta-section {
            text-align: center;
            margin: var(--space-16) 0;
        }

        .btn-cta {
            display: inline-flex;
            align-items: center;
            gap: var(--space-4);
            padding: var(--space-6) var(--space-12);
            min-height: 56px;
            background: linear-gradient(135deg, #00bfff, #0099cc);
            color: white;
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            border: none;
            border-radius: var(--radius-full);
            box-shadow:
                0 8px 32px rgba(0, 191, 255, 0.4),
                0 4px 12px rgba(0,0,0,0.3);
            text-decoration: none;
            transition: all var(--duration-base) var(--ease-out);
            cursor: pointer;
        }

        .btn-cta:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow:
                0 12px 48px rgba(0, 191, 255, 0.5),
                0 8px 20px rgba(0,0,0,0.4);
        }

        .btn-cta:active {
            transform: translateY(-2px) scale(1.02);
        }

        .btn-cta i:first-child {
            width: 24px;
            height: 24px;
        }

        .btn-cta i:last-child {
            width: 20px;
            height: 20px;
        }

        /* Features Section */
        .features {
            max-width: 900px;
            margin: 0 auto var(--space-20);
            position: relative;

            /* Enhanced Glassmorphism */
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: var(--radius-2xl);
            padding: var(--space-10);

            /* Doppelte Schatten */
            box-shadow:
                inset 0 1px 1px rgba(255,255,255,0.2),
                0 8px 32px rgba(0,0,0,0.35);
            overflow: hidden;
        }

        /* Shine Effect */
        .features::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 30%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.15), transparent);
            pointer-events: none;
        }

        .features__title {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-semibold);
            color: rgba(255,255,255,0.95);
            margin-bottom: var(--space-6);
            letter-spacing: 0.3px;
        }

        .features__list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-4);
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .features__item {
            display: flex;
            align-items: flex-start;
            gap: var(--space-3);
            font-size: var(--font-size-base);
            color: rgba(255,255,255,0.85);  /* Increased from 0.7 for better contrast */
            line-height: 1.7;  /* Increased for better readability */
        }

        .features__item i {
            color: var(--color-primary);
            flex-shrink: 0;
            width: 20px;
            height: 20px;
            stroke-width: 2.5;
            filter: drop-shadow(0 0 8px rgba(0,191,255,0.4));
        }

        /* Premium Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: var(--z-fixed);

            /* Enhanced Glassmorphism */
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(32px) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(32px) saturate(var(--glass-saturation));
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.4);

            padding: var(--space-3) var(--space-4);
            display: flex;
            justify-content: center;
            gap: var(--space-2);
        }

        .bottom-nav__item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-2) var(--space-4);
            min-width: 60px;
            min-height: 48px;
            text-decoration: none;
            color: rgba(255,255,255,0.6);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
            border-radius: var(--radius-md);
            transition: all var(--duration-base) var(--ease-out);
            position: relative;
        }

        .bottom-nav__item i {
            width: 20px;
            height: 20px;
            stroke-width: 2;
        }

        .bottom-nav__item:hover {
            color: var(--color-primary);
            background: rgba(0, 191, 255, 0.1);
        }

        /* Active State with Top-Border Glow */
        .bottom-nav__item--active {
            color: var(--color-primary);
            background: rgba(0, 191, 255, 0.15);
        }

        .bottom-nav__item--active::before {
            content: '';
            position: absolute;
            top: -3px;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00bfff, transparent);
            box-shadow: 0 0 10px rgba(0,191,255,0.8);
        }

        /* Footer */
        .footer {
            max-width: 900px;
            margin: 0 auto;
            padding: var(--space-8) var(--space-4);
            text-align: center;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255,255,255,0.5);
            font-size: var(--font-size-sm);
        }

        .footer__link {
            color: var(--color-primary);
            text-decoration: none;
            font-weight: var(--font-weight-semibold);
            transition: all var(--duration-base) var(--ease-out);
        }

        .footer__link:hover {
            color: var(--color-primary-hover);
            transform: scale(1.05);
            text-shadow: 0 0 10px rgba(0,191,255,0.5);
        }

        .footer__company {
            margin-top: var(--space-3);
        }

        /* Mobile Optimizations */
        @media (max-width: 768px) {
            body {
                padding: var(--space-4);
                padding-bottom: calc(70px + var(--space-4));
            }

            .hero-cards-grid {
                grid-template-columns: 1fr;
                gap: var(--space-6);
            }

            .welcome-banner {
                flex-direction: column;
                text-align: center;
                padding: var(--space-6);
            }

            .features {
                padding: var(--space-6);
            }

            .features__list {
                grid-template-columns: 1fr;
                gap: 16px;  /* Increased from var(--space-3) for better spacing */
            }

            .features__item {
                font-size: 16px;  /* Minimum for mobile readability (WCAG 1.4.4) */
                line-height: 1.7;  /* Maintain comfortable line spacing */
            }

            .features__title {
                font-size: 24px;  /* Ensure title is prominent on mobile */
                margin-bottom: 20px;
            }

            .bottom-nav {
                padding: var(--space-2) var(--space-2);
            }

            .bottom-nav__item {
                min-width: 50px;
                padding: var(--space-2);
                font-size: 10px;
            }

            .btn-cta {
                padding: var(--space-5) var(--space-8);
                font-size: var(--font-size-lg);
            }
        }

        /* Touch Feedback (Mobile) */
        @media (hover: none) and (pointer: coarse) {
            .hero-card:active {
                transform: scale(0.98);
                box-shadow:
                    inset 0 2px 4px rgba(0,0,0,0.2),
                    0 0 20px rgba(0,191,255,0.5);
            }

            .quick-link:active {
                transform: scale(0.95);
                background: rgba(0, 191, 255, 0.25);
            }

            .btn-cta:active {
                transform: scale(0.97);
            }
        }

        /* ============================================
           üåì THEME TOGGLE BUTTON
           Fixed Top-Right Corner - Apple Style
           ============================================ */
        .theme-toggle {
            position: fixed;
            top: var(--space-4);
            right: var(--space-4);
            z-index: 10000; /* Above everything */
            width: 56px;
            height: 56px;
            border-radius: var(--radius-full);
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            box-shadow: var(--shadow-lg), inset 0 1px 1px rgba(255,255,255,0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            border: none;
        }

        .theme-toggle:hover {
            transform: scale(1.1) rotate(15deg);
            box-shadow: var(--shadow-xl), inset 0 1px 1px rgba(255,255,255,0.2);
        }

        .theme-toggle:active {
            transform: scale(0.95);
        }

        .theme-toggle__icon {
            position: absolute;
            width: 24px;
            height: 24px;
            color: var(--color-text-primary);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        /* Show sun icon in dark mode, moon in light mode */
        [data-theme="dark"] .theme-toggle__icon--light {
            opacity: 1;
            transform: rotate(0deg) scale(1);
        }

        [data-theme="dark"] .theme-toggle__icon--dark {
            opacity: 0;
            transform: rotate(180deg) scale(0);
        }

        :root .theme-toggle__icon--light,
        [data-theme="light"] .theme-toggle__icon--light {
            opacity: 0;
            transform: rotate(-180deg) scale(0);
        }

        :root .theme-toggle__icon--dark,
        [data-theme="light"] .theme-toggle__icon--dark {
            opacity: 1;
            transform: rotate(0deg) scale(1);
        }

        /* Mobile: Hide fixed toggle (using mobile-header toggle instead) */
        @media (max-width: 768px) {
            .theme-toggle {
                display: none;  /* Hidden on mobile - using mobile-header__theme-toggle */
            }
        }

        /* Tablet: Medium-sized toggle button */
        @media (max-width: 1024px) and (min-width: 769px) {
            .theme-toggle {
                width: 52px;
                height: 52px;
            }
        }


        [data-theme="dark"] .mobile-header__icon:active {
            background: rgba(255, 255, 255, 0.1);
        }

        .mobile-header__badge {
            position: absolute;
            top: 4px;
            right: 4px;
            min-width: 18px;
            height: 18px;
            padding: 0 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-error);
            color: white;
            font-size: 10px;
            font-weight: var(--font-weight-semibold);
            border-radius: var(--radius-full);
            border: 2px solid var(--color-background);
        }

        /* Desktop: Header ausblenden */
        @media (min-width: 768px) {
            .mobile-header {
                display: none;
            }
        }

        /* ============================================
           üéØ FLOATING ACTION BUTTON (FAB)
           ============================================ */

        .fab {
            /* Position: Zentriert √ºber Bottom Nav */
            position: fixed;
            bottom: calc(80px + var(--space-4));
            left: 50%;
            transform: translateX(-50%);
            z-index: calc(var(--z-fixed) + 1);

            /* Layout */
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;

            /* Styling */
            background: var(--color-primary);
            color: white;
            border-radius: var(--radius-full);
            box-shadow: var(--shadow-xl), 0 0 0 4px var(--color-background);
            font-size: 28px;
            text-decoration: none;

            /* Interaction */
            cursor: pointer;
            transition: all var(--duration-base) var(--ease-spring);
        }

        .fab:hover {
            transform: translateX(-50%) scale(1.1);
            box-shadow: var(--shadow-2xl), 0 0 0 4px var(--color-background);
        }

        .fab:active {
            transform: translateX(-50%) scale(0.95);
        }

        .fab i {
            width: 28px;
            height: 28px;
            stroke-width: 3;
        }

        /* Desktop: FAB rechts unten */
        @media (min-width: 768px) {
            .fab {
                right: var(--space-6);
                left: auto;
                bottom: var(--space-6);
                transform: none;
            }

            .fab:hover {
                transform: scale(1.1);
            }

            .fab:active {
                transform: scale(0.95);
            }
        }

        /* ============================================
           üì± HERO SECTION - Mobile Optimized
           ============================================ */

        @media (max-width: 768px) {
            .hero {
                padding: var(--space-6) var(--space-4);
                text-align: center;
            }

            .hero__title {
                font-size: var(--font-size-3xl);
            }

            .hero__subtitle {
                font-size: var(--font-size-base);
                max-width: 90%;
                margin: 0 auto;
            }

            .hero__version {
                display: none;
            }
        }

        /* ============================================
           üé¥ HERO CARDS - Mobile 1-Spalten-Layout
           ============================================ */

        @media (max-width: 768px) {
            .hero-cards-grid {
                grid-template-columns: 1fr !important;
                gap: var(--space-4);
                padding: 0;
            }

            .hero-card {
                padding: var(--space-5);
            }

            .hero-card__header {
                flex-direction: row;
                align-items: center;
                gap: var(--space-3);
            }

            .hero-card__header i {
                width: 32px;
                height: 32px;
                flex-shrink: 0;
            }

            .hero-card__header h3 {
                font-size: var(--font-size-lg);
                margin-bottom: 0;
            }

            .hero-card__desc {
                font-size: var(--font-size-sm);
                margin: var(--space-2) 0;
            }

            .hero-card__actions {
                grid-template-columns: repeat(2, 1fr);
                gap: var(--space-2);
            }

            .quick-link {
                padding: var(--space-3);
                font-size: var(--font-size-sm);
            }
        }

        /* ============================================
           üß≠ BOTTOM NAVIGATION - Mobile Touch-Optimized
           ============================================ */

        @media (max-width: 768px) {
            .bottom-nav {
                padding: var(--space-4) var(--space-2);
                padding-bottom: calc(var(--space-4) + env(safe-area-inset-bottom));
            }

            .bottom-nav__item {
                min-width: 60px;
                min-height: 44px;
                padding: var(--space-2);
                gap: var(--space-1);
            }

            .bottom-nav__item i {
                width: 24px;
                height: 24px;
            }

            .bottom-nav__item span {
                font-size: 11px;
                font-weight: var(--font-weight-medium);
            }

            .bottom-nav__item--active {
                background: rgba(0, 122, 255, 0.15);
                font-weight: var(--font-weight-semibold);
            }

            [data-theme="dark"] .bottom-nav__item--active {
                background: rgba(0, 191, 255, 0.15);
            }

            .bottom-nav__item:active {
                transform: scale(0.92);
            }
        }

        /* ============================================
           üì¶ CONTAINER - Mobile Spacing
           ============================================ */

        @media (max-width: 768px) {
            .container {
                padding: var(--space-4);
                padding-bottom: calc(120px + var(--space-4));
            }

            .welcome-banner {
                padding: var(--space-4);
                margin-bottom: var(--space-4);
            }

            .welcome-banner__icon {
                width: 36px;
                height: 36px;
            }

            .welcome-banner h2 {
                font-size: var(--font-size-xl);
            }

            .welcome-banner p {
                font-size: var(--font-size-sm);
            }
        }

        /* ============================================
           ‚ôø BARRIEREFREIHEIT - Reduced Motion
           ============================================ */

        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }

            .accent-light {
                animation: none;
                opacity: 0.3;
            }

            .shine-overlay {
                display: none;
            }

            .page-transition-overlay {
                display: none !important;
            }

            .fab:hover,
            .fab:active {
                transform: translateX(-50%) !important;
            }

            @media (min-width: 768px) {
                .fab:hover,
                .fab:active {
                    transform: none !important;
                }
            }
        }
    </style>
</head>
<body class="has-ai-features">
    <!-- üì± MOBILE HEADER - Sticky Top (Mobile Only) -->
    <header class="mobile-header">
        <div class="mobile-header__logo">
            <i data-feather="zap"></i>
            <span>Fahrzeugannahme</span>
        </div>
        <div class="mobile-header__actions">
            <!-- Dark Mode Toggle (Mobile Only) -->
            <button
                id="mobile-theme-toggle"
                class="mobile-header__icon mobile-header__theme-toggle"
                aria-label="Dunklen Modus aktivieren"
                aria-pressed="false"
                title="Theme wechseln">
                <i data-feather="sun" class="theme-icon theme-icon--light" aria-hidden="true"></i>
                <i data-feather="moon" class="theme-icon theme-icon--dark" aria-hidden="true"></i>
            </button>

            <!-- Benachrichtigungs-Badge -->
            <button class="mobile-header__icon" aria-label="Benachrichtigungen">
                <i data-feather="bell"></i>
                <span class="mobile-header__badge">3</span>
            </button>
        </div>
    </header>

    <!-- THEME TOGGLE BUTTON - Fixed Top-Right (Fully Accessible) -->
    <button
        id="dark-mode-toggle"
        class="theme-toggle"
        type="button"
        aria-label="Dunklen Modus aktivieren"
        aria-pressed="false"
        title="Theme wechseln (Cmd+Shift+D)">
        <span class="sr-only" aria-live="polite" aria-atomic="true">
            Aktuelles Theme: Hell
        </span>
        <i data-feather="sun" class="theme-toggle__icon theme-toggle__icon--light" aria-hidden="true"></i>
        <i data-feather="moon" class="theme-toggle__icon theme-toggle__icon--dark" aria-hidden="true"></i>
    </button>

    <!-- APPLE UX FEATURE 1: Accent-Light (Parallax-f√§hig) -->
    <div class="accent-light"></div>

    <!-- APPLE UX FEATURE 2: Page Transition Overlay -->
    <div class="page-transition-overlay"></div>

    <!-- SVG Gradient Definition for Icons -->
    <svg width="0" height="0" style="position: absolute;">
        <defs>
            <linearGradient id="iconGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#00bfff;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#66d9ff;stop-opacity:1" />
            </linearGradient>
        </defs>
    </svg>

    <!-- Hero Section -->
    <div class="hero">
        <!-- Werkstatt Logo (dynamisch geladen) -->
        <div id="werkstattLogo" style="text-align: center; margin-bottom: 20px;"></div>

        <h1 class="hero__title">Fahrzeugannahme-App</h1>
        <p class="hero__subtitle">Fahrzeuge erfassen in unter 2 Minuten</p>
        <div class="hero__version">Version 2.0 - Premium Dark Glass Edition</div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Welcome Banner -->
        <div class="welcome-banner">
            <div class="welcome-banner__icon">
                <i data-feather="zap"></i>
            </div>
            <div class="welcome-banner__content">
                <h2 id="welcomeTitle">Willkommen im Dashboard</h2>
                <p id="welcomeSubtitle">Verwalten Sie Fahrzeuge, Kunden und Partner-Anfragen professionell und effizient</p>
                <div id="userActions" style="display: none; margin-top: 10px; gap: 10px; flex-wrap: wrap;">
                    <button id="btnSwitchUser" style="padding: 8px 16px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: var(--color-text-secondary); cursor: pointer; font-size: 14px; transition: all 0.2s;">
                        üîÑ Benutzer wechseln
                    </button>
                    <button id="btnLogout" style="padding: 8px 16px; background: rgba(255,0,0,0.1); border: 1px solid rgba(255,0,0,0.3); border-radius: 8px; color: rgba(255,100,100,0.9); cursor: pointer; font-size: 14px; transition: all 0.2s;">
                        üì§ Abmelden
                    </button>
                </div>

                <!-- üÜï Admin/Werkstatt Actions (NUR f√ºr Stage 1 - Admin/Werkstatt) -->
                <div id="adminActions" style="display: none; margin-top: 15px; padding: 15px; background: rgba(255,152,0,0.1); border: 1px solid rgba(255,152,0,0.3); border-radius: 10px;">
                    <div style="font-size: 14px; font-weight: 600; color: var(--color-text-primary); margin-bottom: 10px;">
                        ‚öôÔ∏è Admin-Bereich
                    </div>
                    <!-- üßπ Session Cleanup Button (Admin-Only) -->
                    <button onclick="cleanupAllStaleSessions()" style="width: 100%; padding: 12px; background: rgba(255,152,0,0.15); border: 1px solid rgba(255,152,0,0.4); border-radius: 8px; color: rgba(255,152,0,1); font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        üßπ Stale Sessions aufr√§umen
                    </button>
                </div>

                <!-- üÜï Phase 2.1 & 2.2: Mitarbeiter-spezifische Aktionen -->
                <div id="mitarbeiterActions" style="display: none; margin-top: 15px; padding: 15px; background: rgba(52, 199, 89, 0.1); border: 1px solid rgba(52, 199, 89, 0.3); border-radius: 10px;">
                    <div style="font-size: 14px; font-weight: 600; color: var(--color-text-primary); margin-bottom: 10px;">
                        üë§ Mitarbeiter-Bereich
                    </div>
                    <button onclick="openUrlaubAnfrageModal()" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #34c759, #28a745); border: none; border-radius: 8px; color: white; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 10px;">
                        üèñÔ∏è Urlaub anfragen
                    </button>
                    <!-- üÜï Phase 2.2: Dienstplan-Link -->
                    <button onclick="safeNavigate('dienstplan.html')" style="width: 100%; padding: 12px; background: linear-gradient(135deg, #007aff, #0051d5); border: none; border-radius: 8px; color: white; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        üìÖ Dienstplan ansehen
                    </button>
                </div>

                <!-- Active Mitarbeiter List (Multi-Tab Monitoring) -->
                <div id="activeMitarbeiterSection" style="display: none; margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
                    <div style="font-size: 14px; color: var(--color-text-secondary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <span style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);"></span>
                        <span>Aktuell eingeloggte Mitarbeiter (<span id="activeMitarbeiterCount">0</span>):</span>
                    </div>
                    <div id="activeMitarbeiterList" style="font-size: 13px; line-height: 1.8; color: var(--color-text-primary);">
                        <!-- Dynamically filled by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Core Features -->
        <h2 class="section-title">Hauptfunktionen</h2>
        <div class="hero-cards-grid">
            <!-- GRUPPE 1: Fahrzeug-Management -->
            <div class="hero-card hero-card--primary">
                <!-- APPLE UX FEATURE 4: Shine Overlay -->
                <div class="shine-overlay"></div>
                <div class="hero-card__header">
                    <i data-feather="truck"></i>
                    <h3>Fahrzeug-Management</h3>
                    <span class="badge badge--count" id="badge-fahrzeuge">0 offen</span>
                </div>
                <p class="hero-card__desc">Erfassen, √ºbergeben & verwalten</p>

                <div class="hero-card__actions">
                    <a href="annahme.html" class="quick-link" data-permission="annahme">
                        <i data-feather="file-plus"></i>
                        <span>Annahme</span>
                    </a>
                    <a href="entwuerfe-bearbeiten.html" class="quick-link" data-permission="annahme" style="position: relative;">
                        <i data-feather="edit"></i>
                        <span>Entw√ºrfe</span>
                        <span id="entwuerfeBadge" class="badge badge--warning" style="display: none; position: absolute; top: -5px; right: -5px; font-size: 10px; padding: 2px 6px; border-radius: 10px; background: #ffc107; color: #000;">0</span>
                    </a>
                    <a href="abnahme.html" class="quick-link" data-permission="abnahme">
                        <i data-feather="check-circle"></i>
                        <span>Abnahme</span>
                    </a>
                    <a href="liste.html" class="quick-link" data-permission="liste">
                        <i data-feather="list"></i>
                        <span>√úbersicht</span>
                    </a>
                </div>
            </div>

            <!-- GRUPPE 2: Prozess-√úberwachung -->
            <div class="hero-card">
                <!-- APPLE UX FEATURE 4: Shine Overlay -->
                <div class="shine-overlay"></div>
                <div class="hero-card__header">
                    <i data-feather="activity"></i>
                    <h3>Prozess-√úberwachung</h3>
                    <span class="badge badge--warning" id="badge-prozess">0 in Arbeit</span>
                </div>
                <p class="hero-card__desc">Kanban Board & Kundenverwaltung</p>

                <div class="hero-card__actions">
                    <a href="kanban.html" class="quick-link" data-permission="kanban">
                        <i data-feather="trello"></i>
                        <span>Kanban</span>
                    </a>
                    <a href="kunden.html" class="quick-link" data-permission="kunden">
                        <i data-feather="users"></i>
                        <span>Kunden</span>
                    </a>
                </div>
            </div>

            <!-- GRUPPE 3: Organisation & Partner -->
            <div class="hero-card">
                <!-- APPLE UX FEATURE 4: Shine Overlay -->
                <div class="shine-overlay"></div>
                <div class="hero-card__header">
                    <i data-feather="briefcase"></i>
                    <h3>Organisation & Partner</h3>
                    <span class="badge badge--info" id="badge-partner">0 Anfragen</span>
                </div>
                <p class="hero-card__desc">Termine, Material & Partner-Anfragen</p>

                <div class="hero-card__actions">
                    <a href="kalender.html" class="quick-link" data-permission="kalender">
                        <i data-feather="calendar"></i>
                        <span>Kalender</span>
                    </a>
                    <a href="material.html" class="quick-link" data-permission="material">
                        <i data-feather="package"></i>
                        <span>Material</span>
                    </a>
                    <a href="mitarbeiter-dienstplan.html" class="quick-link" data-permission="dienstplan">
                        <i data-feather="clock"></i>
                        <span>Dienstplan</span>
                    </a>
                    <a href="partner-app/admin-anfragen.html" class="quick-link" data-permission="partnerAnfragen">
                        <i data-feather="mail"></i>
                        <span>Partner</span>
                    </a>
                    <a href="partner-landing.html" class="quick-link" data-permission="partnerPortal">
                        <i data-feather="link"></i>
                        <span>Portal</span>
                    </a>
                    <a href="wissensdatenbank.html" class="quick-link" data-permission="wissensdatenbank">
                        <i data-feather="book-open"></i>
                        <span>Wissen</span>
                    </a>
                </div>
            </div>

            <!-- GRUPPE 3.5: Steuerberater & Bilanz -->
            <div class="hero-card">
                <!-- APPLE UX FEATURE: Shine Overlay -->
                <div class="shine-overlay"></div>
                <div class="hero-card__header">
                    <i data-feather="bar-chart-3"></i>
                    <h3>Steuerberater & Bilanz</h3>
                    <span class="badge badge--success" id="badge-bilanz">Jahresabschluss 2025</span>
                </div>
                <p class="hero-card__desc">Finanzdaten, Statistiken & Export f√ºr Steuerberater</p>

                <!-- Quick Links -->
                <div class="hero-card__actions">
                    <a href="steuerberater-bilanz.html" class="quick-link" data-permission="steuerberaterBilanz">
                        <i data-feather="pie-chart"></i>
                        <span>Bilanz-√úbersicht</span>
                    </a>
                    <a href="steuerberater-statistiken.html" class="quick-link" data-permission="steuerberaterStatistiken">
                        <i data-feather="trending-up"></i>
                        <span>Statistiken</span>
                    </a>
                    <a href="steuerberater-kosten.html" class="quick-link" data-permission="steuerberaterKosten">
                        <i data-feather="layers"></i>
                        <span>Kostenaufschl√ºsselung</span>
                    </a>
                    <a href="steuerberater-export.html" class="quick-link" data-permission="steuerberaterExport">
                        <i data-feather="download"></i>
                        <span>Export & Berichte</span>
                    </a>
                </div>
            </div>

            <!-- GRUPPE 4: Admin-Funktionen -->
            <div class="hero-card">
                <!-- APPLE UX FEATURE 4: Shine Overlay -->
                <div class="shine-overlay"></div>
                <div class="hero-card__header">
                    <i data-feather="shield"></i>
                    <h3>Admin-Funktionen</h3>
                    <span class="badge badge--info">Berechtigungen</span>
                </div>
                <p class="hero-card__desc">Verwaltung & Berechtigungen</p>

                <div class="hero-card__actions">
                    <a href="admin-dashboard.html" class="quick-link" data-permission="adminDashboard">
                        <i data-feather="bar-chart-2"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="mitarbeiter-verwaltung.html" class="quick-link" data-permission="mitarbeiterVerwaltung">
                        <i data-feather="users"></i>
                        <span>Mitarbeiter</span>
                    </a>
                    <a href="admin-einstellungen.html" class="quick-link" data-permission="adminEinstellungen">
                        <i data-feather="sliders"></i>
                        <span>Einstellungen</span>
                    </a>
                    <a href="nutzer-verwaltung.html" class="quick-link" data-permission="nutzerVerwaltung">
                        <i data-feather="user-check"></i>
                        <span>User-Verwaltung</span>
                    </a>
                    <a href="setup-werkstatt.html" class="quick-link" data-permission="setupWerkstatt">
                        <i data-feather="settings"></i>
                        <span>Werkstatt-Setup</span>
                    </a>
                </div>
            </div>

            <!-- GRUPPE 4.5: Bonus-Verwaltung (üÜï BUGFIX 2025-11-04 - FIX #22) -->
            <div class="hero-card">
                <!-- APPLE UX FEATURE 4: Shine Overlay -->
                <div class="shine-overlay"></div>
                <div class="hero-card__header">
                    <i data-feather="dollar-sign"></i>
                    <h3>Bonus-Verwaltung</h3>
                    <span class="badge badge--warning">Partner-Bonus</span>
                </div>
                <p class="hero-card__desc">Partner-Bonus-Auszahlungen verwalten</p>

                <div class="hero-card__actions">
                    <a href="admin-bonus-auszahlungen.html" class="quick-link" data-permission="adminDashboard">
                        <i data-feather="award"></i>
                        <span>Auszahlungen</span>
                    </a>
                </div>
            </div>

            <!-- GRUPPE 4.7: Rechnungsverwaltung (üÜï 2025-11-11) -->
            <div class="hero-card">
                <!-- APPLE UX FEATURE 4: Shine Overlay -->
                <div class="shine-overlay"></div>
                <div class="hero-card__header">
                    <i data-feather="file-text"></i>
                    <h3>Rechnungen</h3>
                    <span class="badge badge--warning" id="badge-rechnungen">0 offen</span>
                </div>
                <p class="hero-card__desc">Rechnungsverwaltung & Zahlungsstatus</p>

                <div class="hero-card__actions">
                    <a href="rechnungen-admin.html" class="quick-link" data-permission="rechnungen">
                        <i data-feather="file-text"></i>
                        <span>Alle Rechnungen</span>
                    </a>
                    <a href="rechnungen-admin.html?filter=offen" class="quick-link" data-permission="rechnungen">
                        <i data-feather="clock"></i>
                        <span>Offene</span>
                    </a>
                    <a href="rechnungen-admin.html?filter=ueberfaellig" class="quick-link" data-permission="rechnungen">
                        <i data-feather="alert-circle"></i>
                        <span>√úberf√§llig</span>
                    </a>
                </div>
            </div>

            <!-- GRUPPE 5: KI-Assistent (NEU - Phase 5) -->
            <div class="hero-card">
                <!-- APPLE UX FEATURE 4: Shine Overlay -->
                <div class="shine-overlay"></div>
                <div class="hero-card__header">
                    <i data-feather="cpu"></i>
                    <h3>KI-Assistent</h3>
                    <span class="badge badge--count">Beta</span>
                </div>
                <p class="hero-card__desc">Intelligente Unterst√ºtzung per Sprache</p>

                <div class="hero-card__actions">
                    <a href="#" onclick="if (window.aiChatWidget) { window.aiChatWidget.open(); } else { showToast('KI-Chat l√§dt noch... Bitte warten.', 'info'); } return false;" class="quick-link" data-permission="kiChat">
                        <i data-feather="message-circle"></i>
                        <span>Chat</span>
                    </a>
                    <a href="#" onclick="if (window.aiChatWidget) { window.aiChatWidget.open(); setTimeout(() => window.aiChatWidget.toggleVoice(), 300); } else { showToast('KI-Chat l√§dt noch... Bitte warten.', 'info'); } return false;" class="quick-link" data-permission="kiSprache">
                        <i data-feather="mic"></i>
                        <span>Sprache</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Primary CTA -->
        <div class="cta-section">
            <a href="annahme.html" class="btn-cta">
                <i data-feather="truck"></i>
                <span>üöó Neues Fahrzeug anlegen</span>
                <i data-feather="arrow-right"></i>
            </a>
        </div>

        <!-- Features Section -->
        <div class="features">
            <h3 class="features__title">Was kann diese App?</h3>
            <ul class="features__list">
                <li class="features__item">
                    <i data-feather="camera"></i>
                    <span>Fotos direkt mit Kamera aufnehmen</span>
                </li>
                <li class="features__item">
                    <i data-feather="edit-3"></i>
                    <span>Digitale Unterschrift des Kunden</span>
                </li>
                <li class="features__item">
                    <i data-feather="file-text"></i>
                    <span>Automatische PDF-Erstellung</span>
                </li>
                <li class="features__item">
                    <i data-feather="image"></i>
                    <span>Vorher/Nachher-Vergleich bei Abnahme</span>
                </li>
                <li class="features__item">
                    <i data-feather="trello"></i>
                    <span>Kanban Board f√ºr Produktions√ºbersicht</span>
                </li>
                <li class="features__item">
                    <i data-feather="users"></i>
                    <span>Kundenverwaltung mit Statistiken</span>
                </li>
                <li class="features__item">
                    <i data-feather="send"></i>
                    <span>Partner-Anfragen direkt bearbeiten</span>
                </li>
                <li class="features__item">
                    <i data-feather="wifi-off"></i>
                    <span>Funktioniert offline - kein Internet n√∂tig</span>
                </li>
                <li class="features__item">
                    <i data-feather="download"></i>
                    <span>Keine Installation erforderlich</span>
                </li>
                <li class="features__item">
                    <i data-feather="smartphone"></i>
                    <span>Mobile-optimiert f√ºr Tablet & Smartphone</span>
                </li>
            </ul>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>Ausf√ºhrliche Anleitung: <a href="README.md" target="_blank" class="footer__link">README √∂ffnen</a></p>
            <p class="footer__company">Auto-Lackierzentrum Mosbach | info@auto-lackierzentrum.de</p>
        </div>
    </div>

    <!-- üéØ FLOATING ACTION BUTTON - Neues Fahrzeug -->
    <a href="annahme.html" class="fab" aria-label="Neues Fahrzeug anlegen">
        <i data-feather="plus"></i>
    </a>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="index.html" class="bottom-nav__item bottom-nav__item--active">
            <i data-feather="home"></i>
            <span>Home</span>
        </a>
        <a href="annahme.html" class="bottom-nav__item">
            <i data-feather="file-plus"></i>
            <span>Annahme</span>
        </a>
        <a href="liste.html" class="bottom-nav__item">
            <i data-feather="list"></i>
            <span>√úbersicht</span>
        </a>
        <a href="kanban.html" class="bottom-nav__item">
            <i data-feather="trello"></i>
            <span>Kanban</span>
        </a>
    </nav>

    <!-- Initialize Feather Icons -->
    <script>
        feather.replace();
    </script>

    <!-- ============================================
         üé® APPLE UX FEATURES - JavaScript Implementation
         ============================================ -->
    <script>
        // ============================================
        // INLINE FALLBACK: safeNavigate (if listener-registry.js not loaded yet)
        // ============================================
        window.safeNavigate = window.safeNavigate || function(url) {
            console.log('‚ö†Ô∏è Using fallback safeNavigate:', url);
            setTimeout(() => {
                safeNavigate(url);
            }, 100);
        };

        // ============================================
        // FEATURE 1: Blur-Overlays beim Seitenwechsel
        // ============================================
        function initPageTransitions() {
            const overlay = document.querySelector('.page-transition-overlay');
            const internalLinks = document.querySelectorAll('a[href]:not([href^="http"]):not([href^="mailto"]):not([target="_blank"])');

            internalLinks.forEach(link => {
                const linkClickHandler = function(e) {
                    const href = link.getAttribute('href');

                    // Ignore # links and javascript: links
                    if (!href || href === '#' || href.startsWith('javascript:')) {
                        return;
                    }

                    e.preventDefault();

                    // Activate overlay
                    overlay.classList.add('active');

                    // Navigate after transition
                    setTimeout(() => {
                        safeNavigate(href);
                    }, 300);
                };
                window.listenerRegistry.registerDOM(link, 'click', linkClickHandler, `Navigation Link: ${link.getAttribute('href')}`);
            });

            console.log('‚úÖ Page Transitions initialized (' + internalLinks.length + ' links)');
        }

        // ============================================
        // FEATURE 2: Haptisches Feedback (nur Mobile)
        // ============================================
        function initHapticFeedback() {
            // Check if vibration API available and touch device
            const isTouch = window.matchMedia('(hover: none) and (pointer: coarse)').matches;
            const canVibrate = 'vibrate' in navigator;

            if (!canVibrate || !isTouch) {
                console.log('‚ÑπÔ∏è Haptic Feedback: Not available or not touch device');
                return;
            }

            // Debounce helper
            let lastVibration = 0;
            function vibrate(duration) {
                const now = Date.now();
                if (now - lastVibration > 100) { // Max 1x per 100ms
                    navigator.vibrate(duration);
                    lastVibration = now;
                }
            }

            // Hero-Cards: 10ms (leicht)
            document.querySelectorAll('.hero-card').forEach(card => {
                const cardTouchHandler = () => vibrate(10);
                window.listenerRegistry.registerDOM(card, 'touchstart', cardTouchHandler, 'Hero Card Haptic');
            });

            // Buttons/CTAs: 15ms (mittel)
            document.querySelectorAll('.btn, .btn-cta').forEach(btn => {
                const btnTouchHandler = () => vibrate(15);
                window.listenerRegistry.registerDOM(btn, 'touchstart', btnTouchHandler, 'Button Haptic');
            });

            // Bottom-Nav: 8ms (sehr leicht)
            document.querySelectorAll('.bottom-nav__item').forEach(item => {
                const navTouchHandler = () => vibrate(8);
                window.listenerRegistry.registerDOM(item, 'touchstart', navTouchHandler, 'Nav Item Haptic');
            });

            console.log('‚úÖ Haptic Feedback initialized (Touch device)');
        }

        // ============================================
        // FEATURE 3: Parallax Light beim Scrollen
        // ============================================
        function initParallaxLight() {
            const accentLight = document.querySelector('.accent-light');
            let ticking = false;

            function updateParallax() {
                const scrollY = window.scrollY || window.pageYOffset;
                const parallaxY = scrollY * 0.3; // 30% der Scroll-Distanz

                accentLight.style.transform = `translateY(${parallaxY}px)`;
                ticking = false;
            }

            const parallaxScrollHandler = function() {
                if (!ticking) {
                    requestAnimationFrame(updateParallax);
                    ticking = true;
                }
            };
            window.listenerRegistry.registerDOM(window, 'scroll', parallaxScrollHandler, 'Parallax Scroll');

            console.log('‚úÖ Parallax Light initialized');
        }

        // ============================================
        // FEATURE 4: Hero-Card Animations (Pulse + Shine)
        // ============================================
        function initHeroCardAnimations() {
            // Check if GSAP loaded
            if (typeof gsap === 'undefined') {
                console.warn('‚ö†Ô∏è GSAP not loaded - Hero-Card animations disabled');
                return;
            }

            document.querySelectorAll('.hero-card').forEach(card => {
                const shineOverlay = card.querySelector('.shine-overlay');

                const cardClickHandler = function(e) {
                    // Don't animate if clicking on a link
                    if (e.target.closest('a')) {
                        return;
                    }

                    // PULSE Animation (Scale)
                    gsap.timeline()
                        .to(card, {
                            scale: 0.95,
                            duration: 0.1,
                            ease: "power2.out"
                        })
                        .to(card, {
                            scale: 1.02,
                            duration: 0.15,
                            ease: "power2.out"
                        })
                        .to(card, {
                            scale: 1,
                            duration: 0.1,
                            ease: "power2.out"
                        });

                    // SHINE Animation (Light Sweep)
                    gsap.fromTo(shineOverlay,
                        { x: '-100%' },
                        {
                            x: '100%',
                            duration: 0.6,
                            ease: "power2.out"
                        }
                    );
                };
                window.listenerRegistry.registerDOM(card, 'click', cardClickHandler, 'Hero Card Animation');
            });

            console.log('‚úÖ Hero-Card Animations initialized (Pulse + Shine)');
        }

        // ============================================
        // Initialize all Apple UX Features on load
        // ============================================
        window.addEventListener('DOMContentLoaded', function() {
            initPageTransitions();
            initHapticFeedback();
            initParallaxLight();
            initHeroCardAnimations();

            console.log('üé® All Apple UX Features initialized!');
        });

        // ============================================
        // üì± FAB SCROLL HIDE/SHOW (Mobile)
        // ============================================
        function initFABScrollBehavior() {
            const fab = document.querySelector('.fab');
            if (!fab) return;

            let lastScrollY = window.scrollY;
            let ticking = false;

            function updateFAB() {
                const currentScrollY = window.scrollY;

                // Check if on mobile (< 768px)
                const isMobile = window.innerWidth < 768;

                if (isMobile) {
                    if (currentScrollY > lastScrollY && currentScrollY > 100) {
                        // Scrolling down - hide FAB
                        fab.style.transform = 'translateX(-50%) translateY(120px)';
                        fab.style.opacity = '0';
                        fab.style.pointerEvents = 'none';
                    } else {
                        // Scrolling up - show FAB
                        fab.style.transform = 'translateX(-50%) translateY(0)';
                        fab.style.opacity = '1';
                        fab.style.pointerEvents = 'auto';
                    }
                } else {
                    // Desktop: Always visible
                    fab.style.transform = 'none';
                    fab.style.opacity = '1';
                    fab.style.pointerEvents = 'auto';
                }

                lastScrollY = currentScrollY;
                ticking = false;
            }

            const fabScrollHandler = () => {
                if (!ticking) {
                    window.requestAnimationFrame(updateFAB);
                    ticking = true;
                }
            };
            window.listenerRegistry.registerDOM(window, 'scroll', fabScrollHandler, 'FAB Scroll Handler');

            // Update on resize
            window.listenerRegistry.registerDOM(window, 'resize', updateFAB, 'FAB Resize Handler');

            console.log('‚úÖ FAB Scroll Behavior initialized');
        }

        // Initialize FAB on load
        document.addEventListener('DOMContentLoaded', () => {
            initFABScrollBehavior();
        });

        // ============================================
        // üåì LIGHT/DARK MODE TOGGLE
        // ============================================
        (function initThemeToggle() {
            const themeToggle = document.getElementById('dark-mode-toggle');
            const mobileThemeToggle = document.getElementById('mobile-theme-toggle');
            const html = document.documentElement;

            // Function to update Accessibility Attributes (both buttons)
            function updateAccessibility(theme) {
                // Update Desktop Toggle
                const toggleButton = document.getElementById('dark-mode-toggle');
                if (toggleButton) {
                    toggleButton.setAttribute('aria-pressed', theme === 'dark' ? 'true' : 'false');
                    toggleButton.setAttribute('aria-label',
                        theme === 'dark' ? 'Hellen Modus aktivieren' : 'Dunklen Modus aktivieren'
                    );
                    const srText = toggleButton.querySelector('.sr-only');
                    if (srText) {
                        srText.textContent = `Aktuelles Theme: ${theme === 'dark' ? 'Dunkel' : 'Hell'}`;
                    }
                }

                // Update Mobile Toggle
                const mobileToggle = document.getElementById('mobile-theme-toggle');
                if (mobileToggle) {
                    mobileToggle.setAttribute('aria-pressed', theme === 'dark' ? 'true' : 'false');
                    mobileToggle.setAttribute('aria-label',
                        theme === 'dark' ? 'Hellen Modus aktivieren' : 'Dunklen Modus aktivieren'
                    );
                }

                console.log(`‚ôø Accessibility attributes updated for ${theme} mode`);
            }

            // Function to update Theme Toggle Button Icons stroke-width only
            function updateThemeToggleIcons(theme) {
                const strokeWidth = theme === 'light' ? '2.5' : '2';

                // Update ONLY Theme Toggle Button Icons (not all icons on page!)
                const toggleButton = document.getElementById('dark-mode-toggle');
                if (toggleButton) {
                    toggleButton.querySelectorAll('svg *[stroke]').forEach(element => {
                        element.setAttribute('stroke-width', strokeWidth);
                    });
                    console.log(`üé® Theme Toggle Icons stroke-width updated to ${strokeWidth} for ${theme} mode`);
                } else {
                    console.warn('‚ö†Ô∏è Theme toggle button not found - cannot update icon stroke-width');
                }
            }

            // Get current theme (already set in <head> for FOUC prevention)
            let currentTheme = html.getAttribute('data-theme') || 'light';
            console.log(`üåì Theme initialized: ${currentTheme} (from <head> pre-load)`);

            // Toggle theme on button click
            const themeToggleHandler = () => {
                currentTheme = currentTheme === 'light' ? 'dark' : 'light';
                html.setAttribute('data-theme', currentTheme);
                localStorage.setItem('theme', currentTheme);

                console.log(`üåì Theme switched to: ${currentTheme}`);

                // Update accessibility attributes
                updateAccessibility(currentTheme);

                // Re-initialize Feather Icons for theme change
                if (typeof feather !== 'undefined') {
                    feather.replace();
                    // Wait for feather.replace() to finish, then update stroke-width
                    setTimeout(() => updateThemeToggleIcons(currentTheme), 50);
                }
            };

            // Register Desktop theme toggle with safe access pattern (BUGFIX 2025-11-04: Race condition)
            if (themeToggle) {
                if (window.listenerRegistry?.registerDOM) {
                    window.listenerRegistry.registerDOM(themeToggle, 'click', themeToggleHandler, 'Theme Toggle Button (Desktop)');
                } else {
                    themeToggle.addEventListener('click', themeToggleHandler);
                    console.warn('‚ö†Ô∏è listenerRegistry not available for desktop theme toggle, using native addEventListener');
                }
            }

            // Register Mobile theme toggle
            if (mobileThemeToggle) {
                if (window.listenerRegistry?.registerDOM) {
                    window.listenerRegistry.registerDOM(mobileThemeToggle, 'click', themeToggleHandler, 'Theme Toggle Button (Mobile)');
                } else {
                    mobileThemeToggle.addEventListener('click', themeToggleHandler);
                    console.warn('‚ö†Ô∏è listenerRegistry not available for mobile theme toggle, using native addEventListener');
                }
            }

            // Keyboard Shortcut: Cmd+Shift+D (Mac) or Ctrl+Shift+D (Windows/Linux)
            const keyboardShortcutHandler = (e) => {
                const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
                const modifierKey = isMac ? e.metaKey : e.ctrlKey;

                if (modifierKey && e.shiftKey && e.key.toLowerCase() === 'd') {
                    e.preventDefault(); // Prevent browser default behavior
                    themeToggleHandler();
                    console.log('‚å®Ô∏è Theme toggled via keyboard shortcut');
                }
            };

            if (window.listenerRegistry?.registerDOM) {
                window.listenerRegistry.registerDOM(document, 'keydown', keyboardShortcutHandler, 'Theme Keyboard Shortcut');
            } else {
                document.addEventListener('keydown', keyboardShortcutHandler);
                console.warn('‚ö†Ô∏è listenerRegistry not available for keyboard shortcut, using native addEventListener');
            }

            // Initialize accessibility attributes
            updateAccessibility(currentTheme);

            // Initialize Feather Icons on load
            if (typeof feather !== 'undefined') {
                feather.replace();
                // Wait for feather.replace() to finish, then update stroke-width
                setTimeout(() => {
                    updateThemeToggleIcons(currentTheme);
                    console.log('‚úÖ Theme Toggle Icons initialized');
                }, 50);
            }
        })();
    </script>

    <!-- GSAP Premium Animations -->
    <script>
        // Firebase Status Badges Update
        async function updateStatusBadges() {
            try {
                if (typeof firebaseApp !== 'undefined' && firebaseApp.getAllFahrzeuge) {
                    const fahrzeuge = await firebaseApp.getAllFahrzeuge();

                    // Z√§hle offene Fahrzeuge
                    const offen = fahrzeuge.filter(f => f.status !== 'abgeschlossen').length;
                    document.getElementById('badge-fahrzeuge').textContent = `${offen} offen`;

                    // Z√§hle in Arbeit
                    const inArbeit = fahrzeuge.filter(f => f.prozessStatus && f.prozessStatus !== 'angenommen' && f.status !== 'abgeschlossen').length;
                    document.getElementById('badge-prozess').textContent = `${inArbeit} in Arbeit`;

                    // Z√§hle offene Partner-Anfragen
                    const anfrageCollection = window.getCollection('partnerAnfragen');
                    const anfrageSnapshot = await anfrageCollection.where('status', '==', 'pending').get();
                    const offeneAnfragen = anfrageSnapshot.size;
                    document.getElementById('badge-partner').textContent = `${offeneAnfragen} Anfragen`;

                    // üÜï Z√§hle offene Entw√ºrfe
                    const entwuerfeSnapshot = await anfrageCollection
                        .where('isEntwurf', '==', true)
                        .where('entwurfStatus', '==', 'offen')
                        .get();
                    const offeneEntwuerfe = entwuerfeSnapshot.size;
                    const entwuerfeBadge = document.getElementById('entwuerfeBadge');
                    if (offeneEntwuerfe > 0) {
                        entwuerfeBadge.textContent = offeneEntwuerfe;
                        entwuerfeBadge.style.display = 'inline-block';
                    } else {
                        entwuerfeBadge.style.display = 'none';
                    }

                    console.log('‚úÖ Status-Badges aktualisiert:', { offen, inArbeit, offeneAnfragen, offeneEntwuerfe });
                } else {
                    // Fallback: Verwende LocalStorage
                    const fahrzeuge = JSON.parse(localStorage.getItem('fahrzeuge') || '[]');
                    const offen = fahrzeuge.filter(f => f.status !== 'abgeschlossen').length;
                    const inArbeit = fahrzeuge.filter(f => f.prozessStatus && f.prozessStatus !== 'angenommen' && f.status !== 'abgeschlossen').length;

                    const partnerAnfragen = JSON.parse(localStorage.getItem('partnerAnfragen') || '[]');
                    const offeneAnfragen = partnerAnfragen.filter(a => a.status === 'pending').length;

                    // üÜï Z√§hle offene Entw√ºrfe (LocalStorage Fallback)
                    const offeneEntwuerfe = partnerAnfragen.filter(a => a.isEntwurf === true && a.entwurfStatus === 'offen').length;
                    const entwuerfeBadge = document.getElementById('entwuerfeBadge');
                    if (offeneEntwuerfe > 0) {
                        entwuerfeBadge.textContent = offeneEntwuerfe;
                        entwuerfeBadge.style.display = 'inline-block';
                    } else {
                        entwuerfeBadge.style.display = 'none';
                    }

                    document.getElementById('badge-fahrzeuge').textContent = `${offen} offen`;
                    document.getElementById('badge-prozess').textContent = `${inArbeit} in Arbeit`;
                    document.getElementById('badge-partner').textContent = `${offeneAnfragen} Anfragen`;
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Status-Badges konnten nicht aktualisiert werden:', error);
                // Behalte Dummy-Werte
            }
        }

        // Wait for ALL resources (including GSAP CDN) to load
        window.addEventListener('load', async function() {

            // Update Status Badges
            await updateStatusBadges();

            // Check if GSAP loaded successfully
            if (typeof gsap === 'undefined') {
                console.warn('‚ö†Ô∏è GSAP not loaded - animations disabled, but page works!');
                return;
            }

            // Fade-in body on page load
            gsap.fromTo("body",
                { opacity: 0 },
                { opacity: 1, duration: 0.6, ease: "power2.out" }
            );

            // Hero section entrance
            gsap.fromTo(".hero",
                { opacity: 0, y: 20 },
                { opacity: 1, y: 0, duration: 0.8, delay: 0.2, ease: "power2.out" }
            );

            // Hero title pulse (subtle, continuous)
            gsap.to(".hero__title", {
                textShadow: "0 0 20px rgba(0,191,255,0.4)",
                duration: 2,
                repeat: -1,
                yoyo: true,
                ease: "sine.inOut"
            });

            // Welcome Banner entrance
            gsap.fromTo(".welcome-banner",
                { opacity: 0, scale: 0.95, y: 20 },
                { opacity: 1, scale: 1, y: 0, duration: 0.8, delay: 0.3, ease: "back.out(1.2)" }
            );

            // Stagger animation for hero cards
            gsap.fromTo(".hero-card",
                // FROM: Start-Werte
                {
                    opacity: 0,
                    scale: 0.9,
                    y: 30
                },
                // TO: Explizite Ziel-Werte
                {
                    opacity: 1,
                    scale: 1,
                    y: 0,
                    duration: 0.7,
                    stagger: 0.15,
                    delay: 0.5,
                    ease: "back.out(1.4)",
                    onComplete: function() {
                        // Markiere Cards als animiert
                        document.querySelectorAll('.hero-card').forEach(card => {
                            card.classList.add('gsap-animated');
                        });
                    }
                }
            );

            // CTA Button entrance
            gsap.fromTo(".btn-cta",
                { opacity: 0, scale: 0.8, y: 20 },
                { opacity: 1, scale: 1, y: 0, duration: 0.6, delay: 1.2, ease: "back.out(1.7)" }
            );

            // Features section entrance
            gsap.fromTo(".features",
                { opacity: 0, y: 30 },
                { opacity: 1, y: 0, duration: 0.8, delay: 1.5, ease: "power2.out" }
            );

            // Features items stagger
            gsap.fromTo(".features__item",
                { opacity: 0, x: -20 },
                { opacity: 1, x: 0, duration: 0.5, stagger: 0.05, delay: 1.7, ease: "power2.out" }
            );

            // Bottom nav entrance
            gsap.fromTo(".bottom-nav",
                { y: 100, opacity: 0 },
                { y: 0, opacity: 1, duration: 0.6, delay: 0.8, ease: "power2.out" }
            );

            // Hover animations for hero cards
            document.querySelectorAll('.hero-card').forEach(card => {
                const cardMouseEnter = function() {
                    gsap.to(card, {
                        y: -8,
                        boxShadow: "inset 0 1px 1px rgba(255,255,255,0.25), 0 0 50px rgba(0,191,255,0.4), 0 16px 48px rgba(0,0,0,0.45)",
                        duration: 0.3,
                        ease: "power2.out"
                    });
                };
                const cardMouseLeave = function() {
                    gsap.to(card, {
                        y: 0,
                        boxShadow: "inset 0 1px 1px rgba(255,255,255,0.2), 0 8px 32px rgba(0,0,0,0.35)",
                        duration: 0.3,
                        ease: "power2.out"
                    });
                };
                window.listenerRegistry.registerDOM(card, 'mouseenter', cardMouseEnter, 'Hero Card Hover Enter');
                window.listenerRegistry.registerDOM(card, 'mouseleave', cardMouseLeave, 'Hero Card Hover Leave');
            });

            // Hover animations for quick links
            document.querySelectorAll('.quick-link').forEach(link => {
                const linkMouseEnter = function() {
                    gsap.to(link, {
                        scale: 1.08,
                        boxShadow: "0 0 20px rgba(0,191,255,0.4)",
                        duration: 0.2,
                        ease: "power2.out"
                    });
                };
                const linkMouseLeave = function() {
                    gsap.to(link, {
                        scale: 1,
                        boxShadow: "none",
                        duration: 0.2,
                        ease: "power2.out"
                    });
                };
                window.listenerRegistry.registerDOM(link, 'mouseenter', linkMouseEnter, 'Quick Link Hover Enter');
                window.listenerRegistry.registerDOM(link, 'mouseleave', linkMouseLeave, 'Quick Link Hover Leave');
            });

            // Bottom nav item hover
            document.querySelectorAll('.bottom-nav__item').forEach(item => {
                const navMouseEnter = function() {
                    if (!item.classList.contains('bottom-nav__item--active')) {
                        gsap.to(item, {
                            scale: 1.1,
                            y: -3,
                            duration: 0.2,
                            ease: "power2.out"
                        });
                    }
                };
                const navMouseLeave = function() {
                    if (!item.classList.contains('bottom-nav__item--active')) {
                        gsap.to(item, {
                            scale: 1,
                            y: 0,
                            duration: 0.2,
                            ease: "power2.out"
                        });
                    }
                };
                window.listenerRegistry.registerDOM(item, 'mouseenter', navMouseEnter, 'Bottom Nav Hover Enter');
                window.listenerRegistry.registerDOM(item, 'mouseleave', navMouseLeave, 'Bottom Nav Hover Leave');
            });
        });
    </script>

    <!-- LOGIN MODAL (Firebase Auth) -->
    <div id="loginModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 100000; padding: 20px; overflow-y: auto;">
        <div style="max-width: 500px; margin: 100px auto; background: var(--color-surface); border-radius: 16px; padding: 40px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); backdrop-filter: blur(25px);">
            <!-- Header -->
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, var(--color-primary), var(--color-primary-hover)); border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 40px;">
                    üîê
                </div>
                <h2 style="color: var(--color-text-primary); margin: 0 0 10px 0; font-size: 28px; font-weight: 700;">Anmelden</h2>
                <p style="color: var(--color-text-secondary); margin: 0; font-size: 14px;">Bitte melden Sie sich mit Ihren Zugangsdaten an</p>
            </div>

            <!-- Login Form -->
            <form id="loginForm" onsubmit="login(event)">
                <!-- Email -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--color-text-secondary); font-size: 14px; font-weight: 600;">üìß E-Mail</label>
                    <input
                        type="email"
                        id="loginEmail"
                        required
                        placeholder="ihre.email@beispiel.de"
                        style="width: 100%; padding: 14px; border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; background: rgba(255,255,255,0.05); color: var(--color-text-primary); font-size: 16px; transition: all 0.2s;"
                        onfocus="this.style.borderColor='var(--color-primary)'"
                        onblur="this.style.borderColor='rgba(255,255,255,0.2)'">
                </div>

                <!-- Password -->
                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--color-text-secondary); font-size: 14px; font-weight: 600;">üîë Passwort</label>
                    <input
                        type="password"
                        id="loginPassword"
                        required
                        placeholder="Passwort eingeben"
                        style="width: 100%; padding: 14px; border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; background: rgba(255,255,255,0.05); color: var(--color-text-primary); font-size: 16px; transition: all 0.2s;"
                        onfocus="this.style.borderColor='var(--color-primary)'"
                        onblur="this.style.borderColor='rgba(255,255,255,0.2)'">
                </div>

                <!-- Error Message -->
                <div id="loginError" style="display: none; background: rgba(255, 59, 48, 0.1); border: 1px solid rgba(255, 59, 48, 0.3); border-radius: 8px; padding: 12px; color: #ff3b30; font-size: 14px; margin-bottom: 20px;"></div>

                <!-- Login Button -->
                <button
                    type="submit"
                    id="loginBtn"
                    style="width: 100%; padding: 16px; background: linear-gradient(135deg, var(--color-primary), var(--color-primary-hover)); border: none; border-radius: 10px; color: white; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <i data-feather="log-in"></i>
                    Anmelden
                </button>
            </form>

            <!-- Alternative Actions -->
            <div style="margin-top: 20px; text-align: center; font-size: 14px; color: var(--color-text-secondary);">
                <p style="margin: 10px 0;">
                    Noch kein Account?
                    <a href="registrierung.html" style="color: var(--color-primary); text-decoration: none; font-weight: 600;">Jetzt registrieren</a>
                </p>
            </div>
        </div>
    </div>

    <!-- MITARBEITER AUSWAHL MODAL (Stage 2 Login) -->
    <div id="mitarbeiterModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 100001; padding: 20px; overflow-y: auto;">
        <div style="max-width: 500px; margin: 100px auto; background: var(--color-surface); border-radius: 16px; padding: 40px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); backdrop-filter: blur(25px);">
            <!-- Header -->
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, var(--color-primary), var(--color-primary-hover)); border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 40px;">
                    üë§
                </div>
                <h2 style="color: var(--color-text-primary); margin: 0 0 10px 0; font-size: 28px; font-weight: 700;">Mitarbeiter ausw√§hlen</h2>
                <p style="color: var(--color-text-secondary); margin: 0; font-size: 14px;">Bitte w√§hlen Sie Ihren Mitarbeiter-Account</p>
            </div>

            <!-- Mitarbeiter Selection Form -->
            <form id="mitarbeiterForm" onsubmit="submitMitarbeiterLogin(event)">
                <!-- Mitarbeiter Dropdown -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--color-text-secondary); font-size: 14px; font-weight: 600;">üë§ Mitarbeiter</label>
                    <select
                        id="mitarbeiterSelect"
                        required
                        style="width: 100%; padding: 14px; border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; background: rgba(255,255,255,0.05); color: var(--color-text-primary); font-size: 16px; transition: all 0.2s; cursor: pointer;"
                        onfocus="this.style.borderColor='var(--color-primary)'"
                        onblur="this.style.borderColor='rgba(255,255,255,0.2)'">
                        <option value="" disabled selected>Mitarbeiter ausw√§hlen...</option>
                    </select>
                </div>

                <!-- Password -->
                <div style="margin-bottom: 25px;">
                    <label style="display: block; margin-bottom: 8px; color: var(--color-text-secondary); font-size: 14px; font-weight: 600;">üîë Passwort</label>
                    <input
                        type="password"
                        id="mitarbeiterPassword"
                        required
                        placeholder="Mitarbeiter-Passwort eingeben"
                        style="width: 100%; padding: 14px; border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; background: rgba(255,255,255,0.05); color: var(--color-text-primary); font-size: 16px; transition: all 0.2s;"
                        onfocus="this.style.borderColor='var(--color-primary)'"
                        onblur="this.style.borderColor='rgba(255,255,255,0.2)'">
                </div>

                <!-- Error Message -->
                <div id="mitarbeiterError" style="display: none; background: rgba(255, 59, 48, 0.1); border: 1px solid rgba(255, 59, 48, 0.3); border-radius: 8px; padding: 12px; color: #ff3b30; font-size: 14px; margin-bottom: 20px;"></div>

                <!-- Test-Daten Button (nur anzeigen wenn keine Mitarbeiter) -->
                <div id="testDataButtonContainer" style="display: none; margin-bottom: 20px;">
                    <button
                        type="button"
                        onclick="createTestMitarbeiterFromModal()"
                        style="width: 100%; padding: 14px; background: rgba(52, 199, 89, 0.15); border: 2px solid rgba(52, 199, 89, 0.4); border-radius: 10px; color: #34c759; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px;"
                        onmouseover="this.style.background='rgba(52, 199, 89, 0.25)'"
                        onmouseout="this.style.background='rgba(52, 199, 89, 0.15)'">
                        <i data-feather="users"></i>
                        üß™ 3 Test-Mitarbeiter erstellen (Passwort: 1234)
                    </button>
                </div>

                <!-- Login Button -->
                <button
                    type="submit"
                    id="mitarbeiterBtn"
                    style="width: 100%; padding: 16px; background: linear-gradient(135deg, var(--color-primary), var(--color-primary-hover)); border: none; border-radius: 10px; color: white; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 10px;">
                    <i data-feather="user-check"></i>
                    Als Mitarbeiter anmelden
                </button>

                <!-- Cancel Button (continue as werkstatt) -->
                <button
                    type="button"
                    onclick="closeMitarbeiterModal()"
                    style="width: 100%; padding: 16px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; color: var(--color-text-primary); font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                    Als Werkstatt fortfahren
                </button>
            </form>

            <!-- Info -->
            <div style="margin-top: 20px; text-align: center; font-size: 13px; color: var(--color-text-secondary); line-height: 1.6;">
                <p style="margin: 0;">
                    üí° <strong>Hinweis:</strong><br>
                    Die Mitarbeiter-Auswahl erm√∂glicht individuelle Berechtigungen.<br>
                    Sie k√∂nnen auch ohne Mitarbeiter-Auswahl als Werkstatt fortfahren (voller Zugriff).
                </p>
            </div>
        </div>
    </div>

    <!-- SERVICE-AUSWAHL MODAL (Phase 1.2 - Dienstplan Feature) -->
    <div id="serviceAuswahlModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 100002; padding: 20px; overflow-y: auto;">
        <div style="max-width: 700px; margin: 80px auto; background: var(--color-surface); border-radius: 16px; padding: 40px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); backdrop-filter: blur(25px);">
            <!-- Header -->
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, #007aff, #0051d5); border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 40px;">
                    üé®
                </div>
                <h2 style="color: var(--color-text-primary); margin: 0 0 10px 0; font-size: 28px; font-weight: 700;">F√ºr welchen Service arbeitest du heute?</h2>
                <p style="color: var(--color-text-secondary); margin: 0; font-size: 14px;">W√§hle einen oder mehrere Services aus</p>
            </div>

            <!-- Service-Grid (12 Services) -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 25px;">
                <!-- Lackierung -->
                <label class="service-card" style="position: relative; display: flex; flex-direction: column; align-items: center; padding: 20px; background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                    <input type="checkbox" name="service" value="lackierung" style="position: absolute; opacity: 0; pointer-events: none;">
                    <div class="service-icon" style="font-size: 48px; margin-bottom: 10px; transition: all 0.3s;">üé®</div>
                    <div class="service-label" style="font-size: 14px; font-weight: 600; color: var(--color-text-primary); transition: all 0.3s;">Lackierung</div>
                </label>

                <!-- Mechanik -->
                <label class="service-card" style="position: relative; display: flex; flex-direction: column; align-items: center; padding: 20px; background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                    <input type="checkbox" name="service" value="mechanik" style="position: absolute; opacity: 0; pointer-events: none;">
                    <div class="service-icon" style="font-size: 48px; margin-bottom: 10px; transition: all 0.3s;">üîß</div>
                    <div class="service-label" style="font-size: 14px; font-weight: 600; color: var(--color-text-primary); transition: all 0.3s;">Mechanik</div>
                </label>

                <!-- Reifen -->
                <label class="service-card" style="position: relative; display: flex; flex-direction: column; align-items: center; padding: 20px; background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                    <input type="checkbox" name="service" value="reifen" style="position: absolute; opacity: 0; pointer-events: none;">
                    <div class="service-icon" style="font-size: 48px; margin-bottom: 10px; transition: all 0.3s;">üõû</div>
                    <div class="service-label" style="font-size: 14px; font-weight: 600; color: var(--color-text-primary); transition: all 0.3s;">Reifen</div>
                </label>

                <!-- Pflege -->
                <label class="service-card" style="position: relative; display: flex; flex-direction: column; align-items: center; padding: 20px; background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                    <input type="checkbox" name="service" value="pflege" style="position: absolute; opacity: 0; pointer-events: none;">
                    <div class="service-icon" style="font-size: 48px; margin-bottom: 10px; transition: all 0.3s;">‚ú®</div>
                    <div class="service-label" style="font-size: 14px; font-weight: 600; color: var(--color-text-primary); transition: all 0.3s;">Pflege</div>
                </label>

                <!-- T√úV -->
                <label class="service-card" style="position: relative; display: flex; flex-direction: column; align-items: center; padding: 20px; background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                    <input type="checkbox" name="service" value="tuev" style="position: absolute; opacity: 0; pointer-events: none;">
                    <div class="service-icon" style="font-size: 48px; margin-bottom: 10px; transition: all 0.3s;">üìã</div>
                    <div class="service-label" style="font-size: 14px; font-weight: 600; color: var(--color-text-primary); transition: all 0.3s;">T√úV</div>
                </label>

                <!-- Versicherung -->
                <label class="service-card" style="position: relative; display: flex; flex-direction: column; align-items: center; padding: 20px; background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                    <input type="checkbox" name="service" value="versicherung" style="position: absolute; opacity: 0; pointer-events: none;">
                    <div class="service-icon" style="font-size: 48px; margin-bottom: 10px; transition: all 0.3s;">üìÑ</div>
                    <div class="service-label" style="font-size: 14px; font-weight: 600; color: var(--color-text-primary); transition: all 0.3s;">Versicherung</div>
                </label>

                <!-- Glas -->
                <label class="service-card" style="position: relative; display: flex; flex-direction: column; align-items: center; padding: 20px; background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                    <input type="checkbox" name="service" value="glas" style="position: absolute; opacity: 0; pointer-events: none;">
                    <div class="service-icon" style="font-size: 48px; margin-bottom: 10px; transition: all 0.3s;">üîç</div>
                    <div class="service-label" style="font-size: 14px; font-weight: 600; color: var(--color-text-primary); transition: all 0.3s;">Glas</div>
                </label>

                <!-- Klima -->
                <label class="service-card" style="position: relative; display: flex; flex-direction: column; align-items: center; padding: 20px; background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                    <input type="checkbox" name="service" value="klima" style="position: absolute; opacity: 0; pointer-events: none;">
                    <div class="service-icon" style="font-size: 48px; margin-bottom: 10px; transition: all 0.3s;">‚ùÑÔ∏è</div>
                    <div class="service-label" style="font-size: 14px; font-weight: 600; color: var(--color-text-primary); transition: all 0.3s;">Klima</div>
                </label>

                <!-- Dellen -->
                <label class="service-card" style="position: relative; display: flex; flex-direction: column; align-items: center; padding: 20px; background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                    <input type="checkbox" name="service" value="dellen" style="position: absolute; opacity: 0; pointer-events: none;">
                    <div class="service-icon" style="font-size: 48px; margin-bottom: 10px; transition: all 0.3s;">üî®</div>
                    <div class="service-label" style="font-size: 14px; font-weight: 600; color: var(--color-text-primary); transition: all 0.3s;">Dellen</div>
                </label>

                <!-- Folierung -->
                <label class="service-card" style="position: relative; display: flex; flex-direction: column; align-items: center; padding: 20px; background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                    <input type="checkbox" name="service" value="folierung" style="position: absolute; opacity: 0; pointer-events: none;">
                    <div class="service-icon" style="font-size: 48px; margin-bottom: 10px; transition: all 0.3s;">üé¨</div>
                    <div class="service-label" style="font-size: 14px; font-weight: 600; color: var(--color-text-primary); transition: all 0.3s;">Folierung</div>
                </label>

                <!-- Steinschutz -->
                <label class="service-card" style="position: relative; display: flex; flex-direction: column; align-items: center; padding: 20px; background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                    <input type="checkbox" name="service" value="steinschutz" style="position: absolute; opacity: 0; pointer-events: none;">
                    <div class="service-icon" style="font-size: 48px; margin-bottom: 10px; transition: all 0.3s;">üõ°Ô∏è</div>
                    <div class="service-label" style="font-size: 14px; font-weight: 600; color: var(--color-text-primary); transition: all 0.3s;">Steinschutz</div>
                </label>

                <!-- Werbebeklebung -->
                <label class="service-card" style="position: relative; display: flex; flex-direction: column; align-items: center; padding: 20px; background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.1); border-radius: 12px; cursor: pointer; transition: all 0.3s;">
                    <input type="checkbox" name="service" value="werbebeklebung" style="position: absolute; opacity: 0; pointer-events: none;">
                    <div class="service-icon" style="font-size: 48px; margin-bottom: 10px; transition: all 0.3s;">üì¢</div>
                    <div class="service-label" style="font-size: 14px; font-weight: 600; color: var(--color-text-primary); transition: all 0.3s;">Werbebeklebung</div>
                </label>
            </div>

            <!-- Buttons -->
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button type="button" onclick="skipServiceSelection()" style="padding: 14px 28px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; color: var(--color-text-primary); font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                    √úberspringen
                </button>
                <button type="button" onclick="confirmServiceSelection()" style="padding: 14px 28px; background: linear-gradient(135deg, var(--color-primary), var(--color-primary-hover)); border: none; border-radius: 10px; color: white; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px;">
                    ‚úÖ Best√§tigen
                </button>
            </div>
        </div>
    </div>

    <!-- URLAUBS-ANFRAGE MODAL (Phase 2.1 - Dienstplan Feature) -->
    <div id="urlaubAnfrageModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 100002; padding: 20px; overflow-y: auto;">
        <div style="max-width: 600px; margin: 80px auto; background: var(--color-surface); border-radius: 16px; padding: 40px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); backdrop-filter: blur(25px);">
            <!-- Header -->
            <div style="text-align: center; margin-bottom: 30px;">
                <div style="width: 80px; height: 80px; margin: 0 auto 20px; background: linear-gradient(135deg, #34c759, #28a745); border-radius: 20px; display: flex; align-items: center; justify-content: center; font-size: 40px;">
                    üèñÔ∏è
                </div>
                <h2 style="color: var(--color-text-primary); margin: 0 0 10px 0; font-size: 28px; font-weight: 700;">Urlaub anfragen</h2>
                <p id="urlaubTageAnzeige" style="color: var(--color-text-secondary); margin: 0; font-size: 14px;">Verf√ºgbare Urlaubstage werden geladen...</p>
            </div>

            <!-- Form -->
            <form onsubmit="submitUrlaubsAnfrage(event)" style="display: flex; flex-direction: column; gap: 20px;">
                <!-- Startdatum -->
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--color-text-primary);">üìÖ Startdatum</label>
                    <input type="date" id="urlaubStartDatum" required style="width: 100%; padding: 12px; border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: var(--color-text-primary); font-size: 14px;">
                </div>

                <!-- Enddatum -->
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--color-text-primary);">üìÖ Enddatum</label>
                    <input type="date" id="urlaubEndDatum" required style="width: 100%; padding: 12px; border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: var(--color-text-primary); font-size: 14px;">
                </div>

                <!-- Anzahl Tage (automatisch berechnet) -->
                <div id="urlaubAnzahlTageContainer" style="display: none; padding: 12px; background: rgba(52, 199, 89, 0.1); border: 2px solid rgba(52, 199, 89, 0.3); border-radius: 8px;">
                    <p style="margin: 0; color: var(--color-text-primary); font-weight: 600;">
                        üìä Anzahl Werktage: <span id="urlaubAnzahlTage">0</span> Tage
                    </p>
                </div>

                <!-- Grund/Notiz -->
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 8px; color: var(--color-text-primary);">üìù Grund / Notiz</label>
                    <textarea id="urlaubGrund" rows="3" placeholder="z.B. Familienurlaub, Arzttermin..." style="width: 100%; padding: 12px; border: 2px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: var(--color-text-primary); font-size: 14px; resize: vertical;"></textarea>
                </div>

                <!-- Buttons -->
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" onclick="closeUrlaubAnfrageModal()" style="padding: 14px 28px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); border-radius: 10px; color: var(--color-text-primary); font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
                        Abbrechen
                    </button>
                    <button type="submit" id="urlaubAnfrageSubmitBtn" style="padding: 14px 28px; background: linear-gradient(135deg, #34c759, #28a745); border: none; border-radius: 10px; color: white; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 8px;">
                        ‚úÖ Anfrage senden
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Service-Card Hover Effects -->
    <style>
        .service-card:hover {
            border-color: var(--color-primary) !important;
            background: rgba(255, 255, 255, 0.08) !important;
            transform: translateY(-4px);
        }

        .service-card input[type="checkbox"]:checked + .service-icon {
            filter: drop-shadow(0 0 10px rgba(0, 191, 255, 0.8));
            transform: scale(1.1);
        }

        .service-card input[type="checkbox"]:checked ~ .service-label {
            color: var(--color-primary) !important;
            font-weight: 700 !important;
        }

        .service-card input[type="checkbox"]:checked {
            opacity: 1 !important;
        }

        /* Checkmark erscheinen lassen bei checked */
        .service-card:has(input:checked)::before {
            content: "‚úì";
            position: absolute;
            top: 10px;
            right: 10px;
            width: 24px;
            height: 24px;
            background: var(--color-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            font-weight: bold;
        }
    </style>

    <!-- USER MANAGEMENT & TILE LOCKING SCRIPT -->
    <script>
        /// <reference path="js/types.js" />

        // ============================================
        // USER MANAGEMENT SYSTEM
        // ============================================

        /**
         * Currently logged in user
         * @type {Object|null}
         */
        let currentUser = null;

        /**
         * List of all users
         * @type {Object[]}
         */
        let usersList = [];

        // ============================================
        // PASSWORD HASHING (SHA-256)
        // ============================================

        /**
         * Hash password using SHA-256
         * @param {string} password - Plain text password
         * @returns {Promise<string>} - Hex string hash
         */
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        // Open Login Modal (Firebase Auth)
        function openLoginModal() {
            document.getElementById('loginModal').style.display = 'block';
            // Focus email field
            setTimeout(() => {
                document.getElementById('loginEmail').focus();
            }, 100);
        }

        // Close Login Modal
        function closeLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
            // Reset form
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginError').style.display = 'none';
        }

        // ============================================
        // MITARBEITER MODAL (Stage 2 Login)
        // ============================================

        // Open Mitarbeiter Modal and load employees
        async function openMitarbeiterModal() {
            console.log('üë§ √ñffne Mitarbeiter-Auswahl Modal...');

            document.getElementById('mitarbeiterModal').style.display = 'block';

            // Load employees from Firestore
            await loadMitarbeiterDropdown();

            // Focus dropdown
            setTimeout(() => {
                document.getElementById('mitarbeiterSelect').focus();
            }, 100);

            // Re-render feather icons
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        }

        // Close Mitarbeiter Modal
        function closeMitarbeiterModal() {
            console.log('üë§ Schlie√üe Mitarbeiter-Auswahl Modal (fortfahren als Werkstatt)');

            document.getElementById('mitarbeiterModal').style.display = 'none';

            // Reset form
            document.getElementById('mitarbeiterSelect').value = '';
            document.getElementById('mitarbeiterPassword').value = '';
            document.getElementById('mitarbeiterError').style.display = 'none';
        }

        // Load Mitarbeiter Dropdown from Firestore
        async function loadMitarbeiterDropdown() {
            console.log('üì• Lade Mitarbeiter f√ºr Dropdown...');

            try {
                // Get werkstattId from currentUser
                if (!currentUser || !currentUser.werkstattId) {
                    console.error('‚ùå Keine werkstattId vorhanden!');
                    return;
                }

                const werkstattId = currentUser.werkstattId;
                console.log('   WerkstattID:', werkstattId);

                // Get mitarbeiter collection using helper function
                const mitarbeiterCollection = window.getCollection('mitarbeiter');
                const mitarbeiterSnapshot = await mitarbeiterCollection.get();

                const dropdown = document.getElementById('mitarbeiterSelect');

                // Clear existing options (except placeholder)
                dropdown.innerHTML = '<option value="" disabled selected>Mitarbeiter ausw√§hlen...</option>';

                // Add mitarbeiter to dropdown (only active employees)
                let activeCount = 0;
                mitarbeiterSnapshot.forEach((doc) => {
                    if (doc.id === '_init') return; // Skip init doc

                    const data = doc.data();

                    // Only show active employees
                    if (data.status === 'active') {
                        const option = document.createElement('option');
                        option.value = doc.id;
                        option.textContent = data.name;
                        dropdown.appendChild(option);
                        activeCount++;
                    }
                });

                console.log(`‚úÖ ${activeCount} aktive Mitarbeiter geladen`);

                // If no employees found, show message + Test-Daten Button
                if (activeCount === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Keine Mitarbeiter gefunden';
                    option.disabled = true;
                    dropdown.appendChild(option);

                    document.getElementById('mitarbeiterError').textContent = '‚ö†Ô∏è Es wurden keine aktiven Mitarbeiter gefunden. Klicken Sie unten auf den Button um Test-Mitarbeiter zu erstellen.';
                    document.getElementById('mitarbeiterError').style.display = 'block';

                    // Show Test-Daten Button
                    document.getElementById('testDataButtonContainer').style.display = 'block';
                } else {
                    // Hide Test-Daten Button if employees exist
                    document.getElementById('testDataButtonContainer').style.display = 'none';
                }

            } catch (error) {
                console.error('‚ùå Fehler beim Laden der Mitarbeiter:', error);
                document.getElementById('mitarbeiterError').textContent = '‚ùå Fehler beim Laden der Mitarbeiter: ' + error.message;
                document.getElementById('mitarbeiterError').style.display = 'block';
            }
        }

        // Submit Mitarbeiter Login (Stage 2)
        async function submitMitarbeiterLogin(event) {
            event.preventDefault();

            const mitarbeiterId = document.getElementById('mitarbeiterSelect').value;
            const password = document.getElementById('mitarbeiterPassword').value;
            const errorDiv = document.getElementById('mitarbeiterError');
            const submitBtn = document.getElementById('mitarbeiterBtn');

            // Validation
            if (!mitarbeiterId || !password) {
                errorDiv.textContent = '‚ö†Ô∏è Bitte Mitarbeiter und Passwort eingeben!';
                errorDiv.style.display = 'block';
                return;
            }

            // Disable button during login
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i data-feather="loader"></i> Anmeldung l√§uft...';
            errorDiv.style.display = 'none';

            if (typeof feather !== 'undefined') {
                feather.replace();
            }

            try {
                console.log('üîê STAGE 2: Mitarbeiter-Login:', mitarbeiterId);

                // Call authManager.loginMitarbeiter()
                const mitarbeiter = await window.authManager.loginMitarbeiter(mitarbeiterId, password);

                console.log('‚úÖ Stage 2 erfolgreich:', mitarbeiter);

                // Update current user with mitarbeiter data
                currentUser = window.authManager.getCurrentUser();

                console.log('‚úÖ Current User aktualisiert:', currentUser);
                console.log('   Login Stage:', currentUser.loginStage);
                console.log('   Rolle:', currentUser.role);
                console.log('   Berechtigungen:', currentUser.berechtigungen);

                // Update Welcome Banner with mitarbeiter name
                updateWelcomeBanner();

                // Re-lock tiles based on mitarbeiter permissions
                lockTiles();

                // Close modal
                closeMitarbeiterModal();

                // Success message
                showToast(`Willkommen, ${currentUser.name}! Sie sind jetzt als Mitarbeiter angemeldet.`, 'success', 4000);

                // üÜï Phase 1.2: Show Service Selection Modal
                showServiceSelectionModal();

            } catch (error) {
                console.error('‚ùå Mitarbeiter-Login fehlgeschlagen:', error);

                // Show error message
                errorDiv.textContent = error.message || '‚ùå Anmeldung fehlgeschlagen! Bitte pr√ºfen Sie Mitarbeiter und Passwort.';
                errorDiv.style.display = 'block';

                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i data-feather="user-check"></i> Als Mitarbeiter anmelden';

                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
            }
        }

        // Create Test Mitarbeiter from Modal (ohne zu mitarbeiter-verwaltung.html zu wechseln)
        async function createTestMitarbeiterFromModal() {
            console.log('üß™ Erstelle Test-Mitarbeiter aus Modal...');

            const errorDiv = document.getElementById('mitarbeiterError');
            const testBtn = document.getElementById('testDataButtonContainer').querySelector('button');

            // Disable button during creation
            testBtn.disabled = true;
            testBtn.innerHTML = '<i data-feather="loader"></i> Erstelle Test-Daten...';
            errorDiv.style.display = 'none';

            if (typeof feather !== 'undefined') {
                feather.replace();
            }

            try {
                // Get werkstattId from currentUser
                if (!currentUser || !currentUser.werkstattId) {
                    throw new Error('Keine werkstattId vorhanden!');
                }

                const werkstattId = currentUser.werkstattId;
                console.log('   WerkstattID:', werkstattId);

                // Get mitarbeiter collection
                const mitarbeiterCollection = window.getCollection('mitarbeiter');

                // Hash f√ºr Passwort "1234"
                const passwordHash = await window.authManager.hashPassword('1234');

                // Test-Mitarbeiter Daten
                const testUsers = [
                    {
                        id: `user_max_${Date.now()}`,
                        name: 'Max M√ºller (Vollzugriff)',
                        passwordHash: passwordHash,
                        status: 'active',
                        berechtigungen: {
                            annahme: true,
                            abnahme: true,
                            liste: true,
                            kanban: true,
                            kunden: true,
                            kalender: true,
                            material: true,
                            partner: true,
                            mitarbeiterVerwaltung: true,
                            einstellungen: true,
                            backup: true,
                            statistiken: true,
                            admin: true,
                            entwickler: true
                        },
                        werkstattId: werkstattId,
                        createdAt: new Date().toISOString(),
                        createdBy: 'Test-Daten Generator (Modal)',
                        lastLogin: null
                    },
                    {
                        id: `user_anna_${Date.now() + 1}`,
                        name: 'Anna Schmidt (Teilzugriff)',
                        passwordHash: passwordHash,
                        status: 'active',
                        berechtigungen: {
                            annahme: true,
                            abnahme: true,
                            liste: true,
                            kanban: true,
                            kunden: false,
                            kalender: true,
                            material: false,
                            partner: false,
                            mitarbeiterVerwaltung: false,
                            einstellungen: false,
                            backup: false,
                            statistiken: false,
                            admin: false,
                            entwickler: false
                        },
                        werkstattId: werkstattId,
                        createdAt: new Date().toISOString(),
                        createdBy: 'Test-Daten Generator (Modal)',
                        lastLogin: null
                    },
                    {
                        id: `user_tom_${Date.now() + 2}`,
                        name: 'Tom Weber (Basiszugriff)',
                        passwordHash: passwordHash,
                        status: 'active', // Active so it appears in dropdown
                        berechtigungen: {
                            annahme: true,
                            abnahme: false,
                            liste: true,
                            kanban: false,
                            kunden: false,
                            kalender: false,
                            material: false,
                            partner: false,
                            mitarbeiterVerwaltung: false,
                            einstellungen: false,
                            backup: false,
                            statistiken: false,
                            admin: false,
                            entwickler: false
                        },
                        werkstattId: werkstattId,
                        createdAt: new Date().toISOString(),
                        createdBy: 'Test-Daten Generator (Modal)',
                        lastLogin: null
                    }
                ];

                // Create all test users
                for (const user of testUsers) {
                    await mitarbeiterCollection.doc(user.id).set(user);
                    console.log(`‚úÖ Mitarbeiter erstellt: ${user.name}`);
                }

                console.log('‚úÖ Alle Test-Mitarbeiter erfolgreich erstellt!');

                // Show success message
                showToast('3 Test-Mitarbeiter erfolgreich erstellt! Passwort: 1234. Bitte w√§hle jetzt einen Mitarbeiter aus.', 'success', 5000);

                // Reload dropdown
                await loadMitarbeiterDropdown();

                // Re-render feather icons
                if (typeof feather !== 'undefined') {
                    feather.replace();
                }

            } catch (error) {
                console.error('‚ùå Fehler beim Erstellen der Test-Mitarbeiter:', error);
                errorDiv.textContent = '‚ùå Fehler beim Erstellen: ' + error.message;
                errorDiv.style.display = 'block';

                // Re-enable button
                testBtn.disabled = false;
                testBtn.innerHTML = '<i data-feather="users"></i> üß™ 3 Test-Mitarbeiter erstellen (Passwort: 1234)';

                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
            }
        }

        // ============================================
        // LOGIN FUNCTIONS
        // ============================================

        // Firebase Login (E-Mail + Password)
        async function login(event) {
            event.preventDefault(); // Prevent form submission reload

            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            const loginBtn = document.getElementById('loginBtn');

            // Validation
            if (!email || !password) {
                errorDiv.textContent = '‚ö†Ô∏è Bitte E-Mail und Passwort eingeben!';
                errorDiv.style.display = 'block';
                return;
            }

            // Disable button during login
            loginBtn.disabled = true;
            loginBtn.textContent = 'Anmeldung l√§uft...';
            errorDiv.style.display = 'none';

            try {
                console.log('üîê Firebase Login:', email);

                // Call authManager.loginWithFirebase()
                const user = await window.authManager.loginWithFirebase(email, password);

                console.log('‚úÖ Login erfolgreich:', user);
                console.log('   Rolle:', user.role);
                console.log('   WerkstattID:', user.werkstattId);

                // üÜï BUGFIX 2025-11-04 (FIX #40): Partner-Accounts d√ºrfen sich nicht im Werkstatt-Dashboard anmelden
                if (user.role === 'partner') {
                    console.error('‚ùå Partner-Login blockiert! Partner k√∂nnen nur das Partner-Portal nutzen.');
                    alert('‚õî Partner-Accounts k√∂nnen sich hier nicht anmelden.\n\nBitte nutzen Sie das Partner-Portal:\n' + window.location.origin + '/partner-app/');

                    // Logout + Reset UI
                    await firebase.auth().signOut();
                    loginBtn.disabled = false;
                    loginBtn.innerHTML = '<i data-feather="log-in"></i><span>Anmelden</span>';
                    feather.replace();
                    return;
                }

                // Set current user
                currentUser = user;

                // Update Welcome Banner
                updateWelcomeBanner();

                // Lock/Unlock tiles based on role and permissions
                lockTiles();

                // Close login modal
                closeLoginModal();

                // ‚ö†Ô∏è WICHTIG: F√ºr Werkstatt-Rolle ‚Üí √∂ffne Mitarbeiter-Auswahl Modal
                if (user.role === 'werkstatt') {
                    console.log('üë§ Werkstatt-Login erkannt ‚Üí √∂ffne Mitarbeiter-Auswahl');

                    // Open mitarbeiter modal after a short delay
                    setTimeout(() => {
                        openMitarbeiterModal();
                    }, 300);

                } else {
                    // For other roles (admin, partner, kunde) ‚Üí show welcome animation
                    showWelcomeAnimation();
                }

            } catch (error) {
                console.error('‚ùå Login fehlgeschlagen:', error);

                // Show error message
                errorDiv.textContent = error.message || '‚ùå Anmeldung fehlgeschlagen! Bitte pr√ºfe deine E-Mail und Passwort.';
                errorDiv.style.display = 'block';

                // Re-enable button
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i data-feather="log-in"></i> Anmelden';
                feather.replace(); // Re-render icons
            }
        }

        // Show welcome animation
        function showWelcomeAnimation() {
            const banner = document.querySelector('.welcome-banner');
            banner.style.animation = 'none';
            setTimeout(() => {
                banner.style.animation = 'fadeIn 0.5s ease-out';
            }, 10);

            showToast(`Willkommen, ${currentUser.name}! Angemeldet um ${currentUser.loginTimeFormatted} Uhr`, 'success', 4000);
        }

        // Update Welcome Banner
        function updateWelcomeBanner() {
            if (!currentUser) return;

            const titleEl = document.getElementById('welcomeTitle');
            const subtitleEl = document.getElementById('welcomeSubtitle');
            const actionsEl = document.getElementById('userActions');

            // Update title
            titleEl.textContent = `Hallo ${currentUser.name}!`;

            // Update subtitle with login time
            if (currentUser.loginTimeFormatted) {
                subtitleEl.textContent = `Angemeldet seit ${currentUser.loginTimeFormatted} Uhr`;
                subtitleEl.style.fontSize = '14px';
                subtitleEl.style.color = 'var(--color-text-secondary)';
            }

            // Show action buttons
            actionsEl.style.display = 'flex';

            // üÜï Phase 2.1: Show mitarbeiter-specific actions if logged in as mitarbeiter
            const mitarbeiterActionsEl = document.getElementById('mitarbeiterActions');
            if (currentUser.loginStage === 2 && currentUser.role === 'mitarbeiter') {
                mitarbeiterActionsEl.style.display = 'block';
                console.log('‚úÖ Mitarbeiter-Bereich eingeblendet');
            } else {
                mitarbeiterActionsEl.style.display = 'none';
            }

            // üÜï Admin Actions: Show for Admin/Werkstatt ONLY (NOT for Mitarbeiter)
            const adminActionsEl = document.getElementById('adminActions');
            if (currentUser.role === 'werkstatt' || currentUser.role === 'admin') {
                adminActionsEl.style.display = 'block';
                console.log('‚úÖ Admin-Bereich eingeblendet (Session Cleanup available)');
            } else {
                adminActionsEl.style.display = 'none';
                console.log('‚ÑπÔ∏è Admin-Bereich ausgeblendet (Nur f√ºr Admin/Werkstatt)');
            }
        }

        // Logout User (Firebase Auth)
        async function logoutUser() {
            if (!currentUser) return;

            const userName = currentUser.name;

            if (!confirm(`M√∂chtest du dich wirklich abmelden?\n\nAngemeldet als: ${userName}`)) {
                return;
            }

            try {
                // Firebase Logout
                await window.authManager.logout();
                currentUser = null;

                console.log(`üëã ${userName} abgemeldet`);

                // Show goodbye message
                showToast(`Bis bald, ${userName}! Das Tablet ist jetzt bereit f√ºr den n√§chsten Benutzer.`, 'info', 4000);

                // Reset Welcome Banner
                document.getElementById('welcomeTitle').textContent = 'Willkommen im Dashboard';
                document.getElementById('welcomeSubtitle').textContent = 'Verwalten Sie Fahrzeuge, Kunden und Partner-Anfragen professionell und effizient';
                document.getElementById('userActions').style.display = 'none';

                // Reset all tiles to locked state
                resetTiles();

                // Open login modal
                setTimeout(() => {
                    openLoginModal();
                }, 300);

            } catch (error) {
                console.error('‚ùå Logout fehlgeschlagen:', error);
                showToast('Fehler beim Abmelden!', 'error');
            }
        }

        // ============================================
        // SWITCH USER (Mitarbeiter wechseln, Werkstatt bleibt eingeloggt)
        // ============================================

        async function switchUser() {
            console.log('üîÑ User-Wechsel initiiert...');

            // 1. Check if logged in
            if (!currentUser) {
                console.log('‚ùå Kein User eingeloggt ‚Üí √∂ffne Login-Modal');
                openLoginModal();
                return;
            }

            // 2. Werkstatt-User ohne Mitarbeiter ‚Üí Stage 2 Login
            if (currentUser.role === 'werkstatt' && !currentUser.mitarbeiterId) {
                console.log('üë§ Werkstatt-User ohne Mitarbeiter ‚Üí √∂ffne Mitarbeiter-Auswahl');
                openMitarbeiterModal();
                return;
            }

            // 3. Werkstatt-User MIT Mitarbeiter ‚Üí Mitarbeiter wechseln
            if (currentUser.role === 'werkstatt' && currentUser.mitarbeiterId) {
                console.log('üîÑ Werkstatt-User mit Mitarbeiter ‚Üí Mitarbeiter wechseln');

                const mitarbeiterName = currentUser.mitarbeiterName || currentUser.name;

                if (!confirm(`Mitarbeiter wechseln?\n\nAktuell angemeldet: ${mitarbeiterName}\n\nDie Werkstatt bleibt eingeloggt.`)) {
                    return;
                }

                // ‚úÖ Nur Mitarbeiter ausloggen (Werkstatt bleibt eingeloggt!)
                window.authManager.logoutMitarbeiter();

                console.log('üëã Mitarbeiter ausgeloggt - Werkstatt bleibt eingeloggt');

                // Reset Welcome Banner
                document.getElementById('welcomeTitle').textContent = 'Willkommen im Dashboard';
                document.getElementById('welcomeSubtitle').textContent = 'Bitte w√§hlen Sie einen Mitarbeiter aus';
                document.getElementById('userActions').style.display = 'none';

                // Reset all tiles to locked state
                resetTiles();

                // √ñffne Mitarbeiter-Modal neu (Stage 2)
                setTimeout(() => {
                    openMitarbeiterModal();
                }, 300);

                return;
            }

            // 4. Alle anderen Rollen (admin, partner, kunde) ‚Üí Full Re-Login
            console.log('üîê Admin/Partner/Kunde ‚Üí Full Re-Login erforderlich');

            if (confirm(`M√∂chtest du dich als ${currentUser.name} abmelden und einen anderen User anmelden?`)) {
                try {
                    await window.authManager.logout();
                    currentUser = null;

                    console.log('üëã User abgemeldet');

                    // Reset Welcome Banner
                    document.getElementById('welcomeTitle').textContent = 'Willkommen im Dashboard';
                    document.getElementById('welcomeSubtitle').textContent = 'Verwalten Sie Fahrzeuge, Kunden und Partner-Anfragen professionell und effizient';
                    document.getElementById('userActions').style.display = 'none';

                    // Reset all tiles to locked state
                    resetTiles();

                    // Open login modal
                    setTimeout(() => {
                        openLoginModal();
                    }, 300);

                } catch (error) {
                    console.error('‚ùå Logout fehlgeschlagen:', error);
                    showToast('Fehler beim Abmelden!', 'error');
                }
            }
        }

        // Load Current User from Firebase Auth
        async function loadCurrentUser() {
            // ‚ö†Ô∏è WICHTIG: Warte auf Auth State Listener (Race Condition Fix)
            // Identisch mit mitarbeiter-verwaltung.html Polling-Mechanismus
            let user = null;
            let attempts = 0;
            const maxAttempts = 20; // 20 * 250ms = 5 Sekunden max

            while (!user && attempts < maxAttempts) {
                user = window.authManager.getCurrentUser();
                if (!user) {
                    console.log(`‚è≥ Warte auf Auth State Listener (Versuch ${attempts + 1}/${maxAttempts})...`);
                    await new Promise(resolve => setTimeout(resolve, 250)); // 250ms warten
                    attempts++;
                }
            }

            if (user) {
                currentUser = user;
                console.log('‚úÖ Firebase Auth User geladen:', currentUser.name);
                console.log('   Rolle:', currentUser.role);
                console.log('   Login Stage:', currentUser.loginStage);

                // üÜï BUGFIX 2025-11-18: Persist session data to sessionStorage for cross-page navigation
                // Fix for Steuerberater Dashboard access denied (sessionStorage was empty)
                if (currentUser && currentUser.role) {
                    sessionStorage.setItem('role', currentUser.role);
                    sessionStorage.setItem('email', currentUser.email || '');
                    sessionStorage.setItem('werkstattId', currentUser.werkstattId || 'mosbach');
                    console.log('‚úÖ Session data saved to sessionStorage:', {
                        role: currentUser.role,
                        email: currentUser.email,
                        werkstattId: currentUser.werkstattId
                    });
                }

                // üÜï BUGFIX 2025-11-04 (FIX #41): Partner-Zugriff auf Werkstatt-Dashboard blockieren
                // Partner d√ºrfen nur das Partner-Portal nutzen, nicht das Werkstatt-Dashboard
                if (currentUser.role === 'partner') {
                    console.warn('üö´ Partner-Zugriff blockiert! Redirect zu Partner-Portal...');
                    safeNavigate('./partner-app/meine-anfragen.html');
                    return; // Stop further execution
                }

                updateWelcomeBanner();
                lockTiles();
            } else {
                // Nach 5 Sekunden: Timeout ‚Üí kein User eingeloggt
                console.log('‚ö†Ô∏è Kein Benutzer eingeloggt nach 5 Sekunden ‚Üí √∂ffne Login-Modal');
                setTimeout(() => {
                    openLoginModal();
                }, 500);
            }
        }

        // ============================================
        // TILE LOCKING SYSTEM
        // ============================================

        function lockTiles() {
            if (!currentUser) {
                console.warn('‚ö†Ô∏è Kein Benutzer eingeloggt');
                return;
            }

            console.log('üîí Pr√ºfe Kachel-Berechtigungen f√ºr Rolle:', currentUser.role);

            const links = document.querySelectorAll('a[data-permission]');

            // Admin & Werkstatt haben immer vollen Zugriff - alle Kacheln freischalten
            if (currentUser.role === 'admin' || currentUser.role === 'superadmin' || currentUser.role === 'werkstatt') {
                console.log('‚úÖ Admin/Werkstatt-Rolle: Alle Kacheln freigeschaltet');
                links.forEach(link => {
                    link.style.opacity = '1';
                    link.style.pointerEvents = 'auto';
                    link.style.filter = 'none';
                    const lockIcon = link.querySelector('.lock-icon');
                    if (lockIcon) lockIcon.remove();
                });
                return;
            }

            // Steuerberater: Zugriff nur auf Steuerberater-Kacheln (Read-Only)
            if (currentUser.role === 'steuerberater') {
                console.log('üìä Steuerberater-Rolle: Nur Finanz-Kacheln freigeschaltet');
                links.forEach(link => {
                    const permission = link.getAttribute('data-permission');
                    const isSteuerberaterLink = permission && permission.startsWith('steuerberater');

                    if (isSteuerberaterLink) {
                        // UNLOCK: Steuerberater-Kacheln
                        link.style.opacity = '1';
                        link.style.pointerEvents = 'auto';
                        link.style.filter = 'none';
                        const lockIcon = link.querySelector('.lock-icon');
                        if (lockIcon) lockIcon.remove();
                    } else {
                        // LOCK: Alle anderen Kacheln
                        link.style.opacity = '0.5';
                        link.style.pointerEvents = 'none';
                        link.style.filter = 'grayscale(1)';

                        if (!link.querySelector('.lock-icon')) {
                            const lockIcon = document.createElement('i');
                            lockIcon.setAttribute('data-feather', 'lock');
                            lockIcon.className = 'lock-icon';
                            lockIcon.style.position = 'absolute';
                            lockIcon.style.top = '5px';
                            lockIcon.style.right = '5px';
                            lockIcon.style.width = '16px';
                            lockIcon.style.height = '16px';
                            lockIcon.style.color = '#ff4444';

                            link.style.position = 'relative';
                            link.appendChild(lockIcon);
                            feather.replace();
                        }

                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            showToast('Zugriff verweigert! Steuerberater haben nur Zugriff auf Finanz-Berichte.', 'warning', 4000);
                            return false;
                        });
                    }
                });
                return;
            }

            // F√ºr Mitarbeiter: Berechtigungen pr√ºfen
            if (currentUser.role === 'mitarbeiter') {
                if (!currentUser.berechtigungen) {
                    console.warn('‚ö†Ô∏è Mitarbeiter hat keine Berechtigungen definiert');
                    return;
                }

                const permissions = currentUser.berechtigungen;

            links.forEach(link => {
                const requiredPermission = link.getAttribute('data-permission');
                const hasPermission = permissions[requiredPermission] === true;

                if (hasPermission) {
                    // UNLOCK: Remove lock
                    link.style.opacity = '1';
                    link.style.pointerEvents = 'auto';
                    link.style.filter = 'none';

                    // Remove lock icon if exists
                    const lockIcon = link.querySelector('.lock-icon');
                    if (lockIcon) lockIcon.remove();

                } else {
                    // LOCK: Add lock styling
                    link.style.opacity = '0.5';
                    link.style.pointerEvents = 'none';
                    link.style.filter = 'grayscale(1)';

                    // Add lock icon
                    if (!link.querySelector('.lock-icon')) {
                        const lockIcon = document.createElement('i');
                        lockIcon.setAttribute('data-feather', 'lock');
                        lockIcon.className = 'lock-icon';
                        lockIcon.style.position = 'absolute';
                        lockIcon.style.top = '5px';
                        lockIcon.style.right = '5px';
                        lockIcon.style.width = '16px';
                        lockIcon.style.height = '16px';
                        lockIcon.style.color = '#ff4444';

                        link.style.position = 'relative';
                        link.appendChild(lockIcon);

                        // Refresh feather icons
                        feather.replace();
                    }

                    // Prevent click
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        showToast(`Zugriff verweigert! Du hast keine Berechtigung f√ºr "${link.textContent.trim()}".`, 'warning', 4000);
                        return false;
                    });
                }
            });

                console.log('‚úÖ Kachel-Berechtigungen angewendet (Mitarbeiter)');
                return;
            }

            // F√ºr Werkstatt: Voller Zugriff (wie Admin)
            if (currentUser.role === 'werkstatt') {
                console.log('‚úÖ Werkstatt-Rolle: Alle Kacheln freigeschaltet');
                links.forEach(link => {
                    link.style.opacity = '1';
                    link.style.pointerEvents = 'auto';
                    link.style.filter = 'none';
                    const lockIcon = link.querySelector('.lock-icon');
                    if (lockIcon) lockIcon.remove();
                });
                return;
            }

            // F√ºr Partner und Kunde: Aktuell keine Kacheln in index.html
            // (Partner nutzen partner-app, Kunde nutzt Kunde-Portal)
            console.log('‚ÑπÔ∏è Rolle:', currentUser.role, '- Keine spezifischen Kachel-Berechtigungen');
        }

        // Reset all tiles to locked state (after logout)
        function resetTiles() {
            console.log('üîÑ Setze alle Kacheln zur√ºck...');

            const links = document.querySelectorAll('a[data-permission]');

            links.forEach(link => {
                // LOCK all tiles
                link.style.opacity = '0.5';
                link.style.pointerEvents = 'none';
                link.style.filter = 'grayscale(1)';

                // Add lock icon if not exists
                if (!link.querySelector('.lock-icon')) {
                    const lockIcon = document.createElement('i');
                    lockIcon.setAttribute('data-feather', 'lock');
                    lockIcon.className = 'lock-icon';
                    lockIcon.style.position = 'absolute';
                    lockIcon.style.top = '5px';
                    lockIcon.style.right = '5px';
                    lockIcon.style.width = '16px';
                    lockIcon.style.height = '16px';
                    lockIcon.style.color = '#ff4444';

                    link.style.position = 'relative';
                    link.appendChild(lockIcon);

                    // Refresh feather icons
                    feather.replace();
                }
            });

            console.log('‚úÖ Alle Kacheln gesperrt');
        }

        // ============================================
        // INITIALIZE ON PAGE LOAD
        // ============================================

        window.addEventListener('DOMContentLoaded', async () => {
            // Wait for Firebase to initialize
            await window.firebaseInitialized;

            // Attach event listeners to user action buttons
            const btnSwitchUser = document.getElementById('btnSwitchUser');
            if (btnSwitchUser) {
                const switchUserHandler = function(e) {
                    e.preventDefault();
                    console.log('üñ±Ô∏è Benutzer-wechseln-Button geklickt!');
                    switchUser(); // ‚úÖ Switch employee only (workshop stays logged in)
                };
                window.listenerRegistry.registerDOM(btnSwitchUser, 'click', switchUserHandler, 'Switch User Button');
                console.log('‚úÖ Switch-User-Button Event Listener attached');
            }

            const btnLogout = document.getElementById('btnLogout');
            if (btnLogout) {
                const logoutHandler = function(e) {
                    e.preventDefault();
                    console.log('üñ±Ô∏è Abmelden-Button geklickt!');
                    logoutUser();
                };
                window.listenerRegistry.registerDOM(btnLogout, 'click', logoutHandler, 'Logout Button');
                console.log('‚úÖ Logout-Button Event Listener attached');
            }

            // Load current user
            loadCurrentUser();

            // Load Werkstatt-Logo & Branding
            try {
                const settings = await window.settingsManager.loadSettings();
                if (settings?.profil) {
                    // Update Page Title
                    document.title = `${settings.profil.name} | Fahrzeugannahme-App`;

                    // Display Logo in Hero Section
                    if (settings.profil.logoUrl) {
                        const logoContainer = document.getElementById('werkstattLogo');
                        if (logoContainer) {
                            logoContainer.innerHTML = `
                                <img src="${settings.profil.logoUrl}"
                                     alt="${settings.profil.name}"
                                     style="height: 60px; width: auto; object-fit: contain; filter: drop-shadow(0 4px 12px rgba(0, 191, 255, 0.3));">
                            `;
                            console.log('‚úÖ [INDEX] Werkstatt-Logo angezeigt:', settings.profil.name);
                        }
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è [INDEX] Werkstatt-Branding konnte nicht geladen werden:', error);
            }

            console.log('‚úÖ User Management System initialized');
        });
    </script>

    <!-- Error Handler & Storage Monitor -->
    <script src="error-handler.js"></script>
    <script src="storage-monitor.js"></script>

    <!-- AI Agent System (LOAD FIRST!) -->
    <script src="js/ai-agent-tools.js?v=46c7e84"></script>
    <script src="js/ai-agent-engine.js?v=46c7e84"></script>
    <script src="js/ai-chat-widget.js?v=46c7e84"></script>
    <script src="js/quota-display.js"></script>

    <!-- THEN Initialize AI Agent -->
    <script>
        // ============================================
        // AI AGENT INITIALIZATION
        // ============================================
        // Initialize AI Agent AFTER Firebase is ready
        (async () => {
            try {
                // Wait for Firebase to be fully initialized
                await window.firebaseInitialized;
                console.log('üî• Firebase ready, initializing AI Agent...');

                // Initialize AI Agent
                if (window.initAIAgent) {
                    await window.initAIAgent();
                    console.log('‚úÖ AI Agent initialized successfully');
                } else {
                    console.error('‚ùå initAIAgent function not found');
                }
            } catch (error) {
                console.error('‚ùå AI Agent initialization failed:', error);
            }
        })();
    </script>

    <!-- Phase 3: Event Listeners for Real-Time Dashboard Updates -->
    <script>
        /**
         * Setup event listeners for AI Agent actions
         * Enables real-time dashboard updates when AI creates/updates data
         */
        function setupDashboardEventListeners() {
            // Check if event system is available
            if (!window.appEvents) {
                console.warn('‚ö†Ô∏è [DASHBOARD] Event system not available yet, will retry...');
                // Retry after a short delay
                setTimeout(setupDashboardEventListeners, 500);
                return;
            }

            console.log('üëÇ [DASHBOARD] Setting up event listeners...');

            // Listen for fahrzeug created
            window.appEvents.on('fahrzeugCreated', async (data) => {
                console.log('ü§ñ [DASHBOARD] AI created vehicle:', data.fahrzeug.kennzeichen);
                // Update dashboard status badges
                if (typeof updateStatusBadges === 'function') {
                    await updateStatusBadges();
                    console.log('‚úÖ [DASHBOARD] Status badges refreshed after fahrzeugCreated');
                }
            });

            // Listen for fahrzeug updated
            window.appEvents.on('fahrzeugUpdated', async (data) => {
                console.log('ü§ñ [DASHBOARD] AI updated vehicle:', data.vehicleId);
                // Update dashboard status badges
                if (typeof updateStatusBadges === 'function') {
                    await updateStatusBadges();
                    console.log('‚úÖ [DASHBOARD] Status badges refreshed after fahrzeugUpdated');
                }
            });

            // Listen for termin created
            window.appEvents.on('terminCreated', async (data) => {
                console.log('ü§ñ [DASHBOARD] AI created appointment:', data.termin);
                // Update dashboard (appointments affect calendar tile)
                if (typeof updateStatusBadges === 'function') {
                    await updateStatusBadges();
                    console.log('‚úÖ [DASHBOARD] Status badges refreshed after terminCreated');
                }
            });

            // Listen for kunde created
            window.appEvents.on('kundeCreated', async (data) => {
                console.log('ü§ñ [DASHBOARD] AI created customer:', data.kunde.name);
                // Update dashboard (customers affect kunden tile)
                if (typeof updateStatusBadges === 'function') {
                    await updateStatusBadges();
                    console.log('‚úÖ [DASHBOARD] Status badges refreshed after kundeCreated');
                }
            });

            console.log('‚úÖ [DASHBOARD] Event listeners registered successfully');
        }

        // Initialize event listeners when page loads
        if (document.readyState === 'loading') {
            window.listenerRegistry.registerDOM(document, 'DOMContentLoaded', setupDashboardEventListeners, 'document DOMContentLoaded');
        } else {
            // DOM already loaded
            setupDashboardEventListeners();
        }
    </script>

    <!-- ============================================
         ADMIN PROTECTION MODAL
         ============================================ -->
    <div id="adminPasswordModal" class="admin-modal">
        <div class="admin-modal__content">
            <div class="admin-modal__header">
                <i data-feather="shield"></i>
                <h3>Admin-Bereich</h3>
            </div>
            <p class="admin-modal__desc">Bitte geben Sie das Admin-Passwort ein:</p>
            <input type="password" id="adminPasswordInput" class="admin-modal__input" placeholder="Passwort eingeben...">
            <div class="admin-modal__error" id="adminPasswordError"></div>
            <div class="admin-modal__actions">
                <button onclick="closeAdminModal()" class="btn-secondary">Abbrechen</button>
                <button onclick="validateAdminPassword()" class="btn-primary">Best√§tigen</button>
            </div>
        </div>
    </div>

    <style>
        /* Admin Modal Styles */
        .admin-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        .admin-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .admin-modal__content {
            background: var(--color-surface, white);
            border-radius: 16px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        .admin-modal__header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .admin-modal__header i {
            color: var(--color-primary, #007aff);
            width: 24px;
            height: 24px;
        }

        .admin-modal__header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
            color: var(--color-text-primary, #1d1d1f);
        }

        .admin-modal__desc {
            margin-bottom: 20px;
            color: var(--color-text-secondary, #6e6e73);
            font-size: 14px;
        }

        .admin-modal__input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--color-border, #d2d2d7);
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 12px;
            transition: all 0.2s ease;
        }

        .admin-modal__input:focus {
            outline: none;
            border-color: var(--color-primary, #007aff);
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }

        .admin-modal__error {
            color: #ff3b30;
            font-size: 13px;
            margin-bottom: 16px;
            min-height: 18px;
        }

        .admin-modal__actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .admin-modal__actions button {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-secondary {
            background: var(--color-surface-secondary, #f5f5f7);
            color: var(--color-text-primary, #1d1d1f);
        }

        .btn-secondary:hover {
            background: var(--color-surface-tertiary, #e8e8ed);
        }

        .btn-primary {
            background: var(--color-primary, #007aff);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover, #0051d5);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Dark Mode Support */
        [data-theme="dark"] .admin-modal__content {
            background: var(--color-surface, #1c1c1e);
        }

        [data-theme="dark"] .admin-modal__header h3 {
            color: var(--color-text-primary, rgba(255, 255, 255, 0.9));
        }

        [data-theme="dark"] .admin-modal__input {
            background: var(--color-surface-secondary, #2c2c2e);
            border-color: var(--color-border, #3a3a3c);
            color: var(--color-text-primary, rgba(255, 255, 255, 0.9));
        }

        [data-theme="dark"] .btn-secondary {
            background: var(--color-surface-secondary, #2c2c2e);
            color: var(--color-text-primary, rgba(255, 255, 255, 0.9));
        }

        [data-theme="dark"] .btn-secondary:hover {
            background: var(--color-surface-tertiary, #3a3a3c);
        }

        /* ============================================
           NOTIFICATION TOAST STYLES
           ============================================ */

        .notification-toast {
            position: fixed;
            top: 80px;
            right: -400px;
            width: 360px;
            max-width: 90%;
            background: var(--color-surface, white);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12),
                        0 0 0 1px rgba(0, 0, 0, 0.05);
            padding: 16px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            z-index: 9999;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            cursor: pointer;
        }

        .notification-toast.show {
            right: 20px;
        }

        .notification-toast[data-priority="urgent"] {
            border-left: 4px solid #ff3b30;
        }

        .notification-toast[data-priority="high"] {
            border-left: 4px solid #ff9500;
        }

        .notification-toast[data-priority="normal"] {
            border-left: 4px solid var(--color-primary, #007aff);
        }

        .notification-toast[data-priority="low"] {
            border-left: 4px solid #8e8e93;
        }

        .notification-toast__icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .notification-toast__content {
            flex: 1;
            min-width: 0;
        }

        .notification-toast__title {
            margin: 0 0 4px 0;
            font-size: 15px;
            font-weight: 600;
            color: var(--color-text-primary, #1d1d1f);
            line-height: 1.3;
        }

        .notification-toast__message {
            margin: 0 0 6px 0;
            font-size: 13px;
            color: var(--color-text-secondary, #6e6e73);
            line-height: 1.4;
        }

        .notification-toast__time {
            font-size: 11px;
            color: var(--color-text-tertiary, #8e8e93);
        }

        .notification-toast__close {
            flex-shrink: 0;
            width: 28px;
            height: 28px;
            border: none;
            background: var(--color-surface-secondary, #f5f5f7);
            border-radius: 50%;
            font-size: 20px;
            line-height: 1;
            color: var(--color-text-secondary, #6e6e73);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-toast__close:hover {
            background: var(--color-surface-tertiary, #e8e8ed);
            color: var(--color-text-primary, #1d1d1f);
        }

        /* Animation */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Dark Mode Support */
        [data-theme="dark"] .notification-toast {
            background: var(--color-surface, #1c1c1e);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3),
                        0 0 0 1px rgba(255, 255, 255, 0.1);
        }

        [data-theme="dark"] .notification-toast__title {
            color: var(--color-text-primary, rgba(255, 255, 255, 0.9));
        }

        [data-theme="dark"] .notification-toast__message {
            color: var(--color-text-secondary, rgba(255, 255, 255, 0.6));
        }

        [data-theme="dark"] .notification-toast__time {
            color: var(--color-text-tertiary, rgba(255, 255, 255, 0.4));
        }

        [data-theme="dark"] .notification-toast__close {
            background: var(--color-surface-secondary, #2c2c2e);
            color: var(--color-text-secondary, rgba(255, 255, 255, 0.6));
        }

        [data-theme="dark"] .notification-toast__close:hover {
            background: var(--color-surface-tertiary, #3a3a3c);
            color: var(--color-text-primary, rgba(255, 255, 255, 0.9));
        }

        /* Mobile Responsive */
        @media (max-width: 480px) {
            .notification-toast {
                width: calc(100% - 40px);
                right: -100%;
            }

            .notification-toast.show {
                right: 20px;
            }
        }
    </style>

    <!-- ============================================
         ADMIN PROTECTION SCRIPT
         ============================================ -->
    <script>
        /**
         * Admin Protection System
         * Sch√ºtzt Admin-Bereiche mit Passwort-Dialog
         * Session-Token wird in localStorage gespeichert (1 Stunde g√ºltig)
         */

        // ‚úÖ FIX 2025-11-17: Admin Password Security
        // Password wird aus Firestore geladen ‚Üí Kein Hardcoded Password mehr im Code!
        // Fallback auf 'admin123' nur wenn Firestore fehlschl√§gt
        let ADMIN_PASSWORD = 'admin123'; // Default fallback (wird aus Firestore √ºberschrieben)
        const SESSION_DURATION = 60 * 60 * 1000; // 1 hour in milliseconds

        let pendingAdminLink = null;

        /**
         * Load admin password from Firestore
         * Collection: systemConfig_{werkstattId}
         * Document: adminSettings
         */
        async function loadAdminPassword() {
            try {
                if (!window.db || !window.werkstattId) {
                    console.warn('‚ö†Ô∏è [ADMIN] Firebase not ready, using fallback password');
                    return;
                }

                const configDoc = await window.db
                    .collection(`systemConfig_${window.werkstattId}`)
                    .doc('adminSettings')
                    .get();

                if (configDoc.exists && configDoc.data().adminPassword) {
                    ADMIN_PASSWORD = configDoc.data().adminPassword;
                    console.log('‚úÖ [ADMIN] Password loaded from Firestore');
                } else {
                    console.warn('‚ö†Ô∏è [ADMIN] No password in Firestore, using fallback');
                }
            } catch (error) {
                console.error('‚ùå [ADMIN] Error loading password:', error);
                console.warn('‚ö†Ô∏è [ADMIN] Using fallback password');
            }
        }

        // Load admin password when Firebase is ready
        window.addEventListener('firebaseReady', () => {
            loadAdminPassword();
        });

        /**
         * Check if admin session is valid
         */
        function isAdminSessionValid() {
            const session = localStorage.getItem('adminSession');
            if (!session) return false;

            try {
                const sessionData = JSON.parse(session);
                const now = Date.now();

                // Check if session is still valid
                if (sessionData.expiresAt > now) {
                    console.log('‚úÖ Admin session valid until:', new Date(sessionData.expiresAt).toLocaleString());
                    return true;
                } else {
                    console.log('‚è∞ Admin session expired');
                    localStorage.removeItem('adminSession');
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Error parsing admin session:', error);
                localStorage.removeItem('adminSession');
                return false;
            }
        }

        /**
         * Create admin session
         */
        function createAdminSession() {
            const expiresAt = Date.now() + SESSION_DURATION;
            const sessionData = {
                createdAt: Date.now(),
                expiresAt: expiresAt
            };
            localStorage.setItem('adminSession', JSON.stringify(sessionData));
            console.log('‚úÖ Admin session created, expires:', new Date(expiresAt).toLocaleString());
        }

        /**
         * Open admin password modal
         */
        function openAdminModal(targetUrl) {
            pendingAdminLink = targetUrl;
            const modal = document.getElementById('adminPasswordModal');
            const input = document.getElementById('adminPasswordInput');
            const error = document.getElementById('adminPasswordError');

            modal.classList.add('active');
            input.value = '';
            error.textContent = '';

            // Focus input
            setTimeout(() => input.focus(), 100);

            // Enter key listener
            input.onkeypress = (e) => {
                if (e.key === 'Enter') {
                    validateAdminPassword();
                }
            };
        }

        /**
         * Close admin password modal
         */
        function closeAdminModal() {
            const modal = document.getElementById('adminPasswordModal');
            modal.classList.remove('active');
            pendingAdminLink = null;
        }

        /**
         * Validate admin password
         */
        function validateAdminPassword() {
            const input = document.getElementById('adminPasswordInput');
            const error = document.getElementById('adminPasswordError');
            const password = input.value;

            if (!password) {
                error.textContent = '‚ö†Ô∏è Bitte Passwort eingeben';
                return;
            }

            // Check password
            if (password === ADMIN_PASSWORD) {
                console.log('‚úÖ Admin-Zugriff gew√§hrt');
                createAdminSession();
                closeAdminModal();

                // Navigate to admin page
                if (pendingAdminLink) {
                    safeNavigate(pendingAdminLink);
                }
            } else {
                console.log('‚ùå Zugriff verweigert');
                error.textContent = '‚ùå Falsches Passwort';
                input.value = '';
                input.focus();
            }
        }

        /**
         * Setup admin protection on page load
         */
        function setupAdminProtection() {
            console.log('üîí Setting up admin protection...');

            // Find all admin links
            const adminLinks = document.querySelectorAll('[data-permission]');

            console.log(`üîç Found ${adminLinks.length} admin links`);

            adminLinks.forEach(link => {
                const permission = link.getAttribute('data-permission');

                // Only protect admin-related permissions
                const adminPermissions = ['adminDashboard', 'mitarbeiterVerwaltung', 'adminEinstellungen', 'nutzerVerwaltung', 'setupWerkstatt'];

                if (adminPermissions.includes(permission)) {
                    console.log(`üîí Protecting: ${permission}`);

                    link.addEventListener('click', (e) => {
                        e.preventDefault();

                        // Check if admin session is valid
                        if (isAdminSessionValid()) {
                            console.log('‚úÖ Admin session valid, allowing access');
                            safeNavigate(link.href);
                        } else {
                            console.log('üîê No valid session, showing password modal');
                            openAdminModal(link.href);
                        }
                    });
                }
            });

            console.log('‚úÖ Admin protection setup complete');
        }

        // Initialize admin protection when DOM is ready
        if (document.readyState === 'loading') {
            window.listenerRegistry.registerDOM(document, 'DOMContentLoaded', setupAdminProtection, 'document DOMContentLoaded');
        } else {
            setupAdminProtection();
        }
    </script>

    <!-- ============================================
         SERVICE WORKER REGISTRATION - Offline-Funktionalit√§t
         ============================================ -->
    <script>
        // Service Worker nur registrieren wenn:
        // 1. Browser unterst√ºtzt Service Worker
        // 2. NICHT in Playwright Tests (navigator.webdriver)
        // 3. NICHT auf Emulator-Port (8000)
        if ('serviceWorker' in navigator && !navigator.webdriver && window.location.port !== '8000') {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('./sw.js', {
                        scope: './'
                    });

                    console.log('‚úÖ [SW] Service Worker registriert:', registration.scope);

                    // Update-Handling: Neuen SW aktivieren wenn gefunden
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('üîÑ [SW] Update gefunden, installiere...');

                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                console.log('‚úÖ [SW] Update bereit! Seite neu laden f√ºr neue Version.');

                                // Optional: Auto-reload nach 3 Sekunden
                                // setTimeout(() => window.location.reload(), 3000);
                            }
                        });
                    });

                } catch (error) {
                    console.error('‚ùå [SW] Registrierung fehlgeschlagen:', error);
                }
            });
        } else {
            console.log('‚ÑπÔ∏è [SW] Service Worker nicht registriert (Test-Modus oder nicht unterst√ºtzt)');
        }

        // ============================================
        // ACTIVE SESSIONS MONITORING (Multi-Tab)
        // ============================================

        let activeSessionsListener = null;

        /**
         * Setup realtime listener for active sessions
         */
        async function setupActiveSessionsListener() {
            const currentUser = window.authManager?.getCurrentUser();
            if (!currentUser || !currentUser.werkstattId) {
                console.log('‚ÑπÔ∏è No werkstattId - skipping active sessions listener');
                return;
            }

            // Cleanup existing listener
            if (activeSessionsListener) {
                activeSessionsListener();
            }

            console.log('üîÑ Setting up active sessions listener for:', currentUser.werkstattId);

            // Realtime listener for active sessions
            activeSessionsListener = window.getCollection('activeSessions')
                .where('werkstattId', '==', currentUser.werkstattId)
                .where('status', '==', 'active')
                .orderBy('loginTime', 'desc')
                .onSnapshot((snapshot) => {
                    const activeMitarbeiter = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        activeMitarbeiter.push({
                            id: doc.id,
                            name: data.mitarbeiterName || 'Unbekannt',
                            loginTime: data.loginTime?.toDate(),
                            mitarbeiterId: data.mitarbeiterId,
                            lastActivity: data.lastActivity?.toDate()
                        });
                    });

                    console.log(`‚úÖ Active sessions updated: ${activeMitarbeiter.length} mitarbeiter(s)`);
                    renderActiveMitarbeiter(activeMitarbeiter);
                }, (error) => {
                    console.error('‚ùå Active sessions listener error:', error);
                });
        }

        /**
         * Render active mitarbeiter list in UI
         * @param {Array} mitarbeiterList - List of active mitarbeiter
         */
        function renderActiveMitarbeiter(mitarbeiterList) {
            const section = document.getElementById('activeMitarbeiterSection');
            const list = document.getElementById('activeMitarbeiterList');
            const count = document.getElementById('activeMitarbeiterCount');

            if (!section || !list || !count) {
                console.warn('‚ö†Ô∏è Active sessions UI elements not found');
                return;
            }

            // Hide if no active mitarbeiter
            if (mitarbeiterList.length === 0) {
                section.style.display = 'none';
                return;
            }

            // Show section and update count
            section.style.display = 'block';
            count.textContent = mitarbeiterList.length;

            // Render list
            list.innerHTML = mitarbeiterList.map(m => {
                const timeStr = m.loginTime ?
                    m.loginTime.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' }) :
                    'unbekannt';
                return `<div style="padding: 6px 0; display: flex; align-items: center; gap: 8px;">
                    <span style="width: 6px; height: 6px; background: #10b981; border-radius: 50%;"></span>
                    <span>${m.name} <span style="color: var(--color-text-secondary);">(seit ${timeStr})</span></span>
                </div>`;
            }).join('');
        }

        /**
         * Initialize active sessions monitoring after auth
         */
        window.addEventListener('authStateChanged', async (event) => {
            const user = event.detail.user;
            if (user && user.werkstattId) {
                // Wait for Firebase to be ready
                await window.firebaseInitialized;
                // Setup listener
                await setupActiveSessionsListener();
            } else {
                // Cleanup listener on logout
                if (activeSessionsListener) {
                    activeSessionsListener();
                    activeSessionsListener = null;
                }
                // Hide section
                const section = document.getElementById('activeMitarbeiterSection');
                if (section) section.style.display = 'none';
            }
        });

        // Also setup on page load (if already logged in)
        (async () => {
            await window.firebaseInitialized;
            const currentUser = window.authManager?.getCurrentUser();
            if (currentUser && currentUser.werkstattId) {
                await setupActiveSessionsListener();
            }
        })();

        // ============================================
        // SERVICE-AUSWAHL MODAL (Phase 1.2)
        // ============================================

        /**
         * Show service selection modal after mitarbeiter login
         */
        function showServiceSelectionModal() {
            console.log('üé® Zeige Service-Auswahl Modal');
            document.getElementById('serviceAuswahlModal').style.display = 'block';
        }

        /**
         * Skip service selection and continue to dashboard
         */
        function skipServiceSelection() {
            console.log('‚è© Service-Auswahl √ºbersprungen');
            document.getElementById('serviceAuswahlModal').style.display = 'none';
            sessionStorage.setItem('currentServices', JSON.stringify([]));
        }

        /**
         * Confirm service selection and create firestore sessions
         */
        async function confirmServiceSelection() {
            console.log('‚úÖ Service-Auswahl best√§tigen...');

            // Hole ausgew√§hlte Services
            const checkboxes = document.querySelectorAll('input[name="service"]:checked');
            const selectedServices = Array.from(checkboxes).map(cb => cb.value);

            if (selectedServices.length === 0) {
                showToast('‚ö†Ô∏è Bitte mindestens einen Service ausw√§hlen!', 'warning', 3000);
                return;
            }

            // Hole Mitarbeiter-Daten aus sessionStorage
            const mitarbeiterStr = sessionStorage.getItem('mitarbeiter');
            if (!mitarbeiterStr) {
                console.error('‚ùå Kein Mitarbeiter in sessionStorage!');
                showToast('‚ùå Fehler: Kein Mitarbeiter eingeloggt', 'error', 3000);
                return;
            }

            const mitarbeiter = JSON.parse(mitarbeiterStr);

            // Speichere Services in sessionStorage
            sessionStorage.setItem('currentServices', JSON.stringify(selectedServices));

            // Erstelle serviceSessions in Firestore
            try {
                const sessionPromises = selectedServices.map(async (service) => {
                    const sessionData = {
                        mitarbeiterId: mitarbeiter.id,
                        mitarbeiterName: mitarbeiter.name,
                        service: service,
                        werkstattId: window.werkstattId,
                        loginTime: firebase.firestore.FieldValue.serverTimestamp(),
                        logoutTime: null,
                        status: 'active',
                        userAgent: navigator.userAgent.substring(0, 200)
                    };

                    return window.getCollection('serviceSessions').add(sessionData);
                });

                await Promise.all(sessionPromises);
                console.log(`‚úÖ ${selectedServices.length} Service-Session(s) erstellt:`, selectedServices);

                // Modal schlie√üen
                document.getElementById('serviceAuswahlModal').style.display = 'none';

                // Service-Namen f√ºr Toast (mit Emojis)
                const serviceEmojis = {
                    'lackierung': 'üé®',
                    'mechanik': 'üîß',
                    'reifen': 'üõû',
                    'pflege': '‚ú®',
                    'tuev': 'üìã',
                    'versicherung': 'üìÑ',
                    'glas': 'üîç',
                    'klima': '‚ùÑÔ∏è',
                    'dellen': 'üî®',
                    'folierung': 'üé¨',
                    'steinschutz': 'üõ°Ô∏è',
                    'werbebeklebung': 'üì¢'
                };

                const serviceNames = selectedServices.map(s => serviceEmojis[s] || '').join(' ');
                showToast(`‚úÖ Angemeldet f√ºr: ${serviceNames}`, 'success', 4000);

            } catch (error) {
                console.error('‚ùå Fehler beim Erstellen der Service-Sessions:', error);
                showToast('‚ùå Fehler beim Speichern der Services. Siehe Console.', 'error', 4000);
            }
        }

        // ============================================
        // üßπ STALE SESSION CLEANUP FUNCTION
        // ============================================
        // Manually clean up inactive sessions (>2h without heartbeat)
        // Fixes bug: 27 zombie sessions displayed after logout/crash/tab-close
        // ============================================

        async function cleanupAllStaleSessions() {
            if (!confirm('Alle inaktiven Sessions (>2h ohne Heartbeat) l√∂schen?\n\nDies entfernt Mitarbeiter, die angezeigt werden, aber nicht wirklich eingeloggt sind (z.B. nach Logout, Crash, oder Tab-Close).')) {
                return;
            }

            const currentUser = window.authManager?.getCurrentUser();
            if (!currentUser?.werkstattId) {
                showToast('‚ùå Fehler: Keine Berechtigung', 'error');
                return;
            }

            // ‚úÖ SECURITY: Block Mitarbeiter (Defense in Depth - Layer 2)
            const role = currentUser?.role;
            if (role === 'mitarbeiter') {
                showToast('‚ùå Keine Berechtigung: Nur Admin/Werkstatt k√∂nnen Sessions l√∂schen', 'error', 4000);
                console.warn('‚ö†Ô∏è Mitarbeiter attempted to clean sessions - BLOCKED by role check');
                return;
            }

            try {
                // Show loading state
                showToast('üßπ Suche inaktive Sessions...', 'info', 2000);

                const now = new Date();
                const twoHoursAgo = new Date(now.getTime() - 2 * 60 * 60 * 1000);

                // Query stale sessions (lastActivity > 2h ago)
                const staleSessionsSnapshot = await window.getCollection('activeSessions')
                    .where('werkstattId', '==', currentUser.werkstattId)
                    .where('status', '==', 'active')
                    .where('lastActivity', '<', firebase.firestore.Timestamp.fromDate(twoHoursAgo))
                    .get();

                console.log(`üßπ Found ${staleSessionsSnapshot.size} stale sessions to delete`);

                // Delete in batch for performance
                if (staleSessionsSnapshot.size > 0) {
                    const batch = window.db.batch();
                    staleSessionsSnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                        console.log(`   ‚ùå Deleting stale session: ${doc.id} (${doc.data().mitarbeiterName})`);
                    });

                    await batch.commit();
                    showToast(`‚úÖ ${staleSessionsSnapshot.size} inaktive Sessions gel√∂scht`, 'success', 4000);

                    // Update display
                    console.log('‚úÖ Stale sessions cleanup complete');

                } else {
                    showToast('‚ÑπÔ∏è Keine inaktiven Sessions gefunden', 'info', 3000);
                    console.log('‚ÑπÔ∏è No stale sessions found (all sessions have heartbeat within 2h)');
                }

            } catch (error) {
                console.error('‚ùå Fehler beim Cleanup:', error);
                showToast(`‚ùå Fehler beim Aufr√§umen: ${error.message}`, 'error', 5000);
            }
        }

        // ============================================
        // URLAUBS-ANFRAGE MODAL (Phase 2.1)
        // ============================================

        /**
         * Open vacation request modal
         */
        async function openUrlaubAnfrageModal() {
            console.log('üèñÔ∏è √ñffne Urlaubs-Anfrage Modal');

            // Hole Mitarbeiter-Daten aus sessionStorage
            const mitarbeiterStr = sessionStorage.getItem('mitarbeiter');
            if (!mitarbeiterStr) {
                showToast('‚ùå Kein Mitarbeiter eingeloggt!', 'error', 3000);
                return;
            }

            const mitarbeiter = JSON.parse(mitarbeiterStr);

            // Lade Urlaubstage-Info
            try {
                // Hole Mitarbeiter-Dokument aus Firestore f√ºr aktuelle Urlaubstage
                const mitarbeiterDoc = await window.getCollection('mitarbeiter').doc(mitarbeiter.id).get();
                const mitarbeiterData = mitarbeiterDoc.data();

                const urlaubstageJahr = mitarbeiterData.urlaubstageJahr || 30;
                const urlaubstageVerbraucht = mitarbeiterData.urlaubstageVerbraucht || 0;
                const urlaubstageVerfuegbar = urlaubstageJahr - urlaubstageVerbraucht;

                // Anzeige aktualisieren
                document.getElementById('urlaubTageAnzeige').textContent =
                    `‚úÖ Verf√ºgbar: ${urlaubstageVerfuegbar} von ${urlaubstageJahr} Tagen (${urlaubstageVerbraucht} verbraucht)`;

                // Speichere f√ºr Validierung
                window.currentMitarbeiterUrlaubsdaten = {
                    urlaubstageJahr,
                    urlaubstageVerbraucht,
                    urlaubstageVerfuegbar
                };

            } catch (error) {
                console.error('‚ùå Fehler beim Laden der Urlaubstage:', error);
                document.getElementById('urlaubTageAnzeige').textContent = 'Fehler beim Laden der Urlaubstage';
            }

            // Modal anzeigen
            document.getElementById('urlaubAnfrageModal').style.display = 'block';

            // Event Listener f√ºr automatische Berechnung der Tage
            const startInput = document.getElementById('urlaubStartDatum');
            const endInput = document.getElementById('urlaubEndDatum');

            startInput.addEventListener('change', calculateUrlaubsTage);
            endInput.addEventListener('change', calculateUrlaubsTage);
        }

        /**
         * Close vacation request modal
         */
        function closeUrlaubAnfrageModal() {
            console.log('üèñÔ∏è Schlie√üe Urlaubs-Anfrage Modal');
            document.getElementById('urlaubAnfrageModal').style.display = 'none';

            // Reset form
            document.getElementById('urlaubStartDatum').value = '';
            document.getElementById('urlaubEndDatum').value = '';
            document.getElementById('urlaubGrund').value = '';
            document.getElementById('urlaubAnzahlTageContainer').style.display = 'none';
        }

        /**
         * Calculate vacation days (Werktage Mo-Fr)
         */
        function calculateUrlaubsTage() {
            const startInput = document.getElementById('urlaubStartDatum');
            const endInput = document.getElementById('urlaubEndDatum');

            if (!startInput.value || !endInput.value) return;

            const start = new Date(startInput.value);
            const end = new Date(endInput.value);

            // Validierung: Enddatum muss nach Startdatum liegen
            if (end < start) {
                document.getElementById('urlaubAnzahlTageContainer').style.display = 'none';
                showToast('‚ö†Ô∏è Enddatum muss nach Startdatum liegen!', 'warning', 3000);
                return;
            }

            // Berechne Werktage (Montag-Freitag)
            let werktage = 0;
            let current = new Date(start);

            while (current <= end) {
                const dayOfWeek = current.getDay();
                // 0 = Sonntag, 6 = Samstag ‚Üí nur 1-5 z√§hlen
                if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                    werktage++;
                }
                current.setDate(current.getDate() + 1);
            }

            // Anzeige aktualisieren
            document.getElementById('urlaubAnzahlTage').textContent = werktage;
            document.getElementById('urlaubAnzahlTageContainer').style.display = 'block';

            console.log(`üìä Berechnete Werktage: ${werktage}`);
        }

        /**
         * Submit vacation request
         */
        async function submitUrlaubsAnfrage(event) {
            event.preventDefault();
            console.log('‚úÖ Urlaubs-Anfrage wird gesendet...');

            // Hole Mitarbeiter-Daten
            const mitarbeiterStr = sessionStorage.getItem('mitarbeiter');
            if (!mitarbeiterStr) {
                showToast('‚ùå Kein Mitarbeiter eingeloggt!', 'error', 3000);
                return;
            }

            const mitarbeiter = JSON.parse(mitarbeiterStr);

            // Form-Daten
            const startDatum = document.getElementById('urlaubStartDatum').value;
            const endDatum = document.getElementById('urlaubEndDatum').value;
            const grund = document.getElementById('urlaubGrund').value.trim();

            if (!startDatum || !endDatum) {
                showToast('‚ö†Ô∏è Bitte Start- und Enddatum ausw√§hlen!', 'warning', 3000);
                return;
            }

            // Berechne Anzahl Tage nochmal (f√ºr Sicherheit)
            const start = new Date(startDatum);
            const end = new Date(endDatum);
            let anzahlTage = 0;
            let current = new Date(start);

            while (current <= end) {
                const dayOfWeek = current.getDay();
                if (dayOfWeek >= 1 && dayOfWeek <= 5) {
                    anzahlTage++;
                }
                current.setDate(current.getDate() + 1);
            }

            // Validierung: Genug Urlaubstage verf√ºgbar?
            if (window.currentMitarbeiterUrlaubsdaten) {
                const verfuegbar = window.currentMitarbeiterUrlaubsdaten.urlaubstageVerfuegbar;
                if (anzahlTage > verfuegbar) {
                    showToast(`‚ùå Nicht genug Urlaubstage! Du hast nur ${verfuegbar} Tage verf√ºgbar.`, 'error', 4000);
                    return;
                }
            }

            // Button deaktivieren
            const submitBtn = document.getElementById('urlaubAnfrageSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Wird gesendet...';

            try {
                // Erstelle Anfrage in Firestore
                const anfrageData = {
                    mitarbeiterId: mitarbeiter.id,
                    mitarbeiterName: mitarbeiter.name,
                    mitarbeiterRolle: mitarbeiter.rolle || 'Sonstige',
                    startDatum: startDatum,
                    endDatum: endDatum,
                    anzahlTage: anzahlTage,
                    grund: grund || 'Keine Angabe',
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    werkstattId: window.werkstattId,
                    bearbeitetVon: null,
                    bearbeitetAm: null,
                    ablehnungsgrund: null
                };

                await window.getCollection('urlaubsAnfragen').add(anfrageData);

                console.log('‚úÖ Urlaubs-Anfrage erfolgreich erstellt:', anfrageData);

                // Modal schlie√üen
                closeUrlaubAnfrageModal();

                // Success Toast
                showToast(`‚úÖ Urlaubs-Anfrage gesendet!\n${anzahlTage} Tage vom ${start.toLocaleDateString('de-DE')} bis ${end.toLocaleDateString('de-DE')}`, 'success', 5000);

            } catch (error) {
                console.error('‚ùå Fehler beim Erstellen der Urlaubs-Anfrage:', error);
                showToast('‚ùå Fehler beim Senden der Anfrage. Siehe Console.', 'error', 4000);
            } finally {
                // Button wieder aktivieren
                submitBtn.disabled = false;
                submitBtn.textContent = '‚úÖ Anfrage senden';
            }
        }
    </script>
</body>
</html>
