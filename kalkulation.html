<!DOCTYPE html>
<html lang="de" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ§® Kalkulation - Fahrzeugannahme App</title>

    <!-- ðŸŒ“ FOUC Prevention: Load Theme BEFORE CSS -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>

    <!-- Design System CSS -->
    <link rel="stylesheet" href="design-system.css">
    <link rel="stylesheet" href="components.css">
    <link rel="stylesheet" href="animations.css">
    <link rel="stylesheet" href="mobile-first.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="listener-registry.js"></script>
    <script src="js/auth-manager.js"></script>

    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>

    <!-- Sketchfab Viewer API -->
    <script src="https://static.sketchfab.com/api/sketchfab-viewer-1.12.1.js"></script>

    <!-- jsPDF fÃ¼r PDF-Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Ersatzteile-Datenbank mit OE-Nummern -->
    <script src="ersatzteile-db.js"></script>

    <style>
        /* ============================================
           ðŸ§® KALKULATION PAGE SPECIFIC STYLES
           ============================================ */

        body {
            min-height: 100vh;
            background: var(--color-background);
        }

        .page-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-6);
        }

        /* Header */
        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-8);
            flex-wrap: wrap;
            gap: var(--space-4);
        }

        .page-header-left {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .back-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            background: var(--color-surface);
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-button);
            color: var(--color-text-primary);
            cursor: pointer;
            transition: all var(--duration-base) var(--ease-out);
        }

        .back-button:hover {
            background: var(--color-primary);
            color: white;
            transform: translateX(-2px);
        }

        .page-title {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .page-title h1 {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin: 0;
        }

        .page-title .badge {
            background: var(--color-primary);
            color: white;
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            gap: var(--space-2);
            background: var(--color-surface);
            padding: var(--space-2);
            border-radius: var(--radius-card);
            border: 1px solid var(--color-border-glass);
            margin-bottom: var(--space-6);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab-button {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-5);
            background: transparent;
            border: none;
            border-radius: var(--radius-button);
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all var(--duration-base) var(--ease-out);
            white-space: nowrap;
        }

        .tab-button:hover {
            background: rgba(var(--color-primary-rgb), 0.1);
            color: var(--color-primary);
        }

        .tab-button.active {
            background: var(--color-primary);
            color: white;
            box-shadow: var(--shadow-primary);
        }

        .tab-button i {
            width: 18px;
            height: 18px;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s var(--ease-out);
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Content Cards */
        .content-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-card);
            padding: var(--space-6);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
        }

        .content-card__header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-6);
            flex-wrap: wrap;
            gap: var(--space-4);
        }

        .content-card__title {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .content-card__title h2 {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin: 0;
        }

        .content-card__title i {
            color: var(--color-primary);
        }

        /* Form Styles */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-5);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .form-group label {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
        }

        .form-group input,
        .form-group select {
            padding: var(--space-3) var(--space-4);
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-input);
            font-size: var(--font-size-base);
            color: var(--color-text-primary);
            transition: all var(--duration-base) var(--ease-out);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: var(--shadow-focus);
        }

        .form-group .input-suffix {
            position: relative;
        }

        .form-group .input-suffix input {
            padding-right: var(--space-12);
        }

        .form-group .input-suffix span {
            position: absolute;
            right: var(--space-4);
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
        }

        .form-group small {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-5);
            border: none;
            border-radius: var(--radius-button);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all var(--duration-base) var(--ease-out);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);
            color: white;
            box-shadow: var(--shadow-primary);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            color: var(--color-text-primary);
        }

        .btn-secondary:hover {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .btn-success {
            background: linear-gradient(135deg, #34c759 0%, #30b350 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(52, 199, 89, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Table Styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: var(--space-4);
            text-align: left;
            border-bottom: 1px solid var(--color-border);
        }

        .data-table th {
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background: rgba(var(--color-primary-rgb), 0.05);
        }

        .data-table td {
            font-size: var(--font-size-sm);
            color: var(--color-text-primary);
        }

        .data-table tr:hover td {
            background: rgba(var(--color-primary-rgb), 0.03);
        }

        .data-table .actions {
            display: flex;
            gap: var(--space-2);
        }

        .data-table .btn-icon {
            width: 32px;
            height: 32px;
            padding: 0;
            border-radius: var(--radius-button);
        }

        .data-table .btn-icon i {
            width: 16px;
            height: 16px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: var(--space-12);
            color: var(--color-text-secondary);
        }

        .empty-state i {
            width: 48px;
            height: 48px;
            margin-bottom: var(--space-4);
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-medium);
            margin-bottom: var(--space-2);
            color: var(--color-text-primary);
        }

        .empty-state p {
            font-size: var(--font-size-sm);
            margin-bottom: var(--space-6);
        }

        /* Search & Filter */
        .search-filter-bar {
            display: flex;
            gap: var(--space-4);
            margin-bottom: var(--space-6);
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            position: relative;
        }

        .search-input i {
            position: absolute;
            left: var(--space-4);
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-text-secondary);
            width: 18px;
            height: 18px;
        }

        .search-input input {
            width: 100%;
            padding: var(--space-3) var(--space-4) var(--space-3) var(--space-12);
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-input);
            font-size: var(--font-size-sm);
            color: var(--color-text-primary);
        }

        .search-input input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: var(--shadow-focus);
        }

        /* Category Groups */
        .category-group {
            margin-bottom: var(--space-6);
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-4);
            background: rgba(var(--color-primary-rgb), 0.1);
            border-radius: var(--radius-button);
            margin-bottom: var(--space-3);
        }

        .category-header h3 {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            color: var(--color-primary);
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .category-header .count {
            background: var(--color-primary);
            color: white;
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
        }

        /* Kalkulation Summary */
        .kalkulation-summary {
            background: linear-gradient(135deg, rgba(var(--color-primary-rgb), 0.1) 0%, rgba(var(--color-primary-rgb), 0.05) 100%);
            border: 1px solid rgba(var(--color-primary-rgb), 0.2);
            border-radius: var(--radius-card);
            padding: var(--space-6);
            margin-top: var(--space-6);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-2) 0;
        }

        .summary-row.total {
            border-top: 2px solid var(--color-border);
            margin-top: var(--space-4);
            padding-top: var(--space-4);
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
        }

        .summary-row .label {
            color: var(--color-text-secondary);
        }

        .summary-row .value {
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
        }

        .summary-row.total .value {
            color: var(--color-primary);
        }

        /* ============================================
           ðŸš— FAHRZEUG-DIAGRAMM & SCHADENS-WIZARD
           ============================================ */

        .vehicle-selector {
            background: var(--color-surface);
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-card);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
        }

        .vehicle-selector__header {
            text-align: center;
            margin-bottom: var(--space-6);
        }

        .vehicle-selector__header h3 {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin: 0 0 var(--space-2) 0;
        }

        .vehicle-selector__header p {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            margin: 0;
        }

        .vehicle-diagram {
            display: flex;
            justify-content: center;
            margin-bottom: var(--space-6);
        }

        .vehicle-svg {
            max-width: 100%;
            height: auto;
        }

        .vehicle-part {
            cursor: pointer;
            transition: all 0.2s ease;
            fill: var(--color-surface);
            stroke: var(--color-border);
            stroke-width: 2;
        }

        .vehicle-part:hover {
            fill: rgba(var(--color-primary-rgb), 0.2);
            stroke: var(--color-primary);
            stroke-width: 3;
        }

        .vehicle-part.selected {
            fill: rgba(var(--color-primary-rgb), 0.3);
            stroke: var(--color-primary);
            stroke-width: 3;
        }

        .vehicle-part.damaged-light {
            fill: rgba(255, 193, 7, 0.3);
            stroke: #ffc107;
        }

        .vehicle-part.damaged-medium {
            fill: rgba(255, 152, 0, 0.3);
            stroke: #ff9800;
        }

        .vehicle-part.damaged-heavy {
            fill: rgba(244, 67, 54, 0.3);
            stroke: #f44336;
        }

        .vehicle-part-label {
            font-size: 10px;
            fill: var(--color-text-secondary);
            pointer-events: none;
            text-anchor: middle;
        }

        /* 2D/3D View Toggle */
        .view-toggle-btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-4);
            border: 1px solid var(--color-border);
            background: var(--color-surface);
            color: var(--color-text-secondary);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .view-toggle-btn:hover {
            border-color: var(--color-primary);
            color: var(--color-primary);
        }

        .view-toggle-btn.active {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: white;
        }

        .view-toggle-btn svg {
            width: 16px;
            height: 16px;
        }

        /* 3D Container */
        .vehicle-3d-container {
            margin-bottom: var(--space-6);
        }

        .sketchfab-embed-wrapper iframe {
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border-glass);
        }

        /* 3D Part Buttons */
        .part-btn-3d {
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--color-border);
            background: var(--color-surface);
            color: var(--color-text-primary);
            border-radius: var(--radius-md);
            font-size: var(--font-size-xs);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .part-btn-3d:hover {
            border-color: var(--color-primary);
            background: rgba(var(--color-primary-rgb), 0.1);
            color: var(--color-primary);
        }

        .part-btn-3d.selected {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: white;
        }

        /* Fahrzeugtyp-Buttons */
        .vehicle-type-btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-4);
            border: 2px solid var(--color-border);
            background: var(--color-surface);
            color: var(--color-text-primary);
            border-radius: var(--radius-lg);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .vehicle-type-btn:hover {
            border-color: var(--color-primary);
            background: rgba(var(--color-primary-rgb), 0.05);
        }

        .vehicle-type-btn.active {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: white;
        }

        /* Spinner Animation */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Schadens-Wizard */
        .damage-wizard {
            display: none;
            background: linear-gradient(135deg, rgba(var(--color-primary-rgb), 0.05) 0%, transparent 100%);
            border: 1px solid rgba(var(--color-primary-rgb), 0.2);
            border-radius: var(--radius-card);
            padding: var(--space-6);
            margin-top: var(--space-4);
            animation: fadeIn 0.3s ease;
        }

        .damage-wizard.active {
            display: block;
        }

        .damage-wizard__header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-5);
        }

        .damage-wizard__title {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .damage-wizard__title h4 {
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin: 0;
        }

        .damage-wizard__close {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            border-radius: var(--radius-button);
            color: var(--color-text-secondary);
            cursor: pointer;
        }

        .damage-wizard__close:hover {
            background: var(--color-error);
            color: white;
        }

        .damage-options {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-3);
            margin-bottom: var(--space-5);
        }

        .damage-option {
            flex: 1;
            min-width: 120px;
            padding: var(--space-4);
            background: var(--color-surface);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-button);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .damage-option:hover {
            border-color: var(--color-primary);
            background: rgba(var(--color-primary-rgb), 0.05);
        }

        .damage-option.selected {
            border-color: var(--color-primary);
            background: rgba(var(--color-primary-rgb), 0.1);
        }

        .damage-option__icon {
            font-size: 24px;
            margin-bottom: var(--space-2);
        }

        .damage-option__label {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
        }

        /* Vorgeschlagene Positionen */
        .suggested-positions {
            margin-top: var(--space-5);
        }

        .suggested-positions__header {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--space-3);
        }

        .suggested-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-3) var(--space-4);
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-button);
            margin-bottom: var(--space-2);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .suggested-item:hover {
            border-color: var(--color-primary);
            background: rgba(var(--color-primary-rgb), 0.05);
        }

        .suggested-item.added {
            border-color: var(--color-success);
            background: rgba(52, 199, 89, 0.1);
        }

        .suggested-item__info {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .suggested-item__checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--color-border);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .suggested-item.added .suggested-item__checkbox {
            background: var(--color-success);
            border-color: var(--color-success);
            color: white;
        }

        .suggested-item__name {
            font-size: var(--font-size-sm);
            color: var(--color-text-primary);
        }

        .suggested-item__price {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            color: var(--color-primary);
        }

        /* Schnellsuche Autocomplete */
        .quick-search {
            position: relative;
            margin-bottom: var(--space-6);
        }

        .quick-search__input {
            width: 100%;
            padding: var(--space-4) var(--space-5);
            padding-left: var(--space-12);
            background: var(--color-surface);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-card);
            font-size: var(--font-size-base);
            color: var(--color-text-primary);
            transition: all 0.2s ease;
        }

        .quick-search__input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 4px rgba(var(--color-primary-rgb), 0.1);
        }

        .quick-search__icon {
            position: absolute;
            left: var(--space-4);
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-text-secondary);
        }

        .quick-search__results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-card);
            box-shadow: var(--shadow-lg);
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .quick-search__results.active {
            display: block;
        }

        .quick-search__result {
            padding: var(--space-3) var(--space-4);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border-bottom: 1px solid var(--color-border);
        }

        .quick-search__result:last-child {
            border-bottom: none;
        }

        .quick-search__result:hover {
            background: rgba(var(--color-primary-rgb), 0.05);
        }

        .quick-search__result-name {
            font-size: var(--font-size-sm);
            color: var(--color-text-primary);
        }

        .quick-search__result-name mark {
            background: rgba(var(--color-primary-rgb), 0.3);
            color: inherit;
            padding: 0 2px;
            border-radius: 2px;
        }

        .quick-search__result-meta {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }

        /* OE-Nummern Suche */
        .oe-search-container {
            background: var(--color-surface);
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-card);
            padding: var(--space-5);
            margin-bottom: var(--space-6);
        }

        .oe-search-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-4);
        }

        .oe-search-title {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
        }

        .oe-search-stats {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
            background: var(--color-background);
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-button);
        }

        .oe-search-input-group {
            display: flex;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
        }

        .oe-search-input {
            flex: 1;
            padding: var(--space-3) var(--space-4);
            background: var(--color-background);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-button);
            font-size: var(--font-size-sm);
            color: var(--color-text-primary);
            transition: all 0.2s ease;
        }

        .oe-search-input:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .oe-search-input::placeholder {
            color: var(--color-text-secondary);
        }

        .oe-vehicle-select {
            display: flex;
            gap: var(--space-2);
        }

        .oe-vehicle-select select {
            padding: var(--space-2) var(--space-3);
            background: var(--color-background);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-button);
            font-size: var(--font-size-sm);
            color: var(--color-text-primary);
            cursor: pointer;
        }

        .oe-results {
            max-height: 350px;
            overflow-y: auto;
        }

        .oe-result-item {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            padding: var(--space-3) var(--space-4);
            background: var(--color-background);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-button);
            margin-bottom: var(--space-2);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .oe-result-item:hover {
            border-color: var(--color-primary);
            background: rgba(var(--color-primary-rgb), 0.05);
        }

        .oe-result-info {
            flex: 1;
        }

        .oe-result-part {
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
            margin-bottom: var(--space-1);
        }

        .oe-result-vehicle {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }

        .oe-result-oe {
            font-family: monospace;
            font-size: var(--font-size-sm);
            background: var(--color-primary);
            color: white;
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-button);
            white-space: nowrap;
        }

        .oe-no-results {
            text-align: center;
            padding: var(--space-6);
            color: var(--color-text-secondary);
        }

        .oe-no-results i {
            font-size: 2rem;
            margin-bottom: var(--space-2);
            display: block;
        }

        /* ============================================
           NEUER KALKULATIONS-WIZARD STYLES
           ============================================ */

        /* Step Progress Bar */
        .kalk-steps {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-6);
            background: var(--color-surface);
            border-radius: var(--radius-card);
            margin-bottom: var(--space-6);
        }

        .kalk-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-2);
            opacity: 0.5;
            transition: all 0.3s ease;
        }

        .kalk-step.active {
            opacity: 1;
        }

        .kalk-step.completed {
            opacity: 1;
        }

        .kalk-step__number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--color-border);
            color: var(--color-text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-lg);
            transition: all 0.3s ease;
        }

        .kalk-step.active .kalk-step__number {
            background: var(--color-primary);
            color: white;
        }

        .kalk-step.completed .kalk-step__number {
            background: var(--color-success);
            color: white;
        }

        .kalk-step__label {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            text-align: center;
        }

        .kalk-step.active .kalk-step__label {
            color: var(--color-text-primary);
            font-weight: var(--font-weight-medium);
        }

        .kalk-step__line {
            flex: 1;
            max-width: 60px;
            height: 3px;
            background: var(--color-border);
            border-radius: 2px;
        }

        /* Step Content */
        .kalk-step-content {
            display: none;
        }

        .kalk-step-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Vehicle Form */
        .kalk-vehicle-form {
            padding: var(--space-6);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-4);
            margin-bottom: var(--space-4);
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .kalk-vehicle-info {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            padding: var(--space-4);
            background: rgba(var(--color-success-rgb), 0.1);
            border: 1px solid var(--color-success);
            border-radius: var(--radius-card);
            margin-top: var(--space-4);
        }

        .kalk-vehicle-info__icon {
            font-size: 2rem;
        }

        .kalk-vehicle-info__details {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }

        .kalk-vehicle-info__details strong {
            font-size: var(--font-size-lg);
        }

        .kalk-vehicle-info__details span {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        /* Step Actions */
        .kalk-step-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-6);
            border-top: 1px solid var(--color-border);
            margin-top: var(--space-6);
        }

        .btn-lg {
            padding: var(--space-4) var(--space-6);
            font-size: var(--font-size-base);
        }

        /* Selected Vehicle Display */
        .kalk-selected-vehicle {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-4);
            background: rgba(var(--color-primary-rgb), 0.1);
            border-radius: var(--radius-button);
            margin-bottom: var(--space-4);
        }

        .kalk-selected-vehicle__label {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .kalk-selected-vehicle__value {
            font-weight: var(--font-weight-semibold);
            color: var(--color-primary);
        }

        /* Selected Part Display */
        .kalk-selected-part {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-4);
            background: rgba(var(--color-success-rgb), 0.1);
            border: 2px solid var(--color-success);
            border-radius: var(--radius-card);
            margin: var(--space-4) 0;
        }

        .kalk-selected-part__icon {
            width: 32px;
            height: 32px;
            background: var(--color-success);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .kalk-selected-part__info {
            flex: 1;
        }

        .kalk-selected-part__info strong {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .kalk-selected-part__info span {
            display: block;
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
        }

        /* Parts List */
        .kalk-parts-list {
            margin: var(--space-4) 0;
            padding: var(--space-4);
            background: var(--color-surface);
            border-radius: var(--radius-card);
        }

        .kalk-parts-list h4 {
            margin-bottom: var(--space-3);
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
        }

        /* Repair Options */
        .kalk-repair-options {
            padding: var(--space-6);
        }

        .kalk-repair-options h4 {
            margin-bottom: var(--space-2);
        }

        .kalk-repair-hint {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
            margin-bottom: var(--space-4);
        }

        .repair-options-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-3);
        }

        @media (max-width: 992px) {
            .repair-options-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .repair-options-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .repair-option {
            cursor: pointer;
        }

        .repair-option input[type="checkbox"] {
            display: none;
        }

        .repair-option__content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-4);
            background: var(--color-surface);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-card);
            transition: all 0.2s ease;
        }

        .repair-option:hover .repair-option__content {
            border-color: var(--color-primary);
            background: rgba(var(--color-primary-rgb), 0.05);
        }

        .repair-option input[type="checkbox"]:checked + .repair-option__content {
            border-color: var(--color-success);
            background: rgba(var(--color-success-rgb), 0.1);
        }

        .repair-option__icon {
            font-size: 1.5rem;
        }

        .repair-option__label {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            text-align: center;
        }

        /* Kalkulation Summary */
        .kalk-summary {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: var(--space-6);
            padding: var(--space-6);
        }

        @media (max-width: 768px) {
            .kalk-summary {
                grid-template-columns: 1fr;
            }
        }

        .kalk-summary__vehicle,
        .kalk-summary__parts {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-card);
            padding: var(--space-4);
        }

        .kalk-summary h4 {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--space-3);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .damage-option {
                min-width: calc(50% - var(--space-2));
            }

            .vehicle-svg {
                max-width: 100%;
            }

            .kalk-steps {
                flex-wrap: wrap;
                gap: var(--space-3);
            }

            .kalk-step__line {
                display: none;
            }
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: var(--space-6);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--color-surface);
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-card);
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s var(--ease-out);
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: scale(0.95) translateY(-20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-5) var(--space-6);
            border-bottom: 1px solid var(--color-border);
        }

        .modal-header h3 {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin: 0;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            border-radius: var(--radius-button);
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: all var(--duration-base) var(--ease-out);
        }

        .modal-close:hover {
            background: var(--color-error);
            color: white;
        }

        .modal-body {
            padding: var(--space-6);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: var(--space-3);
            padding: var(--space-5) var(--space-6);
            border-top: 1px solid var(--color-border);
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: var(--space-6);
            right: var(--space-6);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }

        .toast {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-4) var(--space-5);
            background: var(--color-surface);
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-card);
            box-shadow: var(--shadow-lg);
            animation: toastSlideIn 0.3s var(--ease-out);
        }

        .toast.success {
            border-left: 4px solid #34c759;
        }

        .toast.error {
            border-left: 4px solid var(--color-error);
        }

        .toast.info {
            border-left: 4px solid var(--color-primary);
        }

        @keyframes toastSlideIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .page-container {
                padding: var(--space-4);
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .tab-navigation {
                width: 100%;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .content-card__header {
                flex-direction: column;
                align-items: flex-start;
            }

            .data-table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <!-- Header -->
        <header class="page-header">
            <div class="page-header-left">
                <button class="back-button" onclick="safeNavigate('index.html')" title="ZurÃ¼ck zum Dashboard">
                    <i data-feather="arrow-left"></i>
                </button>
                <div class="page-title">
                    <h1>ðŸ§® Kalkulation</h1>
                    <span class="badge">NEU</span>
                </div>
            </div>
        </header>

        <!-- Tab Navigation -->
        <nav class="tab-navigation">
            <button class="tab-button active" data-tab="kalkulation" onclick="switchTab('kalkulation')">
                <i data-feather="hash"></i>
                <span>Neue Kalkulation</span>
            </button>
            <button class="tab-button" data-tab="katalog" onclick="switchTab('katalog')">
                <i data-feather="book"></i>
                <span>Arbeitswert-Katalog</span>
            </button>
            <button class="tab-button" data-tab="saetze" onclick="switchTab('saetze')">
                <i data-feather="dollar-sign"></i>
                <span>StundensÃ¤tze</span>
            </button>
            <button class="tab-button" data-tab="material" onclick="switchTab('material')">
                <i data-feather="package"></i>
                <span>Material</span>
            </button>
            <button class="tab-button" data-tab="historie" onclick="switchTab('historie')">
                <i data-feather="clock"></i>
                <span>Historie</span>
            </button>
        </nav>

        <!-- ============================================ -->
        <!-- TAB 1: Neue Kalkulation erstellen -->
        <!-- ============================================ -->
        <section id="tab-kalkulation" class="tab-content active">

            <!-- ============================================ -->
            <!-- STEP PROGRESS BAR -->
            <!-- ============================================ -->
            <div class="kalk-steps">
                <div class="kalk-step active" data-step="1">
                    <div class="kalk-step__number">1</div>
                    <div class="kalk-step__label">Fahrzeug</div>
                </div>
                <div class="kalk-step__line"></div>
                <div class="kalk-step" data-step="2">
                    <div class="kalk-step__number">2</div>
                    <div class="kalk-step__label">Teil wÃ¤hlen</div>
                </div>
                <div class="kalk-step__line"></div>
                <div class="kalk-step" data-step="3">
                    <div class="kalk-step__number">3</div>
                    <div class="kalk-step__label">Reparatur</div>
                </div>
                <div class="kalk-step__line"></div>
                <div class="kalk-step" data-step="4">
                    <div class="kalk-step__number">4</div>
                    <div class="kalk-step__label">Kalkulation</div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- STEP 1: FAHRZEUGDATEN -->
            <!-- ============================================ -->
            <div class="kalk-step-content active" id="stepContent1">
                <div class="content-card">
                    <div class="content-card__header">
                        <div class="content-card__title">
                            <i data-feather="truck"></i>
                            <h2>Schritt 1: Fahrzeugdaten eingeben</h2>
                        </div>
                    </div>

                    <div class="kalk-vehicle-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="kalkMarke">Marke *</label>
                                <select id="kalkMarke" onchange="updateKalkModelle()" required>
                                    <option value="">-- Marke wÃ¤hlen --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="kalkModell">Modell *</label>
                                <select id="kalkModell" required>
                                    <option value="">-- Erst Marke wÃ¤hlen --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="kalkBaujahr">Baujahr *</label>
                                <select id="kalkBaujahr" required>
                                    <option value="">-- Baujahr --</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="kalkKennzeichen">Kennzeichen (optional)</label>
                                <input type="text" id="kalkKennzeichen" placeholder="z.B. MOS-AB 123">
                            </div>
                            <div class="form-group">
                                <label for="kalkFarbe">Farbcode (optional)</label>
                                <input type="text" id="kalkFarbe" placeholder="z.B. LY9T">
                            </div>
                            <div class="form-group">
                                <label for="kalkKunde">Kundenname (optional)</label>
                                <input type="text" id="kalkKunde" placeholder="z.B. Max Mustermann">
                            </div>
                        </div>

                        <!-- Fahrzeug-Info Box -->
                        <div class="kalk-vehicle-info" id="kalkVehicleInfo" style="display: none;">
                            <div class="kalk-vehicle-info__icon">ðŸš—</div>
                            <div class="kalk-vehicle-info__details">
                                <strong id="kalkVehicleDisplay">-</strong>
                                <span id="kalkVehicleExtra">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="kalk-step-actions">
                        <div></div>
                        <button class="btn btn-primary btn-lg" onclick="goToStep(2)" id="btnStep1Next">
                            Weiter zu Teil wÃ¤hlen
                            <i data-feather="arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- STEP 2: TEIL AUSWÃ„HLEN -->
            <!-- ============================================ -->
            <div class="kalk-step-content" id="stepContent2">
                <div class="content-card">
                    <div class="content-card__header">
                        <div class="content-card__title">
                            <i data-feather="crosshair"></i>
                            <h2>Schritt 2: BeschÃ¤digtes Teil wÃ¤hlen</h2>
                        </div>
                    </div>

                    <!-- GewÃ¤hltes Fahrzeug anzeigen -->
                    <div class="kalk-selected-vehicle" id="step2VehicleInfo">
                        <span class="kalk-selected-vehicle__label">Fahrzeug:</span>
                        <span class="kalk-selected-vehicle__value" id="step2VehicleDisplay">-</span>
                    </div>

                    <!-- Ansicht-Umschalter -->
                    <div class="view-toggle" style="margin: var(--space-4) 0; display: flex; justify-content: center; gap: var(--space-2);">
                        <button class="view-toggle-btn active" data-view="2d" onclick="switchVehicleView('2d')">
                            <i data-feather="layout"></i> 2D Draufsicht
                        </button>
                        <button class="view-toggle-btn" data-view="3d" onclick="switchVehicleView('3d')">
                            <i data-feather="box"></i> 3D Modell
                        </button>
                    </div>

                    <!-- 3D Sketchfab Viewer (versteckt by default) -->
                    <div id="vehicle3DView" class="vehicle-3d-container" style="display: none;">

                        <!-- Fahrzeugtyp-Auswahl -->
                        <div class="vehicle-type-selector" style="display: flex; justify-content: center; gap: var(--space-2); margin-bottom: var(--space-4); flex-wrap: wrap;">
                            <button class="vehicle-type-btn active" data-type="sedan" onclick="changeVehicleType('sedan')">
                                ðŸš— Limousine
                            </button>
                            <button class="vehicle-type-btn" data-type="suv" onclick="changeVehicleType('suv')">
                                ðŸš™ SUV
                            </button>
                            <button class="vehicle-type-btn" data-type="transporter" onclick="changeVehicleType('transporter')">
                                ðŸš Transporter
                            </button>
                            <button class="vehicle-type-btn" data-type="kombi" onclick="changeVehicleType('kombi')">
                                ðŸš• Kombi
                            </button>
                            <div class="ai-model-dropdown" style="position: relative; display: inline-block;">
                                <button class="vehicle-type-btn ai-btn" onclick="toggleAIDropdown()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-color: transparent; color: white;">
                                    ðŸ¤– KI-Modell
                                </button>
                                <div id="aiDropdown" class="ai-dropdown-content" style="display: none; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); background: var(--color-surface-elevated); border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--space-3); margin-top: var(--space-2); min-width: 280px; box-shadow: var(--shadow-lg); z-index: 100;">
                                    <p style="font-size: var(--font-size-xs); color: var(--color-text-secondary); margin: 0 0 var(--space-3) 0; text-align: center;">
                                        Erstelle 3D-Modelle aus Fotos mit KI:
                                    </p>
                                    <a href="https://huggingface.co/spaces/alexnasa/PartCrafter" target="_blank" class="ai-link" style="display: block; padding: var(--space-2); border-radius: var(--radius-sm); text-decoration: none; color: var(--color-text-primary); background: rgba(var(--color-primary-rgb), 0.1); margin-bottom: var(--space-2); font-size: var(--font-size-sm);">
                                        <strong>PartCrafter</strong> (MIT) - 4-16 separate Teile aus 1 Foto
                                    </a>
                                    <a href="https://huggingface.co/spaces/tencent/Hunyuan3D-Part" target="_blank" class="ai-link" style="display: block; padding: var(--space-2); border-radius: var(--radius-sm); text-decoration: none; color: var(--color-text-primary); background: rgba(var(--color-primary-rgb), 0.1); margin-bottom: var(--space-2); font-size: var(--font-size-sm);">
                                        <strong>Hunyuan3D-Part</strong> (Tencent) - Teile-Segmentierung
                                    </a>
                                    <a href="https://www.meshy.ai/" target="_blank" class="ai-link" style="display: block; padding: var(--space-2); border-radius: var(--radius-sm); text-decoration: none; color: var(--color-text-primary); background: rgba(var(--color-primary-rgb), 0.1); font-size: var(--font-size-sm);">
                                        <strong>Meshy AI</strong> (Free-Tier) - Schnelle 3D-Generierung
                                    </a>
                                </div>
                            </div>
                        </div>

                        <div class="sketchfab-embed-wrapper">
                            <!-- Sketchfab Viewer API Container -->
                            <div id="sketchfabApiContainer" style="width: 100%; height: 450px; border-radius: var(--radius-card); overflow: hidden; background: var(--color-surface-elevated); position: relative;">
                                <div id="sketchfabLoading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                    <div class="spinner" style="width: 40px; height: 40px; border: 3px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px;"></div>
                                    <p style="color: var(--color-text-secondary); font-size: var(--font-size-sm);">3D-Modell wird geladen...</p>
                                </div>
                            </div>
                            <p id="sketchfabCredit" class="sketchfab-credit" style="font-size: 11px; color: var(--color-text-secondary); text-align: center; margin-top: var(--space-2);">
                                3D-Modell: <a id="modelLink" href="https://sketchfab.com/3d-models/generic-sedan-car-58c33766470d46e7b2aed542650494e5" target="_blank" style="color: var(--color-primary);">Generic Sedan Car</a> von <span id="modelAuthor">MMC Works</span> (CC BY)
                            </p>
                        </div>

                        <!-- Klick-Hinweis -->
                        <div id="clickHint" style="text-align: center; margin: var(--space-4) 0; padding: var(--space-3); background: rgba(var(--color-primary-rgb), 0.1); border-radius: var(--radius-md); display: none;">
                            <p style="margin: 0; font-size: var(--font-size-sm); color: var(--color-primary);">
                                <i data-feather="mouse-pointer" style="width: 14px; height: 14px; vertical-align: middle;"></i>
                                <strong>Tipp:</strong> Klicken Sie direkt auf das 3D-Modell, um ein Teil auszuwÃ¤hlen!
                            </p>
                        </div>

                        <!-- Geklicktes Teil Anzeige -->
                        <div id="clickedPartInfo" style="display: none; text-align: center; margin-bottom: var(--space-4); padding: var(--space-3); background: var(--color-success-bg); border: 1px solid var(--color-success); border-radius: var(--radius-md);">
                            <p style="margin: 0; font-size: var(--font-size-sm); color: var(--color-success);">
                                <i data-feather="check-circle" style="width: 14px; height: 14px; vertical-align: middle;"></i>
                                AusgewÃ¤hlt: <strong id="clickedPartName">-</strong>
                            </p>
                        </div>

                        <!-- 3D Teil-Auswahl Buttons (Fallback) -->
                        <div class="part-buttons-3d" style="display: flex; flex-wrap: wrap; gap: var(--space-2); justify-content: center; margin-top: var(--space-4);">
                            <span style="width: 100%; text-align: center; font-size: var(--font-size-xs); color: var(--color-text-secondary); margin-bottom: var(--space-2);">Oder wÃ¤hlen Sie manuell:</span>
                            <button class="part-btn-3d" onclick="select3DPart('StoÃŸfÃ¤nger vorne')">StoÃŸfÃ¤nger V</button>
                            <button class="part-btn-3d" onclick="select3DPart('Motorhaube')">Motorhaube</button>
                            <button class="part-btn-3d" onclick="select3DPart('KotflÃ¼gel vorne links')">KotflÃ¼gel VL</button>
                            <button class="part-btn-3d" onclick="select3DPart('KotflÃ¼gel vorne rechts')">KotflÃ¼gel VR</button>
                            <button class="part-btn-3d" onclick="select3DPart('TÃ¼r vorne links')">TÃ¼r VL</button>
                            <button class="part-btn-3d" onclick="select3DPart('TÃ¼r vorne rechts')">TÃ¼r VR</button>
                            <button class="part-btn-3d" onclick="select3DPart('TÃ¼r hinten links')">TÃ¼r HL</button>
                            <button class="part-btn-3d" onclick="select3DPart('TÃ¼r hinten rechts')">TÃ¼r HR</button>
                            <button class="part-btn-3d" onclick="select3DPart('Dach')">Dach</button>
                            <button class="part-btn-3d" onclick="select3DPart('Heckklappe')">Heckklappe</button>
                            <button class="part-btn-3d" onclick="select3DPart('StoÃŸfÃ¤nger hinten')">StoÃŸfÃ¤nger H</button>
                            <button class="part-btn-3d" onclick="select3DPart('Seitenteil links')">Seitenteil L</button>
                            <button class="part-btn-3d" onclick="select3DPart('Seitenteil rechts')">Seitenteil R</button>
                        </div>
                    </div>

                    <!-- 2D SVG Diagramm (default sichtbar) -->
                    <div id="vehicle2DView" class="vehicle-diagram">
                        <svg class="vehicle-svg" viewBox="0 0 400 250" width="400" height="250">
                            <!-- Fahrzeug von oben (Draufsicht) -->

                            <!-- Hintergrund -->
                            <rect x="0" y="0" width="400" height="250" fill="transparent"/>

                            <!-- StoÃŸfÃ¤nger vorne -->
                            <path class="vehicle-part" id="part-stossfaenger-vorne"
                                  d="M 100,30 L 300,30 Q 310,30 310,40 L 310,50 L 90,50 L 90,40 Q 90,30 100,30"
                                  data-part="StoÃŸfÃ¤nger vorne" data-keywords="stossfaenger,vorne,front"/>
                            <text class="vehicle-part-label" x="200" y="43">StoÃŸfÃ¤nger V</text>

                            <!-- Motorhaube -->
                            <path class="vehicle-part" id="part-motorhaube"
                                  d="M 95,50 L 305,50 L 305,90 L 95,90 Z"
                                  data-part="Motorhaube" data-keywords="motorhaube,haube,hood"/>
                            <text class="vehicle-part-label" x="200" y="73">Motorhaube</text>

                            <!-- KotflÃ¼gel vorne links -->
                            <path class="vehicle-part" id="part-kotfluegel-vl"
                                  d="M 60,50 L 95,50 L 95,100 L 60,100 Q 50,100 50,90 L 50,60 Q 50,50 60,50"
                                  data-part="KotflÃ¼gel vorne links" data-keywords="kotfluegel,vorne,links"/>
                            <text class="vehicle-part-label" x="72" y="78" style="font-size: 8px;">KF VL</text>

                            <!-- KotflÃ¼gel vorne rechts -->
                            <path class="vehicle-part" id="part-kotfluegel-vr"
                                  d="M 305,50 L 340,50 Q 350,50 350,60 L 350,90 Q 350,100 340,100 L 305,100 Z"
                                  data-part="KotflÃ¼gel vorne rechts" data-keywords="kotfluegel,vorne,rechts"/>
                            <text class="vehicle-part-label" x="327" y="78" style="font-size: 8px;">KF VR</text>

                            <!-- TÃ¼r vorne links -->
                            <path class="vehicle-part" id="part-tuer-vl"
                                  d="M 50,100 L 95,100 L 95,140 L 50,140 Z"
                                  data-part="TÃ¼r vorne links" data-keywords="tuer,vorne,links,fahrer"/>
                            <text class="vehicle-part-label" x="72" y="123" style="font-size: 8px;">TÃ¼r VL</text>

                            <!-- TÃ¼r vorne rechts -->
                            <path class="vehicle-part" id="part-tuer-vr"
                                  d="M 305,100 L 350,100 L 350,140 L 305,140 Z"
                                  data-part="TÃ¼r vorne rechts" data-keywords="tuer,vorne,rechts,beifahrer"/>
                            <text class="vehicle-part-label" x="327" y="123" style="font-size: 8px;">TÃ¼r VR</text>

                            <!-- Dach -->
                            <path class="vehicle-part" id="part-dach"
                                  d="M 95,90 L 305,90 L 305,160 L 95,160 Z"
                                  data-part="Dach" data-keywords="dach,roof"/>
                            <text class="vehicle-part-label" x="200" y="128">Dach</text>

                            <!-- Spiegel links -->
                            <ellipse class="vehicle-part" id="part-spiegel-l"
                                     cx="45" cy="95" rx="8" ry="12"
                                     data-part="Seitenspiegel links" data-keywords="spiegel,links"/>

                            <!-- Spiegel rechts -->
                            <ellipse class="vehicle-part" id="part-spiegel-r"
                                     cx="355" cy="95" rx="8" ry="12"
                                     data-part="Seitenspiegel rechts" data-keywords="spiegel,rechts"/>

                            <!-- TÃ¼r hinten links -->
                            <path class="vehicle-part" id="part-tuer-hl"
                                  d="M 50,140 L 95,140 L 95,175 L 50,175 Z"
                                  data-part="TÃ¼r hinten links" data-keywords="tuer,hinten,links"/>
                            <text class="vehicle-part-label" x="72" y="160" style="font-size: 8px;">TÃ¼r HL</text>

                            <!-- TÃ¼r hinten rechts -->
                            <path class="vehicle-part" id="part-tuer-hr"
                                  d="M 305,140 L 350,140 L 350,175 L 305,175 Z"
                                  data-part="TÃ¼r hinten rechts" data-keywords="tuer,hinten,rechts"/>
                            <text class="vehicle-part-label" x="327" y="160" style="font-size: 8px;">TÃ¼r HR</text>

                            <!-- KotflÃ¼gel hinten links / Seitenteil -->
                            <path class="vehicle-part" id="part-seitenteil-l"
                                  d="M 50,175 L 95,175 L 95,200 L 60,200 Q 50,200 50,190 Z"
                                  data-part="Seitenteil links" data-keywords="seitenteil,kotfluegel,hinten,links"/>
                            <text class="vehicle-part-label" x="72" y="190" style="font-size: 8px;">ST L</text>

                            <!-- KotflÃ¼gel hinten rechts / Seitenteil -->
                            <path class="vehicle-part" id="part-seitenteil-r"
                                  d="M 305,175 L 350,175 L 350,190 Q 350,200 340,200 L 305,200 Z"
                                  data-part="Seitenteil rechts" data-keywords="seitenteil,kotfluegel,hinten,rechts"/>
                            <text class="vehicle-part-label" x="327" y="190" style="font-size: 8px;">ST R</text>

                            <!-- Heckklappe -->
                            <path class="vehicle-part" id="part-heckklappe"
                                  d="M 95,160 L 305,160 L 305,200 L 95,200 Z"
                                  data-part="Heckklappe" data-keywords="heckklappe,kofferraum,heck"/>
                            <text class="vehicle-part-label" x="200" y="183">Heckklappe</text>

                            <!-- StoÃŸfÃ¤nger hinten -->
                            <path class="vehicle-part" id="part-stossfaenger-hinten"
                                  d="M 90,200 L 310,200 L 310,210 Q 310,220 300,220 L 100,220 Q 90,220 90,210 Z"
                                  data-part="StoÃŸfÃ¤nger hinten" data-keywords="stossfaenger,hinten,heck"/>
                            <text class="vehicle-part-label" x="200" y="213">StoÃŸfÃ¤nger H</text>

                            <!-- Schweller links -->
                            <rect class="vehicle-part" id="part-schweller-l"
                                  x="35" y="105" width="15" height="65"
                                  data-part="Schweller links" data-keywords="schweller,links"/>

                            <!-- Schweller rechts -->
                            <rect class="vehicle-part" id="part-schweller-r"
                                  x="350" y="105" width="15" height="65"
                                  data-part="Schweller rechts" data-keywords="schweller,rechts"/>
                        </svg>
                    </div><!-- Ende vehicle2DView -->

                    <!-- AusgewÃ¤hltes Teil Anzeige -->
                    <div class="kalk-selected-part" id="selectedPartDisplay" style="display: none;">
                        <div class="kalk-selected-part__icon">âœ“</div>
                        <div class="kalk-selected-part__info">
                            <strong>AusgewÃ¤hltes Teil:</strong>
                            <span id="selectedPartName">-</span>
                        </div>
                        <button class="btn btn-sm btn-secondary" onclick="clearSelectedPart()">
                            <i data-feather="x"></i>
                        </button>
                    </div>

                    <!-- AusgewÃ¤hlte Teile Liste (fÃ¼r mehrere Teile) -->
                    <div class="kalk-parts-list" id="selectedPartsList" style="display: none;">
                        <h4>AusgewÃ¤hlte Teile:</h4>
                        <div id="partsListContent"></div>
                    </div>

                    <div class="kalk-step-actions">
                        <button class="btn btn-secondary btn-lg" onclick="goToStep(1)">
                            <i data-feather="arrow-left"></i>
                            ZurÃ¼ck
                        </button>
                        <button class="btn btn-primary btn-lg" onclick="goToStep(3)" id="btnStep2Next" disabled>
                            Weiter zu Reparaturart
                            <i data-feather="arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- STEP 3: REPARATURART WÃ„HLEN -->
            <!-- ============================================ -->
            <div class="kalk-step-content" id="stepContent3">
                <div class="content-card">
                    <div class="content-card__header">
                        <div class="content-card__title">
                            <i data-feather="settings"></i>
                            <h2>Schritt 3: Reparaturart wÃ¤hlen</h2>
                        </div>
                    </div>

                    <!-- GewÃ¤hltes Teil anzeigen -->
                    <div class="kalk-selected-vehicle" id="step3PartInfo">
                        <span class="kalk-selected-vehicle__label">Teil:</span>
                        <span class="kalk-selected-vehicle__value" id="step3PartDisplay">-</span>
                    </div>

                    <!-- Reparaturarten als Checkboxen -->
                    <div class="kalk-repair-options">
                        <h4>Welche Arbeiten sollen durchgefÃ¼hrt werden?</h4>
                        <p class="kalk-repair-hint">WÃ¤hlen Sie alle zutreffenden Arbeiten aus</p>

                        <div class="repair-options-grid">
                            <label class="repair-option">
                                <input type="checkbox" name="repair" value="lackieren" onchange="updateRepairSelection()">
                                <div class="repair-option__content">
                                    <span class="repair-option__icon">ðŸŽ¨</span>
                                    <span class="repair-option__label">Lackieren</span>
                                </div>
                            </label>
                            <label class="repair-option">
                                <input type="checkbox" name="repair" value="demontieren" onchange="updateRepairSelection()">
                                <div class="repair-option__content">
                                    <span class="repair-option__icon">ðŸ”§</span>
                                    <span class="repair-option__label">Demontieren</span>
                                </div>
                            </label>
                            <label class="repair-option">
                                <input type="checkbox" name="repair" value="montieren" onchange="updateRepairSelection()">
                                <div class="repair-option__content">
                                    <span class="repair-option__icon">ðŸ”©</span>
                                    <span class="repair-option__label">Montieren</span>
                                </div>
                            </label>
                            <label class="repair-option">
                                <input type="checkbox" name="repair" value="grundieren" onchange="updateRepairSelection()">
                                <div class="repair-option__content">
                                    <span class="repair-option__icon">ðŸ–Œï¸</span>
                                    <span class="repair-option__label">Grundieren</span>
                                </div>
                            </label>
                            <label class="repair-option">
                                <input type="checkbox" name="repair" value="spachteln" onchange="updateRepairSelection()">
                                <div class="repair-option__content">
                                    <span class="repair-option__icon">ðŸª£</span>
                                    <span class="repair-option__label">Spachteln</span>
                                </div>
                            </label>
                            <label class="repair-option">
                                <input type="checkbox" name="repair" value="schleifen" onchange="updateRepairSelection()">
                                <div class="repair-option__content">
                                    <span class="repair-option__icon">ðŸ“</span>
                                    <span class="repair-option__label">Schleifen</span>
                                </div>
                            </label>
                            <label class="repair-option">
                                <input type="checkbox" name="repair" value="austauschen" onchange="updateRepairSelection()">
                                <div class="repair-option__content">
                                    <span class="repair-option__icon">ðŸ”„</span>
                                    <span class="repair-option__label">Austauschen (Neuteil)</span>
                                </div>
                            </label>
                            <label class="repair-option">
                                <input type="checkbox" name="repair" value="spot-repair" onchange="updateRepairSelection()">
                                <div class="repair-option__content">
                                    <span class="repair-option__icon">âœ¨</span>
                                    <span class="repair-option__label">Spot-Repair</span>
                                </div>
                            </label>
                            <label class="repair-option">
                                <input type="checkbox" name="repair" value="polieren" onchange="updateRepairSelection()">
                                <div class="repair-option__content">
                                    <span class="repair-option__icon">ðŸ’Ž</span>
                                    <span class="repair-option__label">Polieren</span>
                                </div>
                            </label>
                            <label class="repair-option">
                                <input type="checkbox" name="repair" value="ausbeulen" onchange="updateRepairSelection()">
                                <div class="repair-option__content">
                                    <span class="repair-option__icon">ðŸ”¨</span>
                                    <span class="repair-option__label">Ausbeulen (PDR)</span>
                                </div>
                            </label>
                            <label class="repair-option">
                                <input type="checkbox" name="repair" value="schweissen" onchange="updateRepairSelection()">
                                <div class="repair-option__content">
                                    <span class="repair-option__icon">âš¡</span>
                                    <span class="repair-option__label">SchweiÃŸen</span>
                                </div>
                            </label>
                            <label class="repair-option">
                                <input type="checkbox" name="repair" value="kleben" onchange="updateRepairSelection()">
                                <div class="repair-option__content">
                                    <span class="repair-option__icon">ðŸ§´</span>
                                    <span class="repair-option__label">Kleben</span>
                                </div>
                            </label>
                        </div>

                        <!-- Weiteres Teil hinzufÃ¼gen Button -->
                        <div class="kalk-add-more" style="margin-top: var(--space-6); text-align: center;">
                            <button class="btn btn-secondary" onclick="addCurrentPartAndGoBack()">
                                <i data-feather="plus-circle"></i>
                                Dieses Teil hinzufÃ¼gen & weiteres Teil wÃ¤hlen
                            </button>
                        </div>
                    </div>

                    <div class="kalk-step-actions">
                        <button class="btn btn-secondary btn-lg" onclick="goToStep(2)">
                            <i data-feather="arrow-left"></i>
                            ZurÃ¼ck
                        </button>
                        <button class="btn btn-primary btn-lg" onclick="goToStep(4)" id="btnStep3Next" disabled>
                            Weiter zur Kalkulation
                            <i data-feather="arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- STEP 4: KALKULATION ÃœBERSICHT -->
            <!-- ============================================ -->
            <div class="kalk-step-content" id="stepContent4">
                <div class="content-card">
                    <div class="content-card__header">
                        <div class="content-card__title">
                            <i data-feather="file-text"></i>
                            <h2>Schritt 4: Kalkulation</h2>
                        </div>
                    </div>

                    <!-- Zusammenfassung -->
                    <div class="kalk-summary">
                        <div class="kalk-summary__vehicle">
                            <h4>Fahrzeug</h4>
                            <div id="step4VehicleSummary">-</div>
                        </div>
                        <div class="kalk-summary__parts">
                            <h4>AusgewÃ¤hlte Teile & Arbeiten</h4>
                            <div id="step4PartsSummary">-</div>
                        </div>
                    </div>

                    <!-- OE-Nummern Ersatzteile-Suche (jetzt hier in Step 4) -->
                    <div class="oe-search-container" id="oeSearchContainer" style="margin-top: var(--space-6);">
                        <div class="oe-search-header">
                            <div class="oe-search-title">
                                <span>ðŸ”</span>
                                <span>Ersatzteile hinzufÃ¼gen (OE-Nummern)</span>
                            </div>
                            <div class="oe-search-stats" id="oeSearchStats">
                                Wird geladen...
                            </div>
                        </div>

                        <div class="oe-vehicle-select">
                            <select id="oeMarkeSelect" onchange="updateOeModelle()">
                                <option value="">Alle Marken</option>
                            </select>
                            <select id="oeModellSelect" onchange="performOeSearch()">
                                <option value="">Alle Modelle</option>
                            </select>
                        </div>

                        <div class="oe-search-input-group">
                            <input type="text"
                                   id="oeSearchInput"
                                   class="oe-search-input"
                                   placeholder="OE-Nummer oder Teilename eingeben (z.B. 5G1941005A oder StoÃŸfÃ¤nger)"
                                   oninput="performOeSearch()"
                                   autocomplete="off">
                        </div>

                        <div class="oe-results" id="oeResults">
                            <div class="oe-no-results">
                                <i data-feather="search"></i>
                                <p>Geben Sie eine OE-Nummer oder einen Teilenamen ein</p>
                            </div>
                        </div>
                    </div>

                <div id="kalkulationContent">
                    <!-- Arbeitspositionen -->
                    <div class="content-card" style="margin-bottom: var(--space-6);">
                        <div class="content-card__header">
                            <div class="content-card__title">
                                <i data-feather="tool"></i>
                                <h2>Arbeitspositionen</h2>
                            </div>
                            <button class="btn btn-primary" onclick="openPositionModal()">
                                <i data-feather="plus"></i>
                                Position hinzufÃ¼gen
                            </button>
                        </div>

                        <div id="positionenListe">
                            <div class="empty-state">
                                <i data-feather="clipboard"></i>
                                <h3>Keine Positionen</h3>
                                <p>FÃ¼gen Sie Arbeitspositionen aus dem Katalog hinzu</p>
                            </div>
                        </div>
                    </div>

                    <!-- Material -->
                    <div class="content-card" style="margin-bottom: var(--space-6);">
                        <div class="content-card__header">
                            <div class="content-card__title">
                                <i data-feather="package"></i>
                                <h2>Material</h2>
                            </div>
                            <button class="btn btn-primary" onclick="openMaterialModal()">
                                <i data-feather="plus"></i>
                                Material hinzufÃ¼gen
                            </button>
                        </div>

                        <div id="materialListe">
                            <div class="empty-state">
                                <i data-feather="box"></i>
                                <h3>Kein Material</h3>
                                <p>FÃ¼gen Sie Materialien aus dem Katalog hinzu</p>
                            </div>
                        </div>
                    </div>

                    <!-- Zusammenfassung -->
                    <div class="kalkulation-summary">
                        <div class="summary-row">
                            <span class="label">Summe Arbeit (netto)</span>
                            <span class="value" id="summeArbeit">0,00 â‚¬</span>
                        </div>
                        <div class="summary-row">
                            <span class="label">Summe Material (netto)</span>
                            <span class="value" id="summeMaterial">0,00 â‚¬</span>
                        </div>
                        <div class="summary-row">
                            <span class="label">Zwischensumme (netto)</span>
                            <span class="value" id="summeNetto">0,00 â‚¬</span>
                        </div>
                        <div class="summary-row">
                            <span class="label">MwSt. <span id="mwstSatzDisplay">19</span>%</span>
                            <span class="value" id="summeMwst">0,00 â‚¬</span>
                        </div>
                        <div class="summary-row total">
                            <span class="label">Gesamtbetrag (brutto)</span>
                            <span class="value" id="summeBrutto">0,00 â‚¬</span>
                        </div>
                    </div>

                    <!-- Aktionen -->
                    <div style="display: flex; gap: var(--space-4); margin-top: var(--space-6); flex-wrap: wrap;">
                        <button class="btn btn-secondary" onclick="saveKalkulationEntwurf()">
                            <i data-feather="save"></i>
                            Als Entwurf speichern
                        </button>
                        <button class="btn btn-primary" onclick="exportKalkulationPDF()">
                            <i data-feather="file-text"></i>
                            PDF exportieren
                        </button>
                        <button class="btn btn-success" onclick="sendKalkulationEmail()">
                            <i data-feather="send"></i>
                            Per E-Mail senden
                        </button>
                    </div>
                </div>

                <!-- Freie Kalkulation starten -->
                <div id="freieKalkulationStart">
                    <button class="btn btn-secondary" onclick="startFreieKalkulation()">
                        <i data-feather="edit-3"></i>
                        Freie Kalkulation ohne Fahrzeug starten
                    </button>
                </div>
            </div>
        </section>

        <!-- ============================================ -->
        <!-- TAB 2: Arbeitswert-Katalog -->
        <!-- ============================================ -->
        <section id="tab-katalog" class="tab-content">
            <div class="content-card">
                <div class="content-card__header">
                    <div class="content-card__title">
                        <i data-feather="book"></i>
                        <h2>Arbeitswert-Katalog</h2>
                    </div>
                    <button class="btn btn-primary" onclick="openKatalogModal()">
                        <i data-feather="plus"></i>
                        Neue Position
                    </button>
                </div>

                <!-- Search & Filter -->
                <div class="search-filter-bar">
                    <div class="search-input">
                        <i data-feather="search"></i>
                        <input type="text" id="katalogSearch" placeholder="Suchen..." oninput="filterKatalog()">
                    </div>
                    <select id="katalogFilter" onchange="filterKatalog()">
                        <option value="">Alle Kategorien</option>
                        <option value="Karosserie">Karosserie</option>
                        <option value="Lackierung">Lackierung</option>
                        <option value="Mechanik">Mechanik</option>
                        <option value="Elektrik">Elektrik</option>
                        <option value="Sonstiges">Sonstiges</option>
                    </select>
                </div>

                <div id="katalogListe">
                    <div class="empty-state">
                        <i data-feather="book-open"></i>
                        <h3>Katalog leer</h3>
                        <p>Erstellen Sie Ihren ersten Arbeitswert-Eintrag</p>
                        <button class="btn btn-primary" onclick="seedKatalog()">
                            <i data-feather="download"></i>
                            Standard-Katalog laden
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ============================================ -->
        <!-- TAB 3: StundensÃ¤tze -->
        <!-- ============================================ -->
        <section id="tab-saetze" class="tab-content">
            <div class="content-card">
                <div class="content-card__header">
                    <div class="content-card__title">
                        <i data-feather="dollar-sign"></i>
                        <h2>StundensÃ¤tze & Einstellungen</h2>
                    </div>
                </div>

                <form id="saetzeForm" onsubmit="saveSaetze(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="stundensatzLack">Lackierarbeiten</label>
                            <div class="input-suffix">
                                <input type="number" id="stundensatzLack" step="0.01" min="0" value="95.00" required>
                                <span>â‚¬/Std</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="stundensatzKarosserie">Karosseriearbeiten</label>
                            <div class="input-suffix">
                                <input type="number" id="stundensatzKarosserie" step="0.01" min="0" value="85.00" required>
                                <span>â‚¬/Std</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="stundensatzMechanik">Mechanik/Elektrik</label>
                            <div class="input-suffix">
                                <input type="number" id="stundensatzMechanik" step="0.01" min="0" value="75.00" required>
                                <span>â‚¬/Std</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="stundensatzSonstige">Sonstige Arbeiten</label>
                            <div class="input-suffix">
                                <input type="number" id="stundensatzSonstige" step="0.01" min="0" value="65.00" required>
                                <span>â‚¬/Std</span>
                            </div>
                        </div>
                    </div>

                    <hr style="margin: var(--space-8) 0; border: none; border-top: 1px solid var(--color-border);">

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="awInMinuten">1 Arbeitswert (AW) entspricht</label>
                            <div class="input-suffix">
                                <input type="number" id="awInMinuten" step="1" min="1" value="5" required>
                                <span>Minuten</span>
                            </div>
                            <small>Branchenstandard: 5 Minuten pro AW</small>
                        </div>

                        <div class="form-group">
                            <label for="mwstSatz">Mehrwertsteuersatz</label>
                            <div class="input-suffix">
                                <input type="number" id="mwstSatz" step="0.1" min="0" value="19" required>
                                <span>%</span>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: var(--space-6);">
                        <button type="submit" class="btn btn-success" id="saveSaetzeBtn">
                            <i data-feather="save"></i>
                            Einstellungen speichern
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <!-- ============================================ -->
        <!-- TAB 4: Material-Katalog -->
        <!-- ============================================ -->
        <section id="tab-material" class="tab-content">
            <div class="content-card">
                <div class="content-card__header">
                    <div class="content-card__title">
                        <i data-feather="package"></i>
                        <h2>Material-Katalog</h2>
                    </div>
                    <button class="btn btn-primary" onclick="openMaterialKatalogModal()">
                        <i data-feather="plus"></i>
                        Neues Material
                    </button>
                </div>

                <!-- Search & Filter -->
                <div class="search-filter-bar">
                    <div class="search-input">
                        <i data-feather="search"></i>
                        <input type="text" id="materialSearch" placeholder="Suchen..." oninput="filterMaterial()">
                    </div>
                    <select id="materialFilter" onchange="filterMaterial()">
                        <option value="">Alle Kategorien</option>
                        <option value="Lackmaterial">Lackmaterial</option>
                        <option value="Verbrauchsmaterial">Verbrauchsmaterial</option>
                        <option value="Ersatzteile">Ersatzteile</option>
                        <option value="Sonstiges">Sonstiges</option>
                    </select>
                </div>

                <div id="materialKatalogListe">
                    <div class="empty-state">
                        <i data-feather="package"></i>
                        <h3>Material-Katalog leer</h3>
                        <p>Erstellen Sie Ihren ersten Material-Eintrag</p>
                        <button class="btn btn-primary" onclick="seedMaterial()">
                            <i data-feather="download"></i>
                            Standard-Material laden
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ============================================ -->
        <!-- TAB 5: Historie -->
        <!-- ============================================ -->
        <section id="tab-historie" class="tab-content">
            <div class="content-card">
                <div class="content-card__header">
                    <div class="content-card__title">
                        <i data-feather="clock"></i>
                        <h2>Kalkulations-Historie</h2>
                    </div>
                </div>

                <!-- Search & Filter -->
                <div class="search-filter-bar">
                    <div class="search-input">
                        <i data-feather="search"></i>
                        <input type="text" id="historieSearch" placeholder="Kennzeichen oder Kunde suchen...">
                    </div>
                    <select id="historieFilter">
                        <option value="">Alle Status</option>
                        <option value="entwurf">Entwurf</option>
                        <option value="gesendet">Gesendet</option>
                        <option value="akzeptiert">Akzeptiert</option>
                        <option value="abgelehnt">Abgelehnt</option>
                    </select>
                </div>

                <div id="historieListe">
                    <div class="empty-state">
                        <i data-feather="file-text"></i>
                        <h3>Keine Kalkulationen</h3>
                        <p>Ihre erstellten Kalkulationen erscheinen hier</p>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- ============================================ -->
    <!-- MODALS -->
    <!-- ============================================ -->

    <!-- Modal: Position aus Katalog zur Kalkulation hinzufÃ¼gen -->
    <div class="modal-overlay" id="positionAuswahlModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3>Position aus Katalog hinzufÃ¼gen</h3>
                <button class="modal-close" onclick="closeModal('positionAuswahlModal')">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                <div class="search-input" style="margin-bottom: var(--space-4);">
                    <i data-feather="search"></i>
                    <input type="text" id="positionAuswahlSearch" placeholder="Position suchen..." oninput="filterPositionAuswahl()">
                </div>
                <div id="positionAuswahlListe">
                    <!-- Wird dynamisch gefÃ¼llt -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('positionAuswahlModal')">Abbrechen</button>
            </div>
        </div>
    </div>

    <!-- Modal: Material aus Katalog zur Kalkulation hinzufÃ¼gen -->
    <div class="modal-overlay" id="materialAuswahlModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3>Material aus Katalog hinzufÃ¼gen</h3>
                <button class="modal-close" onclick="closeModal('materialAuswahlModal')">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                <div class="search-input" style="margin-bottom: var(--space-4);">
                    <i data-feather="search"></i>
                    <input type="text" id="materialAuswahlSearch" placeholder="Material suchen..." oninput="filterMaterialAuswahl()">
                </div>
                <div id="materialAuswahlListe">
                    <!-- Wird dynamisch gefÃ¼llt -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('materialAuswahlModal')">Abbrechen</button>
            </div>
        </div>
    </div>

    <!-- Modal: Katalog-Position hinzufÃ¼gen/bearbeiten -->
    <div class="modal-overlay" id="katalogModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="katalogModalTitle">Neue Position</h3>
                <button class="modal-close" onclick="closeModal('katalogModal')">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="katalogForm" onsubmit="saveKatalogPosition(event)">
                    <input type="hidden" id="katalogPositionId">

                    <div class="form-group">
                        <label for="positionName">Bezeichnung *</label>
                        <input type="text" id="positionName" required placeholder="z.B. StoÃŸfÃ¤nger vorne dem./mont.">
                    </div>

                    <div class="form-group">
                        <label for="positionKategorie">Kategorie *</label>
                        <select id="positionKategorie" required>
                            <option value="">-- WÃ¤hlen --</option>
                            <option value="Karosserie">Karosserie</option>
                            <option value="Lackierung">Lackierung</option>
                            <option value="Mechanik">Mechanik</option>
                            <option value="Elektrik">Elektrik</option>
                            <option value="Sonstiges">Sonstiges</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="positionAW">Arbeitswerte (AW) *</label>
                        <input type="number" id="positionAW" step="0.5" min="0.5" required placeholder="z.B. 8.5">
                        <small>1 AW = 5 Minuten (Standard)</small>
                    </div>

                    <div class="form-group">
                        <label for="positionBeschreibung">Beschreibung (optional)</label>
                        <input type="text" id="positionBeschreibung" placeholder="ZusÃ¤tzliche Infos...">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('katalogModal')">Abbrechen</button>
                <button type="submit" form="katalogForm" class="btn btn-primary">
                    <i data-feather="save"></i>
                    Speichern
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Material hinzufÃ¼gen/bearbeiten -->
    <div class="modal-overlay" id="materialKatalogModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="materialModalTitle">Neues Material</h3>
                <button class="modal-close" onclick="closeModal('materialKatalogModal')">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="materialForm" onsubmit="saveMaterialPosition(event)">
                    <input type="hidden" id="materialPositionId">

                    <div class="form-group">
                        <label for="materialName">Bezeichnung *</label>
                        <input type="text" id="materialName" required placeholder="z.B. Basislack 1L">
                    </div>

                    <div class="form-group">
                        <label for="materialKategorie">Kategorie *</label>
                        <select id="materialKategorie" required>
                            <option value="">-- WÃ¤hlen --</option>
                            <option value="Lackmaterial">Lackmaterial</option>
                            <option value="Verbrauchsmaterial">Verbrauchsmaterial</option>
                            <option value="Ersatzteile">Ersatzteile</option>
                            <option value="Sonstiges">Sonstiges</option>
                        </select>
                    </div>

                    <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="form-group">
                            <label for="materialEK">Einkaufspreis (EK)</label>
                            <div class="input-suffix">
                                <input type="number" id="materialEK" step="0.01" min="0" placeholder="0.00">
                                <span>â‚¬</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="materialVK">Verkaufspreis (VK) *</label>
                            <div class="input-suffix">
                                <input type="number" id="materialVK" step="0.01" min="0" required placeholder="0.00">
                                <span>â‚¬</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="materialEinheit">Einheit</label>
                        <select id="materialEinheit">
                            <option value="StÃ¼ck">StÃ¼ck</option>
                            <option value="Liter">Liter</option>
                            <option value="kg">kg</option>
                            <option value="Set">Set</option>
                            <option value="Meter">Meter</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('materialKatalogModal')">Abbrechen</button>
                <button type="submit" form="materialForm" class="btn btn-primary">
                    <i data-feather="save"></i>
                    Speichern
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // INITIALIZATION
        // ============================================

        let kalkulationSaetze = {
            stundensatzLack: 95.00,
            stundensatzKarosserie: 85.00,
            stundensatzMechanik: 75.00,
            stundensatzSonstige: 65.00,
            awInMinuten: 5,
            mwstSatz: 19
        };

        let katalogData = [];
        let materialData = [];
        let aktuelleKalkulation = {
            positionen: [],
            materialien: [],
            fahrzeugId: null,
            kundenName: '',
            kennzeichen: ''
        };

        // ============================================
        // ðŸ†• NEUER KALKULATIONS-WIZARD STATE
        // ============================================
        let currentStep = 1;
        let kalkWizardData = {
            fahrzeug: {
                marke: '',
                modell: '',
                baujahr: '',
                kennzeichen: '',
                farbcode: '',
                kunde: ''
            },
            teile: [], // Array von { teil: 'StoÃŸfÃ¤nger vorne', reparaturen: ['lackieren', 'spachteln'] }
            currentPart: null
        };

        // ============================================
        // ðŸš— FAHRZEUG-DIAGRAMM & SCHADENS-WIZARD STATE
        // ============================================
        let selectedPart = null;
        let selectedDamageType = null;
        let selectedDamageSize = null;
        let suggestedItems = [];

        // Mapping: Bauteil â†’ passende Arbeitspositionen (Keywords)
        const partWorkMapping = {
            'StoÃŸfÃ¤nger vorne': {
                kratzer: ['StoÃŸfÃ¤nger vorne lackieren', 'Spot-Repair'],
                delle: ['StoÃŸfÃ¤nger vorne lackieren', 'KunststoffschweiÃŸen', 'Spachteln'],
                riss: ['StoÃŸfÃ¤nger vorne lackieren', 'KunststoffschweiÃŸen', 'Klebereparatur Kunststoff'],
                ersatz: ['StoÃŸfÃ¤nger vorne dem./mont.', 'StoÃŸfÃ¤nger vorne lackieren']
            },
            'StoÃŸfÃ¤nger hinten': {
                kratzer: ['StoÃŸfÃ¤nger hinten lackieren', 'Spot-Repair'],
                delle: ['StoÃŸfÃ¤nger hinten lackieren', 'KunststoffschweiÃŸen', 'Spachteln'],
                riss: ['StoÃŸfÃ¤nger hinten lackieren', 'KunststoffschweiÃŸen', 'Klebereparatur Kunststoff'],
                ersatz: ['StoÃŸfÃ¤nger hinten dem./mont.', 'StoÃŸfÃ¤nger hinten lackieren']
            },
            'Motorhaube': {
                kratzer: ['Motorhaube lackieren', 'Spot-Repair'],
                delle: ['Motorhaube lackieren', 'Delle ausbeulen', 'Spachteln'],
                riss: ['Motorhaube lackieren', 'SchweiÃŸnaht', 'Spachteln'],
                ersatz: ['Motorhaube dem./mont.', 'Motorhaube lackieren']
            },
            'KotflÃ¼gel vorne links': {
                kratzer: ['KotflÃ¼gel vorne lackieren', 'Spot-Repair'],
                delle: ['KotflÃ¼gel vorne lackieren', 'Delle ausbeulen', 'Spachteln'],
                riss: ['KotflÃ¼gel vorne lackieren', 'SchweiÃŸnaht', 'Spachteln'],
                ersatz: ['KotflÃ¼gel vorne dem./mont.', 'KotflÃ¼gel vorne lackieren']
            },
            'KotflÃ¼gel vorne rechts': {
                kratzer: ['KotflÃ¼gel vorne lackieren', 'Spot-Repair'],
                delle: ['KotflÃ¼gel vorne lackieren', 'Delle ausbeulen', 'Spachteln'],
                riss: ['KotflÃ¼gel vorne lackieren', 'SchweiÃŸnaht', 'Spachteln'],
                ersatz: ['KotflÃ¼gel vorne dem./mont.', 'KotflÃ¼gel vorne lackieren']
            },
            'TÃ¼r vorne links': {
                kratzer: ['TÃ¼r lackieren', 'Spot-Repair'],
                delle: ['TÃ¼r lackieren', 'Delle ausbeulen', 'Spachteln'],
                riss: ['TÃ¼r lackieren', 'SchweiÃŸnaht', 'Spachteln'],
                ersatz: ['TÃ¼r vorne dem./mont.', 'TÃ¼r lackieren', 'TÃ¼rverkleidung dem./mont.']
            },
            'TÃ¼r vorne rechts': {
                kratzer: ['TÃ¼r lackieren', 'Spot-Repair'],
                delle: ['TÃ¼r lackieren', 'Delle ausbeulen', 'Spachteln'],
                riss: ['TÃ¼r lackieren', 'SchweiÃŸnaht', 'Spachteln'],
                ersatz: ['TÃ¼r vorne dem./mont.', 'TÃ¼r lackieren', 'TÃ¼rverkleidung dem./mont.']
            },
            'TÃ¼r hinten links': {
                kratzer: ['TÃ¼r lackieren', 'Spot-Repair'],
                delle: ['TÃ¼r lackieren', 'Delle ausbeulen', 'Spachteln'],
                riss: ['TÃ¼r lackieren', 'SchweiÃŸnaht', 'Spachteln'],
                ersatz: ['TÃ¼r hinten dem./mont.', 'TÃ¼r lackieren', 'TÃ¼rverkleidung dem./mont.']
            },
            'TÃ¼r hinten rechts': {
                kratzer: ['TÃ¼r lackieren', 'Spot-Repair'],
                delle: ['TÃ¼r lackieren', 'Delle ausbeulen', 'Spachteln'],
                riss: ['TÃ¼r lackieren', 'SchweiÃŸnaht', 'Spachteln'],
                ersatz: ['TÃ¼r hinten dem./mont.', 'TÃ¼r lackieren', 'TÃ¼rverkleidung dem./mont.']
            },
            'Dach': {
                kratzer: ['Dach lackieren', 'Spot-Repair'],
                delle: ['Dach lackieren', 'Delle ausbeulen', 'Hagelschaden'],
                riss: ['Dach lackieren', 'SchweiÃŸnaht', 'Spachteln'],
                ersatz: ['Dach lackieren']
            },
            'Heckklappe': {
                kratzer: ['Heckklappe lackieren', 'Spot-Repair'],
                delle: ['Heckklappe lackieren', 'Delle ausbeulen', 'Spachteln'],
                riss: ['Heckklappe lackieren', 'SchweiÃŸnaht', 'Spachteln'],
                ersatz: ['Heckklappe dem./mont.', 'Heckklappe lackieren']
            },
            'Seitenteil links': {
                kratzer: ['Seitenteil lackieren', 'Spot-Repair'],
                delle: ['Seitenteil lackieren', 'Delle ausbeulen', 'Spachteln'],
                riss: ['Seitenteil lackieren', 'Seitenteil ersetzen', 'SchweiÃŸnaht'],
                ersatz: ['Seitenteil ersetzen', 'Seitenteil lackieren']
            },
            'Seitenteil rechts': {
                kratzer: ['Seitenteil lackieren', 'Spot-Repair'],
                delle: ['Seitenteil lackieren', 'Delle ausbeulen', 'Spachteln'],
                riss: ['Seitenteil lackieren', 'Seitenteil ersetzen', 'SchweiÃŸnaht'],
                ersatz: ['Seitenteil ersetzen', 'Seitenteil lackieren']
            },
            'Seitenspiegel links': {
                kratzer: ['Spiegel lackieren'],
                delle: ['Spiegel lackieren'],
                riss: ['Seitenspiegel dem./mont.'],
                ersatz: ['Seitenspiegel dem./mont.', 'Spiegel lackieren']
            },
            'Seitenspiegel rechts': {
                kratzer: ['Spiegel lackieren'],
                delle: ['Spiegel lackieren'],
                riss: ['Seitenspiegel dem./mont.'],
                ersatz: ['Seitenspiegel dem./mont.', 'Spiegel lackieren']
            },
            'Schweller links': {
                kratzer: ['Schweller lackieren', 'Spot-Repair'],
                delle: ['Schweller lackieren', 'Spachteln'],
                riss: ['Schweller lackieren', 'Schweller ersetzen'],
                ersatz: ['Schweller ersetzen', 'Schweller lackieren']
            },
            'Schweller rechts': {
                kratzer: ['Schweller lackieren', 'Spot-Repair'],
                delle: ['Schweller lackieren', 'Spachteln'],
                riss: ['Schweller lackieren', 'Schweller ersetzen'],
                ersatz: ['Schweller ersetzen', 'Schweller lackieren']
            }
        };

        // GrÃ¶ÃŸen-Suffix fÃ¼r Spot-Repair und Dellen
        const sizeMapping = {
            klein: { spotRepair: 'Spot-Repair XS', delle: 'PDR XS', spachteln: 'Spachteln klein' },
            mittel: { spotRepair: 'Spot-Repair M', delle: 'PDR M', spachteln: 'Spachteln mittel' },
            gross: { spotRepair: 'Spot-Repair XL', delle: 'PDR XL', spachteln: 'Spachteln groÃŸ' }
        };

        // Initialize Feather Icons
        feather.replace();

        // Wait for Firebase AND werkstattId
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                await window.initFirebase();
                console.log('âœ… Firebase initialisiert');

                // ðŸ†• FIX (2025-11-29): Wait for werkstattId (auth-manager sets it after auth state)
                let attempts = 0;
                while (!window.werkstattId && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }

                if (!window.werkstattId) {
                    console.warn('âš ï¸ werkstattId nicht gefunden nach 5s - Benutzer nicht eingeloggt?');
                    showToast('Bitte einloggen um fortzufahren', 'error');
                    setTimeout(() => safeNavigate('index.html'), 2000);
                    return;
                }

                console.log('âœ… werkstattId:', window.werkstattId);

                // Load saved settings
                await loadSaetze();
                await loadKatalog();
                await loadMaterial();
                await loadFahrzeuge();

                // Check URL params for tab
                const urlParams = new URLSearchParams(window.location.search);
                const tab = urlParams.get('tab');
                if (tab) {
                    switchTab(tab);
                }

                // Fahrzeug-Diagramm initialisieren
                initVehicleDiagram();

                // OE-Nummern Ersatzteile-Suche initialisieren
                initOeSearch();

                // ðŸ†• Neuen Kalkulations-Wizard initialisieren
                initKalkWizard();

                console.log('âœ… Kalkulation-Modul geladen');
            } catch (error) {
                console.error('âŒ Fehler beim Initialisieren:', error);
                showToast('Fehler beim Laden der Daten', 'error');
            }
        });

        // ============================================
        // ðŸ†• NEUER KALKULATIONS-WIZARD FUNKTIONEN
        // ============================================

        function initKalkWizard() {
            // Marken-Dropdown befÃ¼llen aus ERSATZTEILE_DB
            const markeSelect = document.getElementById('kalkMarke');
            if (markeSelect && typeof ERSATZTEILE_DB !== 'undefined') {
                markeSelect.innerHTML = '<option value="">-- Marke wÃ¤hlen --</option>';
                Object.keys(ERSATZTEILE_DB.marken).sort().forEach(key => {
                    const marke = ERSATZTEILE_DB.marken[key];
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = marke.name;
                    markeSelect.appendChild(option);
                });
            }

            // Baujahr-Dropdown befÃ¼llen (2010-2025)
            const baujahrSelect = document.getElementById('kalkBaujahr');
            if (baujahrSelect) {
                baujahrSelect.innerHTML = '<option value="">-- Baujahr --</option>';
                for (let year = 2025; year >= 2005; year--) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    baujahrSelect.appendChild(option);
                }
            }

            // Event-Listener fÃ¼r Fahrzeugdaten
            ['kalkMarke', 'kalkModell', 'kalkBaujahr', 'kalkKennzeichen', 'kalkFarbe', 'kalkKunde'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('change', updateVehicleInfo);
                if (el) el.addEventListener('input', updateVehicleInfo);
            });

            console.log('âœ… Kalkulations-Wizard initialisiert');
        }

        function updateKalkModelle() {
            const markeKey = document.getElementById('kalkMarke').value;
            const modellSelect = document.getElementById('kalkModell');
            modellSelect.innerHTML = '<option value="">-- Modell wÃ¤hlen --</option>';

            if (markeKey && ERSATZTEILE_DB.marken[markeKey]) {
                const marke = ERSATZTEILE_DB.marken[markeKey];
                Object.keys(marke.modelle).sort().forEach(key => {
                    const modell = marke.modelle[key];
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = `${modell.name} (${modell.baujahre})`;
                    modellSelect.appendChild(option);
                });
            }

            updateVehicleInfo();
        }

        function updateVehicleInfo() {
            const marke = document.getElementById('kalkMarke');
            const modell = document.getElementById('kalkModell');
            const baujahr = document.getElementById('kalkBaujahr');
            const kennzeichen = document.getElementById('kalkKennzeichen');
            const farbe = document.getElementById('kalkFarbe');
            const kunde = document.getElementById('kalkKunde');

            // Speichern
            kalkWizardData.fahrzeug = {
                marke: marke?.options[marke.selectedIndex]?.text || '',
                markeKey: marke?.value || '',
                modell: modell?.options[modell.selectedIndex]?.text || '',
                modellKey: modell?.value || '',
                baujahr: baujahr?.value || '',
                kennzeichen: kennzeichen?.value || '',
                farbcode: farbe?.value || '',
                kunde: kunde?.value || ''
            };

            // Info-Box anzeigen wenn Marke + Modell gewÃ¤hlt
            const infoBox = document.getElementById('kalkVehicleInfo');
            if (infoBox && kalkWizardData.fahrzeug.marke && kalkWizardData.fahrzeug.modell && kalkWizardData.fahrzeug.modell !== '-- Modell wÃ¤hlen --') {
                infoBox.style.display = 'flex';
                document.getElementById('kalkVehicleDisplay').textContent =
                    `${kalkWizardData.fahrzeug.marke} ${kalkWizardData.fahrzeug.modell}`;

                let extra = [];
                if (kalkWizardData.fahrzeug.baujahr) extra.push(`Bj. ${kalkWizardData.fahrzeug.baujahr}`);
                if (kalkWizardData.fahrzeug.kennzeichen) extra.push(kalkWizardData.fahrzeug.kennzeichen);
                if (kalkWizardData.fahrzeug.farbcode) extra.push(`Farbe: ${kalkWizardData.fahrzeug.farbcode}`);
                document.getElementById('kalkVehicleExtra').textContent = extra.join(' | ') || '-';
            } else if (infoBox) {
                infoBox.style.display = 'none';
            }
        }

        function goToStep(step) {
            // Validierung vor Schrittwechsel
            if (step > currentStep) {
                if (!validateStep(currentStep)) {
                    return;
                }
            }

            // Schritt aktualisieren
            currentStep = step;
            updateStepUI();

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function validateStep(step) {
            switch(step) {
                case 1:
                    // Marke und Modell mÃ¼ssen gewÃ¤hlt sein
                    const marke = document.getElementById('kalkMarke').value;
                    const modell = document.getElementById('kalkModell').value;
                    if (!marke || !modell) {
                        showToast('Bitte wÃ¤hlen Sie Marke und Modell', 'warning');
                        return false;
                    }
                    return true;

                case 2:
                    // Mindestens ein Teil muss ausgewÃ¤hlt sein
                    if (!kalkWizardData.currentPart && kalkWizardData.teile.length === 0) {
                        showToast('Bitte wÃ¤hlen Sie mindestens ein Teil aus', 'warning');
                        return false;
                    }
                    return true;

                case 3:
                    // Mindestens eine Reparatur muss gewÃ¤hlt sein
                    const checkedRepairs = document.querySelectorAll('input[name="repair"]:checked');
                    if (checkedRepairs.length === 0) {
                        showToast('Bitte wÃ¤hlen Sie mindestens eine Reparaturart', 'warning');
                        return false;
                    }
                    return true;

                default:
                    return true;
            }
        }

        function updateStepUI() {
            // Step-Indikatoren aktualisieren
            document.querySelectorAll('.kalk-step').forEach((step, index) => {
                const stepNum = index + 1;
                step.classList.remove('active', 'completed');
                if (stepNum === currentStep) {
                    step.classList.add('active');
                } else if (stepNum < currentStep) {
                    step.classList.add('completed');
                }
            });

            // Step-Content aktualisieren
            document.querySelectorAll('.kalk-step-content').forEach((content, index) => {
                content.classList.remove('active');
                if (index + 1 === currentStep) {
                    content.classList.add('active');
                }
            });

            // Step-spezifische Updates
            switch(currentStep) {
                case 2:
                    // Fahrzeug-Info in Step 2 anzeigen
                    const step2Display = document.getElementById('step2VehicleDisplay');
                    if (step2Display) {
                        step2Display.textContent = `${kalkWizardData.fahrzeug.marke} ${kalkWizardData.fahrzeug.modell}`;
                        if (kalkWizardData.fahrzeug.baujahr) {
                            step2Display.textContent += ` (${kalkWizardData.fahrzeug.baujahr})`;
                        }
                    }
                    break;

                case 3:
                    // Teil-Info in Step 3 anzeigen
                    const step3Display = document.getElementById('step3PartDisplay');
                    if (step3Display && kalkWizardData.currentPart) {
                        step3Display.textContent = kalkWizardData.currentPart;
                    }
                    // Checkboxen zurÃ¼cksetzen
                    document.querySelectorAll('input[name="repair"]').forEach(cb => cb.checked = false);
                    break;

                case 4:
                    // Zusammenfassung in Step 4 anzeigen
                    updateStep4Summary();
                    break;
            }

            feather.replace();
        }

        function selectVehiclePartNew(partName, element) {
            // Vorherige Auswahl entfernen
            document.querySelectorAll('.vehicle-part.selected').forEach(p => {
                p.classList.remove('selected');
            });

            // Neue Auswahl markieren
            if (element) element.classList.add('selected');
            kalkWizardData.currentPart = partName;

            // Anzeige aktualisieren
            const display = document.getElementById('selectedPartDisplay');
            const nameSpan = document.getElementById('selectedPartName');
            if (display && nameSpan) {
                display.style.display = 'flex';
                nameSpan.textContent = partName;
            }

            // Weiter-Button aktivieren
            const nextBtn = document.getElementById('btnStep2Next');
            if (nextBtn) nextBtn.disabled = false;

            feather.replace();
        }

        function clearSelectedPart() {
            kalkWizardData.currentPart = null;

            // Markierung entfernen
            document.querySelectorAll('.vehicle-part.selected').forEach(p => {
                p.classList.remove('selected');
            });

            // Anzeige verstecken
            const display = document.getElementById('selectedPartDisplay');
            if (display) display.style.display = 'none';

            // Weiter-Button deaktivieren (wenn keine Teile in Liste)
            if (kalkWizardData.teile.length === 0) {
                const nextBtn = document.getElementById('btnStep2Next');
                if (nextBtn) nextBtn.disabled = true;
            }
        }

        function updateRepairSelection() {
            const checkedRepairs = document.querySelectorAll('input[name="repair"]:checked');
            const nextBtn = document.getElementById('btnStep3Next');
            if (nextBtn) {
                nextBtn.disabled = checkedRepairs.length === 0;
            }
        }

        function addCurrentPartAndGoBack() {
            // Aktuelle Reparaturen sammeln
            const repairs = Array.from(document.querySelectorAll('input[name="repair"]:checked'))
                .map(cb => cb.value);

            if (repairs.length === 0) {
                showToast('Bitte wÃ¤hlen Sie mindestens eine Reparaturart', 'warning');
                return;
            }

            // Teil zur Liste hinzufÃ¼gen
            kalkWizardData.teile.push({
                teil: kalkWizardData.currentPart,
                reparaturen: repairs
            });

            // Checkboxen zurÃ¼cksetzen
            document.querySelectorAll('input[name="repair"]').forEach(cb => cb.checked = false);

            // CurrentPart zurÃ¼cksetzen
            kalkWizardData.currentPart = null;

            showToast(`${kalkWizardData.teile[kalkWizardData.teile.length - 1].teil} hinzugefÃ¼gt`, 'success');

            // ZurÃ¼ck zu Step 2
            goToStep(2);

            // Parts-Liste aktualisieren
            updatePartsListDisplay();
        }

        function updatePartsListDisplay() {
            const listContainer = document.getElementById('selectedPartsList');
            const listContent = document.getElementById('partsListContent');

            if (kalkWizardData.teile.length > 0 && listContainer && listContent) {
                listContainer.style.display = 'block';
                listContent.innerHTML = kalkWizardData.teile.map((item, index) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-2); background: var(--color-background); border-radius: var(--radius-button); margin-bottom: var(--space-2);">
                        <div>
                            <strong>${item.teil}</strong>
                            <span style="font-size: var(--font-size-xs); color: var(--color-text-secondary); display: block;">
                                ${item.reparaturen.join(', ')}
                            </span>
                        </div>
                        <button class="btn btn-sm btn-error" onclick="removePartFromList(${index})">
                            <i data-feather="trash-2"></i>
                        </button>
                    </div>
                `).join('');
                feather.replace();

                // Weiter-Button aktivieren
                const nextBtn = document.getElementById('btnStep2Next');
                if (nextBtn) nextBtn.disabled = false;
            } else if (listContainer) {
                listContainer.style.display = 'none';
            }
        }

        function removePartFromList(index) {
            kalkWizardData.teile.splice(index, 1);
            updatePartsListDisplay();

            if (kalkWizardData.teile.length === 0 && !kalkWizardData.currentPart) {
                const nextBtn = document.getElementById('btnStep2Next');
                if (nextBtn) nextBtn.disabled = true;
            }
        }

        function updateStep4Summary() {
            // Fahrzeug-Zusammenfassung
            const vehicleSummary = document.getElementById('step4VehicleSummary');
            if (vehicleSummary) {
                let html = `<strong>${kalkWizardData.fahrzeug.marke} ${kalkWizardData.fahrzeug.modell}</strong>`;
                if (kalkWizardData.fahrzeug.baujahr) html += `<br>Baujahr: ${kalkWizardData.fahrzeug.baujahr}`;
                if (kalkWizardData.fahrzeug.kennzeichen) html += `<br>Kennzeichen: ${kalkWizardData.fahrzeug.kennzeichen}`;
                if (kalkWizardData.fahrzeug.farbcode) html += `<br>Farbcode: ${kalkWizardData.fahrzeug.farbcode}`;
                if (kalkWizardData.fahrzeug.kunde) html += `<br>Kunde: ${kalkWizardData.fahrzeug.kunde}`;
                vehicleSummary.innerHTML = html;
            }

            // Teile-Zusammenfassung
            const partsSummary = document.getElementById('step4PartsSummary');
            if (partsSummary) {
                // Aktuelles Teil auch hinzufÃ¼gen wenn noch nicht in Liste
                let allParts = [...kalkWizardData.teile];
                if (kalkWizardData.currentPart) {
                    const repairs = Array.from(document.querySelectorAll('input[name="repair"]:checked'))
                        .map(cb => cb.value);
                    if (repairs.length > 0) {
                        allParts.push({
                            teil: kalkWizardData.currentPart,
                            reparaturen: repairs
                        });
                    }
                }

                if (allParts.length === 0) {
                    partsSummary.innerHTML = '<p style="color: var(--color-text-secondary);">Keine Teile ausgewÃ¤hlt</p>';
                } else {
                    partsSummary.innerHTML = allParts.map(item => `
                        <div style="padding: var(--space-3); background: var(--color-background); border-radius: var(--radius-button); margin-bottom: var(--space-2);">
                            <strong>${item.teil}</strong>
                            <div style="display: flex; flex-wrap: wrap; gap: var(--space-1); margin-top: var(--space-2);">
                                ${item.reparaturen.map(r => `<span style="background: var(--color-primary); color: white; padding: 2px 8px; border-radius: 12px; font-size: var(--font-size-xs);">${r}</span>`).join('')}
                            </div>
                        </div>
                    `).join('');

                    // Positionen zur aktuellenKalkulation hinzufÃ¼gen
                    generateKalkulationPositions(allParts);
                }
            }
        }

        function generateKalkulationPositions(allParts) {
            // Positionen aus den gewÃ¤hlten Teilen + Reparaturen generieren
            aktuelleKalkulation.positionen = [];
            aktuelleKalkulation.kundenName = kalkWizardData.fahrzeug.kunde;
            aktuelleKalkulation.kennzeichen = kalkWizardData.fahrzeug.kennzeichen;

            allParts.forEach(item => {
                item.reparaturen.forEach(repair => {
                    const positionName = `${item.teil} ${repair}`;

                    // Preis aus Katalog suchen oder Standardpreis
                    let preis = getPreisFromKatalog(item.teil, repair);

                    aktuelleKalkulation.positionen.push({
                        id: Date.now() + Math.random(),
                        name: positionName,
                        teil: item.teil,
                        arbeit: repair,
                        preis: preis,
                        menge: 1
                    });
                });
            });

            // Positionen rendern
            renderPositionenNew();
            berechneGesamtsumme();
        }

        function getPreisFromKatalog(teil, arbeit) {
            // Versuche Preis aus Katalog zu finden
            const searchTerm = `${teil} ${arbeit}`.toLowerCase();

            for (const item of katalogData) {
                if (item.name && item.name.toLowerCase().includes(teil.toLowerCase()) &&
                    item.name.toLowerCase().includes(arbeit.toLowerCase())) {
                    return item.preis || 0;
                }
            }

            // Standardpreise nach Arbeit
            const standardPreise = {
                'lackieren': 250,
                'demontieren': 45,
                'montieren': 45,
                'grundieren': 85,
                'spachteln': 120,
                'schleifen': 65,
                'austauschen': 150,
                'spot-repair': 180,
                'polieren': 95,
                'ausbeulen': 200,
                'schweissen': 150,
                'kleben': 75
            };

            return standardPreise[arbeit] || 100;
        }

        function renderPositionenNew() {
            const container = document.getElementById('positionenListe');
            if (!container) return;

            if (aktuelleKalkulation.positionen.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i data-feather="clipboard"></i>
                        <h3>Keine Positionen</h3>
                        <p>Die Positionen werden automatisch aus Ihrer Auswahl generiert</p>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Position</th>
                                <th>Preis</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            ${aktuelleKalkulation.positionen.map((pos, index) => `
                                <tr>
                                    <td>${pos.name}</td>
                                    <td>
                                        <input type="number"
                                               value="${pos.preis.toFixed(2)}"
                                               onchange="updatePositionPreis(${index}, this.value)"
                                               style="width: 100px; text-align: right;">
                                        â‚¬
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-error" onclick="removePositionNew(${index})">
                                            <i data-feather="trash-2"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }

            feather.replace();
        }

        function updatePositionPreis(index, value) {
            aktuelleKalkulation.positionen[index].preis = parseFloat(value) || 0;
            berechneGesamtsumme();
        }

        function removePositionNew(index) {
            aktuelleKalkulation.positionen.splice(index, 1);
            renderPositionenNew();
            berechneGesamtsumme();
        }

        // ============================================
        // ðŸ’° GESAMTSUMME BERECHNEN
        // ============================================

        function berechneGesamtsumme() {
            // Summe Arbeit (Positionen)
            const summeArbeit = aktuelleKalkulation.positionen.reduce((sum, p) => {
                const preis = parseFloat(p.preis) || 0;
                const menge = parseFloat(p.menge) || 1;
                return sum + (preis * menge);
            }, 0);

            // Summe Material
            const summeMaterial = aktuelleKalkulation.materialien.reduce((sum, m) => {
                const preis = parseFloat(m.preis) || parseFloat(m.verkaufspreis) || 0;
                const menge = parseFloat(m.menge) || 1;
                return sum + (preis * menge);
            }, 0);

            // Netto, MwSt, Brutto
            const summeNetto = summeArbeit + summeMaterial;
            const mwstSatz = kalkulationSaetze?.mwstSatz || 19;
            const mwst = summeNetto * (mwstSatz / 100);
            const summeBrutto = summeNetto + mwst;

            // UI aktualisieren
            const elSummeArbeit = document.getElementById('summeArbeit');
            const elSummeMaterial = document.getElementById('summeMaterial');
            const elSummeNetto = document.getElementById('summeNetto');
            const elMwstSatz = document.getElementById('mwstSatzDisplay');
            const elSummeMwst = document.getElementById('summeMwst');
            const elSummeBrutto = document.getElementById('summeBrutto');

            if (elSummeArbeit) elSummeArbeit.textContent = summeArbeit.toFixed(2).replace('.', ',') + ' â‚¬';
            if (elSummeMaterial) elSummeMaterial.textContent = summeMaterial.toFixed(2).replace('.', ',') + ' â‚¬';
            if (elSummeNetto) elSummeNetto.textContent = summeNetto.toFixed(2).replace('.', ',') + ' â‚¬';
            if (elMwstSatz) elMwstSatz.textContent = mwstSatz;
            if (elSummeMwst) elSummeMwst.textContent = mwst.toFixed(2).replace('.', ',') + ' â‚¬';
            if (elSummeBrutto) elSummeBrutto.textContent = summeBrutto.toFixed(2).replace('.', ',') + ' â‚¬';

            console.log('ðŸ’° Summen berechnet:', { summeArbeit, summeMaterial, summeNetto, mwst, summeBrutto });
        }

        // ============================================
        // ðŸš— FAHRZEUG-DIAGRAMM FUNKTIONEN
        // ============================================

        // ============================================
        // ðŸš— FAHRZEUGTYPEN KONFIGURATION
        // ============================================

        const VEHICLE_MODELS = {
            sedan: {
                id: '58c33766470d46e7b2aed542650494e5',
                name: 'Generic Sedan Car',
                author: 'MMC Works',
                url: 'https://sketchfab.com/3d-models/generic-sedan-car-58c33766470d46e7b2aed542650494e5'
            },
            suv: {
                id: '68341ef7bf3e4f83aa2777bfa2543719',
                name: 'Compact SUV Concept',
                author: 'MaG80',
                url: 'https://sketchfab.com/3d-models/compact-suv-concept-car-68341ef7bf3e4f83aa2777bfa2543719'
            },
            transporter: {
                id: '8c4e2162cea4498395cc5bc8064a6c20',
                name: 'Transporter Van',
                author: 'VIS-All-3D',
                url: 'https://sketchfab.com/3d-models/transporter-van-free-download-8c4e2162cea4498395cc5bc8064a6c20'
            },
            kombi: {
                id: 'aa0becb6e854422596cac6b21bf79787',
                name: '80s Station Wagon',
                author: 'Daniel Zhabotinsky',
                url: 'https://sketchfab.com/3d-models/80s-generic-usa-station-wagon-low-poly-model-aa0becb6e854422596cac6b21bf79787'
            }
        };

        let currentVehicleType = 'sedan';
        let sketchfabClient = null;
        let sketchfabApi = null;
        let nodeMap = {};

        // Mapping von 3D-Node-Namen zu deutschen Teile-Namen
        const NODE_TO_PART_MAPPING = {
            // Allgemeine Begriffe die in verschiedenen Modellen vorkommen kÃ¶nnen
            'hood': 'Motorhaube',
            'bonnet': 'Motorhaube',
            'motorhaube': 'Motorhaube',
            'bumper_front': 'StoÃŸfÃ¤nger vorne',
            'front_bumper': 'StoÃŸfÃ¤nger vorne',
            'bumper_rear': 'StoÃŸfÃ¤nger hinten',
            'rear_bumper': 'StoÃŸfÃ¤nger hinten',
            'door_fl': 'TÃ¼r vorne links',
            'door_fr': 'TÃ¼r vorne rechts',
            'door_rl': 'TÃ¼r hinten links',
            'door_rr': 'TÃ¼r hinten rechts',
            'door_front_left': 'TÃ¼r vorne links',
            'door_front_right': 'TÃ¼r vorne rechts',
            'door_rear_left': 'TÃ¼r hinten links',
            'door_rear_right': 'TÃ¼r hinten rechts',
            'fender_fl': 'KotflÃ¼gel vorne links',
            'fender_fr': 'KotflÃ¼gel vorne rechts',
            'fender': 'KotflÃ¼gel',
            'trunk': 'Heckklappe',
            'tailgate': 'Heckklappe',
            'roof': 'Dach',
            'body': 'Karosserie',
            'side_left': 'Seitenteil links',
            'side_right': 'Seitenteil rechts',
            'mirror': 'Spiegel',
            'window': 'Scheibe',
            'wheel': 'Rad',
            'tire': 'Reifen'
        };

        function initVehicleDiagram() {
            // Click handlers fÃ¼r alle Fahrzeugteile (2D)
            document.querySelectorAll('.vehicle-part').forEach(part => {
                part.addEventListener('click', (e) => {
                    const partName = e.target.dataset.part;
                    if (partName) {
                        // Neuer Wizard: selectVehiclePartNew statt selectVehiclePart
                        selectVehiclePartNew(partName, e.target);
                    }
                });
            });

            // Schnellsuche initialisieren
            initQuickSearch();

            // Feather Icons fÃ¼r Toggle-Buttons
            feather.replace();

            console.log('âœ… Fahrzeug-Diagramm initialisiert');
        }

        // ============================================
        // ðŸ”„ 2D/3D VIEW TOGGLE
        // ============================================

        function switchVehicleView(view) {
            const view2D = document.getElementById('vehicle2DView');
            const view3D = document.getElementById('vehicle3DView');
            const buttons = document.querySelectorAll('.view-toggle-btn');

            // Toggle Buttons aktualisieren
            buttons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });

            if (view === '3d') {
                view2D.style.display = 'none';
                view3D.style.display = 'block';

                // Sketchfab Viewer API initialisieren
                if (!sketchfabClient) {
                    initSketchfabViewerAPI();
                }
            } else {
                view2D.style.display = 'flex';
                view3D.style.display = 'none';
            }

            feather.replace();
        }

        // ============================================
        // ðŸŽ® SKETCHFAB VIEWER API
        // ============================================

        function initSketchfabViewerAPI() {
            const container = document.getElementById('sketchfabApiContainer');
            const modelData = VEHICLE_MODELS[currentVehicleType];

            // Iframe fÃ¼r Viewer API erstellen
            const iframe = document.createElement('iframe');
            iframe.id = 'api-frame';
            iframe.style.width = '100%';
            iframe.style.height = '100%';
            iframe.style.border = 'none';
            iframe.allow = 'autoplay; fullscreen; xr-spatial-tracking';

            // Loading-Spinner entfernen und Iframe einfÃ¼gen
            const loading = document.getElementById('sketchfabLoading');
            if (loading) loading.style.display = 'block';

            container.appendChild(iframe);

            // Sketchfab Client initialisieren
            sketchfabClient = new Sketchfab(iframe);

            sketchfabClient.init(modelData.id, {
                success: function(api) {
                    sketchfabApi = api;
                    api.start();
                    api.addEventListener('viewerready', function() {
                        console.log('âœ… Sketchfab Viewer API bereit');

                        // Loading verstecken
                        if (loading) loading.style.display = 'none';

                        // Klick-Hinweis anzeigen
                        document.getElementById('clickHint').style.display = 'block';

                        // Node Map laden fÃ¼r Teile-Namen
                        api.getNodeMap(function(err, nodes) {
                            if (!err) {
                                nodeMap = nodes;
                                console.log('ðŸ“‹ Node Map geladen:', Object.keys(nodes).length, 'Nodes');
                            }
                        });

                        // Click Event Handler
                        api.addEventListener('click', function(info) {
                            if (info.instanceID) {
                                handleModelClick(info);
                            }
                        }, { pick: 'slow' });

                        feather.replace();
                    });
                },
                error: function() {
                    console.error('âŒ Sketchfab Viewer API Fehler');
                    if (loading) {
                        loading.innerHTML = '<p style="color: var(--color-error);">âŒ 3D-Modell konnte nicht geladen werden</p>';
                    }
                },
                autostart: 1,
                preload: 1,
                ui_controls: 1,
                ui_infos: 0,
                ui_stop: 0,
                ui_watermark: 0
            });

            // Credit aktualisieren
            updateModelCredit(modelData);
        }

        function handleModelClick(info) {
            // Node-Name aus der Node Map holen
            let nodeName = 'Unbekannt';
            let partName = null;

            // Suche nach dem geklickten Node
            for (const [id, node] of Object.entries(nodeMap)) {
                if (node.instanceID === info.instanceID) {
                    nodeName = node.name || 'Node ' + id;
                    break;
                }
            }

            console.log('ðŸŽ¯ Geklickt auf:', nodeName, '(ID:', info.instanceID, ')');

            // Versuche Node-Namen auf deutsches Teil zu mappen
            const lowerName = nodeName.toLowerCase();
            for (const [key, value] of Object.entries(NODE_TO_PART_MAPPING)) {
                if (lowerName.includes(key)) {
                    partName = value;
                    break;
                }
            }

            // Wenn kein Mapping gefunden, versuche intelligente Erkennung
            if (!partName) {
                partName = guessPartFromNodeName(nodeName);
            }

            // UI aktualisieren
            const clickedInfo = document.getElementById('clickedPartInfo');
            const clickedName = document.getElementById('clickedPartName');

            if (partName) {
                clickedInfo.style.display = 'block';
                clickedName.textContent = partName;
                feather.replace();

                // Nach kurzer VerzÃ¶gerung Wizard Ã¶ffnen
                setTimeout(() => {
                    selectedPart = partName;
                    openDamageWizard(partName);
                }, 500);
            } else {
                // Zeige zumindest den Node-Namen
                clickedInfo.style.display = 'block';
                clickedInfo.style.background = 'var(--color-warning-bg)';
                clickedInfo.style.borderColor = 'var(--color-warning)';
                clickedName.textContent = nodeName + ' (nicht zugeordnet)';
                feather.replace();
            }
        }

        function guessPartFromNodeName(name) {
            const lower = name.toLowerCase();

            // Intelligente Erkennung basierend auf SchlÃ¼sselwÃ¶rtern
            if (lower.includes('tÃ¼r') || lower.includes('door')) {
                if (lower.includes('vorne') || lower.includes('front') || lower.includes('fl') || lower.includes('fr')) {
                    if (lower.includes('links') || lower.includes('left') || lower.includes('fl') || lower.includes('_l')) {
                        return 'TÃ¼r vorne links';
                    } else if (lower.includes('rechts') || lower.includes('right') || lower.includes('fr') || lower.includes('_r')) {
                        return 'TÃ¼r vorne rechts';
                    }
                    return 'TÃ¼r vorne';
                } else if (lower.includes('hinten') || lower.includes('rear') || lower.includes('rl') || lower.includes('rr')) {
                    if (lower.includes('links') || lower.includes('left') || lower.includes('rl') || lower.includes('_l')) {
                        return 'TÃ¼r hinten links';
                    } else if (lower.includes('rechts') || lower.includes('right') || lower.includes('rr') || lower.includes('_r')) {
                        return 'TÃ¼r hinten rechts';
                    }
                    return 'TÃ¼r hinten';
                }
                return 'TÃ¼r';
            }

            if (lower.includes('stoÃŸ') || lower.includes('bumper')) {
                if (lower.includes('vorne') || lower.includes('front')) return 'StoÃŸfÃ¤nger vorne';
                if (lower.includes('hinten') || lower.includes('rear')) return 'StoÃŸfÃ¤nger hinten';
                return 'StoÃŸfÃ¤nger';
            }

            if (lower.includes('motorhaube') || lower.includes('hood') || lower.includes('bonnet')) return 'Motorhaube';
            if (lower.includes('kotflÃ¼gel') || lower.includes('fender') || lower.includes('wing')) return 'KotflÃ¼gel';
            if (lower.includes('dach') || lower.includes('roof')) return 'Dach';
            if (lower.includes('heck') || lower.includes('trunk') || lower.includes('tailgate') || lower.includes('boot')) return 'Heckklappe';
            if (lower.includes('spiegel') || lower.includes('mirror')) return 'Spiegel';
            if (lower.includes('schweller') || lower.includes('sill') || lower.includes('rocker')) return 'Schweller';
            if (lower.includes('seite') || lower.includes('side')) {
                if (lower.includes('links') || lower.includes('left')) return 'Seitenteil links';
                if (lower.includes('rechts') || lower.includes('right')) return 'Seitenteil rechts';
                return 'Seitenteil';
            }

            return null;
        }

        // ============================================
        // ðŸš™ FAHRZEUGTYP WECHSELN
        // ============================================

        function changeVehicleType(type) {
            if (type === currentVehicleType) return;

            currentVehicleType = type;

            // Buttons aktualisieren
            document.querySelectorAll('.vehicle-type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });

            // Viewer neu laden
            const container = document.getElementById('sketchfabApiContainer');
            const existingFrame = document.getElementById('api-frame');
            if (existingFrame) {
                existingFrame.remove();
            }

            // Loading wieder anzeigen
            const loading = document.getElementById('sketchfabLoading');
            if (loading) {
                loading.style.display = 'block';
                loading.innerHTML = `
                    <div class="spinner" style="width: 40px; height: 40px; border: 3px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px;"></div>
                    <p style="color: var(--color-text-secondary); font-size: var(--font-size-sm);">3D-Modell wird geladen...</p>
                `;
            }

            // Klick-Info zurÃ¼cksetzen
            document.getElementById('clickedPartInfo').style.display = 'none';
            document.getElementById('clickHint').style.display = 'none';

            // Sketchfab Client zurÃ¼cksetzen
            sketchfabClient = null;
            sketchfabApi = null;
            nodeMap = {};

            // Neuen Viewer initialisieren
            initSketchfabViewerAPI();

            console.log('ðŸ”„ Fahrzeugtyp gewechselt zu:', type);
        }

        function updateModelCredit(modelData) {
            const link = document.getElementById('modelLink');
            const author = document.getElementById('modelAuthor');

            if (link) {
                link.href = modelData.url;
                link.textContent = modelData.name;
            }
            if (author) {
                author.textContent = modelData.author;
            }
        }

        // ============================================
        // ðŸ¤– KI-MODELL DROPDOWN
        // ============================================

        function toggleAIDropdown() {
            const dropdown = document.getElementById('aiDropdown');
            if (dropdown) {
                const isVisible = dropdown.style.display === 'block';
                dropdown.style.display = isVisible ? 'none' : 'block';
            }
        }

        // Dropdown schlieÃŸen wenn auÃŸerhalb geklickt wird
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('aiDropdown');
            const aiBtn = event.target.closest('.ai-btn');

            if (dropdown && !aiBtn && !event.target.closest('.ai-dropdown-content')) {
                dropdown.style.display = 'none';
            }
        });

        // ============================================
        // ðŸ” OE-NUMMERN ERSATZTEILE-SUCHE
        // ============================================

        let oeSearchTimeout = null;

        function initOeSearch() {
            // PrÃ¼fe ob ERSATZTEILE_DB verfÃ¼gbar ist
            if (typeof ERSATZTEILE_DB === 'undefined') {
                console.error('âŒ ERSATZTEILE_DB nicht geladen');
                document.getElementById('oeSearchStats').textContent = 'Datenbank nicht verfÃ¼gbar';
                return;
            }

            // Statistiken anzeigen
            const stats = ERSATZTEILE_DB.getStatistiken();
            document.getElementById('oeSearchStats').textContent =
                `${stats.marken} Marken | ${stats.modelle} Modelle | ${stats.oeNummern} OE-Nummern`;

            // Marken-Dropdown befÃ¼llen
            const markeSelect = document.getElementById('oeMarkeSelect');
            markeSelect.innerHTML = '<option value="">Alle Marken</option>';

            Object.keys(ERSATZTEILE_DB.marken).sort().forEach(markenKey => {
                const marke = ERSATZTEILE_DB.marken[markenKey];
                const option = document.createElement('option');
                option.value = markenKey;
                option.textContent = marke.name;
                markeSelect.appendChild(option);
            });

            console.log('âœ… OE-Suche initialisiert:', stats);
        }

        function updateOeModelle() {
            const markeKey = document.getElementById('oeMarkeSelect').value;
            const modellSelect = document.getElementById('oeModellSelect');
            modellSelect.innerHTML = '<option value="">Alle Modelle</option>';

            if (markeKey && ERSATZTEILE_DB.marken[markeKey]) {
                const marke = ERSATZTEILE_DB.marken[markeKey];
                Object.keys(marke.modelle).sort().forEach(modellKey => {
                    const modell = marke.modelle[modellKey];
                    const option = document.createElement('option');
                    option.value = modellKey;
                    option.textContent = `${modell.name} (${modell.baujahre})`;
                    modellSelect.appendChild(option);
                });
            }

            performOeSearch();
        }

        function performOeSearch() {
            // Debounce fÃ¼r Performance
            clearTimeout(oeSearchTimeout);
            oeSearchTimeout = setTimeout(() => {
                executeOeSearch();
            }, 200);
        }

        function executeOeSearch() {
            const searchInput = document.getElementById('oeSearchInput').value.trim();
            const markeKey = document.getElementById('oeMarkeSelect').value;
            const modellKey = document.getElementById('oeModellSelect').value;
            const resultsContainer = document.getElementById('oeResults');

            // Keine Suche wenn kein Input
            if (!searchInput && !markeKey) {
                resultsContainer.innerHTML = `
                    <div class="oe-no-results">
                        <span style="font-size: 2rem;">ðŸ”</span>
                        <p>Geben Sie eine OE-Nummer oder einen Teilenamen ein</p>
                    </div>
                `;
                return;
            }

            let ergebnisse = [];

            // Suche nach OE-Nummer
            if (searchInput.length >= 2) {
                // Versuche OE-Nummer-Suche
                const oeResults = ERSATZTEILE_DB.sucheNachOeNummer(searchInput);
                // Auch Namenssuche
                const nameResults = ERSATZTEILE_DB.sucheNachName(searchInput);

                // Kombinieren und Duplikate entfernen
                const combined = [...oeResults];
                nameResults.forEach(nr => {
                    const exists = combined.some(or =>
                        or.marke === nr.marke && or.modell === nr.modell && or.teil === nr.teil
                    );
                    if (!exists) combined.push(nr);
                });
                ergebnisse = combined;
            }

            // Fahrzeug-spezifische Suche
            if (markeKey) {
                const fahrzeugTeile = ERSATZTEILE_DB.getTeileNachFahrzeug(
                    ERSATZTEILE_DB.marken[markeKey].name,
                    modellKey ? ERSATZTEILE_DB.marken[markeKey].modelle[modellKey]?.name : null
                );

                if (searchInput.length >= 2) {
                    // Filter bereits gefundene Ergebnisse nach Fahrzeug
                    ergebnisse = ergebnisse.filter(e =>
                        e.marke === ERSATZTEILE_DB.marken[markeKey].name &&
                        (!modellKey || e.modell === ERSATZTEILE_DB.marken[markeKey].modelle[modellKey]?.name)
                    );
                } else {
                    // Zeige alle Teile des Fahrzeugs
                    ergebnisse = fahrzeugTeile;
                }
            }

            // Ergebnisse anzeigen
            if (ergebnisse.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="oe-no-results">
                        <span style="font-size: 2rem;">ðŸ˜”</span>
                        <p>Keine Ergebnisse gefunden</p>
                        <small>Versuchen Sie einen anderen Suchbegriff</small>
                    </div>
                `;
                return;
            }

            // Maximal 50 Ergebnisse anzeigen
            const displayResults = ergebnisse.slice(0, 50);

            resultsContainer.innerHTML = displayResults.map(result => `
                <div class="oe-result-item" onclick="selectOeResult(this, '${escapeHtml(result.teil)}', '${result.oe_nummer}', '${escapeHtml(result.marke)} ${escapeHtml(result.modell)}')">
                    <div class="oe-result-info">
                        <div class="oe-result-part">${result.teil}</div>
                        <div class="oe-result-vehicle">${result.marke} ${result.modell} (${result.baujahre || 'diverse'})</div>
                    </div>
                    <div class="oe-result-oe">${result.oe_nummer}</div>
                </div>
            `).join('');

            if (ergebnisse.length > 50) {
                resultsContainer.innerHTML += `
                    <div style="text-align: center; padding: var(--space-3); color: var(--color-text-secondary); font-size: var(--font-size-sm);">
                        ... und ${ergebnisse.length - 50} weitere Ergebnisse
                    </div>
                `;
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/[&<>"']/g, function(m) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[m];
            });
        }

        function selectOeResult(element, teileName, oeNummer, fahrzeug) {
            // Markiere als ausgewÃ¤hlt
            document.querySelectorAll('.oe-result-item').forEach(item => {
                item.style.borderColor = 'var(--color-border)';
                item.style.background = 'var(--color-background)';
            });
            element.style.borderColor = 'var(--color-success)';
            element.style.background = 'rgba(52, 199, 89, 0.1)';

            // Erstelle Material-Position mit OE-Nummer
            const materialName = `${teileName} (OE: ${oeNummer}) - ${fahrzeug}`;

            // FÃ¼ge als Material hinzu
            addMaterialWithOe(materialName, oeNummer);

            // Feedback
            showToast(`âœ… ${teileName} hinzugefÃ¼gt`, 'success');
        }

        function addMaterialWithOe(name, oeNummer) {
            const newMaterial = {
                name: name,
                kategorie: 'Ersatzteile',
                menge: 1,
                einheit: 'StÃ¼ck',
                einkaufspreis: 0, // Preis manuell eintragen
                verkaufspreis: 0, // Preis manuell eintragen
                oeNummer: oeNummer
            };

            materialien.push(newMaterial);
            renderMaterialien();
            berechneGesamtsumme();
        }

        // ============================================
        // ðŸŽ¯ 3D PART SELECTION (Button-Fallback)
        // ============================================

        function select3DPart(partName) {
            // Vorherige Auswahl entfernen
            document.querySelectorAll('.part-btn-3d').forEach(btn => {
                btn.classList.remove('selected');
            });

            // Aktiven Button markieren
            if (event && event.target) {
                event.target.classList.add('selected');
            }

            // Wizard Ã¶ffnen (gleiche Funktion wie 2D)
            selectedPart = partName;
            openDamageWizard(partName);
        }

        function selectVehiclePart(partName, element) {
            // Vorherige Auswahl entfernen
            document.querySelectorAll('.vehicle-part.selected').forEach(p => {
                p.classList.remove('selected');
            });

            // Neue Auswahl markieren
            element.classList.add('selected');
            selectedPart = partName;

            // Wizard Ã¶ffnen
            openDamageWizard(partName);
        }

        function openDamageWizard(partName) {
            selectedDamageType = null;
            selectedDamageSize = null;

            // Titel setzen
            document.getElementById('wizardPartName').textContent = partName;

            // Schritte zurÃ¼cksetzen
            document.getElementById('wizardStep1').style.display = 'block';
            document.getElementById('wizardStep2').style.display = 'none';
            document.getElementById('suggestedPositions').style.display = 'none';

            // Options zurÃ¼cksetzen
            document.querySelectorAll('.damage-option').forEach(opt => {
                opt.classList.remove('selected');
            });

            // Wizard anzeigen
            document.getElementById('damageWizard').classList.add('active');
            feather.replace();
        }

        function closeDamageWizard() {
            document.getElementById('damageWizard').classList.remove('active');

            // Auswahl im Diagramm entfernen
            document.querySelectorAll('.vehicle-part.selected').forEach(p => {
                p.classList.remove('selected');
            });

            selectedPart = null;
            selectedDamageType = null;
            selectedDamageSize = null;
        }

        function selectDamageType(element) {
            // Vorherige Auswahl entfernen
            document.querySelectorAll('#damageTypeOptions .damage-option').forEach(opt => {
                opt.classList.remove('selected');
            });

            // Neue Auswahl
            element.classList.add('selected');
            selectedDamageType = element.dataset.type;

            // Zu Schritt 2 wechseln
            document.getElementById('wizardStep1').style.display = 'none';
            document.getElementById('wizardStep2').style.display = 'block';
        }

        function selectDamageSize(element) {
            // Vorherige Auswahl entfernen
            document.querySelectorAll('#damageSizeOptions .damage-option').forEach(opt => {
                opt.classList.remove('selected');
            });

            // Neue Auswahl
            element.classList.add('selected');
            selectedDamageSize = element.dataset.size;

            // VorschlÃ¤ge generieren und anzeigen
            generateSuggestions();
        }

        function generateSuggestions() {
            suggestedItems = [];

            const mapping = partWorkMapping[selectedPart];
            if (!mapping) {
                console.warn('Kein Mapping fÃ¼r:', selectedPart);
                return;
            }

            const keywords = mapping[selectedDamageType] || [];

            // Passende Positionen aus dem Katalog finden
            keywords.forEach(keyword => {
                // GrÃ¶ÃŸe berÃ¼cksichtigen bei Spot-Repair, Delle, Spachteln
                let searchKeyword = keyword;
                if (keyword === 'Spot-Repair') {
                    searchKeyword = sizeMapping[selectedDamageSize]?.spotRepair || 'Spot-Repair M';
                } else if (keyword.includes('Delle ausbeulen')) {
                    searchKeyword = 'Delle ausbeulen ' + (sizeMapping[selectedDamageSize]?.delle || 'PDR M');
                } else if (keyword === 'Spachteln') {
                    searchKeyword = sizeMapping[selectedDamageSize]?.spachteln || 'Spachteln mittel';
                }

                // Im Katalog suchen
                const matches = katalogData.filter(item =>
                    item.name.toLowerCase().includes(searchKeyword.toLowerCase())
                );

                if (matches.length > 0) {
                    // Beste Ãœbereinstimmung nehmen
                    const bestMatch = matches[0];
                    if (!suggestedItems.find(s => s.id === bestMatch.id)) {
                        suggestedItems.push({
                            ...bestMatch,
                            added: false
                        });
                    }
                }
            });

            // VorschlÃ¤ge anzeigen
            renderSuggestions();
        }

        function renderSuggestions() {
            const container = document.getElementById('suggestedList');

            if (suggestedItems.length === 0) {
                container.innerHTML = `
                    <p style="color: var(--color-text-secondary); font-size: var(--font-size-sm);">
                        Keine passenden Positionen im Katalog gefunden.
                        <a href="?tab=katalog" style="color: var(--color-primary);">Katalog erweitern</a>
                    </p>
                `;
            } else {
                container.innerHTML = suggestedItems.map((item, index) => {
                    const preis = calculatePositionPreis(item);
                    return `
                        <div class="suggested-item ${item.added ? 'added' : ''}"
                             onclick="toggleSuggestedItem(${index})">
                            <div class="suggested-item__info">
                                <div class="suggested-item__checkbox">
                                    ${item.added ? '<i data-feather="check" style="width: 14px; height: 14px;"></i>' : ''}
                                </div>
                                <span class="suggested-item__name">${item.name}</span>
                            </div>
                            <span class="suggested-item__price">${item.arbeitswerte} AW / ${preis.toFixed(2)} â‚¬</span>
                        </div>
                    `;
                }).join('');
            }

            // VorschlÃ¤ge-Section anzeigen
            document.getElementById('suggestedPositions').style.display = 'block';
            feather.replace();
        }

        function toggleSuggestedItem(index) {
            const item = suggestedItems[index];
            item.added = !item.added;

            if (item.added) {
                // Zur Kalkulation hinzufÃ¼gen
                addPositionToKalkulation(item);
            } else {
                // Aus Kalkulation entfernen
                removePositionFromKalkulation(item.id);
            }

            renderSuggestions();
        }

        function addAllSuggested() {
            suggestedItems.forEach(item => {
                if (!item.added) {
                    item.added = true;
                    addPositionToKalkulation(item);
                }
            });

            renderSuggestions();
            showToast(`${suggestedItems.length} Positionen hinzugefÃ¼gt`, 'success');

            // Bauteil als beschÃ¤digt markieren
            const selectedElement = document.querySelector('.vehicle-part.selected');
            if (selectedElement) {
                selectedElement.classList.remove('selected');
                selectedElement.classList.add('damaged-medium');
            }
        }

        function addPositionToKalkulation(item) {
            // PrÃ¼fen ob bereits vorhanden
            if (aktuelleKalkulation.positionen.find(p => p.katalogId === item.id)) {
                return;
            }

            aktuelleKalkulation.positionen.push({
                katalogId: item.id,
                name: item.name,
                kategorie: item.kategorie,
                arbeitswerte: item.arbeitswerte,
                anzahl: 1,
                preis: calculatePositionPreis(item)
            });

            renderPositionen();
            calculateSumme();

            // Kalkulation-Content anzeigen
            document.getElementById('kalkulationContent').style.display = 'block';
            document.getElementById('freieKalkulationStart').style.display = 'none';
        }

        function removePositionFromKalkulation(katalogId) {
            aktuelleKalkulation.positionen = aktuelleKalkulation.positionen.filter(
                p => p.katalogId !== katalogId
            );
            renderPositionen();
            calculateSumme();
        }

        function calculatePositionPreis(item) {
            // Stundensatz basierend auf Kategorie
            let stundensatz = kalkulationSaetze.stundensatzSonstige;
            if (item.kategorie === 'Lackierung') {
                stundensatz = kalkulationSaetze.stundensatzLack;
            } else if (item.kategorie === 'Karosserie') {
                stundensatz = kalkulationSaetze.stundensatzKarosserie;
            } else if (item.kategorie === 'Mechanik') {
                stundensatz = kalkulationSaetze.stundensatzMechanik;
            }

            // AW â†’ Stunden â†’ Euro
            const stunden = (item.arbeitswerte * kalkulationSaetze.awInMinuten) / 60;
            return stunden * stundensatz;
        }

        // ============================================
        // ðŸ” SCHNELLSUCHE FUNKTIONEN
        // ============================================

        function initQuickSearch() {
            const input = document.getElementById('quickSearchInput');
            const results = document.getElementById('quickSearchResults');

            if (!input || !results) return;

            let debounceTimer;

            input.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    const query = input.value.trim().toLowerCase();

                    if (query.length < 2) {
                        results.classList.remove('active');
                        return;
                    }

                    const matches = katalogData.filter(item =>
                        item.name.toLowerCase().includes(query) ||
                        (item.kategorie && item.kategorie.toLowerCase().includes(query))
                    ).slice(0, 10);

                    if (matches.length === 0) {
                        results.innerHTML = `
                            <div class="quick-search__result" style="color: var(--color-text-secondary);">
                                Keine Ergebnisse fÃ¼r "${query}"
                            </div>
                        `;
                    } else {
                        results.innerHTML = matches.map(item => {
                            const highlightedName = item.name.replace(
                                new RegExp(`(${query})`, 'gi'),
                                '<mark>$1</mark>'
                            );
                            const preis = calculatePositionPreis(item);
                            return `
                                <div class="quick-search__result" onclick="addFromQuickSearch('${item.id}')">
                                    <span class="quick-search__result-name">${highlightedName}</span>
                                    <span class="quick-search__result-meta">${item.arbeitswerte} AW Â· ${preis.toFixed(2)} â‚¬</span>
                                </div>
                            `;
                        }).join('');
                    }

                    results.classList.add('active');
                }, 200);
            });

            // SchlieÃŸen bei Klick auÃŸerhalb
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !results.contains(e.target)) {
                    results.classList.remove('active');
                }
            });

            // Enter-Taste
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const firstResult = results.querySelector('.quick-search__result');
                    if (firstResult) {
                        firstResult.click();
                    }
                }
            });
        }

        function addFromQuickSearch(itemId) {
            const item = katalogData.find(k => k.id === itemId);
            if (item) {
                addPositionToKalkulation(item);
                showToast(`"${item.name}" hinzugefÃ¼gt`, 'success');

                // Suche zurÃ¼cksetzen
                document.getElementById('quickSearchInput').value = '';
                document.getElementById('quickSearchResults').classList.remove('active');
            }
        }

        // ============================================
        // TAB NAVIGATION
        // ============================================

        function switchTab(tabId) {
            // Update buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tabId) {
                    btn.classList.add('active');
                }
            });

            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`tab-${tabId}`).classList.add('active');

            // Update URL without reload
            const url = new URL(window.location);
            url.searchParams.set('tab', tabId);
            window.history.replaceState({}, '', url);

            // Load data for specific tabs
            if (tabId === 'historie') {
                loadHistorie();
            }
        }

        // ============================================
        // STUNDENSÃ„TZE (TAB 3)
        // ============================================

        async function loadSaetze() {
            try {
                const doc = await window.getCollection('kalkulation_saetze').doc('config').get();
                if (doc.exists) {
                    kalkulationSaetze = { ...kalkulationSaetze, ...doc.data() };

                    // Update form fields
                    document.getElementById('stundensatzLack').value = kalkulationSaetze.stundensatzLack;
                    document.getElementById('stundensatzKarosserie').value = kalkulationSaetze.stundensatzKarosserie;
                    document.getElementById('stundensatzMechanik').value = kalkulationSaetze.stundensatzMechanik;
                    document.getElementById('stundensatzSonstige').value = kalkulationSaetze.stundensatzSonstige;
                    document.getElementById('awInMinuten').value = kalkulationSaetze.awInMinuten;
                    document.getElementById('mwstSatz').value = kalkulationSaetze.mwstSatz;

                    console.log('âœ… StundensÃ¤tze geladen');
                }
            } catch (error) {
                console.warn('âš ï¸ StundensÃ¤tze nicht gefunden, verwende Standardwerte');
            }
        }

        async function saveSaetze(event) {
            event.preventDefault();

            const btn = document.getElementById('saveSaetzeBtn');
            btn.disabled = true;
            btn.innerHTML = '<i data-feather="loader"></i> Speichert...';
            feather.replace();

            try {
                kalkulationSaetze = {
                    stundensatzLack: parseFloat(document.getElementById('stundensatzLack').value) || 95,
                    stundensatzKarosserie: parseFloat(document.getElementById('stundensatzKarosserie').value) || 85,
                    stundensatzMechanik: parseFloat(document.getElementById('stundensatzMechanik').value) || 75,
                    stundensatzSonstige: parseFloat(document.getElementById('stundensatzSonstige').value) || 65,
                    awInMinuten: parseInt(document.getElementById('awInMinuten').value) || 5,
                    mwstSatz: parseFloat(document.getElementById('mwstSatz').value) || 19,
                    updatedAt: new Date().toISOString()
                };

                await window.getCollection('kalkulation_saetze').doc('config').set(kalkulationSaetze);

                showToast('Einstellungen gespeichert!', 'success');
                console.log('âœ… StundensÃ¤tze gespeichert:', kalkulationSaetze);

            } catch (error) {
                console.error('âŒ Fehler beim Speichern:', error);
                showToast('Fehler beim Speichern', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i data-feather="save"></i> Einstellungen speichern';
                feather.replace();
            }
        }

        // ============================================
        // ARBEITSWERT-KATALOG (TAB 2)
        // ============================================

        async function loadKatalog() {
            try {
                const snapshot = await window.getCollection('kalkulation_katalog')
                    .orderBy('kategorie')
                    .orderBy('name')
                    .get();

                katalogData = [];
                snapshot.forEach(doc => {
                    katalogData.push({ id: doc.id, ...doc.data() });
                });

                renderKatalog();
                console.log(`âœ… ${katalogData.length} Katalog-EintrÃ¤ge geladen`);
            } catch (error) {
                console.warn('âš ï¸ Katalog nicht gefunden:', error);
            }
        }

        function renderKatalog() {
            const container = document.getElementById('katalogListe');

            if (katalogData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i data-feather="book-open"></i>
                        <h3>Katalog leer</h3>
                        <p>Erstellen Sie Ihren ersten Arbeitswert-Eintrag</p>
                        <button class="btn btn-primary" onclick="seedKatalog()">
                            <i data-feather="download"></i>
                            Standard-Katalog laden
                        </button>
                    </div>
                `;
                feather.replace();
                return;
            }

            // Group by category
            const grouped = {};
            katalogData.forEach(item => {
                const kat = item.kategorie || 'Sonstiges';
                if (!grouped[kat]) grouped[kat] = [];
                grouped[kat].push(item);
            });

            let html = '';
            Object.keys(grouped).sort().forEach(kategorie => {
                const items = grouped[kategorie];
                html += `
                    <div class="category-group">
                        <div class="category-header">
                            <h3>${kategorie}</h3>
                            <span class="count">${items.length}</span>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Bezeichnung</th>
                                    <th>AW</th>
                                    <th>Zeit</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${items.map(item => `
                                    <tr>
                                        <td>${item.name}</td>
                                        <td>${item.arbeitswerte} AW</td>
                                        <td>~${Math.round(item.arbeitswerte * kalkulationSaetze.awInMinuten)} Min</td>
                                        <td class="actions">
                                            <button class="btn btn-icon btn-secondary" onclick="editKatalogPosition('${item.id}')" title="Bearbeiten">
                                                <i data-feather="edit-2"></i>
                                            </button>
                                            <button class="btn btn-icon btn-secondary" onclick="deleteKatalogPosition('${item.id}')" title="LÃ¶schen" style="color: var(--color-error);">
                                                <i data-feather="trash-2"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            });

            container.innerHTML = html;
            feather.replace();
        }

        function filterKatalog() {
            const search = document.getElementById('katalogSearch').value.toLowerCase();
            const filter = document.getElementById('katalogFilter').value;

            // TODO: Implement filtering
            console.log('Filter:', search, filter);
        }

        function openKatalogModal(positionId = null) {
            document.getElementById('katalogModalTitle').textContent = positionId ? 'Position bearbeiten' : 'Neue Position';
            document.getElementById('katalogPositionId').value = positionId || '';
            document.getElementById('katalogForm').reset();

            if (positionId) {
                const position = katalogData.find(p => p.id === positionId);
                if (position) {
                    document.getElementById('positionName').value = position.name || '';
                    document.getElementById('positionKategorie').value = position.kategorie || '';
                    document.getElementById('positionAW').value = position.arbeitswerte || '';
                    document.getElementById('positionBeschreibung').value = position.beschreibung || '';
                }
            }

            document.getElementById('katalogModal').classList.add('active');
            feather.replace();
        }

        function editKatalogPosition(positionId) {
            openKatalogModal(positionId);
        }

        async function saveKatalogPosition(event) {
            event.preventDefault();

            const positionId = document.getElementById('katalogPositionId').value;
            const data = {
                name: document.getElementById('positionName').value.trim(),
                kategorie: document.getElementById('positionKategorie').value,
                arbeitswerte: parseFloat(document.getElementById('positionAW').value) || 0,
                beschreibung: document.getElementById('positionBeschreibung').value.trim(),
                updatedAt: new Date().toISOString()
            };

            try {
                if (positionId) {
                    await window.getCollection('kalkulation_katalog').doc(positionId).update(data);
                    showToast('Position aktualisiert', 'success');
                } else {
                    data.createdAt = new Date().toISOString();
                    await window.getCollection('kalkulation_katalog').add(data);
                    showToast('Position erstellt', 'success');
                }

                closeModal('katalogModal');
                await loadKatalog();

            } catch (error) {
                console.error('âŒ Fehler:', error);
                showToast('Fehler beim Speichern', 'error');
            }
        }

        async function deleteKatalogPosition(positionId) {
            if (!confirm('Position wirklich lÃ¶schen?')) return;

            try {
                await window.getCollection('kalkulation_katalog').doc(positionId).delete();
                showToast('Position gelÃ¶scht', 'success');
                await loadKatalog();
            } catch (error) {
                console.error('âŒ Fehler:', error);
                showToast('Fehler beim LÃ¶schen', 'error');
            }
        }

        async function seedKatalog() {
            // ============================================
            // ðŸ­ UMFANGREICHER ARBEITSWERT-KATALOG
            // Basierend auf DAT/Audatex Branchenstandards 2024
            // 1 AW = 5 Minuten (Branchenstandard)
            // Quellen: DEKRA, ZKF, Carrosserie Suisse
            // ============================================
            const SEED_DATA = [
                // ================================================
                // DEMONTAGE/MONTAGE - STOSSF Ã„NGER
                // ================================================
                { name: "StoÃŸfÃ¤nger vorne dem./mont.", kategorie: "Karosserie", arbeitswerte: 8.5 },
                { name: "StoÃŸfÃ¤nger vorne mit Sensoren dem./mont.", kategorie: "Karosserie", arbeitswerte: 12.0 },
                { name: "StoÃŸfÃ¤nger hinten dem./mont.", kategorie: "Karosserie", arbeitswerte: 7.0 },
                { name: "StoÃŸfÃ¤nger hinten mit Sensoren dem./mont.", kategorie: "Karosserie", arbeitswerte: 10.0 },
                { name: "PDC-Sensoren kalibrieren", kategorie: "Karosserie", arbeitswerte: 4.0 },

                // ================================================
                // DEMONTAGE/MONTAGE - AUSSENHAUT
                // ================================================
                { name: "KotflÃ¼gel vorne dem./mont.", kategorie: "Karosserie", arbeitswerte: 12.0 },
                { name: "KotflÃ¼gel vorne Aluminium dem./mont.", kategorie: "Karosserie", arbeitswerte: 15.0 },
                { name: "Motorhaube dem./mont.", kategorie: "Karosserie", arbeitswerte: 4.0 },
                { name: "Motorhaube mit DÃ¤mmung dem./mont.", kategorie: "Karosserie", arbeitswerte: 6.0 },
                { name: "TÃ¼r vorne dem./mont.", kategorie: "Karosserie", arbeitswerte: 8.0 },
                { name: "TÃ¼r hinten dem./mont.", kategorie: "Karosserie", arbeitswerte: 7.0 },
                { name: "TÃ¼rverkleidung dem./mont.", kategorie: "Karosserie", arbeitswerte: 4.0 },
                { name: "Heckklappe dem./mont.", kategorie: "Karosserie", arbeitswerte: 6.0 },
                { name: "Heckklappe Kombi mit Scheibenheizung dem./mont.", kategorie: "Karosserie", arbeitswerte: 10.0 },
                { name: "Kofferraumdeckel Limousine dem./mont.", kategorie: "Karosserie", arbeitswerte: 5.0 },
                { name: "Seitenspiegel dem./mont.", kategorie: "Karosserie", arbeitswerte: 2.0 },
                { name: "Seitenspiegel elektrisch dem./mont.", kategorie: "Karosserie", arbeitswerte: 3.5 },
                { name: "Seitenspiegel mit Kamera dem./mont.", kategorie: "Karosserie", arbeitswerte: 5.0 },

                // ================================================
                // DEMONTAGE/MONTAGE - VERGLASUNG
                // ================================================
                { name: "Frontscheibe dem./mont.", kategorie: "Karosserie", arbeitswerte: 18.0 },
                { name: "Frontscheibe mit Kamera (ADAS) dem./mont.", kategorie: "Karosserie", arbeitswerte: 24.0 },
                { name: "Heckscheibe dem./mont.", kategorie: "Karosserie", arbeitswerte: 12.0 },
                { name: "Heckscheibe mit Heizung dem./mont.", kategorie: "Karosserie", arbeitswerte: 15.0 },
                { name: "Seitenscheibe vorne dem./mont.", kategorie: "Karosserie", arbeitswerte: 6.0 },
                { name: "Seitenscheibe hinten dem./mont.", kategorie: "Karosserie", arbeitswerte: 5.0 },
                { name: "Dreiecksfenster dem./mont.", kategorie: "Karosserie", arbeitswerte: 4.0 },
                { name: "ADAS-Kalibrierung nach Scheibenwechsel", kategorie: "Karosserie", arbeitswerte: 12.0 },

                // ================================================
                // DEMONTAGE/MONTAGE - ANBAUTEILE
                // ================================================
                { name: "Scheinwerfer dem./mont.", kategorie: "Karosserie", arbeitswerte: 4.0 },
                { name: "Scheinwerfer LED/Xenon dem./mont.", kategorie: "Karosserie", arbeitswerte: 6.0 },
                { name: "Scheinwerfer Matrix-LED dem./mont.", kategorie: "Karosserie", arbeitswerte: 8.0 },
                { name: "RÃ¼ckleuchte dem./mont.", kategorie: "Karosserie", arbeitswerte: 2.0 },
                { name: "RÃ¼ckleuchte LED dem./mont.", kategorie: "Karosserie", arbeitswerte: 3.0 },
                { name: "KÃ¼hlergrill dem./mont.", kategorie: "Karosserie", arbeitswerte: 3.0 },
                { name: "KÃ¼hlergrill mit Kamera/Radar dem./mont.", kategorie: "Karosserie", arbeitswerte: 5.0 },
                { name: "Schweller-Verkleidung dem./mont.", kategorie: "Karosserie", arbeitswerte: 3.0 },
                { name: "Radlaufverkleidung dem./mont.", kategorie: "Karosserie", arbeitswerte: 2.0 },
                { name: "Unterbodenverkleidung dem./mont.", kategorie: "Karosserie", arbeitswerte: 6.0 },
                { name: "Spoiler vorne dem./mont.", kategorie: "Karosserie", arbeitswerte: 4.0 },
                { name: "Spoiler hinten dem./mont.", kategorie: "Karosserie", arbeitswerte: 3.0 },
                { name: "Dachspoiler dem./mont.", kategorie: "Karosserie", arbeitswerte: 4.0 },
                { name: "DachtrÃ¤ger dem./mont.", kategorie: "Karosserie", arbeitswerte: 2.0 },
                { name: "Dachantenne dem./mont.", kategorie: "Karosserie", arbeitswerte: 1.5 },
                { name: "Tankdeckel dem./mont.", kategorie: "Karosserie", arbeitswerte: 1.0 },
                { name: "Zierleisten Fenster dem./mont.", kategorie: "Karosserie", arbeitswerte: 6.0 },
                { name: "Zierleisten StoÃŸfÃ¤nger dem./mont.", kategorie: "Karosserie", arbeitswerte: 2.0 },
                { name: "TÃ¼rgriff auÃŸen dem./mont.", kategorie: "Karosserie", arbeitswerte: 2.0 },
                { name: "Nummernschildhalter dem./mont.", kategorie: "Karosserie", arbeitswerte: 0.5 },

                // ================================================
                // LACKIERUNG - EINZELTEILE
                // ================================================
                { name: "StoÃŸfÃ¤nger vorne lackieren", kategorie: "Lackierung", arbeitswerte: 10.0 },
                { name: "StoÃŸfÃ¤nger hinten lackieren", kategorie: "Lackierung", arbeitswerte: 9.0 },
                { name: "KotflÃ¼gel vorne lackieren", kategorie: "Lackierung", arbeitswerte: 10.0 },
                { name: "Motorhaube lackieren", kategorie: "Lackierung", arbeitswerte: 12.0 },
                { name: "TÃ¼r lackieren", kategorie: "Lackierung", arbeitswerte: 11.0 },
                { name: "Heckklappe lackieren", kategorie: "Lackierung", arbeitswerte: 11.0 },
                { name: "Kofferraumdeckel lackieren", kategorie: "Lackierung", arbeitswerte: 10.0 },
                { name: "Dach lackieren", kategorie: "Lackierung", arbeitswerte: 14.0 },
                { name: "Seitenteil lackieren", kategorie: "Lackierung", arbeitswerte: 12.0 },
                { name: "A-SÃ¤ule lackieren", kategorie: "Lackierung", arbeitswerte: 6.0 },
                { name: "B-SÃ¤ule lackieren", kategorie: "Lackierung", arbeitswerte: 5.0 },
                { name: "C-SÃ¤ule lackieren", kategorie: "Lackierung", arbeitswerte: 5.0 },
                { name: "Schweller lackieren", kategorie: "Lackierung", arbeitswerte: 8.0 },
                { name: "Spiegel lackieren (pro StÃ¼ck)", kategorie: "Lackierung", arbeitswerte: 3.0 },
                { name: "Spoiler lackieren", kategorie: "Lackierung", arbeitswerte: 6.0 },
                { name: "Tankdeckel lackieren", kategorie: "Lackierung", arbeitswerte: 2.0 },
                { name: "TÃ¼rgriff lackieren (pro StÃ¼ck)", kategorie: "Lackierung", arbeitswerte: 1.5 },

                // ================================================
                // LACKIERUNG - SPOT-REPAIR / SMART-REPAIR
                // ================================================
                { name: "Spot-Repair XS (bis 3cm)", kategorie: "Lackierung", arbeitswerte: 4.0 },
                { name: "Spot-Repair S (bis 5cm)", kategorie: "Lackierung", arbeitswerte: 5.0 },
                { name: "Spot-Repair M (bis 10cm)", kategorie: "Lackierung", arbeitswerte: 6.0 },
                { name: "Spot-Repair L (bis 15cm)", kategorie: "Lackierung", arbeitswerte: 8.0 },
                { name: "Spot-Repair XL (bis 20cm)", kategorie: "Lackierung", arbeitswerte: 10.0 },
                { name: "Steinschlag-Reparatur (pro Stelle)", kategorie: "Lackierung", arbeitswerte: 1.0 },
                { name: "Kratzer-Politur (pro Panel)", kategorie: "Lackierung", arbeitswerte: 2.0 },
                { name: "Lackreinigung vor Lackierung", kategorie: "Lackierung", arbeitswerte: 2.0 },

                // ================================================
                // LACKIERUNG - LACKAUFBAU
                // ================================================
                { name: "Grundierung auftragen (pro Teil)", kategorie: "Lackierung", arbeitswerte: 4.0 },
                { name: "FÃ¼ller auftragen (pro Teil)", kategorie: "Lackierung", arbeitswerte: 4.0 },
                { name: "FÃ¼ller schleifen (pro Teil)", kategorie: "Lackierung", arbeitswerte: 3.0 },
                { name: "Basislack auftragen (pro Teil)", kategorie: "Lackierung", arbeitswerte: 5.0 },
                { name: "Klarlack auftragen (pro Teil)", kategorie: "Lackierung", arbeitswerte: 4.0 },
                { name: "2-Schicht Metallic-Lackierung (pro Teil)", kategorie: "Lackierung", arbeitswerte: 10.0 },
                { name: "3-Schicht Perleffekt-Lackierung (pro Teil)", kategorie: "Lackierung", arbeitswerte: 14.0 },
                { name: "Mattlack-Lackierung (pro Teil)", kategorie: "Lackierung", arbeitswerte: 12.0 },
                { name: "Sonderlackierung (Effektlack)", kategorie: "Lackierung", arbeitswerte: 16.0 },
                { name: "Farbton mischen nach Farbcode", kategorie: "Lackierung", arbeitswerte: 3.0 },
                { name: "Farbton einmessen (Spectrophotometer)", kategorie: "Lackierung", arbeitswerte: 2.0 },

                // ================================================
                // LACKIERUNG - KOMPLETT
                // ================================================
                { name: "Komplettlackierung Kleinwagen", kategorie: "Lackierung", arbeitswerte: 80.0 },
                { name: "Komplettlackierung Kompaktklasse", kategorie: "Lackierung", arbeitswerte: 100.0 },
                { name: "Komplettlackierung Mittelklasse", kategorie: "Lackierung", arbeitswerte: 120.0 },
                { name: "Komplettlackierung Oberklasse/SUV", kategorie: "Lackierung", arbeitswerte: 140.0 },
                { name: "Komplettlackierung Transporter", kategorie: "Lackierung", arbeitswerte: 160.0 },
                { name: "Teillackierung (3-5 Teile)", kategorie: "Lackierung", arbeitswerte: 40.0 },
                { name: "Teillackierung (6-10 Teile)", kategorie: "Lackierung", arbeitswerte: 70.0 },

                // ================================================
                // KAROSSERIEARBEITEN - AUSBEULEN
                // ================================================
                { name: "Delle ausbeulen PDR XS (bis 1cm)", kategorie: "Karosserie", arbeitswerte: 3.0 },
                { name: "Delle ausbeulen PDR S (bis 2cm)", kategorie: "Karosserie", arbeitswerte: 5.0 },
                { name: "Delle ausbeulen PDR M (bis 5cm)", kategorie: "Karosserie", arbeitswerte: 8.0 },
                { name: "Delle ausbeulen PDR L (bis 10cm)", kategorie: "Karosserie", arbeitswerte: 12.0 },
                { name: "Delle ausbeulen PDR XL (Ã¼ber 10cm)", kategorie: "Karosserie", arbeitswerte: 18.0 },
                { name: "Hagelschaden PDR pro Delle", kategorie: "Karosserie", arbeitswerte: 2.0 },
                { name: "Hagelschaden Pauschale Kleinwagen", kategorie: "Karosserie", arbeitswerte: 60.0 },
                { name: "Hagelschaden Pauschale Mittelklasse", kategorie: "Karosserie", arbeitswerte: 80.0 },
                { name: "Hagelschaden Pauschale SUV/Kombi", kategorie: "Karosserie", arbeitswerte: 100.0 },
                { name: "Ausbeulen konventionell (pro Teil)", kategorie: "Karosserie", arbeitswerte: 15.0 },
                { name: "Ausziehen mit Spotter", kategorie: "Karosserie", arbeitswerte: 10.0 },

                // ================================================
                // KAROSSERIEARBEITEN - SPACHTELN
                // ================================================
                { name: "Spachteln klein (bis 5cm)", kategorie: "Karosserie", arbeitswerte: 4.0 },
                { name: "Spachteln mittel (bis 15cm)", kategorie: "Karosserie", arbeitswerte: 8.0 },
                { name: "Spachteln groÃŸ (bis 30cm)", kategorie: "Karosserie", arbeitswerte: 12.0 },
                { name: "Spachteln sehr groÃŸ (Ã¼ber 30cm)", kategorie: "Karosserie", arbeitswerte: 18.0 },
                { name: "Glasfaserspachtel auftragen", kategorie: "Karosserie", arbeitswerte: 6.0 },
                { name: "Kunststoffspachteln", kategorie: "Karosserie", arbeitswerte: 5.0 },
                { name: "Feinspachteln", kategorie: "Karosserie", arbeitswerte: 3.0 },
                { name: "Schleifen vor Lackierung", kategorie: "Karosserie", arbeitswerte: 4.0 },
                { name: "Nassschleifen (pro Teil)", kategorie: "Karosserie", arbeitswerte: 3.0 },

                // ================================================
                // KAROSSERIEARBEITEN - SCHWEISSEN/KLEBEN
                // ================================================
                { name: "SchweiÃŸnaht kurz (bis 10cm)", kategorie: "Karosserie", arbeitswerte: 4.0 },
                { name: "SchweiÃŸnaht mittel (bis 30cm)", kategorie: "Karosserie", arbeitswerte: 8.0 },
                { name: "SchweiÃŸnaht lang (Ã¼ber 30cm)", kategorie: "Karosserie", arbeitswerte: 12.0 },
                { name: "PunktschweiÃŸen (pro Punkt)", kategorie: "Karosserie", arbeitswerte: 0.5 },
                { name: "KunststoffschweiÃŸen", kategorie: "Karosserie", arbeitswerte: 8.0 },
                { name: "Klebereparatur Kunststoff", kategorie: "Karosserie", arbeitswerte: 6.0 },
                { name: "Strukturkleben", kategorie: "Karosserie", arbeitswerte: 5.0 },
                { name: "Hohlraumversiegelung (pro Hohlraum)", kategorie: "Karosserie", arbeitswerte: 3.0 },
                { name: "Unterbodenschutz auftragen", kategorie: "Karosserie", arbeitswerte: 10.0 },
                { name: "Nahtabdichtung", kategorie: "Karosserie", arbeitswerte: 4.0 },

                // ================================================
                // KAROSSERIEARBEITEN - TEILEERSATZ
                // ================================================
                { name: "KotflÃ¼gel einschweiÃŸen", kategorie: "Karosserie", arbeitswerte: 40.0 },
                { name: "Seitenteil ersetzen (geschweiÃŸt)", kategorie: "Karosserie", arbeitswerte: 60.0 },
                { name: "Schweller ersetzen (komplett)", kategorie: "Karosserie", arbeitswerte: 50.0 },
                { name: "Schweller Teilersatz", kategorie: "Karosserie", arbeitswerte: 30.0 },
                { name: "A-SÃ¤ule ersetzen", kategorie: "Karosserie", arbeitswerte: 45.0 },
                { name: "B-SÃ¤ule ersetzen", kategorie: "Karosserie", arbeitswerte: 50.0 },
                { name: "Radhaus ersetzen", kategorie: "Karosserie", arbeitswerte: 35.0 },
                { name: "LÃ¤ngstrÃ¤gerteil ersetzen", kategorie: "Karosserie", arbeitswerte: 55.0 },
                { name: "RÃ¼ckwand ersetzen", kategorie: "Karosserie", arbeitswerte: 45.0 },
                { name: "Bodenblech Teilersatz", kategorie: "Karosserie", arbeitswerte: 40.0 },

                // ================================================
                // MECHANIK - FAHRWERK
                // ================================================
                { name: "StoÃŸdÃ¤mpfer vorne wechseln (pro Seite)", kategorie: "Mechanik", arbeitswerte: 8.0 },
                { name: "StoÃŸdÃ¤mpfer hinten wechseln (pro Seite)", kategorie: "Mechanik", arbeitswerte: 6.0 },
                { name: "Federbein komplett wechseln", kategorie: "Mechanik", arbeitswerte: 10.0 },
                { name: "Traggelenk wechseln", kategorie: "Mechanik", arbeitswerte: 6.0 },
                { name: "Querlenker wechseln", kategorie: "Mechanik", arbeitswerte: 8.0 },
                { name: "Spurstangenkopf wechseln", kategorie: "Mechanik", arbeitswerte: 4.0 },
                { name: "Stabilisator wechseln", kategorie: "Mechanik", arbeitswerte: 4.0 },
                { name: "Koppelstange wechseln", kategorie: "Mechanik", arbeitswerte: 2.0 },
                { name: "Achsvermessung", kategorie: "Mechanik", arbeitswerte: 6.0 },
                { name: "Spureinstellung", kategorie: "Mechanik", arbeitswerte: 4.0 },

                // ================================================
                // MECHANIK - BREMSEN
                // ================================================
                { name: "BremsbelÃ¤ge vorne wechseln", kategorie: "Mechanik", arbeitswerte: 4.0 },
                { name: "BremsbelÃ¤ge hinten wechseln", kategorie: "Mechanik", arbeitswerte: 4.0 },
                { name: "Bremsscheiben vorne wechseln", kategorie: "Mechanik", arbeitswerte: 6.0 },
                { name: "Bremsscheiben hinten wechseln", kategorie: "Mechanik", arbeitswerte: 5.0 },
                { name: "Bremssattel wechseln", kategorie: "Mechanik", arbeitswerte: 5.0 },
                { name: "Bremsleitung erneuern", kategorie: "Mechanik", arbeitswerte: 6.0 },
                { name: "BremsflÃ¼ssigkeit wechseln", kategorie: "Mechanik", arbeitswerte: 3.0 },
                { name: "Handbremse einstellen", kategorie: "Mechanik", arbeitswerte: 2.0 },

                // ================================================
                // MECHANIK - BELEUCHTUNG
                // ================================================
                { name: "Scheinwerfer einstellen", kategorie: "Mechanik", arbeitswerte: 2.0 },
                { name: "Scheinwerfer-Leuchtmittel wechseln", kategorie: "Mechanik", arbeitswerte: 1.0 },
                { name: "Xenon-Brenner wechseln", kategorie: "Mechanik", arbeitswerte: 2.0 },
                { name: "LED-Scheinwerfer-Modul wechseln", kategorie: "Mechanik", arbeitswerte: 4.0 },
                { name: "RÃ¼ckleuchte Leuchtmittel wechseln", kategorie: "Mechanik", arbeitswerte: 0.5 },
                { name: "Kennzeichenbeleuchtung wechseln", kategorie: "Mechanik", arbeitswerte: 0.5 },

                // ================================================
                // MECHANIK - KÃœHLUNG/KLIMA
                // ================================================
                { name: "KÃ¼hler wechseln", kategorie: "Mechanik", arbeitswerte: 10.0 },
                { name: "KÃ¼hlerschlauch wechseln", kategorie: "Mechanik", arbeitswerte: 3.0 },
                { name: "Thermostat wechseln", kategorie: "Mechanik", arbeitswerte: 4.0 },
                { name: "Klimakondensator wechseln", kategorie: "Mechanik", arbeitswerte: 12.0 },
                { name: "Klimaservice (BefÃ¼llung)", kategorie: "Mechanik", arbeitswerte: 3.0 },
                { name: "Klimaleitung wechseln", kategorie: "Mechanik", arbeitswerte: 6.0 },

                // ================================================
                // SONSTIGES - REINIGUNG
                // ================================================
                { name: "Fahrzeug waschen", kategorie: "Sonstiges", arbeitswerte: 2.0 },
                { name: "Fahrzeug waschen & trocknen", kategorie: "Sonstiges", arbeitswerte: 3.0 },
                { name: "Fahrzeug waschen & aufbereiten", kategorie: "Sonstiges", arbeitswerte: 4.0 },
                { name: "Innenreinigung Standard", kategorie: "Sonstiges", arbeitswerte: 4.0 },
                { name: "Innenreinigung intensiv", kategorie: "Sonstiges", arbeitswerte: 8.0 },
                { name: "Lederreinigung & Pflege", kategorie: "Sonstiges", arbeitswerte: 6.0 },
                { name: "MotorwÃ¤sche", kategorie: "Sonstiges", arbeitswerte: 4.0 },
                { name: "Felgenreinigung (4 StÃ¼ck)", kategorie: "Sonstiges", arbeitswerte: 2.0 },

                // ================================================
                // SONSTIGES - POLIEREN
                // ================================================
                { name: "Polieren 1-Stufen (Fahrzeug komplett)", kategorie: "Sonstiges", arbeitswerte: 16.0 },
                { name: "Polieren 2-Stufen (Fahrzeug komplett)", kategorie: "Sonstiges", arbeitswerte: 24.0 },
                { name: "Polieren 3-Stufen (Fahrzeug komplett)", kategorie: "Sonstiges", arbeitswerte: 32.0 },
                { name: "Polieren Einzelteil", kategorie: "Sonstiges", arbeitswerte: 4.0 },
                { name: "Scheinwerfer polieren (Paar)", kategorie: "Sonstiges", arbeitswerte: 4.0 },
                { name: "Versiegelung auftragen", kategorie: "Sonstiges", arbeitswerte: 6.0 },
                { name: "Keramikversiegelung", kategorie: "Sonstiges", arbeitswerte: 16.0 },

                // ================================================
                // SONSTIGES - DIVERSES
                // ================================================
                { name: "Fahrzeug auf HebebÃ¼hne", kategorie: "Sonstiges", arbeitswerte: 1.0 },
                { name: "Fahrzeug abkleben fÃ¼r Lackierung", kategorie: "Sonstiges", arbeitswerte: 8.0 },
                { name: "Fahrzeug komplett abkleben", kategorie: "Sonstiges", arbeitswerte: 12.0 },
                { name: "Folie entfernen (pro Teil)", kategorie: "Sonstiges", arbeitswerte: 4.0 },
                { name: "Aufkleber/Beschriftung entfernen", kategorie: "Sonstiges", arbeitswerte: 3.0 },
                { name: "Steinschlagschutzfolie montieren", kategorie: "Sonstiges", arbeitswerte: 8.0 },
                { name: "Probefahrt & Endkontrolle", kategorie: "Sonstiges", arbeitswerte: 2.0 },
                { name: "Dokumentation & Fotodokumentation", kategorie: "Sonstiges", arbeitswerte: 2.0 },
                { name: "Vor- und Nachbereitung Werkzeuge", kategorie: "Sonstiges", arbeitswerte: 6.0 },
            ];

            try {
                const batch = window.db.batch();
                const collectionRef = window.getCollection('kalkulation_katalog');

                SEED_DATA.forEach(item => {
                    const docRef = collectionRef.doc();
                    batch.set(docRef, {
                        ...item,
                        createdAt: new Date().toISOString()
                    });
                });

                await batch.commit();
                showToast(`${SEED_DATA.length} Positionen geladen`, 'success');
                await loadKatalog();

            } catch (error) {
                console.error('âŒ Fehler beim Laden des Standard-Katalogs:', error);
                showToast('Fehler beim Laden', 'error');
            }
        }

        // ============================================
        // MATERIAL-KATALOG (TAB 4)
        // ============================================

        async function loadMaterial() {
            try {
                const snapshot = await window.getCollection('kalkulation_material')
                    .orderBy('kategorie')
                    .orderBy('name')
                    .get();

                materialData = [];
                snapshot.forEach(doc => {
                    materialData.push({ id: doc.id, ...doc.data() });
                });

                renderMaterialKatalog();
                console.log(`âœ… ${materialData.length} Material-EintrÃ¤ge geladen`);
            } catch (error) {
                console.warn('âš ï¸ Material nicht gefunden:', error);
            }
        }

        function renderMaterialKatalog() {
            const container = document.getElementById('materialKatalogListe');

            if (materialData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i data-feather="package"></i>
                        <h3>Material-Katalog leer</h3>
                        <p>Erstellen Sie Ihren ersten Material-Eintrag</p>
                        <button class="btn btn-primary" onclick="seedMaterial()">
                            <i data-feather="download"></i>
                            Standard-Material laden
                        </button>
                    </div>
                `;
                feather.replace();
                return;
            }

            // Group by category
            const grouped = {};
            materialData.forEach(item => {
                const kat = item.kategorie || 'Sonstiges';
                if (!grouped[kat]) grouped[kat] = [];
                grouped[kat].push(item);
            });

            let html = '';
            Object.keys(grouped).sort().forEach(kategorie => {
                const items = grouped[kategorie];
                html += `
                    <div class="category-group">
                        <div class="category-header">
                            <h3>${kategorie}</h3>
                            <span class="count">${items.length}</span>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Bezeichnung</th>
                                    <th>EK</th>
                                    <th>VK</th>
                                    <th>Marge</th>
                                    <th>Einheit</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${items.map(item => {
                                    const marge = item.einkaufspreis > 0
                                        ? Math.round(((item.verkaufspreis - item.einkaufspreis) / item.einkaufspreis) * 100)
                                        : '-';
                                    return `
                                        <tr>
                                            <td>${item.name}</td>
                                            <td>${item.einkaufspreis ? item.einkaufspreis.toFixed(2) + ' â‚¬' : '-'}</td>
                                            <td>${item.verkaufspreis.toFixed(2)} â‚¬</td>
                                            <td>${marge}%</td>
                                            <td>${item.einheit || 'StÃ¼ck'}</td>
                                            <td class="actions">
                                                <button class="btn btn-icon btn-secondary" onclick="editMaterialPosition('${item.id}')" title="Bearbeiten">
                                                    <i data-feather="edit-2"></i>
                                                </button>
                                                <button class="btn btn-icon btn-secondary" onclick="deleteMaterialPosition('${item.id}')" title="LÃ¶schen" style="color: var(--color-error);">
                                                    <i data-feather="trash-2"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            });

            container.innerHTML = html;
            feather.replace();
        }

        function openMaterialKatalogModal(positionId = null) {
            document.getElementById('materialModalTitle').textContent = positionId ? 'Material bearbeiten' : 'Neues Material';
            document.getElementById('materialPositionId').value = positionId || '';
            document.getElementById('materialForm').reset();

            if (positionId) {
                const item = materialData.find(p => p.id === positionId);
                if (item) {
                    document.getElementById('materialName').value = item.name || '';
                    document.getElementById('materialKategorie').value = item.kategorie || '';
                    document.getElementById('materialEK').value = item.einkaufspreis || '';
                    document.getElementById('materialVK').value = item.verkaufspreis || '';
                    document.getElementById('materialEinheit').value = item.einheit || 'StÃ¼ck';
                }
            }

            document.getElementById('materialKatalogModal').classList.add('active');
            feather.replace();
        }

        function editMaterialPosition(positionId) {
            openMaterialKatalogModal(positionId);
        }

        async function saveMaterialPosition(event) {
            event.preventDefault();

            const positionId = document.getElementById('materialPositionId').value;
            const data = {
                name: document.getElementById('materialName').value.trim(),
                kategorie: document.getElementById('materialKategorie').value,
                einkaufspreis: parseFloat(document.getElementById('materialEK').value) || 0,
                verkaufspreis: parseFloat(document.getElementById('materialVK').value) || 0,
                einheit: document.getElementById('materialEinheit').value,
                updatedAt: new Date().toISOString()
            };

            try {
                if (positionId) {
                    await window.getCollection('kalkulation_material').doc(positionId).update(data);
                    showToast('Material aktualisiert', 'success');
                } else {
                    data.createdAt = new Date().toISOString();
                    await window.getCollection('kalkulation_material').add(data);
                    showToast('Material erstellt', 'success');
                }

                closeModal('materialKatalogModal');
                await loadMaterial();

            } catch (error) {
                console.error('âŒ Fehler:', error);
                showToast('Fehler beim Speichern', 'error');
            }
        }

        async function deleteMaterialPosition(positionId) {
            if (!confirm('Material wirklich lÃ¶schen?')) return;

            try {
                await window.getCollection('kalkulation_material').doc(positionId).delete();
                showToast('Material gelÃ¶scht', 'success');
                await loadMaterial();
            } catch (error) {
                console.error('âŒ Fehler:', error);
                showToast('Fehler beim LÃ¶schen', 'error');
            }
        }

        async function seedMaterial() {
            // ============================================
            // ðŸŽ¨ UMFANGREICHER MATERIAL-KATALOG
            // Basierend auf Marktpreisen 2024 (Standox, Spies Hecker, Glasurit, Mipa)
            // EK = Einkaufspreis (HÃ¤ndlerpreis), VK = Verkaufspreis (Endkundenpreis)
            // Quellen: lackcolor.de, autolack-burmeister.shop, carross.eu
            // ============================================
            const SEED_DATA = [
                // ================================================
                // LACKMATERIAL - GRUNDIERUNG / PRIMER
                // ================================================
                { name: "Haftgrund 1K (1L)", kategorie: "Lackmaterial", einkaufspreis: 18.00, verkaufspreis: 35.00, einheit: "Liter" },
                { name: "FÃ¼llgrund 2K (1L)", kategorie: "Lackmaterial", einkaufspreis: 28.00, verkaufspreis: 52.00, einheit: "Liter" },
                { name: "Wash-Primer (1L)", kategorie: "Lackmaterial", einkaufspreis: 22.00, verkaufspreis: 42.00, einheit: "Liter" },
                { name: "Kunststoff-Primer (1L)", kategorie: "Lackmaterial", einkaufspreis: 32.00, verkaufspreis: 58.00, einheit: "Liter" },
                { name: "Aluminium-Primer (1L)", kategorie: "Lackmaterial", einkaufspreis: 35.00, verkaufspreis: 65.00, einheit: "Liter" },
                { name: "Zinkstaubgrund (1L)", kategorie: "Lackmaterial", einkaufspreis: 28.00, verkaufspreis: 52.00, einheit: "Liter" },
                { name: "Epoxy-Grundierung 2K (1L)", kategorie: "Lackmaterial", einkaufspreis: 38.00, verkaufspreis: 72.00, einheit: "Liter" },
                { name: "Grundierung grau RAL 7035 (1L)", kategorie: "Lackmaterial", einkaufspreis: 22.00, verkaufspreis: 42.00, einheit: "Liter" },

                // ================================================
                // LACKMATERIAL - FÃœLLER
                // ================================================
                { name: "2K-HS-FÃ¼ller grau (1L)", kategorie: "Lackmaterial", einkaufspreis: 25.00, verkaufspreis: 48.00, einheit: "Liter" },
                { name: "2K-HS-FÃ¼ller weiÃŸ (1L)", kategorie: "Lackmaterial", einkaufspreis: 26.00, verkaufspreis: 50.00, einheit: "Liter" },
                { name: "2K-HS-FÃ¼ller schwarz (1L)", kategorie: "Lackmaterial", einkaufspreis: 26.00, verkaufspreis: 50.00, einheit: "Liter" },
                { name: "Nass-in-Nass FÃ¼ller (1L)", kategorie: "Lackmaterial", einkaufspreis: 32.00, verkaufspreis: 58.00, einheit: "Liter" },
                { name: "ExpressfÃ¼ller (1L)", kategorie: "Lackmaterial", einkaufspreis: 35.00, verkaufspreis: 65.00, einheit: "Liter" },
                { name: "UV-FÃ¼ller (200ml)", kategorie: "Lackmaterial", einkaufspreis: 42.00, verkaufspreis: 78.00, einheit: "StÃ¼ck" },
                { name: "SpritzfÃ¼ller grau Spraydose (400ml)", kategorie: "Lackmaterial", einkaufspreis: 8.50, verkaufspreis: 16.00, einheit: "StÃ¼ck" },

                // ================================================
                // LACKMATERIAL - BASISLACK
                // ================================================
                { name: "Basislack Uni nach Farbcode (1L)", kategorie: "Lackmaterial", einkaufspreis: 45.00, verkaufspreis: 89.00, einheit: "Liter" },
                { name: "Basislack Metallic nach Farbcode (1L)", kategorie: "Lackmaterial", einkaufspreis: 55.00, verkaufspreis: 105.00, einheit: "Liter" },
                { name: "Basislack Perleffekt nach Farbcode (1L)", kategorie: "Lackmaterial", einkaufspreis: 65.00, verkaufspreis: 125.00, einheit: "Liter" },
                { name: "Basislack Sonderfarbe (1L)", kategorie: "Lackmaterial", einkaufspreis: 85.00, verkaufspreis: 165.00, einheit: "Liter" },
                { name: "Basislack Schwarz uni (1L)", kategorie: "Lackmaterial", einkaufspreis: 38.00, verkaufspreis: 72.00, einheit: "Liter" },
                { name: "Basislack WeiÃŸ uni (1L)", kategorie: "Lackmaterial", einkaufspreis: 38.00, verkaufspreis: 72.00, einheit: "Liter" },
                { name: "Basislack Silber metallic (1L)", kategorie: "Lackmaterial", einkaufspreis: 48.00, verkaufspreis: 92.00, einheit: "Liter" },
                { name: "Mittellack Perllack 3-Schicht (1L)", kategorie: "Lackmaterial", einkaufspreis: 75.00, verkaufspreis: 145.00, einheit: "Liter" },
                { name: "Basislack-VerdÃ¼nnung (1L)", kategorie: "Lackmaterial", einkaufspreis: 12.00, verkaufspreis: 24.00, einheit: "Liter" },

                // ================================================
                // LACKMATERIAL - KLARLACK (Standox/Spies Hecker Niveau)
                // ================================================
                { name: "2K-HS-Klarlack Standard (1L)", kategorie: "Lackmaterial", einkaufspreis: 35.00, verkaufspreis: 68.00, einheit: "Liter" },
                { name: "2K-HS-Klarlack Premium (1L)", kategorie: "Lackmaterial", einkaufspreis: 48.00, verkaufspreis: 92.00, einheit: "Liter" },
                { name: "2K-MS-Klarlack (1L)", kategorie: "Lackmaterial", einkaufspreis: 32.00, verkaufspreis: 62.00, einheit: "Liter" },
                { name: "Klarlack matt 2K (1L)", kategorie: "Lackmaterial", einkaufspreis: 52.00, verkaufspreis: 98.00, einheit: "Liter" },
                { name: "Klarlack seidenmatt 2K (1L)", kategorie: "Lackmaterial", einkaufspreis: 48.00, verkaufspreis: 92.00, einheit: "Liter" },
                { name: "Schnellklarlack Express (1L)", kategorie: "Lackmaterial", einkaufspreis: 42.00, verkaufspreis: 82.00, einheit: "Liter" },
                { name: "Scratch-Resistant Klarlack (1L)", kategorie: "Lackmaterial", einkaufspreis: 58.00, verkaufspreis: 112.00, einheit: "Liter" },
                { name: "UV-Klarlack (200ml)", kategorie: "Lackmaterial", einkaufspreis: 48.00, verkaufspreis: 92.00, einheit: "StÃ¼ck" },
                { name: "Klarlack Spraydose (400ml)", kategorie: "Lackmaterial", einkaufspreis: 9.50, verkaufspreis: 18.00, einheit: "StÃ¼ck" },

                // ================================================
                // LACKMATERIAL - HÃ„RTER
                // ================================================
                { name: "HÃ¤rter Standard (0.5L)", kategorie: "Lackmaterial", einkaufspreis: 15.00, verkaufspreis: 28.00, einheit: "Liter" },
                { name: "HÃ¤rter Standard (1L)", kategorie: "Lackmaterial", einkaufspreis: 28.00, verkaufspreis: 52.00, einheit: "Liter" },
                { name: "HÃ¤rter schnell (0.5L)", kategorie: "Lackmaterial", einkaufspreis: 18.00, verkaufspreis: 34.00, einheit: "Liter" },
                { name: "HÃ¤rter schnell (1L)", kategorie: "Lackmaterial", einkaufspreis: 32.00, verkaufspreis: 62.00, einheit: "Liter" },
                { name: "HÃ¤rter langsam (0.5L)", kategorie: "Lackmaterial", einkaufspreis: 18.00, verkaufspreis: 34.00, einheit: "Liter" },
                { name: "HÃ¤rter langsam (1L)", kategorie: "Lackmaterial", einkaufspreis: 32.00, verkaufspreis: 62.00, einheit: "Liter" },
                { name: "FÃ¼ller-HÃ¤rter (0.5L)", kategorie: "Lackmaterial", einkaufspreis: 14.00, verkaufspreis: 26.00, einheit: "Liter" },
                { name: "Epoxy-HÃ¤rter (0.5L)", kategorie: "Lackmaterial", einkaufspreis: 22.00, verkaufspreis: 42.00, einheit: "Liter" },

                // ================================================
                // LACKMATERIAL - VERDÃœNNUNG
                // ================================================
                { name: "AcrylverdÃ¼nnung normal (1L)", kategorie: "Lackmaterial", einkaufspreis: 10.00, verkaufspreis: 19.00, einheit: "Liter" },
                { name: "AcrylverdÃ¼nnung normal (5L)", kategorie: "Lackmaterial", einkaufspreis: 42.00, verkaufspreis: 78.00, einheit: "StÃ¼ck" },
                { name: "AcrylverdÃ¼nnung schnell (1L)", kategorie: "Lackmaterial", einkaufspreis: 12.00, verkaufspreis: 22.00, einheit: "Liter" },
                { name: "AcrylverdÃ¼nnung langsam (1L)", kategorie: "Lackmaterial", einkaufspreis: 12.00, verkaufspreis: 22.00, einheit: "Liter" },
                { name: "NitroverdÃ¼nnung (1L)", kategorie: "Lackmaterial", einkaufspreis: 6.00, verkaufspreis: 12.00, einheit: "Liter" },
                { name: "NitroverdÃ¼nnung (5L)", kategorie: "Lackmaterial", einkaufspreis: 22.00, verkaufspreis: 42.00, einheit: "StÃ¼ck" },
                { name: "UniversalverdÃ¼nnung (1L)", kategorie: "Lackmaterial", einkaufspreis: 8.00, verkaufspreis: 15.00, einheit: "Liter" },

                // ================================================
                // LACKMATERIAL - ADDITIVE
                // ================================================
                { name: "Antikraterzusatz (250ml)", kategorie: "Lackmaterial", einkaufspreis: 12.00, verkaufspreis: 22.00, einheit: "StÃ¼ck" },
                { name: "Silikonentferner (1L)", kategorie: "Lackmaterial", einkaufspreis: 8.00, verkaufspreis: 15.00, einheit: "Liter" },
                { name: "Silikonentferner (5L)", kategorie: "Lackmaterial", einkaufspreis: 32.00, verkaufspreis: 58.00, einheit: "StÃ¼ck" },
                { name: "Antistatikmittel (500ml)", kategorie: "Lackmaterial", einkaufspreis: 15.00, verkaufspreis: 28.00, einheit: "StÃ¼ck" },
                { name: "Verlaufsmittel (250ml)", kategorie: "Lackmaterial", einkaufspreis: 18.00, verkaufspreis: 34.00, einheit: "StÃ¼ck" },
                { name: "Trocknungsbeschleuniger (250ml)", kategorie: "Lackmaterial", einkaufspreis: 22.00, verkaufspreis: 42.00, einheit: "StÃ¼ck" },
                { name: "Elastifizierungsmittel (500ml)", kategorie: "Lackmaterial", einkaufspreis: 25.00, verkaufspreis: 48.00, einheit: "StÃ¼ck" },

                // ================================================
                // SPACHTELMASSE
                // ================================================
                { name: "Universalspachtel (1kg)", kategorie: "Spachtelmasse", einkaufspreis: 8.00, verkaufspreis: 16.00, einheit: "kg" },
                { name: "Universalspachtel (2kg)", kategorie: "Spachtelmasse", einkaufspreis: 14.00, verkaufspreis: 28.00, einheit: "kg" },
                { name: "Feinspachtel (500g)", kategorie: "Spachtelmasse", einkaufspreis: 8.00, verkaufspreis: 15.00, einheit: "StÃ¼ck" },
                { name: "Feinspachtel (1kg)", kategorie: "Spachtelmasse", einkaufspreis: 12.00, verkaufspreis: 24.00, einheit: "kg" },
                { name: "Glasfaserspachtel (500g)", kategorie: "Spachtelmasse", einkaufspreis: 12.00, verkaufspreis: 24.00, einheit: "StÃ¼ck" },
                { name: "Glasfaserspachtel (1kg)", kategorie: "Spachtelmasse", einkaufspreis: 18.00, verkaufspreis: 35.00, einheit: "kg" },
                { name: "Aluminiumspachtel (500g)", kategorie: "Spachtelmasse", einkaufspreis: 15.00, verkaufspreis: 28.00, einheit: "StÃ¼ck" },
                { name: "Kunststoffspachtel (500g)", kategorie: "Spachtelmasse", einkaufspreis: 14.00, verkaufspreis: 26.00, einheit: "StÃ¼ck" },
                { name: "Spritzspachtel (1L)", kategorie: "Spachtelmasse", einkaufspreis: 22.00, verkaufspreis: 42.00, einheit: "Liter" },
                { name: "Nitro-Spritzspachtel (1L)", kategorie: "Spachtelmasse", einkaufspreis: 18.00, verkaufspreis: 35.00, einheit: "Liter" },
                { name: "SpachtelhÃ¤rter (25g Tube)", kategorie: "Spachtelmasse", einkaufspreis: 2.50, verkaufspreis: 5.00, einheit: "StÃ¼ck" },
                { name: "SpachtelhÃ¤rter (100g)", kategorie: "Spachtelmasse", einkaufspreis: 6.00, verkaufspreis: 12.00, einheit: "StÃ¼ck" },

                // ================================================
                // SCHLEIFMATERIAL
                // ================================================
                { name: "Schleifpapier P80 (50 Blatt)", kategorie: "Schleifmaterial", einkaufspreis: 12.00, verkaufspreis: 22.00, einheit: "Set" },
                { name: "Schleifpapier P120 (50 Blatt)", kategorie: "Schleifmaterial", einkaufspreis: 12.00, verkaufspreis: 22.00, einheit: "Set" },
                { name: "Schleifpapier P180 (50 Blatt)", kategorie: "Schleifmaterial", einkaufspreis: 12.00, verkaufspreis: 22.00, einheit: "Set" },
                { name: "Schleifpapier P240 (50 Blatt)", kategorie: "Schleifmaterial", einkaufspreis: 12.00, verkaufspreis: 22.00, einheit: "Set" },
                { name: "Schleifpapier P320 (50 Blatt)", kategorie: "Schleifmaterial", einkaufspreis: 14.00, verkaufspreis: 26.00, einheit: "Set" },
                { name: "Schleifpapier P400 (50 Blatt)", kategorie: "Schleifmaterial", einkaufspreis: 14.00, verkaufspreis: 26.00, einheit: "Set" },
                { name: "Schleifpapier P600 (50 Blatt)", kategorie: "Schleifmaterial", einkaufspreis: 15.00, verkaufspreis: 28.00, einheit: "Set" },
                { name: "Schleifpapier P800 (50 Blatt)", kategorie: "Schleifmaterial", einkaufspreis: 15.00, verkaufspreis: 28.00, einheit: "Set" },
                { name: "Nassschleifpapier P1000 (50 Blatt)", kategorie: "Schleifmaterial", einkaufspreis: 16.00, verkaufspreis: 30.00, einheit: "Set" },
                { name: "Nassschleifpapier P1200 (50 Blatt)", kategorie: "Schleifmaterial", einkaufspreis: 16.00, verkaufspreis: 30.00, einheit: "Set" },
                { name: "Nassschleifpapier P1500 (50 Blatt)", kategorie: "Schleifmaterial", einkaufspreis: 18.00, verkaufspreis: 34.00, einheit: "Set" },
                { name: "Nassschleifpapier P2000 (50 Blatt)", kategorie: "Schleifmaterial", einkaufspreis: 18.00, verkaufspreis: 34.00, einheit: "Set" },
                { name: "Schleifscheiben P80 (50 Stk)", kategorie: "Schleifmaterial", einkaufspreis: 22.00, verkaufspreis: 42.00, einheit: "Set" },
                { name: "Schleifscheiben P180 (50 Stk)", kategorie: "Schleifmaterial", einkaufspreis: 22.00, verkaufspreis: 42.00, einheit: "Set" },
                { name: "Schleifscheiben P320 (50 Stk)", kategorie: "Schleifmaterial", einkaufspreis: 24.00, verkaufspreis: 45.00, einheit: "Set" },
                { name: "Schleifscheiben P500 (50 Stk)", kategorie: "Schleifmaterial", einkaufspreis: 26.00, verkaufspreis: 48.00, einheit: "Set" },
                { name: "Schleifvlies grau (fein)", kategorie: "Schleifmaterial", einkaufspreis: 2.50, verkaufspreis: 5.00, einheit: "StÃ¼ck" },
                { name: "Schleifvlies rot (mittel)", kategorie: "Schleifmaterial", einkaufspreis: 2.50, verkaufspreis: 5.00, einheit: "StÃ¼ck" },
                { name: "Schleifvlies grÃ¼n (grob)", kategorie: "Schleifmaterial", einkaufspreis: 2.50, verkaufspreis: 5.00, einheit: "StÃ¼ck" },
                { name: "Schleifschwamm fein", kategorie: "Schleifmaterial", einkaufspreis: 4.00, verkaufspreis: 8.00, einheit: "StÃ¼ck" },
                { name: "Schleifschwamm mittel", kategorie: "Schleifmaterial", einkaufspreis: 4.00, verkaufspreis: 8.00, einheit: "StÃ¼ck" },
                { name: "Schleifblock Hand", kategorie: "Schleifmaterial", einkaufspreis: 5.00, verkaufspreis: 10.00, einheit: "StÃ¼ck" },

                // ================================================
                // ABDECKMATERIAL
                // ================================================
                { name: "Abdeckpapier 60cm x 300m", kategorie: "Abdeckmaterial", einkaufspreis: 18.00, verkaufspreis: 35.00, einheit: "Rolle" },
                { name: "Abdeckpapier 90cm x 300m", kategorie: "Abdeckmaterial", einkaufspreis: 25.00, verkaufspreis: 48.00, einheit: "Rolle" },
                { name: "Abdeckpapier 120cm x 300m", kategorie: "Abdeckmaterial", einkaufspreis: 32.00, verkaufspreis: 58.00, einheit: "Rolle" },
                { name: "Abdeckfolie 4m x 150m", kategorie: "Abdeckmaterial", einkaufspreis: 15.00, verkaufspreis: 28.00, einheit: "Rolle" },
                { name: "Abdeckfolie 5m x 150m", kategorie: "Abdeckmaterial", einkaufspreis: 18.00, verkaufspreis: 35.00, einheit: "Rolle" },
                { name: "Abklebeband 18mm x 50m", kategorie: "Abdeckmaterial", einkaufspreis: 2.80, verkaufspreis: 5.50, einheit: "StÃ¼ck" },
                { name: "Abklebeband 24mm x 50m", kategorie: "Abdeckmaterial", einkaufspreis: 3.20, verkaufspreis: 6.00, einheit: "StÃ¼ck" },
                { name: "Abklebeband 36mm x 50m", kategorie: "Abdeckmaterial", einkaufspreis: 4.00, verkaufspreis: 8.00, einheit: "StÃ¼ck" },
                { name: "Abklebeband 48mm x 50m", kategorie: "Abdeckmaterial", einkaufspreis: 5.00, verkaufspreis: 10.00, einheit: "StÃ¼ck" },
                { name: "Feinlinienband 3mm x 55m", kategorie: "Abdeckmaterial", einkaufspreis: 4.50, verkaufspreis: 9.00, einheit: "StÃ¼ck" },
                { name: "Feinlinienband 6mm x 55m", kategorie: "Abdeckmaterial", einkaufspreis: 5.00, verkaufspreis: 10.00, einheit: "StÃ¼ck" },
                { name: "Kantenschutzband", kategorie: "Abdeckmaterial", einkaufspreis: 8.00, verkaufspreis: 15.00, einheit: "StÃ¼ck" },
                { name: "Schaumstoffband 13mm", kategorie: "Abdeckmaterial", einkaufspreis: 6.00, verkaufspreis: 12.00, einheit: "StÃ¼ck" },
                { name: "Radabdeckung (4 Stk Set)", kategorie: "Abdeckmaterial", einkaufspreis: 8.00, verkaufspreis: 15.00, einheit: "Set" },
                { name: "Spiegelabdeckung (2 Stk)", kategorie: "Abdeckmaterial", einkaufspreis: 3.00, verkaufspreis: 6.00, einheit: "Set" },
                { name: "TÃ¼rgriffabdeckung (4 Stk)", kategorie: "Abdeckmaterial", einkaufspreis: 4.00, verkaufspreis: 8.00, einheit: "Set" },

                // ================================================
                // POLIERMATERIAL
                // ================================================
                { name: "Polierpaste grob (1kg)", kategorie: "Poliermaterial", einkaufspreis: 25.00, verkaufspreis: 48.00, einheit: "kg" },
                { name: "Polierpaste mittel (1kg)", kategorie: "Poliermaterial", einkaufspreis: 28.00, verkaufspreis: 52.00, einheit: "kg" },
                { name: "Polierpaste fein (1kg)", kategorie: "Poliermaterial", einkaufspreis: 32.00, verkaufspreis: 58.00, einheit: "kg" },
                { name: "Hochglanz-Finish (500ml)", kategorie: "Poliermaterial", einkaufspreis: 22.00, verkaufspreis: 42.00, einheit: "StÃ¼ck" },
                { name: "Schleifpaste (500g)", kategorie: "Poliermaterial", einkaufspreis: 18.00, verkaufspreis: 35.00, einheit: "StÃ¼ck" },
                { name: "Antihologramm-Politur (500ml)", kategorie: "Poliermaterial", einkaufspreis: 28.00, verkaufspreis: 52.00, einheit: "StÃ¼ck" },
                { name: "Polierschwamm grob (2 Stk)", kategorie: "Poliermaterial", einkaufspreis: 8.00, verkaufspreis: 15.00, einheit: "Set" },
                { name: "Polierschwamm mittel (2 Stk)", kategorie: "Poliermaterial", einkaufspreis: 8.00, verkaufspreis: 15.00, einheit: "Set" },
                { name: "Polierschwamm fein (2 Stk)", kategorie: "Poliermaterial", einkaufspreis: 8.00, verkaufspreis: 15.00, einheit: "Set" },
                { name: "Lammfell-Polierpad", kategorie: "Poliermaterial", einkaufspreis: 12.00, verkaufspreis: 22.00, einheit: "StÃ¼ck" },
                { name: "Mikrofasertuch (10 Stk)", kategorie: "Poliermaterial", einkaufspreis: 8.00, verkaufspreis: 15.00, einheit: "Set" },
                { name: "Poliertuch fusselarm (50 Stk)", kategorie: "Poliermaterial", einkaufspreis: 15.00, verkaufspreis: 28.00, einheit: "Set" },

                // ================================================
                // KLEBE- UND DICHTMATERIAL
                // ================================================
                { name: "Karosseriekleber (310ml)", kategorie: "Klebematerial", einkaufspreis: 12.00, verkaufspreis: 22.00, einheit: "StÃ¼ck" },
                { name: "Strukturkleber 2K (50ml)", kategorie: "Klebematerial", einkaufspreis: 18.00, verkaufspreis: 35.00, einheit: "StÃ¼ck" },
                { name: "Scheibenklebstoff (310ml)", kategorie: "Klebematerial", einkaufspreis: 22.00, verkaufspreis: 42.00, einheit: "StÃ¼ck" },
                { name: "Scheibenklebstoff-Set komplett", kategorie: "Klebematerial", einkaufspreis: 45.00, verkaufspreis: 85.00, einheit: "Set" },
                { name: "Kunststoffkleber (20g)", kategorie: "Klebematerial", einkaufspreis: 8.00, verkaufspreis: 15.00, einheit: "StÃ¼ck" },
                { name: "Dichtmasse grau (310ml)", kategorie: "Klebematerial", einkaufspreis: 8.00, verkaufspreis: 15.00, einheit: "StÃ¼ck" },
                { name: "Dichtmasse schwarz (310ml)", kategorie: "Klebematerial", einkaufspreis: 8.00, verkaufspreis: 15.00, einheit: "StÃ¼ck" },
                { name: "Nahtabdichtung Ã¼berlackierbar (310ml)", kategorie: "Klebematerial", einkaufspreis: 12.00, verkaufspreis: 22.00, einheit: "StÃ¼ck" },
                { name: "Hohlraumversiegelung (500ml)", kategorie: "Klebematerial", einkaufspreis: 15.00, verkaufspreis: 28.00, einheit: "StÃ¼ck" },
                { name: "Hohlraumwachs Spraydose (500ml)", kategorie: "Klebematerial", einkaufspreis: 12.00, verkaufspreis: 22.00, einheit: "StÃ¼ck" },
                { name: "Unterbodenschutz (1L)", kategorie: "Klebematerial", einkaufspreis: 12.00, verkaufspreis: 22.00, einheit: "Liter" },
                { name: "Steinschlagschutz (1L)", kategorie: "Klebematerial", einkaufspreis: 15.00, verkaufspreis: 28.00, einheit: "Liter" },
                { name: "DÃ¤mmmatte selbstklebend (1mÂ²)", kategorie: "Klebematerial", einkaufspreis: 18.00, verkaufspreis: 35.00, einheit: "mÂ²" },

                // ================================================
                // REINIGUNGSMATERIAL
                // ================================================
                { name: "Entfetter/Silikonentferner (1L)", kategorie: "Reinigungsmaterial", einkaufspreis: 8.00, verkaufspreis: 15.00, einheit: "Liter" },
                { name: "Entfetter/Silikonentferner (5L)", kategorie: "Reinigungsmaterial", einkaufspreis: 32.00, verkaufspreis: 58.00, einheit: "StÃ¼ck" },
                { name: "Kunststoffreiniger (1L)", kategorie: "Reinigungsmaterial", einkaufspreis: 12.00, verkaufspreis: 22.00, einheit: "Liter" },
                { name: "Bremsenreiniger (500ml)", kategorie: "Reinigungsmaterial", einkaufspreis: 4.00, verkaufspreis: 8.00, einheit: "StÃ¼ck" },
                { name: "Bremsenreiniger (5L)", kategorie: "Reinigungsmaterial", einkaufspreis: 18.00, verkaufspreis: 35.00, einheit: "StÃ¼ck" },
                { name: "Staubbindetuch (10 Stk)", kategorie: "Reinigungsmaterial", einkaufspreis: 5.00, verkaufspreis: 10.00, einheit: "Set" },
                { name: "ReinigungstÃ¼cher Rolle (500 Stk)", kategorie: "Reinigungsmaterial", einkaufspreis: 25.00, verkaufspreis: 48.00, einheit: "Rolle" },
                { name: "Handwaschpaste (500ml)", kategorie: "Reinigungsmaterial", einkaufspreis: 6.00, verkaufspreis: 12.00, einheit: "StÃ¼ck" },
                { name: "Lackknete (100g)", kategorie: "Reinigungsmaterial", einkaufspreis: 8.00, verkaufspreis: 15.00, einheit: "StÃ¼ck" },
                { name: "Teerentferner (500ml)", kategorie: "Reinigungsmaterial", einkaufspreis: 8.00, verkaufspreis: 15.00, einheit: "StÃ¼ck" },

                // ================================================
                // VERBRAUCHSMATERIAL LACKIERKABINE
                // ================================================
                { name: "Filter Bodengitter (Set)", kategorie: "Verbrauchsmaterial", einkaufspreis: 45.00, verkaufspreis: 85.00, einheit: "Set" },
                { name: "Filter Decke (Set)", kategorie: "Verbrauchsmaterial", einkaufspreis: 65.00, verkaufspreis: 125.00, einheit: "Set" },
                { name: "Einmaloverall GrÃ¶ÃŸe L", kategorie: "Verbrauchsmaterial", einkaufspreis: 4.00, verkaufspreis: 8.00, einheit: "StÃ¼ck" },
                { name: "Einmaloverall GrÃ¶ÃŸe XL", kategorie: "Verbrauchsmaterial", einkaufspreis: 4.00, verkaufspreis: 8.00, einheit: "StÃ¼ck" },
                { name: "Einmalhandschuhe Nitril (100 Stk)", kategorie: "Verbrauchsmaterial", einkaufspreis: 12.00, verkaufspreis: 22.00, einheit: "Box" },
                { name: "Atemschutzmaske A2/P3", kategorie: "Verbrauchsmaterial", einkaufspreis: 35.00, verkaufspreis: 65.00, einheit: "StÃ¼ck" },
                { name: "Atemschutzfilter A2/P3 (2 Stk)", kategorie: "Verbrauchsmaterial", einkaufspreis: 22.00, verkaufspreis: 42.00, einheit: "Set" },
                { name: "Staubmaske FFP2 (20 Stk)", kategorie: "Verbrauchsmaterial", einkaufspreis: 15.00, verkaufspreis: 28.00, einheit: "Box" },
                { name: "RÃ¼hrstab Holz (100 Stk)", kategorie: "Verbrauchsmaterial", einkaufspreis: 8.00, verkaufspreis: 15.00, einheit: "Set" },
                { name: "Mischbecher (50 Stk)", kategorie: "Verbrauchsmaterial", einkaufspreis: 12.00, verkaufspreis: 22.00, einheit: "Set" },
                { name: "Siebe fÃ¼r Lack (100 Stk)", kategorie: "Verbrauchsmaterial", einkaufspreis: 18.00, verkaufspreis: 35.00, einheit: "Set" },
                { name: "Pistolenreiniger (1L)", kategorie: "Verbrauchsmaterial", einkaufspreis: 15.00, verkaufspreis: 28.00, einheit: "Liter" },

                // ================================================
                // ERSATZTEILE (HÃ„UFIG BENÃ–TIGT)
                // ================================================
                { name: "StoÃŸfÃ¤ngerhalter vorne (Set)", kategorie: "Ersatzteile", einkaufspreis: 25.00, verkaufspreis: 48.00, einheit: "Set" },
                { name: "StoÃŸfÃ¤ngerhalter hinten (Set)", kategorie: "Ersatzteile", einkaufspreis: 25.00, verkaufspreis: 48.00, einheit: "Set" },
                { name: "Befestigungsclips Universal (50 Stk)", kategorie: "Ersatzteile", einkaufspreis: 12.00, verkaufspreis: 22.00, einheit: "Set" },
                { name: "TÃ¼rdichtung Meter", kategorie: "Ersatzteile", einkaufspreis: 8.00, verkaufspreis: 15.00, einheit: "Meter" },
                { name: "Fensterdichtung Meter", kategorie: "Ersatzteile", einkaufspreis: 12.00, verkaufspreis: 22.00, einheit: "Meter" },
                { name: "Radlaufverbreiterung Clip (10 Stk)", kategorie: "Ersatzteile", einkaufspreis: 8.00, verkaufspreis: 15.00, einheit: "Set" },
                { name: "Zierleistenclips (20 Stk)", kategorie: "Ersatzteile", einkaufspreis: 15.00, verkaufspreis: 28.00, einheit: "Set" },
                { name: "Emblem Befestigung (Set)", kategorie: "Ersatzteile", einkaufspreis: 5.00, verkaufspreis: 10.00, einheit: "Set" },
            ];

            try {
                const batch = window.db.batch();
                const collectionRef = window.getCollection('kalkulation_material');

                SEED_DATA.forEach(item => {
                    const docRef = collectionRef.doc();
                    batch.set(docRef, {
                        ...item,
                        createdAt: new Date().toISOString()
                    });
                });

                await batch.commit();
                showToast(`${SEED_DATA.length} Materialien geladen`, 'success');
                await loadMaterial();

            } catch (error) {
                console.error('âŒ Fehler beim Laden des Standard-Materials:', error);
                showToast('Fehler beim Laden', 'error');
            }
        }

        function filterMaterial() {
            // TODO: Implement filtering
        }

        // ============================================
        // FAHRZEUGE LADEN (TAB 1)
        // ============================================

        async function loadFahrzeuge() {
            try {
                const snapshot = await window.getCollection('fahrzeuge')
                    .where('status', 'in', ['offen', 'in_arbeit', 'warte_teile', 'terminiert'])
                    .orderBy('annahmedatum', 'desc')
                    .limit(50)
                    .get();

                const select = document.getElementById('fahrzeugSelect');
                select.innerHTML = '<option value="">-- Fahrzeug wÃ¤hlen --</option>';

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = `${data.kennzeichen || 'Ohne Kennzeichen'} - ${data.fahrzeugmodell || 'Unbekannt'} - ${data.kundenname || 'Ohne Kunde'}`;
                    select.appendChild(option);
                });

                // Add change handler
                select.addEventListener('change', (e) => {
                    if (e.target.value) {
                        const fahrzeug = snapshot.docs.find(d => d.id === e.target.value);
                        if (fahrzeug) {
                            aktuelleKalkulation.fahrzeugId = fahrzeug.id;
                            aktuelleKalkulation.kennzeichen = fahrzeug.data().kennzeichen || '';
                            aktuelleKalkulation.kundenName = fahrzeug.data().kundenname || '';
                            document.getElementById('kalkulationContent').style.display = 'block';
                            document.getElementById('freieKalkulationStart').style.display = 'none';
                        }
                    } else {
                        document.getElementById('kalkulationContent').style.display = 'none';
                        document.getElementById('freieKalkulationStart').style.display = 'block';
                    }
                });

                console.log(`âœ… ${snapshot.size} Fahrzeuge geladen`);

            } catch (error) {
                console.warn('âš ï¸ Fahrzeuge konnten nicht geladen werden:', error);
            }
        }

        function startFreieKalkulation() {
            aktuelleKalkulation.fahrzeugId = null;
            aktuelleKalkulation.kennzeichen = 'Freie Kalkulation';
            aktuelleKalkulation.kundenName = '';
            document.getElementById('kalkulationContent').style.display = 'block';
            document.getElementById('freieKalkulationStart').style.display = 'none';
            document.getElementById('fahrzeugSelect').value = '';
        }

        // ============================================
        // KALKULATION ERSTELLEN (TAB 1)
        // ============================================

        function openPositionModal() {
            renderPositionAuswahl();
            document.getElementById('positionAuswahlModal').classList.add('active');
            document.getElementById('positionAuswahlSearch').value = '';
            feather.replace();
        }

        function renderPositionAuswahl(searchFilter = '') {
            const container = document.getElementById('positionAuswahlListe');

            let filteredData = katalogData;
            if (searchFilter) {
                filteredData = katalogData.filter(item =>
                    item.name.toLowerCase().includes(searchFilter.toLowerCase()) ||
                    item.kategorie.toLowerCase().includes(searchFilter.toLowerCase())
                );
            }

            if (filteredData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: var(--space-6);">
                        <p>Keine Positionen gefunden</p>
                    </div>
                `;
                return;
            }

            // Group by category
            const grouped = {};
            filteredData.forEach(item => {
                const kat = item.kategorie || 'Sonstiges';
                if (!grouped[kat]) grouped[kat] = [];
                grouped[kat].push(item);
            });

            let html = '';
            Object.keys(grouped).sort().forEach(kategorie => {
                html += `<div class="category-header" style="margin-top: var(--space-4);"><h3>${kategorie}</h3></div>`;
                grouped[kategorie].forEach(item => {
                    const stundensatz = getStundensatzForKategorie(item.kategorie);
                    const preis = (item.arbeitswerte * kalkulationSaetze.awInMinuten / 60) * stundensatz;
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-3); border-bottom: 1px solid var(--color-border); cursor: pointer;"
                             onclick="addPositionToKalkulation('${item.id}')"
                             onmouseover="this.style.background='rgba(var(--color-primary-rgb), 0.1)'"
                             onmouseout="this.style.background='transparent'">
                            <div>
                                <strong>${item.name}</strong>
                                <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">
                                    ${item.arbeitswerte} AW Â· ~${Math.round(item.arbeitswerte * kalkulationSaetze.awInMinuten)} Min
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <strong style="color: var(--color-primary);">${preis.toFixed(2)} â‚¬</strong>
                                <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">
                                    ${stundensatz.toFixed(2)} â‚¬/Std
                                </div>
                            </div>
                        </div>
                    `;
                });
            });

            container.innerHTML = html;
        }

        function filterPositionAuswahl() {
            const search = document.getElementById('positionAuswahlSearch').value;
            renderPositionAuswahl(search);
        }

        function getStundensatzForKategorie(kategorie) {
            switch (kategorie) {
                case 'Lackierung': return kalkulationSaetze.stundensatzLack;
                case 'Karosserie': return kalkulationSaetze.stundensatzKarosserie;
                case 'Mechanik':
                case 'Elektrik': return kalkulationSaetze.stundensatzMechanik;
                default: return kalkulationSaetze.stundensatzSonstige;
            }
        }

        function addPositionToKalkulation(positionId) {
            const position = katalogData.find(p => p.id === positionId);
            if (!position) return;

            const stundensatz = getStundensatzForKategorie(position.kategorie);
            const preis = (position.arbeitswerte * kalkulationSaetze.awInMinuten / 60) * stundensatz;

            aktuelleKalkulation.positionen.push({
                id: Date.now().toString(),
                katalogId: position.id,
                name: position.name,
                kategorie: position.kategorie,
                arbeitswerte: position.arbeitswerte,
                stundensatz: stundensatz,
                preis: preis
            });

            closeModal('positionAuswahlModal');
            renderKalkulationPositionen();
            updateKalkulationSummary();
            showToast(`"${position.name}" hinzugefÃ¼gt`, 'success');
        }

        function removePositionFromKalkulation(positionId) {
            aktuelleKalkulation.positionen = aktuelleKalkulation.positionen.filter(p => p.id !== positionId);
            renderKalkulationPositionen();
            updateKalkulationSummary();
        }

        function renderKalkulationPositionen() {
            const container = document.getElementById('positionenListe');

            if (aktuelleKalkulation.positionen.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i data-feather="clipboard"></i>
                        <h3>Keine Positionen</h3>
                        <p>FÃ¼gen Sie Arbeitspositionen aus dem Katalog hinzu</p>
                    </div>
                `;
                feather.replace();
                return;
            }

            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Position</th>
                            <th>Kategorie</th>
                            <th>AW</th>
                            <th>Stundensatz</th>
                            <th>Preis</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            aktuelleKalkulation.positionen.forEach((pos, index) => {
                html += `
                    <tr>
                        <td><strong>${index + 1}.</strong> ${pos.name}</td>
                        <td>${pos.kategorie}</td>
                        <td>${pos.arbeitswerte} AW</td>
                        <td>${pos.stundensatz.toFixed(2)} â‚¬/Std</td>
                        <td><strong>${pos.preis.toFixed(2)} â‚¬</strong></td>
                        <td>
                            <button class="btn btn-icon btn-secondary" onclick="removePositionFromKalkulation('${pos.id}')" title="Entfernen" style="color: var(--color-error);">
                                <i data-feather="x"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
            feather.replace();
        }

        // ============================================
        // MATERIAL ZUR KALKULATION HINZUFÃœGEN
        // ============================================

        function openMaterialModal() {
            renderMaterialAuswahl();
            document.getElementById('materialAuswahlModal').classList.add('active');
            document.getElementById('materialAuswahlSearch').value = '';
            feather.replace();
        }

        function renderMaterialAuswahl(searchFilter = '') {
            const container = document.getElementById('materialAuswahlListe');

            let filteredData = materialData;
            if (searchFilter) {
                filteredData = materialData.filter(item =>
                    item.name.toLowerCase().includes(searchFilter.toLowerCase()) ||
                    item.kategorie.toLowerCase().includes(searchFilter.toLowerCase())
                );
            }

            if (filteredData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: var(--space-6);">
                        <p>Kein Material gefunden</p>
                    </div>
                `;
                return;
            }

            // Group by category
            const grouped = {};
            filteredData.forEach(item => {
                const kat = item.kategorie || 'Sonstiges';
                if (!grouped[kat]) grouped[kat] = [];
                grouped[kat].push(item);
            });

            let html = '';
            Object.keys(grouped).sort().forEach(kategorie => {
                html += `<div class="category-header" style="margin-top: var(--space-4);"><h3>${kategorie}</h3></div>`;
                grouped[kategorie].forEach(item => {
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-3); border-bottom: 1px solid var(--color-border); cursor: pointer;"
                             onclick="addMaterialToKalkulation('${item.id}')"
                             onmouseover="this.style.background='rgba(var(--color-primary-rgb), 0.1)'"
                             onmouseout="this.style.background='transparent'">
                            <div>
                                <strong>${item.name}</strong>
                                <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">
                                    ${item.einheit || 'StÃ¼ck'}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <strong style="color: var(--color-primary);">${item.verkaufspreis.toFixed(2)} â‚¬</strong>
                            </div>
                        </div>
                    `;
                });
            });

            container.innerHTML = html;
        }

        function filterMaterialAuswahl() {
            const search = document.getElementById('materialAuswahlSearch').value;
            renderMaterialAuswahl(search);
        }

        function addMaterialToKalkulation(materialId) {
            const material = materialData.find(m => m.id === materialId);
            if (!material) return;

            // Check if already exists
            const existing = aktuelleKalkulation.materialien.find(m => m.katalogId === materialId);
            if (existing) {
                existing.menge += 1;
                existing.preis = existing.menge * existing.einzelpreis;
            } else {
                aktuelleKalkulation.materialien.push({
                    id: Date.now().toString(),
                    katalogId: material.id,
                    name: material.name,
                    kategorie: material.kategorie,
                    einheit: material.einheit || 'StÃ¼ck',
                    einzelpreis: material.verkaufspreis,
                    menge: 1,
                    preis: material.verkaufspreis
                });
            }

            closeModal('materialAuswahlModal');
            renderKalkulationMaterial();
            updateKalkulationSummary();
            showToast(`"${material.name}" hinzugefÃ¼gt`, 'success');
        }

        function removeMaterialFromKalkulation(materialId) {
            aktuelleKalkulation.materialien = aktuelleKalkulation.materialien.filter(m => m.id !== materialId);
            renderKalkulationMaterial();
            updateKalkulationSummary();
        }

        function updateMaterialMenge(materialId, newMenge) {
            const material = aktuelleKalkulation.materialien.find(m => m.id === materialId);
            if (material) {
                material.menge = Math.max(1, parseInt(newMenge) || 1);
                material.preis = material.menge * material.einzelpreis;
                updateKalkulationSummary();
            }
        }

        function renderKalkulationMaterial() {
            const container = document.getElementById('materialListe');

            if (aktuelleKalkulation.materialien.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i data-feather="box"></i>
                        <h3>Kein Material</h3>
                        <p>FÃ¼gen Sie Materialien aus dem Katalog hinzu</p>
                    </div>
                `;
                feather.replace();
                return;
            }

            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Material</th>
                            <th>Einzelpreis</th>
                            <th>Menge</th>
                            <th>Preis</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            aktuelleKalkulation.materialien.forEach((mat, index) => {
                html += `
                    <tr>
                        <td><strong>${index + 1}.</strong> ${mat.name}</td>
                        <td>${mat.einzelpreis.toFixed(2)} â‚¬/${mat.einheit}</td>
                        <td>
                            <input type="number" min="1" value="${mat.menge}"
                                   style="width: 60px; padding: var(--space-2); border: 1px solid var(--color-border); border-radius: var(--radius-input);"
                                   onchange="updateMaterialMenge('${mat.id}', this.value)">
                        </td>
                        <td><strong>${mat.preis.toFixed(2)} â‚¬</strong></td>
                        <td>
                            <button class="btn btn-icon btn-secondary" onclick="removeMaterialFromKalkulation('${mat.id}')" title="Entfernen" style="color: var(--color-error);">
                                <i data-feather="x"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
            feather.replace();
        }

        // ============================================
        // KALKULATION BERECHNEN & ANZEIGEN
        // ============================================

        function updateKalkulationSummary() {
            const summeArbeit = aktuelleKalkulation.positionen.reduce((sum, p) => sum + p.preis, 0);
            const summeMaterial = aktuelleKalkulation.materialien.reduce((sum, m) => sum + m.preis, 0);
            const summeNetto = summeArbeit + summeMaterial;
            const mwst = summeNetto * (kalkulationSaetze.mwstSatz / 100);
            const summeBrutto = summeNetto + mwst;

            document.getElementById('summeArbeit').textContent = summeArbeit.toFixed(2) + ' â‚¬';
            document.getElementById('summeMaterial').textContent = summeMaterial.toFixed(2) + ' â‚¬';
            document.getElementById('summeNetto').textContent = summeNetto.toFixed(2) + ' â‚¬';
            document.getElementById('mwstSatzDisplay').textContent = kalkulationSaetze.mwstSatz;
            document.getElementById('summeMwst').textContent = mwst.toFixed(2) + ' â‚¬';
            document.getElementById('summeBrutto').textContent = summeBrutto.toFixed(2) + ' â‚¬';
        }

        // ============================================
        // KALKULATION SPEICHERN
        // ============================================

        async function saveKalkulationEntwurf() {
            if (aktuelleKalkulation.positionen.length === 0 && aktuelleKalkulation.materialien.length === 0) {
                showToast('Keine Positionen oder Material vorhanden', 'error');
                return;
            }

            try {
                const summeArbeit = aktuelleKalkulation.positionen.reduce((sum, p) => sum + p.preis, 0);
                const summeMaterial = aktuelleKalkulation.materialien.reduce((sum, m) => sum + m.preis, 0);
                const summeNetto = summeArbeit + summeMaterial;
                const mwst = summeNetto * (kalkulationSaetze.mwstSatz / 100);
                const summeBrutto = summeNetto + mwst;

                const kalkulationData = {
                    fahrzeugId: aktuelleKalkulation.fahrzeugId,
                    kennzeichen: aktuelleKalkulation.kennzeichen,
                    kundenName: aktuelleKalkulation.kundenName,
                    positionen: aktuelleKalkulation.positionen,
                    materialien: aktuelleKalkulation.materialien,
                    summeArbeit,
                    summeMaterial,
                    summeNetto,
                    mwstSatz: kalkulationSaetze.mwstSatz,
                    mwst,
                    summeBrutto,
                    status: 'entwurf',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                const docRef = await window.getCollection('kalkulationen').add(kalkulationData);
                showToast('Kalkulation gespeichert!', 'success');
                console.log('âœ… Kalkulation gespeichert:', docRef.id);

                // Reset for new calculation
                resetKalkulation();

            } catch (error) {
                console.error('âŒ Fehler beim Speichern:', error);
                showToast('Fehler beim Speichern', 'error');
            }
        }

        function resetKalkulation() {
            aktuelleKalkulation = {
                positionen: [],
                materialien: [],
                fahrzeugId: null,
                kundenName: '',
                kennzeichen: ''
            };
            document.getElementById('fahrzeugSelect').value = '';
            document.getElementById('kalkulationContent').style.display = 'none';
            document.getElementById('freieKalkulationStart').style.display = 'block';
            renderKalkulationPositionen();
            renderKalkulationMaterial();
            updateKalkulationSummary();
        }

        // ============================================
        // PDF EXPORT
        // ============================================

        async function exportKalkulationPDF() {
            if (aktuelleKalkulation.positionen.length === 0 && aktuelleKalkulation.materialien.length === 0) {
                showToast('Keine Positionen oder Material vorhanden', 'error');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                const summeArbeit = aktuelleKalkulation.positionen.reduce((sum, p) => sum + p.preis, 0);
                const summeMaterial = aktuelleKalkulation.materialien.reduce((sum, m) => sum + m.preis, 0);
                const summeNetto = summeArbeit + summeMaterial;
                const mwst = summeNetto * (kalkulationSaetze.mwstSatz / 100);
                const summeBrutto = summeNetto + mwst;

                // Header
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text('KOSTENVORANSCHLAG', 105, 20, { align: 'center' });

                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text(`Datum: ${new Date().toLocaleDateString('de-DE')}`, 20, 35);

                if (aktuelleKalkulation.kennzeichen) {
                    doc.text(`Kennzeichen: ${aktuelleKalkulation.kennzeichen}`, 20, 42);
                }
                if (aktuelleKalkulation.kundenName) {
                    doc.text(`Kunde: ${aktuelleKalkulation.kundenName}`, 20, 49);
                }

                let yPos = 65;

                // Arbeitspositionen
                if (aktuelleKalkulation.positionen.length > 0) {
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('ARBEITSPOSITIONEN', 20, yPos);
                    yPos += 8;

                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Pos.', 20, yPos);
                    doc.text('Bezeichnung', 35, yPos);
                    doc.text('AW', 120, yPos);
                    doc.text('Preis', 145, yPos);
                    yPos += 5;

                    doc.setFont('helvetica', 'normal');
                    aktuelleKalkulation.positionen.forEach((pos, index) => {
                        doc.text(`${index + 1}.`, 20, yPos);
                        doc.text(pos.name.substring(0, 45), 35, yPos);
                        doc.text(`${pos.arbeitswerte}`, 120, yPos);
                        doc.text(`${pos.preis.toFixed(2)} â‚¬`, 145, yPos);
                        yPos += 6;

                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 20;
                        }
                    });

                    doc.setFont('helvetica', 'bold');
                    doc.text(`Summe Arbeit: ${summeArbeit.toFixed(2)} â‚¬`, 145, yPos, { align: 'right' });
                    yPos += 12;
                }

                // Material
                if (aktuelleKalkulation.materialien.length > 0) {
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('MATERIAL', 20, yPos);
                    yPos += 8;

                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Pos.', 20, yPos);
                    doc.text('Bezeichnung', 35, yPos);
                    doc.text('Menge', 110, yPos);
                    doc.text('Preis', 145, yPos);
                    yPos += 5;

                    doc.setFont('helvetica', 'normal');
                    aktuelleKalkulation.materialien.forEach((mat, index) => {
                        doc.text(`${index + 1}.`, 20, yPos);
                        doc.text(mat.name.substring(0, 40), 35, yPos);
                        doc.text(`${mat.menge} ${mat.einheit}`, 110, yPos);
                        doc.text(`${mat.preis.toFixed(2)} â‚¬`, 145, yPos);
                        yPos += 6;

                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 20;
                        }
                    });

                    doc.setFont('helvetica', 'bold');
                    doc.text(`Summe Material: ${summeMaterial.toFixed(2)} â‚¬`, 145, yPos, { align: 'right' });
                    yPos += 15;
                }

                // Zusammenfassung
                doc.setDrawColor(0);
                doc.line(20, yPos - 5, 190, yPos - 5);

                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Nettobetrag:', 120, yPos);
                doc.text(`${summeNetto.toFixed(2)} â‚¬`, 190, yPos, { align: 'right' });
                yPos += 6;

                doc.text(`MwSt. ${kalkulationSaetze.mwstSatz}%:`, 120, yPos);
                doc.text(`${mwst.toFixed(2)} â‚¬`, 190, yPos, { align: 'right' });
                yPos += 8;

                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('GESAMTBETRAG:', 120, yPos);
                doc.text(`${summeBrutto.toFixed(2)} â‚¬`, 190, yPos, { align: 'right' });

                // Footer
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.text('Dieser Kostenvoranschlag ist unverbindlich. PreisÃ¤nderungen vorbehalten.', 105, 285, { align: 'center' });

                // Download
                const filename = `KVA_${aktuelleKalkulation.kennzeichen || 'Frei'}_${new Date().toISOString().slice(0, 10)}.pdf`;
                doc.save(filename);
                showToast('PDF exportiert!', 'success');

            } catch (error) {
                console.error('âŒ Fehler beim PDF-Export:', error);
                showToast('Fehler beim PDF-Export', 'error');
            }
        }

        function sendKalkulationEmail() {
            showToast('Email-Versand wird vorbereitet...', 'info');
            // For now, just export PDF - email integration would require backend
            exportKalkulationPDF();
        }

        // ============================================
        // HISTORIE LADEN
        // ============================================

        async function loadHistorie() {
            try {
                const snapshot = await window.getCollection('kalkulationen')
                    .orderBy('createdAt', 'desc')
                    .limit(50)
                    .get();

                const container = document.getElementById('historieListe');

                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i data-feather="file-text"></i>
                            <h3>Keine Kalkulationen</h3>
                            <p>Ihre erstellten Kalkulationen erscheinen hier</p>
                        </div>
                    `;
                    feather.replace();
                    return;
                }

                let html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Datum</th>
                                <th>Kennzeichen</th>
                                <th>Kunde</th>
                                <th>Positionen</th>
                                <th>Betrag</th>
                                <th>Status</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const datum = new Date(data.createdAt).toLocaleDateString('de-DE');
                    const statusBadge = {
                        'entwurf': '<span style="background: var(--color-warning); color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">Entwurf</span>',
                        'gesendet': '<span style="background: var(--color-primary); color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">Gesendet</span>',
                        'akzeptiert': '<span style="background: var(--color-success); color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">Akzeptiert</span>',
                        'abgelehnt': '<span style="background: var(--color-error); color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">Abgelehnt</span>'
                    };

                    html += `
                        <tr>
                            <td>${datum}</td>
                            <td>${data.kennzeichen || '-'}</td>
                            <td>${data.kundenName || '-'}</td>
                            <td>${(data.positionen?.length || 0) + (data.materialien?.length || 0)}</td>
                            <td><strong>${data.summeBrutto?.toFixed(2) || '0.00'} â‚¬</strong></td>
                            <td>${statusBadge[data.status] || data.status}</td>
                            <td class="actions">
                                <button class="btn btn-icon btn-secondary" onclick="loadKalkulationToEdit('${doc.id}')" title="Bearbeiten">
                                    <i data-feather="edit-2"></i>
                                </button>
                                <button class="btn btn-icon btn-secondary" onclick="deleteKalkulation('${doc.id}')" title="LÃ¶schen" style="color: var(--color-error);">
                                    <i data-feather="trash-2"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
                feather.replace();

            } catch (error) {
                console.error('âŒ Fehler beim Laden der Historie:', error);
            }
        }

        async function deleteKalkulation(kalkulationId) {
            if (!confirm('Kalkulation wirklich lÃ¶schen?')) return;

            try {
                await window.getCollection('kalkulationen').doc(kalkulationId).delete();
                showToast('Kalkulation gelÃ¶scht', 'success');
                await loadHistorie();
            } catch (error) {
                console.error('âŒ Fehler beim LÃ¶schen:', error);
                showToast('Fehler beim LÃ¶schen', 'error');
            }
        }

        async function loadKalkulationToEdit(kalkulationId) {
            try {
                const doc = await window.getCollection('kalkulationen').doc(kalkulationId).get();
                if (!doc.exists) {
                    showToast('Kalkulation nicht gefunden', 'error');
                    return;
                }

                const data = doc.data();
                aktuelleKalkulation = {
                    id: doc.id,
                    positionen: data.positionen || [],
                    materialien: data.materialien || [],
                    fahrzeugId: data.fahrzeugId,
                    kundenName: data.kundenName || '',
                    kennzeichen: data.kennzeichen || ''
                };

                // Switch to Kalkulation tab
                switchTab('kalkulation');
                document.getElementById('kalkulationContent').style.display = 'block';
                document.getElementById('freieKalkulationStart').style.display = 'none';

                renderKalkulationPositionen();
                renderKalkulationMaterial();
                updateKalkulationSummary();
                showToast('Kalkulation geladen', 'success');

            } catch (error) {
                console.error('âŒ Fehler beim Laden:', error);
                showToast('Fehler beim Laden', 'error');
            }
        }

        // ============================================
        // HELPER FUNCTIONS
        // ============================================

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i data-feather="${type === 'success' ? 'check-circle' : type === 'error' ? 'alert-circle' : 'info'}"></i>
                <span>${message}</span>
            `;
            container.appendChild(toast);
            feather.replace();

            setTimeout(() => {
                toast.style.animation = 'toastSlideIn 0.3s var(--ease-out) reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Close modal on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });

        // ESC key to close modals
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay.active').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        });
    </script>
</body>
</html>
