<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>ðŸ§® Kalkulation - Fahrzeugannahme App</title>

    <!-- Aggressive No-Cache Headers -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- ðŸŒ“ FOUC Prevention: Load Theme BEFORE CSS -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            console.log(`ðŸŒ“ Theme pre-loaded in <head>: ${savedTheme} (FOUC Prevention)`);
        })();
    </script>

    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Apple Liquid Glass Design System -->
    <link rel="stylesheet" href="design-system.css?v=af6b90f">
    <link rel="stylesheet" href="components.css?v=af6b90f">
    <link rel="stylesheet" href="animations.css?v=af6b90f">
    <link rel="stylesheet" href="mobile-first.css?v=af6b90f">

    <!-- Light Mode Readability Optimizations -->
    <link rel="stylesheet" href="css/light-mode.css?v=nov9">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="listener-registry.js"></script>
    <script src="js/auth-manager.js"></script>
    <script src="js/utils/escape-html.js"></script>

    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>

    <!-- GSAP Animation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

    <!-- Sketchfab Viewer API -->
    <script src="https://static.sketchfab.com/api/sketchfab-viewer-1.12.1.js"></script>

    <!-- jsPDF fÃ¼r PDF-Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Ersatzteile-Datenbank mit OE-Nummern -->
    <script src="ersatzteile-db.js"></script>

    <style>
        /* ============================================
           ðŸŽ¨ SMOOTH THEME TRANSITIONS
           ============================================ */

        /* Global smooth transitions for theme changes */
        :root {
            transition: background-color var(--duration-base) var(--ease-out),
                        color var(--duration-base) var(--ease-out);
        }

        body,
        .page-container,
        .content-card,
        .tab-navigation,
        .tab-button,
        .back-button,
        .theme-toggle {
            transition: background var(--duration-base) var(--ease-out),
                        background-color var(--duration-base) var(--ease-out),
                        color var(--duration-base) var(--ease-out),
                        border-color var(--duration-base) var(--ease-out),
                        box-shadow var(--duration-base) var(--ease-out),
                        backdrop-filter var(--duration-base) var(--ease-out);
        }

        /* Smooth icon transitions */
        i[data-feather] {
            transition: color var(--duration-base) var(--ease-out),
                        stroke-width var(--duration-base) var(--ease-out),
                        transform var(--duration-base) var(--ease-out);
        }

        /* Smooth text transitions */
        h1, h2, h3, h4, h5, h6, p, span, a, label {
            transition: color var(--duration-base) var(--ease-out);
        }

        /* Screen Reader Only Text (Accessibility) */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* ============================================
           ðŸŽ¨ APPLE LIQUID GLASS - BACKGROUND EFFECTS
           Gradient Mesh, Noise Texture, Floating Orbs
           ============================================ */

        /* Animated Gradient Mesh Background */
        .gradient-mesh {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -2;
            opacity: 0.4;
            pointer-events: none;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(0, 191, 255, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 30%, rgba(138, 43, 226, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 40% 80%, rgba(0, 255, 136, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 90% 90%, rgba(255, 107, 107, 0.08) 0%, transparent 50%);
            animation: mesh-drift 20s ease-in-out infinite;
        }

        [data-theme="light"] .gradient-mesh {
            opacity: 0.25;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(0, 122, 255, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 30%, rgba(88, 86, 214, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 40% 80%, rgba(52, 199, 89, 0.06) 0%, transparent 50%),
                radial-gradient(ellipse at 90% 90%, rgba(255, 149, 0, 0.06) 0%, transparent 50%);
        }

        @keyframes mesh-drift {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(2%, 1%) scale(1.02); }
            50% { transform: translate(-1%, 2%) scale(1); }
            75% { transform: translate(1%, -1%) scale(1.01); }
        }

        /* Noise/Grain Texture Overlay */
        .noise-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -1;  /* Behind everything - was 9998 which blocked modals */
            pointer-events: none;
            opacity: 0.03;
            mix-blend-mode: overlay;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }

        [data-theme="light"] .noise-overlay {
            opacity: 0.02;
            mix-blend-mode: multiply;
        }

        /* Decorative Floating Orbs */
        .floating-orb {
            position: fixed;
            border-radius: 50%;
            pointer-events: none;
            z-index: -1;
            filter: blur(60px);
        }

        .floating-orb--1 {
            width: 300px;
            height: 300px;
            background: rgba(0, 191, 255, 0.15);
            top: 10%;
            right: -5%;
            animation: orb-float-1 25s ease-in-out infinite;
        }

        .floating-orb--2 {
            width: 200px;
            height: 200px;
            background: rgba(138, 43, 226, 0.1);
            bottom: 20%;
            left: -5%;
            animation: orb-float-2 30s ease-in-out infinite;
        }

        .floating-orb--3 {
            width: 150px;
            height: 150px;
            background: rgba(0, 255, 136, 0.08);
            top: 50%;
            right: 10%;
            animation: orb-float-3 20s ease-in-out infinite;
        }

        [data-theme="light"] .floating-orb--1 {
            background: rgba(0, 122, 255, 0.08);
        }

        [data-theme="light"] .floating-orb--2 {
            background: rgba(88, 86, 214, 0.06);
        }

        [data-theme="light"] .floating-orb--3 {
            background: rgba(52, 199, 89, 0.05);
        }

        @keyframes orb-float-1 {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(-30px, 40px) scale(1.1); }
            66% { transform: translate(20px, -30px) scale(0.95); }
        }

        @keyframes orb-float-2 {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(40px, -20px) scale(1.05); }
            66% { transform: translate(-20px, 30px) scale(0.9); }
        }

        @keyframes orb-float-3 {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(-40px, 40px) scale(1.15); }
        }

        /* ============================================
           ðŸŽ¨ ACCENT LIGHT (Pulsating Glow)
           ============================================ */
        .accent-light {
            position: fixed;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, var(--accent-light-color, rgba(0, 191, 255, 0.3)) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
            animation: pulse 8s ease-in-out infinite;
            transform: translate3d(0, 0, 0);
            will-change: transform;
        }

        [data-theme="light"] .accent-light {
            background: radial-gradient(circle, rgba(255, 200, 50, 0.15) 0%, transparent 70%);
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 0.8; }
        }

        /* ============================================
           ðŸŽ¨ PAGE TRANSITION OVERLAY
           ============================================ */
        .page-transition-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: rgba(11, 11, 12, 0.4);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-out;
        }

        .page-transition-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        [data-theme="light"] .page-transition-overlay {
            background: rgba(255, 255, 255, 0.6);
        }

        /* ============================================
           ðŸŽ¨ ENHANCED HERO SECTION
           ============================================ */
        .page-hero {
            text-align: center;
            padding: var(--space-8) 0 var(--space-6);
            margin-bottom: var(--space-6);
        }

        .page-hero__title {
            font-size: clamp(32px, 5vw, 48px);
            font-weight: 800;
            letter-spacing: -0.02em;
            line-height: 1.1;
            margin-bottom: var(--space-3);
            background: linear-gradient(135deg, #fff 0%, #00bfff 50%, #66d9ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        [data-theme="light"] .page-hero__title {
            background: linear-gradient(135deg, #1a1a2e 0%, #0066cc 50%, #0099ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .page-hero__subtitle {
            font-size: var(--font-size-lg);
            color: rgba(255, 255, 255, 0.7);
            font-weight: var(--font-weight-regular);
            max-width: 500px;
            margin: 0 auto var(--space-4);
        }

        [data-theme="light"] .page-hero__subtitle {
            color: rgba(0, 0, 0, 0.6);
        }

        .page-hero__badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-5);
            background: linear-gradient(135deg, rgba(0, 191, 255, 0.15), rgba(138, 43, 226, 0.1));
            border: 1px solid rgba(0, 191, 255, 0.3);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
            color: var(--color-primary);
            animation: badge-glow 3s ease-in-out infinite;
        }

        [data-theme="light"] .page-hero__badge {
            background: linear-gradient(135deg, rgba(0, 102, 204, 0.1), rgba(88, 86, 214, 0.08));
            border-color: rgba(0, 102, 204, 0.3);
        }

        @keyframes badge-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(0, 191, 255, 0.2); }
            50% { box-shadow: 0 0 30px rgba(0, 191, 255, 0.4); }
        }

        /* ============================================
           ðŸŽ¨ ENHANCED GLASS CARDS
           ============================================ */
        .content-card {
            position: relative;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: var(--radius-xl);
            box-shadow:
                inset 0 1px 1px rgba(255, 255, 255, 0.1),
                0 8px 32px rgba(0, 0, 0, 0.25);
            overflow: hidden;
        }

        /* Glass Card Shine Effect */
        .content-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 40%;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.1), transparent);
            pointer-events: none;
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
        }

        /* Glass Card Border Gradient */
        .content-card::after {
            content: '';
            position: absolute;
            inset: -1px;
            border-radius: inherit;
            padding: 1px;
            background: linear-gradient(
                135deg,
                rgba(255, 255, 255, 0.2) 0%,
                transparent 50%,
                rgba(0, 191, 255, 0.1) 100%
            );
            -webkit-mask:
                linear-gradient(#fff 0 0) content-box,
                linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
            z-index: 1;
        }

        [data-theme="light"] .content-card {
            background: rgba(255, 255, 255, 0.7);
            border-color: rgba(0, 0, 0, 0.08);
            box-shadow:
                0 4px 24px rgba(0, 0, 0, 0.08),
                0 1px 2px rgba(0, 0, 0, 0.04);
        }

        [data-theme="light"] .content-card::before {
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0.5), transparent);
        }

        /* Enhanced Tab Navigation */
        .tab-navigation {
            background: rgba(255, 255, 255, 0.06);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.05);
        }

        [data-theme="light"] .tab-navigation {
            background: rgba(255, 255, 255, 0.8);
            border-color: rgba(0, 0, 0, 0.06);
        }

        .tab-button.active {
            background: linear-gradient(135deg, var(--color-primary), #0099cc);
            box-shadow: 0 4px 15px rgba(0, 191, 255, 0.4);
        }

        /* Reduce animations on mobile for performance */
        @media (max-width: 768px) {
            .floating-orb {
                display: none;
            }
            .noise-overlay {
                display: none;
            }
            .gradient-mesh {
                opacity: 0.2;
            }
        }

        /* ============================================
           ðŸŒ“ THEME TOGGLE BUTTON
           Fixed Top-Right Corner - Apple Style
           ============================================ */
        .theme-toggle {
            position: fixed;
            top: var(--space-4);
            right: var(--space-4);
            z-index: 10000;
            width: 56px;
            height: 56px;
            border-radius: var(--radius-full);
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            box-shadow: var(--shadow-lg), inset 0 1px 1px rgba(255,255,255,0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .theme-toggle:hover {
            transform: scale(1.1) rotate(15deg);
            box-shadow: var(--shadow-xl), inset 0 1px 1px rgba(255,255,255,0.2);
        }

        .theme-toggle:active {
            transform: scale(0.95);
        }

        .theme-toggle__icon {
            position: absolute;
            width: 24px;
            height: 24px;
            color: var(--color-text-primary);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        /* Show sun icon in dark mode, moon in light mode */
        [data-theme="dark"] .theme-toggle__icon--light {
            opacity: 1;
            transform: rotate(0deg) scale(1);
        }

        [data-theme="dark"] .theme-toggle__icon--dark {
            opacity: 0;
            transform: rotate(180deg) scale(0);
        }

        :root .theme-toggle__icon--light,
        [data-theme="light"] .theme-toggle__icon--light {
            opacity: 0;
            transform: rotate(-180deg) scale(0);
        }

        :root .theme-toggle__icon--dark,
        [data-theme="light"] .theme-toggle__icon--dark {
            opacity: 1;
            transform: rotate(0deg) scale(1);
        }

        /* Light Mode Theme Toggle styling */
        [data-theme="light"] .theme-toggle {
            background: rgba(255, 255, 255, 0.9);
            border-color: rgba(0, 0, 0, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        }

        /* Mobile: Hide fixed toggle (using mobile-header toggle instead) */
        @media (max-width: 768px) {
            .theme-toggle {
                display: none;
            }
        }

        /* Tablet: Medium-sized toggle button */
        @media (max-width: 1024px) and (min-width: 769px) {
            .theme-toggle {
                width: 52px;
                height: 52px;
            }
        }

        /* ============================================
           ðŸ“± MOBILE HEADER ENHANCEMENTS
           ============================================ */

        /* Mobile Header Theme Toggle Icons */
        .mobile-header__theme-toggle .theme-icon {
            position: absolute;
            width: 20px;
            height: 20px;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        [data-theme="dark"] .mobile-header__theme-toggle .theme-icon--light {
            opacity: 1;
            transform: rotate(0deg) scale(1);
        }

        [data-theme="dark"] .mobile-header__theme-toggle .theme-icon--dark {
            opacity: 0;
            transform: rotate(180deg) scale(0);
        }

        :root .mobile-header__theme-toggle .theme-icon--light,
        [data-theme="light"] .mobile-header__theme-toggle .theme-icon--light {
            opacity: 0;
            transform: rotate(-180deg) scale(0);
        }

        :root .mobile-header__theme-toggle .theme-icon--dark,
        [data-theme="light"] .mobile-header__theme-toggle .theme-icon--dark {
            opacity: 1;
            transform: rotate(0deg) scale(1);
        }

        /* Desktop: Header ausblenden */
        @media (min-width: 769px) {
            .mobile-header {
                display: none !important;
            }
        }

        /* Mobile: Extra padding for mobile header */
        @media (max-width: 768px) {
            .page-container {
                padding-top: calc(var(--space-6) + 60px);
            }
        }

        /* ============================================
           ðŸ§® KALKULATION PAGE SPECIFIC STYLES
           ============================================ */

        body {
            min-height: 100vh;
            background: var(--color-background);
            padding: var(--space-6);
            padding-bottom: calc(80px + var(--space-6));
            font-family: 'SF Pro Display', 'Inter', var(--font-system);
            position: relative;
            overflow-x: hidden;
        }

        .page-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-6);
            position: relative;
            z-index: 1;
        }

        /* Header */
        .page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-8);
            flex-wrap: wrap;
            gap: var(--space-4);
        }

        .page-header-left {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .back-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            background: var(--color-surface);
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-button);
            color: var(--color-text-primary);
            cursor: pointer;
            transition: all var(--duration-base) var(--ease-out);
        }

        .back-button:hover {
            background: var(--color-primary);
            color: white;
            transform: translateX(-2px);
        }

        .page-title {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .page-title h1 {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin: 0;
        }

        .page-title .badge {
            background: var(--color-primary);
            color: white;
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            gap: var(--space-2);
            background: var(--color-surface);
            padding: var(--space-2);
            border-radius: var(--radius-card);
            border: 1px solid var(--color-border-glass);
            margin-bottom: var(--space-6);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab-button {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-5);
            background: transparent;
            border: none;
            border-radius: var(--radius-button);
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all var(--duration-base) var(--ease-out);
            white-space: nowrap;
        }

        .tab-button:hover {
            background: rgba(var(--color-primary-rgb), 0.1);
            color: var(--color-primary);
        }

        .tab-button.active {
            background: var(--color-primary);
            color: white;
            box-shadow: var(--shadow-primary);
        }

        .tab-button i {
            width: 18px;
            height: 18px;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s var(--ease-out);
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Content Cards */
        .content-card {
            background: var(--color-surface);
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-card);
            padding: var(--space-6);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
        }

        .content-card__header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-6);
            flex-wrap: wrap;
            gap: var(--space-4);
        }

        .content-card__title {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .content-card__title h2 {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin: 0;
        }

        .content-card__title i {
            color: var(--color-primary);
        }

        /* Form Styles */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-5);
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .form-group label {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
        }

        .form-group input,
        .form-group select {
            padding: var(--space-3) var(--space-4);
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-input);
            font-size: var(--font-size-base);
            color: var(--color-text-primary);
            transition: all var(--duration-base) var(--ease-out);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: var(--shadow-focus);
        }

        .form-group .input-suffix {
            position: relative;
        }

        .form-group .input-suffix input {
            padding-right: var(--space-12);
        }

        .form-group .input-suffix span {
            position: absolute;
            right: var(--space-4);
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
        }

        .form-group small {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-5);
            border: none;
            border-radius: var(--radius-button);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all var(--duration-base) var(--ease-out);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-hover) 100%);
            color: white;
            box-shadow: var(--shadow-primary);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            color: var(--color-text-primary);
        }

        .btn-secondary:hover {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .btn-success {
            background: linear-gradient(135deg, #34c759 0%, #30b350 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(52, 199, 89, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Table Styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: var(--space-4);
            text-align: left;
            border-bottom: 1px solid var(--color-border);
        }

        .data-table th {
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            background: rgba(var(--color-primary-rgb), 0.05);
        }

        .data-table td {
            font-size: var(--font-size-sm);
            color: var(--color-text-primary);
        }

        .data-table tr:hover td {
            background: rgba(var(--color-primary-rgb), 0.03);
        }

        .data-table .actions {
            display: flex;
            gap: var(--space-2);
        }

        .data-table .btn-icon {
            width: 32px;
            height: 32px;
            padding: 0;
            border-radius: var(--radius-button);
        }

        .data-table .btn-icon i {
            width: 16px;
            height: 16px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: var(--space-12);
            color: var(--color-text-secondary);
        }

        .empty-state i {
            width: 48px;
            height: 48px;
            margin-bottom: var(--space-4);
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-medium);
            margin-bottom: var(--space-2);
            color: var(--color-text-primary);
        }

        .empty-state p {
            font-size: var(--font-size-sm);
            margin-bottom: var(--space-6);
        }

        /* Search & Filter */
        .search-filter-bar {
            display: flex;
            gap: var(--space-4);
            margin-bottom: var(--space-6);
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            position: relative;
        }

        .search-input i {
            position: absolute;
            left: var(--space-4);
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-text-secondary);
            width: 18px;
            height: 18px;
        }

        .search-input input {
            width: 100%;
            padding: var(--space-3) var(--space-4) var(--space-3) var(--space-12);
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-input);
            font-size: var(--font-size-sm);
            color: var(--color-text-primary);
        }

        .search-input input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: var(--shadow-focus);
        }

        /* Category Groups */
        .category-group {
            margin-bottom: var(--space-6);
        }

        .category-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-4);
            background: rgba(var(--color-primary-rgb), 0.1);
            border-radius: var(--radius-button);
            margin-bottom: var(--space-3);
        }

        .category-header h3 {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            color: var(--color-primary);
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .category-header .count {
            background: var(--color-primary);
            color: white;
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
        }

        /* Kalkulation Summary */
        .kalkulation-summary {
            background: linear-gradient(135deg, rgba(var(--color-primary-rgb), 0.1) 0%, rgba(var(--color-primary-rgb), 0.05) 100%);
            border: 1px solid rgba(var(--color-primary-rgb), 0.2);
            border-radius: var(--radius-card);
            padding: var(--space-6);
            margin-top: var(--space-6);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-2) 0;
        }

        .summary-row.total {
            border-top: 2px solid var(--color-border);
            margin-top: var(--space-4);
            padding-top: var(--space-4);
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
        }

        .summary-row .label {
            color: var(--color-text-secondary);
        }

        .summary-row .value {
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
        }

        .summary-row.total .value {
            color: var(--color-primary);
        }

        /* ============================================
           ðŸš— FAHRZEUG-DIAGRAMM & SCHADENS-WIZARD
           ============================================ */

        .vehicle-selector {
            background: var(--color-surface);
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-card);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
        }

        .vehicle-selector__header {
            text-align: center;
            margin-bottom: var(--space-6);
        }

        .vehicle-selector__header h3 {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin: 0 0 var(--space-2) 0;
        }

        .vehicle-selector__header p {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            margin: 0;
        }

        .vehicle-diagram {
            display: flex;
            justify-content: center;
            margin-bottom: var(--space-6);
        }

        .vehicle-svg {
            max-width: 100%;
            height: auto;
        }

        .vehicle-part {
            cursor: pointer;
            transition: all 0.2s ease;
            fill: var(--color-surface);
            stroke: var(--color-border);
            stroke-width: 2;
        }

        .vehicle-part:hover {
            fill: rgba(var(--color-primary-rgb), 0.2);
            stroke: var(--color-primary);
            stroke-width: 3;
        }

        .vehicle-part.selected {
            fill: rgba(var(--color-primary-rgb), 0.3);
            stroke: var(--color-primary);
            stroke-width: 3;
        }

        .vehicle-part.damaged-light {
            fill: rgba(255, 193, 7, 0.3);
            stroke: #ffc107;
        }

        .vehicle-part.damaged-medium {
            fill: rgba(255, 152, 0, 0.3);
            stroke: #ff9800;
        }

        .vehicle-part.damaged-heavy {
            fill: rgba(244, 67, 54, 0.3);
            stroke: #f44336;
        }

        /* Spezielle Teile-Typen */
        .vehicle-part--glass {
            fill: url(#glassGradient);
            stroke: rgba(70, 130, 180, 0.6);
            stroke-width: 1.5;
        }

        .vehicle-part--glass:hover {
            fill: rgba(135, 206, 235, 0.7);
            stroke: var(--color-primary);
            stroke-width: 2;
        }

        .vehicle-part--glass.selected {
            fill: rgba(var(--color-primary-rgb), 0.4);
            stroke: var(--color-primary);
            stroke-width: 2.5;
        }

        .vehicle-part--pillar {
            fill: rgba(80, 80, 80, 0.3);
            stroke: rgba(60, 60, 60, 0.5);
            stroke-width: 1;
        }

        .vehicle-part--pillar:hover {
            fill: rgba(var(--color-primary-rgb), 0.3);
            stroke: var(--color-primary);
        }

        .vehicle-part--light {
            fill: rgba(255, 255, 200, 0.2);
            stroke: rgba(0, 0, 0, 0.3);
            stroke-width: 1;
        }

        .vehicle-part--light:hover {
            fill: rgba(255, 255, 150, 0.5);
            stroke: var(--color-primary);
        }

        .vehicle-part--wheel {
            cursor: pointer;
        }

        .vehicle-part--wheel:hover ellipse:first-child {
            stroke: var(--color-primary);
            stroke-width: 3;
        }

        .vehicle-part--wheel.selected ellipse:first-child {
            stroke: var(--color-primary);
            stroke-width: 4;
        }

        .vehicle-body-outline {
            pointer-events: none;
        }

        /* GrÃ¶ÃŸere SVG im Container - VERBESSERT fÃ¼r bessere Lesbarkeit */
        .vehicle-diagram {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: var(--space-6);
            background: linear-gradient(135deg, rgba(var(--color-primary-rgb), 0.02), rgba(var(--color-primary-rgb), 0.05));
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-4);
            overflow: auto;
        }

        .vehicle-diagram .vehicle-svg {
            width: 100%;
            max-width: 700px;
            height: auto;
            min-height: 450px;
        }

        /* GrÃ¶ÃŸere Labels fÃ¼r bessere Lesbarkeit */
        .vehicle-part-label {
            font-size: 11px;
            font-weight: 500;
            fill: var(--color-text-primary);
            pointer-events: none;
            text-anchor: middle;
        }

        .vehicle-part-label--glass {
            fill: rgba(0, 50, 100, 0.8);
            font-size: 10px;
        }

        /* 2D/3D View Toggle */
        .view-toggle-btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-4);
            border: 1px solid var(--color-border);
            background: var(--color-surface);
            color: var(--color-text-secondary);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .view-toggle-btn:hover {
            border-color: var(--color-primary);
            color: var(--color-primary);
        }

        .view-toggle-btn.active {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: white;
        }

        .view-toggle-btn svg {
            width: 16px;
            height: 16px;
        }

        /* 3D Container */
        .vehicle-3d-container {
            margin-bottom: var(--space-6);
        }

        .sketchfab-embed-wrapper iframe {
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border-glass);
        }

        /* 3D Part Buttons */
        .part-btn-3d {
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--color-border);
            background: var(--color-surface);
            color: var(--color-text-primary);
            border-radius: var(--radius-md);
            font-size: var(--font-size-xs);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .part-btn-3d:hover {
            border-color: var(--color-primary);
            background: rgba(var(--color-primary-rgb), 0.1);
            color: var(--color-primary);
        }

        .part-btn-3d.selected {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: white;
        }

        /* Fahrzeugtyp-Buttons */
        .vehicle-type-btn {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-4);
            border: 2px solid var(--color-border);
            background: var(--color-surface);
            color: var(--color-text-primary);
            border-radius: var(--radius-lg);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .vehicle-type-btn:hover {
            border-color: var(--color-primary);
            background: rgba(var(--color-primary-rgb), 0.05);
        }

        .vehicle-type-btn.active {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: white;
        }

        /* Spinner Animation */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Schadens-Wizard */
        .damage-wizard {
            display: none;
            background: linear-gradient(135deg, rgba(var(--color-primary-rgb), 0.05) 0%, transparent 100%);
            border: 1px solid rgba(var(--color-primary-rgb), 0.2);
            border-radius: var(--radius-card);
            padding: var(--space-6);
            margin-top: var(--space-4);
            animation: fadeIn 0.3s ease;
        }

        .damage-wizard.active {
            display: block;
        }

        .damage-wizard__header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-5);
        }

        .damage-wizard__title {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .damage-wizard__title h4 {
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin: 0;
        }

        .damage-wizard__close {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            border-radius: var(--radius-button);
            color: var(--color-text-secondary);
            cursor: pointer;
        }

        .damage-wizard__close:hover {
            background: var(--color-error);
            color: white;
        }

        .damage-options {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-3);
            margin-bottom: var(--space-5);
        }

        .damage-option {
            flex: 1;
            min-width: 120px;
            padding: var(--space-4);
            background: var(--color-surface);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-button);
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .damage-option:hover {
            border-color: var(--color-primary);
            background: rgba(var(--color-primary-rgb), 0.05);
        }

        .damage-option.selected {
            border-color: var(--color-primary);
            background: rgba(var(--color-primary-rgb), 0.1);
        }

        .damage-option__icon {
            font-size: 24px;
            margin-bottom: var(--space-2);
        }

        .damage-option__label {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
        }

        /* Vorgeschlagene Positionen */
        .suggested-positions {
            margin-top: var(--space-5);
        }

        .suggested-positions__header {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--space-3);
        }

        .suggested-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-3) var(--space-4);
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-button);
            margin-bottom: var(--space-2);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .suggested-item:hover {
            border-color: var(--color-primary);
            background: rgba(var(--color-primary-rgb), 0.05);
        }

        .suggested-item.added {
            border-color: var(--color-success);
            background: rgba(52, 199, 89, 0.1);
        }

        .suggested-item__info {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .suggested-item__checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--color-border);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .suggested-item.added .suggested-item__checkbox {
            background: var(--color-success);
            border-color: var(--color-success);
            color: white;
        }

        .suggested-item__name {
            font-size: var(--font-size-sm);
            color: var(--color-text-primary);
        }

        .suggested-item__price {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            color: var(--color-primary);
        }

        /* Schnellsuche Autocomplete */
        .quick-search {
            position: relative;
            margin-bottom: var(--space-6);
        }

        .quick-search__input {
            width: 100%;
            padding: var(--space-4) var(--space-5);
            padding-left: var(--space-12);
            background: var(--color-surface);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-card);
            font-size: var(--font-size-base);
            color: var(--color-text-primary);
            transition: all 0.2s ease;
        }

        .quick-search__input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 4px rgba(var(--color-primary-rgb), 0.1);
        }

        .quick-search__icon {
            position: absolute;
            left: var(--space-4);
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-text-secondary);
        }

        .quick-search__results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-card);
            box-shadow: var(--shadow-lg);
            max-height: 300px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .quick-search__results.active {
            display: block;
        }

        .quick-search__result {
            padding: var(--space-3) var(--space-4);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border-bottom: 1px solid var(--color-border);
        }

        .quick-search__result:last-child {
            border-bottom: none;
        }

        .quick-search__result:hover {
            background: rgba(var(--color-primary-rgb), 0.05);
        }

        .quick-search__result-name {
            font-size: var(--font-size-sm);
            color: var(--color-text-primary);
        }

        .quick-search__result-name mark {
            background: rgba(var(--color-primary-rgb), 0.3);
            color: inherit;
            padding: 0 2px;
            border-radius: 2px;
        }

        .quick-search__result-meta {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }

        /* OE-Nummern Suche */
        .oe-search-container {
            background: var(--color-surface);
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-card);
            padding: var(--space-5);
            margin-bottom: var(--space-6);
        }

        .oe-search-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-4);
        }

        .oe-search-title {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
        }

        .oe-search-stats {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
            background: var(--color-background);
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-button);
        }

        .oe-search-input-group {
            display: flex;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
        }

        .oe-search-input {
            flex: 1;
            padding: var(--space-3) var(--space-4);
            background: var(--color-background);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-button);
            font-size: var(--font-size-sm);
            color: var(--color-text-primary);
            transition: all 0.2s ease;
        }

        .oe-search-input:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .oe-search-input::placeholder {
            color: var(--color-text-secondary);
        }

        .oe-vehicle-select {
            display: flex;
            gap: var(--space-2);
        }

        .oe-vehicle-select select {
            padding: var(--space-2) var(--space-3);
            background: var(--color-background);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-button);
            font-size: var(--font-size-sm);
            color: var(--color-text-primary);
            cursor: pointer;
        }

        .oe-results {
            max-height: 350px;
            overflow-y: auto;
        }

        .oe-result-item {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            padding: var(--space-3) var(--space-4);
            background: var(--color-background);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-button);
            margin-bottom: var(--space-2);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .oe-result-item:hover {
            border-color: var(--color-primary);
            background: rgba(var(--color-primary-rgb), 0.05);
        }

        .oe-result-info {
            flex: 1;
        }

        .oe-result-part {
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
            margin-bottom: var(--space-1);
        }

        .oe-result-vehicle {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }

        .oe-result-oe {
            font-family: monospace;
            font-size: var(--font-size-sm);
            background: var(--color-primary);
            color: white;
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-button);
            white-space: nowrap;
        }

        .oe-no-results {
            text-align: center;
            padding: var(--space-6);
            color: var(--color-text-secondary);
        }

        .oe-no-results i {
            font-size: 2rem;
            margin-bottom: var(--space-2);
            display: block;
        }

        /* ============================================
           NEUER KALKULATIONS-WIZARD STYLES
           ============================================ */

        /* Step Progress Bar */
        .kalk-steps {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-6);
            background: var(--color-surface);
            border-radius: var(--radius-card);
            margin-bottom: var(--space-6);
        }

        .kalk-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-2);
            opacity: 0.5;
            transition: all 0.3s ease;
        }

        .kalk-step.active {
            opacity: 1;
        }

        .kalk-step.completed {
            opacity: 1;
        }

        .kalk-step__number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--color-border);
            color: var(--color-text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-lg);
            transition: all 0.3s ease;
        }

        .kalk-step.active .kalk-step__number {
            background: var(--color-primary);
            color: white;
        }

        .kalk-step.completed .kalk-step__number {
            background: var(--color-success);
            color: white;
        }

        .kalk-step__label {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            text-align: center;
        }

        .kalk-step.active .kalk-step__label {
            color: var(--color-text-primary);
            font-weight: var(--font-weight-medium);
        }

        .kalk-step__line {
            flex: 1;
            max-width: 60px;
            height: 3px;
            background: var(--color-border);
            border-radius: 2px;
        }

        /* Step Content */
        .kalk-step-content {
            display: none;
        }

        .kalk-step-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Vehicle Form */
        .kalk-vehicle-form {
            padding: var(--space-6);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-4);
            margin-bottom: var(--space-4);
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .kalk-vehicle-info {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            padding: var(--space-4);
            background: rgba(var(--color-success-rgb), 0.1);
            border: 1px solid var(--color-success);
            border-radius: var(--radius-card);
            margin-top: var(--space-4);
        }

        .kalk-vehicle-info__icon {
            font-size: 2rem;
        }

        .kalk-vehicle-info__details {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }

        .kalk-vehicle-info__details strong {
            font-size: var(--font-size-lg);
        }

        .kalk-vehicle-info__details span {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        /* Step Actions */
        .kalk-step-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-6);
            border-top: 1px solid var(--color-border);
            margin-top: var(--space-6);
        }

        .btn-lg {
            padding: var(--space-4) var(--space-6);
            font-size: var(--font-size-base);
        }

        /* Selected Vehicle Display */
        .kalk-selected-vehicle {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-4);
            background: rgba(var(--color-primary-rgb), 0.1);
            border-radius: var(--radius-button);
            margin-bottom: var(--space-4);
        }

        .kalk-selected-vehicle__label {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .kalk-selected-vehicle__value {
            font-weight: var(--font-weight-semibold);
            color: var(--color-primary);
        }

        /* Fahrzeug-Tab Navigation (Step 1) */
        .kalk-vehicle-tabs {
            display: flex;
            gap: var(--space-2);
            margin-bottom: var(--space-6);
            background: var(--color-background);
            padding: var(--space-2);
            border-radius: var(--radius-card);
        }

        .kalk-vehicle-tab {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-4);
            background: transparent;
            border: none;
            border-radius: var(--radius-button);
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .kalk-vehicle-tab:hover {
            background: rgba(var(--color-primary-rgb), 0.1);
            color: var(--color-primary);
        }

        .kalk-vehicle-tab.active {
            background: var(--color-primary);
            color: white;
        }

        .kalk-vehicle-tab i {
            width: 16px;
            height: 16px;
        }

        /* Entwurf Badge */
        .entwurf-badge {
            background: #ef4444;
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 4px;
        }

        .kalk-vehicle-tab.active .entwurf-badge {
            background: white;
            color: var(--color-primary);
        }

        /* Partner Badge */
        .partner-badge {
            background: #8b5cf6 !important;
        }

        .kalk-vehicle-tab.active .partner-badge {
            background: white !important;
            color: #8b5cf6 !important;
        }

        /* Entwurf Info Banner */
        .entwurf-info-banner {
            display: flex;
            gap: var(--space-3);
            padding: var(--space-3);
            background: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%);
            border-radius: var(--radius-card);
            margin-bottom: var(--space-4);
            border-left: 4px solid var(--color-primary);
        }

        .entwurf-info-banner i {
            color: var(--color-primary);
            flex-shrink: 0;
        }

        .entwurf-info-banner strong {
            display: block;
            color: var(--color-text-primary);
            margin-bottom: 4px;
        }

        .entwurf-info-banner p {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
            margin: 0;
        }

        /* Partner Banner */
        .entwurf-info-banner.partner-banner {
            background: linear-gradient(135deg, #f3e8ff 0%, #ede9fe 100%);
            border-left-color: #8b5cf6;
        }

        .entwurf-info-banner.partner-banner i {
            color: #8b5cf6;
        }

        /* Partner Item Styles */
        .partner-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3);
            border-bottom: 1px solid var(--color-border);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .partner-item:last-child {
            border-bottom: none;
        }

        .partner-item:hover {
            background: rgba(139, 92, 246, 0.05);
        }

        .partner-item.selected {
            background: rgba(139, 92, 246, 0.1);
            border-left: 3px solid #8b5cf6;
        }

        .partner-item__icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #f3e8ff 0%, #ede9fe 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .partner-item__info {
            flex: 1;
            min-width: 0;
        }

        .partner-item__title {
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: 4px;
        }

        .partner-item__meta {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .partner-item__meta span {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .partner-item__partner-name {
            background: #f3e8ff;
            color: #7c3aed;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .partner-item__status {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .partner-item__status.neu {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .partner-item__status.warte_kva {
            background: #fef3c7;
            color: #b45309;
        }

        .partner-item__photos {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }

        .partner-item__photo {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 6px;
            border: 1px solid var(--color-border);
        }

        .partner-item__photo-more {
            width: 40px;
            height: 40px;
            background: var(--color-bg-secondary);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            color: var(--color-text-secondary);
        }

        .partner-item__arrow {
            color: var(--color-text-tertiary);
        }

        .partner-item:hover .partner-item__arrow {
            color: #8b5cf6;
        }

        /* Entwurf Item Styles */
        .entwurf-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3);
            border-bottom: 1px solid var(--color-border);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .entwurf-item:last-child {
            border-bottom: none;
        }

        .entwurf-item:hover {
            background: rgba(var(--color-primary-rgb), 0.05);
        }

        .entwurf-item.selected {
            background: rgba(var(--color-primary-rgb), 0.1);
            border-left: 3px solid var(--color-primary);
        }

        .entwurf-item__icon {
            font-size: 2rem;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: var(--radius-card);
        }

        .entwurf-item__info {
            flex: 1;
            min-width: 0;
        }

        .entwurf-item__title {
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: 2px;
        }

        .entwurf-item__meta {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-2);
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .entwurf-item__meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .entwurf-item__service {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: var(--color-primary);
            color: white;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
        }

        .entwurf-item__photos {
            display: flex;
            gap: 4px;
            margin-top: 8px;
        }

        .entwurf-item__photo {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-button);
            object-fit: cover;
            border: 2px solid white;
            box-shadow: var(--shadow-sm);
        }

        .entwurf-item__photo-more {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-button);
            background: var(--color-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            color: var(--color-text-secondary);
        }

        .entwurf-item__arrow {
            color: var(--color-text-tertiary);
            transition: transform 0.2s ease;
        }

        .entwurf-item:hover .entwurf-item__arrow {
            transform: translateX(4px);
            color: var(--color-primary);
        }

        /* ðŸ†• Auftragsinfo Box (Step 3) */
        .auftrags-info-box {
            background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%);
            border: 1px solid #fde047;
            border-radius: var(--radius-card);
            margin-bottom: var(--space-4);
            overflow: hidden;
        }

        .auftrags-info-header {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-3);
            background: rgba(250, 204, 21, 0.2);
            border-bottom: 1px solid #fde047;
            color: #854d0e;
        }

        .auftrags-info-header i {
            width: 18px;
            height: 18px;
        }

        .auftrags-info-header strong {
            flex: 1;
        }

        .auftrags-info-content {
            padding: var(--space-3);
        }

        .auftrags-info-content.collapsed {
            display: none;
        }

        .auftrags-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
        }

        .auftrags-info-section {
            background: white;
            border-radius: var(--radius-md);
            padding: var(--space-3);
            border: 1px solid #fef08a;
        }

        .auftrags-info-section.auftrags-info-full {
            grid-column: 1 / -1;
            margin-top: var(--space-3);
        }

        .auftrags-info-section-title {
            font-weight: 600;
            font-size: var(--font-size-sm);
            color: #854d0e;
            margin-bottom: var(--space-2);
            padding-bottom: var(--space-2);
            border-bottom: 1px solid #fef08a;
        }

        .auftrags-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            font-size: var(--font-size-sm);
        }

        .auftrags-info-label {
            color: var(--color-text-secondary);
        }

        .auftrags-info-value {
            font-weight: 600;
            color: var(--color-text-primary);
            text-align: right;
        }

        .auftrags-info-schaden,
        .auftrags-info-notizen {
            font-size: var(--font-size-sm);
            color: var(--color-text-primary);
            line-height: 1.5;
            white-space: pre-wrap;
            background: #fffef0;
            padding: var(--space-2);
            border-radius: var(--radius-sm);
            border: 1px dashed #fde047;
        }

        /* ðŸ†• Entwurf Fotos KI-Analyse Section */
        .entwurf-fotos-ki-section {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 1px solid #6ee7b7;
            border-radius: var(--radius-card);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .entwurf-fotos-ki-header {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-bottom: var(--space-2);
            color: #047857;
        }

        .entwurf-fotos-ki-header h4 {
            flex: 1;
            margin: 0;
            font-size: var(--font-size-base);
        }

        .entwurf-fotos-ki-header i {
            width: 20px;
            height: 20px;
        }

        .entwurf-fotos-ki-hint {
            color: #065f46;
            font-size: var(--font-size-sm);
            margin-bottom: var(--space-3);
        }

        .entwurf-fotos-ki-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: var(--space-3);
            margin-bottom: var(--space-3);
        }

        .entwurf-foto-item {
            position: relative;
            cursor: pointer;
            border-radius: var(--radius-md);
            overflow: hidden;
            border: 3px solid transparent;
            transition: all 0.2s ease;
        }

        .entwurf-foto-item:hover {
            transform: scale(1.02);
            box-shadow: var(--shadow-md);
        }

        .entwurf-foto-item.selected {
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
        }

        .entwurf-foto-item img {
            width: 100%;
            height: 90px;
            object-fit: cover;
            display: block;
        }

        .entwurf-foto-item__checkbox {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            background: white;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .entwurf-foto-item.selected .entwurf-foto-item__checkbox {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }

        .entwurf-foto-item__checkbox i {
            width: 14px;
            height: 14px;
            opacity: 0;
        }

        .entwurf-foto-item.selected .entwurf-foto-item__checkbox i {
            opacity: 1;
        }

        .entwurf-foto-item__number {
            position: absolute;
            bottom: 8px;
            left: 8px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            font-size: 11px;
            font-weight: 600;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .entwurf-fotos-ki-actions {
            display: flex;
            gap: var(--space-2);
            justify-content: center;
            margin-bottom: var(--space-3);
        }

        .entwurf-fotos-ki-divider {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-top: var(--space-4);
            color: var(--color-text-secondary);
        }

        .entwurf-fotos-ki-divider::before,
        .entwurf-fotos-ki-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--color-border);
        }

        .entwurf-fotos-ki-divider span {
            font-size: var(--font-size-sm);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Entwurf Fotos Section */
        .entwurf-photos-section {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: var(--radius-card);
            padding: var(--space-3);
            margin-bottom: var(--space-4);
            border: 1px solid #bae6fd;
        }

        .entwurf-photos-header {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-bottom: var(--space-3);
            color: #0369a1;
            font-weight: 600;
        }

        .entwurf-photos-header i {
            width: 18px;
            height: 18px;
        }

        .entwurf-photos-header span {
            flex: 1;
        }

        .entwurf-photos-gallery {
            display: flex;
            gap: var(--space-2);
            overflow-x: auto;
            padding-bottom: var(--space-2);
        }

        .entwurf-photo-thumb {
            width: 100px;
            height: 75px;
            border-radius: var(--radius-button);
            object-fit: cover;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid white;
            box-shadow: var(--shadow-sm);
            flex-shrink: 0;
        }

        .entwurf-photo-thumb:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
        }

        /* Fullscreen Photo Modal */
        .photo-lightbox {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-4);
        }

        .photo-lightbox__close {
            position: absolute;
            top: var(--space-4);
            right: var(--space-4);
            background: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .photo-lightbox__image {
            max-width: 90vw;
            max-height: 85vh;
            object-fit: contain;
            border-radius: var(--radius-card);
        }

        .photo-lightbox__nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            border: none;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-lg);
        }

        .photo-lightbox__nav--prev { left: var(--space-4); }
        .photo-lightbox__nav--next { right: var(--space-4); }

        .photo-lightbox__counter {
            position: absolute;
            bottom: var(--space-4);
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.9);
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-button);
            font-weight: 500;
        }

        .kalk-vehicle-tab-content {
            display: none;
        }

        .kalk-vehicle-tab-content.active {
            display: block;
        }

        /* Fahrzeug-Liste */
        .kalk-vehicle-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-card);
            background: var(--color-background);
        }

        .kalk-vehicle-loading,
        .kalk-vehicle-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: var(--space-3);
            padding: var(--space-8);
            color: var(--color-text-secondary);
        }

        .kalk-vehicle-empty i {
            width: 48px;
            height: 48px;
            opacity: 0.5;
        }

        .spinner-small {
            width: 24px;
            height: 24px;
            border: 2px solid var(--color-border);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .kalk-vehicle-item {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            padding: var(--space-4);
            border-bottom: 1px solid var(--color-border);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .kalk-vehicle-item:last-child {
            border-bottom: none;
        }

        .kalk-vehicle-item:hover {
            background: rgba(var(--color-primary-rgb), 0.05);
        }

        .kalk-vehicle-item.selected {
            background: rgba(var(--color-success-rgb), 0.1);
            border-left: 3px solid var(--color-success);
        }

        .kalk-vehicle-item__icon {
            font-size: 1.5rem;
        }

        .kalk-vehicle-item__info {
            flex: 1;
        }

        .kalk-vehicle-item__name {
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
        }

        .kalk-vehicle-item__details {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .kalk-vehicle-item__service {
            display: inline-block;
            padding: 2px 8px;
            background: var(--color-primary);
            color: white;
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
        }

        /* AusgewÃ¤hltes Fahrzeug aus DB */
        .kalk-selected-db-vehicle {
            padding: var(--space-4);
            background: rgba(var(--color-success-rgb), 0.1);
            border: 2px solid var(--color-success);
            border-radius: var(--radius-card);
            margin-top: var(--space-4);
        }

        .kalk-selected-db-vehicle__header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-3);
        }

        .kalk-selected-db-vehicle__badge {
            background: var(--color-success);
            color: white;
            padding: 2px 10px;
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
        }

        .kalk-selected-db-vehicle__info {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .kalk-selected-db-vehicle__icon {
            font-size: 2rem;
        }

        .kalk-selected-db-vehicle__details {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }

        .kalk-selected-db-vehicle__details strong {
            font-size: var(--font-size-lg);
            color: var(--color-text-primary);
        }

        .kalk-selected-db-vehicle__details span {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        /* Selected Part Display */
        .kalk-selected-part {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-4);
            background: rgba(var(--color-success-rgb), 0.1);
            border: 2px solid var(--color-success);
            border-radius: var(--radius-card);
            margin: var(--space-4) 0;
        }

        .kalk-selected-part__icon {
            width: 32px;
            height: 32px;
            background: var(--color-success);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .kalk-selected-part__info {
            flex: 1;
        }

        .kalk-selected-part__info strong {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .kalk-selected-part__info span {
            display: block;
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
        }

        /* Parts List */
        .kalk-parts-list {
            margin: var(--space-4) 0;
            padding: var(--space-4);
            background: var(--color-surface);
            border-radius: var(--radius-card);
        }

        .kalk-parts-list h4 {
            margin-bottom: var(--space-3);
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
        }

        /* Service Options (Step 2) */
        .kalk-service-options {
            padding: var(--space-6);
        }

        .kalk-service-hint {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
            margin-bottom: var(--space-4);
            text-align: center;
        }

        .service-options-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-4);
        }

        @media (max-width: 1200px) {
            .service-options-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .service-options-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .service-option {
            cursor: pointer;
        }

        .service-option input[type="radio"] {
            display: none;
        }

        .service-option__content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-5);
            background: var(--color-surface);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-card);
            transition: all 0.2s ease;
            text-align: center;
        }

        .service-option:hover .service-option__content {
            border-color: var(--color-primary);
            background: rgba(var(--color-primary-rgb), 0.05);
            transform: translateY(-2px);
        }

        .service-option input[type="radio"]:checked + .service-option__content {
            border-color: var(--color-success);
            background: rgba(var(--color-success-rgb), 0.1);
            box-shadow: 0 0 0 3px rgba(var(--color-success-rgb), 0.2);
        }

        .service-option__icon {
            font-size: 2rem;
        }

        .service-option__label {
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
        }

        .service-option__desc {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }

        /* ============================================ */
        /* STEP 2b: SERVICE-DETAILS FORM STYLES */
        /* ============================================ */
        .service-details-form {
            padding: var(--space-6);
            display: grid;
            gap: var(--space-5);
        }

        .service-field-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .service-field-group label {
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .service-field-group label .required-star {
            color: var(--color-error);
        }

        .service-field-group input,
        .service-field-group select,
        .service-field-group textarea {
            padding: var(--space-3);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-default);
            font-size: var(--font-size-base);
            background: var(--color-surface);
            color: var(--color-text-primary);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .service-field-group input:focus,
        .service-field-group select:focus,
        .service-field-group textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(var(--color-primary-rgb), 0.2);
        }

        .service-field-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .service-field-help {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }

        /* File Upload Styling */
        .service-file-upload {
            position: relative;
            border: 2px dashed var(--color-border);
            border-radius: var(--radius-card);
            padding: var(--space-6);
            text-align: center;
            background: var(--color-surface);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .service-file-upload:hover {
            border-color: var(--color-primary);
            background: rgba(var(--color-primary-rgb), 0.05);
        }

        .service-file-upload.drag-over {
            border-color: var(--color-success);
            background: rgba(var(--color-success-rgb), 0.1);
        }

        .service-file-upload input[type="file"] {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .service-file-upload__icon {
            font-size: 2.5rem;
            color: var(--color-text-secondary);
            margin-bottom: var(--space-3);
        }

        .service-file-upload__text {
            font-size: var(--font-size-base);
            color: var(--color-text-primary);
            margin-bottom: var(--space-1);
        }

        .service-file-upload__hint {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }

        /* Design Upload Preview Grid */
        .design-upload-preview {
            padding: var(--space-6);
            border-top: 1px solid var(--color-border);
        }

        .design-preview-header {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-bottom: var(--space-4);
            color: var(--color-text-primary);
        }

        .design-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: var(--space-4);
        }

        .design-preview-item {
            position: relative;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-card);
            overflow: hidden;
            background: var(--color-surface);
        }

        .design-preview-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        .design-preview-item__name {
            padding: var(--space-2);
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .design-preview-item__remove {
            position: absolute;
            top: var(--space-2);
            right: var(--space-2);
            width: 24px;
            height: 24px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            line-height: 1;
            transition: transform 0.2s ease;
        }

        .design-preview-item__remove:hover {
            transform: scale(1.1);
        }

        .design-preview-item__file-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 120px;
            font-size: 3rem;
            color: var(--color-text-secondary);
            background: var(--color-surface-elevated);
        }

        /* Badge fÃ¼r Service-Anzeige */
        .kalk-selected-vehicle__badge {
            background: var(--color-primary);
            color: white;
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-default);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
            margin-left: var(--space-3);
        }

        /* Step 6: Design-Galerie */
        .step6-design-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: var(--space-4);
            margin-top: var(--space-3);
        }

        .step6-design-item {
            border: 1px solid var(--color-border);
            border-radius: var(--radius-card);
            overflow: hidden;
            background: var(--color-surface);
        }

        .step6-design-item img {
            width: 100%;
            height: 140px;
            object-fit: cover;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .step6-design-item img:hover {
            transform: scale(1.02);
        }

        .step6-design-item__info {
            padding: var(--space-2) var(--space-3);
            border-top: 1px solid var(--color-border);
        }

        .step6-design-item__name {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .step6-design-item__file {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 140px;
            font-size: 3rem;
            color: var(--color-text-secondary);
            background: var(--color-surface-elevated);
        }

        /* Service-Details Summary */
        .service-details-list {
            display: grid;
            gap: var(--space-2);
        }

        .service-details-row {
            display: flex;
            gap: var(--space-3);
            padding: var(--space-2) 0;
            border-bottom: 1px dashed var(--color-border);
        }

        .service-details-row:last-child {
            border-bottom: none;
        }

        .service-details-label {
            font-weight: var(--font-weight-medium);
            color: var(--color-text-secondary);
            min-width: 140px;
        }

        .service-details-value {
            color: var(--color-text-primary);
        }

        /* ðŸ†• MULTI-SERVICE TABS (Step 3) - Nov 30, 2025 */
        .service-tabs-container {
            margin-bottom: var(--space-4);
            padding: var(--space-4);
            background: var(--color-surface-elevated);
            border-radius: var(--radius-card);
            border: 1px solid var(--color-border);
        }

        .service-tabs-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            flex-wrap: wrap;
        }

        .service-tabs-label {
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
        }

        .service-tabs {
            display: flex;
            gap: var(--space-2);
            flex-wrap: wrap;
            flex: 1;
        }

        .service-tab {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-4);
            background: var(--color-surface);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-full);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-secondary);
        }

        .service-tab:hover {
            border-color: var(--color-primary);
            color: var(--color-primary);
            background: rgba(var(--color-primary-rgb), 0.05);
        }

        .service-tab.active {
            border-color: var(--color-primary);
            background: var(--color-primary);
            color: white;
        }

        .service-tab__icon {
            font-size: 1rem;
        }

        .service-tab__badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-bold);
        }

        .service-tab.active .service-tab__badge {
            background: rgba(255, 255, 255, 0.3);
        }

        .service-tab:not(.active) .service-tab__badge {
            background: var(--color-border);
        }

        .service-tabs-info {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-top: var(--space-3);
            padding: var(--space-2) var(--space-3);
            background: rgba(var(--color-primary-rgb), 0.1);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .service-tabs-info i {
            color: var(--color-primary);
            width: 16px;
            height: 16px;
        }

        @media (max-width: 768px) {
            .service-tabs-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .service-tabs {
                width: 100%;
            }

            .service-tab {
                flex: 1;
                justify-content: center;
                min-width: calc(50% - var(--space-1));
            }
        }

        /* Service-spezifische Teile-Liste (Step 3) */
        .service-parts-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-3);
        }

        @media (max-width: 1200px) {
            .service-parts-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .service-parts-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .service-part-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-4);
            background: var(--color-surface);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-card);
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }

        .service-part-btn:hover {
            border-color: var(--color-primary);
            background: rgba(var(--color-primary-rgb), 0.05);
            transform: translateY(-2px);
        }

        .service-part-btn.selected {
            border-color: var(--color-success);
            background: rgba(var(--color-success-rgb), 0.1);
            box-shadow: 0 0 0 3px rgba(var(--color-success-rgb), 0.2);
        }

        .service-part-btn__icon {
            font-size: 1.5rem;
        }

        .service-part-btn__label {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
        }

        /* ðŸ†• Multi-Select Checkmark (Nov 30, 2025) */
        .service-part-btn__check {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            background: var(--color-success);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .service-part-btn {
            position: relative;
        }

        /* ðŸ†• Step 4: Multi-Service Teile-Ãœbersicht (Nov 30, 2025) */
        .step4-parts-overview {
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
            border: 1px solid var(--color-border);
        }

        .step4-parts-header {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-weight: 600;
            margin-bottom: var(--space-3);
            color: var(--color-text-primary);
        }

        .step4-parts-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-2);
        }

        .step4-part-tab {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: var(--color-background);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-full);
            cursor: pointer;
            font-size: var(--font-size-sm);
            transition: all 0.2s ease;
        }

        .step4-part-tab:hover {
            border-color: var(--color-primary);
        }

        .step4-part-tab.active {
            background: var(--color-primary);
            border-color: var(--color-primary);
            color: white;
        }

        .step4-part-tab.completed {
            background: var(--color-success-light);
            border-color: var(--color-success);
        }

        .step4-part-tab.completed .step4-part-check {
            display: flex;
        }

        .step4-part-tab__icon {
            font-size: 16px;
        }

        .step4-part-tab__service {
            font-size: var(--font-size-xs);
            opacity: 0.7;
        }

        .step4-part-check {
            display: none;
            width: 16px;
            height: 16px;
            background: var(--color-success);
            color: white;
            border-radius: 50%;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        /* ðŸ†• Step 5: Teile-Checkliste fÃ¼r Bestellungen (Nov 30, 2025) */
        .teile-checklist-section {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border: 2px solid #ff9800;
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .teile-checklist-header {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-weight: 600;
            margin-bottom: var(--space-3);
            color: #e65100;
        }

        .teile-checklist-badge {
            margin-left: auto;
            background: #ff9800;
            color: white;
            padding: 2px 8px;
            border-radius: var(--radius-full);
            font-size: var(--font-size-sm);
        }

        .teile-checklist-info {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            background: rgba(255, 255, 255, 0.7);
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-3);
            font-size: var(--font-size-sm);
            color: #e65100;
        }

        .teile-checklist-items {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .teile-checklist-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            background: white;
            padding: var(--space-3);
            border-radius: var(--radius-md);
            border: 1px solid #ffcc80;
            transition: all 0.2s ease;
        }

        .teile-checklist-item:hover {
            border-color: #ff9800;
        }

        .teile-checklist-item.checked {
            background: #e8f5e9;
            border-color: var(--color-success);
        }

        .teile-checklist-item.checked .teile-checklist-item__name {
            text-decoration: line-through;
            color: var(--color-text-secondary);
        }

        .teile-checklist-item__checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: var(--color-success);
        }

        .teile-checklist-item__icon {
            font-size: 20px;
        }

        .teile-checklist-item__content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .teile-checklist-item__name {
            font-weight: 500;
            color: var(--color-text-primary);
        }

        .teile-checklist-item__service {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }

        .teile-checklist-item__arbeiten {
            font-size: var(--font-size-xs);
            color: var(--color-primary);
        }

        .teile-checklist-actions {
            display: flex;
            gap: var(--space-2);
            margin-top: var(--space-3);
            padding-top: var(--space-3);
            border-top: 1px solid #ffcc80;
        }

        /* Dark Mode fÃ¼r Teile-Checkliste */
        [data-theme="dark"] .teile-checklist-section {
            background: linear-gradient(135deg, #3e2723 0%, #4e342e 100%);
            border-color: #ff9800;
        }

        [data-theme="dark"] .teile-checklist-header {
            color: #ffb74d;
        }

        [data-theme="dark"] .teile-checklist-info {
            background: rgba(0, 0, 0, 0.3);
            color: #ffb74d;
        }

        [data-theme="dark"] .teile-checklist-item {
            background: var(--color-surface);
            border-color: #5d4037;
        }

        [data-theme="dark"] .teile-checklist-item.checked {
            background: #1b5e20;
            border-color: var(--color-success);
        }

        /* Repair Options */
        .kalk-repair-options {
            padding: var(--space-6);
        }

        .kalk-repair-options h4 {
            margin-bottom: var(--space-2);
        }

        .kalk-repair-hint {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
            margin-bottom: var(--space-4);
        }

        .repair-options-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-3);
        }

        @media (max-width: 992px) {
            .repair-options-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .repair-options-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .repair-option {
            cursor: pointer;
        }

        .repair-option input[type="checkbox"] {
            display: none;
        }

        .repair-option__content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-4);
            background: var(--color-surface);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-card);
            transition: all 0.2s ease;
        }

        .repair-option:hover .repair-option__content {
            border-color: var(--color-primary);
            background: rgba(var(--color-primary-rgb), 0.05);
        }

        .repair-option input[type="checkbox"]:checked + .repair-option__content {
            border-color: var(--color-success);
            background: rgba(var(--color-success-rgb), 0.1);
        }

        .repair-option__icon {
            font-size: 1.5rem;
        }

        .repair-option__label {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            text-align: center;
        }

        /* Kalkulation Summary */
        .kalk-summary {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: var(--space-6);
            padding: var(--space-6);
        }

        @media (max-width: 768px) {
            .kalk-summary {
                grid-template-columns: 1fr;
            }
        }

        .kalk-summary__vehicle,
        .kalk-summary__parts,
        .kalk-summary__ersatzteile {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-card);
            padding: var(--space-4);
        }

        .kalk-summary h4 {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: var(--space-3);
        }

        /* ============================================ */
        /* ERSATZTEILE STYLES (Step 4 Inline + Step 5) */
        /* ============================================ */

        /* Step 4: Inline Ersatzteil-Eingabe */
        .kalk-ersatzteil-inline {
            background: linear-gradient(135deg, rgba(var(--color-primary-rgb), 0.05), rgba(var(--color-primary-rgb), 0.02));
            border: 1px solid rgba(var(--color-primary-rgb), 0.2);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
        }

        .ersatzteil-inline-header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
        }

        .ersatzteil-inline-header h4 {
            margin: 0;
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
        }

        .ersatzteil-hint {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            margin-left: auto;
        }

        .ersatzteil-inline-form {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: var(--space-3);
        }

        @media (max-width: 768px) {
            .ersatzteil-inline-form {
                grid-template-columns: 1fr 1fr;
            }
        }

        .ersatzteil-input {
            padding: var(--space-3);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            background: var(--color-surface);
        }

        .ersatzteil-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(var(--color-primary-rgb), 0.1);
        }

        .ersatzteil-db-hint {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-top: var(--space-3);
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }

        .ersatzteil-db-hint svg {
            width: 14px;
            height: 14px;
        }

        /* Autocomplete Dropdown */
        .ersatzteil-search-wrapper {
            position: relative;
        }

        .ersatzteil-autocomplete {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
        }

        .ersatzteil-autocomplete-item {
            padding: var(--space-3);
            cursor: pointer;
            border-bottom: 1px solid var(--color-border);
            transition: background 0.15s;
        }

        .ersatzteil-autocomplete-item:last-child {
            border-bottom: none;
        }

        .ersatzteil-autocomplete-item:hover {
            background: rgba(var(--color-primary-rgb), 0.1);
        }

        .ersatzteil-autocomplete-item__name {
            font-weight: var(--font-weight-medium);
        }

        .ersatzteil-autocomplete-item__details {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }

        /* Step 5: Ersatzteile-Ãœbersicht */
        .ersatzteile-info-banner {
            display: flex;
            gap: var(--space-4);
            padding: var(--space-4);
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(59, 130, 246, 0.05));
            border: 1px solid rgba(59, 130, 246, 0.2);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-6);
        }

        .ersatzteile-info-banner > svg {
            color: #3b82f6;
            flex-shrink: 0;
        }

        .ersatzteile-info-banner p {
            margin: var(--space-1) 0 0;
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .ersatzteile-from-repairs,
        .ersatzteile-add-section,
        .ersatzteile-complete-list {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            margin-bottom: var(--space-5);
        }

        .ersatzteile-from-repairs h4,
        .ersatzteile-add-section h4,
        .ersatzteile-complete-list h4 {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin: 0 0 var(--space-4);
            font-size: var(--font-size-base);
        }

        .ersatzteile-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .no-items-hint {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
            font-style: italic;
        }

        /* Ersatzteil Add Form */
        .ersatzteil-add-form {
            background: rgba(var(--color-primary-rgb), 0.02);
            border-radius: var(--radius-md);
            padding: var(--space-4);
        }

        .ersatzteil-form-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: var(--space-4);
            margin-bottom: var(--space-4);
        }

        .ersatzteil-form-row:last-child {
            grid-template-columns: 1fr 1fr 1fr 1fr;
            margin-bottom: 0;
        }

        @media (max-width: 768px) {
            .ersatzteil-form-row,
            .ersatzteil-form-row:last-child {
                grid-template-columns: 1fr 1fr;
            }
        }

        .ersatzteil-field label {
            display: block;
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-secondary);
            margin-bottom: var(--space-1);
        }

        .ersatzteil-field input,
        .ersatzteil-field select {
            width: 100%;
            padding: var(--space-3);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: var(--font-size-sm);
            background: var(--color-surface);
        }

        .ersatzteil-field--large {
            grid-column: span 1;
        }

        .ersatzteil-field--action {
            display: flex;
            flex-direction: column;
        }

        .ersatzteil-field--lieferant {
            min-width: 180px;
        }

        .ersatzteil-field--link {
            min-width: 200px;
            flex: 1;
        }

        .lieferant-combo-input input {
            width: 100%;
        }

        .ersatzteil-link {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            color: var(--color-primary);
            text-decoration: none;
        }

        .ersatzteil-link:hover {
            text-decoration: underline;
        }

        /* External Links */
        .ersatzteile-external-links {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            margin-top: var(--space-4);
            padding-top: var(--space-4);
            border-top: 1px solid var(--color-border);
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .external-link {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            color: var(--color-primary);
            text-decoration: none;
            font-weight: var(--font-weight-medium);
        }

        .external-link:hover {
            text-decoration: underline;
        }

        .external-link svg {
            width: 14px;
            height: 14px;
        }

        /* Ersatzteile Table */
        .ersatzteile-table-wrapper {
            overflow-x: auto;
        }

        .ersatzteile-table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--font-size-sm);
        }

        .ersatzteile-table th,
        .ersatzteile-table td {
            padding: var(--space-3);
            text-align: left;
            border-bottom: 1px solid var(--color-border);
        }

        .ersatzteile-table th {
            background: rgba(var(--color-primary-rgb), 0.05);
            font-weight: var(--font-weight-semibold);
            font-size: var(--font-size-xs);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .ersatzteile-table tbody tr:hover {
            background: rgba(var(--color-primary-rgb), 0.02);
        }

        .no-items-row td {
            text-align: center;
            color: var(--color-text-secondary);
            font-style: italic;
            padding: var(--space-6);
        }

        .ersatzteile-total-row {
            background: rgba(var(--color-primary-rgb), 0.05);
        }

        .ersatzteile-total-row td {
            border-bottom: none;
        }

        .ersatzteile-table .btn-icon {
            padding: var(--space-2);
            background: none;
            border: none;
            cursor: pointer;
            color: var(--color-text-secondary);
            border-radius: var(--radius-sm);
        }

        .ersatzteile-table .btn-icon:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        /* ============================================ */
        /* ðŸ†• KI-ERSATZTEILSUCHE STYLES */
        /* ============================================ */

        .ki-ersatzteile-section {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            margin-bottom: var(--space-5);
        }

        .ki-ersatzteile-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
            flex-wrap: wrap;
            gap: var(--space-3);
        }

        .ki-ersatzteile-header__title {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .ki-ersatzteile-header__title h4 {
            margin: 0;
            font-size: var(--font-size-lg);
            color: #92400e;
        }

        .ki-ersatzteile-context {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-4);
            background: white;
            border-radius: var(--radius-md);
            padding: var(--space-3);
            margin-bottom: var(--space-4);
        }

        .ki-kontext-item {
            display: flex;
            gap: var(--space-2);
        }

        .ki-kontext-label {
            font-weight: 600;
            color: var(--color-text-secondary);
        }

        .ki-kontext-value {
            color: var(--color-text-primary);
        }

        .ki-ersatzteile-loading {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            background: white;
            border-radius: var(--radius-md);
            padding: var(--space-5);
            text-align: center;
            justify-content: center;
        }

        .ki-loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #f59e0b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .ki-loading-text strong {
            display: block;
            margin-bottom: var(--space-1);
            color: #92400e;
        }

        .ki-loading-text p {
            margin: 0;
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
        }

        .ki-ersatzteile-results {
            background: white;
            border-radius: var(--radius-md);
            padding: var(--space-4);
        }

        .ki-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
            padding-bottom: var(--space-3);
            border-bottom: 1px solid var(--color-border);
            flex-wrap: wrap;
            gap: var(--space-3);
        }

        .ki-results-count {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-weight: 600;
            color: #059669;
        }

        .ki-results-count svg {
            color: #10b981;
        }

        .ki-results-actions {
            display: flex;
            gap: var(--space-2);
        }

        /* Teil-Gruppe */
        .ki-teil-gruppe {
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-4);
            overflow: hidden;
        }

        .ki-teil-gruppe__header {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            padding: var(--space-3) var(--space-4);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--color-border);
        }

        .ki-teil-gruppe__name {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .ki-teil-gruppe__name svg {
            color: var(--color-primary);
        }

        .ki-teil-gruppe__angebote {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        /* Einzelnes Angebot */
        .ki-angebot {
            display: grid;
            grid-template-columns: auto 1fr auto auto auto;
            gap: var(--space-3);
            align-items: center;
            padding: var(--space-3) var(--space-4);
            border-bottom: 1px solid var(--color-border);
            transition: background 0.2s;
        }

        .ki-angebot:last-child {
            border-bottom: none;
        }

        .ki-angebot:hover {
            background: #f9fafb;
        }

        .ki-angebot.selected {
            background: #ecfdf5;
            border-left: 3px solid #10b981;
        }

        .ki-angebot__checkbox {
            width: 22px;
            height: 22px;
            cursor: pointer;
        }

        .ki-angebot__info {
            min-width: 0;
        }

        .ki-angebot__title {
            font-weight: 500;
            color: var(--color-text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ki-angebot__details {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            display: flex;
            gap: var(--space-3);
            flex-wrap: wrap;
        }

        .ki-angebot__anbieter {
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }

        .ki-angebot__anbieter-logo {
            width: 60px;
            height: 24px;
            object-fit: contain;
            border-radius: 4px;
            background: #f3f4f6;
            padding: 2px 4px;
        }

        .ki-angebot__anbieter-name {
            font-weight: 500;
            color: var(--color-text-primary);
        }

        .ki-angebot__preis {
            text-align: right;
            min-width: 80px;
        }

        .ki-angebot__preis-wert {
            font-size: var(--font-size-lg);
            font-weight: 700;
            color: var(--color-primary);
        }

        .ki-angebot__preis-label {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }

        .ki-angebot__link {
            color: var(--color-text-secondary);
            padding: var(--space-2);
            border-radius: var(--radius-sm);
            transition: all 0.2s;
        }

        .ki-angebot__link:hover {
            color: var(--color-primary);
            background: rgba(var(--color-primary-rgb), 0.1);
        }

        /* Badge fÃ¼r QualitÃ¤t */
        .ki-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .ki-badge--oe {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .ki-badge--aftermarket {
            background: #fef3c7;
            color: #b45309;
        }

        .ki-badge--gebraucht {
            background: #f3f4f6;
            color: #4b5563;
        }

        .ki-badge--guenstig {
            background: #dcfce7;
            color: #15803d;
        }

        .ki-badge--lieferbar {
            background: #ecfdf5;
            color: #059669;
        }

        .ki-badge--bestellen {
            background: #fef3c7;
            color: #d97706;
        }

        /* Footer */
        .ki-results-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: var(--space-4);
            padding-top: var(--space-4);
            border-top: 2px solid var(--color-border);
            flex-wrap: wrap;
            gap: var(--space-3);
        }

        .ki-selected-summary {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            font-size: var(--font-size-base);
        }

        .ki-selected-summary strong {
            font-size: var(--font-size-xl);
            color: var(--color-primary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .ki-angebot {
                grid-template-columns: auto 1fr auto;
                grid-template-rows: auto auto;
            }

            .ki-angebot__anbieter {
                grid-column: 2;
                grid-row: 2;
            }

            .ki-angebot__preis {
                grid-column: 3;
                grid-row: 1 / span 2;
            }

            .ki-angebot__link {
                display: none;
            }
        }

        /* ============================================ */

        /* Responsive */
        @media (max-width: 768px) {
            .damage-option {
                min-width: calc(50% - var(--space-2));
            }

            .vehicle-svg {
                max-width: 100%;
            }

            .kalk-steps {
                flex-wrap: wrap;
                gap: var(--space-3);
            }

            .kalk-step__line {
                display: none;
            }
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            padding: var(--space-6);
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            position: relative;
            z-index: 10000;
            background: #ffffff !important;  /* Force solid white */
            border: 1px solid #e0e0e0 !important;
            border-radius: 16px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease-out;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        /* Dark mode modal */
        [data-theme="dark"] .modal {
            background: #1c1c1e !important;
            border-color: #3a3a3c !important;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: scale(0.95) translateY(-20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid #e0e0e0;
            background: #f8f8f8;
            border-radius: 16px 16px 0 0;
        }

        [data-theme="dark"] .modal-header {
            background: #2c2c2e;
            border-bottom-color: #3a3a3c;
        }

        .modal-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1d1d1f;
            margin: 0;
        }

        [data-theme="dark"] .modal-header h3 {
            color: #ffffff;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            border-radius: var(--radius-button);
            color: var(--color-text-secondary);
            cursor: pointer;
            transition: all var(--duration-base) var(--ease-out);
        }

        .modal-close:hover {
            background: var(--color-error);
            color: white;
        }

        .modal-body {
            padding: 24px;
            background: #ffffff;
            color: #1d1d1f;
        }

        [data-theme="dark"] .modal-body {
            background: #1c1c1e;
            color: #ffffff;
        }

        .modal-body .form-group {
            margin-bottom: 16px;
        }

        .modal-body label {
            display: block;
            font-weight: 500;
            margin-bottom: 6px;
            color: #1d1d1f;
        }

        [data-theme="dark"] .modal-body label {
            color: #ffffff;
        }

        .modal-body input,
        .modal-body select,
        .modal-body textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d1d6;
            border-radius: 8px;
            font-size: 15px;
            background: #ffffff;
            color: #1d1d1f;
        }

        [data-theme="dark"] .modal-body input,
        [data-theme="dark"] .modal-body select,
        [data-theme="dark"] .modal-body textarea {
            background: #2c2c2e;
            border-color: #3a3a3c;
            color: #ffffff;
        }

        .modal-body small {
            display: block;
            margin-top: 4px;
            font-size: 12px;
            color: #86868b;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 16px 24px;
            border-top: 1px solid #e0e0e0;
            background: #f8f8f8;
            border-radius: 0 0 16px 16px;
        }

        [data-theme="dark"] .modal-footer {
            background: #2c2c2e;
            border-top-color: #3a3a3c;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: var(--space-6);
            right: var(--space-6);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }

        .toast {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-4) var(--space-5);
            background: var(--color-surface);
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-card);
            box-shadow: var(--shadow-lg);
            animation: toastSlideIn 0.3s var(--ease-out);
        }

        .toast.success {
            border-left: 4px solid #34c759;
        }

        .toast.error {
            border-left: 4px solid var(--color-error);
        }

        .toast.info {
            border-left: 4px solid var(--color-primary);
        }

        @keyframes toastSlideIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .page-container {
                padding: var(--space-4);
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .tab-navigation {
                width: 100%;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .content-card__header {
                flex-direction: column;
                align-items: flex-start;
            }

            .data-table {
                display: block;
                overflow-x: auto;
            }
        }

        /* ============================================
           VEHICLE-MATCH & PREIS-TREND STYLES
           ============================================ */
        .ersatzteil-autocomplete-item.vehicle-match {
            background: rgba(var(--color-primary-rgb), 0.1);
            border-left: 3px solid var(--color-primary);
        }

        .vehicle-badge {
            margin-right: 4px;
            font-size: 0.9em;
        }

        /* ============================================
           TEMPLATE TAB STYLES
           ============================================ */
        .template-categories {
            display: flex;
            gap: var(--space-2);
            margin-bottom: var(--space-6);
            flex-wrap: wrap;
        }

        .template-category {
            padding: var(--space-2) var(--space-4);
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-full);
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: all var(--duration-base) var(--ease-out);
        }

        .template-category:hover {
            border-color: var(--color-primary);
            color: var(--color-primary);
        }

        .template-category.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: var(--space-4);
        }

        .template-card {
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-card);
            padding: var(--space-4);
            cursor: pointer;
            transition: all var(--duration-base) var(--ease-out);
            display: flex;
            gap: var(--space-4);
            align-items: flex-start;
        }

        .template-card:hover {
            border-color: var(--color-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .template-card__icon {
            font-size: 2rem;
            flex-shrink: 0;
        }

        .template-card__content h4 {
            margin: 0 0 var(--space-2) 0;
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
        }

        .template-card__content p {
            margin: 0 0 var(--space-3) 0;
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .template-card__meta {
            display: flex;
            gap: var(--space-4);
            font-size: var(--font-size-xs);
            color: var(--color-text-muted);
        }

        .template-card__meta span {
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }

        .template-card__meta i {
            width: 12px;
            height: 12px;
        }

        /* ============================================
           LIEFERANTEN TAB STYLES
           ============================================ */
        .lieferanten-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: var(--space-4);
        }

        .lieferant-card {
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-card);
            padding: var(--space-4);
            display: flex;
            gap: var(--space-4);
            align-items: flex-start;
        }

        .lieferant-card__logo {
            flex-shrink: 0;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-surface);
            border-radius: var(--radius-lg);
        }

        .lieferant-card__content {
            flex: 1;
        }

        .lieferant-card__content h4 {
            margin: 0 0 var(--space-1) 0;
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
        }

        .lieferant-card__content p {
            margin: 0 0 var(--space-3) 0;
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .lieferant-card__meta {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        /* Ersatzteile nach Lieferant Styles */
        .lieferant-ersatzteile-section {
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-card);
            margin-bottom: var(--space-4);
            overflow: hidden;
        }

        .lieferant-ersatzteile-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-4);
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-border);
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .lieferant-ersatzteile-header:hover {
            background: var(--color-surface-hover);
        }

        .lieferant-ersatzteile-header__info {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .lieferant-ersatzteile-header__info h4 {
            margin: 0;
            font-size: var(--font-size-base);
        }

        .lieferant-ersatzteile-header__stats {
            display: flex;
            align-items: center;
            gap: var(--space-4);
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .lieferant-ersatzteile-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .lieferant-ersatzteile-body.expanded {
            max-height: 1000px;
        }

        .lieferant-ersatzteile-list {
            padding: var(--space-3);
        }

        .lieferant-ersatzteil-item {
            display: grid;
            grid-template-columns: 1fr auto auto auto;
            gap: var(--space-4);
            align-items: center;
            padding: var(--space-3);
            border-bottom: 1px solid var(--color-border-light);
            font-size: var(--font-size-sm);
        }

        .lieferant-ersatzteil-item:last-child {
            border-bottom: none;
        }

        .lieferant-ersatzteil-item__name {
            font-weight: 500;
        }

        .lieferant-ersatzteil-item__name small {
            display: block;
            font-weight: 400;
            color: var(--color-text-secondary);
            font-size: var(--font-size-xs);
        }

        .lieferant-ersatzteil-item__preis {
            font-weight: 600;
            color: var(--color-primary);
        }

        .lieferant-ersatzteil-item__count {
            color: var(--color-text-secondary);
        }

        @media (max-width: 640px) {
            .lieferant-ersatzteil-item {
                grid-template-columns: 1fr;
                gap: var(--space-2);
            }

            .lieferant-ersatzteil-item__preis,
            .lieferant-ersatzteil-item__count {
                text-align: left;
            }
        }

        .preisvergleich-results {
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-card);
            min-height: 200px;
        }

        .preisvergleich-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-4);
            border-bottom: 1px solid var(--color-border);
        }

        .preisvergleich-item:last-child {
            border-bottom: none;
        }

        .preisvergleich-item__info h5 {
            margin: 0 0 var(--space-1) 0;
            font-size: var(--font-size-base);
        }

        .preisvergleich-item__info p {
            margin: 0;
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .preisvergleich-item__prices {
            display: flex;
            gap: var(--space-4);
        }

        .preisvergleich-price {
            text-align: center;
            padding: var(--space-2) var(--space-4);
            background: var(--color-surface);
            border-radius: var(--radius-lg);
        }

        .preisvergleich-price__label {
            font-size: var(--font-size-xs);
            color: var(--color-text-muted);
        }

        .preisvergleich-price__value {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-bold);
        }

        .preisvergleich-price--best {
            background: rgba(34, 197, 94, 0.1);
        }

        .preisvergleich-price--best .preisvergleich-price__value {
            color: #22c55e;
        }

        /* ============================================
           KUNDEN TAB STYLES
           ============================================ */
        .kunden-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: var(--space-4);
        }

        .kunde-card {
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-card);
            padding: var(--space-4);
            cursor: pointer;
            transition: all var(--duration-base) var(--ease-out);
        }

        .kunde-card:hover {
            border-color: var(--color-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .kunde-card__header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-3);
        }

        .kunde-card__name {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            margin: 0;
        }

        .kunde-card__badge {
            background: var(--color-primary);
            color: white;
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
        }

        .kunde-card__fahrzeuge {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .kunde-fahrzeug {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-2);
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            font-size: var(--font-size-sm);
        }

        .kunde-fahrzeug__info {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .kunde-fahrzeug__kennzeichen {
            font-weight: var(--font-weight-medium);
            color: var(--color-primary);
        }

        .kunde-fahrzeug__modell {
            color: var(--color-text-secondary);
        }

        .kunde-fahrzeug__count {
            font-size: var(--font-size-xs);
            color: var(--color-text-muted);
        }

        /* ============================================
           FOTO-ANALYSE STYLES (KI)
           ============================================ */
        .foto-analyse-container {
            border: 2px dashed var(--color-border);
            border-radius: var(--radius-card);
            padding: var(--space-8);
            text-align: center;
            cursor: pointer;
            transition: all var(--duration-base) var(--ease-out);
        }

        .foto-analyse-container:hover,
        .foto-analyse-container.dragover {
            border-color: var(--color-primary);
            background: rgba(var(--color-primary-rgb), 0.05);
        }

        .foto-analyse-container i {
            width: 48px;
            height: 48px;
            color: var(--color-text-muted);
            margin-bottom: var(--space-4);
        }

        .foto-analyse-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: var(--space-4);
            margin-top: var(--space-4);
        }

        .foto-analyse-preview img {
            width: 100%;
            aspect-ratio: 4/3;
            object-fit: cover;
            border-radius: var(--radius-lg);
        }

        .ki-analyse-result {
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-card);
            padding: var(--space-6);
            margin-top: var(--space-6);
        }

        .ki-analyse-result__header {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin-bottom: var(--space-4);
        }

        .ki-analyse-result__header i {
            color: var(--color-primary);
        }

        .ki-schaeden-liste {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
        }

        .ki-schaden-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3);
            background: var(--color-surface);
            border-radius: var(--radius-lg);
        }

        .ki-schaden-item__info {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .ki-schaden-item__confidence {
            font-size: var(--font-size-xs);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-full);
        }

        .ki-schaden-item__confidence--high {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
        }

        .ki-schaden-item__confidence--medium {
            background: rgba(234, 179, 8, 0.1);
            color: #eab308;
        }

        .ki-schaden-item__confidence--low {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }
    </style>
</head>
<body>
    <!-- ðŸŽ¨ APPLE LIQUID GLASS - Background Effects -->
    <div class="gradient-mesh" aria-hidden="true"></div>
    <div class="noise-overlay" aria-hidden="true"></div>
    <div class="floating-orb floating-orb--1" aria-hidden="true"></div>
    <div class="floating-orb floating-orb--2" aria-hidden="true"></div>
    <div class="floating-orb floating-orb--3" aria-hidden="true"></div>
    <div class="accent-light" aria-hidden="true"></div>
    <div class="page-transition-overlay" aria-hidden="true"></div>

    <!-- ðŸ“± MOBILE HEADER - Sticky Top (Mobile Only) -->
    <header class="mobile-header">
        <div class="mobile-header__logo">
            <i data-feather="hash"></i>
            <span>Kalkulation</span>
        </div>
        <div class="mobile-header__actions">
            <!-- Dark Mode Toggle (Mobile Only) -->
            <button
                id="mobile-theme-toggle"
                class="mobile-header__icon mobile-header__theme-toggle"
                aria-label="Dunklen Modus aktivieren"
                aria-pressed="false"
                title="Theme wechseln">
                <i data-feather="sun" class="theme-icon theme-icon--light" aria-hidden="true"></i>
                <i data-feather="moon" class="theme-icon theme-icon--dark" aria-hidden="true"></i>
            </button>
        </div>
    </header>

    <!-- THEME TOGGLE BUTTON - Fixed Top-Right (Desktop Only) -->
    <button
        id="dark-mode-toggle"
        class="theme-toggle"
        type="button"
        aria-label="Dunklen Modus aktivieren"
        aria-pressed="false"
        title="Theme wechseln (Cmd+Shift+D)">
        <span class="sr-only" aria-live="polite" aria-atomic="true">
            Aktuelles Theme: Hell
        </span>
        <i data-feather="sun" class="theme-toggle__icon theme-toggle__icon--light" aria-hidden="true"></i>
        <i data-feather="moon" class="theme-toggle__icon theme-toggle__icon--dark" aria-hidden="true"></i>
    </button>

    <div class="page-container">
        <!-- ðŸŽ¨ HERO SECTION -->
        <div class="page-hero">
            <h1 class="page-hero__title">ðŸ§® Kalkulation</h1>
            <p class="page-hero__subtitle">Professionelle Schadenskalkulationen erstellen</p>
            <div class="page-hero__badge">
                <i data-feather="zap" style="width: 14px; height: 14px;"></i>
                Premium Kalkulations-Tool
            </div>
        </div>

        <!-- Back Button -->
        <div style="margin-bottom: var(--space-6);">
            <button class="back-button" onclick="safeNavigate('index.html')" title="ZurÃ¼ck zum Dashboard">
                <i data-feather="arrow-left"></i>
            </button>
        </div>

        <!-- Tab Navigation -->
        <nav class="tab-navigation">
            <button class="tab-button active" data-tab="kalkulation" onclick="switchTab('kalkulation')">
                <i data-feather="hash"></i>
                <span>Neue Kalkulation</span>
            </button>
            <button class="tab-button" data-tab="katalog" onclick="switchTab('katalog')">
                <i data-feather="book"></i>
                <span>Arbeitswert-Katalog</span>
            </button>
            <button class="tab-button" data-tab="saetze" onclick="switchTab('saetze')">
                <i data-feather="dollar-sign"></i>
                <span>StundensÃ¤tze</span>
            </button>
            <button class="tab-button" data-tab="material" onclick="switchTab('material')">
                <i data-feather="package"></i>
                <span>Material</span>
            </button>
            <button class="tab-button" data-tab="historie" onclick="switchTab('historie')">
                <i data-feather="clock"></i>
                <span>Historie</span>
            </button>
            <button class="tab-button" data-tab="templates" onclick="switchTab('templates')">
                <i data-feather="copy"></i>
                <span>Templates</span>
            </button>
            <button class="tab-button" data-tab="lieferanten" onclick="switchTab('lieferanten')">
                <i data-feather="truck"></i>
                <span>Lieferanten</span>
            </button>
            <button class="tab-button" data-tab="kunden" onclick="switchTab('kunden')">
                <i data-feather="users"></i>
                <span>Kunden</span>
            </button>
        </nav>

        <!-- ============================================ -->
        <!-- TAB 1: Neue Kalkulation erstellen -->
        <!-- ============================================ -->
        <section id="tab-kalkulation" class="tab-content active">

            <!-- ============================================ -->
            <!-- STEP PROGRESS BAR (6 Steps) -->
            <!-- ============================================ -->
            <div class="kalk-steps">
                <div class="kalk-step active" data-step="1">
                    <div class="kalk-step__number">1</div>
                    <div class="kalk-step__label">Fahrzeug</div>
                </div>
                <div class="kalk-step__line"></div>
                <div class="kalk-step" data-step="2">
                    <div class="kalk-step__number">2</div>
                    <div class="kalk-step__label">Service</div>
                </div>
                <div class="kalk-step__line"></div>
                <div class="kalk-step" data-step="3">
                    <div class="kalk-step__number">3</div>
                    <div class="kalk-step__label">Teil</div>
                </div>
                <div class="kalk-step__line"></div>
                <div class="kalk-step" data-step="4">
                    <div class="kalk-step__number">4</div>
                    <div class="kalk-step__label">Arbeiten</div>
                </div>
                <div class="kalk-step__line"></div>
                <div class="kalk-step" data-step="5">
                    <div class="kalk-step__number">5</div>
                    <div class="kalk-step__label">Ersatzteile</div>
                </div>
                <div class="kalk-step__line"></div>
                <div class="kalk-step" data-step="6">
                    <div class="kalk-step__number">6</div>
                    <div class="kalk-step__label">Ãœbersicht</div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- STEP 1: FAHRZEUGDATEN -->
            <!-- ============================================ -->
            <div class="kalk-step-content active" id="stepContent1">
                <div class="content-card">
                    <div class="content-card__header">
                        <div class="content-card__title">
                            <i data-feather="truck"></i>
                            <h2>Schritt 1: Fahrzeugdaten</h2>
                        </div>
                    </div>

                    <!-- TABS: Entwurf, Partner-Anfragen, Bestehendes Fahrzeug oder Neues Fahrzeug -->
                    <div class="kalk-vehicle-tabs">
                        <button class="kalk-vehicle-tab active" data-tab="entwurf" onclick="switchVehicleTab('entwurf')">
                            <i data-feather="file-text"></i>
                            ðŸ“ Aus Entwurf
                            <span class="entwurf-badge" id="entwurfCount" style="display: none;">0</span>
                        </button>
                        <button class="kalk-vehicle-tab" data-tab="partner" onclick="switchVehicleTab('partner')">
                            <i data-feather="users"></i>
                            ðŸ¤ Partner-Anfragen
                            <span class="entwurf-badge partner-badge" id="partnerCount" style="display: none;">0</span>
                        </button>
                        <button class="kalk-vehicle-tab" data-tab="existing" onclick="switchVehicleTab('existing')">
                            <i data-feather="database"></i>
                            Bestehendes Fahrzeug
                        </button>
                        <button class="kalk-vehicle-tab" data-tab="new" onclick="switchVehicleTab('new')">
                            <i data-feather="plus-circle"></i>
                            Neues Fahrzeug
                        </button>
                    </div>

                    <!-- TAB: EntwÃ¼rfe aus Annahme -->
                    <div class="kalk-vehicle-tab-content active" id="tabEntwurf">
                        <div class="entwurf-info-banner">
                            <i data-feather="info"></i>
                            <div>
                                <strong>EntwÃ¼rfe aus der Fahrzeugannahme</strong>
                                <p>WÃ¤hlen Sie einen Entwurf aus, um die Daten automatisch zu Ã¼bernehmen (Fahrzeug, Service, Fotos).</p>
                            </div>
                        </div>

                        <div class="kalk-vehicle-list" id="entwurfList">
                            <div class="kalk-vehicle-loading" id="entwurfLoading">
                                <div class="spinner-small"></div>
                                <span>EntwÃ¼rfe werden geladen...</span>
                            </div>
                            <div class="kalk-vehicle-empty" id="entwurfEmpty" style="display: none;">
                                <i data-feather="inbox"></i>
                                <p>Keine offenen EntwÃ¼rfe vorhanden</p>
                                <small>Erstellen Sie einen Entwurf Ã¼ber die Fahrzeugannahme</small>
                            </div>
                            <div id="entwurfListItems">
                                <!-- Dynamisch gefÃ¼llt -->
                            </div>
                        </div>
                    </div>

                    <!-- TAB: Partner-Anfragen -->
                    <div class="kalk-vehicle-tab-content" id="tabPartner" style="display: none;">
                        <div class="entwurf-info-banner partner-banner">
                            <i data-feather="users"></i>
                            <div>
                                <strong>Partner-Anfragen</strong>
                                <p>Anfragen von Partnern, die noch kein KVA haben. WÃ¤hlen Sie eine Anfrage um ein KVA zu erstellen.</p>
                            </div>
                        </div>

                        <div class="kalk-vehicle-list" id="partnerList">
                            <div class="kalk-vehicle-loading" id="partnerLoading">
                                <div class="spinner-small"></div>
                                <span>Partner-Anfragen werden geladen...</span>
                            </div>
                            <div class="kalk-vehicle-empty" id="partnerEmpty" style="display: none;">
                                <i data-feather="inbox"></i>
                                <p>Keine offenen Partner-Anfragen</p>
                                <small>Alle Anfragen haben bereits ein KVA oder sind abgeschlossen</small>
                            </div>
                            <div id="partnerListItems">
                                <!-- Dynamisch gefÃ¼llt -->
                            </div>
                        </div>
                    </div>

                    <!-- TAB: Bestehendes Fahrzeug aus DB -->
                    <div class="kalk-vehicle-tab-content" id="tabExisting" style="display: none;">
                        <div class="kalk-vehicle-search">
                            <div class="form-group">
                                <label>Fahrzeug suchen</label>
                                <input type="text" id="vehicleSearchInput"
                                       placeholder="Kennzeichen, Kunde oder Marke eingeben..."
                                       oninput="searchVehicles()">
                            </div>
                        </div>

                        <div class="kalk-vehicle-list" id="vehicleList">
                            <div class="kalk-vehicle-loading" id="vehicleLoading">
                                <div class="spinner-small"></div>
                                <span>Fahrzeuge werden geladen...</span>
                            </div>
                            <div class="kalk-vehicle-empty" id="vehicleEmpty" style="display: none;">
                                <i data-feather="inbox"></i>
                                <p>Keine Fahrzeuge gefunden</p>
                                <button class="btn btn-secondary btn-sm" onclick="switchVehicleTab('new')">
                                    Neues Fahrzeug anlegen
                                </button>
                            </div>
                            <div id="vehicleListItems">
                                <!-- Dynamisch gefÃ¼llt -->
                            </div>
                        </div>
                    </div>

                    <!-- TAB: Neues Fahrzeug manuell -->
                    <div class="kalk-vehicle-tab-content" id="tabNew" style="display: none;">
                        <div class="kalk-vehicle-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="kalkMarke">Marke *</label>
                                <select id="kalkMarke" onchange="updateKalkModelle()" required>
                                    <option value="">-- Marke wÃ¤hlen --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="kalkModell">Modell *</label>
                                <select id="kalkModell" required>
                                    <option value="">-- Erst Marke wÃ¤hlen --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="kalkBaujahr">Baujahr *</label>
                                <select id="kalkBaujahr" required>
                                    <option value="">-- Baujahr --</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="kalkKennzeichen">Kennzeichen (optional)</label>
                                <input type="text" id="kalkKennzeichen" placeholder="z.B. MOS-AB 123">
                            </div>
                            <div class="form-group">
                                <label for="kalkFarbe">Farbcode (optional)</label>
                                <input type="text" id="kalkFarbe" placeholder="z.B. LY9T">
                            </div>
                            <div class="form-group">
                                <label for="kalkKunde">Kundenname (optional)</label>
                                <input type="text" id="kalkKunde" placeholder="z.B. Max Mustermann">
                            </div>
                        </div>

                        <!-- Fahrzeug-Info Box -->
                        <div class="kalk-vehicle-info" id="kalkVehicleInfo" style="display: none;">
                            <div class="kalk-vehicle-info__icon">ðŸš—</div>
                            <div class="kalk-vehicle-info__details">
                                <strong id="kalkVehicleDisplay">-</strong>
                                <span id="kalkVehicleExtra">-</span>
                            </div>
                        </div>
                        </div><!-- END kalk-vehicle-form -->
                    </div><!-- END tabNew -->

                    <!-- AusgewÃ¤hltes Fahrzeug Anzeige (fÃ¼r beide Tabs) -->
                    <div class="kalk-selected-db-vehicle" id="selectedDbVehicle" style="display: none;">
                        <div class="kalk-selected-db-vehicle__header">
                            <span class="kalk-selected-db-vehicle__badge">AusgewÃ¤hlt</span>
                            <button class="btn btn-sm btn-secondary" onclick="clearSelectedVehicle()">
                                <i data-feather="x"></i> Ã„ndern
                            </button>
                        </div>
                        <div class="kalk-selected-db-vehicle__info">
                            <div class="kalk-selected-db-vehicle__icon">ðŸš—</div>
                            <div class="kalk-selected-db-vehicle__details">
                                <strong id="selectedVehicleName">-</strong>
                                <span id="selectedVehicleKennzeichen">-</span>
                                <span id="selectedVehicleKunde">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="kalk-step-actions">
                        <div></div>
                        <button class="btn btn-primary btn-lg" onclick="goToStep(2)" id="btnStep1Next">
                            Weiter zu Service-Art
                            <i data-feather="arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- STEP 2: SERVICE-ART WÃ„HLEN (12 Services) -->
            <!-- ============================================ -->
            <div class="kalk-step-content" id="stepContent2">
                <div class="content-card">
                    <div class="content-card__header">
                        <div class="content-card__title">
                            <i data-feather="grid"></i>
                            <h2>Schritt 2: Service-Art wÃ¤hlen</h2>
                        </div>
                    </div>

                    <!-- ðŸ†• AUFTRAGSINFO BOX fÃ¼r Step 2 (Nov 30, 2025) -->
                    <div class="auftrags-info-box" id="step2AuftragsInfo" style="display: none;">
                        <div class="auftrags-info-header">
                            <i data-feather="file-text"></i>
                            <strong>Auftragsinformationen</strong>
                            <button class="btn btn-sm btn-ghost" onclick="toggleAuftragsInfo('step2')" id="auftragsInfoToggle2">
                                <i data-feather="chevron-up"></i>
                            </button>
                        </div>
                        <div class="auftrags-info-content" id="auftragsInfoContent2">
                            <div class="auftrags-info-grid">
                                <!-- Fahrzeug -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">ðŸš— Fahrzeug</div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Kennzeichen:</span>
                                        <span class="auftrags-info-value" id="info2Kennzeichen">-</span>
                                    </div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Fahrzeug:</span>
                                        <span class="auftrags-info-value" id="info2Fahrzeug">-</span>
                                    </div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Farbe:</span>
                                        <span class="auftrags-info-value" id="info2Farbe">-</span>
                                    </div>
                                </div>

                                <!-- Kunde -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">ðŸ‘¤ Kunde</div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Name:</span>
                                        <span class="auftrags-info-value" id="info2Kunde">-</span>
                                    </div>
                                    <div class="auftrags-info-row" id="info2PartnerRow" style="display: none;">
                                        <span class="auftrags-info-label">Partner:</span>
                                        <span class="auftrags-info-value" id="info2Partner">-</span>
                                    </div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Datum:</span>
                                        <span class="auftrags-info-value" id="info2Datum">-</span>
                                    </div>
                                </div>

                                <!-- Service -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">ðŸ”§ Service</div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Service-Art:</span>
                                        <span class="auftrags-info-value" id="info2Service">-</span>
                                    </div>
                                    <div class="auftrags-info-row" id="info2DringlichkeitRow" style="display: none;">
                                        <span class="auftrags-info-label">Dringlichkeit:</span>
                                        <span class="auftrags-info-value" id="info2Dringlichkeit">-</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Schadensbeschreibung -->
                            <div class="auftrags-info-section auftrags-info-full" id="info2SchadenSection" style="display: none;">
                                <div class="auftrags-info-section-title">ðŸ“ Schadensbeschreibung</div>
                                <div class="auftrags-info-schaden" id="info2Schaden">-</div>
                            </div>

                            <!-- Notizen -->
                            <div class="auftrags-info-section auftrags-info-full" id="info2NotizenSection" style="display: none;">
                                <div class="auftrags-info-section-title">ðŸ“‹ Notizen</div>
                                <div class="auftrags-info-notizen" id="info2Notizen">-</div>
                            </div>

                            <!-- Service-Details pro Service -->
                            <div class="auftrags-info-section auftrags-info-full" id="info2ServiceDetailsSection" style="display: none;">
                                <div class="auftrags-info-section-title">ðŸ“¦ Service-Details</div>
                                <div class="auftrags-info-service-details" id="info2ServiceDetails">
                                    <!-- Dynamisch gefÃ¼llt -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="kalk-service-options">
                        <p class="kalk-service-hint">WÃ¤hlen Sie die Art der Reparatur/Dienstleistung</p>

                        <div class="service-options-grid">
                            <!-- 1. Lackierung -->
                            <label class="service-option">
                                <input type="radio" name="serviceArt" value="lackier" onchange="updateServiceSelection()">
                                <div class="service-option__content">
                                    <span class="service-option__icon">ðŸŽ¨</span>
                                    <span class="service-option__label">Lackierung</span>
                                    <span class="service-option__desc">LackschÃ¤den, Kratzer, Beulen</span>
                                </div>
                            </label>

                            <!-- 2. Versicherung (Unfall) -->
                            <label class="service-option">
                                <input type="radio" name="serviceArt" value="versicherung" onchange="updateServiceSelection()">
                                <div class="service-option__content">
                                    <span class="service-option__icon">ðŸ›¡ï¸</span>
                                    <span class="service-option__label">Versicherungsschaden</span>
                                    <span class="service-option__desc">Unfallreparatur, Gutachten</span>
                                </div>
                            </label>

                            <!-- 3. Dellen (Smart-Repair/PDR) -->
                            <label class="service-option">
                                <input type="radio" name="serviceArt" value="dellen" onchange="updateServiceSelection()">
                                <div class="service-option__content">
                                    <span class="service-option__icon">ðŸ”¨</span>
                                    <span class="service-option__label">DellendrÃ¼cken</span>
                                    <span class="service-option__desc">Smart-Repair, PDR, Hagel</span>
                                </div>
                            </label>

                            <!-- 4. Glas -->
                            <label class="service-option">
                                <input type="radio" name="serviceArt" value="glas" onchange="updateServiceSelection()">
                                <div class="service-option__content">
                                    <span class="service-option__icon">ðŸªŸ</span>
                                    <span class="service-option__label">Glasreparatur</span>
                                    <span class="service-option__desc">Scheiben, Steinschlag</span>
                                </div>
                            </label>

                            <!-- 5. Reifen -->
                            <label class="service-option">
                                <input type="radio" name="serviceArt" value="reifen" onchange="updateServiceSelection()">
                                <div class="service-option__content">
                                    <span class="service-option__icon">ðŸ›ž</span>
                                    <span class="service-option__label">Reifen-Service</span>
                                    <span class="service-option__desc">Reifenwechsel, Felgen</span>
                                </div>
                            </label>

                            <!-- 6. Mechanik -->
                            <label class="service-option">
                                <input type="radio" name="serviceArt" value="mechanik" onchange="updateServiceSelection()">
                                <div class="service-option__content">
                                    <span class="service-option__icon">ðŸ”§</span>
                                    <span class="service-option__label">Mechanik</span>
                                    <span class="service-option__desc">Reparaturen, Wartung</span>
                                </div>
                            </label>

                            <!-- 7. Pflege (Aufbereitung) -->
                            <label class="service-option">
                                <input type="radio" name="serviceArt" value="pflege" onchange="updateServiceSelection()">
                                <div class="service-option__content">
                                    <span class="service-option__icon">âœ¨</span>
                                    <span class="service-option__label">Fahrzeugpflege</span>
                                    <span class="service-option__desc">Aufbereitung, Politur</span>
                                </div>
                            </label>

                            <!-- 8. TÃœV/AU -->
                            <label class="service-option">
                                <input type="radio" name="serviceArt" value="tuev" onchange="updateServiceSelection()">
                                <div class="service-option__content">
                                    <span class="service-option__icon">ðŸ“‹</span>
                                    <span class="service-option__label">TÃœV/AU</span>
                                    <span class="service-option__desc">Hauptuntersuchung</span>
                                </div>
                            </label>

                            <!-- 9. Klima -->
                            <label class="service-option">
                                <input type="radio" name="serviceArt" value="klima" onchange="updateServiceSelection()">
                                <div class="service-option__content">
                                    <span class="service-option__icon">â„ï¸</span>
                                    <span class="service-option__label">Klimaservice</span>
                                    <span class="service-option__desc">Klimaanlage, Wartung</span>
                                </div>
                            </label>

                            <!-- 10. Folierung -->
                            <label class="service-option">
                                <input type="radio" name="serviceArt" value="folierung" onchange="updateServiceSelection()">
                                <div class="service-option__content">
                                    <span class="service-option__icon">ðŸŒˆ</span>
                                    <span class="service-option__label">Folierung</span>
                                    <span class="service-option__desc">Car Wrapping, Design</span>
                                </div>
                            </label>

                            <!-- 11. Steinschutz -->
                            <label class="service-option">
                                <input type="radio" name="serviceArt" value="steinschutz" onchange="updateServiceSelection()">
                                <div class="service-option__content">
                                    <span class="service-option__icon">ðŸ›¡ï¸</span>
                                    <span class="service-option__label">Steinschutzfolie</span>
                                    <span class="service-option__desc">Lackschutz, PPF</span>
                                </div>
                            </label>

                            <!-- 12. Werbebeklebung -->
                            <label class="service-option">
                                <input type="radio" name="serviceArt" value="werbebeklebung" onchange="updateServiceSelection()">
                                <div class="service-option__content">
                                    <span class="service-option__icon">ðŸ“¢</span>
                                    <span class="service-option__label">Werbebeklebung</span>
                                    <span class="service-option__desc">Beschriftung, Logos</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="kalk-step-actions">
                        <button class="btn btn-secondary btn-lg" onclick="goToStep(1)">
                            <i data-feather="arrow-left"></i>
                            ZurÃ¼ck
                        </button>
                        <button class="btn btn-primary btn-lg" onclick="goToStep2Next()" id="btnStep2Next" disabled>
                            Weiter
                            <i data-feather="arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- STEP 2b: SERVICE-DETAILS (Dynamisch generiert) -->
            <!-- ============================================ -->
            <div class="kalk-step-content" id="stepContent2b" style="display: none;">
                <div class="content-card">
                    <div class="content-card__header">
                        <div class="content-card__title">
                            <i data-feather="settings"></i>
                            <h2>Schritt 2b: <span id="step2bServiceName">Service</span>-Details</h2>
                        </div>
                    </div>

                    <!-- ðŸ†• AUFTRAGSINFO BOX fÃ¼r Step 2b (Nov 30, 2025) -->
                    <div class="auftrags-info-box" id="step2bAuftragsInfo" style="display: none;">
                        <div class="auftrags-info-header">
                            <i data-feather="file-text"></i>
                            <strong>Auftragsinformationen</strong>
                            <button class="btn btn-sm btn-ghost" onclick="toggleAuftragsInfo('step2b')" id="auftragsInfoToggle2b">
                                <i data-feather="chevron-up"></i>
                            </button>
                        </div>
                        <div class="auftrags-info-content" id="auftragsInfoContent2b">
                            <div class="auftrags-info-grid">
                                <!-- Fahrzeug -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">ðŸš— Fahrzeug</div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Kennzeichen:</span>
                                        <span class="auftrags-info-value" id="info2bKennzeichen">-</span>
                                    </div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Fahrzeug:</span>
                                        <span class="auftrags-info-value" id="info2bFahrzeug">-</span>
                                    </div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Farbe:</span>
                                        <span class="auftrags-info-value" id="info2bFarbe">-</span>
                                    </div>
                                    <div class="auftrags-info-row" id="info2bKmStandRow">
                                        <span class="auftrags-info-label">KM-Stand:</span>
                                        <span class="auftrags-info-value" id="info2bKmStand">-</span>
                                    </div>
                                </div>

                                <!-- Kunde -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">ðŸ‘¤ Kunde</div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Name:</span>
                                        <span class="auftrags-info-value" id="info2bKunde">-</span>
                                    </div>
                                    <div class="auftrags-info-row" id="info2bPartnerRow" style="display: none;">
                                        <span class="auftrags-info-label">Partner:</span>
                                        <span class="auftrags-info-value" id="info2bPartner">-</span>
                                    </div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Datum:</span>
                                        <span class="auftrags-info-value" id="info2bDatum">-</span>
                                    </div>
                                </div>

                                <!-- Service -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">ðŸ”§ Service</div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Service-Art:</span>
                                        <span class="auftrags-info-value" id="info2bService">-</span>
                                    </div>
                                    <div class="auftrags-info-row" id="info2bDringlichkeitRow" style="display: none;">
                                        <span class="auftrags-info-label">Dringlichkeit:</span>
                                        <span class="auftrags-info-value" id="info2bDringlichkeit">-</span>
                                    </div>
                                </div>

                                <!-- ðŸ†• Termine (Nov 30, 2025) - Meister braucht diese Infos -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">ðŸ“… Termine</div>
                                    <div class="auftrags-info-row" id="info2bAnlieferterminRow">
                                        <span class="auftrags-info-label">Anlieferung:</span>
                                        <span class="auftrags-info-value" id="info2bAnliefertermin">-</span>
                                    </div>
                                    <div class="auftrags-info-row" id="info2bAbholterminRow">
                                        <span class="auftrags-info-label">Abholung:</span>
                                        <span class="auftrags-info-value" id="info2bAbholtermin">-</span>
                                    </div>
                                    <div class="auftrags-info-row" id="info2bErsatzfahrzeugRow">
                                        <span class="auftrags-info-label">Ersatzfahrzeug:</span>
                                        <span class="auftrags-info-value" id="info2bErsatzfahrzeug">-</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Schadensbeschreibung -->
                            <div class="auftrags-info-section auftrags-info-full" id="info2bSchadenSection" style="display: none;">
                                <div class="auftrags-info-section-title">ðŸ“ Schadensbeschreibung</div>
                                <div class="auftrags-info-schaden" id="info2bSchaden">-</div>
                            </div>

                            <!-- Notizen -->
                            <div class="auftrags-info-section auftrags-info-full" id="info2bNotizenSection" style="display: none;">
                                <div class="auftrags-info-section-title">ðŸ“‹ Notizen</div>
                                <div class="auftrags-info-notizen" id="info2bNotizen">-</div>
                            </div>

                            <!-- Service-Details pro Service -->
                            <div class="auftrags-info-section auftrags-info-full" id="info2bServiceDetailsSection" style="display: none;">
                                <div class="auftrags-info-section-title">ðŸ“¦ Service-Details</div>
                                <div class="auftrags-info-service-details" id="info2bServiceDetails">
                                    <!-- Dynamisch gefÃ¼llt -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ðŸ†• Fotos aus Entwurf/Annahme fÃ¼r Step 2b (Nov 30, 2025) -->
                    <div class="entwurf-photos-section" id="step2bPhotosSection" style="display: none;">
                        <div class="entwurf-photos-header">
                            <i data-feather="camera"></i>
                            <span>Fotos aus der Annahme</span>
                            <button class="btn btn-sm btn-secondary" onclick="togglePhotoGallery('step2b')">
                                <i data-feather="maximize-2"></i> Vollbild
                            </button>
                        </div>
                        <div class="entwurf-photos-gallery" id="step2bPhotosGallery">
                            <!-- Dynamisch gefÃ¼llt -->
                        </div>
                    </div>

                    <!-- Dynamisch generierte Zusatzfelder -->
                    <div class="service-details-form" id="serviceDetailsForm">
                        <!-- Wird dynamisch befÃ¼llt durch renderServiceDetails() -->
                    </div>

                    <!-- Design-Upload Preview (fÃ¼r Folierung/Werbebeklebung) -->
                    <div class="design-upload-preview" id="designUploadPreview" style="display: none;">
                        <div class="design-preview-header">
                            <i data-feather="image"></i>
                            <strong>Hochgeladene Designs</strong>
                        </div>
                        <div class="design-preview-grid" id="designPreviewGrid">
                            <!-- Wird dynamisch befÃ¼llt -->
                        </div>
                    </div>

                    <div class="kalk-step-actions">
                        <button class="btn btn-secondary btn-lg" onclick="goToStep2bBack()">
                            <i data-feather="arrow-left"></i>
                            ZurÃ¼ck
                        </button>
                        <button class="btn btn-primary btn-lg" onclick="goToStep2bNext()" id="btnStep2bNext">
                            Weiter
                            <i data-feather="arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- STEP 3: TEIL AUSWÃ„HLEN -->
            <!-- ============================================ -->
            <div class="kalk-step-content" id="stepContent3">
                <div class="content-card">
                    <div class="content-card__header">
                        <div class="content-card__title">
                            <i data-feather="crosshair"></i>
                            <h2>Schritt 3: BeschÃ¤digtes Teil wÃ¤hlen</h2>
                        </div>
                    </div>

                    <!-- ðŸ†• AUFTRAGSINFO BOX - Alle Infos aus Entwurf/Anfrage -->
                    <div class="auftrags-info-box" id="step3AuftragsInfo" style="display: none;">
                        <div class="auftrags-info-header">
                            <i data-feather="file-text"></i>
                            <strong>Auftragsinformationen</strong>
                            <button class="btn btn-sm btn-ghost" onclick="toggleAuftragsInfo()" id="auftragsInfoToggle">
                                <i data-feather="chevron-up"></i>
                            </button>
                        </div>
                        <div class="auftrags-info-content" id="auftragsInfoContent">
                            <div class="auftrags-info-grid">
                                <!-- Fahrzeug -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">ðŸš— Fahrzeug</div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Kennzeichen:</span>
                                        <span class="auftrags-info-value" id="infoKennzeichen">-</span>
                                    </div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Fahrzeug:</span>
                                        <span class="auftrags-info-value" id="infoFahrzeug">-</span>
                                    </div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Farbe:</span>
                                        <span class="auftrags-info-value" id="infoFarbe">-</span>
                                    </div>
                                </div>

                                <!-- Kunde -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">ðŸ‘¤ Kunde</div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Name:</span>
                                        <span class="auftrags-info-value" id="infoKunde">-</span>
                                    </div>
                                    <div class="auftrags-info-row" id="infoPartnerRow" style="display: none;">
                                        <span class="auftrags-info-label">Partner:</span>
                                        <span class="auftrags-info-value" id="infoPartner">-</span>
                                    </div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Datum:</span>
                                        <span class="auftrags-info-value" id="infoDatum">-</span>
                                    </div>
                                </div>

                                <!-- Service -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">ðŸ”§ Service</div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Service-Art:</span>
                                        <span class="auftrags-info-value" id="infoService">-</span>
                                    </div>
                                    <div class="auftrags-info-row" id="infoDringlichkeitRow" style="display: none;">
                                        <span class="auftrags-info-label">Dringlichkeit:</span>
                                        <span class="auftrags-info-value" id="infoDringlichkeit">-</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Schadensbeschreibung -->
                            <div class="auftrags-info-section auftrags-info-full" id="infoSchadenSection" style="display: none;">
                                <div class="auftrags-info-section-title">ðŸ“ Schadensbeschreibung</div>
                                <div class="auftrags-info-schaden" id="infoSchaden">-</div>
                            </div>

                            <!-- Notizen -->
                            <div class="auftrags-info-section auftrags-info-full" id="infoNotizenSection" style="display: none;">
                                <div class="auftrags-info-section-title">ðŸ“‹ Notizen</div>
                                <div class="auftrags-info-notizen" id="infoNotizen">-</div>
                            </div>

                            <!-- ðŸ†• Service-Details pro Service (Nov 30, 2025) -->
                            <div class="auftrags-info-section auftrags-info-full" id="infoServiceDetailsSection" style="display: none;">
                                <div class="auftrags-info-section-title">ðŸ“¦ Service-Details</div>
                                <div class="auftrags-info-service-details" id="infoServiceDetails">
                                    <!-- Dynamisch gefÃ¼llt -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ðŸ†• Fotos aus Entwurf/Annahme -->
                    <div class="entwurf-photos-section" id="step3PhotosSection" style="display: none;">
                        <div class="entwurf-photos-header">
                            <i data-feather="camera"></i>
                            <span>Fotos aus der Annahme</span>
                            <button class="btn btn-sm btn-secondary" onclick="togglePhotoGallery('step3')">
                                <i data-feather="maximize-2"></i> Vollbild
                            </button>
                        </div>
                        <div class="entwurf-photos-gallery" id="step3PhotosGallery">
                            <!-- Dynamisch gefÃ¼llt -->
                        </div>
                    </div>

                    <!-- ðŸ†• MULTI-SERVICE TABS (Nov 30, 2025) -->
                    <div id="step3ServiceTabs" class="service-tabs-container" style="display: none;">
                        <div class="service-tabs-header">
                            <span class="service-tabs-label">Services:</span>
                            <div class="service-tabs" id="step3ServiceTabsInner">
                                <!-- Dynamisch generiert -->
                            </div>
                        </div>
                        <div class="service-tabs-info">
                            <i data-feather="info"></i>
                            <span>WÃ¤hlen Sie Teile fÃ¼r jeden Service separat. Aktiver Service: <strong id="step3ActiveServiceName">-</strong></span>
                        </div>
                    </div>

                    <!-- Ansicht-Umschalter -->
                    <div class="view-toggle" style="margin: var(--space-4) 0; display: flex; justify-content: center; gap: var(--space-2); flex-wrap: wrap;">
                        <button class="view-toggle-btn" data-view="list" onclick="switchVehicleView('list')">
                            <i data-feather="list"></i> Service-Teile
                        </button>
                        <button class="view-toggle-btn active" data-view="2d" onclick="switchVehicleView('2d')">
                            <i data-feather="layout"></i> 2D Draufsicht
                        </button>
                        <button class="view-toggle-btn" data-view="3d" onclick="switchVehicleView('3d')">
                            <i data-feather="box"></i> 3D Modell
                        </button>
                        <button class="view-toggle-btn" data-view="foto" onclick="switchVehicleView('foto')" style="background: linear-gradient(135deg, var(--color-primary), #9333ea);">
                            <i data-feather="camera"></i> KI Foto-Analyse
                        </button>
                    </div>

                    <!-- Service-spezifische Teile-Liste (NEU) -->
                    <div id="vehicleListView" class="service-parts-list" style="display: none;">
                        <p class="service-parts-hint" style="text-align: center; margin-bottom: var(--space-4); color: var(--color-text-secondary);">
                            WÃ¤hlen Sie das betroffene Teil fÃ¼r <strong id="listServiceName">-</strong>:
                        </p>
                        <div id="servicePartsGrid" class="service-parts-grid">
                            <!-- Dynamisch generiert basierend auf SERVICE_CONFIG -->
                        </div>
                    </div>

                    <!-- 3D Sketchfab Viewer (versteckt by default) -->
                    <div id="vehicle3DView" class="vehicle-3d-container" style="display: none;">

                        <!-- Fahrzeugtyp-Auswahl -->
                        <div class="vehicle-type-selector" style="display: flex; justify-content: center; gap: var(--space-2); margin-bottom: var(--space-4); flex-wrap: wrap;">
                            <button class="vehicle-type-btn active" data-type="sedan" onclick="changeVehicleType('sedan')">
                                ðŸš— Limousine
                            </button>
                            <button class="vehicle-type-btn" data-type="suv" onclick="changeVehicleType('suv')">
                                ðŸš™ SUV
                            </button>
                            <button class="vehicle-type-btn" data-type="transporter" onclick="changeVehicleType('transporter')">
                                ðŸš Transporter
                            </button>
                            <button class="vehicle-type-btn" data-type="kombi" onclick="changeVehicleType('kombi')">
                                ðŸš• Kombi
                            </button>
                            <div class="ai-model-dropdown" style="position: relative; display: inline-block;">
                                <button class="vehicle-type-btn ai-btn" onclick="toggleAIDropdown()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-color: transparent; color: white;">
                                    ðŸ¤– KI-Modell
                                </button>
                                <div id="aiDropdown" class="ai-dropdown-content" style="display: none; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); background: var(--color-surface-elevated); border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--space-3); margin-top: var(--space-2); min-width: 280px; box-shadow: var(--shadow-lg); z-index: 100;">
                                    <p style="font-size: var(--font-size-xs); color: var(--color-text-secondary); margin: 0 0 var(--space-3) 0; text-align: center;">
                                        Erstelle 3D-Modelle aus Fotos mit KI:
                                    </p>
                                    <a href="https://huggingface.co/spaces/alexnasa/PartCrafter" target="_blank" class="ai-link" style="display: block; padding: var(--space-2); border-radius: var(--radius-sm); text-decoration: none; color: var(--color-text-primary); background: rgba(var(--color-primary-rgb), 0.1); margin-bottom: var(--space-2); font-size: var(--font-size-sm);">
                                        <strong>PartCrafter</strong> (MIT) - 4-16 separate Teile aus 1 Foto
                                    </a>
                                    <a href="https://huggingface.co/spaces/tencent/Hunyuan3D-Part" target="_blank" class="ai-link" style="display: block; padding: var(--space-2); border-radius: var(--radius-sm); text-decoration: none; color: var(--color-text-primary); background: rgba(var(--color-primary-rgb), 0.1); margin-bottom: var(--space-2); font-size: var(--font-size-sm);">
                                        <strong>Hunyuan3D-Part</strong> (Tencent) - Teile-Segmentierung
                                    </a>
                                    <a href="https://www.meshy.ai/" target="_blank" class="ai-link" style="display: block; padding: var(--space-2); border-radius: var(--radius-sm); text-decoration: none; color: var(--color-text-primary); background: rgba(var(--color-primary-rgb), 0.1); font-size: var(--font-size-sm);">
                                        <strong>Meshy AI</strong> (Free-Tier) - Schnelle 3D-Generierung
                                    </a>
                                </div>
                            </div>
                        </div>

                        <div class="sketchfab-embed-wrapper">
                            <!-- Sketchfab Viewer API Container -->
                            <div id="sketchfabApiContainer" style="width: 100%; height: 450px; border-radius: var(--radius-card); overflow: hidden; background: var(--color-surface-elevated); position: relative;">
                                <div id="sketchfabLoading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                    <div class="spinner" style="width: 40px; height: 40px; border: 3px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px;"></div>
                                    <p style="color: var(--color-text-secondary); font-size: var(--font-size-sm);">3D-Modell wird geladen...</p>
                                </div>
                            </div>
                            <p id="sketchfabCredit" class="sketchfab-credit" style="font-size: 11px; color: var(--color-text-secondary); text-align: center; margin-top: var(--space-2);">
                                3D-Modell: <a id="modelLink" href="https://sketchfab.com/3d-models/generic-sedan-car-58c33766470d46e7b2aed542650494e5" target="_blank" style="color: var(--color-primary);">Generic Sedan Car</a> von <span id="modelAuthor">MMC Works</span> (CC BY)
                            </p>
                        </div>

                        <!-- Klick-Hinweis -->
                        <div id="clickHint" style="text-align: center; margin: var(--space-4) 0; padding: var(--space-3); background: rgba(var(--color-primary-rgb), 0.1); border-radius: var(--radius-md); display: none;">
                            <p style="margin: 0; font-size: var(--font-size-sm); color: var(--color-primary);">
                                <i data-feather="mouse-pointer" style="width: 14px; height: 14px; vertical-align: middle;"></i>
                                <strong>Tipp:</strong> Klicken Sie direkt auf das 3D-Modell, um ein Teil auszuwÃ¤hlen!
                            </p>
                        </div>

                        <!-- Geklicktes Teil Anzeige -->
                        <div id="clickedPartInfo" style="display: none; text-align: center; margin-bottom: var(--space-4); padding: var(--space-3); background: var(--color-success-bg); border: 1px solid var(--color-success); border-radius: var(--radius-md);">
                            <p style="margin: 0; font-size: var(--font-size-sm); color: var(--color-success);">
                                <i data-feather="check-circle" style="width: 14px; height: 14px; vertical-align: middle;"></i>
                                AusgewÃ¤hlt: <strong id="clickedPartName">-</strong>
                            </p>
                        </div>

                        <!-- 3D Teil-Auswahl Buttons (Fallback) -->
                        <div class="part-buttons-3d" style="display: flex; flex-wrap: wrap; gap: var(--space-2); justify-content: center; margin-top: var(--space-4);">
                            <span style="width: 100%; text-align: center; font-size: var(--font-size-xs); color: var(--color-text-secondary); margin-bottom: var(--space-2);">Oder wÃ¤hlen Sie manuell:</span>
                            <button class="part-btn-3d" onclick="select3DPart('StoÃŸfÃ¤nger vorne')">StoÃŸfÃ¤nger V</button>
                            <button class="part-btn-3d" onclick="select3DPart('Motorhaube')">Motorhaube</button>
                            <button class="part-btn-3d" onclick="select3DPart('KotflÃ¼gel vorne links')">KotflÃ¼gel VL</button>
                            <button class="part-btn-3d" onclick="select3DPart('KotflÃ¼gel vorne rechts')">KotflÃ¼gel VR</button>
                            <button class="part-btn-3d" onclick="select3DPart('TÃ¼r vorne links')">TÃ¼r VL</button>
                            <button class="part-btn-3d" onclick="select3DPart('TÃ¼r vorne rechts')">TÃ¼r VR</button>
                            <button class="part-btn-3d" onclick="select3DPart('TÃ¼r hinten links')">TÃ¼r HL</button>
                            <button class="part-btn-3d" onclick="select3DPart('TÃ¼r hinten rechts')">TÃ¼r HR</button>
                            <button class="part-btn-3d" onclick="select3DPart('Dach')">Dach</button>
                            <button class="part-btn-3d" onclick="select3DPart('Heckklappe')">Heckklappe</button>
                            <button class="part-btn-3d" onclick="select3DPart('StoÃŸfÃ¤nger hinten')">StoÃŸfÃ¤nger H</button>
                            <button class="part-btn-3d" onclick="select3DPart('Seitenteil links')">Seitenteil L</button>
                            <button class="part-btn-3d" onclick="select3DPart('Seitenteil rechts')">Seitenteil R</button>
                        </div>
                    </div>

                    <!-- 2D SVG Diagramm (default sichtbar) -->
                    <div id="vehicle2DView" class="vehicle-diagram">
                        <svg class="vehicle-svg" viewBox="0 0 520 340" preserveAspectRatio="xMidYMid meet">
                            <!-- ================================================== -->
                            <!-- DETAILLIERTE 2D DRAUFSICHT - Limousine/Kombi       -->
                            <!-- ================================================== -->

                            <defs>
                                <!-- Gradient fÃ¼r Scheiben -->
                                <linearGradient id="glassGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#87CEEB;stop-opacity:0.6"/>
                                    <stop offset="100%" style="stop-color:#4682B4;stop-opacity:0.4"/>
                                </linearGradient>
                                <!-- Gradient fÃ¼r Reifen -->
                                <radialGradient id="tireGradient" cx="50%" cy="50%" r="50%">
                                    <stop offset="0%" style="stop-color:#555"/>
                                    <stop offset="70%" style="stop-color:#333"/>
                                    <stop offset="100%" style="stop-color:#1a1a1a"/>
                                </radialGradient>
                                <!-- Gradient fÃ¼r Felgen -->
                                <radialGradient id="rimGradient" cx="50%" cy="50%" r="50%">
                                    <stop offset="0%" style="stop-color:#e8e8e8"/>
                                    <stop offset="100%" style="stop-color:#a0a0a0"/>
                                </radialGradient>
                                <!-- Schatten -->
                                <filter id="dropShadow" x="-20%" y="-20%" width="140%" height="140%">
                                    <feGaussianBlur in="SourceAlpha" stdDeviation="3"/>
                                    <feOffset dx="2" dy="2" result="offsetblur"/>
                                    <feComponentTransfer>
                                        <feFuncA type="linear" slope="0.3"/>
                                    </feComponentTransfer>
                                    <feMerge>
                                        <feMergeNode/>
                                        <feMergeNode in="SourceGraphic"/>
                                    </feMerge>
                                </filter>
                            </defs>

                            <!-- Hintergrund mit Schatten des Fahrzeugs -->
                            <ellipse cx="250" cy="165" rx="180" ry="130" fill="rgba(0,0,0,0.08)" filter="url(#dropShadow)"/>

                            <!-- ========== RÃ„DER / REIFEN ========== -->

                            <!-- Rad vorne links (auÃŸen sichtbar) -->
                            <g class="vehicle-part vehicle-part--wheel" id="part-rad-vl" data-part="Rad vorne links" data-keywords="rad,reifen,felge,vorne,links">
                                <ellipse cx="95" cy="85" rx="28" ry="20" fill="url(#tireGradient)" stroke="#222" stroke-width="2"/>
                                <ellipse cx="95" cy="85" rx="16" ry="11" fill="url(#rimGradient)" stroke="#888" stroke-width="1"/>
                                <circle cx="95" cy="85" r="4" fill="#666"/>
                                <!-- Felgen-Speichen -->
                                <line x1="95" y1="74" x2="95" y2="96" stroke="#999" stroke-width="1.5"/>
                                <line x1="81" y1="85" x2="109" y2="85" stroke="#999" stroke-width="1.5"/>
                            </g>

                            <!-- Rad vorne rechts -->
                            <g class="vehicle-part vehicle-part--wheel" id="part-rad-vr" data-part="Rad vorne rechts" data-keywords="rad,reifen,felge,vorne,rechts">
                                <ellipse cx="405" cy="85" rx="28" ry="20" fill="url(#tireGradient)" stroke="#222" stroke-width="2"/>
                                <ellipse cx="405" cy="85" rx="16" ry="11" fill="url(#rimGradient)" stroke="#888" stroke-width="1"/>
                                <circle cx="405" cy="85" r="4" fill="#666"/>
                                <line x1="405" y1="74" x2="405" y2="96" stroke="#999" stroke-width="1.5"/>
                                <line x1="391" y1="85" x2="419" y2="85" stroke="#999" stroke-width="1.5"/>
                            </g>

                            <!-- Rad hinten links -->
                            <g class="vehicle-part vehicle-part--wheel" id="part-rad-hl" data-part="Rad hinten links" data-keywords="rad,reifen,felge,hinten,links">
                                <ellipse cx="95" cy="245" rx="28" ry="20" fill="url(#tireGradient)" stroke="#222" stroke-width="2"/>
                                <ellipse cx="95" cy="245" rx="16" ry="11" fill="url(#rimGradient)" stroke="#888" stroke-width="1"/>
                                <circle cx="95" cy="245" r="4" fill="#666"/>
                                <line x1="95" y1="234" x2="95" y2="256" stroke="#999" stroke-width="1.5"/>
                                <line x1="81" y1="245" x2="109" y2="245" stroke="#999" stroke-width="1.5"/>
                            </g>

                            <!-- Rad hinten rechts -->
                            <g class="vehicle-part vehicle-part--wheel" id="part-rad-hr" data-part="Rad hinten rechts" data-keywords="rad,reifen,felge,hinten,rechts">
                                <ellipse cx="405" cy="245" rx="28" ry="20" fill="url(#tireGradient)" stroke="#222" stroke-width="2"/>
                                <ellipse cx="405" cy="245" rx="16" ry="11" fill="url(#rimGradient)" stroke="#888" stroke-width="1"/>
                                <circle cx="405" cy="245" r="4" fill="#666"/>
                                <line x1="405" y1="234" x2="405" y2="256" stroke="#999" stroke-width="1.5"/>
                                <line x1="391" y1="245" x2="419" y2="245" stroke="#999" stroke-width="1.5"/>
                            </g>

                            <!-- ========== KAROSSERIE OUTLINE ========== -->

                            <!-- Fahrzeug-Grundform (Schatten/Kontur) -->
                            <path class="vehicle-body-outline"
                                  d="M 130,25
                                     Q 145,18 250,18 Q 355,18 370,25
                                     L 385,35 Q 400,45 410,65 L 420,95
                                     L 422,115 L 422,215 L 420,235
                                     Q 410,285 385,295 L 370,305
                                     Q 355,312 250,312 Q 145,312 130,305
                                     L 115,295 Q 90,285 80,235
                                     L 78,215 L 78,115 L 80,95
                                     Q 90,45 115,35 Z"
                                  fill="none" stroke="var(--color-border)" stroke-width="1" opacity="0.5"/>

                            <!-- ========== STOÃŸFÃ„NGER VORNE ========== -->
                            <path class="vehicle-part" id="part-stossfaenger-vorne"
                                  d="M 130,25 Q 145,18 250,18 Q 355,18 370,25 L 385,35 Q 395,42 400,55 L 100,55 Q 105,42 115,35 Z"
                                  data-part="StoÃŸfÃ¤nger vorne" data-keywords="stossfaenger,vorne,front,bumper"/>
                            <text class="vehicle-part-label" x="250" y="40">StoÃŸfÃ¤nger vorne</text>

                            <!-- KÃ¼hlergrill -->
                            <rect x="175" y="28" width="150" height="12" rx="3" fill="rgba(0,0,0,0.2)" stroke="none"/>
                            <line x1="200" y1="28" x2="200" y2="40" stroke="rgba(0,0,0,0.3)" stroke-width="1"/>
                            <line x1="225" y1="28" x2="225" y2="40" stroke="rgba(0,0,0,0.3)" stroke-width="1"/>
                            <line x1="250" y1="28" x2="250" y2="40" stroke="rgba(0,0,0,0.3)" stroke-width="1"/>
                            <line x1="275" y1="28" x2="275" y2="40" stroke="rgba(0,0,0,0.3)" stroke-width="1"/>
                            <line x1="300" y1="28" x2="300" y2="40" stroke="rgba(0,0,0,0.3)" stroke-width="1"/>

                            <!-- Scheinwerfer vorne links -->
                            <path class="vehicle-part vehicle-part--light" id="part-scheinwerfer-vl"
                                  d="M 105,42 Q 115,35 130,35 L 145,42 L 145,55 L 105,55 Z"
                                  data-part="Scheinwerfer vorne links" data-keywords="scheinwerfer,licht,vorne,links"/>
                            <ellipse cx="125" cy="48" rx="12" ry="5" fill="rgba(255,255,200,0.6)" stroke="rgba(0,0,0,0.2)"/>

                            <!-- Scheinwerfer vorne rechts -->
                            <path class="vehicle-part vehicle-part--light" id="part-scheinwerfer-vr"
                                  d="M 355,55 L 355,42 L 370,35 Q 385,35 395,42 L 395,55 Z"
                                  data-part="Scheinwerfer vorne rechts" data-keywords="scheinwerfer,licht,vorne,rechts"/>
                            <ellipse cx="375" cy="48" rx="12" ry="5" fill="rgba(255,255,200,0.6)" stroke="rgba(0,0,0,0.2)"/>

                            <!-- ========== MOTORHAUBE ========== -->
                            <path class="vehicle-part" id="part-motorhaube"
                                  d="M 100,55 L 400,55 Q 408,55 415,70 L 420,95 L 80,95 L 85,70 Q 92,55 100,55 Z"
                                  data-part="Motorhaube" data-keywords="motorhaube,haube,hood,motor"/>
                            <text class="vehicle-part-label" x="250" y="78">Motorhaube</text>
                            <!-- Motorhauben-Kontur -->
                            <line x1="250" y1="58" x2="250" y2="92" stroke="rgba(0,0,0,0.1)" stroke-width="1"/>

                            <!-- ========== KOTFLÃœGEL VORNE ========== -->

                            <!-- KotflÃ¼gel vorne links -->
                            <path class="vehicle-part" id="part-kotfluegel-vl"
                                  d="M 80,55 L 100,55 Q 92,55 85,70 L 80,95 L 78,115 L 68,115
                                     Q 60,105 60,85 Q 60,65 68,55 Z"
                                  data-part="KotflÃ¼gel vorne links" data-keywords="kotfluegel,vorne,links,fender"/>
                            <text class="vehicle-part-label" x="78" y="88" style="font-size: 9px;">KF VL</text>

                            <!-- KotflÃ¼gel vorne rechts -->
                            <path class="vehicle-part" id="part-kotfluegel-vr"
                                  d="M 400,55 L 420,55 Q 432,55 440,65 Q 440,85 440,105 L 432,115 L 422,115
                                     L 420,95 L 415,70 Q 408,55 400,55 Z"
                                  data-part="KotflÃ¼gel vorne rechts" data-keywords="kotfluegel,vorne,rechts,fender"/>
                            <text class="vehicle-part-label" x="422" y="88" style="font-size: 9px;">KF VR</text>

                            <!-- ========== A-SÃ„ULEN ========== -->

                            <!-- A-SÃ¤ule links -->
                            <path class="vehicle-part vehicle-part--pillar" id="part-a-saeule-l"
                                  d="M 78,95 L 105,95 L 115,115 L 78,115 Z"
                                  data-part="A-SÃ¤ule links" data-keywords="saeule,a-saeule,links,pillar"/>

                            <!-- A-SÃ¤ule rechts -->
                            <path class="vehicle-part vehicle-part--pillar" id="part-a-saeule-r"
                                  d="M 395,95 L 422,95 L 422,115 L 385,115 Z"
                                  data-part="A-SÃ¤ule rechts" data-keywords="saeule,a-saeule,rechts,pillar"/>

                            <!-- ========== FRONTSCHEIBE ========== -->
                            <path class="vehicle-part vehicle-part--glass" id="part-frontscheibe"
                                  d="M 115,95 L 385,95 L 385,115 L 360,130 L 140,130 L 115,115 Z"
                                  data-part="Frontscheibe" data-keywords="frontscheibe,windschutzscheibe,scheibe,glas"/>
                            <text class="vehicle-part-label vehicle-part-label--glass" x="250" y="115">Frontscheibe</text>

                            <!-- ========== TÃœREN VORNE ========== -->

                            <!-- TÃ¼r vorne links -->
                            <path class="vehicle-part" id="part-tuer-vl"
                                  d="M 68,115 L 115,115 L 140,130 L 140,175 L 68,175 Z"
                                  data-part="TÃ¼r vorne links" data-keywords="tuer,vorne,links,fahrer,door"/>
                            <text class="vehicle-part-label" x="100" y="150" style="font-size: 10px;">TÃ¼r VL</text>
                            <!-- TÃ¼rgriff -->
                            <rect x="100" y="155" width="25" height="6" rx="2" fill="rgba(0,0,0,0.15)"/>

                            <!-- TÃ¼r vorne rechts -->
                            <path class="vehicle-part" id="part-tuer-vr"
                                  d="M 385,115 L 432,115 L 432,175 L 360,175 L 360,130 Z"
                                  data-part="TÃ¼r vorne rechts" data-keywords="tuer,vorne,rechts,beifahrer,door"/>
                            <text class="vehicle-part-label" x="400" y="150" style="font-size: 10px;">TÃ¼r VR</text>
                            <!-- TÃ¼rgriff -->
                            <rect x="375" y="155" width="25" height="6" rx="2" fill="rgba(0,0,0,0.15)"/>

                            <!-- ========== SEITENSCHEIBEN VORNE ========== -->

                            <!-- Seitenscheibe vorne links -->
                            <path class="vehicle-part vehicle-part--glass" id="part-seitenscheibe-vl"
                                  d="M 78,118 L 112,118 L 137,132 L 137,165 L 78,165 Z"
                                  data-part="Seitenscheibe vorne links" data-keywords="seitenscheibe,scheibe,vorne,links,glas"/>

                            <!-- Seitenscheibe vorne rechts -->
                            <path class="vehicle-part vehicle-part--glass" id="part-seitenscheibe-vr"
                                  d="M 388,118 L 422,118 L 422,165 L 363,165 L 363,132 Z"
                                  data-part="Seitenscheibe vorne rechts" data-keywords="seitenscheibe,scheibe,vorne,rechts,glas"/>

                            <!-- ========== SPIEGEL ========== -->

                            <!-- Seitenspiegel links -->
                            <g class="vehicle-part" id="part-spiegel-l" data-part="Seitenspiegel links" data-keywords="spiegel,aussenspiegel,links,mirror">
                                <ellipse cx="55" cy="125" rx="14" ry="10" fill="var(--color-surface)" stroke="var(--color-border)" stroke-width="1.5"/>
                                <ellipse cx="55" cy="125" rx="10" ry="7" fill="url(#glassGradient)"/>
                            </g>

                            <!-- Seitenspiegel rechts -->
                            <g class="vehicle-part" id="part-spiegel-r" data-part="Seitenspiegel rechts" data-keywords="spiegel,aussenspiegel,rechts,mirror">
                                <ellipse cx="445" cy="125" rx="14" ry="10" fill="var(--color-surface)" stroke="var(--color-border)" stroke-width="1.5"/>
                                <ellipse cx="445" cy="125" rx="10" ry="7" fill="url(#glassGradient)"/>
                            </g>

                            <!-- ========== B-SÃ„ULEN ========== -->

                            <!-- B-SÃ¤ule links -->
                            <path class="vehicle-part vehicle-part--pillar" id="part-b-saeule-l"
                                  d="M 68,175 L 140,175 L 140,185 L 68,185 Z"
                                  data-part="B-SÃ¤ule links" data-keywords="saeule,b-saeule,links,pillar"/>

                            <!-- B-SÃ¤ule rechts -->
                            <path class="vehicle-part vehicle-part--pillar" id="part-b-saeule-r"
                                  d="M 360,175 L 432,175 L 432,185 L 360,185 Z"
                                  data-part="B-SÃ¤ule rechts" data-keywords="saeule,b-saeule,rechts,pillar"/>

                            <!-- ========== TÃœREN HINTEN ========== -->

                            <!-- TÃ¼r hinten links -->
                            <path class="vehicle-part" id="part-tuer-hl"
                                  d="M 68,185 L 140,185 L 140,230 L 68,230 Z"
                                  data-part="TÃ¼r hinten links" data-keywords="tuer,hinten,links,fond,door"/>
                            <text class="vehicle-part-label" x="100" y="212" style="font-size: 10px;">TÃ¼r HL</text>
                            <!-- TÃ¼rgriff -->
                            <rect x="100" y="200" width="25" height="6" rx="2" fill="rgba(0,0,0,0.15)"/>

                            <!-- TÃ¼r hinten rechts -->
                            <path class="vehicle-part" id="part-tuer-hr"
                                  d="M 360,185 L 432,185 L 432,230 L 360,230 Z"
                                  data-part="TÃ¼r hinten rechts" data-keywords="tuer,hinten,rechts,fond,door"/>
                            <text class="vehicle-part-label" x="400" y="212" style="font-size: 10px;">TÃ¼r HR</text>
                            <!-- TÃ¼rgriff -->
                            <rect x="375" y="200" width="25" height="6" rx="2" fill="rgba(0,0,0,0.15)"/>

                            <!-- ========== SEITENSCHEIBEN HINTEN ========== -->

                            <!-- Seitenscheibe hinten links -->
                            <path class="vehicle-part vehicle-part--glass" id="part-seitenscheibe-hl"
                                  d="M 78,188 L 137,188 L 137,225 L 78,225 Z"
                                  data-part="Seitenscheibe hinten links" data-keywords="seitenscheibe,scheibe,hinten,links,glas"/>

                            <!-- Seitenscheibe hinten rechts -->
                            <path class="vehicle-part vehicle-part--glass" id="part-seitenscheibe-hr"
                                  d="M 363,188 L 422,188 L 422,225 L 363,225 Z"
                                  data-part="Seitenscheibe hinten rechts" data-keywords="seitenscheibe,scheibe,hinten,rechts,glas"/>

                            <!-- ========== DACH ========== -->
                            <path class="vehicle-part" id="part-dach"
                                  d="M 140,130 L 360,130 L 360,230 L 140,230 Z"
                                  data-part="Dach" data-keywords="dach,roof,panorama"/>
                            <text class="vehicle-part-label" x="250" y="183">Dach</text>
                            <!-- Dachreling (optional) -->
                            <line x1="145" y1="135" x2="145" y2="225" stroke="rgba(0,0,0,0.1)" stroke-width="3"/>
                            <line x1="355" y1="135" x2="355" y2="225" stroke="rgba(0,0,0,0.1)" stroke-width="3"/>

                            <!-- ========== C-SÃ„ULEN ========== -->

                            <!-- C-SÃ¤ule links -->
                            <path class="vehicle-part vehicle-part--pillar" id="part-c-saeule-l"
                                  d="M 68,230 L 140,230 L 140,245 L 115,245 L 68,235 Z"
                                  data-part="C-SÃ¤ule links" data-keywords="saeule,c-saeule,links,pillar"/>

                            <!-- C-SÃ¤ule rechts -->
                            <path class="vehicle-part vehicle-part--pillar" id="part-c-saeule-r"
                                  d="M 360,230 L 432,230 L 432,235 L 385,245 L 360,245 Z"
                                  data-part="C-SÃ¤ule rechts" data-keywords="saeule,c-saeule,rechts,pillar"/>

                            <!-- ========== HECKSCHEIBE ========== -->
                            <path class="vehicle-part vehicle-part--glass" id="part-heckscheibe"
                                  d="M 140,230 L 360,230 L 385,245 L 385,265 L 115,265 L 115,245 Z"
                                  data-part="Heckscheibe" data-keywords="heckscheibe,scheibe,hinten,glas"/>
                            <text class="vehicle-part-label vehicle-part-label--glass" x="250" y="252">Heckscheibe</text>

                            <!-- ========== SEITENTEILE / KOTFLÃœGEL HINTEN ========== -->

                            <!-- Seitenteil links -->
                            <path class="vehicle-part" id="part-seitenteil-l"
                                  d="M 60,230 L 68,230 L 68,265 L 78,285 L 60,285 Q 55,275 55,260 L 55,245 Q 55,235 60,230 Z"
                                  data-part="Seitenteil links" data-keywords="seitenteil,kotfluegel,hinten,links,fender"/>
                            <text class="vehicle-part-label" x="68" y="260" style="font-size: 8px;">ST L</text>

                            <!-- Seitenteil rechts -->
                            <path class="vehicle-part" id="part-seitenteil-r"
                                  d="M 432,230 L 440,230 Q 445,235 445,245 L 445,260 Q 445,275 440,285 L 422,285 L 432,265 Z"
                                  data-part="Seitenteil rechts" data-keywords="seitenteil,kotfluegel,hinten,rechts,fender"/>
                            <text class="vehicle-part-label" x="432" y="260" style="font-size: 8px;">ST R</text>

                            <!-- ========== HECKKLAPPE / KOFFERRAUM ========== -->
                            <path class="vehicle-part" id="part-heckklappe"
                                  d="M 78,265 L 422,265 L 422,285 L 400,295 L 100,295 L 78,285 Z"
                                  data-part="Heckklappe" data-keywords="heckklappe,kofferraum,kofferraumdeckel,heck,trunk"/>
                            <text class="vehicle-part-label" x="250" y="283">Heckklappe</text>

                            <!-- Kennzeichen-Mulde hinten -->
                            <rect x="200" y="272" width="100" height="18" rx="2" fill="rgba(255,255,255,0.3)" stroke="rgba(0,0,0,0.2)"/>

                            <!-- ========== RÃœCKLICHTER ========== -->

                            <!-- RÃ¼cklicht links -->
                            <path class="vehicle-part vehicle-part--light" id="part-ruecklicht-l"
                                  d="M 78,270 L 115,270 L 115,290 L 85,290 Q 78,290 78,282 Z"
                                  data-part="RÃ¼cklicht links" data-keywords="ruecklicht,licht,hinten,links"/>
                            <rect x="85" y="275" width="25" height="10" rx="2" fill="rgba(255,0,0,0.5)"/>

                            <!-- RÃ¼cklicht rechts -->
                            <path class="vehicle-part vehicle-part--light" id="part-ruecklicht-r"
                                  d="M 385,270 L 422,270 L 422,282 Q 422,290 415,290 L 385,290 Z"
                                  data-part="RÃ¼cklicht rechts" data-keywords="ruecklicht,licht,hinten,rechts"/>
                            <rect x="390" y="275" width="25" height="10" rx="2" fill="rgba(255,0,0,0.5)"/>

                            <!-- ========== STOÃŸFÃ„NGER HINTEN ========== -->
                            <path class="vehicle-part" id="part-stossfaenger-hinten"
                                  d="M 85,295 L 415,295 Q 395,305 380,310 Q 300,315 250,315 Q 200,315 120,310 Q 105,305 85,295 Z"
                                  data-part="StoÃŸfÃ¤nger hinten" data-keywords="stossfaenger,hinten,heck,bumper"/>
                            <text class="vehicle-part-label" x="250" y="308">StoÃŸfÃ¤nger hinten</text>

                            <!-- Auspuff-Blenden -->
                            <ellipse cx="140" cy="305" rx="12" ry="6" fill="rgba(50,50,50,0.6)" stroke="#444"/>
                            <ellipse cx="360" cy="305" rx="12" ry="6" fill="rgba(50,50,50,0.6)" stroke="#444"/>

                            <!-- ========== SCHWELLER ========== -->

                            <!-- Schweller links -->
                            <rect class="vehicle-part" id="part-schweller-l"
                                  x="55" y="115" width="13" height="115" rx="3"
                                  data-part="Schweller links" data-keywords="schweller,seitenschweller,links,sill"/>

                            <!-- Schweller rechts -->
                            <rect class="vehicle-part" id="part-schweller-r"
                                  x="432" y="115" width="13" height="115" rx="3"
                                  data-part="Schweller rechts" data-keywords="schweller,seitenschweller,rechts,sill"/>

                        </svg>
                    </div><!-- Ende vehicle2DView -->

                    <!-- KI Foto-Analyse View -->
                    <div id="vehicleFotoView" class="foto-analyse-view" style="display: none;">

                        <!-- ðŸ†• Vorhandene Fotos aus Entwurf/Anfrage -->
                        <div id="entwurfFotosSection" class="entwurf-fotos-ki-section" style="display: none;">
                            <div class="entwurf-fotos-ki-header">
                                <i data-feather="image"></i>
                                <h4>Fotos aus der Annahme auswÃ¤hlen</h4>
                                <span class="badge badge--success" id="selectedFotosCount">0 ausgewÃ¤hlt</span>
                            </div>
                            <p class="entwurf-fotos-ki-hint">WÃ¤hlen Sie die Fotos aus, die von der KI analysiert werden sollen:</p>

                            <div class="entwurf-fotos-ki-grid" id="entwurfFotosGrid">
                                <!-- Dynamisch gefÃ¼llt mit Fotos aus kalkWizardData.entwurfPhotos -->
                            </div>

                            <div class="entwurf-fotos-ki-actions">
                                <button class="btn btn-secondary btn-sm" onclick="selectAllEntwurfFotos()">
                                    <i data-feather="check-square"></i> Alle auswÃ¤hlen
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="deselectAllEntwurfFotos()">
                                    <i data-feather="square"></i> Keine auswÃ¤hlen
                                </button>
                            </div>

                            <div style="margin-top: var(--space-4); text-align: center;">
                                <button class="btn btn-primary btn-lg" onclick="analyzeSelectedEntwurfFotos()" id="btnAnalyzeEntwurfFotos">
                                    <i data-feather="cpu"></i>
                                    KI-Analyse starten
                                </button>
                            </div>

                            <div class="entwurf-fotos-ki-divider">
                                <span>oder</span>
                            </div>
                        </div>

                        <!-- Upload fÃ¼r neue/zusÃ¤tzliche Fotos -->
                        <div class="foto-analyse-container" id="fotoDropzone" onclick="document.getElementById('fotoInput').click()">
                            <i data-feather="upload"></i>
                            <h4 id="fotoUploadTitle">Weitere Fotos hochladen</h4>
                            <p>Klicken oder Fotos hierher ziehen</p>
                            <p class="text-muted" style="font-size: var(--font-size-xs);">Die KI analysiert die Bilder und erkennt automatisch SchÃ¤den</p>
                            <input type="file" id="fotoInput" accept="image/*" multiple style="display: none;" onchange="handleFotoUpload(this.files)">
                        </div>

                        <div class="foto-analyse-preview" id="fotoPreview"></div>

                        <div id="kiAnalyseResult" class="ki-analyse-result" style="display: none;">
                            <div class="ki-analyse-result__header">
                                <i data-feather="cpu"></i>
                                <h4>KI-Schadensanalyse</h4>
                                <span class="badge badge--info">GPT-4 Vision</span>
                            </div>
                            <div class="ki-schaeden-liste" id="kiSchaedenListe">
                                <!-- Wird dynamisch gefÃ¼llt -->
                            </div>
                            <div style="margin-top: var(--space-4); text-align: center;">
                                <button class="btn btn-primary" onclick="applyKISchaeden()">
                                    <i data-feather="check"></i>
                                    Erkannte SchÃ¤den Ã¼bernehmen
                                </button>
                            </div>
                        </div>

                        <div id="kiAnalyseLoading" style="display: none; text-align: center; padding: var(--space-8);">
                            <div class="spinner" style="margin: 0 auto var(--space-4);"></div>
                            <p>KI analysiert die Bilder...</p>
                        </div>
                    </div>

                    <!-- AusgewÃ¤hltes Teil Anzeige -->
                    <div class="kalk-selected-part" id="selectedPartDisplay" style="display: none;">
                        <div class="kalk-selected-part__icon">âœ“</div>
                        <div class="kalk-selected-part__info">
                            <strong>AusgewÃ¤hltes Teil:</strong>
                            <span id="selectedPartName">-</span>
                        </div>
                        <button class="btn btn-sm btn-secondary" onclick="clearSelectedPart()">
                            <i data-feather="x"></i>
                        </button>
                    </div>

                    <!-- AusgewÃ¤hlte Teile Liste (fÃ¼r mehrere Teile) -->
                    <div class="kalk-parts-list" id="selectedPartsList" style="display: none;">
                        <h4>AusgewÃ¤hlte Teile:</h4>
                        <div id="partsListContent"></div>
                    </div>

                    <div class="kalk-step-actions">
                        <button class="btn btn-secondary btn-lg" onclick="goToStep3Back()">
                            <i data-feather="arrow-left"></i>
                            ZurÃ¼ck
                        </button>
                        <button class="btn btn-primary btn-lg" onclick="goToStep(4)" id="btnStep3Next" disabled>
                            Weiter zu Reparaturart
                            <i data-feather="arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- STEP 4: REPARATURART WÃ„HLEN -->
            <!-- ============================================ -->
            <div class="kalk-step-content" id="stepContent4">
                <div class="content-card">
                    <div class="content-card__header">
                        <div class="content-card__title">
                            <i data-feather="settings"></i>
                            <h2>Schritt 4: Reparaturart wÃ¤hlen</h2>
                        </div>
                    </div>

                    <!-- ðŸ†• Nov 30, 2025: AUFTRAGSINFO BOX - Kopie von Step 3 -->
                    <div class="auftrags-info-box" id="step4AuftragsInfo" style="display: none;">
                        <div class="auftrags-info-header">
                            <i data-feather="file-text"></i>
                            <strong>Auftragsinformationen</strong>
                            <button class="btn btn-sm btn-ghost" onclick="toggleAuftragsInfo('step4')" id="auftragsInfoToggle4">
                                <i data-feather="chevron-up"></i>
                            </button>
                        </div>
                        <div class="auftrags-info-content" id="auftragsInfoContent4">
                            <div class="auftrags-info-grid">
                                <!-- Fahrzeug -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">ðŸš— Fahrzeug</div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Kennzeichen:</span>
                                        <span class="auftrags-info-value" id="info4Kennzeichen">-</span>
                                    </div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Fahrzeug:</span>
                                        <span class="auftrags-info-value" id="info4Fahrzeug">-</span>
                                    </div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Farbe:</span>
                                        <span class="auftrags-info-value" id="info4Farbe">-</span>
                                    </div>
                                </div>

                                <!-- Kunde -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">ðŸ‘¤ Kunde</div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Name:</span>
                                        <span class="auftrags-info-value" id="info4Kunde">-</span>
                                    </div>
                                    <div class="auftrags-info-row" id="info4PartnerRow" style="display: none;">
                                        <span class="auftrags-info-label">Partner:</span>
                                        <span class="auftrags-info-value" id="info4Partner">-</span>
                                    </div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Datum:</span>
                                        <span class="auftrags-info-value" id="info4Datum">-</span>
                                    </div>
                                </div>

                                <!-- Service -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">ðŸ”§ Service</div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Service-Art:</span>
                                        <span class="auftrags-info-value" id="info4Service">-</span>
                                    </div>
                                    <div class="auftrags-info-row" id="info4DringlichkeitRow" style="display: none;">
                                        <span class="auftrags-info-label">Dringlichkeit:</span>
                                        <span class="auftrags-info-value" id="info4Dringlichkeit">-</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Schadensbeschreibung -->
                            <div class="auftrags-info-section auftrags-info-full" id="info4SchadenSection" style="display: none;">
                                <div class="auftrags-info-section-title">ðŸ“ Schadensbeschreibung</div>
                                <div class="auftrags-info-schaden" id="info4Schaden">-</div>
                            </div>

                            <!-- Notizen -->
                            <div class="auftrags-info-section auftrags-info-full" id="info4NotizenSection" style="display: none;">
                                <div class="auftrags-info-section-title">ðŸ“‹ Notizen</div>
                                <div class="auftrags-info-notizen" id="info4Notizen">-</div>
                            </div>

                            <!-- Service-Details pro Service -->
                            <div class="auftrags-info-section auftrags-info-full" id="info4ServiceDetailsSection" style="display: none;">
                                <div class="auftrags-info-section-title">ðŸ“¦ Service-Details</div>
                                <div class="auftrags-info-service-details" id="info4ServiceDetails">
                                    <!-- Dynamisch gefÃ¼llt -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ðŸ†• Nov 30, 2025: Multi-Service Teile-Ãœbersicht -->
                    <div class="step4-parts-overview" id="step4PartsOverview" style="display: none;">
                        <div class="step4-parts-header">
                            <i data-feather="layers"></i>
                            <span>AusgewÃ¤hlte Teile (<span id="step4PartsCount">0</span>)</span>
                        </div>
                        <div class="step4-parts-tabs" id="step4PartsTabs">
                            <!-- Dynamisch: Tabs fÃ¼r jedes Teil -->
                        </div>
                    </div>

                    <!-- GewÃ¤hltes Teil anzeigen -->
                    <div class="kalk-selected-vehicle" id="step4PartInfo">
                        <span class="kalk-selected-vehicle__label">Teil:</span>
                        <span class="kalk-selected-vehicle__value" id="step4PartDisplay">-</span>
                        <span class="kalk-selected-vehicle__service" id="step4PartService" style="margin-left: var(--space-2); color: var(--color-text-secondary); font-size: var(--font-size-sm);"></span>
                    </div>

                    <!-- ðŸ†• Fotos aus Entwurf/Annahme -->
                    <div class="entwurf-photos-section" id="step4PhotosSection" style="display: none;">
                        <div class="entwurf-photos-header">
                            <i data-feather="camera"></i>
                            <span>Fotos aus der Annahme</span>
                            <button class="btn btn-sm btn-secondary" onclick="togglePhotoGallery('step4')">
                                <i data-feather="maximize-2"></i> Vollbild
                            </button>
                        </div>
                        <div class="entwurf-photos-gallery" id="step4PhotosGallery">
                            <!-- Dynamisch gefÃ¼llt -->
                        </div>
                    </div>

                    <!-- Reparaturarten als Checkboxen (dynamisch je nach Service) -->
                    <div class="kalk-repair-options">
                        <h4>Welche Arbeiten sollen durchgefÃ¼hrt werden?</h4>
                        <p class="kalk-repair-hint">WÃ¤hlen Sie alle zutreffenden Arbeiten fÃ¼r <strong id="step4ServiceName">-</strong> aus</p>

                        <div class="repair-options-grid" id="repairOptionsGrid">
                            <!-- Dynamisch generiert basierend auf SERVICE_CONFIG -->
                            <label class="repair-option">
                                <input type="checkbox" name="repair" value="lackieren" onchange="updateRepairSelection()">
                                <div class="repair-option__content">
                                    <span class="repair-option__icon">ðŸŽ¨</span>
                                    <span class="repair-option__label">Lackieren</span>
                                </div>
                            </label>
                            <label class="repair-option">
                                <input type="checkbox" name="repair" value="demontieren" onchange="updateRepairSelection()">
                                <div class="repair-option__content">
                                    <span class="repair-option__icon">ðŸ”§</span>
                                    <span class="repair-option__label">Demontieren</span>
                                </div>
                            </label>
                            <label class="repair-option">
                                <input type="checkbox" name="repair" value="montieren" onchange="updateRepairSelection()">
                                <div class="repair-option__content">
                                    <span class="repair-option__icon">ðŸ”©</span>
                                    <span class="repair-option__label">Montieren</span>
                                </div>
                            </label>
                            <label class="repair-option">
                                <input type="checkbox" name="repair" value="grundieren" onchange="updateRepairSelection()">
                                <div class="repair-option__content">
                                    <span class="repair-option__icon">ðŸ–Œï¸</span>
                                    <span class="repair-option__label">Grundieren</span>
                                </div>
                            </label>
                            <label class="repair-option">
                                <input type="checkbox" name="repair" value="spachteln" onchange="updateRepairSelection()">
                                <div class="repair-option__content">
                                    <span class="repair-option__icon">ðŸª£</span>
                                    <span class="repair-option__label">Spachteln</span>
                                </div>
                            </label>
                            <label class="repair-option">
                                <input type="checkbox" name="repair" value="schleifen" onchange="updateRepairSelection()">
                                <div class="repair-option__content">
                                    <span class="repair-option__icon">ðŸ“</span>
                                    <span class="repair-option__label">Schleifen</span>
                                </div>
                            </label>
                            <label class="repair-option">
                                <input type="checkbox" name="repair" value="austauschen" onchange="updateRepairSelection()">
                                <div class="repair-option__content">
                                    <span class="repair-option__icon">ðŸ”„</span>
                                    <span class="repair-option__label">Austauschen (Neuteil)</span>
                                </div>
                            </label>
                            <label class="repair-option">
                                <input type="checkbox" name="repair" value="spot-repair" onchange="updateRepairSelection()">
                                <div class="repair-option__content">
                                    <span class="repair-option__icon">âœ¨</span>
                                    <span class="repair-option__label">Spot-Repair</span>
                                </div>
                            </label>
                            <label class="repair-option">
                                <input type="checkbox" name="repair" value="polieren" onchange="updateRepairSelection()">
                                <div class="repair-option__content">
                                    <span class="repair-option__icon">ðŸ’Ž</span>
                                    <span class="repair-option__label">Polieren</span>
                                </div>
                            </label>
                            <label class="repair-option">
                                <input type="checkbox" name="repair" value="ausbeulen" onchange="updateRepairSelection()">
                                <div class="repair-option__content">
                                    <span class="repair-option__icon">ðŸ”¨</span>
                                    <span class="repair-option__label">Ausbeulen (PDR)</span>
                                </div>
                            </label>
                            <label class="repair-option">
                                <input type="checkbox" name="repair" value="schweissen" onchange="updateRepairSelection()">
                                <div class="repair-option__content">
                                    <span class="repair-option__icon">âš¡</span>
                                    <span class="repair-option__label">SchweiÃŸen</span>
                                </div>
                            </label>
                            <label class="repair-option">
                                <input type="checkbox" name="repair" value="kleben" onchange="updateRepairSelection()">
                                <div class="repair-option__content">
                                    <span class="repair-option__icon">ðŸ§´</span>
                                    <span class="repair-option__label">Kleben</span>
                                </div>
                            </label>
                        </div>

                        <!-- Ersatzteil-Eingabe (erscheint bei Austauschen/Ersetzen) -->
                        <div class="kalk-ersatzteil-inline" id="ersatzteilInlineForm" style="display: none; margin-top: var(--space-6);">
                            <div class="ersatzteil-inline-header">
                                <i data-feather="package"></i>
                                <h4>Ersatzteil fÃ¼r dieses Teil</h4>
                                <span class="ersatzteil-hint">Wird automatisch zur Bestellliste hinzugefÃ¼gt</span>
                            </div>
                            <div class="ersatzteil-inline-form">
                                <div class="ersatzteil-search-wrapper">
                                    <input type="text"
                                           id="ersatzteilInlineName"
                                           class="ersatzteil-input"
                                           placeholder="Ersatzteil-Name (z.B. StoÃŸfÃ¤nger vorne)"
                                           oninput="searchErsatzteileDB(this.value)"
                                           autocomplete="off">
                                    <div class="ersatzteil-autocomplete" id="ersatzteilAutocomplete" style="display: none;">
                                        <!-- Autocomplete-Ergebnisse aus DB -->
                                    </div>
                                </div>
                                <input type="text"
                                       id="ersatzteilInlineTeilenr"
                                       class="ersatzteil-input ersatzteil-input--small"
                                       placeholder="OE-/Teilenummer">
                                <input type="number"
                                       id="ersatzteilInlinePreis"
                                       class="ersatzteil-input ersatzteil-input--small"
                                       placeholder="Preis (â‚¬)"
                                       step="0.01"
                                       min="0">
                                <select id="ersatzteilInlineLieferant" class="ersatzteil-input ersatzteil-input--small">
                                    <option value="">Lieferant wÃ¤hlen</option>
                                    <option value="DAT">DAT</option>
                                    <option value="Partslink24">Partslink24</option>
                                    <option value="Tecdoc">Tecdoc</option>
                                    <option value="Hersteller OE">Hersteller OE</option>
                                    <option value="Aftermarket">Aftermarket</option>
                                    <option value="Gebraucht">Gebraucht</option>
                                    <option value="Sonstige">Sonstige</option>
                                </select>
                            </div>
                            <p class="ersatzteil-db-hint">
                                <i data-feather="database"></i>
                                Neue Teile werden automatisch in Ihrer Ersatzteile-Datenbank gespeichert
                            </p>
                        </div>

                        <!-- Weiteres Teil hinzufÃ¼gen Button -->
                        <div class="kalk-add-more" style="margin-top: var(--space-6); text-align: center;">
                            <button class="btn btn-secondary" onclick="addCurrentPartAndGoBack()">
                                <i data-feather="plus-circle"></i>
                                Dieses Teil hinzufÃ¼gen & weiteres Teil wÃ¤hlen
                            </button>
                        </div>
                    </div>

                    <div class="kalk-step-actions">
                        <button class="btn btn-secondary btn-lg" onclick="goToStep(3)">
                            <i data-feather="arrow-left"></i>
                            ZurÃ¼ck
                        </button>
                        <button class="btn btn-primary btn-lg" onclick="saveCurrentPartAndGoToStep5()" id="btnStep4Next" disabled>
                            Weiter zu Ersatzteile
                            <i data-feather="arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- STEP 5: ERSATZTEILE-ÃœBERSICHT (NEU) -->
            <!-- ============================================ -->
            <div class="kalk-step-content" id="stepContent5">
                <div class="content-card">
                    <div class="content-card__header">
                        <div class="content-card__title">
                            <i data-feather="package"></i>
                            <h2>Schritt 5: Ersatzteile & Bestellungen</h2>
                        </div>
                    </div>

                    <!-- ðŸ†• Nov 30, 2025: AUFTRAGSINFO BOX fÃ¼r Step 5 -->
                    <div class="auftrags-info-box" id="step5AuftragsInfo" style="display: none;">
                        <div class="auftrags-info-header">
                            <i data-feather="file-text"></i>
                            <strong>Auftragsinformationen</strong>
                            <button class="btn btn-sm btn-ghost" onclick="toggleAuftragsInfo('step5')" id="auftragsInfoToggle5">
                                <i data-feather="chevron-up"></i>
                            </button>
                        </div>
                        <div class="auftrags-info-content" id="auftragsInfoContent5">
                            <div class="auftrags-info-grid">
                                <!-- Fahrzeug -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">ðŸš— Fahrzeug</div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Kennzeichen:</span>
                                        <span class="auftrags-info-value" id="info5Kennzeichen">-</span>
                                    </div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Fahrzeug:</span>
                                        <span class="auftrags-info-value" id="info5Fahrzeug">-</span>
                                    </div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Farbe:</span>
                                        <span class="auftrags-info-value" id="info5Farbe">-</span>
                                    </div>
                                </div>

                                <!-- Kunde -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">ðŸ‘¤ Kunde</div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Name:</span>
                                        <span class="auftrags-info-value" id="info5Kunde">-</span>
                                    </div>
                                    <div class="auftrags-info-row" id="info5PartnerRow" style="display: none;">
                                        <span class="auftrags-info-label">Partner:</span>
                                        <span class="auftrags-info-value" id="info5Partner">-</span>
                                    </div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Datum:</span>
                                        <span class="auftrags-info-value" id="info5Datum">-</span>
                                    </div>
                                </div>

                                <!-- Service -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">ðŸ”§ Service</div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Service-Art:</span>
                                        <span class="auftrags-info-value" id="info5Service">-</span>
                                    </div>
                                    <div class="auftrags-info-row" id="info5DringlichkeitRow" style="display: none;">
                                        <span class="auftrags-info-label">Dringlichkeit:</span>
                                        <span class="auftrags-info-value" id="info5Dringlichkeit">-</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Schadensbeschreibung -->
                            <div class="auftrags-info-section auftrags-info-full" id="info5SchadenSection" style="display: none;">
                                <div class="auftrags-info-section-title">ðŸ“ Schadensbeschreibung</div>
                                <div class="auftrags-info-schaden" id="info5Schaden">-</div>
                            </div>

                            <!-- Notizen -->
                            <div class="auftrags-info-section auftrags-info-full" id="info5NotizenSection" style="display: none;">
                                <div class="auftrags-info-section-title">ðŸ“‹ Notizen</div>
                                <div class="auftrags-info-notizen" id="info5Notizen">-</div>
                            </div>

                            <!-- Service-Details pro Service -->
                            <div class="auftrags-info-section auftrags-info-full" id="info5ServiceDetailsSection" style="display: none;">
                                <div class="auftrags-info-section-title">ðŸ“¦ Service-Details</div>
                                <div class="auftrags-info-service-details" id="info5ServiceDetails">
                                    <!-- Dynamisch gefÃ¼llt -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ðŸ†• Nov 30, 2025: TEILE-CHECKLISTE fÃ¼r Bestellungen -->
                    <div class="teile-checklist-section" id="teileChecklistSection" style="display: none;">
                        <div class="teile-checklist-header">
                            <i data-feather="check-square"></i>
                            <strong>BenÃ¶tigte Teile - Bestellungs-Checkliste</strong>
                            <span class="teile-checklist-badge" id="teileChecklistBadge">0/0</span>
                        </div>
                        <div class="teile-checklist-info">
                            <i data-feather="alert-circle"></i>
                            <span>Haken Sie jedes Teil ab, nachdem Sie es bestellt haben, um keine Bestellung zu vergessen!</span>
                        </div>
                        <div class="teile-checklist-items" id="teileChecklistItems">
                            <!-- Dynamisch gefÃ¼llt mit Checkboxen fÃ¼r jedes Teil -->
                        </div>
                        <div class="teile-checklist-actions" id="teileChecklistActions" style="display: none;">
                            <button class="btn btn-sm btn-outline" onclick="checkAllTeile()">
                                <i data-feather="check-square"></i> Alle abhaken
                            </button>
                            <button class="btn btn-sm btn-outline" onclick="uncheckAllTeile()">
                                <i data-feather="square"></i> Alle zurÃ¼cksetzen
                            </button>
                        </div>
                    </div>

                    <!-- Info-Banner -->
                    <div class="ersatzteile-info-banner">
                        <i data-feather="info"></i>
                        <div>
                            <strong>Ersatzteile bestellen</strong>
                            <p>Hier kÃ¶nnen Sie alle benÃ¶tigten Ersatzteile erfassen. Die KI sucht automatisch passende Teile aus verschiedenen Online-Shops.</p>
                        </div>
                    </div>

                    <!-- ðŸ†• KI-GESTÃœTZTE ERSATZTEIL-SUCHE -->
                    <div class="ki-ersatzteile-section" id="kiErsatzteileSection">
                        <div class="ki-ersatzteile-header">
                            <div class="ki-ersatzteile-header__title">
                                <i data-feather="search"></i>
                                <h4>ðŸ¤– KI-Ersatzteilsuche</h4>
                            </div>
                            <button class="btn btn-primary" onclick="startKIErsatzteilSuche()" id="btnStartKISuche">
                                <i data-feather="zap"></i>
                                Ersatzteile automatisch suchen
                            </button>
                        </div>

                        <!-- Suchkontext-Info -->
                        <div class="ki-ersatzteile-context" id="kiSuchKontext">
                            <div class="ki-kontext-item">
                                <span class="ki-kontext-label">Fahrzeug:</span>
                                <span class="ki-kontext-value" id="kiKontextFahrzeug">-</span>
                            </div>
                            <div class="ki-kontext-item">
                                <span class="ki-kontext-label">BenÃ¶tigte Teile:</span>
                                <span class="ki-kontext-value" id="kiKontextTeile">-</span>
                            </div>
                        </div>

                        <!-- Ladeanzeige -->
                        <div class="ki-ersatzteile-loading" id="kiErsatzteileLoading" style="display: none;">
                            <div class="ki-loading-spinner"></div>
                            <div class="ki-loading-text">
                                <strong>KI sucht nach Ersatzteilen...</strong>
                                <p id="kiLoadingStatus">Durchsuche Online-Shops nach passenden Teilen</p>
                            </div>
                        </div>

                        <!-- Suchergebnisse -->
                        <div class="ki-ersatzteile-results" id="kiErsatzteileResults" style="display: none;">
                            <div class="ki-results-header">
                                <div class="ki-results-count">
                                    <i data-feather="check-circle"></i>
                                    <span id="kiResultsCount">0</span> Angebote gefunden
                                </div>
                                <div class="ki-results-actions">
                                    <button class="btn btn-sm btn-outline" onclick="selectAllKIErsatzteile()">
                                        Alle auswÃ¤hlen
                                    </button>
                                    <button class="btn btn-sm btn-outline" onclick="selectCheapestKIErsatzteile()">
                                        GÃ¼nstigste auswÃ¤hlen
                                    </button>
                                </div>
                            </div>

                            <!-- Gruppiert nach Teil -->
                            <div id="kiErsatzteileGrouped"></div>

                            <!-- Ãœbernehmen Button -->
                            <div class="ki-results-footer">
                                <div class="ki-selected-summary">
                                    <span id="kiSelectedCount">0</span> Teile ausgewÃ¤hlt
                                    <strong id="kiSelectedTotal">0,00 â‚¬</strong>
                                </div>
                                <button class="btn btn-primary btn-lg" onclick="addSelectedKIErsatzteile()">
                                    <i data-feather="plus-circle"></i>
                                    AusgewÃ¤hlte zur Bestellliste hinzufÃ¼gen
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Bereits hinzugefÃ¼gte Ersatzteile aus Step 4 -->
                    <div class="ersatzteile-from-repairs" id="ersatzteileFromRepairs">
                        <h4><i data-feather="check-circle"></i> Ersatzteile aus Reparaturen</h4>
                        <div id="ersatzteileFromRepairsList" class="ersatzteile-list">
                            <!-- Automatisch aus Step 4 Ã¼bernommen -->
                            <p class="no-items-hint">Keine Ersatzteile aus Reparaturen hinzugefÃ¼gt</p>
                        </div>
                    </div>

                    <!-- Weitere Ersatzteile manuell hinzufÃ¼gen -->
                    <div class="ersatzteile-add-section">
                        <h4><i data-feather="plus-circle"></i> Weitere Ersatzteile hinzufÃ¼gen</h4>

                        <div class="ersatzteil-add-form">
                            <div class="ersatzteil-form-row">
                                <div class="ersatzteil-field ersatzteil-field--large">
                                    <label>Bezeichnung / Teilename</label>
                                    <div class="ersatzteil-search-wrapper">
                                        <input type="text"
                                               id="ersatzteilAddName"
                                               placeholder="z.B. StoÃŸfÃ¤nger vorne, Scheinwerfer links..."
                                               oninput="searchErsatzteileDBStep5(this.value)"
                                               autocomplete="off">
                                        <div class="ersatzteil-autocomplete" id="ersatzteilAutocompleteStep5" style="display: none;">
                                        </div>
                                    </div>
                                </div>
                                <div class="ersatzteil-field">
                                    <label>OE-/Teilenummer</label>
                                    <input type="text" id="ersatzteilAddTeilenr" placeholder="z.B. 5G1941005A">
                                </div>
                                <!-- ðŸ†• Dec 1, 2025: Service-Auswahl fÃ¼r Multi-Service -->
                                <div class="ersatzteil-field" id="ersatzteilServiceContainer" style="display: none;">
                                    <label>FÃ¼r Service</label>
                                    <select id="ersatzteilAddService" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                                        <option value="">Allgemein</option>
                                        <!-- Wird dynamisch befÃ¼llt bei Multi-Service -->
                                    </select>
                                </div>
                            </div>
                            <!-- ðŸ†• Nov 30, 2025: Zwei Preis-Felder fÃ¼r Original und Aftermarket -->
                            <div class="ersatzteil-form-row">
                                <div class="ersatzteil-field">
                                    <label>Original-Preis (â‚¬ netto) *</label>
                                    <input type="number" id="ersatzteilAddPreisOriginal" placeholder="z.B. 450.00" step="0.01" min="0" style="border-color: #003366;">
                                    <small style="color: #003366;">OEM / Hersteller-Teil</small>
                                </div>
                                <div class="ersatzteil-field">
                                    <label>Aftermarket-Preis (â‚¬ netto)</label>
                                    <input type="number" id="ersatzteilAddPreisAftermarket" placeholder="z.B. 280.00" step="0.01" min="0" style="border-color: #ff9800;">
                                    <small style="color: #ff9800;">ZubehÃ¶r / Budget (optional)</small>
                                </div>
                                <div class="ersatzteil-field">
                                    <label>Menge</label>
                                    <input type="number" id="ersatzteilAddMenge" value="1" min="1">
                                </div>
                                <div class="ersatzteil-field ersatzteil-field--lieferant">
                                    <label>Lieferant</label>
                                    <div class="lieferant-combo-input">
                                        <input type="text" id="ersatzteilAddLieferant" placeholder="z.B. Autodoc, eBay, HÃ¤ndler XY..." list="lieferantSuggestions">
                                        <datalist id="lieferantSuggestions">
                                            <option value="Autodoc">
                                            <option value="eBay">
                                            <option value="kfzteile24">
                                            <option value="Daparto">
                                            <option value="Autoteile-Markt">
                                            <option value="Partslink24">
                                            <option value="DAT">
                                            <option value="Hersteller OE">
                                            <option value="Aftermarket">
                                            <option value="Gebraucht">
                                        </datalist>
                                    </div>
                                </div>
                                <div class="ersatzteil-field ersatzteil-field--link">
                                    <label>Bestell-Link (optional)</label>
                                    <input type="url" id="ersatzteilAddLink" placeholder="https://...">
                                </div>
                                <div class="ersatzteil-field ersatzteil-field--action">
                                    <label>&nbsp;</label>
                                    <button class="btn btn-primary" onclick="addErsatzteilToList()">
                                        <i data-feather="plus"></i>
                                        HinzufÃ¼gen
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Externe Links -->
                        <div class="ersatzteile-external-links">
                            <span>Teile suchen bei:</span>
                            <a href="https://www.dat.de" target="_blank" class="external-link">
                                <i data-feather="external-link"></i> DAT
                            </a>
                            <a href="https://www.partslink24.com" target="_blank" class="external-link">
                                <i data-feather="external-link"></i> Partslink24
                            </a>
                            <a href="https://www.tecdoc.de" target="_blank" class="external-link">
                                <i data-feather="external-link"></i> TecDoc
                            </a>
                        </div>
                    </div>

                    <!-- Ersatzteile-Liste (alle gesammelten) -->
                    <div class="ersatzteile-complete-list">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4);">
                            <h4 style="margin: 0;"><i data-feather="list"></i> Bestellliste</h4>
                            <button class="btn btn-secondary" onclick="exportBestelllistePDF()">
                                <i data-feather="download"></i>
                                PDF Export
                            </button>
                        </div>
                        <div id="ersatzteileCompleteList" class="ersatzteile-table-wrapper">
                            <!-- ðŸ†• Nov 30, 2025: Zwei Preis-Spalten (Original + Aftermarket) -->
                            <table class="ersatzteile-table">
                                <thead>
                                    <tr>
                                        <th>Bezeichnung</th>
                                        <th>Teilenummer</th>
                                        <th>Lieferant</th>
                                        <th>Menge</th>
                                        <th style="background: #e3f2fd; color: #003366;">Original (â‚¬)</th>
                                        <th style="background: #fff3e0; color: #e65100;">Aftermarket (â‚¬)</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="ersatzteileTableBody">
                                    <tr class="no-items-row">
                                        <td colspan="7">Noch keine Ersatzteile hinzugefÃ¼gt</td>
                                    </tr>
                                </tbody>
                                <tfoot>
                                    <tr class="ersatzteile-total-row">
                                        <td colspan="4"><strong>Gesamt Ersatzteile (netto)</strong></td>
                                        <td style="background: #e3f2fd;"><strong id="ersatzteileGesamtOriginal">0,00 â‚¬</strong></td>
                                        <td style="background: #fff3e0;"><strong id="ersatzteileGesamtAftermarket">0,00 â‚¬</strong></td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <div class="kalk-step-actions">
                        <button class="btn btn-secondary btn-lg" onclick="goToStep(4)">
                            <i data-feather="arrow-left"></i>
                            ZurÃ¼ck
                        </button>
                        <button class="btn btn-primary btn-lg" onclick="goToStep(6)" id="btnStep5Next">
                            Weiter zur Ãœbersicht
                            <i data-feather="arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- STEP 6: KALKULATION ÃœBERSICHT -->
            <!-- ============================================ -->
            <div class="kalk-step-content" id="stepContent6">
                <div class="content-card">
                    <div class="content-card__header">
                        <div class="content-card__title">
                            <i data-feather="file-text"></i>
                            <h2>Schritt 6: Kalkulation & Ãœbersicht</h2>
                        </div>
                    </div>

                    <!-- ðŸ†• Nov 30, 2025: AUFTRAGSINFO BOX fÃ¼r Step 6 -->
                    <div class="auftrags-info-box" id="step6AuftragsInfo" style="display: none;">
                        <div class="auftrags-info-header">
                            <i data-feather="file-text"></i>
                            <strong>Auftragsinformationen</strong>
                            <button class="btn btn-sm btn-ghost" onclick="toggleAuftragsInfo('step6')" id="auftragsInfoToggle6">
                                <i data-feather="chevron-up"></i>
                            </button>
                        </div>
                        <div class="auftrags-info-content" id="auftragsInfoContent6">
                            <div class="auftrags-info-grid">
                                <!-- Fahrzeug -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">ðŸš— Fahrzeug</div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Kennzeichen:</span>
                                        <span class="auftrags-info-value" id="info6Kennzeichen">-</span>
                                    </div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Fahrzeug:</span>
                                        <span class="auftrags-info-value" id="info6Fahrzeug">-</span>
                                    </div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Farbe:</span>
                                        <span class="auftrags-info-value" id="info6Farbe">-</span>
                                    </div>
                                </div>

                                <!-- Kunde -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">ðŸ‘¤ Kunde</div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Name:</span>
                                        <span class="auftrags-info-value" id="info6Kunde">-</span>
                                    </div>
                                    <div class="auftrags-info-row" id="info6PartnerRow" style="display: none;">
                                        <span class="auftrags-info-label">Partner:</span>
                                        <span class="auftrags-info-value" id="info6Partner">-</span>
                                    </div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Datum:</span>
                                        <span class="auftrags-info-value" id="info6Datum">-</span>
                                    </div>
                                </div>

                                <!-- Service -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">ðŸ”§ Service</div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Service-Art:</span>
                                        <span class="auftrags-info-value" id="info6Service">-</span>
                                    </div>
                                    <div class="auftrags-info-row" id="info6DringlichkeitRow" style="display: none;">
                                        <span class="auftrags-info-label">Dringlichkeit:</span>
                                        <span class="auftrags-info-value" id="info6Dringlichkeit">-</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Schadensbeschreibung -->
                            <div class="auftrags-info-section auftrags-info-full" id="info6SchadenSection" style="display: none;">
                                <div class="auftrags-info-section-title">ðŸ“ Schadensbeschreibung</div>
                                <div class="auftrags-info-schaden" id="info6Schaden">-</div>
                            </div>

                            <!-- Notizen -->
                            <div class="auftrags-info-section auftrags-info-full" id="info6NotizenSection" style="display: none;">
                                <div class="auftrags-info-section-title">ðŸ“‹ Notizen</div>
                                <div class="auftrags-info-notizen" id="info6Notizen">-</div>
                            </div>

                            <!-- Service-Details pro Service -->
                            <div class="auftrags-info-section auftrags-info-full" id="info6ServiceDetailsSection" style="display: none;">
                                <div class="auftrags-info-section-title">ðŸ“¦ Service-Details</div>
                                <div class="auftrags-info-service-details" id="info6ServiceDetails">
                                    <!-- Dynamisch gefÃ¼llt -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Zusammenfassung -->
                    <div class="kalk-summary">
                        <div class="kalk-summary__vehicle">
                            <h4>Fahrzeug</h4>
                            <div id="step6VehicleSummary">-</div>
                        </div>
                        <div class="kalk-summary__parts">
                            <h4>AusgewÃ¤hlte Teile & Arbeiten</h4>
                            <div id="step6PartsSummary">-</div>
                        </div>
                        <div class="kalk-summary__ersatzteile">
                            <h4>Ersatzteile (Bestellliste)</h4>
                            <div id="step6ErsatzteileSummary">-</div>
                        </div>
                        <!-- ðŸ†• Service-Details & Design-Galerie (fÃ¼r Folierung/Werbebeklebung) -->
                        <div class="kalk-summary__service-details" id="step6ServiceDetailsSection" style="display: none;">
                            <h4>ðŸŽ¨ Service-Details</h4>
                            <div id="step6ServiceDetailsSummary">-</div>
                        </div>
                        <div class="kalk-summary__designs" id="step6DesignsSection" style="display: none;">
                            <h4>ðŸ“Ž Hochgeladene Designs</h4>
                            <div class="step6-design-gallery" id="step6DesignGallery">-</div>
                        </div>
                    </div>

                <div id="kalkulationContent">
                    <!-- Arbeitspositionen -->
                    <div class="content-card" style="margin-bottom: var(--space-6);">
                        <div class="content-card__header">
                            <div class="content-card__title">
                                <i data-feather="tool"></i>
                                <h2>Arbeitspositionen</h2>
                            </div>
                            <button class="btn btn-primary" onclick="openPositionModal()">
                                <i data-feather="plus"></i>
                                Position hinzufÃ¼gen
                            </button>
                        </div>

                        <div id="positionenListe">
                            <div class="empty-state">
                                <i data-feather="clipboard"></i>
                                <h3>Keine Positionen</h3>
                                <p>FÃ¼gen Sie Arbeitspositionen aus dem Katalog hinzu</p>
                            </div>
                        </div>
                    </div>

                    <!-- Material -->
                    <div class="content-card" style="margin-bottom: var(--space-6);">
                        <div class="content-card__header">
                            <div class="content-card__title">
                                <i data-feather="package"></i>
                                <h2>Material</h2>
                            </div>
                            <button class="btn btn-primary" onclick="openMaterialModal()">
                                <i data-feather="plus"></i>
                                Material hinzufÃ¼gen
                            </button>
                        </div>

                        <div id="materialListe">
                            <div class="empty-state">
                                <i data-feather="box"></i>
                                <h3>Kein Material</h3>
                                <p>FÃ¼gen Sie Materialien aus dem Katalog hinzu</p>
                            </div>
                        </div>
                    </div>

                    <!-- Zusammenfassung -->
                    <div class="kalkulation-summary">
                        <div class="summary-row">
                            <span class="label">Summe Arbeit (netto)</span>
                            <span class="value" id="summeArbeit">0,00 â‚¬</span>
                        </div>
                        <div class="summary-row">
                            <span class="label">Summe Material (netto)</span>
                            <span class="value" id="summeMaterial">0,00 â‚¬</span>
                        </div>
                        <div class="summary-row">
                            <span class="label">Summe Ersatzteile (netto)</span>
                            <span class="value" id="summeErsatzteile">0,00 â‚¬</span>
                        </div>
                        <!-- ðŸš— Ersatzfahrzeug-Kosten (FIX: Nov 30, 2025) -->
                        <div class="summary-row" id="ersatzfahrzeugSummaryRow" style="display: none;">
                            <span class="label">ðŸš— Ersatzfahrzeug (netto)</span>
                            <span class="value" id="summeErsatzfahrzeug">0,00 â‚¬</span>
                        </div>
                        <div class="summary-row" style="border-top: 1px solid var(--color-border); padding-top: var(--space-2); margin-top: var(--space-2);">
                            <span class="label">Zwischensumme (netto)</span>
                            <span class="value" id="summeNetto">0,00 â‚¬</span>
                        </div>
                        <div class="summary-row">
                            <span class="label">MwSt. <span id="mwstSatzDisplay">19</span>%</span>
                            <span class="value" id="summeMwst">0,00 â‚¬</span>
                        </div>
                        <div class="summary-row total">
                            <span class="label">Gesamtbetrag (brutto)</span>
                            <span class="value" id="summeBrutto">0,00 â‚¬</span>
                        </div>
                    </div>

                    <!-- Aktionen -->
                    <div style="display: flex; gap: var(--space-4); margin-top: var(--space-6); flex-wrap: wrap;">
                        <button class="btn btn-success btn-lg" onclick="saveKVA()" style="flex: 1; min-width: 200px;">
                            <i data-feather="save"></i>
                            Kalkulation speichern
                        </button>
                        <button class="btn btn-secondary" onclick="goToStep(1)" style="min-width: 150px;">
                            <i data-feather="arrow-left"></i>
                            ZurÃ¼ck bearbeiten
                        </button>
                    </div>
                    <p style="margin-top: var(--space-3); font-size: var(--font-size-sm); color: var(--color-text-secondary);">
                        <i data-feather="info" style="width: 14px; height: 14px; vertical-align: middle;"></i>
                        Die Kalkulation wird im Entwurf gespeichert. Danach kÃ¶nnen Sie das Angebot an den Kunden versenden.
                    </p>
                </div>

                <!-- Freie Kalkulation starten -->
                <div id="freieKalkulationStart">
                    <button class="btn btn-secondary" onclick="startFreieKalkulation()">
                        <i data-feather="edit-3"></i>
                        Freie Kalkulation ohne Fahrzeug starten
                    </button>
                </div>
            </div>
        </section>

        <!-- ============================================ -->
        <!-- TAB 2: Arbeitswert-Katalog -->
        <!-- ============================================ -->
        <section id="tab-katalog" class="tab-content">
            <div class="content-card">
                <div class="content-card__header">
                    <div class="content-card__title">
                        <i data-feather="book"></i>
                        <h2>Arbeitswert-Katalog</h2>
                    </div>
                    <button class="btn btn-primary" onclick="openKatalogModal()">
                        <i data-feather="plus"></i>
                        Neue Position
                    </button>
                </div>

                <!-- Search & Filter -->
                <div class="search-filter-bar">
                    <div class="search-input">
                        <i data-feather="search"></i>
                        <input type="text" id="katalogSearch" placeholder="Suchen..." oninput="filterKatalog()">
                    </div>
                    <select id="katalogFilter" onchange="filterKatalog()">
                        <option value="">Alle Kategorien</option>
                        <option value="Karosserie">Karosserie</option>
                        <option value="Lackierung">Lackierung</option>
                        <option value="Mechanik">Mechanik</option>
                        <option value="Elektrik">Elektrik</option>
                        <option value="Sonstiges">Sonstiges</option>
                    </select>
                </div>

                <div id="katalogListe">
                    <div class="empty-state">
                        <i data-feather="book-open"></i>
                        <h3>Katalog leer</h3>
                        <p>Erstellen Sie Ihren ersten Arbeitswert-Eintrag</p>
                        <button class="btn btn-primary" onclick="seedKatalog()">
                            <i data-feather="download"></i>
                            Standard-Katalog laden
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ============================================ -->
        <!-- TAB 3: StundensÃ¤tze -->
        <!-- ============================================ -->
        <section id="tab-saetze" class="tab-content">
            <div class="content-card">
                <div class="content-card__header">
                    <div class="content-card__title">
                        <i data-feather="dollar-sign"></i>
                        <h2>StundensÃ¤tze & Einstellungen</h2>
                    </div>
                </div>

                <form id="saetzeForm" onsubmit="saveSaetze(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="stundensatzLack">Lackierarbeiten</label>
                            <div class="input-suffix">
                                <input type="number" id="stundensatzLack" step="0.01" min="0" value="95.00" required>
                                <span>â‚¬/Std</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="stundensatzKarosserie">Karosseriearbeiten</label>
                            <div class="input-suffix">
                                <input type="number" id="stundensatzKarosserie" step="0.01" min="0" value="85.00" required>
                                <span>â‚¬/Std</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="stundensatzMechanik">Mechanik/Elektrik</label>
                            <div class="input-suffix">
                                <input type="number" id="stundensatzMechanik" step="0.01" min="0" value="75.00" required>
                                <span>â‚¬/Std</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="stundensatzSonstige">Sonstige Arbeiten</label>
                            <div class="input-suffix">
                                <input type="number" id="stundensatzSonstige" step="0.01" min="0" value="65.00" required>
                                <span>â‚¬/Std</span>
                            </div>
                        </div>
                    </div>

                    <hr style="margin: var(--space-8) 0; border: none; border-top: 1px solid var(--color-border);">

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="awInMinuten">1 Arbeitswert (AW) entspricht</label>
                            <div class="input-suffix">
                                <input type="number" id="awInMinuten" step="1" min="1" value="5" required>
                                <span>Minuten</span>
                            </div>
                            <small>Branchenstandard: 5 Minuten pro AW</small>
                        </div>

                        <div class="form-group">
                            <label for="mwstSatz">Mehrwertsteuersatz</label>
                            <div class="input-suffix">
                                <input type="number" id="mwstSatz" step="0.1" min="0" value="19" required>
                                <span>%</span>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: var(--space-6);">
                        <button type="submit" class="btn btn-success" id="saveSaetzeBtn">
                            <i data-feather="save"></i>
                            Einstellungen speichern
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <!-- ============================================ -->
        <!-- TAB 4: Material-Katalog -->
        <!-- ============================================ -->
        <section id="tab-material" class="tab-content">
            <div class="content-card">
                <div class="content-card__header">
                    <div class="content-card__title">
                        <i data-feather="package"></i>
                        <h2>Material-Katalog</h2>
                    </div>
                    <button class="btn btn-primary" onclick="openMaterialKatalogModal()">
                        <i data-feather="plus"></i>
                        Neues Material
                    </button>
                </div>

                <!-- Search & Filter -->
                <div class="search-filter-bar">
                    <div class="search-input">
                        <i data-feather="search"></i>
                        <input type="text" id="materialSearch" placeholder="Suchen..." oninput="filterMaterial()">
                    </div>
                    <select id="materialFilter" onchange="filterMaterial()">
                        <option value="">Alle Kategorien</option>
                        <option value="Lackmaterial">Lackmaterial</option>
                        <option value="Verbrauchsmaterial">Verbrauchsmaterial</option>
                        <option value="Ersatzteile">Ersatzteile</option>
                        <option value="Sonstiges">Sonstiges</option>
                    </select>
                </div>

                <div id="materialKatalogListe">
                    <div class="empty-state">
                        <i data-feather="package"></i>
                        <h3>Material-Katalog leer</h3>
                        <p>Erstellen Sie Ihren ersten Material-Eintrag</p>
                        <button class="btn btn-primary" onclick="seedMaterial()">
                            <i data-feather="download"></i>
                            Standard-Material laden
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ============================================ -->
        <!-- TAB 5: Historie -->
        <!-- ============================================ -->
        <section id="tab-historie" class="tab-content">
            <div class="content-card">
                <div class="content-card__header">
                    <div class="content-card__title">
                        <i data-feather="clock"></i>
                        <h2>Kalkulations-Historie</h2>
                    </div>
                </div>

                <!-- Search & Filter -->
                <div class="search-filter-bar">
                    <div class="search-input">
                        <i data-feather="search"></i>
                        <input type="text" id="historieSearch" placeholder="Kennzeichen oder Kunde suchen...">
                    </div>
                    <select id="historieFilter">
                        <option value="">Alle Status</option>
                        <option value="entwurf">Entwurf</option>
                        <option value="gesendet">Gesendet</option>
                        <option value="akzeptiert">Akzeptiert</option>
                        <option value="abgelehnt">Abgelehnt</option>
                    </select>
                </div>

                <div id="historieListe">
                    <div class="empty-state">
                        <i data-feather="file-text"></i>
                        <h3>Keine Kalkulationen</h3>
                        <p>Ihre erstellten Kalkulationen erscheinen hier</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- ============================================ -->
        <!-- TAB 6: Schnell-Kalkulationen (Templates) -->
        <!-- ============================================ -->
        <section id="tab-templates" class="tab-content">
            <div class="content-card">
                <div class="content-card__header">
                    <div class="content-card__title">
                        <i data-feather="copy"></i>
                        <h2>Kalkulations-Templates</h2>
                    </div>
                    <button class="btn btn-primary" onclick="openTemplateModal()">
                        <i data-feather="plus"></i>
                        Neues Template
                    </button>
                </div>
                <p class="text-muted" style="margin-bottom: var(--space-4);">
                    Speichern Sie hÃ¤ufige Kalkulationen als Templates fÃ¼r schnelle Wiederverwendung.
                </p>

                <!-- Template-Kategorien -->
                <div class="template-categories">
                    <button class="template-category active" data-category="all" onclick="filterTemplates('all')">
                        Alle Templates
                    </button>
                    <button class="template-category" data-category="lackierung" onclick="filterTemplates('lackierung')">
                        Lackierung
                    </button>
                    <button class="template-category" data-category="smart_repair" onclick="filterTemplates('smart_repair')">
                        Smart Repair
                    </button>
                    <button class="template-category" data-category="unfall" onclick="filterTemplates('unfall')">
                        UnfallschÃ¤den
                    </button>
                    <button class="template-category" data-category="sonstiges" onclick="filterTemplates('sonstiges')">
                        Sonstiges
                    </button>
                </div>

                <!-- Template-Liste -->
                <div id="templateListe" class="template-grid">
                    <!-- Vordefinierte Standard-Templates -->
                    <div class="template-card" onclick="loadTemplate('standard_kotfluegel')">
                        <div class="template-card__icon">ðŸš—</div>
                        <div class="template-card__content">
                            <h4>KotflÃ¼gel lackieren</h4>
                            <p>Standard-Lackierung eines KotflÃ¼gels inkl. Vor-/Nachbereitung</p>
                            <div class="template-card__meta">
                                <span><i data-feather="clock"></i> ~3h</span>
                                <span><i data-feather="tag"></i> Lackierung</span>
                            </div>
                        </div>
                    </div>

                    <div class="template-card" onclick="loadTemplate('standard_stossfaenger')">
                        <div class="template-card__icon">ðŸ›¡ï¸</div>
                        <div class="template-card__content">
                            <h4>StoÃŸfÃ¤nger komplett</h4>
                            <p>Demontage, Reparatur, Lackierung, Montage</p>
                            <div class="template-card__meta">
                                <span><i data-feather="clock"></i> ~5h</span>
                                <span><i data-feather="tag"></i> Lackierung</span>
                            </div>
                        </div>
                    </div>

                    <div class="template-card" onclick="loadTemplate('smart_beule')">
                        <div class="template-card__icon">ðŸ”§</div>
                        <div class="template-card__content">
                            <h4>Beule Smart Repair</h4>
                            <p>Kleine Delle ausbeulen ohne Lackierung (PDR)</p>
                            <div class="template-card__meta">
                                <span><i data-feather="clock"></i> ~1h</span>
                                <span><i data-feather="tag"></i> Smart Repair</span>
                            </div>
                        </div>
                    </div>

                    <div class="template-card" onclick="loadTemplate('smart_kratzer')">
                        <div class="template-card__icon">âœ¨</div>
                        <div class="template-card__content">
                            <h4>Kratzer ausbessern</h4>
                            <p>Spot Repair fÃ¼r oberflÃ¤chliche Kratzer</p>
                            <div class="template-card__meta">
                                <span><i data-feather="clock"></i> ~2h</span>
                                <span><i data-feather="tag"></i> Smart Repair</span>
                            </div>
                        </div>
                    </div>

                    <div class="template-card" onclick="loadTemplate('unfall_seite')">
                        <div class="template-card__icon">ðŸ’¥</div>
                        <div class="template-card__content">
                            <h4>Seitenschaden Standard</h4>
                            <p>TÃ¼re + Schweller + KotflÃ¼gel hinten</p>
                            <div class="template-card__meta">
                                <span><i data-feather="clock"></i> ~12h</span>
                                <span><i data-feather="tag"></i> Unfall</span>
                            </div>
                        </div>
                    </div>

                    <div class="template-card" onclick="loadTemplate('unfall_front')">
                        <div class="template-card__icon">ðŸš§</div>
                        <div class="template-card__content">
                            <h4>Frontschaden Standard</h4>
                            <p>StoÃŸfÃ¤nger + Motorhaube + KotflÃ¼gel</p>
                            <div class="template-card__meta">
                                <span><i data-feather="clock"></i> ~15h</span>
                                <span><i data-feather="tag"></i> Unfall</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Eigene Templates -->
                <h3 style="margin-top: var(--space-8); margin-bottom: var(--space-4);">
                    <i data-feather="bookmark"></i>
                    Meine gespeicherten Templates
                </h3>
                <div id="eigeneTemplateListe" class="template-grid">
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <i data-feather="bookmark"></i>
                        <h4>Keine eigenen Templates</h4>
                        <p>Erstellen Sie eigene Templates aus abgeschlossenen Kalkulationen</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- ============================================ -->
        <!-- TAB 7: Lieferanten-Vergleich -->
        <!-- ============================================ -->
        <section id="tab-lieferanten" class="tab-content">
            <div class="content-card">
                <div class="content-card__header">
                    <div class="content-card__title">
                        <i data-feather="truck"></i>
                        <h2>Lieferanten-Vergleich</h2>
                    </div>
                    <button class="btn btn-primary" onclick="openLieferantModal()">
                        <i data-feather="plus"></i>
                        Neuer Lieferant
                    </button>
                </div>
                <p class="text-muted" style="margin-bottom: var(--space-4);">
                    Verwalten Sie Ihre Lieferanten und vergleichen Sie Preise fÃ¼r Ersatzteile.
                </p>

                <!-- Lieferanten-Liste -->
                <div id="lieferantenListe" class="lieferanten-grid">
                    <!-- Standard-Lieferanten -->
                    <div class="lieferant-card">
                        <div class="lieferant-card__logo">
                            <span style="font-size: 2rem;">ðŸ”§</span>
                        </div>
                        <div class="lieferant-card__content">
                            <h4>DAT / Audatex</h4>
                            <p>Offizieller Ersatzteilkatalog</p>
                            <div class="lieferant-card__meta">
                                <span class="badge badge--success">PrimÃ¤r</span>
                                <a href="https://www.dat.de" target="_blank" class="btn btn-sm btn-secondary">
                                    <i data-feather="external-link"></i>
                                    Ã–ffnen
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="lieferant-card">
                        <div class="lieferant-card__logo">
                            <span style="font-size: 2rem;">ðŸš—</span>
                        </div>
                        <div class="lieferant-card__content">
                            <h4>Partslink24</h4>
                            <p>OEM-Ersatzteile aller Hersteller</p>
                            <div class="lieferant-card__meta">
                                <span class="badge badge--info">OEM</span>
                                <a href="https://www.partslink24.com" target="_blank" class="btn btn-sm btn-secondary">
                                    <i data-feather="external-link"></i>
                                    Ã–ffnen
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="lieferant-card">
                        <div class="lieferant-card__logo">
                            <span style="font-size: 2rem;">ðŸ“š</span>
                        </div>
                        <div class="lieferant-card__content">
                            <h4>TecDoc</h4>
                            <p>Aftermarket-Ersatzteile</p>
                            <div class="lieferant-card__meta">
                                <span class="badge badge--warning">Aftermarket</span>
                                <a href="https://www.tecdoc.de" target="_blank" class="btn btn-sm btn-secondary">
                                    <i data-feather="external-link"></i>
                                    Ã–ffnen
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="lieferant-card">
                        <div class="lieferant-card__logo">
                            <span style="font-size: 2rem;">ðŸ›’</span>
                        </div>
                        <div class="lieferant-card__content">
                            <h4>Stahlgruber</h4>
                            <p>GroÃŸhandel fÃ¼r Werkstattbedarf</p>
                            <div class="lieferant-card__meta">
                                <span class="badge badge--secondary">GroÃŸhandel</span>
                                <a href="https://www.stahlgruber.de" target="_blank" class="btn btn-sm btn-secondary">
                                    <i data-feather="external-link"></i>
                                    Ã–ffnen
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Preisvergleich-Tool -->
                <h3 style="margin-top: var(--space-8); margin-bottom: var(--space-4);">
                    <i data-feather="bar-chart-2"></i>
                    Ersatzteil-Preisvergleich
                </h3>
                <div class="preisvergleich-container">
                    <div class="search-input" style="max-width: 400px; margin-bottom: var(--space-4);">
                        <i data-feather="search"></i>
                        <input type="text" id="preisvergleichSuche" placeholder="Ersatzteil suchen (Name oder Teilenummer)..." oninput="searchPreisvergleich(this.value)">
                    </div>
                    <div id="preisvergleichResult" class="preisvergleich-results">
                        <div class="empty-state">
                            <i data-feather="search"></i>
                            <h4>Ersatzteil suchen</h4>
                            <p>Geben Sie den Namen oder die Teilenummer ein, um Preise zu vergleichen</p>
                        </div>
                    </div>
                </div>

                <!-- Eigene Lieferanten -->
                <h3 style="margin-top: var(--space-8); margin-bottom: var(--space-4);">
                    <i data-feather="users"></i>
                    Meine Lieferanten
                </h3>
                <div id="eigeneLieferantenListe" class="lieferanten-grid">
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <i data-feather="truck"></i>
                        <h4>Keine eigenen Lieferanten</h4>
                        <p>FÃ¼gen Sie Ihre bevorzugten Lieferanten hinzu</p>
                    </div>
                </div>

                <!-- Ersatzteile nach Lieferant -->
                <h3 style="margin-top: var(--space-8); margin-bottom: var(--space-4);">
                    <i data-feather="package"></i>
                    Ersatzteile nach Lieferant
                    <span id="ersatzteileCountBadge" class="badge badge--info" style="margin-left: 8px; font-size: 0.75rem;">0 Teile</span>
                </h3>
                <div id="ersatzteileByLieferantContainer">
                    <div class="empty-state">
                        <i data-feather="package"></i>
                        <h4>Keine Ersatzteile erfasst</h4>
                        <p>Ersatzteile werden hier nach Lieferant gruppiert angezeigt, sobald Sie welche in Kalkulationen verwenden</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- ============================================ -->
        <!-- TAB 8: Wiederkehrende Kunden-Fahrzeuge -->
        <!-- ============================================ -->
        <section id="tab-kunden" class="tab-content">
            <div class="content-card">
                <div class="content-card__header">
                    <div class="content-card__title">
                        <i data-feather="users"></i>
                        <h2>Kunden & Fahrzeuge</h2>
                    </div>
                </div>
                <p class="text-muted" style="margin-bottom: var(--space-4);">
                    Alle Kunden und deren Fahrzeuge aus bisherigen Kalkulationen. Klicken Sie auf einen Kunden, um direkt eine neue Kalkulation zu starten.
                </p>

                <!-- Such- und Filterleiste -->
                <div class="search-filter-bar" style="margin-bottom: var(--space-6);">
                    <div class="search-input" style="flex: 1;">
                        <i data-feather="search"></i>
                        <input type="text" id="kundenSuche" placeholder="Kunde, Kennzeichen oder Fahrzeug suchen..." oninput="filterKunden(this.value)">
                    </div>
                    <select id="kundenSort" onchange="sortKunden(this.value)">
                        <option value="recent">Zuletzt verwendet</option>
                        <option value="name">Name A-Z</option>
                        <option value="count">Meiste AuftrÃ¤ge</option>
                    </select>
                </div>

                <!-- Kunden-Liste -->
                <div id="kundenListe" class="kunden-grid">
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <i data-feather="users"></i>
                        <h4>Keine Kunden vorhanden</h4>
                        <p>Kunden werden automatisch aus abgeschlossenen Kalkulationen hinzugefÃ¼gt</p>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- ============================================ -->
    <!-- MODALS -->
    <!-- ============================================ -->

    <!-- Modal: Position aus Katalog zur Kalkulation hinzufÃ¼gen -->
    <div class="modal-overlay" id="positionAuswahlModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3>Position aus Katalog hinzufÃ¼gen</h3>
                <button class="modal-close" onclick="closeModal('positionAuswahlModal')">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                <div class="search-input" style="margin-bottom: var(--space-4);">
                    <i data-feather="search"></i>
                    <input type="text" id="positionAuswahlSearch" placeholder="Position suchen..." oninput="filterPositionAuswahl()">
                </div>
                <div id="positionAuswahlListe">
                    <!-- Wird dynamisch gefÃ¼llt -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('positionAuswahlModal')">Abbrechen</button>
            </div>
        </div>
    </div>

    <!-- Modal: Material aus Katalog zur Kalkulation hinzufÃ¼gen -->
    <div class="modal-overlay" id="materialAuswahlModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3>Material aus Katalog hinzufÃ¼gen</h3>
                <button class="modal-close" onclick="closeModal('materialAuswahlModal')">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                <div class="search-input" style="margin-bottom: var(--space-4);">
                    <i data-feather="search"></i>
                    <input type="text" id="materialAuswahlSearch" placeholder="Material suchen..." oninput="filterMaterialAuswahl()">
                </div>
                <div id="materialAuswahlListe">
                    <!-- Wird dynamisch gefÃ¼llt -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('materialAuswahlModal')">Abbrechen</button>
            </div>
        </div>
    </div>

    <!-- Modal: Katalog-Position hinzufÃ¼gen/bearbeiten -->
    <div class="modal-overlay" id="katalogModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="katalogModalTitle">Neue Position</h3>
                <button class="modal-close" onclick="closeModal('katalogModal')">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="katalogForm" onsubmit="saveKatalogPosition(event)">
                    <input type="hidden" id="katalogPositionId">

                    <div class="form-group">
                        <label for="positionName">Bezeichnung *</label>
                        <input type="text" id="positionName" required placeholder="z.B. StoÃŸfÃ¤nger vorne dem./mont.">
                    </div>

                    <div class="form-group">
                        <label for="positionKategorie">Kategorie *</label>
                        <select id="positionKategorie" required>
                            <option value="">-- WÃ¤hlen --</option>
                            <option value="Karosserie">Karosserie</option>
                            <option value="Lackierung">Lackierung</option>
                            <option value="Mechanik">Mechanik</option>
                            <option value="Elektrik">Elektrik</option>
                            <option value="Sonstiges">Sonstiges</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="positionAW">Arbeitswerte (AW) *</label>
                        <input type="number" id="positionAW" step="0.5" min="0.5" required placeholder="z.B. 8.5">
                        <small>1 AW = 5 Minuten (Standard)</small>
                    </div>

                    <div class="form-group">
                        <label for="positionBeschreibung">Beschreibung (optional)</label>
                        <input type="text" id="positionBeschreibung" placeholder="ZusÃ¤tzliche Infos...">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('katalogModal')">Abbrechen</button>
                <button type="submit" form="katalogForm" class="btn btn-primary">
                    <i data-feather="save"></i>
                    Speichern
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Material hinzufÃ¼gen/bearbeiten -->
    <div class="modal-overlay" id="materialKatalogModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="materialModalTitle">Neues Material</h3>
                <button class="modal-close" onclick="closeModal('materialKatalogModal')">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="materialForm" onsubmit="saveMaterialPosition(event)">
                    <input type="hidden" id="materialPositionId">

                    <div class="form-group">
                        <label for="materialName">Bezeichnung *</label>
                        <input type="text" id="materialName" required placeholder="z.B. Basislack 1L">
                    </div>

                    <div class="form-group">
                        <label for="materialKategorie">Kategorie *</label>
                        <select id="materialKategorie" required>
                            <option value="">-- WÃ¤hlen --</option>
                            <option value="Lackmaterial">Lackmaterial</option>
                            <option value="Verbrauchsmaterial">Verbrauchsmaterial</option>
                            <option value="Ersatzteile">Ersatzteile</option>
                            <option value="Sonstiges">Sonstiges</option>
                        </select>
                    </div>

                    <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="form-group">
                            <label for="materialEK">Einkaufspreis (EK)</label>
                            <div class="input-suffix">
                                <input type="number" id="materialEK" step="0.01" min="0" placeholder="0.00">
                                <span>â‚¬</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="materialVK">Verkaufspreis (VK) *</label>
                            <div class="input-suffix">
                                <input type="number" id="materialVK" step="0.01" min="0" required placeholder="0.00">
                                <span>â‚¬</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="materialEinheit">Einheit</label>
                        <select id="materialEinheit">
                            <option value="StÃ¼ck">StÃ¼ck</option>
                            <option value="Liter">Liter</option>
                            <option value="kg">kg</option>
                            <option value="Set">Set</option>
                            <option value="Meter">Meter</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('materialKatalogModal')">Abbrechen</button>
                <button type="submit" form="materialForm" class="btn btn-primary">
                    <i data-feather="save"></i>
                    Speichern
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Template hinzufÃ¼gen/bearbeiten -->
    <div class="modal-overlay" id="templateModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="templateModalTitle">Neues Template</h3>
                <button class="modal-close" onclick="closeModal('templateModal')">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="templateForm" onsubmit="saveTemplate(event)">
                    <input type="hidden" id="templateId">

                    <div class="form-group">
                        <label for="templateName">Template-Name *</label>
                        <input type="text" id="templateName" required placeholder="z.B. KotflÃ¼gel lackieren komplett">
                    </div>

                    <div class="form-group">
                        <label for="templateKategorie">Kategorie *</label>
                        <select id="templateKategorie" required>
                            <option value="">-- WÃ¤hlen --</option>
                            <option value="lackierung">Lackierung</option>
                            <option value="smart_repair">Smart Repair</option>
                            <option value="unfall">UnfallschÃ¤den</option>
                            <option value="sonstiges">Sonstiges</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="templateBeschreibung">Beschreibung</label>
                        <textarea id="templateBeschreibung" rows="2" placeholder="Kurze Beschreibung des Templates..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="templateIcon">Icon (Emoji)</label>
                        <input type="text" id="templateIcon" maxlength="2" placeholder="ðŸš—" style="width: 60px; text-align: center; font-size: 1.5rem;">
                    </div>

                    <div class="form-group">
                        <label for="templateGeschaetzteZeit">GeschÃ¤tzte Zeit</label>
                        <input type="text" id="templateGeschaetzteZeit" placeholder="z.B. ~3h">
                    </div>

                    <div class="form-group">
                        <label>Positionen aus aktueller Kalkulation Ã¼bernehmen?</label>
                        <div style="display: flex; gap: 12px; margin-top: 8px;">
                            <label class="checkbox-label">
                                <input type="checkbox" id="templateUebernahmePositionen" checked>
                                <span>Arbeitspositionen</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="templateUebernahmeMaterial" checked>
                                <span>Material</span>
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('templateModal')">Abbrechen</button>
                <button type="submit" form="templateForm" class="btn btn-primary">
                    <i data-feather="save"></i>
                    Speichern
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Lieferant hinzufÃ¼gen/bearbeiten -->
    <div class="modal-overlay" id="lieferantModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="lieferantModalTitle">Neuer Lieferant</h3>
                <button class="modal-close" onclick="closeModal('lieferantModal')">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="lieferantForm" onsubmit="saveLieferant(event)">
                    <input type="hidden" id="lieferantId">

                    <div class="form-group">
                        <label for="lieferantName">Firmenname *</label>
                        <input type="text" id="lieferantName" required placeholder="z.B. AutoTeile GmbH">
                    </div>

                    <div class="form-group">
                        <label for="lieferantTyp">Typ *</label>
                        <select id="lieferantTyp" required>
                            <option value="">-- WÃ¤hlen --</option>
                            <option value="oem">OEM (Original)</option>
                            <option value="aftermarket">Aftermarket</option>
                            <option value="lackmaterial">Lackmaterial</option>
                            <option value="verbrauchsmaterial">Verbrauchsmaterial</option>
                            <option value="werkzeug">Werkzeug</option>
                            <option value="sonstiges">Sonstiges</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="lieferantWebsite">Website</label>
                        <input type="url" id="lieferantWebsite" placeholder="https://www.beispiel.de">
                    </div>

                    <div class="form-group">
                        <label for="lieferantTelefon">Telefon</label>
                        <input type="tel" id="lieferantTelefon" placeholder="+49 123 456789">
                    </div>

                    <div class="form-group">
                        <label for="lieferantEmail">E-Mail</label>
                        <input type="email" id="lieferantEmail" placeholder="bestellung@beispiel.de">
                    </div>

                    <div class="form-group">
                        <label for="lieferantKundennummer">Kundennummer</label>
                        <input type="text" id="lieferantKundennummer" placeholder="Ihre Kundennummer beim Lieferanten">
                    </div>

                    <div class="form-group">
                        <label for="lieferantIcon">Icon (Emoji)</label>
                        <input type="text" id="lieferantIcon" maxlength="2" placeholder="ðŸš—" style="width: 60px; text-align: center; font-size: 1.5rem;">
                    </div>

                    <div class="form-group">
                        <label for="lieferantNotizen">Notizen</label>
                        <textarea id="lieferantNotizen" rows="2" placeholder="ZusÃ¤tzliche Informationen..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('lieferantModal')">Abbrechen</button>
                <button type="submit" form="lieferantForm" class="btn btn-primary">
                    <i data-feather="save"></i>
                    Speichern
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // INITIALIZATION
        // ============================================

        let kalkulationSaetze = {
            stundensatzLack: 95.00,
            stundensatzKarosserie: 85.00,
            stundensatzMechanik: 75.00,
            stundensatzSonstige: 65.00,
            awInMinuten: 5,
            mwstSatz: 19
        };

        let katalogData = [];
        let materialData = [];
        let templateData = [];
        let lieferantenData = [];
        let aktuelleKalkulation = {
            positionen: [],
            materialien: [],
            fahrzeugId: null,
            kundenName: '',
            kennzeichen: ''
        };

        // ============================================
        // ðŸ”§ BUG #8 FIX (2025-11-30): Audit-Trail Helper fÃ¼r User-Tracking
        // Ersetzt window.currentUser (war nie initialisiert!)
        // ============================================
        /**
         * Ermittelt aktuellen Benutzer fÃ¼r Audit-Trail EintrÃ¤ge
         * PrioritÃ¤t:
         * 1. sessionStorage (mitarbeiter login) - PREFERRED
         * 2. firebase.auth().currentUser - FALLBACK
         * 3. 'Meister' - LAST RESORT
         *
         * @returns {Object} {user: string, userId: string|null, rolle: string|null, email: string|null}
         */
        function getCurrentUserForAudit() {
            // Try sessionStorage first (mitarbeiter login via Mitarbeiterverwaltung)
            const mitarbeiterStr = sessionStorage.getItem('mitarbeiter');
            if (mitarbeiterStr) {
                try {
                    const mitarbeiter = JSON.parse(mitarbeiterStr);
                    return {
                        user: mitarbeiter.name || mitarbeiter.email || 'Meister',
                        userId: mitarbeiter.id || null,
                        rolle: mitarbeiter.rolle || 'Sonstige',
                        email: mitarbeiter.email || null
                    };
                } catch (e) {
                    console.error('âŒ Fehler beim Parsen von Mitarbeiter-Daten:', e);
                }
            }

            // Fallback: Firebase Auth (for Admin/Werkstatt login)
            const authUser = firebase.auth().currentUser;
            if (authUser) {
                return {
                    user: authUser.displayName || authUser.email || 'Meister',
                    userId: authUser.uid || null,
                    rolle: null,
                    email: authUser.email || null
                };
            }

            // Last resort - In Kalkulation-Context ist das normalerweise der Meister
            console.warn('âš ï¸ getCurrentUserForAudit(): Kein User gefunden! Fallback zu "Meister"');
            return {
                user: 'Meister',
                userId: null,
                rolle: null,
                email: null
            };
        }

        // ============================================
        // ðŸ†• NEUER KALKULATIONS-WIZARD STATE (6 Steps)
        // ============================================
        let currentStep = 1;
        let kalkWizardData = {
            fahrzeug: {
                marke: '',
                modell: '',
                baujahr: '',
                kennzeichen: '',
                farbcode: '',
                kunde: ''
            },
            serviceArt: '', // BEHALTEN fÃ¼r Backwards-Compat (String)
            // ðŸ†• MULTI-SERVICE SUPPORT (2025-11-30)
            services: [],              // Array aller Services bei Multi-Service
            currentServiceIndex: 0,    // Welcher Service wird gerade in Step 2b bearbeitet
            serviceDetailsPerService: {}, // Service-Details pro Service: { 'lackier': {...}, 'reifen': {...} }
            additionalServicesFromEntwurf: [], // Original additionalServices aus Entwurf
            isMultiService: false,     // Flag fÃ¼r Multi-Service Modus
            // Ende Multi-Service Support
            teile: [], // Array von { teil: 'StoÃŸfÃ¤nger vorne', reparaturen: ['lackieren', 'spachteln'], ersatzteil: {...} }
            ersatzteile: [], // Array von { name, teilenummer, preis, lieferant, menge }
            currentPart: null,
            dbFahrzeugId: null // Falls aus DB geladen
        };

        // Geladene Fahrzeuge aus der Datenbank
        let loadedVehicles = [];
        let selectedDbVehicle = null;

        // Ersatzteile-Datenbank (aus Firestore geladen)
        let ersatzteileDB = [];

        // ============================================
        // ðŸš— FAHRZEUGE AUS FIRESTORE LADEN
        // ============================================

        // LÃ¤dt Fahrzeuge beim Seitenstart
        async function loadVehiclesFromDB() {
            const loading = document.getElementById('vehicleLoading');
            const empty = document.getElementById('vehicleEmpty');
            const listItems = document.getElementById('vehicleListItems');

            if (!loading || !listItems) return;

            try {
                loading.style.display = 'flex';
                if (empty) empty.style.display = 'none';
                listItems.innerHTML = '';

                // Firebase muss initialisiert sein
                await window.firebaseInitialized;

                const werkstattId = window.werkstattId;
                if (!werkstattId) {
                    console.warn('âš ï¸ Keine werkstattId gefunden');
                    loading.style.display = 'none';
                    if (empty) empty.style.display = 'flex';
                    return;
                }

                // Fahrzeuge aus Firestore laden (letzte 50, nach Datum sortiert)
                if (!window.getCollection) {
                    console.warn('âš ï¸ getCollection nicht verfÃ¼gbar');
                    loading.style.display = 'none';
                    if (empty) empty.style.display = 'flex';
                    return;
                }
                const snapshot = await window.getCollection('fahrzeuge')
                    .orderBy('erstelltAm', 'desc')
                    .limit(50)
                    .get();

                loadedVehicles = [];
                snapshot.forEach(doc => {
                    loadedVehicles.push({ id: doc.id, ...doc.data() });
                });

                loading.style.display = 'none';

                if (loadedVehicles.length === 0) {
                    if (empty) empty.style.display = 'flex';
                } else {
                    renderVehicleList(loadedVehicles);
                }

                console.log(`âœ… ${loadedVehicles.length} Fahrzeuge geladen`);

            } catch (error) {
                console.error('âŒ Fehler beim Laden der Fahrzeuge:', error);
                loading.style.display = 'none';
                if (empty) empty.style.display = 'flex';
            }
        }

        // Rendert die Fahrzeugliste
        function renderVehicleList(vehicles) {
            const listItems = document.getElementById('vehicleListItems');
            const empty = document.getElementById('vehicleEmpty');

            if (!listItems) return;

            if (vehicles.length === 0) {
                listItems.innerHTML = '';
                if (empty) empty.style.display = 'flex';
                return;
            }

            if (empty) empty.style.display = 'none';

            listItems.innerHTML = vehicles.map(v => {
                const marke = v.fahrzeugmarke || v.marke || '-';
                const modell = v.fahrzeugmodell || v.modell || '';
                const kennzeichen = v.kennzeichen || '';
                const kunde = v.kundenName || v.kunde || '';
                const serviceTyp = v.serviceTyp || '';
                const serviceLabel = SERVICE_LABELS[serviceTyp] || serviceTyp;

                return `
                    <div class="kalk-vehicle-item ${selectedDbVehicle && selectedDbVehicle.id === v.id ? 'selected' : ''}"
                         onclick="selectVehicleFromDB('${v.id}')">
                        <div class="kalk-vehicle-item__icon">ðŸš—</div>
                        <div class="kalk-vehicle-item__info">
                            <div class="kalk-vehicle-item__name">${marke} ${modell}</div>
                            <div class="kalk-vehicle-item__details">
                                ${kennzeichen ? `ðŸ”– ${kennzeichen}` : ''}
                                ${kunde ? ` â€¢ ðŸ‘¤ ${kunde}` : ''}
                            </div>
                        </div>
                        ${serviceLabel ? `<span class="kalk-vehicle-item__service">${serviceLabel}</span>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Suche in geladenen Fahrzeugen
        function searchVehicles() {
            const input = document.getElementById('vehicleSearchInput');
            const query = (input?.value || '').toLowerCase().trim();

            if (!query) {
                renderVehicleList(loadedVehicles);
                return;
            }

            const filtered = loadedVehicles.filter(v => {
                const marke = (v.fahrzeugmarke || v.marke || '').toLowerCase();
                const modell = (v.fahrzeugmodell || v.modell || '').toLowerCase();
                const kennzeichen = (v.kennzeichen || '').toLowerCase();
                const kunde = (v.kundenName || v.kunde || '').toLowerCase();

                return marke.includes(query) ||
                       modell.includes(query) ||
                       kennzeichen.includes(query) ||
                       kunde.includes(query);
            });

            renderVehicleList(filtered);
        }

        // Fahrzeug aus DB auswÃ¤hlen
        function selectVehicleFromDB(vehicleId) {
            const vehicle = loadedVehicles.find(v => String(v.id) === String(vehicleId));
            if (!vehicle) {
                console.error('Fahrzeug nicht gefunden:', vehicleId);
                return;
            }

            selectedDbVehicle = vehicle;

            // Wizard-Daten befÃ¼llen
            kalkWizardData.fahrzeug = {
                marke: vehicle.fahrzeugmarke || vehicle.marke || '',
                modell: vehicle.fahrzeugmodell || vehicle.modell || '',
                baujahr: vehicle.baujahr || '',
                kennzeichen: vehicle.kennzeichen || '',
                farbcode: vehicle.farbnummer || vehicle.farbcode || '',
                kunde: vehicle.kundenName || vehicle.kunde || '',
                // ðŸ†• FIX (Nov 30, 2025): ZusÃ¤tzliche Felder fÃ¼r Meister-Ãœbersicht
                kmstand: vehicle.kmstand || vehicle.kilometerstand || '',
                anliefertermin: vehicle.anliefertermin || vehicle.liefertermin || '',
                abholtermin: vehicle.abholtermin || vehicle.fertigstellungsdatum || '',
                ersatzfahrzeug: vehicle.ersatzfahrzeug || vehicle.ersatzfahrzeugGewuenscht || ''
            };
            kalkWizardData.dbFahrzeugId = vehicle.id;

            // ðŸ†• Auch auf Root-Level fÃ¼r einfacheren Zugriff
            kalkWizardData.kmstand = kalkWizardData.fahrzeug.kmstand;
            kalkWizardData.anliefertermin = kalkWizardData.fahrzeug.anliefertermin;
            kalkWizardData.abholtermin = kalkWizardData.fahrzeug.abholtermin;

            // ðŸš— Ersatzfahrzeug-Daten als Objekt Ã¼bernehmen (FIX: Nov 30, 2025)
            const ersatzfahrzeugFromVehicle = vehicle.kalkulationData?.ersatzfahrzeug;
            if (ersatzfahrzeugFromVehicle && typeof ersatzfahrzeugFromVehicle === 'object') {
                kalkWizardData.ersatzfahrzeug = ersatzfahrzeugFromVehicle;
                console.log('ðŸš— Ersatzfahrzeug-Kosten aus Fahrzeug geladen:', ersatzfahrzeugFromVehicle);
            } else {
                kalkWizardData.ersatzfahrzeug = kalkWizardData.fahrzeug.ersatzfahrzeug;
            }

            // Wenn Service bereits gesetzt ist, Ã¼bernehmen
            if (vehicle.serviceTyp) {
                kalkWizardData.serviceArt = vehicle.serviceTyp;
            }

            // UI aktualisieren
            const selectedDisplay = document.getElementById('selectedDbVehicle');
            const nameEl = document.getElementById('selectedVehicleName');
            const kennzeichenEl = document.getElementById('selectedVehicleKennzeichen');
            const kundeEl = document.getElementById('selectedVehicleKunde');

            if (selectedDisplay) {
                selectedDisplay.style.display = 'block';
                if (nameEl) nameEl.textContent = `${kalkWizardData.fahrzeug.marke} ${kalkWizardData.fahrzeug.modell}`;
                if (kennzeichenEl) kennzeichenEl.textContent = kalkWizardData.fahrzeug.kennzeichen ? `ðŸ”– ${kalkWizardData.fahrzeug.kennzeichen}` : '';
                if (kundeEl) kundeEl.textContent = kalkWizardData.fahrzeug.kunde ? `ðŸ‘¤ ${kalkWizardData.fahrzeug.kunde}` : '';
            }

            // Tabs ausblenden, da Fahrzeug gewÃ¤hlt
            const tabsContainer = document.querySelector('.kalk-vehicle-tabs');
            const tabExisting = document.getElementById('tabExisting');
            const tabNew = document.getElementById('tabNew');

            if (tabsContainer) tabsContainer.style.display = 'none';
            if (tabExisting) tabExisting.style.display = 'none';
            if (tabNew) tabNew.style.display = 'none';

            // Liste aktualisieren
            renderVehicleList(loadedVehicles);

            showToast(`Fahrzeug "${kalkWizardData.fahrzeug.marke} ${kalkWizardData.fahrzeug.modell}" ausgewÃ¤hlt`, 'success');
            feather.replace();
        }

        // Auswahl zurÃ¼cksetzen
        function clearSelectedVehicle() {
            selectedDbVehicle = null;
            selectedEntwurf = null;
            selectedPartnerAnfrage = null;
            kalkWizardData.fahrzeug = {
                marke: '', modell: '', baujahr: '', kennzeichen: '', farbcode: '', kunde: ''
            };
            kalkWizardData.dbFahrzeugId = null;
            kalkWizardData.entwurfId = null;
            kalkWizardData.partnerAnfrageId = null;
            kalkWizardData.entwurfPhotos = [];
            kalkWizardData.serviceArt = '';

            // UI zurÃ¼cksetzen
            const selectedDisplay = document.getElementById('selectedDbVehicle');
            const tabsContainer = document.querySelector('.kalk-vehicle-tabs');
            const tabEntwurf = document.getElementById('tabEntwurf');

            if (selectedDisplay) selectedDisplay.style.display = 'none';
            if (tabsContainer) tabsContainer.style.display = 'flex';
            // Zeige Standard-Tab (Entwurf)
            if (tabEntwurf) tabEntwurf.style.display = 'block';

            // Liste aktualisieren
            renderVehicleList(loadedVehicles);
            feather.replace();
        }

        // Tab-Wechsel in Step 1
        function switchVehicleTab(tab) {
            const buttons = document.querySelectorAll('.kalk-vehicle-tab');
            const tabEntwurf = document.getElementById('tabEntwurf');
            const tabPartner = document.getElementById('tabPartner');
            const tabExisting = document.getElementById('tabExisting');
            const tabNew = document.getElementById('tabNew');

            buttons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });

            // Hide all tabs
            if (tabEntwurf) tabEntwurf.style.display = 'none';
            if (tabPartner) tabPartner.style.display = 'none';
            if (tabExisting) tabExisting.style.display = 'none';
            if (tabNew) tabNew.style.display = 'none';

            // Show selected tab
            if (tab === 'entwurf') {
                if (tabEntwurf) tabEntwurf.style.display = 'block';
                loadEntwuerfe(); // EntwÃ¼rfe laden
            } else if (tab === 'partner') {
                if (tabPartner) tabPartner.style.display = 'block';
                loadPartnerAnfragen(); // Partner-Anfragen laden
            } else if (tab === 'existing') {
                if (tabExisting) tabExisting.style.display = 'block';
            } else if (tab === 'new') {
                if (tabNew) tabNew.style.display = 'block';
            }

            feather.replace();
        }

        // ============================================
        // ðŸ†• ENTWURF-INTEGRATION (Workflow: Annahme â†’ Kalkulation)
        // ============================================

        let loadedEntwuerfe = [];
        let selectedEntwurf = null;

        async function loadEntwuerfe() {
            const loading = document.getElementById('entwurfLoading');
            const empty = document.getElementById('entwurfEmpty');
            const listItems = document.getElementById('entwurfListItems');
            const countBadge = document.getElementById('entwurfCount');

            if (!loading || !listItems) return;

            try {
                loading.style.display = 'flex';
                if (empty) empty.style.display = 'none';
                listItems.innerHTML = '';

                await window.firebaseInitialized;
                if (!window.werkstattId || !window.getCollection) {
                    console.warn('âš ï¸ loadEntwuerfe: werkstattId oder getCollection nicht verfÃ¼gbar');
                    loading.style.display = 'none';
                    if (empty) empty.style.display = 'flex';
                    return;
                }

                // EntwÃ¼rfe aus partnerAnfragen laden (isEntwurf=true, entwurfStatus=offen)
                const snapshot = await window.getCollection('partnerAnfragen')
                    .where('isEntwurf', '==', true)
                    .where('entwurfStatus', '==', 'offen')
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .get();

                loadedEntwuerfe = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // ðŸ”§ FIX Nov 29, 2025: Nur EntwÃ¼rfe OHNE Kalkulation anzeigen
                    // EntwÃ¼rfe mit kalkulationErstelltAm haben bereits eine KVA
                    // Diese sollen in entwuerfe-bearbeiten.html weiter bearbeitet werden
                    if (!data.kalkulationErstelltAm) {
                        loadedEntwuerfe.push({ id: doc.id, ...data });
                    }
                });

                loading.style.display = 'none';

                // Badge aktualisieren
                if (countBadge) {
                    if (loadedEntwuerfe.length > 0) {
                        countBadge.textContent = loadedEntwuerfe.length;
                        countBadge.style.display = 'inline';
                    } else {
                        countBadge.style.display = 'none';
                    }
                }

                if (loadedEntwuerfe.length === 0) {
                    if (empty) empty.style.display = 'flex';
                } else {
                    renderEntwuerfeListe(loadedEntwuerfe);
                }

                console.log(`ðŸ“ ${loadedEntwuerfe.length} EntwÃ¼rfe geladen`);

            } catch (error) {
                console.error('âŒ Fehler beim Laden der EntwÃ¼rfe:', error);
                loading.style.display = 'none';
                if (empty) empty.style.display = 'flex';
            }
        }

        function renderEntwuerfeListe(entwuerfe) {
            const container = document.getElementById('entwurfListItems');
            if (!container) return;

            container.innerHTML = entwuerfe.map(entwurf => {
                // ðŸ†• MULTI-SERVICE SUPPORT (2025-11-30)
                const services = Array.isArray(entwurf.serviceTyp)
                    ? entwurf.serviceTyp
                    : [entwurf.serviceTyp || 'lackier'];
                const isMultiService = services.length > 1;
                const serviceLabelsStr = services.map(s => SERVICE_LABELS[s] || s).join(' + ');
                // ðŸ”§ FIX Bug #5 (2025-12-01): Fahrzeugschein-Fotos hinzufÃ¼gen
                const schadenFotos = entwurf.photoUrls || entwurf.photos || [];
                const fahrzeugscheinFotos = entwurf.fahrzeugscheinFotos || [];
                const photos = [...schadenFotos, ...fahrzeugscheinFotos];
                const hasPhotos = photos.length > 0;

                return `
                    <div class="entwurf-item ${selectedEntwurf?.id === entwurf.id ? 'selected' : ''}"
                         onclick="selectEntwurf('${entwurf.id}')">
                        <div class="entwurf-item__icon">${isMultiService ? 'ðŸ“¦' : 'ðŸ“'}</div>
                        <div class="entwurf-item__info">
                            <div class="entwurf-item__title">
                                ${entwurf.kennzeichen || 'Ohne Kennzeichen'}
                                ${entwurf.marke ? `- ${entwurf.marke} ${entwurf.modell || ''}` : ''}
                                ${isMultiService ? '<span style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; font-size: 10px; padding: 2px 6px; border-radius: 8px; margin-left: 8px;">MULTI</span>' : ''}
                            </div>
                            <div class="entwurf-item__meta">
                                <span><i data-feather="user" style="width:12px;height:12px;"></i> ${entwurf.kundenname || '-'}</span>
                                <span><i data-feather="calendar" style="width:12px;height:12px;"></i> ${entwurf.datum || '-'}</span>
                                <span class="entwurf-item__service">${serviceLabelsStr}</span>
                            </div>
                            ${hasPhotos ? `
                                <div class="entwurf-item__photos">
                                    ${photos.slice(0, 3).map(url => `
                                        <img src="${url}" class="entwurf-item__photo" alt="Foto">
                                    `).join('')}
                                    ${photos.length > 3 ? `
                                        <div class="entwurf-item__photo-more">+${photos.length - 3}</div>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                        <div class="entwurf-item__arrow">
                            <i data-feather="chevron-right"></i>
                        </div>
                    </div>
                `;
            }).join('');

            feather.replace();
        }

        function selectEntwurf(entwurfId) {
            selectedEntwurf = loadedEntwuerfe.find(e => e.id === entwurfId);
            if (!selectedEntwurf) {
                console.error('Entwurf nicht gefunden:', entwurfId);
                return;
            }

            console.log('ðŸ“ Entwurf ausgewÃ¤hlt:', selectedEntwurf);

            // Highlight selected item
            document.querySelectorAll('.entwurf-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            // Fahrzeugdaten aus Entwurf Ã¼bernehmen
            kalkWizardData.entwurfId = selectedEntwurf.id;
            kalkWizardData.fahrzeug = {
                marke: selectedEntwurf.marke || '',
                modell: selectedEntwurf.modell || '',
                baujahr: selectedEntwurf.baujahrVon || '',
                kennzeichen: selectedEntwurf.kennzeichen || '',
                farbcode: selectedEntwurf.farbcode || selectedEntwurf.farbnummer || '',
                kunde: selectedEntwurf.kundenname || '',
                // ðŸ†• FIX (Nov 30, 2025): ZusÃ¤tzliche Felder fÃ¼r Meister-Ãœbersicht
                kmstand: selectedEntwurf.kmstand || selectedEntwurf.kilometerstand || '',
                anliefertermin: selectedEntwurf.anliefertermin || selectedEntwurf.liefertermin || '',
                abholtermin: selectedEntwurf.abholtermin || selectedEntwurf.fertigstellungsdatum || '',
                ersatzfahrzeug: selectedEntwurf.ersatzfahrzeug || selectedEntwurf.ersatzfahrzeugGewuenscht || ''
            };

            // ðŸ†• Auch auf Root-Level fÃ¼r einfacheren Zugriff
            kalkWizardData.kmstand = kalkWizardData.fahrzeug.kmstand;
            kalkWizardData.anliefertermin = kalkWizardData.fahrzeug.anliefertermin;
            kalkWizardData.abholtermin = kalkWizardData.fahrzeug.abholtermin;

            // ðŸš— Ersatzfahrzeug-Daten als Objekt Ã¼bernehmen (FIX: Nov 30, 2025)
            const ersatzfahrzeugFromEntwurf = selectedEntwurf.kalkulationData?.ersatzfahrzeug;
            if (ersatzfahrzeugFromEntwurf && typeof ersatzfahrzeugFromEntwurf === 'object') {
                kalkWizardData.ersatzfahrzeug = ersatzfahrzeugFromEntwurf;
                console.log('ðŸš— Ersatzfahrzeug-Kosten aus Entwurf geladen:', ersatzfahrzeugFromEntwurf);
            } else {
                kalkWizardData.ersatzfahrzeug = kalkWizardData.fahrzeug.ersatzfahrzeug;
            }

            // Schadensbeschreibung/Notizen aus Entwurf
            kalkWizardData.schadenBeschreibung = selectedEntwurf.schadenBeschreibung || selectedEntwurf.beschreibung || '';
            kalkWizardData.notizen = selectedEntwurf.notizen || '';

            // ðŸ†• MULTI-SERVICE SUPPORT (2025-11-30)
            // Service-Art(en) Ã¼bernehmen
            if (Array.isArray(selectedEntwurf.serviceTyp) && selectedEntwurf.serviceTyp.length > 0) {
                kalkWizardData.services = [...selectedEntwurf.serviceTyp];
                kalkWizardData.isMultiService = selectedEntwurf.serviceTyp.length > 1;
            } else {
                kalkWizardData.services = [selectedEntwurf.serviceTyp || 'lackier'];
                kalkWizardData.isMultiService = false;
            }
            kalkWizardData.serviceArt = kalkWizardData.services[0]; // Backwards-Compat: Erster Service
            kalkWizardData.currentServiceIndex = 0;
            kalkWizardData.serviceDetailsPerService = {};

            // additionalServices aus Entwurf laden (fÃ¼r Service-Details)
            if (selectedEntwurf.additionalServices && Array.isArray(selectedEntwurf.additionalServices)) {
                kalkWizardData.additionalServicesFromEntwurf = selectedEntwurf.additionalServices;
                console.log('ðŸ†• Multi-Service: additionalServices geladen:', kalkWizardData.additionalServicesFromEntwurf);
            } else {
                kalkWizardData.additionalServicesFromEntwurf = [];
            }

            // ðŸ”§ FIX (2025-11-30): Service-Details aus Entwurf in serviceDetailsPerService vorausfÃ¼llen
            // Problem: Ohne diesen Code mÃ¼ssen bereits eingegebene Details nochmal eingegeben werden
            kalkWizardData.serviceDetailsPerService = {};

            // ðŸ”§ Feldnamen-Mapping (annahme.html â†’ kalkulation.html SERVICE_CONFIG)
            // annahme.html verwendet teilweise andere Feldnamen als SERVICE_CONFIG.zusatzfelder
            // ðŸ†• UPDATE Nov 30, 2025: SERVICE_CONFIG wurde erweitert um ALLE Felder aus annahme.html
            // Mappings nur noch nÃ¶tig wo Feldnamen unterschiedlich sind
            const normalizeServiceDetails = (details) => {
                if (!details || typeof details !== 'object') return {};
                const normalized = { ...details };

                // ===== REIFEN-MAPPING =====
                // reifentyp â†’ reifenTyp (camelCase in SERVICE_CONFIG)
                if (normalized.reifentyp !== undefined) {
                    normalized.reifenTyp = normalized.reifentyp;
                    delete normalized.reifentyp;
                }
                // reifengroesse âœ… (gleich)
                // reifenanzahl âœ… (jetzt in SERVICE_CONFIG)

                // ===== GLAS-MAPPING =====
                // scheibentyp, schadensgroesse, glasposition âœ… (jetzt in SERVICE_CONFIG)
                // kalibrierungNoetig âœ… (gleich)

                // ===== KLIMA-MAPPING =====
                // kaeltemittel âœ… (gleich)
                // klimaservice âœ… (jetzt in SERVICE_CONFIG)
                // klimaproblem âœ… (jetzt in SERVICE_CONFIG)

                // ===== DELLEN-MAPPING =====
                // dellenanzahl, dellengroesse, lackschaden, dellenpositionen âœ… (jetzt in SERVICE_CONFIG)

                // ===== MECHANIK-MAPPING =====
                // problem âœ… (jetzt in SERVICE_CONFIG)
                // symptome âœ… (gleich)

                // ===== VERSICHERUNG-MAPPING =====
                // schadensnummer, versicherung, schadendatum, unfallhergang âœ… (jetzt in SERVICE_CONFIG)

                // ===== PFLEGE-MAPPING =====
                // paket â†’ pflegePaket
                if (normalized.paket !== undefined) {
                    normalized.pflegePaket = normalized.paket;
                    delete normalized.paket;
                }
                // zusatzleistungen âœ… (jetzt in SERVICE_CONFIG)

                // ===== TUEV-MAPPING =====
                // faelligkeit â†’ huDatum
                if (normalized.faelligkeit !== undefined) {
                    normalized.huDatum = normalized.faelligkeit;
                    delete normalized.faelligkeit;
                }
                // pruefart âœ… (jetzt in SERVICE_CONFIG)
                // bekannteMaengel âœ… (gleich)

                // ===== FOLIERUNG-MAPPING =====
                // folierungArt âœ… (jetzt in SERVICE_CONFIG)
                // folierungMaterial â†’ folienTyp
                if (normalized.folierungMaterial !== undefined) {
                    normalized.folienTyp = normalized.folierungMaterial;
                    delete normalized.folierungMaterial;
                }
                // folierungSpezialTyp âœ… (jetzt in SERVICE_CONFIG)
                // folierungFarbe â†’ folienFarbe
                if (normalized.folierungFarbe !== undefined) {
                    normalized.folienFarbe = normalized.folierungFarbe;
                    delete normalized.folierungFarbe;
                }
                // folierungBereiche âœ… (jetzt in SERVICE_CONFIG)
                // folierungDesign â†’ designBeschreibung
                if (normalized.folierungDesign !== undefined) {
                    normalized.designBeschreibung = normalized.folierungDesign;
                    delete normalized.folierungDesign;
                }
                // folierungInfo âœ… (jetzt in SERVICE_CONFIG)

                // ===== STEINSCHUTZ-MAPPING =====
                // steinschutzUmfang âœ… (jetzt in SERVICE_CONFIG)
                // steinschutzMaterial â†’ folienTyp
                if (normalized.steinschutzMaterial !== undefined) {
                    normalized.folienTyp = normalized.steinschutzMaterial;
                    delete normalized.steinschutzMaterial;
                }
                // steinschutzBereiche âœ… (jetzt in SERVICE_CONFIG)
                // steinschutzInfo âœ… (jetzt in SERVICE_CONFIG)

                // ===== WERBEBEKLEBUNG-MAPPING =====
                // werbebeklebungUmfang âœ… (jetzt in SERVICE_CONFIG)
                // werbebeklebungKomplexitaet â†’ designKomplexitaet
                if (normalized.werbebeklebungKomplexitaet !== undefined) {
                    normalized.designKomplexitaet = normalized.werbebeklebungKomplexitaet;
                    delete normalized.werbebeklebungKomplexitaet;
                }
                // werbebeklebungText âœ… (jetzt in SERVICE_CONFIG)
                // werbebeklebungFarbanzahl â†’ farbanzahl
                if (normalized.werbebeklebungFarbanzahl !== undefined) {
                    normalized.farbanzahl = parseInt(normalized.werbebeklebungFarbanzahl) || 2;
                    delete normalized.werbebeklebungFarbanzahl;
                }
                // werbebeklebungInfo âœ… (jetzt in SERVICE_CONFIG)

                // ===== LACKIERUNG/LACKIER-MAPPING =====
                // farbname, farbvariante, farbnummer, lackart âœ… (jetzt in SERVICE_CONFIG)
                // ersatzfahrzeugGewuenscht âœ… (jetzt in SERVICE_CONFIG)
                // Boolean zu String konvertieren fÃ¼r Select-Feld
                if (normalized.ersatzfahrzeugGewuenscht !== undefined) {
                    if (typeof normalized.ersatzfahrzeugGewuenscht === 'boolean') {
                        normalized.ersatzfahrzeugGewuenscht = normalized.ersatzfahrzeugGewuenscht ? 'ja' : 'nein';
                    }
                }

                console.log('ðŸ“‹ Normalisierte Service-Details:', normalized);
                return normalized;
            };

            // 1. Primary Service Details laden
            const primaryService = kalkWizardData.services[0];
            if (selectedEntwurf.serviceDetails && typeof selectedEntwurf.serviceDetails === 'object') {
                kalkWizardData.serviceDetailsPerService[primaryService] = normalizeServiceDetails(selectedEntwurf.serviceDetails);
                console.log(`ðŸ“‹ Primary Service "${primaryService}" Details vorausgefÃ¼llt:`, kalkWizardData.serviceDetailsPerService[primaryService]);
            }

            // 2. Additional Services Details laden
            if (kalkWizardData.additionalServicesFromEntwurf.length > 0) {
                kalkWizardData.additionalServicesFromEntwurf.forEach(addService => {
                    if (addService.serviceTyp && addService.serviceDetails && typeof addService.serviceDetails === 'object') {
                        kalkWizardData.serviceDetailsPerService[addService.serviceTyp] = normalizeServiceDetails(addService.serviceDetails);
                        console.log(`ðŸ“‹ Additional Service "${addService.serviceTyp}" Details vorausgefÃ¼llt:`, kalkWizardData.serviceDetailsPerService[addService.serviceTyp]);
                    }
                });
            }

            // 3. Falls bereits serviceDetailsPerService vom vorherigen Kalkulations-Durchlauf existiert (PrioritÃ¤t!)
            if (selectedEntwurf.serviceDetailsPerService && typeof selectedEntwurf.serviceDetailsPerService === 'object') {
                Object.keys(selectedEntwurf.serviceDetailsPerService).forEach(serviceKey => {
                    // Ãœberschreibe mit Kalkulations-Daten (haben PrioritÃ¤t Ã¼ber Entwurf-Daten)
                    kalkWizardData.serviceDetailsPerService[serviceKey] = {
                        ...kalkWizardData.serviceDetailsPerService[serviceKey], // Entwurf-Basis
                        ...selectedEntwurf.serviceDetailsPerService[serviceKey]  // Kalkulations-Override
                    };
                    console.log(`ðŸ“‹ Kalkulations-Details fÃ¼r "${serviceKey}" Ã¼bernommen (PrioritÃ¤t):`, kalkWizardData.serviceDetailsPerService[serviceKey]);
                });
            }

            console.log('âœ… serviceDetailsPerService vollstÃ¤ndig geladen:', kalkWizardData.serviceDetailsPerService);

            console.log(`ðŸ†• Multi-Service Modus: ${kalkWizardData.isMultiService ? 'JA' : 'NEIN'}, Services:`, kalkWizardData.services);

            // Fotos speichern fÃ¼r Step 3 und 4
            // ðŸ”§ FIX Bug #5 (2025-12-01): Fahrzeugschein-Fotos hinzufÃ¼gen
            const schadenFotos = selectedEntwurf.photoUrls || selectedEntwurf.photos || [];
            const fahrzeugscheinFotos = selectedEntwurf.fahrzeugscheinFotos || [];
            kalkWizardData.entwurfPhotos = [...schadenFotos, ...fahrzeugscheinFotos];

            // ZusÃ¤tzliche Daten speichern
            kalkWizardData.kundenEmail = selectedEntwurf.kundenEmail || '';
            kalkWizardData.notizen = selectedEntwurf.notizen || '';
            kalkWizardData.schadenBeschreibung = selectedEntwurf.schadenBeschreibung || selectedEntwurf.notizen || '';
            kalkWizardData.farbe = selectedEntwurf.farbe || selectedEntwurf.farbname || '';
            kalkWizardData.datum = selectedEntwurf.datum || (selectedEntwurf.timestamp ? new Date(selectedEntwurf.timestamp).toLocaleDateString('de-DE') : '-');
            kalkWizardData.dringlichkeit = selectedEntwurf.dringlichkeit || selectedEntwurf.dringlichkeitLabel || '';
            kalkWizardData.quelle = 'entwurf';

            // Zeige ausgewÃ¤hltes Fahrzeug
            const selectedBox = document.getElementById('selectedDbVehicle');
            if (selectedBox) {
                selectedBox.style.display = 'block';
                document.getElementById('selectedVehicleName').textContent =
                    `${selectedEntwurf.marke || '-'} ${selectedEntwurf.modell || ''}`;
                document.getElementById('selectedVehicleKennzeichen').textContent =
                    selectedEntwurf.kennzeichen || '-';
                document.getElementById('selectedVehicleKunde').textContent =
                    `Kunde: ${selectedEntwurf.kundenname || '-'}`;
            }

            // Service-Art Radio-Button in Step 2 vorauswÃ¤hlen
            setTimeout(() => {
                const serviceRadio = document.querySelector(`input[name="serviceArt"][value="${kalkWizardData.serviceArt}"]`);
                if (serviceRadio) {
                    serviceRadio.checked = true;
                    // Trigger change event um UI zu aktualisieren
                    serviceRadio.dispatchEvent(new Event('change', { bubbles: true }));
                    console.log('âœ… Service vorausgewÃ¤hlt:', kalkWizardData.serviceArt);
                } else {
                    console.warn('âš ï¸ Service-Radio nicht gefunden fÃ¼r:', kalkWizardData.serviceArt);
                }
            }, 100);

            showToast(`âœ… Entwurf "${selectedEntwurf.kennzeichen}" Ã¼bernommen`, 'success');

            // ðŸ”§ FIX (2025-11-30): Bei Multi-Service zu Step 2b mit ALLEN Services auf einer Seite
            setTimeout(() => {
                // PrÃ¼fe ob irgendein Service Details hat
                const hasAnyServiceDetails = kalkWizardData.services.some(service => {
                    const config = SERVICE_CONFIG[service];
                    return config?.zusatzfelder && Object.keys(config.zusatzfelder).length > 0;
                });

                if (hasAnyServiceDetails) {
                    console.log('ðŸ†• Services haben Details, gehe zu Step 2b');
                    console.log('   Services:', kalkWizardData.services);

                    // Step 2b anzeigen mit ALLEN Services
                    currentStep = '2b';
                    renderAllServiceDetails(); // ðŸ†• NEU: Alle Services auf einer Seite!
                    updateStepUI();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    // Keine Service-Details nÃ¶tig â†’ Direkt zu Step 3
                    console.log('ðŸ†• Keine Service-Details nÃ¶tig, gehe direkt zu Step 3');
                    goToStep(3);
                }
            }, 500);
        }

        // ðŸ†• Fotos aus Entwurf in Step 3 und 4 anzeigen
        function renderEntwurfPhotos() {
            const photos = kalkWizardData.entwurfPhotos || [];
            if (photos.length === 0) return;

            // ðŸ†• FIX (Nov 30, 2025): Auch Step 2b hinzugefÃ¼gt fÃ¼r Meister-Ãœbersicht
            ['step2b', 'step3', 'step4'].forEach(step => {
                const section = document.getElementById(`${step}PhotosSection`);
                const gallery = document.getElementById(`${step}PhotosGallery`);

                if (section && gallery) {
                    section.style.display = 'block';
                    gallery.innerHTML = photos.map((url, index) => `
                        <img src="${url}"
                             class="entwurf-photo-thumb"
                             alt="Foto ${index + 1}"
                             onclick="openPhotoLightbox(${index})">
                    `).join('');
                }
            });
        }

        // ðŸ†• Auftragsinfo in Step 3 und Step 4 anzeigen
        // prefix: 'info' fÃ¼r Step 3, 'info4' fÃ¼r Step 4
        function renderAuftragsInfoForStep(stepId, prefix) {
            const infoBox = document.getElementById(stepId);
            if (!infoBox) return;

            // ðŸ”§ FIX (2025-11-30): Auftragsinfo IMMER anzeigen wenn Fahrzeug-Daten vorhanden
            // Vorher: Nur bei Entwurf/Partner-Anfrage angezeigt
            // Jetzt: Immer anzeigen, damit alle Infos wÃ¤hrend der Kalkulation sichtbar sind
            const hasVehicleData = kalkWizardData.fahrzeug?.kennzeichen || kalkWizardData.fahrzeug?.marke;
            const hasServiceData = kalkWizardData.serviceArt || (kalkWizardData.services && kalkWizardData.services.length > 0);

            if (!hasVehicleData && !hasServiceData) {
                infoBox.style.display = 'none';
                return;
            }

            infoBox.style.display = 'block';

            // Fahrzeug-Infos
            const setTextSafe = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value || '-';
            };

            setTextSafe(`${prefix}Kennzeichen`, kalkWizardData.fahrzeug?.kennzeichen);
            setTextSafe(`${prefix}Fahrzeug`, `${kalkWizardData.fahrzeug?.marke || ''} ${kalkWizardData.fahrzeug?.modell || ''}`.trim() || '-');
            // Farbe mit mehreren Fallbacks
            const farbe = kalkWizardData.farbe ||
                          kalkWizardData.fahrzeug?.farbcode ||
                          kalkWizardData.fahrzeug?.farbe ||
                          kalkWizardData.farbname ||
                          '-';
            setTextSafe(`${prefix}Farbe`, farbe);

            // Kunde-Infos
            setTextSafe(`${prefix}Kunde`, kalkWizardData.fahrzeug?.kunde);
            setTextSafe(`${prefix}Datum`, kalkWizardData.datum);

            // Partner anzeigen (nur bei Partner-Anfragen)
            const partnerRow = document.getElementById(`${prefix}PartnerRow`);
            if (partnerRow) {
                if (kalkWizardData.partnerName) {
                    partnerRow.style.display = 'flex';
                    setTextSafe(`${prefix}Partner`, kalkWizardData.partnerName);
                } else {
                    partnerRow.style.display = 'none';
                }
            }

            // Service-Infos - Multi-Service Support
            let serviceDisplay = '-';
            if (kalkWizardData.isMultiService && kalkWizardData.services && kalkWizardData.services.length > 1) {
                serviceDisplay = kalkWizardData.services
                    .map(s => SERVICE_LABELS[s] || s)
                    .join(', ');
                serviceDisplay += ` (${kalkWizardData.services.length} Services)`;
            } else {
                serviceDisplay = SERVICE_LABELS[kalkWizardData.serviceArt] || kalkWizardData.serviceArt || '-';
            }
            setTextSafe(`${prefix}Service`, serviceDisplay);

            // Dringlichkeit anzeigen (wenn vorhanden)
            const dringlichkeitRow = document.getElementById(`${prefix}DringlichkeitRow`);
            if (dringlichkeitRow) {
                if (kalkWizardData.dringlichkeit) {
                    dringlichkeitRow.style.display = 'flex';
                    setTextSafe(`${prefix}Dringlichkeit`, kalkWizardData.dringlichkeit);
                } else {
                    dringlichkeitRow.style.display = 'none';
                }
            }

            // Schadensbeschreibung anzeigen (wenn vorhanden)
            const schadenSection = document.getElementById(`${prefix}SchadenSection`);
            if (schadenSection) {
                if (kalkWizardData.schadenBeschreibung) {
                    schadenSection.style.display = 'block';
                    setTextSafe(`${prefix}Schaden`, kalkWizardData.schadenBeschreibung);
                } else {
                    schadenSection.style.display = 'none';
                }
            }

            // Notizen anzeigen (wenn vorhanden und unterschiedlich von Schadensbeschreibung)
            const notizenSection = document.getElementById(`${prefix}NotizenSection`);
            if (notizenSection) {
                if (kalkWizardData.notizen && kalkWizardData.notizen !== kalkWizardData.schadenBeschreibung) {
                    notizenSection.style.display = 'block';
                    setTextSafe(`${prefix}Notizen`, kalkWizardData.notizen);
                } else {
                    notizenSection.style.display = 'none';
                }
            }

            // Service-Details anzeigen
            renderAuftragsServiceDetailsForStep(`${prefix}ServiceDetailsSection`, `${prefix}ServiceDetails`);

            feather.replace();
        }

        // Wrapper fÃ¼r Step 2 (ðŸ†• Nov 30, 2025)
        function renderAuftragsInfoStep2() {
            renderAuftragsInfoForStep('step2AuftragsInfo', 'info2');
        }

        // Wrapper fÃ¼r Step 2b (ðŸ†• Nov 30, 2025)
        // ðŸ”§ FIX: Meister benÃ¶tigt ALLE Infos in Step 2b fÃ¼r Service-Details Eingabe
        function renderAuftragsInfoStep2b() {
            console.log('ðŸ”§ renderAuftragsInfoStep2b() called');
            console.log('   kalkWizardData.fahrzeug:', kalkWizardData.fahrzeug);

            // Generische Funktion aufrufen (befÃ¼llt Standard-Felder)
            renderAuftragsInfoForStep('step2bAuftragsInfo', 'info2b');

            // ðŸ†• FIX (Nov 30, 2025): Box IMMER anzeigen in Step 2b wenn Fahrzeug ausgewÃ¤hlt
            // Der Meister braucht alle Infos wÃ¤hrend der Service-Details Eingabe
            const infoBox = document.getElementById('step2bAuftragsInfo');
            if (infoBox && kalkWizardData.fahrzeug) {
                infoBox.style.display = 'block';
                console.log('âœ… Step 2b Auftragsinfo-Box angezeigt');
            }

            // ðŸ†• ZUSÃ„TZLICHE FELDER fÃ¼r Step 2b (Nov 30, 2025)
            // Diese Felder werden in der generischen Funktion nicht befÃ¼llt
            const setTextSafe = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value || '-';
            };

            // KM-Stand
            const kmStand = kalkWizardData.fahrzeug?.kmstand ||
                            kalkWizardData.fahrzeug?.kilometerstand ||
                            kalkWizardData.kmstand ||
                            kalkWizardData.kilometerstand;
            if (kmStand) {
                setTextSafe('info2bKmStand', `${parseInt(kmStand).toLocaleString('de-DE')} km`);
            }

            // Anliefertermin
            const anliefertermin = kalkWizardData.anliefertermin ||
                                   kalkWizardData.fahrzeug?.anliefertermin ||
                                   kalkWizardData.termine?.anliefertermin;
            if (anliefertermin) {
                setTextSafe('info2bAnliefertermin', formatDateForDisplay(anliefertermin));
            }

            // Abholtermin
            const abholtermin = kalkWizardData.abholtermin ||
                               kalkWizardData.fahrzeug?.abholtermin ||
                               kalkWizardData.termine?.abholtermin;
            if (abholtermin) {
                setTextSafe('info2bAbholtermin', formatDateForDisplay(abholtermin));
            }

            // Ersatzfahrzeug
            const ersatzfahrzeug = kalkWizardData.ersatzfahrzeug ||
                                   kalkWizardData.fahrzeug?.ersatzfahrzeug ||
                                   kalkWizardData.ersatzfahrzeugGewuenscht;
            if (ersatzfahrzeug) {
                const ersatzText = ersatzfahrzeug === true || ersatzfahrzeug === 'ja' || ersatzfahrzeug === 'Ja'
                    ? 'âœ… Ja, gewÃ¼nscht'
                    : ersatzfahrzeug === false || ersatzfahrzeug === 'nein' || ersatzfahrzeug === 'Nein'
                        ? 'âŒ Nein'
                        : ersatzfahrzeug;
                setTextSafe('info2bErsatzfahrzeug', ersatzText);
            }

            console.log('âœ… Step 2b zusÃ¤tzliche Felder befÃ¼llt:', {
                kmStand, anliefertermin, abholtermin, ersatzfahrzeug
            });
        }

        // Hilfsfunktion: Datum formatieren
        function formatDateForDisplay(dateStr) {
            if (!dateStr) return '-';
            try {
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) return dateStr;
                return date.toLocaleDateString('de-DE', {
                    weekday: 'short',
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric'
                });
            } catch (e) {
                return dateStr;
            }
        }

        // Wrapper fÃ¼r Step 3 (KompatibilitÃ¤t)
        function renderAuftragsInfo() {
            renderAuftragsInfoForStep('step3AuftragsInfo', 'info');
        }

        // Wrapper fÃ¼r Step 4
        function renderAuftragsInfoStep4() {
            renderAuftragsInfoForStep('step4AuftragsInfo', 'info4');
        }

        // Wrapper fÃ¼r Step 5
        function renderAuftragsInfoStep5() {
            renderAuftragsInfoForStep('step5AuftragsInfo', 'info5');
        }

        // Wrapper fÃ¼r Step 6
        function renderAuftragsInfoStep6() {
            renderAuftragsInfoForStep('step6AuftragsInfo', 'info6');
        }

        /**
         * ðŸ†• Rendert die Service-Details in der Auftragsinformationen-Box
         * Parametrisiert fÃ¼r Step 3 und Step 4
         */
        function renderAuftragsServiceDetailsForStep(sectionId, containerId) {
            const section = document.getElementById(sectionId);
            const container = document.getElementById(containerId);

            if (!section || !container) return;

            const services = kalkWizardData.services || [kalkWizardData.serviceArt];
            const detailsPerService = kalkWizardData.serviceDetailsPerService || {};

            // PrÃ¼fen ob Ã¼berhaupt Details vorhanden sind
            let hasAnyDetails = false;
            for (const service of services) {
                const details = detailsPerService[service];
                if (details && Object.keys(details).length > 0) {
                    hasAnyDetails = true;
                    break;
                }
            }

            if (!hasAnyDetails) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';

            // HTML fÃ¼r Service-Details generieren
            let html = '';

            for (const service of services) {
                const details = detailsPerService[service];
                if (!details || Object.keys(details).length === 0) continue;

                const serviceLabel = SERVICE_LABELS[service] || service;
                const serviceIcon = getServiceIcon(service);
                const config = SERVICE_CONFIG[service];

                html += `
                    <div class="service-detail-card" style="
                        background: var(--color-surface);
                        border: 1px solid var(--color-border);
                        border-radius: var(--radius-md);
                        padding: var(--space-3);
                        margin-bottom: var(--space-2);
                    ">
                        <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-2); font-weight: var(--font-weight-semibold); color: var(--color-primary);">
                            <span>${serviceIcon}</span>
                            <span>${serviceLabel}</span>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: var(--space-2); font-size: var(--font-size-sm);">
                `;

                // ðŸ†• FIX (Nov 30, 2025): Nur Felder anzeigen, die in SERVICE_CONFIG.zusatzfelder definiert sind
                // UND die typischen Partner-Felder (art, info, etc.)
                const allowedFields = config?.zusatzfelder ? Object.keys(config.zusatzfelder) : [];
                // FÃ¼ge auch die Original-Partner-Felder hinzu (bevor sie gemappt wurden)
                const partnerFields = ['art', 'info', 'teile', 'karosserie', 'ersatzteil', 'farbcode'];

                // Details durchlaufen - aber nur relevante Felder anzeigen
                for (const [key, value] of Object.entries(details)) {
                    if (!value || value === '' || value === 'undefined') continue;

                    // ðŸ†• FIX: Nur Felder anzeigen, die entweder:
                    // 1. In SERVICE_CONFIG.zusatzfelder definiert sind, ODER
                    // 2. Typische Partner-Felder sind (art, info, teile, etc.)
                    const isAllowedField = allowedFields.includes(key) || partnerFields.includes(key);
                    if (!isAllowedField && allowedFields.length > 0) {
                        // Wenn SERVICE_CONFIG.zusatzfelder existiert, nur definierte Felder anzeigen
                        continue;
                    }

                    // Label aus SERVICE_CONFIG holen oder formatieren
                    let label = key;
                    if (config?.zusatzfelder?.[key]?.label) {
                        label = config.zusatzfelder[key].label;
                    } else {
                        // CamelCase zu lesbar
                        label = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                    }

                    // Wert formatieren (Arrays als Liste)
                    let displayValue = value;
                    if (Array.isArray(value)) {
                        displayValue = value.join(', ');
                    } else if (typeof value === 'boolean') {
                        displayValue = value ? 'Ja' : 'Nein';
                    }

                    html += `
                        <div style="display: flex; flex-direction: column;">
                            <span style="color: var(--color-text-secondary); font-size: var(--font-size-xs);">${label}</span>
                            <span style="color: var(--color-text-primary);">${displayValue}</span>
                        </div>
                    `;
                }

                html += `
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // Wrapper fÃ¼r Step 3 (KompatibilitÃ¤t)
        function renderAuftragsServiceDetails() {
            renderAuftragsServiceDetailsForStep('infoServiceDetailsSection', 'infoServiceDetails');
        }

        // Toggle Auftragsinfo ein/ausklappen (parametrisiert fÃ¼r Step 2, 3, 4, 5 und 6)
        function toggleAuftragsInfo(step = 'step3') {
            let contentId, toggleId;

            if (step === 'step6') {
                contentId = 'auftragsInfoContent6';
                toggleId = 'auftragsInfoToggle6';
            } else if (step === 'step5') {
                contentId = 'auftragsInfoContent5';
                toggleId = 'auftragsInfoToggle5';
            } else if (step === 'step4') {
                contentId = 'auftragsInfoContent4';
                toggleId = 'auftragsInfoToggle4';
            } else if (step === 'step2b') {
                // ðŸ†• Nov 30, 2025: Step 2b Support
                contentId = 'auftragsInfoContent2b';
                toggleId = 'auftragsInfoToggle2b';
            } else if (step === 'step2') {
                // ðŸ†• Nov 30, 2025: Step 2 Support
                contentId = 'auftragsInfoContent2';
                toggleId = 'auftragsInfoToggle2';
            } else {
                contentId = 'auftragsInfoContent';
                toggleId = 'auftragsInfoToggle';
            }

            const content = document.getElementById(contentId);
            const toggle = document.getElementById(toggleId);
            if (content && toggle) {
                content.classList.toggle('collapsed');
                const icon = toggle.querySelector('i');
                if (icon) {
                    icon.setAttribute('data-feather', content.classList.contains('collapsed') ? 'chevron-down' : 'chevron-up');
                    feather.replace();
                }
            }
        }

        let currentLightboxIndex = 0;

        function openPhotoLightbox(index) {
            const photos = kalkWizardData.entwurfPhotos || [];
            if (photos.length === 0) return;

            currentLightboxIndex = index;

            const lightbox = document.createElement('div');
            lightbox.className = 'photo-lightbox';
            lightbox.id = 'photoLightbox';
            lightbox.innerHTML = `
                <button class="photo-lightbox__close" onclick="closePhotoLightbox()">
                    <i data-feather="x"></i>
                </button>
                ${photos.length > 1 ? `
                    <button class="photo-lightbox__nav photo-lightbox__nav--prev" onclick="navigateLightbox(-1)">
                        <i data-feather="chevron-left"></i>
                    </button>
                    <button class="photo-lightbox__nav photo-lightbox__nav--next" onclick="navigateLightbox(1)">
                        <i data-feather="chevron-right"></i>
                    </button>
                ` : ''}
                <img src="${photos[index]}" class="photo-lightbox__image" id="lightboxImage">
                <div class="photo-lightbox__counter">${index + 1} / ${photos.length}</div>
            `;

            document.body.appendChild(lightbox);
            feather.replace();

            // ESC zum SchlieÃŸen
            document.addEventListener('keydown', handleLightboxKeydown);
        }

        function closePhotoLightbox() {
            const lightbox = document.getElementById('photoLightbox');
            if (lightbox) {
                lightbox.remove();
                document.removeEventListener('keydown', handleLightboxKeydown);
            }
        }

        function navigateLightbox(direction) {
            const photos = kalkWizardData.entwurfPhotos || [];
            currentLightboxIndex = (currentLightboxIndex + direction + photos.length) % photos.length;

            const img = document.getElementById('lightboxImage');
            const counter = document.querySelector('.photo-lightbox__counter');
            if (img) img.src = photos[currentLightboxIndex];
            if (counter) counter.textContent = `${currentLightboxIndex + 1} / ${photos.length}`;
        }

        function handleLightboxKeydown(e) {
            if (e.key === 'Escape') closePhotoLightbox();
            if (e.key === 'ArrowLeft') navigateLightbox(-1);
            if (e.key === 'ArrowRight') navigateLightbox(1);
        }

        function togglePhotoGallery(step) {
            openPhotoLightbox(0);
        }

        // ============================================
        // ðŸ†• ENTWURF-FOTOS FÃœR KI-ANALYSE
        // ============================================

        let selectedKIFotos = new Set();

        function renderEntwurfFotosForKI() {
            const photos = kalkWizardData.entwurfPhotos || [];
            const section = document.getElementById('entwurfFotosSection');
            const grid = document.getElementById('entwurfFotosGrid');
            const uploadTitle = document.getElementById('fotoUploadTitle');

            if (!section || !grid) return;

            // Wenn keine Fotos aus Entwurf vorhanden, Section ausblenden
            if (photos.length === 0) {
                section.style.display = 'none';
                if (uploadTitle) uploadTitle.textContent = 'Schadenfotos hochladen';
                return;
            }

            // Section anzeigen und Upload-Text anpassen
            section.style.display = 'block';
            if (uploadTitle) uploadTitle.textContent = 'Weitere Fotos hochladen';

            // Alle Fotos standardmÃ¤ÃŸig auswÃ¤hlen
            selectedKIFotos = new Set(photos.map((_, i) => i));

            // Foto-Grid rendern
            grid.innerHTML = photos.map((url, index) => `
                <div class="entwurf-foto-item selected" data-index="${index}" onclick="toggleKIFotoSelection(${index})">
                    <img src="${url}" alt="Foto ${index + 1}">
                    <div class="entwurf-foto-item__checkbox">
                        <i data-feather="check"></i>
                    </div>
                    <div class="entwurf-foto-item__number">Foto ${index + 1}</div>
                </div>
            `).join('');

            updateSelectedFotosCount();
            feather.replace();
        }

        function toggleKIFotoSelection(index) {
            const item = document.querySelector(`.entwurf-foto-item[data-index="${index}"]`);
            if (!item) return;

            if (selectedKIFotos.has(index)) {
                selectedKIFotos.delete(index);
                item.classList.remove('selected');
            } else {
                selectedKIFotos.add(index);
                item.classList.add('selected');
            }

            updateSelectedFotosCount();
        }

        function selectAllEntwurfFotos() {
            const photos = kalkWizardData.entwurfPhotos || [];
            selectedKIFotos = new Set(photos.map((_, i) => i));

            document.querySelectorAll('.entwurf-foto-item').forEach(item => {
                item.classList.add('selected');
            });

            updateSelectedFotosCount();
        }

        function deselectAllEntwurfFotos() {
            selectedKIFotos.clear();

            document.querySelectorAll('.entwurf-foto-item').forEach(item => {
                item.classList.remove('selected');
            });

            updateSelectedFotosCount();
        }

        function updateSelectedFotosCount() {
            const countBadge = document.getElementById('selectedFotosCount');
            const analyzeBtn = document.getElementById('btnAnalyzeEntwurfFotos');

            if (countBadge) {
                countBadge.textContent = `${selectedKIFotos.size} ausgewÃ¤hlt`;
            }

            if (analyzeBtn) {
                analyzeBtn.disabled = selectedKIFotos.size === 0;
                if (selectedKIFotos.size === 0) {
                    analyzeBtn.innerHTML = '<i data-feather="cpu"></i> Bitte Fotos auswÃ¤hlen';
                } else {
                    analyzeBtn.innerHTML = `<i data-feather="cpu"></i> ${selectedKIFotos.size} Foto${selectedKIFotos.size > 1 ? 's' : ''} analysieren`;
                }
                feather.replace();
            }
        }

        async function analyzeSelectedEntwurfFotos() {
            const photos = kalkWizardData.entwurfPhotos || [];
            const selectedPhotos = Array.from(selectedKIFotos).map(i => photos[i]).filter(Boolean);

            if (selectedPhotos.length === 0) {
                showToast('Bitte wÃ¤hlen Sie mindestens ein Foto aus', 'warning');
                return;
            }

            console.log('ðŸ¤– KI-Analyse starten mit', selectedPhotos.length, 'Fotos (URLs)');

            // Loading anzeigen
            const loading = document.getElementById('kiAnalyseLoading');
            const result = document.getElementById('kiAnalyseResult');
            if (loading) loading.style.display = 'block';
            if (result) result.style.display = 'none';

            try {
                // OpenAI API Key aus SettingsManager oder Firestore laden
                let apiKey = '';
                if (window.settingsManager?.currentSettings?.systemConfig?.openaiKey) {
                    apiKey = window.settingsManager.currentSettings.systemConfig.openaiKey;
                    console.log('âœ… API-Key aus settingsManager geladen');
                } else {
                    // Fallback: Direkt aus Firestore laden via Multi-Tenant Helper
                    console.log('ðŸ“¥ Lade API-Key aus Firestore via getCollection()');
                    const settingsDoc = await window.getCollection('einstellungen').doc('config').get();
                    if (settingsDoc.exists) {
                        apiKey = settingsDoc.data()?.systemConfig?.openaiKey || '';
                        console.log('âœ… API-Key aus Firestore geladen');
                    }
                }

                if (!apiKey) {
                    throw new Error('OpenAI API-Key nicht konfiguriert. Bitte in Admin-Einstellungen hinterlegen.');
                }

                // Bilder fÃ¼r GPT-4 Vision vorbereiten (max 4 URLs)
                const imagesToAnalyze = selectedPhotos.slice(0, 4);

                const imageContents = imagesToAnalyze.map(url => ({
                    type: 'image_url',
                    image_url: {
                        url: url,
                        detail: 'high'
                    }
                }));

                // Service-Kontext fÃ¼r prÃ¤zisere KI-Analyse
                const serviceArt = kalkWizardData.serviceArt || 'lackier';
                const serviceLabel = SERVICE_LABELS[serviceArt] || 'Lackierung';
                const serviceConfig = SERVICE_CONFIG[serviceArt] || SERVICE_CONFIG['lackier'];
                const verfuegbareTeile = serviceConfig.teile || [];
                const verfuegbareArbeiten = serviceConfig.arbeiten || [];

                console.log('ðŸ¤– Sende', imageContents.length, 'Bilder an GPT-4 Vision...');
                console.log('ðŸ“‹ Service-Kontext:', serviceLabel, '- Teile:', verfuegbareTeile.length);

                // GPT-4 Vision API aufrufen mit Service-Kontext
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        messages: [
                            {
                                role: 'system',
                                content: `Du bist ein Experte fÃ¼r Fahrzeugschaden-Analyse in einer Lackierwerkstatt.
Der Kunde hat den Service "${serviceLabel}" gewÃ¤hlt.

KONTEXT - Dieser Service umfasst typischerweise:
- VerfÃ¼gbare Fahrzeugteile: ${verfuegbareTeile.join(', ')}
- MÃ¶gliche Arbeiten: ${verfuegbareArbeiten.join(', ')}

Analysiere die Bilder und identifiziere alle sichtbaren SchÃ¤den am Fahrzeug.
Fokussiere dich auf SchÃ¤den, die fÃ¼r den Service "${serviceLabel}" relevant sind.

WICHTIG: Antworte NUR im folgenden JSON-Format (keine Markdown, keine ErklÃ¤rungen):
{
  "schaeden": [
    {
      "teil": "Exakte Bezeichnung aus der Teile-Liste oben (z.B. StoÃŸfÃ¤nger vorne, KotflÃ¼gel vorne links)",
      "schaden": "Art des Schadens (z.B. Kratzer, Delle, Steinschlag, Rost, Riss, Lackabplatzer)",
      "schweregrad": "leicht/mittel/schwer",
      "empfohleneArbeiten": ["Array der empfohlenen Arbeiten aus der Liste oben"],
      "confidence": 0.0-1.0
    }
  ],
  "zusammenfassung": "Kurze Zusammenfassung des Gesamtschadens",
  "geschaetzteDauer": "GeschÃ¤tzte Gesamtdauer in Stunden (z.B. '4-6 Stunden')"
}

REGELN:
1. Verwende NUR Teile-Bezeichnungen aus der verfÃ¼gbaren Teile-Liste
2. Empfehle NUR Arbeiten aus der verfÃ¼gbaren Arbeiten-Liste
3. Bei VersicherungsschÃ¤den: Dokumentiere alle SchÃ¤den grÃ¼ndlich
4. Bei Dellen: Fokus auf ausbeulbare Dellen ohne Lackreparatur
5. Sei prÃ¤zise bei der Lokalisierung (links/rechts, vorne/hinten)`
                            },
                            {
                                role: 'user',
                                content: [
                                    {
                                        type: 'text',
                                        text: `Analysiere diese Fahrzeugbilder fÃ¼r den Service "${serviceLabel}". Identifiziere alle relevanten SchÃ¤den und gib das Ergebnis als JSON zurÃ¼ck.`
                                    },
                                    ...imageContents
                                ]
                            }
                        ],
                        max_tokens: 2000,
                        temperature: 0.2
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'API-Fehler');
                }

                const data = await response.json();
                const content = data.choices?.[0]?.message?.content || '';

                console.log('ðŸ¤– GPT-4 Vision Antwort erhalten');

                // JSON aus der Antwort extrahieren
                let analysisResult;
                try {
                    analysisResult = JSON.parse(content);
                } catch {
                    const jsonMatch = content.match(/```json\s*([\s\S]*?)\s*```/) ||
                                     content.match(/\{[\s\S]*"schaeden"[\s\S]*\}/);
                    if (jsonMatch) {
                        analysisResult = JSON.parse(jsonMatch[1] || jsonMatch[0]);
                    } else {
                        throw new Error('Konnte KI-Antwort nicht parsen');
                    }
                }

                // Ergebnisse anzeigen mit erweiterten Daten
                kiErkannteSchaeden = (analysisResult.schaeden || []).map((s, idx) => ({
                    id: `ki-${Date.now()}-${idx}`,
                    teil: s.teil,
                    schaden: s.schaden,
                    schweregrad: s.schweregrad || 'mittel',
                    empfohleneArbeiten: s.empfohleneArbeiten || [s.repairType || 'lackieren'],
                    confidence: s.confidence || 0.8,
                    selected: true
                }));

                // ZusÃ¤tzliche KI-Infos speichern
                window.kiAnalyseResult = {
                    zusammenfassung: analysisResult.zusammenfassung,
                    geschaetzteDauer: analysisResult.geschaetzteDauer,
                    serviceKontext: serviceLabel,
                    analysiertAm: new Date().toISOString()
                };

                // UI aktualisieren
                if (loading) loading.style.display = 'none';
                if (result) result.style.display = 'block';

                renderKISchaeden(analysisResult.zusammenfassung, analysisResult.geschaetzteDauer);

                showToast(`âœ… ${kiErkannteSchaeden.length} SchÃ¤den erkannt`, 'success');
                console.log('âœ… KI-Analyse abgeschlossen:', kiErkannteSchaeden);

            } catch (error) {
                console.error('âŒ KI-Analyse Fehler:', error);
                showToast('Fehler: ' + error.message, 'error');
                if (loading) loading.style.display = 'none';
            }
        }

        // KI-SchÃ¤den in der UI rendern mit Bearbeiten/LÃ¶schen
        function renderKISchaeden(zusammenfassung, geschaetzteDauer) {
            const liste = document.getElementById('kiSchaedenListe');
            if (!liste) return;

            const serviceArt = kalkWizardData.serviceArt || 'lackier';
            const serviceConfig = SERVICE_CONFIG[serviceArt] || SERVICE_CONFIG['lackier'];
            const verfuegbareTeile = serviceConfig.teile || [];

            liste.innerHTML = `
                <!-- Zusammenfassung -->
                <div class="ki-zusammenfassung" style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: var(--space-4); border-radius: var(--radius-md); margin-bottom: var(--space-4); border-left: 4px solid var(--color-primary);">
                    <div style="display: flex; justify-content: space-between; align-items: start; gap: var(--space-3);">
                        <div style="flex: 1;">
                            <strong style="font-size: var(--font-size-base);">ðŸ“‹ KI-Zusammenfassung:</strong>
                            <p style="margin: var(--space-2) 0 0 0; color: var(--color-text-secondary);">${zusammenfassung || 'Keine Zusammenfassung verfÃ¼gbar'}</p>
                        </div>
                        ${geschaetzteDauer ? `
                        <div style="text-align: right; min-width: 120px;">
                            <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">GeschÃ¤tzte Dauer:</div>
                            <div style="font-weight: 600; color: var(--color-primary);">${geschaetzteDauer}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>

                <!-- Header mit ZÃ¤hler und HinzufÃ¼gen-Button -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-3);">
                    <div style="font-weight: 600; color: var(--color-text-primary);">
                        ðŸ”§ Erkannte Teile: <span id="kiSelectedCount">${kiErkannteSchaeden.filter(s => s.selected).length}</span>/${kiErkannteSchaeden.length}
                    </div>
                    <button type="button" class="btn btn-sm btn-outline" onclick="showAddKITeilModal()">
                        <i data-feather="plus"></i> Teil hinzufÃ¼gen
                    </button>
                </div>

                <!-- SchÃ¤den-Liste -->
                <div id="kiSchaedenItems">
                    ${kiErkannteSchaeden.map((schaden, index) => renderKISchadenItem(schaden, index)).join('')}
                </div>

                <!-- Manuell hinzugefÃ¼gte Teile Bereich -->
                <div id="manuelleTeileSection" style="display: none; margin-top: var(--space-4); padding-top: var(--space-4); border-top: 2px dashed var(--color-border);">
                    <div style="font-weight: 600; color: var(--color-text-primary); margin-bottom: var(--space-3);">
                        âž• Manuell hinzugefÃ¼gt:
                    </div>
                    <div id="manuelleTeileItems"></div>
                </div>

                <!-- BestÃ¤tigen Button -->
                <div style="margin-top: var(--space-4); padding-top: var(--space-4); border-top: 1px solid var(--color-border);">
                    <button type="button" class="btn btn-primary btn-lg" onclick="confirmKIAnalyseAndProceed()" style="width: 100%;">
                        <i data-feather="check-circle"></i>
                        Auswahl bestÃ¤tigen & zu Schritt 4
                    </button>
                    <p style="text-align: center; margin-top: var(--space-2); font-size: var(--font-size-sm); color: var(--color-text-secondary);">
                        Die ausgewÃ¤hlten Teile werden in die Kalkulation Ã¼bernommen
                    </p>
                </div>
            `;

            // Feather Icons aktualisieren
            if (typeof feather !== 'undefined') feather.replace();
        }

        // Einzelnen KI-Schaden rendern
        function renderKISchadenItem(schaden, index) {
            const schwereColors = {
                'leicht': { bg: '#ecfdf5', border: '#10b981', text: '#059669' },
                'mittel': { bg: '#fef3c7', border: '#f59e0b', text: '#d97706' },
                'schwer': { bg: '#fee2e2', border: '#ef4444', text: '#dc2626' }
            };
            const colors = schwereColors[schaden.schweregrad] || schwereColors['mittel'];
            const arbeitenText = Array.isArray(schaden.empfohleneArbeiten)
                ? schaden.empfohleneArbeiten.join(', ')
                : schaden.empfohleneArbeiten || '-';

            return `
                <div class="ki-schaden-item" id="kiSchaden-${index}" style="display: flex; align-items: stretch; gap: var(--space-3); padding: var(--space-3); background: ${schaden.selected ? 'white' : '#f9fafb'}; border: 1px solid ${schaden.selected ? colors.border : 'var(--color-border)'}; border-radius: var(--radius-md); margin-bottom: var(--space-2); opacity: ${schaden.selected ? '1' : '0.6'}; transition: all 0.2s;">
                    <!-- Checkbox -->
                    <div style="display: flex; align-items: center;">
                        <input type="checkbox" id="kiSchadenCheck${index}" ${schaden.selected ? 'checked' : ''}
                               onchange="toggleKISchaden(${index})"
                               style="width: 22px; height: 22px; cursor: pointer;">
                    </div>

                    <!-- Hauptinhalt -->
                    <div style="flex: 1; min-width: 0;">
                        <div style="display: flex; align-items: center; gap: var(--space-2); margin-bottom: var(--space-1);">
                            <span style="font-weight: 600; color: var(--color-text-primary);">${schaden.teil}</span>
                            <span class="badge" style="font-size: 10px; background: ${colors.bg}; color: ${colors.text}; border: 1px solid ${colors.border};">
                                ${schaden.schweregrad}
                            </span>
                        </div>
                        <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">
                            <strong>Schaden:</strong> ${schaden.schaden}
                        </div>
                        <div style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin-top: 2px;">
                            <strong>Arbeiten:</strong> ${arbeitenText}
                        </div>
                    </div>

                    <!-- Aktionen -->
                    <div style="display: flex; flex-direction: column; gap: var(--space-1); justify-content: center;">
                        <span class="badge ${schaden.confidence > 0.8 ? 'badge--success' : schaden.confidence > 0.5 ? 'badge--warning' : 'badge--secondary'}"
                              style="font-size: 10px; text-align: center;">
                            ${Math.round(schaden.confidence * 100)}%
                        </span>
                        <div style="display: flex; gap: 4px;">
                            <button type="button" class="btn btn-xs btn-ghost" onclick="editKISchaden(${index})" title="Bearbeiten">
                                <i data-feather="edit-2" style="width: 14px; height: 14px;"></i>
                            </button>
                            <button type="button" class="btn btn-xs btn-ghost" onclick="deleteKISchaden(${index})" title="LÃ¶schen" style="color: var(--color-error);">
                                <i data-feather="trash-2" style="width: 14px; height: 14px;"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // KI-Schaden auswÃ¤hlen/abwÃ¤hlen
        function toggleKISchaden(index) {
            if (kiErkannteSchaeden[index]) {
                kiErkannteSchaeden[index].selected = !kiErkannteSchaeden[index].selected;

                // UI aktualisieren
                const item = document.getElementById(`kiSchaden-${index}`);
                const schwereColors = {
                    'leicht': '#10b981', 'mittel': '#f59e0b', 'schwer': '#ef4444'
                };
                const color = schwereColors[kiErkannteSchaeden[index].schweregrad] || '#f59e0b';

                if (item) {
                    item.style.opacity = kiErkannteSchaeden[index].selected ? '1' : '0.6';
                    item.style.background = kiErkannteSchaeden[index].selected ? 'white' : '#f9fafb';
                    item.style.borderColor = kiErkannteSchaeden[index].selected ? color : 'var(--color-border)';
                }

                // ZÃ¤hler aktualisieren
                const countEl = document.getElementById('kiSelectedCount');
                if (countEl) {
                    countEl.textContent = kiErkannteSchaeden.filter(s => s.selected).length;
                }
            }
        }

        // KI-Schaden bearbeiten
        function editKISchaden(index) {
            const schaden = kiErkannteSchaeden[index];
            if (!schaden) return;

            const serviceArt = kalkWizardData.serviceArt || 'lackier';
            const serviceConfig = SERVICE_CONFIG[serviceArt] || SERVICE_CONFIG['lackier'];
            const verfuegbareTeile = serviceConfig.teile || [];
            const verfuegbareArbeiten = serviceConfig.arbeiten || [];

            // Modal erstellen
            const modal = document.createElement('div');
            modal.id = 'editKISchadenModal';
            modal.className = 'modal-overlay';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';

            modal.innerHTML = `
                <div class="modal-content" style="background: white; border-radius: var(--radius-lg); padding: var(--space-5); max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
                    <h3 style="margin: 0 0 var(--space-4) 0; display: flex; align-items: center; gap: var(--space-2);">
                        <i data-feather="edit-2"></i> Schaden bearbeiten
                    </h3>

                    <div class="form-group" style="margin-bottom: var(--space-3);">
                        <label class="form-label">Fahrzeugteil</label>
                        <select id="editKITeil" class="form-select">
                            ${verfuegbareTeile.map(t => `<option value="${t}" ${t === schaden.teil ? 'selected' : ''}>${t}</option>`).join('')}
                            <option value="custom" ${!verfuegbareTeile.includes(schaden.teil) ? 'selected' : ''}>Eigene Eingabe...</option>
                        </select>
                        <input type="text" id="editKITeilCustom" class="form-input" value="${schaden.teil}"
                               style="margin-top: var(--space-2); display: ${!verfuegbareTeile.includes(schaden.teil) ? 'block' : 'none'};"
                               placeholder="Teil eingeben...">
                    </div>

                    <div class="form-group" style="margin-bottom: var(--space-3);">
                        <label class="form-label">Schaden</label>
                        <input type="text" id="editKISchadenText" class="form-input" value="${schaden.schaden}">
                    </div>

                    <div class="form-group" style="margin-bottom: var(--space-3);">
                        <label class="form-label">Schweregrad</label>
                        <select id="editKISchwere" class="form-select">
                            <option value="leicht" ${schaden.schweregrad === 'leicht' ? 'selected' : ''}>Leicht</option>
                            <option value="mittel" ${schaden.schweregrad === 'mittel' ? 'selected' : ''}>Mittel</option>
                            <option value="schwer" ${schaden.schweregrad === 'schwer' ? 'selected' : ''}>Schwer</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-bottom: var(--space-4);">
                        <label class="form-label">Empfohlene Arbeiten</label>
                        <div style="display: flex; flex-wrap: wrap; gap: var(--space-2);">
                            ${verfuegbareArbeiten.map(a => `
                                <label style="display: flex; align-items: center; gap: 4px; padding: var(--space-1) var(--space-2); background: #f3f4f6; border-radius: var(--radius-sm); cursor: pointer;">
                                    <input type="checkbox" name="editKIArbeiten" value="${a}"
                                           ${(schaden.empfohleneArbeiten || []).includes(a) ? 'checked' : ''}>
                                    ${a}
                                </label>
                            `).join('')}
                        </div>
                    </div>

                    <div style="display: flex; gap: var(--space-3); justify-content: flex-end;">
                        <button type="button" class="btn btn-outline" onclick="closeEditKIModal()">Abbrechen</button>
                        <button type="button" class="btn btn-primary" onclick="saveKISchaden(${index})">Speichern</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Custom-Input Toggle
            document.getElementById('editKITeil').addEventListener('change', function() {
                document.getElementById('editKITeilCustom').style.display = this.value === 'custom' ? 'block' : 'none';
            });

            if (typeof feather !== 'undefined') feather.replace();
        }

        // Edit-Modal schlieÃŸen
        function closeEditKIModal() {
            const modal = document.getElementById('editKISchadenModal');
            if (modal) modal.remove();
        }

        // KI-Schaden speichern
        function saveKISchaden(index) {
            const teilSelect = document.getElementById('editKITeil');
            const teilCustom = document.getElementById('editKITeilCustom');
            const teil = teilSelect.value === 'custom' ? teilCustom.value : teilSelect.value;
            const schadenText = document.getElementById('editKISchadenText').value;
            const schwere = document.getElementById('editKISchwere').value;
            const arbeitenCheckboxes = document.querySelectorAll('input[name="editKIArbeiten"]:checked');
            const arbeiten = Array.from(arbeitenCheckboxes).map(cb => cb.value);

            if (!teil || !schadenText) {
                showToast('Bitte Teil und Schaden ausfÃ¼llen', 'warning');
                return;
            }

            kiErkannteSchaeden[index] = {
                ...kiErkannteSchaeden[index],
                teil: teil,
                schaden: schadenText,
                schweregrad: schwere,
                empfohleneArbeiten: arbeiten,
                bearbeitet: true
            };

            closeEditKIModal();

            // Item neu rendern
            const itemContainer = document.getElementById(`kiSchaden-${index}`);
            if (itemContainer) {
                itemContainer.outerHTML = renderKISchadenItem(kiErkannteSchaeden[index], index);
                if (typeof feather !== 'undefined') feather.replace();
            }

            showToast('Schaden aktualisiert', 'success');
        }

        // KI-Schaden lÃ¶schen
        function deleteKISchaden(index) {
            if (!confirm('Diesen Schaden wirklich entfernen?')) return;

            kiErkannteSchaeden.splice(index, 1);

            // Liste neu rendern
            if (window.kiAnalyseResult) {
                renderKISchaeden(window.kiAnalyseResult.zusammenfassung, window.kiAnalyseResult.geschaetzteDauer);
            }

            showToast('Schaden entfernt', 'info');
        }

        // Modal zum HinzufÃ¼gen eines neuen Teils
        function showAddKITeilModal() {
            const serviceArt = kalkWizardData.serviceArt || 'lackier';
            const serviceConfig = SERVICE_CONFIG[serviceArt] || SERVICE_CONFIG['lackier'];
            const verfuegbareTeile = serviceConfig.teile || [];
            const verfuegbareArbeiten = serviceConfig.arbeiten || [];

            const modal = document.createElement('div');
            modal.id = 'addKITeilModal';
            modal.className = 'modal-overlay';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';

            modal.innerHTML = `
                <div class="modal-content" style="background: white; border-radius: var(--radius-lg); padding: var(--space-5); max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
                    <h3 style="margin: 0 0 var(--space-4) 0; display: flex; align-items: center; gap: var(--space-2);">
                        <i data-feather="plus-circle"></i> Teil hinzufÃ¼gen
                    </h3>

                    <div class="form-group" style="margin-bottom: var(--space-3);">
                        <label class="form-label">Fahrzeugteil</label>
                        <select id="addKITeil" class="form-select">
                            <option value="">Bitte wÃ¤hlen...</option>
                            ${verfuegbareTeile.map(t => `<option value="${t}">${t}</option>`).join('')}
                            <option value="custom">Eigene Eingabe...</option>
                        </select>
                        <input type="text" id="addKITeilCustom" class="form-input" style="margin-top: var(--space-2); display: none;" placeholder="Teil eingeben...">
                    </div>

                    <div class="form-group" style="margin-bottom: var(--space-3);">
                        <label class="form-label">Schaden</label>
                        <input type="text" id="addKISchadenText" class="form-input" placeholder="z.B. Kratzer, Delle, Lackschaden...">
                    </div>

                    <div class="form-group" style="margin-bottom: var(--space-3);">
                        <label class="form-label">Schweregrad</label>
                        <select id="addKISchwere" class="form-select">
                            <option value="leicht">Leicht</option>
                            <option value="mittel" selected>Mittel</option>
                            <option value="schwer">Schwer</option>
                        </select>
                    </div>

                    <div class="form-group" style="margin-bottom: var(--space-4);">
                        <label class="form-label">Arbeiten</label>
                        <div style="display: flex; flex-wrap: wrap; gap: var(--space-2);">
                            ${verfuegbareArbeiten.map(a => `
                                <label style="display: flex; align-items: center; gap: 4px; padding: var(--space-1) var(--space-2); background: #f3f4f6; border-radius: var(--radius-sm); cursor: pointer;">
                                    <input type="checkbox" name="addKIArbeiten" value="${a}">
                                    ${a}
                                </label>
                            `).join('')}
                        </div>
                    </div>

                    <div style="display: flex; gap: var(--space-3); justify-content: flex-end;">
                        <button type="button" class="btn btn-outline" onclick="closeAddKIModal()">Abbrechen</button>
                        <button type="button" class="btn btn-primary" onclick="addNewKITeil()">HinzufÃ¼gen</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            document.getElementById('addKITeil').addEventListener('change', function() {
                document.getElementById('addKITeilCustom').style.display = this.value === 'custom' ? 'block' : 'none';
            });

            if (typeof feather !== 'undefined') feather.replace();
        }

        function closeAddKIModal() {
            const modal = document.getElementById('addKITeilModal');
            if (modal) modal.remove();
        }

        function addNewKITeil() {
            const teilSelect = document.getElementById('addKITeil');
            const teilCustom = document.getElementById('addKITeilCustom');
            const teil = teilSelect.value === 'custom' ? teilCustom.value : teilSelect.value;
            const schadenText = document.getElementById('addKISchadenText').value;
            const schwere = document.getElementById('addKISchwere').value;
            const arbeitenCheckboxes = document.querySelectorAll('input[name="addKIArbeiten"]:checked');
            const arbeiten = Array.from(arbeitenCheckboxes).map(cb => cb.value);

            if (!teil || !schadenText) {
                showToast('Bitte Teil und Schaden ausfÃ¼llen', 'warning');
                return;
            }

            const newSchaden = {
                id: `manual-${Date.now()}`,
                teil: teil,
                schaden: schadenText,
                schweregrad: schwere,
                empfohleneArbeiten: arbeiten.length > 0 ? arbeiten : ['lackieren'],
                confidence: 1.0,
                selected: true,
                manuell: true
            };

            kiErkannteSchaeden.push(newSchaden);
            closeAddKIModal();

            // Liste neu rendern
            if (window.kiAnalyseResult) {
                renderKISchaeden(window.kiAnalyseResult.zusammenfassung, window.kiAnalyseResult.geschaetzteDauer);
            }

            showToast('Teil hinzugefÃ¼gt', 'success');
        }

        // BestÃ¤tigen und zu Schritt 4 wechseln
        function confirmKIAnalyseAndProceed() {
            const selectedSchaeden = kiErkannteSchaeden.filter(s => s.selected);

            if (selectedSchaeden.length === 0) {
                showToast('Bitte mindestens ein Teil auswÃ¤hlen', 'warning');
                return;
            }

            console.log('âœ… KI-Analyse bestÃ¤tigt:', selectedSchaeden.length, 'Teile');

            // Teile in kalkWizardData Ã¼bernehmen
            if (!kalkWizardData.teile) kalkWizardData.teile = [];

            selectedSchaeden.forEach(schaden => {
                // PrÃ¼fen ob Teil bereits existiert
                const existingIndex = kalkWizardData.teile.findIndex(t => t.name === schaden.teil);

                if (existingIndex === -1) {
                    // Neues Teil hinzufÃ¼gen
                    kalkWizardData.teile.push({
                        name: schaden.teil,
                        schaden: schaden.schaden,
                        schweregrad: schaden.schweregrad,
                        arbeiten: schaden.empfohleneArbeiten || [],
                        kiErkannt: !schaden.manuell,
                        confidence: schaden.confidence
                    });
                } else {
                    // Bestehendes Teil aktualisieren
                    kalkWizardData.teile[existingIndex] = {
                        ...kalkWizardData.teile[existingIndex],
                        schaden: schaden.schaden,
                        schweregrad: schaden.schweregrad,
                        arbeiten: schaden.empfohleneArbeiten || [],
                        kiErkannt: !schaden.manuell,
                        confidence: schaden.confidence
                    };
                }
            });

            // KI-Analyse-Info speichern
            kalkWizardData.kiAnalyse = {
                durchgefuehrt: true,
                datum: new Date().toISOString(),
                erkannteTeile: selectedSchaeden.length,
                zusammenfassung: window.kiAnalyseResult?.zusammenfassung || '',
                geschaetzteDauer: window.kiAnalyseResult?.geschaetzteDauer || ''
            };

            showToast(`âœ… ${selectedSchaeden.length} Teile Ã¼bernommen`, 'success');

            // Zu Schritt 4 wechseln
            setTimeout(() => {
                goToStep(4);
            }, 500);
        }

        // ============================================
        // ðŸ†• PARTNER-ANFRAGEN INTEGRATION (Workflow: Partner â†’ Kalkulation â†’ KVA)
        // ============================================

        let loadedPartnerAnfragen = [];
        let selectedPartnerAnfrage = null;

        async function loadPartnerAnfragen() {
            const loading = document.getElementById('partnerLoading');
            const empty = document.getElementById('partnerEmpty');
            const listItems = document.getElementById('partnerListItems');
            const countBadge = document.getElementById('partnerCount');

            if (!loading || !listItems) return;

            try {
                loading.style.display = 'flex';
                if (empty) empty.style.display = 'none';
                listItems.innerHTML = '';

                await window.firebaseInitialized;
                if (!window.werkstattId || !window.getCollection) {
                    console.warn('âš ï¸ loadPartnerAnfragen: werkstattId oder getCollection nicht verfÃ¼gbar');
                    loading.style.display = 'none';
                    if (empty) empty.style.display = 'flex';
                    return;
                }

                // Partner-Anfragen laden (KEINE EntwÃ¼rfe, Status: neu oder warte_kva, noch kein KVA)
                const snapshot = await window.getCollection('partnerAnfragen')
                    .orderBy('timestamp', 'desc')
                    .limit(100)
                    .get();

                // Filtern: nur echte Partner-Anfragen (nicht EntwÃ¼rfe), ohne KVA, status neu/warte_kva
                loadedPartnerAnfragen = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    // Nur Partner-Anfragen die:
                    // 1. KEINE EntwÃ¼rfe sind (isEntwurf !== true)
                    // 2. Status 'neu' oder 'warte_kva' haben
                    // 3. Noch KEIN KVA haben (!data.kva)
                    if (!data.isEntwurf &&
                        ['neu', 'warte_kva'].includes(data.status) &&
                        !data.kva) {
                        loadedPartnerAnfragen.push({ id: doc.id, ...data });
                    }
                });

                loading.style.display = 'none';

                // Badge aktualisieren
                if (countBadge) {
                    if (loadedPartnerAnfragen.length > 0) {
                        countBadge.textContent = loadedPartnerAnfragen.length;
                        countBadge.style.display = 'inline';
                    } else {
                        countBadge.style.display = 'none';
                    }
                }

                if (loadedPartnerAnfragen.length === 0) {
                    if (empty) empty.style.display = 'flex';
                } else {
                    renderPartnerAnfragenListe(loadedPartnerAnfragen);
                }

                console.log(`ðŸ¤ ${loadedPartnerAnfragen.length} Partner-Anfragen geladen (ohne KVA)`);

            } catch (error) {
                console.error('âŒ Fehler beim Laden der Partner-Anfragen:', error);
                loading.style.display = 'none';
                if (empty) empty.style.display = 'flex';
            }
        }

        function renderPartnerAnfragenListe(anfragen) {
            const container = document.getElementById('partnerListItems');
            if (!container) return;

            container.innerHTML = anfragen.map(anfrage => {
                // ðŸ†• FIX: Leeres Array abfangen â†’ Fallback auf 'lackier'
                const serviceTyp = Array.isArray(anfrage.serviceTyp)
                    ? (anfrage.serviceTyp[0] || 'lackier')
                    : (anfrage.serviceTyp || 'lackier');
                const serviceLabel = SERVICE_LABELS[serviceTyp] || serviceTyp || 'Unbekannt';
                // ðŸ†• FIX: Fallback-Kette fÃ¼r konsistente Foto-Feldnamen
                // ðŸ”§ FIX Bug #5 (2025-12-01): Fahrzeugschein-Fotos hinzufÃ¼gen
                const schadenFotos = anfrage.photos || anfrage.photoUrls || anfrage.fotos || [];
                const fahrzeugscheinFotos = anfrage.fahrzeugscheinFotos || [];
                const photos = [...schadenFotos, ...fahrzeugscheinFotos];
                const hasPhotos = photos.length > 0;

                const statusText = anfrage.status === 'neu' ? 'Neu' : 'Warte auf KVA';
                const datum = anfrage.timestamp ? new Date(anfrage.timestamp).toLocaleDateString('de-DE') : '-';

                return `
                    <div class="partner-item ${selectedPartnerAnfrage?.id === anfrage.id ? 'selected' : ''}"
                         onclick="selectPartnerAnfrage('${anfrage.id}')">
                        <div class="partner-item__icon">ðŸ¤</div>
                        <div class="partner-item__info">
                            <div class="partner-item__title">
                                ${anfrage.kennzeichen || anfrage.auftragsnummer || 'Ohne Kennzeichen'}
                                ${anfrage.marke ? `- ${anfrage.marke} ${anfrage.modell || ''}` : ''}
                            </div>
                            <div class="partner-item__meta">
                                <span class="partner-item__partner-name">
                                    <i data-feather="building" style="width:12px;height:12px;"></i>
                                    ${anfrage.partnerName || 'Partner'}
                                </span>
                                <span><i data-feather="calendar" style="width:12px;height:12px;"></i> ${datum}</span>
                                <span class="partner-item__status ${anfrage.status}">${statusText}</span>
                            </div>
                            <div class="partner-item__meta" style="margin-top: 4px;">
                                <span class="entwurf-item__service">${serviceLabel}</span>
                            </div>
                            ${hasPhotos ? `
                                <div class="partner-item__photos">
                                    ${photos.slice(0, 3).map(url => `
                                        <img src="${url}" class="partner-item__photo" alt="Foto">
                                    `).join('')}
                                    ${photos.length > 3 ? `
                                        <div class="partner-item__photo-more">+${photos.length - 3}</div>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                        <div class="partner-item__arrow">
                            <i data-feather="chevron-right"></i>
                        </div>
                    </div>
                `;
            }).join('');

            feather.replace();
        }

        function selectPartnerAnfrage(anfrageId) {
            selectedPartnerAnfrage = loadedPartnerAnfragen.find(a => a.id === anfrageId);
            if (!selectedPartnerAnfrage) {
                console.error('Partner-Anfrage nicht gefunden:', anfrageId);
                return;
            }

            console.log('ðŸ¤ Partner-Anfrage ausgewÃ¤hlt:', selectedPartnerAnfrage);

            // Highlight selected item
            document.querySelectorAll('.partner-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            // Fahrzeugdaten aus Partner-Anfrage Ã¼bernehmen
            kalkWizardData.partnerAnfrageId = selectedPartnerAnfrage.id;
            kalkWizardData.fahrzeug = {
                marke: selectedPartnerAnfrage.marke || '',
                modell: selectedPartnerAnfrage.modell || '',
                baujahr: selectedPartnerAnfrage.baujahrVon || selectedPartnerAnfrage.baujahr || '',
                kennzeichen: selectedPartnerAnfrage.kennzeichen || selectedPartnerAnfrage.auftragsnummer || '',
                farbcode: selectedPartnerAnfrage.farbnummer || selectedPartnerAnfrage.farbe || '',
                kunde: selectedPartnerAnfrage.kundenname || '',
                // ðŸ†• FIX (Nov 30, 2025): ZusÃ¤tzliche Felder fÃ¼r Meister-Ãœbersicht
                kmstand: selectedPartnerAnfrage.kmstand || selectedPartnerAnfrage.kilometerstand || '',
                anliefertermin: selectedPartnerAnfrage.anliefertermin || selectedPartnerAnfrage.liefertermin || '',
                abholtermin: selectedPartnerAnfrage.abholtermin || selectedPartnerAnfrage.fertigstellungsdatum || '',
                ersatzfahrzeug: selectedPartnerAnfrage.ersatzfahrzeug || selectedPartnerAnfrage.ersatzfahrzeugGewuenscht || ''
            };

            // ðŸ†• Auch auf Root-Level fÃ¼r einfacheren Zugriff
            kalkWizardData.kmstand = kalkWizardData.fahrzeug.kmstand;
            kalkWizardData.anliefertermin = kalkWizardData.fahrzeug.anliefertermin;
            kalkWizardData.abholtermin = kalkWizardData.fahrzeug.abholtermin;

            // ðŸš— Ersatzfahrzeug-Daten als Objekt Ã¼bernehmen (FIX: Nov 30, 2025)
            const ersatzfahrzeugFromAnfrage = selectedPartnerAnfrage.kalkulationData?.ersatzfahrzeug;
            if (ersatzfahrzeugFromAnfrage && typeof ersatzfahrzeugFromAnfrage === 'object') {
                kalkWizardData.ersatzfahrzeug = ersatzfahrzeugFromAnfrage;
                console.log('ðŸš— Ersatzfahrzeug-Kosten aus Partner-Anfrage geladen:', ersatzfahrzeugFromAnfrage);
            } else {
                kalkWizardData.ersatzfahrzeug = kalkWizardData.fahrzeug.ersatzfahrzeug;
            }

            // Schadensbeschreibung/Notizen aus Partner-Anfrage
            kalkWizardData.schadenBeschreibung = selectedPartnerAnfrage.schadenBeschreibung || selectedPartnerAnfrage.beschreibung || '';
            kalkWizardData.notizen = selectedPartnerAnfrage.notizen || '';
            kalkWizardData.partnerName = selectedPartnerAnfrage.partnerName || '';

            // ðŸ†• MULTI-SERVICE SUPPORT (2025-11-30) - auch fÃ¼r Partner-Anfragen
            // Service-Art(en) Ã¼bernehmen
            if (Array.isArray(selectedPartnerAnfrage.serviceTyp) && selectedPartnerAnfrage.serviceTyp.length > 0) {
                kalkWizardData.services = [...selectedPartnerAnfrage.serviceTyp];
                kalkWizardData.isMultiService = selectedPartnerAnfrage.serviceTyp.length > 1;
            } else if (selectedPartnerAnfrage.serviceLabels && Array.isArray(selectedPartnerAnfrage.serviceLabels) && selectedPartnerAnfrage.serviceLabels.length > 1) {
                // Fallback: serviceLabels verwenden
                kalkWizardData.services = [...selectedPartnerAnfrage.serviceLabels];
                kalkWizardData.isMultiService = true;
            } else {
                kalkWizardData.services = [selectedPartnerAnfrage.serviceTyp || 'lackier'];
                kalkWizardData.isMultiService = false;
            }
            kalkWizardData.serviceArt = kalkWizardData.services[0]; // Backwards-Compat
            kalkWizardData.currentServiceIndex = 0;
            kalkWizardData.serviceDetailsPerService = {};

            // additionalServices aus Partner-Anfrage laden
            if (selectedPartnerAnfrage.additionalServices && Array.isArray(selectedPartnerAnfrage.additionalServices)) {
                kalkWizardData.additionalServicesFromEntwurf = selectedPartnerAnfrage.additionalServices;
            } else {
                kalkWizardData.additionalServicesFromEntwurf = [];
            }

            // ðŸ”§ FIX (2025-11-30): Service-Details aus Partner-Anfrage in serviceDetailsPerService vorausfÃ¼llen
            // ============================================
            // ðŸ”„ FELDNAMEN-MAPPING: Partner-App â†’ kalkulation.html
            // ============================================
            // VOLLSTÃ„NDIGE MAPPING-TABELLE (Nov 30, 2025)
            // multi-service-anfrage.html speichert ohne Prefix: lackier_farbcode â†’ farbcode
            // kalkulation.html SERVICE_CONFIG hat andere Feldnamen
            //
            // ðŸ†• FIX (Nov 30, 2025): serviceTyp-Parameter hinzugefÃ¼gt!
            // Die Mappings werden jetzt NUR fÃ¼r den jeweiligen Service-Typ angewendet,
            // um zu verhindern dass z.B. Lackier-"art" zu "klimaservice" gemappt wird.
            const normalizeServiceDetailsPartner = (details, serviceTyp = null) => {
                if (!details || typeof details !== 'object') return {};
                const normalized = { ...details };

                // ===== REIFEN-MAPPING (nur fÃ¼r 'reifen') =====
                if (serviceTyp === 'reifen') {
                    if (normalized.reifentyp !== undefined) {
                        normalized.reifenTyp = normalized.reifentyp;
                    }
                    if (normalized.typ !== undefined && normalized.reifenTyp === undefined) {
                        normalized.reifenTyp = normalized.typ;
                    }
                    // Wert-Mapping: Partner "ganzjahr" â†’ Kalkulation "allseason"
                    if (normalized.reifenTyp === 'ganzjahr') {
                        normalized.reifenTyp = 'allseason';
                    }
                    if (normalized.groesse !== undefined) {
                        normalized.reifengroesse = normalized.groesse;
                    }
                    if (normalized.anzahl !== undefined) {
                        normalized.reifenanzahl = String(normalized.anzahl);
                    }
                }

                // ===== LACKIER-MAPPING (nur fÃ¼r 'lackier') =====
                if (serviceTyp === 'lackier') {
                    if (normalized.farbcode !== undefined && normalized.farbnummer === undefined) {
                        normalized.farbnummer = normalized.farbcode;
                    }
                    if (normalized.info !== undefined && normalized.schadenBeschreibung === undefined) {
                        normalized.schadenBeschreibung = normalized.info;
                    }
                }

                // ===== PFLEGE-MAPPING (nur fÃ¼r 'pflege') =====
                if (serviceTyp === 'pflege') {
                    if (normalized.paket !== undefined && normalized.pflegePaket === undefined) {
                        const pflegePaketMapping = {
                            'basis': 'basis',
                            'premium': 'premium',
                            'komplett': 'premium'
                        };
                        normalized.pflegePaket = pflegePaketMapping[normalized.paket] || normalized.paket;
                    }
                    // Sammle Checkbox-Werte zu einem String
                    const pflegeExtras = [];
                    if (normalized.polieren === true) pflegeExtras.push('Polieren');
                    if (normalized.motor === true) pflegeExtras.push('Motorraumreinigung');
                    if (normalized.ozon === true) pflegeExtras.push('Ozonbehandlung');
                    if (pflegeExtras.length > 0 && normalized.zusatzleistungen === undefined) {
                        normalized.zusatzleistungen = pflegeExtras.join(', ');
                    }
                }

                // ===== MECHANIK-MAPPING (nur fÃ¼r 'mechanik') =====
                if (serviceTyp === 'mechanik') {
                    if (normalized.beschreibung !== undefined && normalized.problem === undefined) {
                        normalized.problem = normalized.beschreibung;
                    }
                    if (normalized.beschreibung !== undefined && normalized.symptome === undefined) {
                        normalized.symptome = normalized.beschreibung;
                    }
                }

                // ===== TUEV-MAPPING (nur fÃ¼r 'tuev') =====
                if (serviceTyp === 'tuev') {
                    if (normalized.ablauf !== undefined && normalized.huDatum === undefined) {
                        normalized.huDatum = normalized.ablauf;
                    }
                    if (normalized.info !== undefined && normalized.bekannteMaengel === undefined) {
                        normalized.bekannteMaengel = normalized.info;
                    }
                    // Konvertiere HU/AU Checkboxes zu pruefart
                    if (normalized.pruefart === undefined) {
                        const hasHU = normalized.hau === true;
                        const hasAU = normalized.au === true;
                        if (hasHU && hasAU) normalized.pruefart = 'hu-au';
                        else if (hasHU) normalized.pruefart = 'hu';
                        else if (hasAU) normalized.pruefart = 'au';
                    }
                }

                // ===== KLIMA-MAPPING (nur fÃ¼r 'klima') =====
                if (serviceTyp === 'klima') {
                    if (normalized.art !== undefined && normalized.klimaservice === undefined) {
                        normalized.klimaservice = normalized.art;
                    }
                    if (normalized.problem !== undefined && normalized.klimaproblem === undefined) {
                        normalized.klimaproblem = normalized.problem;
                    }
                    if (normalized.kaeltemittel === 'unbekannt') {
                        normalized.kaeltemittel = '';
                    }
                }

                // ===== GLAS-MAPPING (nur fÃ¼r 'glas') =====
                if (serviceTyp === 'glas') {
                    if (normalized.schadensart !== undefined && normalized.schadensgroesse === undefined) {
                        const schadensartMapping = {
                            'steinschlag': 'klein',
                            'riss': 'riss',
                            'bruch': 'gross'
                        };
                        normalized.schadensgroesse = schadensartMapping[normalized.schadensart] || normalized.schadensart;
                    }
                    if (normalized.position !== undefined && normalized.glasposition === undefined) {
                        normalized.glasposition = normalized.position;
                    }
                }

                // ===== DELLEN-MAPPING (nur fÃ¼r 'dellen') =====
                if (serviceTyp === 'dellen') {
                    if (normalized.anzahl !== undefined && normalized.dellenanzahl === undefined) {
                        const anzahl = parseInt(normalized.anzahl, 10);
                        // ðŸ†• FIX: NaN-Check verhindert falsche Zuordnung
                        if (isNaN(anzahl)) normalized.dellenanzahl = '1-5';
                        else if (anzahl <= 5) normalized.dellenanzahl = '1-5';
                        else if (anzahl <= 15) normalized.dellenanzahl = '6-15';
                        else if (anzahl <= 30) normalized.dellenanzahl = '16-30';
                        else normalized.dellenanzahl = '30+';
                    }
                    if (normalized.groesse !== undefined && normalized.dellengroesse === undefined) {
                        normalized.dellengroesse = normalized.groesse;
                    }
                    if (normalized.position !== undefined && normalized.dellenpositionen === undefined) {
                        normalized.dellenpositionen = normalized.position;
                    }
                    // Radio-Button: "true"/"false" â†’ "ja"/"nein"
                    if (normalized.lackschaden === 'true') normalized.lackschaden = 'ja';
                    if (normalized.lackschaden === 'false') normalized.lackschaden = 'nein';
                }

                // ===== FOLIERUNG-MAPPING (nur fÃ¼r 'folierung') =====
                if (serviceTyp === 'folierung') {
                    if (normalized.art !== undefined && normalized.folierungArt === undefined) {
                        normalized.folierungArt = normalized.art;
                    }
                    if (normalized.folienart !== undefined && normalized.folienTyp === undefined) {
                        normalized.folienTyp = normalized.folienart;
                    }
                    if (normalized.farbe !== undefined && normalized.folienFarbe === undefined) {
                        normalized.folienFarbe = normalized.farbe;
                    }
                    if (normalized.info !== undefined && normalized.folierungInfo === undefined) {
                        normalized.folierungInfo = normalized.info;
                    }
                    // Legacy-Mappings
                    if (normalized.folierungMaterial !== undefined && normalized.folienTyp === undefined) {
                        normalized.folienTyp = normalized.folierungMaterial;
                    }
                    if (normalized.folierungFarbe !== undefined && normalized.folienFarbe === undefined) {
                        normalized.folienFarbe = normalized.folierungFarbe;
                    }
                    if (normalized.folierungDesign !== undefined && normalized.designBeschreibung === undefined) {
                        normalized.designBeschreibung = normalized.folierungDesign;
                    }
                }

                // ===== STEINSCHUTZ-MAPPING (nur fÃ¼r 'steinschutz') =====
                if (serviceTyp === 'steinschutz') {
                    if (normalized.umfang !== undefined && normalized.steinschutzUmfang === undefined) {
                        normalized.steinschutzUmfang = normalized.umfang;
                    }
                    if (normalized.material !== undefined && normalized.folienTyp === undefined) {
                        normalized.folienTyp = normalized.material;
                    }
                    if (normalized.bereiche !== undefined && normalized.steinschutzBereiche === undefined) {
                        normalized.steinschutzBereiche = normalized.bereiche;
                    }
                    // Legacy
                    if (normalized.steinschutzMaterial !== undefined && normalized.folienTyp === undefined) {
                        normalized.folienTyp = normalized.steinschutzMaterial;
                    }
                }

                // ===== WERBEBEKLEBUNG-MAPPING (nur fÃ¼r 'werbebeklebung') =====
                if (serviceTyp === 'werbebeklebung') {
                    if (normalized.art !== undefined && normalized.werbebeklebungUmfang === undefined) {
                        normalized.werbebeklebungUmfang = normalized.art;
                    }
                    if (normalized.komplexitaet !== undefined && normalized.designKomplexitaet === undefined) {
                        normalized.designKomplexitaet = normalized.komplexitaet;
                    }
                    // Legacy
                    if (normalized.werbebeklebungKomplexitaet !== undefined && normalized.designKomplexitaet === undefined) {
                        normalized.designKomplexitaet = normalized.werbebeklebungKomplexitaet;
                    }
                    if (normalized.werbebeklebungFarbanzahl !== undefined && normalized.farbanzahl === undefined) {
                        normalized.farbanzahl = parseInt(normalized.werbebeklebungFarbanzahl) || 2;
                    }
                    if (normalized.werbebeklebungText !== undefined && normalized.kontaktdaten === undefined) {
                        normalized.kontaktdaten = normalized.werbebeklebungText;
                    }
                }

                // ===== VERSICHERUNG-MAPPING (nur fÃ¼r 'versicherung') =====
                if (serviceTyp === 'versicherung') {
                    if (normalized.schadennummer !== undefined && normalized.schadensnummer === undefined) {
                        normalized.schadensnummer = normalized.schadennummer;
                    }
                    if (normalized.hergang !== undefined && normalized.unfallhergang === undefined) {
                        normalized.unfallhergang = normalized.hergang;
                    }
                }

                console.log(`ðŸ“‹ Normalisierte Partner-Service-Details fÃ¼r "${serviceTyp}":`, normalized);
                return normalized;
            };

            // ðŸ†• FIX (2025-11-30): Multi-Service serviceData korrekt laden
            // Bei Multi-Service Anfragen ist serviceData bereits pro Service-Key strukturiert:
            // serviceData = { 'lackier': {...}, 'reifen': {...} }
            // Bei Single-Service Anfragen ist serviceData direkt das Details-Objekt:
            // serviceData = { art: '...', teile: '...' }

            const serviceDataFromAnfrage = selectedPartnerAnfrage.serviceData || {};

            // PrÃ¼fen ob serviceData pro-Service-Key strukturiert ist (Multi-Service Format)
            const isMultiServiceFormat = kalkWizardData.isMultiService &&
                kalkWizardData.services.some(svc => serviceDataFromAnfrage[svc] !== undefined);

            if (isMultiServiceFormat) {
                // MULTI-SERVICE FORMAT: serviceData[serviceTyp] = Details
                console.log('ðŸ“¦ [MULTI-SERVICE] Lade Service-Details pro Service-Key...');
                kalkWizardData.services.forEach(serviceTyp => {
                    const serviceDetails = serviceDataFromAnfrage[serviceTyp];
                    if (serviceDetails && typeof serviceDetails === 'object' && Object.keys(serviceDetails).length > 0) {
                        // ðŸ†• FIX: serviceTyp als 2. Parameter Ã¼bergeben!
                        kalkWizardData.serviceDetailsPerService[serviceTyp] = normalizeServiceDetailsPartner(serviceDetails, serviceTyp);
                        console.log(`   âœ… "${serviceTyp}" Details geladen:`, kalkWizardData.serviceDetailsPerService[serviceTyp]);
                    } else {
                        console.log(`   âš ï¸ "${serviceTyp}" hat keine Details`);
                    }
                });
            } else {
                // SINGLE-SERVICE FORMAT: serviceData = Details (oder serviceDetails)
                console.log('ðŸ“¦ [SINGLE-SERVICE] Lade Service-Details als einzelnes Objekt...');
                const primaryServicePartner = kalkWizardData.services[0];
                const primaryDetails = selectedPartnerAnfrage.serviceDetails || serviceDataFromAnfrage || {};
                if (primaryDetails && typeof primaryDetails === 'object' && Object.keys(primaryDetails).length > 0) {
                    // ðŸ†• FIX: serviceTyp als 2. Parameter Ã¼bergeben!
                    kalkWizardData.serviceDetailsPerService[primaryServicePartner] = normalizeServiceDetailsPartner(primaryDetails, primaryServicePartner);
                    console.log(`   âœ… "${primaryServicePartner}" Details vorausgefÃ¼llt:`, kalkWizardData.serviceDetailsPerService[primaryServicePartner]);
                }
            }

            // 2. Additional Services Details laden (falls additionalServices Array vorhanden)
            if (kalkWizardData.additionalServicesFromEntwurf.length > 0) {
                kalkWizardData.additionalServicesFromEntwurf.forEach(addService => {
                    if (addService.serviceTyp && addService.serviceDetails && typeof addService.serviceDetails === 'object') {
                        // ðŸ†• FIX: serviceTyp als 2. Parameter Ã¼bergeben!
                        kalkWizardData.serviceDetailsPerService[addService.serviceTyp] = normalizeServiceDetailsPartner(addService.serviceDetails, addService.serviceTyp);
                        console.log(`ðŸ“‹ Partner Additional Service "${addService.serviceTyp}" Details vorausgefÃ¼llt:`, kalkWizardData.serviceDetailsPerService[addService.serviceTyp]);
                    }
                });
            }

            // 3. Falls bereits serviceDetailsPerService vom vorherigen Kalkulations-Durchlauf existiert (PrioritÃ¤t!)
            if (selectedPartnerAnfrage.serviceDetailsPerService && typeof selectedPartnerAnfrage.serviceDetailsPerService === 'object') {
                Object.keys(selectedPartnerAnfrage.serviceDetailsPerService).forEach(serviceKey => {
                    kalkWizardData.serviceDetailsPerService[serviceKey] = {
                        ...kalkWizardData.serviceDetailsPerService[serviceKey],
                        ...selectedPartnerAnfrage.serviceDetailsPerService[serviceKey]
                    };
                    console.log(`ðŸ“‹ Partner Kalkulations-Details fÃ¼r "${serviceKey}" Ã¼bernommen:`, kalkWizardData.serviceDetailsPerService[serviceKey]);
                });
            }

            console.log('âœ… Partner serviceDetailsPerService vollstÃ¤ndig geladen:', kalkWizardData.serviceDetailsPerService);

            console.log(`ðŸ†• Partner-Anfrage Multi-Service Modus: ${kalkWizardData.isMultiService ? 'JA' : 'NEIN'}, Services:`, kalkWizardData.services);

            // ðŸ†• FIX: Fotos mit Fallback-Kette speichern fÃ¼r Step 3 und 4
            // ðŸ”§ FIX Bug #5 (2025-12-01): Fahrzeugschein-Fotos hinzufÃ¼gen
            const schadenFotosPartner = selectedPartnerAnfrage.photos ||
                                        selectedPartnerAnfrage.photoUrls ||
                                        selectedPartnerAnfrage.fotos || [];
            const fahrzeugscheinFotosPartner = selectedPartnerAnfrage.fahrzeugscheinFotos || [];
            kalkWizardData.entwurfPhotos = [...schadenFotosPartner, ...fahrzeugscheinFotosPartner];

            // ZusÃ¤tzliche Partner-Daten speichern
            kalkWizardData.partnerName = selectedPartnerAnfrage.partnerName || '';
            kalkWizardData.partnerId = selectedPartnerAnfrage.partnerId || '';
            kalkWizardData.schadenBeschreibung = selectedPartnerAnfrage.schadenBeschreibung ||
                                                  selectedPartnerAnfrage.notizen || '';
            kalkWizardData.serviceData = selectedPartnerAnfrage.serviceData || {};
            kalkWizardData.farbe = selectedPartnerAnfrage.farbe || selectedPartnerAnfrage.farbname || '';
            kalkWizardData.datum = selectedPartnerAnfrage.timestamp
                ? new Date(selectedPartnerAnfrage.timestamp).toLocaleDateString('de-DE')
                : '-';
            kalkWizardData.notizen = selectedPartnerAnfrage.notizen || '';
            kalkWizardData.dringlichkeit = selectedPartnerAnfrage.dringlichkeit || '';
            kalkWizardData.quelle = 'partner';

            // Zeige ausgewÃ¤hltes Fahrzeug
            const selectedBox = document.getElementById('selectedDbVehicle');
            if (selectedBox) {
                selectedBox.style.display = 'block';
                document.getElementById('selectedVehicleName').textContent =
                    `${selectedPartnerAnfrage.marke || '-'} ${selectedPartnerAnfrage.modell || ''}`;
                document.getElementById('selectedVehicleKennzeichen').textContent =
                    selectedPartnerAnfrage.kennzeichen || selectedPartnerAnfrage.auftragsnummer || '-';
                document.getElementById('selectedVehicleKunde').textContent =
                    `Partner: ${selectedPartnerAnfrage.partnerName || '-'}`;
            }

            // Tabs ausblenden
            const tabsContainer = document.querySelector('.kalk-vehicle-tabs');
            const tabPartner = document.getElementById('tabPartner');
            if (tabsContainer) tabsContainer.style.display = 'none';
            if (tabPartner) tabPartner.style.display = 'none';

            // Service-Art Radio-Button in Step 2 vorauswÃ¤hlen
            setTimeout(() => {
                const serviceRadio = document.querySelector(`input[name="serviceArt"][value="${kalkWizardData.serviceArt}"]`);
                if (serviceRadio) {
                    serviceRadio.checked = true;
                    // Trigger change event um UI zu aktualisieren
                    serviceRadio.dispatchEvent(new Event('change', { bubbles: true }));
                    console.log('âœ… Service vorausgewÃ¤hlt:', kalkWizardData.serviceArt);
                } else {
                    console.warn('âš ï¸ Service-Radio nicht gefunden fÃ¼r:', kalkWizardData.serviceArt);
                }
            }, 100);

            showToast(`âœ… Partner-Anfrage "${selectedPartnerAnfrage.kennzeichen || selectedPartnerAnfrage.auftragsnummer}" Ã¼bernommen`, 'success');

            // ðŸ”§ FIX (2025-11-30): Bei Multi-Service zu Step 2b mit ALLEN Services auf einer Seite
            setTimeout(() => {
                // PrÃ¼fe ob irgendein Service Details hat
                const hasAnyServiceDetails = kalkWizardData.services.some(service => {
                    const config = SERVICE_CONFIG[service];
                    return config?.zusatzfelder && Object.keys(config.zusatzfelder).length > 0;
                });

                if (hasAnyServiceDetails) {
                    console.log('ðŸ†• Partner-Anfrage: Services haben Details, gehe zu Step 2b');
                    console.log('   Services:', kalkWizardData.services);

                    // Step 2b anzeigen mit ALLEN Services
                    currentStep = '2b';
                    renderAllServiceDetails(); // ðŸ†• NEU: Alle Services auf einer Seite!
                    updateStepUI();
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    // Keine Service-Details nÃ¶tig â†’ Direkt zu Step 3
                    console.log('ðŸ†• Keine Service-Details nÃ¶tig, gehe direkt zu Step 3');
                    goToStep(3);
                }
            }, 500);
        }

        // Service-Art Labels (echte 12 App-Services)
        const SERVICE_LABELS = {
            'lackier': 'Lackierung',
            'versicherung': 'Versicherungsschaden',
            'dellen': 'DellendrÃ¼cken (PDR)',
            'glas': 'Glasreparatur',
            'reifen': 'Reifen-Service',
            'mechanik': 'Mechanik',
            'pflege': 'Fahrzeugpflege',
            'tuev': 'TÃœV/AU',
            'klima': 'Klimaservice',
            'folierung': 'Folierung',
            'steinschutz': 'Steinschutzfolie',
            'werbebeklebung': 'Werbebeklebung'
        };

        // Service-spezifische Konfiguration fÃ¼r Step 3 (Teile) und Step 4 (Arbeiten)
        const SERVICE_CONFIG = {
            'lackier': {
                teile: ['StoÃŸfÃ¤nger vorne', 'StoÃŸfÃ¤nger hinten', 'Motorhaube', 'KotflÃ¼gel vorne links', 'KotflÃ¼gel vorne rechts', 'TÃ¼r vorne links', 'TÃ¼r vorne rechts', 'TÃ¼r hinten links', 'TÃ¼r hinten rechts', 'Seitenwand links', 'Seitenwand rechts', 'Dach', 'Heckklappe', 'Schweller links', 'Schweller rechts', 'A-SÃ¤ule', 'B-SÃ¤ule', 'C-SÃ¤ule', 'Spiegel links', 'Spiegel rechts'],
                arbeiten: ['lackieren', 'grundieren', 'spachteln', 'schleifen', 'polieren', 'demontieren', 'montieren', 'ersetzen', 'austauschen'],
                tabellen: { ersatzteile: true, arbeitslohn: true, lackierung: true, materialien: false },
                // ðŸ†• Nov 30, 2025: Zusatzfelder fÃ¼r Lackierung (aus Partner-Anfrage)
                zusatzfelder: {
                    farbcode: {
                        label: 'Farbcode',
                        typ: 'text',
                        placeholder: 'z.B. LY9T, LA7W, LC9X...',
                        required: false
                    },
                    karosserie: {
                        label: 'Demontage benÃ¶tigt?',
                        typ: 'select',
                        required: false,
                        options: [
                            { value: '', label: 'Nicht angegeben' },
                            { value: 'ja', label: 'Ja - Demontage erforderlich' },
                            { value: 'nein', label: 'Nein - keine Demontage' }
                        ]
                    },
                    ersatzteil: {
                        label: 'Ersatzteil-PrÃ¤ferenz',
                        typ: 'select',
                        required: false,
                        options: [
                            { value: '', label: 'Nicht angegeben' },
                            { value: 'original', label: 'Original (OEM)' },
                            { value: 'nachbau', label: 'Nachbau / Aftermarket' },
                            { value: 'egal', label: 'Egal' }
                        ]
                    },
                    teile: {
                        label: 'Zu lackierende Teile',
                        typ: 'textarea',
                        placeholder: 'z.B. Motorhaube, KotflÃ¼gel vorne links...',
                        required: false
                    },
                    schadenBeschreibung: {
                        label: 'Schadensbeschreibung',
                        typ: 'textarea',
                        placeholder: 'Beschreiben Sie den Schaden oder die gewÃ¼nschte Lackierung...',
                        required: false
                    }
                }
            },
            'versicherung': {
                teile: ['StoÃŸfÃ¤nger vorne', 'StoÃŸfÃ¤nger hinten', 'Motorhaube', 'KotflÃ¼gel vorne links', 'KotflÃ¼gel vorne rechts', 'TÃ¼r vorne links', 'TÃ¼r vorne rechts', 'TÃ¼r hinten links', 'TÃ¼r hinten rechts', 'Seitenwand links', 'Seitenwand rechts', 'Dach', 'Heckklappe', 'Rahmen/Struktur', 'Airbag', 'Lenkung', 'Achse vorne', 'Achse hinten'],
                arbeiten: ['lackieren', 'austauschen', 'richten', 'schweissen', 'demontieren', 'montieren', 'grundieren', 'spachteln'],
                tabellen: { ersatzteile: true, arbeitslohn: true, lackierung: true, materialien: false }
            },
            'dellen': {
                teile: ['Motorhaube', 'Dach', 'KotflÃ¼gel vorne links', 'KotflÃ¼gel vorne rechts', 'TÃ¼r vorne links', 'TÃ¼r vorne rechts', 'TÃ¼r hinten links', 'TÃ¼r hinten rechts', 'Heckklappe', 'Seitenwand links', 'Seitenwand rechts'],
                arbeiten: ['ausbeulen', 'drÃ¼cken', 'kleben', 'lackieren', 'ersetzen', 'austauschen'],
                tabellen: { ersatzteile: true, arbeitslohn: true, lackierung: false, materialien: false }
            },
            'folierung': {
                teile: ['Fahrzeug komplett', 'Motorhaube', 'Dach', 'StoÃŸfÃ¤nger vorne', 'StoÃŸfÃ¤nger hinten', 'SeitenwÃ¤nde', 'TÃ¼ren', 'Spiegel', 'Dachkanten', 'Einstiege'],
                arbeiten: ['folieren', 'entfolieren', 'reinigen', 'vorbereiten'],
                tabellen: { ersatzteile: false, arbeitslohn: true, lackierung: true, materialien: true },
                // ðŸ†• Service-spezifische Zusatzfelder (erweitert Nov 30, 2025)
                zusatzfelder: {
                    // ðŸ†• NEU: Felder aus annahme.html
                    folierungArt: {
                        label: 'Folierungs-Art',
                        typ: 'select',
                        required: false,
                        options: [
                            { value: '', label: 'Nicht angegeben' },
                            { value: 'vollfolierung', label: 'Vollfolierung' },
                            { value: 'teilfolierung', label: 'Teilfolierung' },
                            { value: 'akzente', label: 'Akzente / Details' }
                        ]
                    },
                    folienTyp: {
                        label: 'Folien-Typ / Material',
                        typ: 'select',
                        required: false,
                        options: [
                            { value: '', label: 'Nicht angegeben' },
                            { value: 'glanz', label: 'Glanz (Glossy)' },
                            { value: 'matt', label: 'Matt' },
                            { value: 'satin', label: 'Satin' },
                            { value: 'metallic', label: 'Metallic' },
                            { value: 'chrome', label: 'Chrom' },
                            { value: 'satin-chrome', label: 'Satin Chrom' },
                            { value: 'carbon', label: 'Carbon-Look' },
                            { value: 'carbon-3d', label: 'Carbon 3D Struktur' },
                            { value: 'brushed', label: 'Brushed (GebÃ¼rstet)' },
                            { value: 'color-shift', label: 'Color-Shift / Flip-Flop' }
                        ]
                    },
                    folierungSpezialTyp: {
                        label: 'Spezial-Effekt (optional)',
                        typ: 'text',
                        placeholder: 'z.B. ChamÃ¤leon, Perlmutt, Hologramm...',
                        required: false
                    },
                    folienFarbe: {
                        label: 'Wunschfarbe',
                        typ: 'text',
                        placeholder: 'z.B. Nardo Grau, Racing Green, Midnight Purple...',
                        required: false
                    },
                    folierungBereiche: {
                        label: 'Bereiche',
                        typ: 'textarea',
                        placeholder: 'z.B. Dach, Motorhaube, Spiegel...',
                        required: false
                    },
                    designBeschreibung: {
                        label: 'Design-Beschreibung',
                        typ: 'textarea',
                        placeholder: 'Beschreiben Sie Ihre Design-Vorstellungen (Muster, Streifen, Akzente, etc.)...',
                        required: false
                    },
                    folierungInfo: {
                        label: 'ZusÃ¤tzliche Informationen',
                        typ: 'textarea',
                        placeholder: 'Weitere WÃ¼nsche oder Anmerkungen...',
                        required: false
                    },
                    designUpload: {
                        label: 'Design/Grafik hochladen (optional)',
                        typ: 'file',
                        accept: 'image/*,.pdf,.ai,.psd,.svg',
                        multiple: true,
                        required: false,
                        help: 'Design-Dateien: JPG, PNG, PDF, AI, PSD, SVG'
                    }
                }
            },
            'steinschutz': {
                teile: ['Motorhaube', 'StoÃŸfÃ¤nger vorne', 'KotflÃ¼gel', 'Spiegel', 'A-SÃ¤ule', 'Dachkante vorne', 'Schweller', 'TÃ¼rkanten'],
                arbeiten: ['folieren', 'reinigen', 'vorbereiten', 'schneiden'],
                tabellen: { ersatzteile: false, arbeitslohn: true, lackierung: true, materialien: true },
                // ðŸ†• Erweitert mit Feldern aus annahme.html (Nov 30, 2025)
                zusatzfelder: {
                    steinschutzUmfang: {
                        label: 'Umfang',
                        typ: 'select',
                        required: false,
                        options: [
                            { value: '', label: 'Nicht angegeben' },
                            { value: 'basis', label: 'Basis (FrontstoÃŸstange, Motorhaube vorne)' },
                            { value: 'standard', label: 'Standard (+ KotflÃ¼gel, Spiegel)' },
                            { value: 'premium', label: 'Premium (komplette Front)' },
                            { value: 'vollschutz', label: 'Vollschutz (ganzes Fahrzeug)' }
                        ]
                    },
                    folienTyp: {
                        label: 'Schutzfolien-Typ / Material',
                        typ: 'select',
                        required: false,
                        options: [
                            { value: '', label: 'Nicht angegeben' },
                            { value: 'ppf-glanz', label: 'PPF Glanz (Paint Protection Film)' },
                            { value: 'ppf-matt', label: 'PPF Matt' },
                            { value: 'ppf-selbstheilend', label: 'PPF Selbstheilend' },
                            { value: 'standard', label: 'Standard Schutzfolie' }
                        ]
                    },
                    folienMarke: {
                        label: 'Bevorzugte Marke (optional)',
                        typ: 'select',
                        required: false,
                        options: [
                            { value: '', label: 'Keine PrÃ¤ferenz' },
                            { value: 'xpel', label: 'XPEL' },
                            { value: 'suntek', label: 'SunTek' },
                            { value: '3m', label: '3M' },
                            { value: 'hexis', label: 'Hexis' },
                            { value: 'llumar', label: 'LLumar' }
                        ]
                    },
                    steinschutzBereiche: {
                        label: 'Bereiche (Details)',
                        typ: 'textarea',
                        placeholder: 'z.B. Motorhaube komplett, StoÃŸfÃ¤nger vorne, Spiegel...',
                        required: false
                    },
                    steinschutzInfo: {
                        label: 'ZusÃ¤tzliche Informationen',
                        typ: 'textarea',
                        placeholder: 'Weitere WÃ¼nsche oder Anmerkungen...',
                        required: false
                    }
                }
            },
            'werbebeklebung': {
                teile: ['Fahrzeug komplett', 'SeitenflÃ¤chen', 'Heck', 'Motorhaube', 'Dach', 'TÃ¼ren', 'Fenster'],
                arbeiten: ['bekleben', 'entfernen', 'gestalten', 'drucken', 'vorbereiten'],
                tabellen: { ersatzteile: false, arbeitslohn: true, lackierung: true, materialien: true },
                // ðŸ†• Erweitert mit Feldern aus annahme.html (Nov 30, 2025)
                zusatzfelder: {
                    werbebeklebungUmfang: {
                        label: 'Umfang',
                        typ: 'select',
                        required: false,
                        options: [
                            { value: '', label: 'Nicht angegeben' },
                            { value: 'klein', label: 'Klein (Logo / Schriftzug)' },
                            { value: 'mittel', label: 'Mittel (TÃ¼ren, Heck)' },
                            { value: 'gross', label: 'GroÃŸ (Teilfolierung)' },
                            { value: 'komplett', label: 'Komplett (Vollfolierung)' }
                        ]
                    },
                    logoUpload: {
                        label: 'Logo hochladen',
                        typ: 'file',
                        accept: 'image/*,.pdf,.ai,.svg,.eps',
                        multiple: true,
                        required: false,
                        help: 'Firmenlogo in hoher AuflÃ¶sung (mind. 300dpi): PNG, SVG, AI, EPS, PDF'
                    },
                    designVorlage: {
                        label: 'Design-Vorlage (falls vorhanden)',
                        typ: 'file',
                        accept: 'image/*,.pdf,.ai,.psd',
                        multiple: true,
                        required: false,
                        help: 'Fertige Design-Vorlage fÃ¼r die Beklebung'
                    },
                    designKomplexitaet: {
                        label: 'Design-KomplexitÃ¤t',
                        typ: 'select',
                        required: false,
                        options: [
                            { value: '', label: 'Nicht angegeben' },
                            { value: 'einfach', label: 'Einfach - nur Logo (1-2 Farben)' },
                            { value: 'mittel', label: 'Mittel - Logo + Text + Grafiken (3-5 Farben)' },
                            { value: 'komplex', label: 'Komplex - VollflÃ¤chiges Design (6+ Farben)' }
                        ]
                    },
                    logoStatus: {
                        label: 'Logo/Design Status',
                        typ: 'select',
                        required: false,
                        options: [
                            { value: '', label: 'Nicht angegeben' },
                            { value: 'vorhanden', label: 'Logo & Design liegen bereits vor' },
                            { value: 'nur-logo', label: 'Nur Logo vorhanden, Design wird benÃ¶tigt' },
                            { value: 'design-service', label: 'Logo & Design mÃ¼ssen erstellt werden' }
                        ]
                    },
                    farbanzahl: {
                        label: 'Anzahl Farben im Design',
                        typ: 'number',
                        min: 1,
                        max: 10,
                        default: 2,
                        required: false
                    },
                    firmenname: {
                        label: 'Firmenname (fÃ¼r Beschriftung)',
                        typ: 'text',
                        placeholder: 'z.B. Mustermann GmbH',
                        required: false
                    },
                    werbebeklebungText: {
                        label: 'Beschriftungstext',
                        typ: 'textarea',
                        placeholder: 'z.B. Slogan, Telefonnummer, Website...',
                        required: false
                    },
                    kontaktdaten: {
                        label: 'Kontaktdaten fÃ¼r Beschriftung',
                        typ: 'textarea',
                        placeholder: 'Tel: 0123-456789\nwww.mustermann.de\ninfo@mustermann.de',
                        required: false
                    },
                    werbebeklebungInfo: {
                        label: 'ZusÃ¤tzliche Informationen',
                        typ: 'textarea',
                        placeholder: 'Weitere WÃ¼nsche oder Anmerkungen...',
                        required: false
                    }
                }
            },
            // ðŸ†• Zusatzfelder fÃ¼r andere Services
            'reifen': {
                teile: ['Reifen vorne links', 'Reifen vorne rechts', 'Reifen hinten links', 'Reifen hinten rechts', 'Felge vorne links', 'Felge vorne rechts', 'Felge hinten links', 'Felge hinten rechts', 'Ersatzrad'],
                arbeiten: ['wechseln', 'auswuchten', 'montieren', 'demontieren', 'reparieren', 'lackieren'],
                tabellen: { ersatzteile: true, arbeitslohn: true, lackierung: false, materialien: false },
                zusatzfelder: {
                    reifengroesse: {
                        label: 'ReifengrÃ¶ÃŸe',
                        typ: 'text',
                        placeholder: 'z.B. 225/45 R17',
                        required: false
                    },
                    reifenTyp: {
                        label: 'Reifen-Typ',
                        typ: 'select',
                        required: false,
                        options: [
                            { value: '', label: 'Nicht angegeben' },
                            { value: 'sommer', label: 'Sommerreifen' },
                            { value: 'winter', label: 'Winterreifen' },
                            { value: 'allseason', label: 'Ganzjahresreifen' }
                        ]
                    },
                    felgenTyp: {
                        label: 'Felgen-Typ',
                        typ: 'select',
                        required: false,
                        options: [
                            { value: '', label: 'Nicht angegeben' },
                            { value: 'stahl', label: 'Stahlfelgen' },
                            { value: 'alu', label: 'Alufelgen' }
                        ]
                    },
                    // ðŸ†• NEU: Feld aus annahme.html (Nov 30, 2025)
                    reifenanzahl: {
                        label: 'Anzahl Reifen',
                        typ: 'select',
                        required: false,
                        options: [
                            { value: '', label: 'Nicht angegeben' },
                            { value: '1', label: '1 Reifen' },
                            { value: '2', label: '2 Reifen' },
                            { value: '4', label: '4 Reifen' },
                            { value: '5', label: '5 Reifen (inkl. Ersatzrad)' }
                        ]
                    }
                }
            },
            'glas': {
                teile: ['Frontscheibe', 'Heckscheibe', 'Seitenscheibe vorne links', 'Seitenscheibe vorne rechts', 'Seitenscheibe hinten links', 'Seitenscheibe hinten rechts', 'Dreiecksfenster', 'Panoramadach'],
                arbeiten: ['austauschen', 'reparieren', 'steinschlag-reparatur', 'demontieren', 'montieren', 'kalibrieren'],
                tabellen: { ersatzteile: true, arbeitslohn: true, lackierung: false, materialien: false },
                zusatzfelder: {
                    // ðŸ†• NEU: Felder aus annahme.html (Nov 30, 2025)
                    scheibentyp: {
                        label: 'Scheibentyp',
                        typ: 'select',
                        required: false,
                        options: [
                            { value: '', label: 'Nicht angegeben' },
                            { value: 'frontscheibe', label: 'Frontscheibe' },
                            { value: 'heckscheibe', label: 'Heckscheibe' },
                            { value: 'seitenscheibe', label: 'Seitenscheibe' },
                            { value: 'dreiecksfenster', label: 'Dreiecksfenster' }
                        ]
                    },
                    glasposition: {
                        label: 'Position',
                        typ: 'select',
                        required: false,
                        options: [
                            { value: '', label: 'Nicht angegeben' },
                            { value: 'vorne', label: 'Vorne' },
                            { value: 'hinten', label: 'Hinten' },
                            { value: 'links', label: 'Links' },
                            { value: 'rechts', label: 'Rechts' }
                        ]
                    },
                    schadensgroesse: {
                        label: 'SchadensgrÃ¶ÃŸe',
                        typ: 'select',
                        required: false,
                        options: [
                            { value: '', label: 'Nicht angegeben' },
                            { value: 'klein', label: 'Klein (< 2cm, reparierbar)' },
                            { value: 'mittel', label: 'Mittel (2-5cm)' },
                            { value: 'gross', label: 'GroÃŸ (> 5cm, Austausch nÃ¶tig)' },
                            { value: 'riss', label: 'Riss' }
                        ]
                    },
                    kalibrierungNoetig: {
                        label: 'Kamera-Kalibrierung nÃ¶tig?',
                        typ: 'select',
                        required: false,
                        options: [
                            { value: '', label: 'Unbekannt' },
                            { value: 'ja', label: 'Ja - Fahrassistenzsysteme vorhanden' },
                            { value: 'nein', label: 'Nein - keine Kalibrierung nÃ¶tig' }
                        ],
                        help: 'Bei Fahrzeugen mit Spurhalteassistent, Notbremsassistent etc.'
                    }
                }
            },
            'klima': {
                teile: ['Klimakompressor', 'Kondensator', 'Verdampfer', 'Trockner', 'Leitungen', 'Innenraumfilter', 'Klimabedienteil'],
                arbeiten: ['prÃ¼fen', 'befÃ¼llen', 'austauschen', 'desinfizieren', 'reinigen'],
                tabellen: { ersatzteile: true, arbeitslohn: true, lackierung: false, materialien: false },
                zusatzfelder: {
                    // ðŸ†• NEU: Felder aus annahme.html (Nov 30, 2025)
                    klimaservice: {
                        label: 'GewÃ¼nschter Service',
                        typ: 'select',
                        required: false,
                        options: [
                            { value: '', label: 'Nicht angegeben' },
                            { value: 'wartung', label: 'Klimawartung' },
                            { value: 'reparatur', label: 'Klimareparatur' },
                            { value: 'befuellung', label: 'KÃ¤ltemittel-BefÃ¼llung' },
                            { value: 'desinfektion', label: 'Desinfektion' }
                        ]
                    },
                    kaeltemittel: {
                        label: 'KÃ¤ltemittel-Typ',
                        typ: 'select',
                        required: false,
                        options: [
                            { value: '', label: 'Unbekannt' },
                            { value: 'r134a', label: 'R134a (bis ca. 2017)' },
                            { value: 'r1234yf', label: 'R1234yf (ab ca. 2017)' }
                        ]
                    },
                    klimaproblem: {
                        label: 'Problembeschreibung',
                        typ: 'textarea',
                        placeholder: 'z.B. Klima kÃ¼hlt nicht mehr, unangenehmer Geruch...',
                        required: false
                    },
                    desinfektion: {
                        label: 'Desinfektion gewÃ¼nscht?',
                        typ: 'select',
                        required: false,
                        options: [
                            { value: '', label: 'Nicht angegeben' },
                            { value: 'ja', label: 'Ja - Ozon-Desinfektion' },
                            { value: 'nein', label: 'Nein' }
                        ]
                    }
                }
            },
            'tuev': {
                teile: ['Bremsen', 'Beleuchtung', 'Lenkung', 'Fahrwerk', 'Abgasanlage', 'Karosserie', 'Reifen', 'Elektronik'],
                arbeiten: ['prÃ¼fen', 'einstellen', 'reparieren', 'austauschen'],
                tabellen: { ersatzteile: false, arbeitslohn: true, lackierung: false, materialien: false },
                zusatzfelder: {
                    // ðŸ†• NEU: Feld aus annahme.html (Nov 30, 2025)
                    pruefart: {
                        label: 'PrÃ¼fart',
                        typ: 'select',
                        required: false,
                        options: [
                            { value: '', label: 'Nicht angegeben' },
                            { value: 'hu', label: 'Hauptuntersuchung (HU)' },
                            { value: 'au', label: 'Abgasuntersuchung (AU)' },
                            { value: 'hu-au', label: 'HU + AU' }
                        ]
                    },
                    huDatum: {
                        label: 'Letztes HU-Datum / FÃ¤lligkeit',
                        typ: 'date',
                        required: false
                    },
                    bekannteMaengel: {
                        label: 'Bekannte MÃ¤ngel',
                        typ: 'textarea',
                        placeholder: 'z.B. Licht defekt, Bremsen verschlissen...',
                        required: false
                    }
                }
            },
            'mechanik': {
                teile: ['Motor', 'Getriebe', 'Kupplung', 'Bremsen vorne', 'Bremsen hinten', 'Auspuff', 'Lenkung', 'Fahrwerk', 'Achse vorne', 'Achse hinten', 'Anlasser', 'Lichtmaschine', 'Batterie', 'Kraftstoffpumpe', 'Wasserpumpe', 'Zahnriemen', 'Keilriemen'],
                arbeiten: ['austauschen', 'reparieren', 'einstellen', 'prÃ¼fen', 'demontieren', 'montieren'],
                tabellen: { ersatzteile: true, arbeitslohn: true, lackierung: false, materialien: false },
                zusatzfelder: {
                    // ðŸ†• NEU: Feld aus annahme.html (Nov 30, 2025)
                    problem: {
                        label: 'Problem / Auftrag',
                        typ: 'textarea',
                        placeholder: 'z.B. Ã–lwechsel, Bremsen erneuern, Inspektion...',
                        required: false
                    },
                    symptome: {
                        label: 'Symptome / Beschreibung',
                        typ: 'textarea',
                        placeholder: 'z.B. GerÃ¤usche beim Bremsen, Motor ruckelt...',
                        required: false
                    },
                    fehlercode: {
                        label: 'Fehlercodes (falls bekannt)',
                        typ: 'text',
                        placeholder: 'z.B. P0300, P0171...',
                        required: false
                    }
                }
            },
            'pflege': {
                teile: ['AuÃŸen komplett', 'Innenraum komplett', 'Motorraum', 'Felgen', 'Scheiben', 'Lack', 'Leder/Stoff', 'Kunststoffe'],
                arbeiten: ['waschen', 'polieren', 'versiegeln', 'reinigen', 'aufbereiten', 'pflegen'],
                tabellen: { ersatzteile: false, arbeitslohn: true, lackierung: false, materialien: true },
                zusatzfelder: {
                    pflegePaket: {
                        label: 'Pflege-Paket',
                        typ: 'select',
                        required: false,
                        options: [
                            { value: '', label: 'Individuell' },
                            { value: 'basis', label: 'Basis-Pflege (AuÃŸenwÃ¤sche)' },
                            { value: 'komfort', label: 'Komfort (AuÃŸen + Innen)' },
                            { value: 'premium', label: 'Premium (Komplett + Politur)' },
                            { value: 'keramik', label: 'Keramik-Versiegelung' }
                        ]
                    },
                    // ðŸ†• NEU: Feld aus annahme.html (Nov 30, 2025)
                    zusatzleistungen: {
                        label: 'Zusatzleistungen',
                        typ: 'textarea',
                        placeholder: 'z.B. Lederpflege, Felgenversiegelung, Geruchsentfernung...',
                        required: false
                    }
                }
            },
            // ðŸ†• NEU: Services die vorher KEINE zusatzfelder hatten (Nov 30, 2025)
            'dellen': {
                teile: ['Motorhaube', 'Dach', 'KotflÃ¼gel vorne links', 'KotflÃ¼gel vorne rechts', 'TÃ¼r vorne links', 'TÃ¼r vorne rechts', 'TÃ¼r hinten links', 'TÃ¼r hinten rechts', 'Heckklappe', 'Seitenwand links', 'Seitenwand rechts'],
                arbeiten: ['ausbeulen', 'drÃ¼cken', 'kleben', 'lackieren', 'ersetzen', 'austauschen'],
                tabellen: { ersatzteile: true, arbeitslohn: true, lackierung: false, materialien: false },
                zusatzfelder: {
                    dellenanzahl: {
                        label: 'Anzahl Dellen',
                        typ: 'select',
                        required: false,
                        options: [
                            { value: '', label: 'Nicht angegeben' },
                            { value: '1-5', label: '1-5 Dellen' },
                            { value: '6-15', label: '6-15 Dellen' },
                            { value: '16-30', label: '16-30 Dellen' },
                            { value: '30+', label: 'Mehr als 30 Dellen' }
                        ]
                    },
                    dellengroesse: {
                        label: 'Durchschnittliche GrÃ¶ÃŸe',
                        typ: 'select',
                        required: false,
                        options: [
                            { value: '', label: 'Nicht angegeben' },
                            { value: 'klein', label: 'Klein (< 1cm)' },
                            { value: 'mittel', label: 'Mittel (1-3cm)' },
                            { value: 'gross', label: 'GroÃŸ (> 3cm)' }
                        ]
                    },
                    lackschaden: {
                        label: 'Lackschaden vorhanden?',
                        typ: 'select',
                        required: false,
                        options: [
                            { value: '', label: 'Nicht angegeben' },
                            { value: 'ja', label: 'Ja - Lack beschÃ¤digt' },
                            { value: 'nein', label: 'Nein - nur Delle' }
                        ]
                    },
                    dellenpositionen: {
                        label: 'Positionen / Beschreibung',
                        typ: 'textarea',
                        placeholder: 'z.B. Hagelschaden Dach und Motorhaube, Parkrempler TÃ¼r links...',
                        required: false
                    }
                }
            },
            'versicherung': {
                teile: ['StoÃŸfÃ¤nger vorne', 'StoÃŸfÃ¤nger hinten', 'Motorhaube', 'KotflÃ¼gel vorne links', 'KotflÃ¼gel vorne rechts', 'TÃ¼r vorne links', 'TÃ¼r vorne rechts', 'TÃ¼r hinten links', 'TÃ¼r hinten rechts', 'Seitenwand links', 'Seitenwand rechts', 'Dach', 'Heckklappe', 'Rahmen/Struktur', 'Airbag', 'Lenkung', 'Achse vorne', 'Achse hinten'],
                arbeiten: ['lackieren', 'austauschen', 'richten', 'schweissen', 'demontieren', 'montieren', 'grundieren', 'spachteln'],
                tabellen: { ersatzteile: true, arbeitslohn: true, lackierung: true, materialien: false },
                zusatzfelder: {
                    schadensnummer: {
                        label: 'Schadensnummer',
                        typ: 'text',
                        placeholder: 'z.B. 2024-123456',
                        required: false
                    },
                    versicherung: {
                        label: 'Versicherung',
                        typ: 'text',
                        placeholder: 'z.B. Allianz, HUK-Coburg, ADAC...',
                        required: false
                    },
                    schadendatum: {
                        label: 'Schadendatum',
                        typ: 'date',
                        required: false
                    },
                    unfallhergang: {
                        label: 'Unfallhergang / Beschreibung',
                        typ: 'textarea',
                        placeholder: 'Kurze Beschreibung des Unfallhergangs...',
                        required: false
                    }
                }
            },
            'lackier': {
                teile: ['StoÃŸfÃ¤nger vorne', 'StoÃŸfÃ¤nger hinten', 'Motorhaube', 'KotflÃ¼gel vorne links', 'KotflÃ¼gel vorne rechts', 'TÃ¼r vorne links', 'TÃ¼r vorne rechts', 'TÃ¼r hinten links', 'TÃ¼r hinten rechts', 'Seitenwand links', 'Seitenwand rechts', 'Dach', 'Heckklappe', 'Schweller links', 'Schweller rechts', 'A-SÃ¤ule', 'B-SÃ¤ule', 'C-SÃ¤ule', 'Spiegel links', 'Spiegel rechts'],
                arbeiten: ['lackieren', 'grundieren', 'spachteln', 'schleifen', 'polieren', 'demontieren', 'montieren', 'ersetzen', 'austauschen'],
                tabellen: { ersatzteile: true, arbeitslohn: true, lackierung: true, materialien: false },
                zusatzfelder: {
                    // ðŸ†• Nov 30, 2025: Felder aus multi-service-anfrage.html hinzugefÃ¼gt
                    farbnummer: {
                        label: 'Farbcode',
                        typ: 'text',
                        placeholder: 'z.B. LC9X, LY9T, Lc92...',
                        required: false
                    },
                    karosserie: {
                        label: 'Demontage benÃ¶tigt?',
                        typ: 'select',
                        required: false,
                        options: [
                            { value: '', label: 'Nicht angegeben' },
                            { value: 'ja', label: 'Ja - Demontage erforderlich' },
                            { value: 'nein', label: 'Nein - keine Demontage' }
                        ]
                    },
                    ersatzteil: {
                        label: 'Ersatzteil-PrÃ¤ferenz',
                        typ: 'select',
                        required: false,
                        options: [
                            { value: '', label: 'Nicht angegeben' },
                            { value: 'original', label: 'Originalteile (OEM)' },
                            { value: 'aftermarket', label: 'ZubehÃ¶rteile (Aftermarket)' },
                            { value: 'gebraucht', label: 'Gebrauchte Teile' }
                        ]
                    },
                    teile: {
                        label: 'Zu lackierende Teile',
                        typ: 'textarea',
                        placeholder: 'z.B. Motorhaube, KotflÃ¼gel vorne links...',
                        required: false
                    },
                    schadenBeschreibung: {
                        label: 'Schadensbeschreibung',
                        typ: 'textarea',
                        placeholder: 'Beschreiben Sie den Schaden...',
                        required: false
                    },
                    ersatzfahrzeugGewuenscht: {
                        label: 'Ersatzfahrzeug gewÃ¼nscht?',
                        typ: 'select',
                        required: false,
                        options: [
                            { value: '', label: 'Nicht angegeben' },
                            { value: 'ja', label: 'Ja' },
                            { value: 'nein', label: 'Nein' }
                        ]
                    }
                }
            }
        };

        // ============================================
        // ðŸš— FAHRZEUG-DIAGRAMM & SCHADENS-WIZARD STATE
        // ============================================
        let selectedPart = null;
        let selectedDamageType = null;
        let selectedDamageSize = null;
        let suggestedItems = [];

        // Mapping: Bauteil â†’ passende Arbeitspositionen (Keywords)
        const partWorkMapping = {
            'StoÃŸfÃ¤nger vorne': {
                kratzer: ['StoÃŸfÃ¤nger vorne lackieren', 'Spot-Repair'],
                delle: ['StoÃŸfÃ¤nger vorne lackieren', 'KunststoffschweiÃŸen', 'Spachteln'],
                riss: ['StoÃŸfÃ¤nger vorne lackieren', 'KunststoffschweiÃŸen', 'Klebereparatur Kunststoff'],
                ersatz: ['StoÃŸfÃ¤nger vorne dem./mont.', 'StoÃŸfÃ¤nger vorne lackieren']
            },
            'StoÃŸfÃ¤nger hinten': {
                kratzer: ['StoÃŸfÃ¤nger hinten lackieren', 'Spot-Repair'],
                delle: ['StoÃŸfÃ¤nger hinten lackieren', 'KunststoffschweiÃŸen', 'Spachteln'],
                riss: ['StoÃŸfÃ¤nger hinten lackieren', 'KunststoffschweiÃŸen', 'Klebereparatur Kunststoff'],
                ersatz: ['StoÃŸfÃ¤nger hinten dem./mont.', 'StoÃŸfÃ¤nger hinten lackieren']
            },
            'Motorhaube': {
                kratzer: ['Motorhaube lackieren', 'Spot-Repair'],
                delle: ['Motorhaube lackieren', 'Delle ausbeulen', 'Spachteln'],
                riss: ['Motorhaube lackieren', 'SchweiÃŸnaht', 'Spachteln'],
                ersatz: ['Motorhaube dem./mont.', 'Motorhaube lackieren']
            },
            'KotflÃ¼gel vorne links': {
                kratzer: ['KotflÃ¼gel vorne lackieren', 'Spot-Repair'],
                delle: ['KotflÃ¼gel vorne lackieren', 'Delle ausbeulen', 'Spachteln'],
                riss: ['KotflÃ¼gel vorne lackieren', 'SchweiÃŸnaht', 'Spachteln'],
                ersatz: ['KotflÃ¼gel vorne dem./mont.', 'KotflÃ¼gel vorne lackieren']
            },
            'KotflÃ¼gel vorne rechts': {
                kratzer: ['KotflÃ¼gel vorne lackieren', 'Spot-Repair'],
                delle: ['KotflÃ¼gel vorne lackieren', 'Delle ausbeulen', 'Spachteln'],
                riss: ['KotflÃ¼gel vorne lackieren', 'SchweiÃŸnaht', 'Spachteln'],
                ersatz: ['KotflÃ¼gel vorne dem./mont.', 'KotflÃ¼gel vorne lackieren']
            },
            'TÃ¼r vorne links': {
                kratzer: ['TÃ¼r lackieren', 'Spot-Repair'],
                delle: ['TÃ¼r lackieren', 'Delle ausbeulen', 'Spachteln'],
                riss: ['TÃ¼r lackieren', 'SchweiÃŸnaht', 'Spachteln'],
                ersatz: ['TÃ¼r vorne dem./mont.', 'TÃ¼r lackieren', 'TÃ¼rverkleidung dem./mont.']
            },
            'TÃ¼r vorne rechts': {
                kratzer: ['TÃ¼r lackieren', 'Spot-Repair'],
                delle: ['TÃ¼r lackieren', 'Delle ausbeulen', 'Spachteln'],
                riss: ['TÃ¼r lackieren', 'SchweiÃŸnaht', 'Spachteln'],
                ersatz: ['TÃ¼r vorne dem./mont.', 'TÃ¼r lackieren', 'TÃ¼rverkleidung dem./mont.']
            },
            'TÃ¼r hinten links': {
                kratzer: ['TÃ¼r lackieren', 'Spot-Repair'],
                delle: ['TÃ¼r lackieren', 'Delle ausbeulen', 'Spachteln'],
                riss: ['TÃ¼r lackieren', 'SchweiÃŸnaht', 'Spachteln'],
                ersatz: ['TÃ¼r hinten dem./mont.', 'TÃ¼r lackieren', 'TÃ¼rverkleidung dem./mont.']
            },
            'TÃ¼r hinten rechts': {
                kratzer: ['TÃ¼r lackieren', 'Spot-Repair'],
                delle: ['TÃ¼r lackieren', 'Delle ausbeulen', 'Spachteln'],
                riss: ['TÃ¼r lackieren', 'SchweiÃŸnaht', 'Spachteln'],
                ersatz: ['TÃ¼r hinten dem./mont.', 'TÃ¼r lackieren', 'TÃ¼rverkleidung dem./mont.']
            },
            'Dach': {
                kratzer: ['Dach lackieren', 'Spot-Repair'],
                delle: ['Dach lackieren', 'Delle ausbeulen', 'Hagelschaden'],
                riss: ['Dach lackieren', 'SchweiÃŸnaht', 'Spachteln'],
                ersatz: ['Dach lackieren']
            },
            'Heckklappe': {
                kratzer: ['Heckklappe lackieren', 'Spot-Repair'],
                delle: ['Heckklappe lackieren', 'Delle ausbeulen', 'Spachteln'],
                riss: ['Heckklappe lackieren', 'SchweiÃŸnaht', 'Spachteln'],
                ersatz: ['Heckklappe dem./mont.', 'Heckklappe lackieren']
            },
            'Seitenteil links': {
                kratzer: ['Seitenteil lackieren', 'Spot-Repair'],
                delle: ['Seitenteil lackieren', 'Delle ausbeulen', 'Spachteln'],
                riss: ['Seitenteil lackieren', 'Seitenteil ersetzen', 'SchweiÃŸnaht'],
                ersatz: ['Seitenteil ersetzen', 'Seitenteil lackieren']
            },
            'Seitenteil rechts': {
                kratzer: ['Seitenteil lackieren', 'Spot-Repair'],
                delle: ['Seitenteil lackieren', 'Delle ausbeulen', 'Spachteln'],
                riss: ['Seitenteil lackieren', 'Seitenteil ersetzen', 'SchweiÃŸnaht'],
                ersatz: ['Seitenteil ersetzen', 'Seitenteil lackieren']
            },
            'Seitenspiegel links': {
                kratzer: ['Spiegel lackieren'],
                delle: ['Spiegel lackieren'],
                riss: ['Seitenspiegel dem./mont.'],
                ersatz: ['Seitenspiegel dem./mont.', 'Spiegel lackieren']
            },
            'Seitenspiegel rechts': {
                kratzer: ['Spiegel lackieren'],
                delle: ['Spiegel lackieren'],
                riss: ['Seitenspiegel dem./mont.'],
                ersatz: ['Seitenspiegel dem./mont.', 'Spiegel lackieren']
            },
            'Schweller links': {
                kratzer: ['Schweller lackieren', 'Spot-Repair'],
                delle: ['Schweller lackieren', 'Spachteln'],
                riss: ['Schweller lackieren', 'Schweller ersetzen'],
                ersatz: ['Schweller ersetzen', 'Schweller lackieren']
            },
            'Schweller rechts': {
                kratzer: ['Schweller lackieren', 'Spot-Repair'],
                delle: ['Schweller lackieren', 'Spachteln'],
                riss: ['Schweller lackieren', 'Schweller ersetzen'],
                ersatz: ['Schweller ersetzen', 'Schweller lackieren']
            }
        };

        // GrÃ¶ÃŸen-Suffix fÃ¼r Spot-Repair und Dellen
        const sizeMapping = {
            klein: { spotRepair: 'Spot-Repair XS', delle: 'PDR XS', spachteln: 'Spachteln klein' },
            mittel: { spotRepair: 'Spot-Repair M', delle: 'PDR M', spachteln: 'Spachteln mittel' },
            gross: { spotRepair: 'Spot-Repair XL', delle: 'PDR XL', spachteln: 'Spachteln groÃŸ' }
        };

        // Initialize Feather Icons
        feather.replace();

        // Wait for Firebase AND werkstattId
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                await window.initFirebase();
                console.log('âœ… Firebase initialisiert');

                // ðŸ†• FIX (2025-11-29): Wait for werkstattId (auth-manager sets it after auth state)
                let attempts = 0;
                while (!window.werkstattId && attempts < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }

                if (!window.werkstattId) {
                    console.warn('âš ï¸ werkstattId nicht gefunden nach 5s - Benutzer nicht eingeloggt?');
                    showToast('Bitte einloggen um fortzufahren', 'error');
                    setTimeout(() => safeNavigate('index.html'), 2000);
                    return;
                }

                console.log('âœ… werkstattId:', window.werkstattId);

                // Load saved settings
                await loadSaetze();
                await loadKatalog();
                await loadMaterial();
                await loadTemplates();
                await loadLieferanten();
                await loadFahrzeuge();

                // Check URL params for tab
                const urlParams = new URLSearchParams(window.location.search);
                const tab = urlParams.get('tab');
                if (tab) {
                    switchTab(tab);
                }

                // Fahrzeug-Diagramm initialisieren
                initVehicleDiagram();

                // OE-Nummern Ersatzteile-Suche initialisieren
                initOeSearch();

                // ðŸ†• Neuen Kalkulations-Wizard initialisieren
                initKalkWizard();

                console.log('âœ… Kalkulation-Modul geladen');
            } catch (error) {
                console.error('âŒ Fehler beim Initialisieren:', error);
                showToast('Fehler beim Laden der Daten', 'error');
            }
        });

        // ============================================
        // ðŸ†• NEUER KALKULATIONS-WIZARD FUNKTIONEN
        // ============================================

        function initKalkWizard() {
            // Marken-Dropdown befÃ¼llen aus ERSATZTEILE_DB
            const markeSelect = document.getElementById('kalkMarke');
            if (markeSelect && typeof ERSATZTEILE_DB !== 'undefined') {
                markeSelect.innerHTML = '<option value="">-- Marke wÃ¤hlen --</option>';
                Object.keys(ERSATZTEILE_DB.marken).sort().forEach(key => {
                    const marke = ERSATZTEILE_DB.marken[key];
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = marke.name;
                    markeSelect.appendChild(option);
                });
            }

            // Baujahr-Dropdown befÃ¼llen (2010-2025)
            const baujahrSelect = document.getElementById('kalkBaujahr');
            if (baujahrSelect) {
                baujahrSelect.innerHTML = '<option value="">-- Baujahr --</option>';
                for (let year = 2025; year >= 2005; year--) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    baujahrSelect.appendChild(option);
                }
            }

            // Event-Listener fÃ¼r Fahrzeugdaten
            ['kalkMarke', 'kalkModell', 'kalkBaujahr', 'kalkKennzeichen', 'kalkFarbe', 'kalkKunde'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('change', updateVehicleInfo);
                if (el) el.addEventListener('input', updateVehicleInfo);
            });

            console.log('âœ… Kalkulations-Wizard initialisiert');
        }

        function updateKalkModelle() {
            const markeEl = document.getElementById('kalkMarke');
            const modellSelect = document.getElementById('kalkModell');
            if (!markeEl || !modellSelect) return;

            const markeKey = markeEl.value;
            modellSelect.innerHTML = '<option value="">-- Modell wÃ¤hlen --</option>';

            if (markeKey && ERSATZTEILE_DB?.marken?.[markeKey]) {
                const marke = ERSATZTEILE_DB.marken[markeKey];
                Object.keys(marke.modelle).sort().forEach(key => {
                    const modell = marke.modelle[key];
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = `${modell.name} (${modell.baujahre})`;
                    modellSelect.appendChild(option);
                });
            }

            updateVehicleInfo();
        }

        function updateVehicleInfo() {
            const marke = document.getElementById('kalkMarke');
            const modell = document.getElementById('kalkModell');
            const baujahr = document.getElementById('kalkBaujahr');
            const kennzeichen = document.getElementById('kalkKennzeichen');
            const farbe = document.getElementById('kalkFarbe');
            const kunde = document.getElementById('kalkKunde');

            // Speichern
            kalkWizardData.fahrzeug = {
                marke: marke?.options[marke.selectedIndex]?.text || '',
                markeKey: marke?.value || '',
                modell: modell?.options[modell.selectedIndex]?.text || '',
                modellKey: modell?.value || '',
                baujahr: baujahr?.value || '',
                kennzeichen: kennzeichen?.value || '',
                farbcode: farbe?.value || '',
                kunde: kunde?.value || ''
            };

            // Info-Box anzeigen wenn Marke + Modell gewÃ¤hlt
            const infoBox = document.getElementById('kalkVehicleInfo');
            if (infoBox && kalkWizardData.fahrzeug.marke && kalkWizardData.fahrzeug.modell && kalkWizardData.fahrzeug.modell !== '-- Modell wÃ¤hlen --') {
                infoBox.style.display = 'flex';
                document.getElementById('kalkVehicleDisplay').textContent =
                    `${kalkWizardData.fahrzeug.marke} ${kalkWizardData.fahrzeug.modell}`;

                let extra = [];
                if (kalkWizardData.fahrzeug.baujahr) extra.push(`Bj. ${kalkWizardData.fahrzeug.baujahr}`);
                if (kalkWizardData.fahrzeug.kennzeichen) extra.push(kalkWizardData.fahrzeug.kennzeichen);
                if (kalkWizardData.fahrzeug.farbcode) extra.push(`Farbe: ${kalkWizardData.fahrzeug.farbcode}`);
                document.getElementById('kalkVehicleExtra').textContent = extra.join(' | ') || '-';
            } else if (infoBox) {
                infoBox.style.display = 'none';
            }
        }

        function goToStep(step) {
            // Validierung vor Schrittwechsel (nur fÃ¼r numerische Steps)
            const numericCurrent = typeof currentStep === 'string' ? parseInt(currentStep) : currentStep;
            const numericTarget = typeof step === 'string' ? parseInt(step) : step;

            if (numericTarget > numericCurrent) {
                if (!validateStep(currentStep)) {
                    return;
                }
            }

            // Schritt aktualisieren
            currentStep = step;
            updateStepUI();

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ============================================
        // ðŸ†• MULTI-SERVICE INFO-BOX & AKKORDEON (2025-11-30)
        // ============================================

        /**
         * Zeigt die Multi-Service Info-Box in Step 2 an
         * Akkordeon mit allen Services und deren Status
         */
        function showMultiServiceInfoBox() {
            if (!kalkWizardData.isMultiService) return;

            // Container fÃ¼r Info-Box finden oder erstellen
            let infoBox = document.getElementById('multiServiceInfoBox');
            const step2Content = document.querySelector('.wizard-step[data-step="2"]');

            if (!infoBox && step2Content) {
                infoBox = document.createElement('div');
                infoBox.id = 'multiServiceInfoBox';
                step2Content.insertBefore(infoBox, step2Content.firstChild);
            }

            if (!infoBox) return;

            const services = kalkWizardData.services;
            const currentIndex = kalkWizardData.currentServiceIndex;

            // Akkordeon-HTML generieren
            let accordionHTML = `
                <div class="multi-service-info" style="
                    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
                    border: 2px solid #667eea;
                    border-radius: 16px;
                    padding: 20px;
                    margin-bottom: 24px;
                ">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                        <span style="font-size: 24px;">ðŸ“¦</span>
                        <div>
                            <h3 style="margin: 0; color: #667eea; font-size: 18px;">Multi-Service Auftrag</h3>
                            <p style="margin: 4px 0 0 0; color: #666; font-size: 14px;">
                                ${services.length} Services ausgewÃ¤hlt - bitte fÃ¼r jeden Service die Details eingeben
                            </p>
                        </div>
                    </div>

                    <div class="service-accordion" style="display: flex; flex-direction: column; gap: 8px;">
            `;

            services.forEach((service, index) => {
                const serviceLabel = SERVICE_LABELS[service] || service;
                const config = SERVICE_CONFIG[service];
                const hasDetails = config?.zusatzfelder && Object.keys(config.zusatzfelder).length > 0;
                const isCompleted = kalkWizardData.serviceDetailsPerService[service] &&
                    Object.keys(kalkWizardData.serviceDetailsPerService[service]).length > 0;
                const isCurrent = index === currentIndex;

                let statusIcon = 'â³';
                let statusColor = '#999';
                let statusText = 'Ausstehend';

                if (isCompleted) {
                    statusIcon = 'âœ…';
                    statusColor = '#10b981';
                    statusText = 'Abgeschlossen';
                } else if (isCurrent) {
                    statusIcon = 'ðŸ“';
                    statusColor = '#667eea';
                    statusText = 'Aktuell';
                }

                if (!hasDetails) {
                    statusIcon = 'âž–';
                    statusColor = '#999';
                    statusText = 'Keine Details nÃ¶tig';
                }

                accordionHTML += `
                    <div class="service-accordion-item" style="
                        background: ${isCurrent ? 'rgba(102, 126, 234, 0.15)' : 'white'};
                        border: 1px solid ${isCurrent ? '#667eea' : '#e5e7eb'};
                        border-radius: 12px;
                        padding: 12px 16px;
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        ${isCurrent ? 'box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);' : ''}
                    ">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 20px;">${statusIcon}</span>
                            <div>
                                <div style="font-weight: 600; color: #1f2937;">${serviceLabel}</div>
                                <div style="font-size: 12px; color: ${statusColor};">${statusText}</div>
                            </div>
                        </div>
                        <span style="
                            background: ${statusColor}20;
                            color: ${statusColor};
                            padding: 4px 10px;
                            border-radius: 20px;
                            font-size: 12px;
                            font-weight: 500;
                        ">${index + 1}/${services.length}</span>
                    </div>
                `;
            });

            accordionHTML += `
                    </div>
                </div>
            `;

            infoBox.innerHTML = accordionHTML;
        }

        /**
         * Geht zum nÃ¤chsten Service oder zu Step 3 wenn alle fertig
         */
        function moveToNextServiceOrStep3() {
            kalkWizardData.currentServiceIndex++;

            if (kalkWizardData.currentServiceIndex < kalkWizardData.services.length) {
                // NÃ¤chster Service
                const nextService = kalkWizardData.services[kalkWizardData.currentServiceIndex];
                kalkWizardData.serviceArt = nextService; // Backwards-Compat update

                console.log(`ðŸ†• Multi-Service: Wechsle zu Service ${kalkWizardData.currentServiceIndex + 1}/${kalkWizardData.services.length}: ${nextService}`);

                const config = SERVICE_CONFIG[nextService];
                if (config?.zusatzfelder && Object.keys(config.zusatzfelder).length > 0) {
                    // Service hat Details â†’ Step 2b anzeigen
                    currentStep = '2b';
                    renderServiceDetails(nextService, config.zusatzfelder);
                    updateStepUI();
                    showMultiServiceInfoBox(); // Info-Box aktualisieren
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                } else {
                    // Service hat keine Details â†’ nÃ¤chsten prÃ¼fen
                    moveToNextServiceOrStep3();
                }
            } else {
                // Alle Services durch â†’ Step 3
                console.log('ðŸ†• Multi-Service: Alle Services abgeschlossen, gehe zu Step 3');
                goToStep(3);
            }
        }

        // ============================================
        // ðŸ†• STEP 2 â†’ 2b NAVIGATION (Konditional)
        // ============================================
        function goToStep2Next() {
            // Validierung Step 2
            if (!validateStep(2)) return;

            // ðŸ†• MULTI-SERVICE: PrÃ¼fe ob Multi-Service Modus
            if (kalkWizardData.isMultiService) {
                // Bei Multi-Service: currentServiceIndex auf 0 setzen und ersten Service prÃ¼fen
                kalkWizardData.currentServiceIndex = 0;
                kalkWizardData.serviceArt = kalkWizardData.services[0];
            }

            const serviceArt = kalkWizardData.serviceArt;
            const config = SERVICE_CONFIG[serviceArt];

            // Check ob der Service zusatzfelder hat
            if (config && config.zusatzfelder && Object.keys(config.zusatzfelder).length > 0) {
                // Zu Step 2b wechseln
                currentStep = '2b';
                renderServiceDetails(serviceArt, config.zusatzfelder);
                updateStepUI();
                if (kalkWizardData.isMultiService) {
                    showMultiServiceInfoBox(); // Info-Box aktualisieren
                }
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else {
                // ðŸ†• MULTI-SERVICE: Wenn erster Service keine Details hat, zum nÃ¤chsten
                if (kalkWizardData.isMultiService && kalkWizardData.services.length > 1) {
                    moveToNextServiceOrStep3();
                } else {
                    // Direkt zu Step 3 (keine zusatzfelder)
                    goToStep(3);
                }
            }
        }

        /**
         * ðŸ†• Step 2b "Weiter" Button Handler (2025-11-30)
         * ðŸ”§ VEREINFACHT (2025-11-30): Alle Services sind jetzt auf einer Seite
         * Direkt zu Step 3 gehen
         */
        function goToStep2bNext() {
            // Validierung (optional - kann deaktiviert werden wenn gewÃ¼nscht)
            // if (!validateStep('2b')) return;

            console.log('ðŸ†• Step 2b abgeschlossen, alle Service-Details erfasst');
            console.log('   serviceDetailsPerService:', kalkWizardData.serviceDetailsPerService);

            // Direkt zu Step 3 (Teile)
            goToStep(3);
        }

        /**
         * ðŸ†• Step 2b "ZurÃ¼ck" Button Handler (2025-11-30)
         * ZurÃ¼ck zu Step 1 (Fahrzeug-Auswahl)
         */
        function goToStep2bBack() {
            console.log('ðŸ†• Step 2b: ZurÃ¼ck zu Step 1');
            goToStep(1);
        }

        // ============================================
        // ðŸ†• SERVICE-DETAILS FORM RENDERING
        // ============================================
        // Storage fÃ¼r hochgeladene Design-Dateien
        let uploadedDesignFiles = {};

        /**
         * ðŸ†• NEU (2025-11-30): Rendert ALLE Service-Details auf einer Seite
         * Bei Multi-Service: Akkordeons fÃ¼r jeden Service
         * Bei Single-Service: Nur ein Formular
         */
        function renderAllServiceDetails() {
            const formContainer = document.getElementById('serviceDetailsForm');
            if (!formContainer) return;

            const services = kalkWizardData.services || [kalkWizardData.serviceArt];
            const isMulti = kalkWizardData.isMultiService && services.length > 1;

            console.log('ðŸ†• renderAllServiceDetails:', { services, isMulti });

            // Header aktualisieren
            const serviceNameEl = document.getElementById('step2bServiceName');
            if (serviceNameEl) {
                if (isMulti) {
                    serviceNameEl.textContent = `${services.length} Services`;
                } else {
                    serviceNameEl.textContent = SERVICE_LABELS[services[0]] || services[0];
                }
            }

            // Badge aktualisieren
            const badgeEl = document.getElementById('step2bServiceBadge');
            if (badgeEl) {
                if (isMulti) {
                    badgeEl.innerHTML = services.map(s => `<span style="margin-right: 8px;">${SERVICE_LABELS[s] || s}</span>`).join(' + ');
                } else {
                    badgeEl.textContent = SERVICE_LABELS[services[0]] || services[0];
                }
            }

            // Fahrzeug-Info aktualisieren
            const vehicleDisplay = document.getElementById('step2bVehicleDisplay');
            if (vehicleDisplay) {
                vehicleDisplay.textContent = `${kalkWizardData.fahrzeug.marke || '-'} ${kalkWizardData.fahrzeug.modell || '-'}`;
                if (kalkWizardData.fahrzeug.baujahr) {
                    vehicleDisplay.textContent += ` (${kalkWizardData.fahrzeug.baujahr})`;
                }
            }

            let html = '';

            if (isMulti) {
                // ðŸ†• MULTI-SERVICE: Akkordeons fÃ¼r JEDEN Service (auch ohne zusatzfelder!)
                html = '<div class="multi-service-accordions">';

                services.forEach((service, index) => {
                    const config = SERVICE_CONFIG[service] || {};
                    const serviceLabel = SERVICE_LABELS[service] || service;
                    const isFirst = index === 0;
                    const hasDetails = config.zusatzfelder && Object.keys(config.zusatzfelder).length > 0;

                    html += `
                        <div class="service-accordion" data-service="${service}">
                            <div class="service-accordion__header ${isFirst ? 'active' : ''}" onclick="toggleServiceAccordion('${service}')">
                                <div class="service-accordion__title">
                                    <span class="service-accordion__icon">${getServiceIcon(service)}</span>
                                    <span class="service-accordion__label">${serviceLabel}</span>
                                    <span class="service-accordion__badge">${index + 1}/${services.length}</span>
                                </div>
                                <span class="service-accordion__chevron">
                                    <i data-feather="${isFirst ? 'chevron-up' : 'chevron-down'}"></i>
                                </span>
                            </div>
                            <div class="service-accordion__content" id="accordion_${service}" style="display: ${isFirst ? 'block' : 'none'};">
                                <div class="service-accordion__form">
                    `;

                    if (hasDetails) {
                        // Felder fÃ¼r diesen Service
                        for (const [fieldId, fieldConfig] of Object.entries(config.zusatzfelder)) {
                            html += renderServiceFieldForMulti(service, fieldId, fieldConfig);
                        }
                    } else {
                        // Keine zusÃ¤tzlichen Felder nÃ¶tig
                        html += `
                            <div class="no-details-info" style="
                                background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
                                border: 1px solid #86efac;
                                border-radius: 8px;
                                padding: 16px;
                                text-align: center;
                                color: #166534;
                            ">
                                <div style="font-size: 32px; margin-bottom: 8px;">âœ…</div>
                                <div style="font-weight: 600;">Keine zusÃ¤tzlichen Details erforderlich</div>
                                <div style="font-size: 14px; color: #4ade80; margin-top: 4px;">
                                    Die Teile und Arbeiten werden in Schritt 3 erfasst
                                </div>
                            </div>
                        `;
                    }

                    html += `
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';

                // CSS fÃ¼r Akkordeons hinzufÃ¼gen
                html += `
                    <style>
                        .multi-service-accordions {
                            display: flex;
                            flex-direction: column;
                            gap: 16px;
                        }
                        .service-accordion {
                            border: 1px solid #e5e7eb;
                            border-radius: 12px;
                            overflow: hidden;
                            background: white;
                        }
                        .service-accordion__header {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            padding: 16px 20px;
                            background: #f9fafb;
                            cursor: pointer;
                            transition: background 0.2s;
                        }
                        .service-accordion__header:hover {
                            background: #f3f4f6;
                        }
                        .service-accordion__header.active {
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                        }
                        .service-accordion__title {
                            display: flex;
                            align-items: center;
                            gap: 12px;
                            font-weight: 600;
                        }
                        .service-accordion__icon {
                            font-size: 24px;
                        }
                        .service-accordion__label {
                            font-size: 16px;
                        }
                        .service-accordion__badge {
                            background: rgba(255,255,255,0.2);
                            padding: 4px 10px;
                            border-radius: 20px;
                            font-size: 12px;
                        }
                        .service-accordion__header:not(.active) .service-accordion__badge {
                            background: #e5e7eb;
                            color: #6b7280;
                        }
                        .service-accordion__chevron {
                            display: flex;
                            align-items: center;
                        }
                        .service-accordion__content {
                            padding: 20px;
                            border-top: 1px solid #e5e7eb;
                        }
                        .service-accordion__form {
                            display: flex;
                            flex-direction: column;
                            gap: 16px;
                        }
                    </style>
                `;

            } else {
                // SINGLE-SERVICE: Normales Formular (wie bisher)
                const service = services[0];
                const config = SERVICE_CONFIG[service] || {};
                const hasDetails = config.zusatzfelder && Object.keys(config.zusatzfelder).length > 0;

                if (hasDetails) {
                    for (const [fieldId, fieldConfig] of Object.entries(config.zusatzfelder)) {
                        html += renderServiceFieldForMulti(service, fieldId, fieldConfig);
                    }
                } else {
                    // Keine Details nÃ¶tig â†’ direkt zu Step 3
                    console.log('ðŸ†• Single-Service ohne zusatzfelder, gehe direkt zu Step 3');
                    goToStep(3);
                    return;
                }
            }

            formContainer.innerHTML = html;

            // File-Upload Event-Listeners hinzufÃ¼gen
            setupFileUploadListeners();

            // VorausgefÃ¼llte Werte laden
            setTimeout(() => {
                services.forEach(service => {
                    const savedDetails = kalkWizardData.serviceDetailsPerService[service];
                    if (savedDetails && typeof savedDetails === 'object') {
                        console.log(`ðŸ“‹ Lade vorausgefÃ¼llte Werte fÃ¼r "${service}":`, savedDetails);
                        for (const [fieldId, fieldValue] of Object.entries(savedDetails)) {
                            const input = document.getElementById(`serviceField_${service}_${fieldId}`);
                            if (input && fieldValue !== undefined && fieldValue !== null) {
                                input.value = fieldValue;
                                console.log(`   âœ… Feld "${service}.${fieldId}" vorausgefÃ¼llt mit: "${fieldValue}"`);
                            }
                        }
                    }
                });
            }, 100);

            // Feather Icons neu rendern
            if (typeof feather !== 'undefined') feather.replace();
        }

        /**
         * Service-Icon basierend auf Service-Typ
         */
        function getServiceIcon(service) {
            const icons = {
                'lackier': 'ðŸŽ¨',
                'versicherung': 'ðŸ›¡ï¸',
                'dellen': 'ðŸ”¨',
                'glas': 'ðŸªŸ',
                'reifen': 'ðŸ›ž',
                'mechanik': 'ðŸ”§',
                'klima': 'â„ï¸',
                'pflege': 'âœ¨',
                'tuev': 'ðŸ“‹',
                'folierung': 'ðŸŽ­',
                'steinschutz': 'ðŸ›¡ï¸',
                'werbebeklebung': 'ðŸ“¢'
            };
            return icons[service] || 'âš™ï¸';
        }

        /**
         * Toggle Akkordeon fÃ¼r einen Service
         */
        function toggleServiceAccordion(service) {
            const content = document.getElementById(`accordion_${service}`);
            const header = content?.previousElementSibling;
            const chevron = header?.querySelector('.service-accordion__chevron i');

            if (!content) return;

            const isOpen = content.style.display !== 'none';

            if (isOpen) {
                content.style.display = 'none';
                header?.classList.remove('active');
                if (chevron) chevron.setAttribute('data-feather', 'chevron-down');
            } else {
                content.style.display = 'block';
                header?.classList.add('active');
                if (chevron) chevron.setAttribute('data-feather', 'chevron-up');
            }

            if (typeof feather !== 'undefined') feather.replace();
        }

        /**
         * Rendert ein Feld fÃ¼r Multi-Service (mit Service-Prefix in ID)
         * ðŸ†• FIX (2025-11-30): VorausgefÃ¼llte Werte aus serviceDetailsPerService laden
         */
        function renderServiceFieldForMulti(service, fieldId, config) {
            const required = config.required ? '<span class="required-star">*</span>' : '';
            const requiredAttr = config.required ? 'required' : '';
            const fullFieldId = `serviceField_${service}_${fieldId}`;

            // ðŸ†• FIX: VorausgefÃ¼llten Wert aus serviceDetailsPerService holen
            const prefillData = kalkWizardData.serviceDetailsPerService[service] || {};
            const prefillValue = prefillData[fieldId] || '';

            let inputHtml = '';

            switch (config.typ) {
                case 'select':
                    inputHtml = `
                        <select id="${fullFieldId}" name="${fieldId}" ${requiredAttr} onchange="saveServiceFieldValueMulti('${service}', '${fieldId}')">
                            <option value="">-- Bitte wÃ¤hlen --</option>
                            ${config.options.map(opt => `<option value="${opt.value}" ${prefillValue === opt.value ? 'selected' : ''}>${opt.label}</option>`).join('')}
                        </select>
                    `;
                    break;

                case 'text':
                    inputHtml = `
                        <input type="text" id="${fullFieldId}" name="${fieldId}" ${requiredAttr}
                               placeholder="${config.placeholder || ''}"
                               value="${prefillValue}"
                               onchange="saveServiceFieldValueMulti('${service}', '${fieldId}')">
                    `;
                    break;

                case 'textarea':
                    inputHtml = `
                        <textarea id="${fullFieldId}" name="${fieldId}" ${requiredAttr}
                                  placeholder="${config.placeholder || ''}"
                                  onchange="saveServiceFieldValueMulti('${service}', '${fieldId}')">${prefillValue}</textarea>
                    `;
                    break;

                case 'number':
                    inputHtml = `
                        <input type="number" id="${fullFieldId}" name="${fieldId}" ${requiredAttr}
                               min="${config.min || ''}" max="${config.max || ''}" value="${prefillValue || config.default || ''}"
                               onchange="saveServiceFieldValueMulti('${service}', '${fieldId}')">
                    `;
                    break;

                case 'date':
                    inputHtml = `
                        <input type="date" id="${fullFieldId}" name="${fieldId}" ${requiredAttr}
                               value="${prefillValue}"
                               onchange="saveServiceFieldValueMulti('${service}', '${fieldId}')">
                    `;
                    break;

                case 'file':
                    const acceptAttr = config.accept || 'image/*';
                    const multipleAttr = config.multiple ? 'multiple' : '';
                    inputHtml = `
                        <div class="file-upload-field">
                            <input type="file" id="${fullFieldId}" name="${fieldId}"
                                   accept="${acceptAttr}" ${multipleAttr}
                                   onchange="handleDesignUpload(this, '${service}', '${fieldId}')">
                            <label for="${fullFieldId}" class="file-upload-label">
                                <i data-feather="upload"></i>
                                <span>${config.placeholder || 'Datei hochladen'}</span>
                            </label>
                            ${prefillValue ? `<div class="file-uploaded-info" style="margin-top: 8px; font-size: 12px; color: #4caf50;">âœ… Datei vorhanden</div>` : ''}
                        </div>
                    `;
                    break;

                default:
                    inputHtml = `<input type="text" id="${fullFieldId}" name="${fieldId}" ${requiredAttr} value="${prefillValue}">`;
            }

            // ðŸ†• FIX: Zeige an wenn Wert vorausgefÃ¼llt wurde
            const prefillBadge = prefillValue ? '<span style="font-size: 10px; color: #4caf50; margin-left: 6px;">âœ“ Vom Partner</span>' : '';

            return `
                <div class="form-group">
                    <label for="${fullFieldId}">${config.label} ${required}${prefillBadge}</label>
                    ${inputHtml}
                    ${config.help ? `<small class="form-help">${config.help}</small>` : ''}
                </div>
            `;
        }

        /**
         * Speichert Feldwert fÃ¼r Multi-Service
         */
        function saveServiceFieldValueMulti(service, fieldId) {
            const input = document.getElementById(`serviceField_${service}_${fieldId}`);
            if (!input) return;

            if (!kalkWizardData.serviceDetailsPerService[service]) {
                kalkWizardData.serviceDetailsPerService[service] = {};
            }

            kalkWizardData.serviceDetailsPerService[service][fieldId] = input.value;
            console.log(`ðŸ“ Multi-Service Details gespeichert fÃ¼r ${service}.${fieldId}:`, input.value);
        }

        // Legacy Funktion fÃ¼r Backwards-Compatibility
        function renderServiceDetails(serviceArt, zusatzfelder) {
            const formContainer = document.getElementById('serviceDetailsForm');
            const previewContainer = document.getElementById('designUploadPreview');
            const previewGrid = document.getElementById('designPreviewGrid');

            if (!formContainer) return;

            // Service-Name in Header anzeigen
            const serviceNameEl = document.getElementById('step2bServiceName');
            if (serviceNameEl) {
                serviceNameEl.textContent = SERVICE_LABELS[serviceArt] || serviceArt;
            }

            // Badge aktualisieren
            const badgeEl = document.getElementById('step2bServiceBadge');
            if (badgeEl) {
                badgeEl.textContent = SERVICE_LABELS[serviceArt] || serviceArt;
            }

            // Fahrzeug-Info aktualisieren
            const vehicleDisplay = document.getElementById('step2bVehicleDisplay');
            if (vehicleDisplay) {
                vehicleDisplay.textContent = `${kalkWizardData.fahrzeug.marke || '-'} ${kalkWizardData.fahrzeug.modell || '-'}`;
                if (kalkWizardData.fahrzeug.baujahr) {
                    vehicleDisplay.textContent += ` (${kalkWizardData.fahrzeug.baujahr})`;
                }
            }

            // Form-Inhalt generieren
            let html = '';
            for (const [fieldId, fieldConfig] of Object.entries(zusatzfelder)) {
                html += renderServiceField(fieldId, fieldConfig);
            }
            formContainer.innerHTML = html;

            // File-Upload Event-Listeners hinzufÃ¼gen
            setupFileUploadListeners();

            // ðŸ”§ FIX (2025-11-30): VorausgefÃ¼llte Werte aus serviceDetailsPerService laden
            const savedDetails = kalkWizardData.serviceDetailsPerService[serviceArt];
            if (savedDetails && typeof savedDetails === 'object') {
                console.log(`ðŸ“‹ Lade vorausgefÃ¼llte Werte fÃ¼r "${serviceArt}":`, savedDetails);

                // Warte kurz, damit DOM vollstÃ¤ndig gerendert ist
                setTimeout(() => {
                    for (const [fieldId, fieldValue] of Object.entries(savedDetails)) {
                        const input = document.getElementById(`serviceField_${fieldId}`);
                        if (input && fieldValue !== undefined && fieldValue !== null) {
                            input.value = fieldValue;
                            console.log(`   âœ… Feld "${fieldId}" vorausgefÃ¼llt mit: "${fieldValue}"`);
                        }
                    }
                }, 50);
            }

            // Design-Preview ausblenden initial
            if (previewContainer) previewContainer.style.display = 'none';
            if (previewGrid) previewGrid.innerHTML = '';

            // Feather Icons neu rendern
            if (typeof feather !== 'undefined') feather.replace();
        }

        function renderServiceField(fieldId, config) {
            const required = config.required ? '<span class="required-star">*</span>' : '';
            const requiredAttr = config.required ? 'required' : '';

            let inputHtml = '';

            switch (config.typ) {
                case 'select':
                    inputHtml = `
                        <select id="serviceField_${fieldId}" name="${fieldId}" ${requiredAttr} onchange="saveServiceFieldValue('${fieldId}')">
                            <option value="">-- Bitte wÃ¤hlen --</option>
                            ${config.options.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('')}
                        </select>
                    `;
                    break;

                case 'text':
                    inputHtml = `
                        <input type="text" id="serviceField_${fieldId}" name="${fieldId}" ${requiredAttr}
                               placeholder="${config.placeholder || ''}"
                               onchange="saveServiceFieldValue('${fieldId}')">
                    `;
                    break;

                case 'textarea':
                    inputHtml = `
                        <textarea id="serviceField_${fieldId}" name="${fieldId}" ${requiredAttr}
                                  placeholder="${config.placeholder || ''}"
                                  onchange="saveServiceFieldValue('${fieldId}')"></textarea>
                    `;
                    break;

                case 'number':
                    inputHtml = `
                        <input type="number" id="serviceField_${fieldId}" name="${fieldId}" ${requiredAttr}
                               min="${config.min || ''}" max="${config.max || ''}" value="${config.default || ''}"
                               onchange="saveServiceFieldValue('${fieldId}')">
                    `;
                    break;

                case 'date':
                    inputHtml = `
                        <input type="date" id="serviceField_${fieldId}" name="${fieldId}" ${requiredAttr}
                               onchange="saveServiceFieldValue('${fieldId}')">
                    `;
                    break;

                case 'file':
                    const acceptAttr = config.accept || 'image/*';
                    const multipleAttr = config.multiple ? 'multiple' : '';
                    inputHtml = `
                        <div class="service-file-upload" id="fileUpload_${fieldId}">
                            <input type="file" id="serviceField_${fieldId}" name="${fieldId}"
                                   accept="${acceptAttr}" ${multipleAttr}
                                   onchange="handleDesignUpload('${fieldId}', this.files)">
                            <div class="service-file-upload__icon">ðŸ“</div>
                            <div class="service-file-upload__text">Dateien hierher ziehen oder klicken</div>
                            <div class="service-file-upload__hint">${config.help || acceptAttr}</div>
                        </div>
                    `;
                    break;

                default:
                    inputHtml = `<input type="text" id="serviceField_${fieldId}" name="${fieldId}">`;
            }

            return `
                <div class="service-field-group">
                    <label for="serviceField_${fieldId}">${config.label} ${required}</label>
                    ${inputHtml}
                    ${config.help && config.typ !== 'file' ? `<span class="service-field-help">${config.help}</span>` : ''}
                </div>
            `;
        }

        function saveServiceFieldValue(fieldId) {
            const input = document.getElementById(`serviceField_${fieldId}`);
            if (!input) return;

            // Service-Details im kalkWizardData speichern
            if (!kalkWizardData.serviceDetails) {
                kalkWizardData.serviceDetails = {};
            }
            kalkWizardData.serviceDetails[fieldId] = input.value;

            // ðŸ†• MULTI-SERVICE: Details pro Service speichern (2025-11-30)
            const currentService = kalkWizardData.services[kalkWizardData.currentServiceIndex] || kalkWizardData.serviceArt;
            if (!kalkWizardData.serviceDetailsPerService[currentService]) {
                kalkWizardData.serviceDetailsPerService[currentService] = {};
            }
            kalkWizardData.serviceDetailsPerService[currentService][fieldId] = input.value;

            console.log(`ðŸ“ Service-Details gespeichert fÃ¼r ${currentService}:`, kalkWizardData.serviceDetailsPerService[currentService]);
        }

        function setupFileUploadListeners() {
            // Drag & Drop fÃ¼r File-Upload-Bereiche
            document.querySelectorAll('.service-file-upload').forEach(uploadArea => {
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('drag-over');
                });

                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('drag-over');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('drag-over');
                    const input = uploadArea.querySelector('input[type="file"]');
                    if (input && e.dataTransfer.files.length > 0) {
                        input.files = e.dataTransfer.files;
                        const fieldId = input.name;
                        handleDesignUpload(fieldId, e.dataTransfer.files);
                    }
                });
            });
        }

        async function handleDesignUpload(fieldId, files) {
            if (!files || files.length === 0) return;

            console.log(`ðŸ“¸ Design-Upload fÃ¼r ${fieldId}:`, files.length, 'Dateien');

            // Initialize storage fÃ¼r dieses Feld
            if (!uploadedDesignFiles[fieldId]) {
                uploadedDesignFiles[fieldId] = [];
            }

            // Dateien verarbeiten
            for (const file of files) {
                // Validierung
                const maxSize = 10 * 1024 * 1024; // 10MB
                if (file.size > maxSize) {
                    showToast(`Datei "${file.name}" ist zu groÃŸ (max 10MB)`, 'warning');
                    continue;
                }

                // Base64 konvertieren fÃ¼r Preview und spÃ¤ter Upload
                const base64 = await fileToBase64(file);
                uploadedDesignFiles[fieldId].push({
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    base64: base64,
                    file: file // Original-File fÃ¼r spÃ¤teren Storage-Upload
                });
            }

            // Preview aktualisieren
            updateDesignPreview();

            // In kalkWizardData speichern (ohne Base64 fÃ¼r Firestore)
            if (!kalkWizardData.serviceDetails) {
                kalkWizardData.serviceDetails = {};
            }
            kalkWizardData.serviceDetails[fieldId] = uploadedDesignFiles[fieldId].map(f => ({
                name: f.name,
                type: f.type,
                size: f.size
            }));

            showToast(`${files.length} Design-Datei(en) hinzugefÃ¼gt`, 'success');
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function updateDesignPreview() {
            const previewContainer = document.getElementById('designUploadPreview');
            const previewGrid = document.getElementById('designPreviewGrid');

            if (!previewContainer || !previewGrid) return;

            // Alle Dateien sammeln
            let allFiles = [];
            for (const [fieldId, files] of Object.entries(uploadedDesignFiles)) {
                files.forEach((f, idx) => {
                    allFiles.push({ ...f, fieldId, index: idx });
                });
            }

            if (allFiles.length === 0) {
                previewContainer.style.display = 'none';
                return;
            }

            previewContainer.style.display = 'block';

            previewGrid.innerHTML = allFiles.map(file => {
                const isImage = file.type.startsWith('image/');
                return `
                    <div class="design-preview-item">
                        ${isImage
                            ? `<img src="${file.base64}" alt="${file.name}">`
                            : `<div class="design-preview-item__file-icon">${getFileIcon(file.type)}</div>`
                        }
                        <div class="design-preview-item__name">${file.name}</div>
                        <button class="design-preview-item__remove" onclick="removeDesignFile('${file.fieldId}', ${file.index})" title="Entfernen">Ã—</button>
                    </div>
                `;
            }).join('');
        }

        function getFileIcon(mimeType) {
            if (mimeType.includes('pdf')) return 'ðŸ“„';
            if (mimeType.includes('illustrator') || mimeType.includes('ai')) return 'ðŸŽ¨';
            if (mimeType.includes('photoshop') || mimeType.includes('psd')) return 'ðŸ–¼ï¸';
            if (mimeType.includes('svg')) return 'âœï¸';
            return 'ðŸ“';
        }

        function removeDesignFile(fieldId, index) {
            if (uploadedDesignFiles[fieldId]) {
                uploadedDesignFiles[fieldId].splice(index, 1);
                updateDesignPreview();

                // kalkWizardData aktualisieren
                if (kalkWizardData.serviceDetails) {
                    kalkWizardData.serviceDetails[fieldId] = uploadedDesignFiles[fieldId].map(f => ({
                        name: f.name,
                        type: f.type,
                        size: f.size
                    }));
                }
            }
        }

        // ============================================
        // ðŸ†• DESIGN-UPLOAD ZU FIREBASE STORAGE
        // ============================================
        async function uploadDesignFilesToStorage(targetId) {
            const designUrls = {};
            const storage = firebase.storage();
            const werkstattId = window.werkstattId || 'mosbach';

            for (const [fieldId, files] of Object.entries(uploadedDesignFiles)) {
                designUrls[fieldId] = [];

                for (let i = 0; i < files.length; i++) {
                    const fileData = files[i];

                    try {
                        // Datei aus Base64 in Blob konvertieren
                        const blob = await base64ToBlob(fileData.base64, fileData.type);

                        // Eindeutiger Pfad in Firebase Storage
                        const timestamp = Date.now();
                        const fileName = `${timestamp}_${fileData.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`;
                        const storagePath = `${werkstattId}/designs/${targetId}/${fieldId}/${fileName}`;

                        // Hochladen zu Firebase Storage
                        const storageRef = storage.ref(storagePath);
                        const uploadResult = await storageRef.put(blob);

                        // Download-URL abrufen
                        const downloadUrl = await uploadResult.ref.getDownloadURL();

                        console.log(`âœ… Design hochgeladen: ${fileName} â†’ ${downloadUrl}`);

                        designUrls[fieldId].push({
                            name: fileData.name,
                            type: fileData.type,
                            size: fileData.size,
                            url: downloadUrl,
                            storagePath: storagePath,
                            uploadedAt: new Date().toISOString()
                        });

                    } catch (error) {
                        console.error(`âŒ Fehler beim Hochladen von ${fileData.name}:`, error);
                        // Fallback: Base64-Bild direkt speichern (fÃ¼r kleine Bilder)
                        if (fileData.size < 1024 * 500) { // < 500KB
                            designUrls[fieldId].push({
                                name: fileData.name,
                                type: fileData.type,
                                size: fileData.size,
                                base64: fileData.base64, // Direkter Base64-Fallback
                                uploadedAt: new Date().toISOString()
                            });
                        }
                    }
                }
            }

            return designUrls;
        }

        // Helper: Base64 zu Blob konvertieren
        function base64ToBlob(base64, mimeType) {
            return new Promise((resolve, reject) => {
                try {
                    // Base64-PrÃ¤fix entfernen falls vorhanden
                    const base64Data = base64.includes(',') ? base64.split(',')[1] : base64;
                    const byteCharacters = atob(base64Data);
                    const byteNumbers = new Array(byteCharacters.length);

                    for (let i = 0; i < byteCharacters.length; i++) {
                        byteNumbers[i] = byteCharacters.charCodeAt(i);
                    }

                    const byteArray = new Uint8Array(byteNumbers);
                    const blob = new Blob([byteArray], { type: mimeType });
                    resolve(blob);
                } catch (error) {
                    reject(error);
                }
            });
        }

        // Validierung fÃ¼r Step 2b
        function validateStep2b() {
            const serviceArt = kalkWizardData.serviceArt;
            const config = SERVICE_CONFIG[serviceArt];

            if (!config || !config.zusatzfelder) return true;

            for (const [fieldId, fieldConfig] of Object.entries(config.zusatzfelder)) {
                if (fieldConfig.required) {
                    if (fieldConfig.typ === 'file') {
                        // FÃ¼r File-Felder: mindestens eine Datei muss hochgeladen sein
                        if (!uploadedDesignFiles[fieldId] || uploadedDesignFiles[fieldId].length === 0) {
                            showToast(`Bitte laden Sie mindestens eine Datei fÃ¼r "${fieldConfig.label}" hoch`, 'warning');
                            return false;
                        }
                    } else {
                        // FÃ¼r andere Felder: Wert muss vorhanden sein
                        const input = document.getElementById(`serviceField_${fieldId}`);
                        if (!input || !input.value) {
                            showToast(`Bitte fÃ¼llen Sie "${fieldConfig.label}" aus`, 'warning');
                            return false;
                        }
                    }
                }
            }
            return true;
        }

        // ðŸ†• Step 3 ZurÃ¼ck-Navigation (konditional zu 2b oder 2)
        function goToStep3Back() {
            const serviceArt = kalkWizardData.serviceArt;
            const config = SERVICE_CONFIG[serviceArt];

            // Check ob der Service zusatzfelder hat
            if (config && config.zusatzfelder && Object.keys(config.zusatzfelder).length > 0) {
                // ZurÃ¼ck zu Step 2b
                currentStep = '2b';
                renderServiceDetails(serviceArt, config.zusatzfelder);
                updateStepUI();
            } else {
                // ZurÃ¼ck zu Step 2
                goToStep(2);
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function validateStep(step) {
            switch(step) {
                case 1:
                    // Entwurf ODER Fahrzeug (Marke + Modell) muss gewÃ¤hlt sein
                    if (selectedEntwurf) {
                        return true; // Entwurf gewÃ¤hlt = OK
                    }
                    if (kalkWizardData.fahrzeug?.marke && kalkWizardData.fahrzeug?.modell) {
                        return true; // Fahrzeug aus DB gewÃ¤hlt = OK
                    }
                    const markeEl = document.getElementById('kalkMarke');
                    const modellEl = document.getElementById('kalkModell');
                    const marke = markeEl?.value || '';
                    const modell = modellEl?.value || '';
                    if (!marke || !modell) {
                        showToast('Bitte wÃ¤hlen Sie einen Entwurf oder ein Fahrzeug', 'warning');
                        return false;
                    }
                    return true;

                case 2:
                    // NEU: Service-Art muss gewÃ¤hlt sein
                    if (!kalkWizardData.serviceArt) {
                        showToast('Bitte wÃ¤hlen Sie eine Service-Art', 'warning');
                        return false;
                    }
                    return true;

                case '2b':
                    // ðŸ†• Validierung fÃ¼r Step 2b (Service-Details)
                    return validateStep2b();

                case 3:
                    // ðŸ†• Nov 30, 2025: Multi-Service Support
                    // Teil muss ausgewÃ¤hlt sein (aus teilePerService ODER altes System)
                    let totalPartsSelected = 0;

                    // Neue Multi-Service Teile zÃ¤hlen
                    if (kalkWizardData.teilePerService) {
                        for (const service of Object.keys(kalkWizardData.teilePerService)) {
                            totalPartsSelected += kalkWizardData.teilePerService[service].length;
                        }
                    }

                    // Fallback: Altes System (currentPart oder teile Array)
                    if (totalPartsSelected === 0 && !kalkWizardData.currentPart && kalkWizardData.teile.length === 0) {
                        showToast('Bitte wÃ¤hlen Sie mindestens ein Teil aus', 'warning');
                        return false;
                    }

                    // ðŸ†• teilePerService in kalkWizardData.teile zusammenfÃ¼hren fÃ¼r Step 4/5
                    mergeTeilePerServiceIntoTeile();

                    return true;

                case 4:
                    // ðŸ†• Nov 30, 2025: Multi-Service - Arbeiten fÃ¼r aktuelles Teil speichern
                    saveCurrentPartArbeiten();

                    // PrÃ¼fen ob alle Teile mindestens eine Arbeit haben
                    const teile = kalkWizardData.teile || [];

                    // Wenn es Teile gibt
                    if (teile.length > 0) {
                        // PrÃ¼fe ob alle Teile Arbeiten haben
                        const teileOhneArbeiten = teile.filter(t => !t.arbeiten || t.arbeiten.length === 0);

                        if (teileOhneArbeiten.length > 0) {
                            // Finde das erste Teil ohne Arbeiten und wechsle dorthin
                            const firstMissingIndex = teile.findIndex(t => !t.arbeiten || t.arbeiten.length === 0);
                            if (firstMissingIndex !== kalkWizardData.step4ActivePartIndex) {
                                switchStep4Part(firstMissingIndex);
                            }
                            showToast(`Bitte wÃ¤hlen Sie Arbeiten fÃ¼r "${teileOhneArbeiten[0].teil}" aus`, 'warning');
                            return false;
                        }
                        return true;
                    }

                    // Fallback: Kein Teil vorhanden
                    showToast('Bitte wÃ¤hlen Sie mindestens ein Teil in Schritt 3', 'warning');
                    return false;

                default:
                    return true;
            }
        }

        function updateStepUI() {
            // Step-Indikatoren aktualisieren
            document.querySelectorAll('.kalk-step').forEach((step, index) => {
                const stepNum = index + 1;
                step.classList.remove('active', 'completed');
                if (stepNum === currentStep) {
                    step.classList.add('active');
                } else if (stepNum < currentStep) {
                    step.classList.add('completed');
                }
            });

            // Step-Content aktualisieren (inkl. Step 2b Handling)
            document.querySelectorAll('.kalk-step-content').forEach((content) => {
                content.classList.remove('active');
            });

            // Spezielles Handling fÃ¼r Step 2b
            if (currentStep === '2b') {
                const step2bContent = document.getElementById('stepContent2b');
                if (step2bContent) {
                    step2bContent.style.display = 'block';
                    step2bContent.classList.add('active');
                }
            } else {
                // Step 2b ausblenden wenn nicht aktiv
                const step2bContent = document.getElementById('stepContent2b');
                if (step2bContent) step2bContent.style.display = 'none';

                // Normales Step-Content aktivieren
                const stepContent = document.getElementById(`stepContent${currentStep}`);
                if (stepContent) stepContent.classList.add('active');
            }

            // Step-spezifische Updates
            switch(currentStep) {
                case 2:
                    // ðŸ†• Nov 30, 2025: Auftragsinfo in Step 2 anzeigen
                    renderAuftragsInfoStep2();
                    break;

                case '2b':
                    // ðŸ†• Nov 30, 2025: Auftragsinfo in Step 2b anzeigen
                    renderAuftragsInfoStep2b();
                    // ðŸ†• Nov 30, 2025: Fotos aus Entwurf auch in Step 2b anzeigen
                    renderEntwurfPhotos();
                    break;

                case 3:
                    // ðŸ†• Auftragsinfo anzeigen (alle Infos aus Entwurf/Partner-Anfrage)
                    renderAuftragsInfo();
                    // ðŸ†• Fotos aus Entwurf anzeigen
                    renderEntwurfPhotos();
                    // ðŸ†• Multi-Service Tabs rendern (Nov 30, 2025)
                    renderStep3ServiceTabs();
                    break;

                case 4:
                    // ðŸ†• Nov 30, 2025: Auftragsinfo in Step 4 anzeigen
                    renderAuftragsInfoStep4();
                    // Multi-Service Teile-Tabs rendern
                    renderStep4PartsTabs();
                    // Service-Name anzeigen
                    const step4ServiceName = document.getElementById('step4ServiceName');
                    if (step4ServiceName && kalkWizardData.serviceArt) {
                        step4ServiceName.textContent = SERVICE_LABELS[kalkWizardData.serviceArt] || kalkWizardData.serviceArt;
                    }
                    // Dynamische Arbeiten fÃ¼r den gewÃ¤hlten Service laden
                    renderServiceRepairOptions();
                    // Button-Status aktualisieren (aktivieren wenn schon Teile vorhanden)
                    updateRepairSelection();
                    break;

                case 5:
                    // ðŸ†• Nov 30, 2025: Auftragsinfo in Step 5 anzeigen
                    renderAuftragsInfoStep5();
                    // Step 5: Ersatzteile-Ãœbersicht
                    updateStep5Ersatzteile();
                    updateKIErsatzteilKontext(); // KI-Suche Kontext aktualisieren
                    break;

                case 6:
                    // ðŸ†• Nov 30, 2025: Auftragsinfo in Step 6 anzeigen
                    renderAuftragsInfoStep6();
                    // Step 6: Zusammenfassung & Kalkulation
                    updateStep6Summary();
                    break;
            }

            feather.replace();
        }

        function selectVehiclePartNew(partName, element) {
            // Vorherige Auswahl entfernen
            document.querySelectorAll('.vehicle-part.selected').forEach(p => {
                p.classList.remove('selected');
            });

            // Neue Auswahl markieren
            if (element) element.classList.add('selected');
            kalkWizardData.currentPart = partName;

            // Anzeige aktualisieren
            const display = document.getElementById('selectedPartDisplay');
            const nameSpan = document.getElementById('selectedPartName');
            if (display && nameSpan) {
                display.style.display = 'flex';
                nameSpan.textContent = partName;
            }

            // Weiter-Button aktivieren (Step 3 = Teil wÃ¤hlen)
            const nextBtn = document.getElementById('btnStep3Next');
            if (nextBtn) nextBtn.disabled = false;

            feather.replace();
        }

        function clearSelectedPart() {
            kalkWizardData.currentPart = null;

            // Markierung entfernen
            document.querySelectorAll('.vehicle-part.selected').forEach(p => {
                p.classList.remove('selected');
            });

            // Anzeige verstecken
            const display = document.getElementById('selectedPartDisplay');
            if (display) display.style.display = 'none';

            // Weiter-Button deaktivieren (wenn keine Teile in Liste)
            if (kalkWizardData.teile.length === 0) {
                const nextBtn = document.getElementById('btnStep3Next');
                if (nextBtn) nextBtn.disabled = true;
            }
        }

        // NEU: Service-Art Auswahl aktualisieren (Step 2)
        function updateServiceSelection() {
            const selectedService = document.querySelector('input[name="serviceArt"]:checked');
            const nextBtn = document.getElementById('btnStep2Next');

            if (selectedService) {
                kalkWizardData.serviceArt = selectedService.value;
                if (nextBtn) nextBtn.disabled = false;

                // Visuelles Feedback
                console.log('ðŸ“‹ Service gewÃ¤hlt:', SERVICE_LABELS[selectedService.value] || selectedService.value);
            } else {
                kalkWizardData.serviceArt = '';
                if (nextBtn) nextBtn.disabled = true;
            }
        }

        function updateRepairSelection() {
            const checkedRepairs = document.querySelectorAll('input[name="repair"]:checked');
            const nextBtn = document.getElementById('btnStep4Next');
            if (nextBtn) {
                // Button aktivieren wenn: Reparaturen gewÃ¤hlt ODER bereits Teile in Liste
                const hasRepairs = checkedRepairs.length > 0;
                const hasExistingParts = kalkWizardData.teile.length > 0;
                nextBtn.disabled = !hasRepairs && !hasExistingParts;
            }

            // NEU: Ersatzteil-Formular wird NICHT mehr in Schritt 4 angezeigt
            // Die Ersatzteil-Suche erfolgt in Schritt 5 (KI-Suche oder manuell)
            // Hier nur Info anzeigen, dass Ersatzteil in Schritt 5 gesucht wird
            const ersatzteilForm = document.getElementById('ersatzteilInlineForm');
            const ersatzteilHinweis = document.getElementById('ersatzteilHinweis');

            const needsErsatzteil = Array.from(checkedRepairs).some(cb =>
                ['austauschen', 'ersetzen', 'wechseln'].includes(cb.value.toLowerCase())
            );

            // Formular verstecken (wird in Schritt 5 erledigt)
            if (ersatzteilForm) {
                ersatzteilForm.style.display = 'none';
            }

            // Hinweis anzeigen wenn Ersatzteil benÃ¶tigt wird
            if (ersatzteilHinweis) {
                ersatzteilHinweis.style.display = needsErsatzteil ? 'block' : 'none';
            } else if (needsErsatzteil) {
                // Hinweis dynamisch erstellen falls nicht vorhanden
                const hinweisDiv = document.createElement('div');
                hinweisDiv.id = 'ersatzteilHinweis';
                hinweisDiv.className = 'ersatzteil-hinweis';
                hinweisDiv.innerHTML = `
                    <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); padding: var(--space-3); border-radius: var(--radius-card); margin-top: var(--space-3); border-left: 4px solid #f59e0b;">
                        <p style="margin: 0; color: #92400e; font-weight: 500;">
                            <span style="font-size: 1.2em;">ðŸ”</span>
                            <strong>Ersatzteil wird in Schritt 5 gesucht</strong>
                        </p>
                        <p style="margin: var(--space-1) 0 0 0; font-size: var(--font-size-sm); color: #78350f;">
                            Die KI sucht automatisch nach dem besten Angebot fÃ¼r "${kalkWizardData.currentPart}" oder Sie kÃ¶nnen manuell suchen.
                        </p>
                    </div>
                `;
                const repairGrid = document.getElementById('repairOptionsGrid');
                if (repairGrid) {
                    repairGrid.parentNode.insertBefore(hinweisDiv, repairGrid.nextSibling);
                }
            }
        }

        function addCurrentPartAndGoBack() {
            // Aktuelle Reparaturen sammeln
            const repairs = Array.from(document.querySelectorAll('input[name="repair"]:checked'))
                .map(cb => cb.value);

            if (repairs.length === 0) {
                showToast('Bitte wÃ¤hlen Sie mindestens eine Reparaturart', 'warning');
                return;
            }

            // NEU: PrÃ¼fen ob Ersatzteil benÃ¶tigt wird (wird in Schritt 5 gesucht)
            const needsErsatzteil = repairs.some(r => ['austauschen', 'ersetzen', 'wechseln'].includes(r.toLowerCase()));

            // Teil zur Liste hinzufÃ¼gen
            // ersatzteil ist erstmal null - wird in Schritt 5 ausgefÃ¼llt
            kalkWizardData.teile.push({
                teil: kalkWizardData.currentPart,
                reparaturen: repairs,
                ersatzteil: null,  // Wird in Schritt 5 per KI-Suche oder manuell gesetzt
                needsErsatzteil: needsErsatzteil  // Flag fÃ¼r Schritt 5
            });

            console.log('ðŸ“¦ Teil hinzugefÃ¼gt:', kalkWizardData.currentPart, 'Reparaturen:', repairs, 'Braucht Ersatzteil:', needsErsatzteil);

            // Formularfelder zurÃ¼cksetzen
            document.querySelectorAll('input[name="repair"]').forEach(cb => cb.checked = false);

            // Ersatzteil-Hinweis entfernen falls vorhanden
            const hinweis = document.getElementById('ersatzteilHinweis');
            if (hinweis) hinweis.remove();

            // CurrentPart zurÃ¼cksetzen
            kalkWizardData.currentPart = null;

            showToast(`${kalkWizardData.teile[kalkWizardData.teile.length - 1].teil} hinzugefÃ¼gt`, 'success');

            // ZurÃ¼ck zu Step 3 (Teil wÃ¤hlen)
            goToStep(3);

            // Parts-Liste aktualisieren
            updatePartsListDisplay();
        }

        // NEU: Speichert aktuelles Teil und geht zu Schritt 5
        function saveCurrentPartAndGoToStep5() {
            // Aktuelle Reparaturen sammeln
            const repairs = Array.from(document.querySelectorAll('input[name="repair"]:checked'))
                .map(cb => cb.value);

            const currentPart = kalkWizardData.currentPart;

            // Fall 1: Aktuelles Teil wird bearbeitet â†’ speichern wenn Reparaturen gewÃ¤hlt
            if (currentPart && repairs.length > 0) {
                // PrÃ¼fen ob dieses Teil schon in der Liste ist
                const alreadyExists = kalkWizardData.teile.some(t => t.teil === currentPart);

                if (!alreadyExists) {
                    // PrÃ¼fen ob Ersatzteil benÃ¶tigt wird
                    const needsErsatzteil = repairs.some(r => ['austauschen', 'ersetzen', 'wechseln'].includes(r.toLowerCase()));

                    // Teil zur Liste hinzufÃ¼gen
                    kalkWizardData.teile.push({
                        teil: currentPart,
                        reparaturen: repairs,
                        ersatzteil: null,
                        needsErsatzteil: needsErsatzteil
                    });

                    console.log('ðŸ“¦ Teil automatisch hinzugefÃ¼gt:', currentPart, 'Reparaturen:', repairs, 'Braucht Ersatzteil:', needsErsatzteil);
                    showToast(`${currentPart} hinzugefÃ¼gt`, 'success');
                }

                // Formularfelder zurÃ¼cksetzen
                document.querySelectorAll('input[name="repair"]').forEach(cb => cb.checked = false);
                kalkWizardData.currentPart = null;

                // Ersatzteil-Hinweis entfernen
                const hinweis = document.getElementById('ersatzteilHinweis');
                if (hinweis) hinweis.remove();
            }

            // Fall 2: Kein aktuelles Teil aber Teile in Liste â†’ direkt weiter
            else if (kalkWizardData.teile.length > 0) {
                console.log('ðŸ“‹ Bereits Teile vorhanden, gehe direkt zu Schritt 5');
            }

            // Fall 3: Weder aktuelles Teil noch Teile in Liste â†’ Fehler
            else {
                showToast('Bitte wÃ¤hlen Sie mindestens ein Teil und eine Reparaturart', 'warning');
                return;
            }

            // Zu Schritt 5 gehen
            console.log('ðŸ“‹ Gehe zu Schritt 5 mit Teilen:', kalkWizardData.teile);
            goToStep(5);
        }

        function updatePartsListDisplay() {
            const listContainer = document.getElementById('selectedPartsList');
            const listContent = document.getElementById('partsListContent');

            if (kalkWizardData.teile.length > 0 && listContainer && listContent) {
                listContainer.style.display = 'block';
                listContent.innerHTML = kalkWizardData.teile.map((item, index) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-2); background: var(--color-background); border-radius: var(--radius-button); margin-bottom: var(--space-2);">
                        <div>
                            <strong>${item.teil}</strong>
                            <span style="font-size: var(--font-size-xs); color: var(--color-text-secondary); display: block;">
                                ${item.reparaturen.join(', ')}
                            </span>
                        </div>
                        <button class="btn btn-sm btn-error" onclick="removePartFromList(${index})">
                            <i data-feather="trash-2"></i>
                        </button>
                    </div>
                `).join('');
                feather.replace();

                // Weiter-Button aktivieren (Step 3 = Teil wÃ¤hlen)
                const nextBtn = document.getElementById('btnStep3Next');
                if (nextBtn) nextBtn.disabled = false;
            } else if (listContainer) {
                listContainer.style.display = 'none';
            }
        }

        function removePartFromList(index) {
            kalkWizardData.teile.splice(index, 1);
            updatePartsListDisplay();

            if (kalkWizardData.teile.length === 0 && !kalkWizardData.currentPart) {
                const nextBtn = document.getElementById('btnStep3Next');
                if (nextBtn) nextBtn.disabled = true;
            }
        }

        // ============================================
        // ðŸ”§ ERSATZTEILE FUNKTIONEN
        // ============================================

        // Ersatzteile aus Firestore laden (fÃ¼r Autocomplete)
        async function loadErsatzteileDB() {
            try {
                await window.firebaseInitialized;
                const werkstattId = window.werkstattId;
                if (!werkstattId) return;
                if (!window.getCollection) {
                    console.warn('â³ loadErsatzteileDB: getCollection nicht verfÃ¼gbar');
                    return;
                }

                const snapshot = await window.getCollection('ersatzteile')
                    .orderBy('verwendetAnzahl', 'desc')
                    .limit(200)
                    .get();

                ersatzteileDB = [];
                snapshot.forEach(doc => {
                    ersatzteileDB.push({ id: doc.id, ...doc.data() });
                });

                console.log(`ðŸ“¦ ${ersatzteileDB.length} Ersatzteile aus DB geladen`);
            } catch (error) {
                console.warn('Ersatzteile-DB konnte nicht geladen werden:', error);
            }
        }

        // Ersatzteil in Firestore speichern (mit Preis-Historie & Fahrzeug-VerknÃ¼pfung)
        async function saveErsatzteilToDB(ersatzteil) {
            try {
                await window.firebaseInitialized;
                const werkstattId = window.werkstattId;
                if (!werkstattId || !ersatzteil.name) return;
                if (!window.getCollection) {
                    console.warn('â³ saveErsatzteilToDB: getCollection nicht verfÃ¼gbar');
                    return;
                }

                // Fahrzeug-Info aus aktuellem Wizard
                const fahrzeugMarke = kalkWizardData.fahrzeug?.marke || '';
                const fahrzeugModell = kalkWizardData.fahrzeug?.modell || '';

                // PrÃ¼fen ob Ersatzteil schon existiert (nach Name + Teilenummer)
                const existing = await window.getCollection('ersatzteile')
                    .where('name', '==', ersatzteil.name)
                    .where('teilenummer', '==', ersatzteil.teilenummer || '')
                    .limit(1)
                    .get();

                if (!existing.empty) {
                    // Existiert bereits - Preis-Historie aktualisieren
                    const docRef = existing.docs[0].ref;
                    const existingData = existing.docs[0].data();

                    // Preis-Historie Array (max. 10 EintrÃ¤ge)
                    let preisHistorie = existingData.preisHistorie || [];
                    if (ersatzteil.preis && ersatzteil.preis > 0) {
                        preisHistorie.push({
                            preis: ersatzteil.preis,
                            datum: new Date().toISOString(),
                            lieferant: ersatzteil.lieferant || ''
                        });
                        // Nur letzte 10 behalten
                        if (preisHistorie.length > 10) {
                            preisHistorie = preisHistorie.slice(-10);
                        }
                    }

                    // Fahrzeuge Array erweitern
                    let fahrzeuge = existingData.fahrzeuge || [];
                    if (fahrzeugMarke && fahrzeugModell) {
                        const fahrzeugKey = `${fahrzeugMarke}|${fahrzeugModell}`;
                        if (!fahrzeuge.includes(fahrzeugKey)) {
                            fahrzeuge.push(fahrzeugKey);
                        }
                    }

                    // Lieferanten Array erweitern
                    let lieferanten = existingData.lieferanten || [];
                    if (ersatzteil.lieferant && !lieferanten.find(l => l.name === ersatzteil.lieferant)) {
                        lieferanten.push({
                            name: ersatzteil.lieferant,
                            preis: ersatzteil.preis || 0,
                            datum: new Date().toISOString()
                        });
                    } else if (ersatzteil.lieferant) {
                        // Preis aktualisieren fÃ¼r existierenden Lieferanten
                        const lIdx = lieferanten.findIndex(l => l.name === ersatzteil.lieferant);
                        if (lIdx >= 0 && ersatzteil.preis) {
                            lieferanten[lIdx].preis = ersatzteil.preis;
                            lieferanten[lIdx].datum = new Date().toISOString();
                        }
                    }

                    // Durchschnittspreis berechnen
                    const allePreise = preisHistorie.map(p => p.preis).filter(p => p > 0);
                    const durchschnittsPreis = allePreise.length > 0
                        ? allePreise.reduce((a, b) => a + b, 0) / allePreise.length
                        : ersatzteil.preis || 0;

                    await docRef.update({
                        verwendetAnzahl: firebase.firestore.FieldValue.increment(1),
                        letzteVerwendung: firebase.firestore.FieldValue.serverTimestamp(),
                        preis: ersatzteil.preis || existingData.preis,
                        preisHistorie: preisHistorie,
                        durchschnittsPreis: durchschnittsPreis,
                        fahrzeuge: fahrzeuge,
                        lieferanten: lieferanten
                    });
                    console.log('ðŸ“¦ Ersatzteil aktualisiert:', ersatzteil.name, '| Ã˜-Preis:', durchschnittsPreis.toFixed(2));
                } else {
                    // Neues Ersatzteil anlegen
                    const neuesErsatzteil = {
                        name: ersatzteil.name,
                        teilenummer: ersatzteil.teilenummer || '',
                        preis: ersatzteil.preis || 0,
                        durchschnittsPreis: ersatzteil.preis || 0,
                        preisHistorie: ersatzteil.preis ? [{
                            preis: ersatzteil.preis,
                            datum: new Date().toISOString(),
                            lieferant: ersatzteil.lieferant || ''
                        }] : [],
                        lieferant: ersatzteil.lieferant || '',
                        lieferanten: ersatzteil.lieferant ? [{
                            name: ersatzteil.lieferant,
                            preis: ersatzteil.preis || 0,
                            datum: new Date().toISOString()
                        }] : [],
                        kategorie: ersatzteil.zuTeil || '',
                        fahrzeuge: (fahrzeugMarke && fahrzeugModell) ? [`${fahrzeugMarke}|${fahrzeugModell}`] : [],
                        verwendetAnzahl: 1,
                        erstelltAm: firebase.firestore.FieldValue.serverTimestamp(),
                        letzteVerwendung: firebase.firestore.FieldValue.serverTimestamp(),
                        werkstattId: werkstattId
                    };

                    await window.getCollection('ersatzteile').add(neuesErsatzteil);
                    console.log('ðŸ“¦ Neues Ersatzteil gespeichert:', ersatzteil.name);

                    // Lokale DB aktualisieren
                    ersatzteileDB.push({ ...neuesErsatzteil, id: 'new-' + Date.now() });
                }
            } catch (error) {
                console.error('Fehler beim Speichern des Ersatzteils:', error);
            }
        }

        // Autocomplete-Suche in Step 4 (Inline) - mit Fahrzeug-Priorisierung
        function searchErsatzteileDB(query) {
            const autocomplete = document.getElementById('ersatzteilAutocomplete');
            if (!autocomplete || !query || query.length < 2) {
                if (autocomplete) autocomplete.style.display = 'none';
                return;
            }

            const queryLower = query.toLowerCase();
            const fahrzeugKey = kalkWizardData.fahrzeug?.marke && kalkWizardData.fahrzeug?.modell
                ? `${kalkWizardData.fahrzeug.marke}|${kalkWizardData.fahrzeug.modell}`
                : null;

            // Filtern und sortieren (Fahrzeug-Match zuerst, dann nach Verwendung)
            let matches = ersatzteileDB.filter(e =>
                e.name?.toLowerCase().includes(queryLower) ||
                e.teilenummer?.toLowerCase().includes(queryLower)
            );

            // Fahrzeug-spezifische Teile nach oben sortieren
            if (fahrzeugKey) {
                matches.sort((a, b) => {
                    const aMatch = a.fahrzeuge?.includes(fahrzeugKey) ? 1 : 0;
                    const bMatch = b.fahrzeuge?.includes(fahrzeugKey) ? 1 : 0;
                    if (aMatch !== bMatch) return bMatch - aMatch;
                    return (b.verwendetAnzahl || 0) - (a.verwendetAnzahl || 0);
                });
            }

            matches = matches.slice(0, 10);

            if (matches.length === 0) {
                autocomplete.style.display = 'none';
                return;
            }

            autocomplete.innerHTML = matches.map(e => {
                const isVehicleMatch = fahrzeugKey && e.fahrzeuge?.includes(fahrzeugKey);
                const preisTrend = getPreisTrend(e);
                const avgPreis = e.durchschnittsPreis || e.preis || 0;

                return `
                    <div class="ersatzteil-autocomplete-item ${isVehicleMatch ? 'vehicle-match' : ''}" onclick="selectErsatzteilFromDB('${e.id}', 'inline')">
                        <div class="ersatzteil-autocomplete-item__name">
                            ${isVehicleMatch ? '<span class="vehicle-badge">ðŸš—</span>' : ''}
                            ${e.name}
                        </div>
                        <div class="ersatzteil-autocomplete-item__details">
                            ${e.teilenummer ? `Nr: ${e.teilenummer}` : ''}
                            ${avgPreis > 0 ? `| Ã˜ ${avgPreis.toFixed(2)} â‚¬ ${preisTrend}` : ''}
                            ${e.lieferanten?.length > 1 ? `| ${e.lieferanten.length} Lieferanten` : (e.lieferant ? `| ${e.lieferant}` : '')}
                        </div>
                    </div>
                `;
            }).join('');
            autocomplete.style.display = 'block';
        }

        // Preis-Trend berechnen (â†‘â†“â†’)
        function getPreisTrend(ersatzteil) {
            if (!ersatzteil.preisHistorie || ersatzteil.preisHistorie.length < 2) return '';
            const preise = ersatzteil.preisHistorie.map(p => p.preis);
            const letzter = preise[preise.length - 1];
            const vorletzter = preise[preise.length - 2];
            const diff = ((letzter - vorletzter) / vorletzter) * 100;

            if (diff > 5) return '<span style="color: #ef4444;">â†‘</span>';
            if (diff < -5) return '<span style="color: #22c55e;">â†“</span>';
            return '<span style="color: #6b7280;">â†’</span>';
        }

        // Autocomplete-Suche in Step 5 - mit Fahrzeug-Priorisierung
        function searchErsatzteileDBStep5(query) {
            const autocomplete = document.getElementById('ersatzteilAutocompleteStep5');
            if (!autocomplete || !query || query.length < 2) {
                if (autocomplete) autocomplete.style.display = 'none';
                return;
            }

            const queryLower = query.toLowerCase();
            const fahrzeugKey = kalkWizardData.fahrzeug?.marke && kalkWizardData.fahrzeug?.modell
                ? `${kalkWizardData.fahrzeug.marke}|${kalkWizardData.fahrzeug.modell}`
                : null;

            let matches = ersatzteileDB.filter(e =>
                e.name?.toLowerCase().includes(queryLower) ||
                e.teilenummer?.toLowerCase().includes(queryLower)
            );

            // Fahrzeug-spezifische Teile nach oben sortieren
            if (fahrzeugKey) {
                matches.sort((a, b) => {
                    const aMatch = a.fahrzeuge?.includes(fahrzeugKey) ? 1 : 0;
                    const bMatch = b.fahrzeuge?.includes(fahrzeugKey) ? 1 : 0;
                    if (aMatch !== bMatch) return bMatch - aMatch;
                    return (b.verwendetAnzahl || 0) - (a.verwendetAnzahl || 0);
                });
            }

            matches = matches.slice(0, 10);

            if (matches.length === 0) {
                autocomplete.style.display = 'none';
                return;
            }

            autocomplete.innerHTML = matches.map(e => {
                const isVehicleMatch = fahrzeugKey && e.fahrzeuge?.includes(fahrzeugKey);
                const preisTrend = getPreisTrend(e);
                const avgPreis = e.durchschnittsPreis ? `Ã˜ ${e.durchschnittsPreis.toFixed(2)} â‚¬` : '';
                const lieferantenCount = e.lieferanten?.length || 0;

                return `
                <div class="ersatzteil-autocomplete-item ${isVehicleMatch ? 'vehicle-match' : ''}" onclick="selectErsatzteilFromDB('${e.id}', 'step5')">
                    <div class="ersatzteil-autocomplete-item__name">
                        ${isVehicleMatch ? '<span class="vehicle-badge">ðŸš—</span>' : ''}
                        ${e.name}
                        ${preisTrend}
                    </div>
                    <div class="ersatzteil-autocomplete-item__details">
                        ${e.teilenummer ? `Nr: ${e.teilenummer}` : ''}
                        ${e.preis ? `| ${e.preis.toFixed(2)} â‚¬` : ''}
                        ${avgPreis ? `| ${avgPreis}` : ''}
                        ${lieferantenCount > 1 ? `| ${lieferantenCount} Lieferanten` : (e.lieferant ? `| ${e.lieferant}` : '')}
                    </div>
                </div>
            `}).join('');
            autocomplete.style.display = 'block';
        }

        // Ersatzteil aus Autocomplete auswÃ¤hlen
        function selectErsatzteilFromDB(id, target) {
            const ersatzteil = ersatzteileDB.find(e => e.id === id);
            if (!ersatzteil) return;

            if (target === 'inline') {
                const inlineName = document.getElementById('ersatzteilInlineName');
                const inlineTeilenr = document.getElementById('ersatzteilInlineTeilenr');
                const inlinePreis = document.getElementById('ersatzteilInlinePreis');
                const inlineLieferant = document.getElementById('ersatzteilInlineLieferant');
                const autocomplete = document.getElementById('ersatzteilAutocomplete');
                if (inlineName) inlineName.value = ersatzteil.name || '';
                if (inlineTeilenr) inlineTeilenr.value = ersatzteil.teilenummer || '';
                if (inlinePreis) inlinePreis.value = ersatzteil.preis || '';
                if (inlineLieferant) inlineLieferant.value = ersatzteil.lieferant || '';
                if (autocomplete) autocomplete.style.display = 'none';
            } else if (target === 'step5') {
                const addName = document.getElementById('ersatzteilAddName');
                const addTeilenr = document.getElementById('ersatzteilAddTeilenr');
                const addPreis = document.getElementById('ersatzteilAddPreis');
                const addLieferant = document.getElementById('ersatzteilAddLieferant');
                const autocomplete5 = document.getElementById('ersatzteilAutocompleteStep5');
                if (addName) addName.value = ersatzteil.name || '';
                if (addTeilenr) addTeilenr.value = ersatzteil.teilenummer || '';
                if (addPreis) addPreis.value = ersatzteil.preis || '';
                if (addLieferant) addLieferant.value = ersatzteil.lieferant || '';
                if (autocomplete5) autocomplete5.style.display = 'none';
            }
        }

        // ============================================
        // ðŸ†• KI-GESTÃœTZTE ERSATZTEILSUCHE
        // ============================================

        let kiErsatzteileAngebote = []; // Alle gefundenen Angebote
        let selectedKIErsatzteile = new Set(); // AusgewÃ¤hlte Angebot-IDs

        // Kontext fÃ¼r Ersatzteilsuche aktualisieren (wird beim Laden von Step 5 aufgerufen)
        function updateKIErsatzteilKontext() {
            // Fahrzeug-Info - KORREKTE Feldnamen aus kalkWizardData.fahrzeug
            const fahrzeugEl = document.getElementById('kiKontextFahrzeug');
            if (fahrzeugEl) {
                const marke = kalkWizardData.fahrzeug?.marke || '';
                const modell = kalkWizardData.fahrzeug?.modell || '';
                const baujahr = kalkWizardData.fahrzeug?.baujahr || '';
                const kennzeichen = kalkWizardData.fahrzeug?.kennzeichen || '';
                let fahrzeugText = `${marke} ${modell}`.trim();
                if (baujahr) fahrzeugText += ` (${baujahr})`;
                if (kennzeichen) fahrzeugText += ` - ${kennzeichen}`;
                fahrzeugEl.textContent = fahrzeugText || '-';
                console.log('ðŸš— KI-Kontext Fahrzeug:', fahrzeugText);
            }

            // Teile-Info - KORREKTE Feldnamen: teil (nicht name), reparaturen (nicht arbeiten)
            const teileEl = document.getElementById('kiKontextTeile');
            if (teileEl) {
                const teileZuErsetzen = (kalkWizardData.teile || []).filter(t => {
                    const reparaturen = t.reparaturen || t.arbeiten || [];
                    return t.needsErsatzteil ||
                        reparaturen.includes('ersetzen') ||
                        reparaturen.includes('austauschen') ||
                        reparaturen.includes('wechseln');
                }).map(t => t.teil || t.name);

                teileEl.textContent = teileZuErsetzen.length > 0 ? teileZuErsetzen.join(', ') : 'Keine Ersatzteile benÃ¶tigt';
                console.log('ðŸ“¦ KI-Kontext Teile:', teileZuErsetzen);
            }

            console.log('ðŸ“‹ kalkWizardData.teile:', kalkWizardData.teile);
            console.log('ðŸ“‹ kalkWizardData.fahrzeug:', kalkWizardData.fahrzeug);
        }

        // KI-Ersatzteilsuche starten
        async function startKIErsatzteilSuche() {
            const btn = document.getElementById('btnStartKISuche');
            const loading = document.getElementById('kiErsatzteileLoading');
            const results = document.getElementById('kiErsatzteileResults');
            const statusText = document.getElementById('kiLoadingStatus');

            // Teile ermitteln die ersetzt werden mÃ¼ssen
            // Hinweis: teile kÃ¶nnen verschiedene Strukturen haben:
            // - Von Step 3/4: { teil: "Name", reparaturen: ["ersetzen", ...], needsErsatzteil: true }
            // - Von KI-Analyse: { name: "Name", arbeiten: ["ersetzen", ...] }
            const teileZuErsetzen = [];

            (kalkWizardData.teile || []).forEach(t => {
                // Teil-Name kann in 'teil' oder 'name' sein
                const teilName = t.teil || t.name;
                // Reparaturen kÃ¶nnen in 'reparaturen' oder 'arbeiten' sein
                const reparaturen = t.reparaturen || t.arbeiten || [];

                // PrÃ¼fen ob ersetzt werden soll (3 Wege)
                const sollErsetzen = t.needsErsatzteil ||  // NEU: Flag aus Schritt 4
                    reparaturen.includes('ersetzen') ||
                    reparaturen.includes('austauschen') ||
                    reparaturen.includes('wechseln');

                if (sollErsetzen && teilName && !teileZuErsetzen.includes(teilName)) {
                    teileZuErsetzen.push(teilName);
                    console.log('ðŸ“¦ Teil zum Ersetzen gefunden:', teilName, 'Reparaturen:', reparaturen, 'Flag:', t.needsErsatzteil);
                }
            });

            // Auch aus KI-Analyse Ã¼bernommene Teile
            if (kiErkannteSchaeden && kiErkannteSchaeden.length > 0) {
                kiErkannteSchaeden.forEach(s => {
                    if (s.selected && (s.empfohleneArbeiten?.includes('ersetzen') || s.empfohleneArbeiten?.includes('austauschen'))) {
                        if (!teileZuErsetzen.includes(s.teil)) {
                            teileZuErsetzen.push(s.teil);
                            console.log('ðŸ“¦ KI-Teil zum Ersetzen:', s.teil);
                        }
                    }
                });
            }

            console.log('ðŸ” Gesamt Teile zum Ersetzen:', teileZuErsetzen);
            console.log('ðŸ“‹ kalkWizardData.teile:', kalkWizardData.teile);

            if (teileZuErsetzen.length === 0) {
                showToast('Keine Ersatzteile zum Suchen gefunden. Bitte "ersetzen" oder "austauschen" in Schritt 4 auswÃ¤hlen.', 'warning');
                return;
            }

            // UI Update
            if (btn) btn.disabled = true;
            if (loading) loading.style.display = 'flex';
            if (results) results.style.display = 'none';

            // KORREKTE Feldnamen aus kalkWizardData.fahrzeug
            const fahrzeug = {
                marke: kalkWizardData.fahrzeug?.marke || '',
                modell: kalkWizardData.fahrzeug?.modell || '',
                baujahr: kalkWizardData.fahrzeug?.baujahr || '',
                kennzeichen: kalkWizardData.fahrzeug?.kennzeichen || ''
            };

            console.log('ðŸš— Fahrzeug fÃ¼r KI-Suche:', fahrzeug);

            console.log('ðŸ” Starte KI-Ersatzteilsuche fÃ¼r:', teileZuErsetzen);

            try {
                kiErsatzteileAngebote = [];

                // FÃ¼r jedes Teil eine Suche durchfÃ¼hren
                for (let i = 0; i < teileZuErsetzen.length; i++) {
                    const teil = teileZuErsetzen[i];
                    if (statusText) statusText.textContent = `Suche nach "${teil}" (${i + 1}/${teileZuErsetzen.length})...`;

                    const angebote = await searchErsatzteilOnline(teil, fahrzeug);
                    kiErsatzteileAngebote.push(...angebote);

                    // Kleine Pause zwischen Anfragen
                    await new Promise(resolve => setTimeout(resolve, 300));
                }

                // Ergebnisse anzeigen
                if (loading) loading.style.display = 'none';
                if (results) results.style.display = 'block';

                renderKIErsatzteileResults();

                showToast(`âœ… ${kiErsatzteileAngebote.length} Angebote gefunden`, 'success');

            } catch (error) {
                console.error('âŒ KI-Ersatzteilsuche Fehler:', error);
                showToast('Fehler bei der Suche: ' + error.message, 'error');
                if (loading) loading.style.display = 'none';
            } finally {
                if (btn) btn.disabled = false;
            }
        }

        // Online-Suche fÃ¼r ein einzelnes Teil
        // ============================================
        // ðŸ” ERSATZTEIL-SUCHE MIT ECHTEN SHOP-LINKS
        // ============================================

        // Echte Shop-URLs fÃ¼r Ersatzteilsuche
        const ERSATZTEIL_SHOPS = {
            'eBay': {
                name: 'eBay Kleinanzeigen & Motors',
                icon: 'ðŸ›’',
                color: '#e53238',
                buildUrl: (teil, fahrzeug) => {
                    const query = `${fahrzeug.marke} ${fahrzeug.modell} ${teil}`.trim();
                    return `https://www.ebay.de/sch/i.html?_nkw=${encodeURIComponent(query)}&_sacat=6028`;
                },
                beschreibung: 'Gebraucht & Neu, oft gÃ¼nstig'
            },
            'Autodoc': {
                name: 'Autodoc',
                icon: 'ðŸš—',
                color: '#ff6600',
                buildUrl: (teil, fahrzeug) => {
                    const query = `${fahrzeug.marke} ${fahrzeug.modell} ${teil}`.trim();
                    return `https://www.autodoc.de/search?keyword=${encodeURIComponent(query)}`;
                },
                beschreibung: 'GroÃŸe Auswahl, schneller Versand'
            },
            'kfzteile24': {
                name: 'kfzteile24',
                icon: 'ðŸ”§',
                color: '#0066cc',
                buildUrl: (teil, fahrzeug) => {
                    const query = `${fahrzeug.marke} ${fahrzeug.modell} ${teil}`.trim();
                    return `https://www.kfzteile24.de/suche/${encodeURIComponent(query)}`;
                },
                beschreibung: 'OE & Aftermarket Teile'
            },
            'Daparto': {
                name: 'Daparto',
                icon: 'âš™ï¸',
                color: '#00aa00',
                buildUrl: (teil, fahrzeug) => {
                    const query = `${fahrzeug.marke} ${fahrzeug.modell} ${teil}`.trim();
                    return `https://www.daparto.de/Suche?s=${encodeURIComponent(query)}`;
                },
                beschreibung: 'Preisvergleich vieler Anbieter'
            },
            'Autoteile-Markt': {
                name: 'Autoteile-Markt.de',
                icon: 'ðŸª',
                color: '#993399',
                buildUrl: (teil, fahrzeug) => {
                    const query = `${fahrzeug.marke} ${fahrzeug.modell} ${teil}`.trim();
                    return `https://www.autoteile-markt.de/suche?q=${encodeURIComponent(query)}`;
                },
                beschreibung: 'Gebrauchtteile von Verwertern'
            }
        };

        // Generiert echte Such-Links fÃ¼r alle Shops
        function generateShopSearchLinks(teilName, fahrzeug) {
            console.log('ðŸ”— Generiere Such-Links fÃ¼r:', teilName, fahrzeug);

            return Object.entries(ERSATZTEIL_SHOPS).map(([key, shop], idx) => ({
                id: `link-${key}-${teilName.replace(/\s+/g, '-')}-${Date.now()}`,
                teilName: teilName,
                shop: shop.name,
                shopKey: key,
                icon: shop.icon,
                color: shop.color,
                titel: `${teilName} bei ${shop.name} suchen`,
                beschreibung: shop.beschreibung,
                url: shop.buildUrl(teilName, fahrzeug),
                isDirectLink: true,  // Markierung: Das ist ein echter Link!
                selected: false
            }));
        }

        // Hauptfunktion: Sucht Ersatzteile online
        async function searchErsatzteilOnline(teilName, fahrzeug) {
            const searchQuery = `${fahrzeug.marke} ${fahrzeug.modell} ${teilName}`;
            console.log('ðŸ”Ž Suche:', searchQuery);

            // IMMER echte Shop-Links generieren
            const shopLinks = generateShopSearchLinks(teilName, fahrzeug);

            // Versuche eBay API fÃ¼r echte Ergebnisse (wenn API-Key vorhanden)
            let ebayResults = [];
            const ebayAppId = await getEbayAppId();

            if (ebayAppId) {
                try {
                    ebayResults = await searchEbayAPI(teilName, fahrzeug, ebayAppId);
                    console.log('âœ… eBay API Ergebnisse:', ebayResults.length);
                } catch (error) {
                    console.warn('âš ï¸ eBay API fehlgeschlagen:', error);
                }
            }

            // GPT-PreisschÃ¤tzung als Zusatz (mit GESCHÃ„TZT-Label)
            let preisSchaetzung = null;
            const openaiKey = await getOpenAIKey();

            if (openaiKey) {
                try {
                    preisSchaetzung = await getGPTPreisSchaetzung(teilName, fahrzeug, openaiKey);
                    console.log('ðŸ’¡ GPT PreisschÃ¤tzung:', preisSchaetzung);
                } catch (error) {
                    console.warn('âš ï¸ GPT SchÃ¤tzung fehlgeschlagen:', error);
                }
            }

            // Kombiniere alle Ergebnisse
            const allResults = [
                ...ebayResults,
                ...shopLinks
            ];

            // PreisschÃ¤tzung als Info-Objekt hinzufÃ¼gen (falls vorhanden)
            if (preisSchaetzung) {
                allResults.unshift({
                    id: `schaetzung-${teilName.replace(/\s+/g, '-')}-${Date.now()}`,
                    teilName: teilName,
                    shop: 'ðŸ’¡ KI-PreisschÃ¤tzung',
                    titel: `${teilName} - Marktpreis-SchÃ¤tzung`,
                    beschreibung: preisSchaetzung.erklaerung || 'Basierend auf aktuellen Marktdaten',
                    preis: preisSchaetzung.mittelpreis,
                    preisVon: preisSchaetzung.preisVon,
                    preisBis: preisSchaetzung.preisBis,
                    isSchaetzung: true,  // Markierung: Das ist eine SchÃ¤tzung!
                    selected: false
                });
            }

            return allResults;
        }

        // eBay API Key aus Einstellungen holen
        async function getEbayAppId() {
            try {
                if (window.settingsManager?.currentSettings?.systemConfig?.ebayAppId) {
                    return window.settingsManager.currentSettings.systemConfig.ebayAppId;
                }
                // Multi-Tenant Helper fÃ¼r konsistenten Collection-Zugriff
                const settingsDoc = await window.getCollection('einstellungen').doc('config').get();
                return settingsDoc.exists ? settingsDoc.data()?.systemConfig?.ebayAppId : null;
            } catch (e) {
                return null;
            }
        }

        // OpenAI Key aus Einstellungen holen
        async function getOpenAIKey() {
            try {
                if (window.settingsManager?.currentSettings?.systemConfig?.openaiKey) {
                    return window.settingsManager.currentSettings.systemConfig.openaiKey;
                }
                // Multi-Tenant Helper fÃ¼r konsistenten Collection-Zugriff
                const settingsDoc = await window.getCollection('einstellungen').doc('config').get();
                return settingsDoc.exists ? settingsDoc.data()?.systemConfig?.openaiKey : null;
            } catch (e) {
                return null;
            }
        }

        // eBay Finding API - Echte Suchergebnisse
        async function searchEbayAPI(teilName, fahrzeug, appId) {
            const query = `${fahrzeug.marke} ${fahrzeug.modell} ${teilName}`;

            // eBay Finding API (CORS-Problem: muss Ã¼ber Backend laufen)
            // FÃ¼r jetzt: Direkte Links zu eBay Suche
            console.log('â„¹ï¸ eBay API benÃ¶tigt Backend-Proxy wegen CORS');

            // Placeholder fÃ¼r zukÃ¼nftige Backend-Integration
            return [];
        }

        // GPT-4 fÃ¼r PreisschÃ¤tzung (NICHT fÃ¼r fake Angebote!)
        async function getGPTPreisSchaetzung(teilName, fahrzeug, apiKey) {
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: 'gpt-4o',
                    messages: [
                        {
                            role: 'system',
                            content: `Du bist ein Experte fÃ¼r Kfz-Ersatzteile.
Gib eine REALISTISCHE PreisschÃ¤tzung basierend auf deinem Wissen Ã¼ber den deutschen Markt.

WICHTIG: Dies ist NUR eine SchÃ¤tzung! Antworte NUR im JSON-Format:
{
    "preisVon": 50,
    "preisBis": 150,
    "mittelpreis": 100,
    "erklaerung": "Kurze ErklÃ¤rung warum dieser Preis"
}

BerÃ¼cksichtige:
- Marke (Premium-Marken teurer)
- Teil-Typ (Karosserie, Mechanik, etc.)
- QualitÃ¤t (OE vs Aftermarket)
- Deutscher Markt 2024`
                        },
                        {
                            role: 'user',
                            content: `SchÃ¤tze den Marktpreis fÃ¼r:
Fahrzeug: ${fahrzeug.marke} ${fahrzeug.modell} ${fahrzeug.baujahr || ''}
Teil: ${teilName}

Gib eine realistische Preisspanne fÃ¼r den deutschen Markt.`
                        }
                    ],
                    max_tokens: 300,
                    temperature: 0.3
                })
            });

            if (!response.ok) throw new Error('API-Fehler');

            const data = await response.json();
            const content = data.choices?.[0]?.message?.content || '';

            try {
                return JSON.parse(content);
            } catch {
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                return jsonMatch ? JSON.parse(jsonMatch[0]) : null;
            }
        }

        // Ergebnisse rendern (gruppiert nach Teil)
        function renderKIErsatzteileResults() {
            const container = document.getElementById('kiErsatzteileGrouped');
            const countEl = document.getElementById('kiResultsCount');
            if (!container) return;

            // ZÃ¤hle nur echte Shop-Links (nicht SchÃ¤tzungen)
            const shopLinks = kiErsatzteileAngebote.filter(a => a.isDirectLink);
            const schaetzungen = kiErsatzteileAngebote.filter(a => a.isSchaetzung);

            if (countEl) countEl.textContent = `${shopLinks.length} Shop-Links`;

            // Nach Teilname gruppieren
            const grouped = {};
            kiErsatzteileAngebote.forEach(a => {
                if (!grouped[a.teilName]) grouped[a.teilName] = [];
                grouped[a.teilName].push(a);
            });

            container.innerHTML = Object.entries(grouped).map(([teilName, angebote]) => {
                const links = angebote.filter(a => a.isDirectLink);
                const schaetzung = angebote.find(a => a.isSchaetzung);

                return `
                <div class="ki-teil-gruppe">
                    <div class="ki-teil-gruppe__header">
                        <div class="ki-teil-gruppe__name">
                            <i data-feather="package"></i>
                            ${teilName}
                        </div>
                        <div class="ki-teil-gruppe__angebote">${links.length} Shops</div>
                    </div>

                    ${schaetzung ? renderPreisSchaetzung(schaetzung) : ''}

                    <div class="ki-shop-links-header" style="padding: 8px 16px; background: #f8f9fa; border-bottom: 1px solid #e9ecef; font-weight: 600; color: #495057;">
                        ðŸ”— Direkt zu den Shops (echte Links):
                    </div>

                    ${links.map(a => renderShopLink(a)).join('')}
                </div>
            `;
            }).join('');

            updateKIErsatzteileSelection();
            if (typeof feather !== 'undefined') feather.replace();
        }

        // KI-PreisschÃ¤tzung rendern (mit GESCHÃ„TZT-Label!)
        function renderPreisSchaetzung(schaetzung) {
            return `
                <div class="ki-preisschaetzung" style="background: linear-gradient(135deg, #fff3cd, #ffeeba); padding: 16px; border-radius: 8px; margin: 8px 16px; border-left: 4px solid #ffc107;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                        <span style="font-size: 1.5em;">ðŸ’¡</span>
                        <strong style="color: #856404;">KI-PreisschÃ¤tzung</strong>
                        <span style="background: #ffc107; color: #000; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 700;">GESCHÃ„TZT</span>
                    </div>
                    <div style="display: flex; align-items: baseline; gap: 8px; margin-bottom: 4px;">
                        <span style="font-size: 1.3em; font-weight: 700; color: #856404;">
                            ${schaetzung.preisVon?.toFixed(0) || '?'} â‚¬ - ${schaetzung.preisBis?.toFixed(0) || '?'} â‚¬
                        </span>
                        <span style="color: #856404; font-size: 0.9em;">(Mittel: ~${schaetzung.preis?.toFixed(0) || '?'} â‚¬)</span>
                    </div>
                    <p style="margin: 0; font-size: 0.85em; color: #6c757d;">
                        ${schaetzung.beschreibung || 'Basierend auf aktuellen Marktdaten'}
                    </p>
                    <p style="margin: 4px 0 0 0; font-size: 0.75em; color: #999; font-style: italic;">
                        âš ï¸ Dies ist nur eine SchÃ¤tzung! Bitte Preise in den Shops unten vergleichen.
                    </p>
                </div>
            `;
        }

        // Shop-Link rendern (echter Link zum Shop!)
        function renderShopLink(link) {
            return `
                <a href="${link.url}" target="_blank" class="ki-shop-link" style="display: flex; align-items: center; padding: 12px 16px; border-bottom: 1px solid #e9ecef; text-decoration: none; color: inherit; transition: background 0.2s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
                    <span style="font-size: 1.5em; margin-right: 12px;">${link.icon}</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: ${link.color};">${link.shop}</div>
                        <div style="font-size: 0.85em; color: #6c757d;">${link.beschreibung}</div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span style="background: #28a745; color: white; padding: 4px 12px; border-radius: 16px; font-size: 0.8em; font-weight: 600;">
                            Jetzt suchen
                        </span>
                        <i data-feather="external-link" style="width: 16px; height: 16px; color: #6c757d;"></i>
                    </div>
                </a>
            `;
        }

        // Legacy: Einzelnes Angebot rendern (fÃ¼r eBay API Ergebnisse)
        function renderKIAngebot(angebot) {
            // Wenn es ein direkter Link ist, nutze die neue Darstellung
            if (angebot.isDirectLink) return renderShopLink(angebot);
            if (angebot.isSchaetzung) return renderPreisSchaetzung(angebot);

            const isSelected = selectedKIErsatzteile.has(angebot.id);
            const gesamtPreis = angebot.preis + (angebot.versand || 0);
            const qualBadgeClass = angebot.qualitaet === 'OE' ? 'ki-badge--oe' :
                                   (angebot.qualitaet === 'Gebraucht' ? 'ki-badge--gebraucht' : 'ki-badge--aftermarket');

            return `
                <div class="ki-angebot ${isSelected ? 'selected' : ''}" data-id="${angebot.id}">
                    <input type="checkbox" class="ki-angebot__checkbox"
                           ${isSelected ? 'checked' : ''}
                           onchange="toggleKIErsatzteil('${angebot.id}')">
                    <div class="ki-angebot__info">
                        <div class="ki-angebot__title">${angebot.titel}</div>
                        <div class="ki-angebot__details">
                            <span class="ki-badge ${qualBadgeClass}">${angebot.qualitaet || 'Unbekannt'}</span>
                            ${angebot.teilenummer ? `<span>Nr: ${angebot.teilenummer}</span>` : ''}
                            <span class="ki-badge ${angebot.verfuegbar ? 'ki-badge--lieferbar' : 'ki-badge--bestellen'}">
                                ${angebot.verfuegbar ? 'âœ“ Lieferbar' : 'â± Bestellbar'}
                            </span>
                            <span>${angebot.lieferzeit || ''}</span>
                        </div>
                    </div>
                    <div class="ki-angebot__anbieter">
                        <span class="ki-angebot__anbieter-name">${angebot.shop}</span>
                    </div>
                    <div class="ki-angebot__preis">
                        <div class="ki-angebot__preis-wert">${gesamtPreis.toFixed(2)} â‚¬</div>
                        <div class="ki-angebot__preis-label">
                            ${angebot.versand > 0 ? `inkl. ${angebot.versand.toFixed(2)} â‚¬ Versand` : 'Versandkostenfrei'}
                        </div>
                    </div>
                    <a href="${angebot.url}" target="_blank" class="ki-angebot__link" title="Im Shop Ã¶ffnen">
                        <i data-feather="external-link"></i>
                    </a>
                </div>
            `;
        }

        // Einzelnes Angebot auswÃ¤hlen/abwÃ¤hlen
        function toggleKIErsatzteil(id) {
            if (selectedKIErsatzteile.has(id)) {
                selectedKIErsatzteile.delete(id);
            } else {
                selectedKIErsatzteile.add(id);
            }
            updateKIErsatzteileSelection();

            // Visual Update
            const el = document.querySelector(`.ki-angebot[data-id="${id}"]`);
            if (el) el.classList.toggle('selected', selectedKIErsatzteile.has(id));
        }

        // Alle auswÃ¤hlen
        function selectAllKIErsatzteile() {
            kiErsatzteileAngebote.forEach(a => selectedKIErsatzteile.add(a.id));
            renderKIErsatzteileResults();
        }

        // GÃ¼nstigste pro Teil auswÃ¤hlen
        function selectCheapestKIErsatzteile() {
            selectedKIErsatzteile.clear();

            // Nach Teil gruppieren und gÃ¼nstigstes pro Gruppe wÃ¤hlen
            const grouped = {};
            kiErsatzteileAngebote.forEach(a => {
                if (!grouped[a.teilName]) grouped[a.teilName] = [];
                grouped[a.teilName].push(a);
            });

            Object.values(grouped).forEach(angebote => {
                const cheapest = angebote.reduce((min, a) =>
                    (a.preis + (a.versand || 0)) < (min.preis + (min.versand || 0)) ? a : min
                );
                selectedKIErsatzteile.add(cheapest.id);
            });

            renderKIErsatzteileResults();
        }

        // Auswahl-Zusammenfassung aktualisieren
        function updateKIErsatzteileSelection() {
            const countEl = document.getElementById('kiSelectedCount');
            const totalEl = document.getElementById('kiSelectedTotal');

            const selectedAngebote = kiErsatzteileAngebote.filter(a => selectedKIErsatzteile.has(a.id));
            const total = selectedAngebote.reduce((sum, a) => sum + a.preis + (a.versand || 0), 0);

            if (countEl) countEl.textContent = selectedAngebote.length;
            if (totalEl) totalEl.textContent = `${total.toFixed(2)} â‚¬`;
        }

        // AusgewÃ¤hlte zur Bestellliste hinzufÃ¼gen
        function addSelectedKIErsatzteile() {
            const selectedAngebote = kiErsatzteileAngebote.filter(a => selectedKIErsatzteile.has(a.id));

            if (selectedAngebote.length === 0) {
                showToast('Bitte mindestens ein Angebot auswÃ¤hlen', 'warning');
                return;
            }

            selectedAngebote.forEach(a => {
                kalkWizardData.ersatzteile.push({
                    name: a.titel,
                    teilenummer: a.teilenummer,
                    preis: a.preis + (a.versand || 0),
                    menge: 1,
                    lieferant: a.shop,
                    qualitaet: a.qualitaet,
                    url: a.url,
                    kiGefunden: true
                });
            });

            // Tabelle aktualisieren
            renderErsatzteileTable();

            // Auswahl zurÃ¼cksetzen
            selectedKIErsatzteile.clear();
            updateKIErsatzteileSelection();

            showToast(`âœ… ${selectedAngebote.length} Teile zur Bestellliste hinzugefÃ¼gt`, 'success');
        }

        // ============================================

        // Ersatzteil zur Liste hinzufÃ¼gen (Step 5)
        // ðŸ†• Nov 30, 2025: Zwei Preise (Original + Aftermarket) fÃ¼r KVA-Varianten
        function addErsatzteilToList() {
            const name = document.getElementById('ersatzteilAddName')?.value?.trim();
            const teilenummer = document.getElementById('ersatzteilAddTeilenr')?.value?.trim();
            // ðŸ†• Zwei Preis-Felder
            const preisOriginal = parseFloat(document.getElementById('ersatzteilAddPreisOriginal')?.value) || 0;
            const preisAftermarket = parseFloat(document.getElementById('ersatzteilAddPreisAftermarket')?.value) || 0;
            const menge = parseInt(document.getElementById('ersatzteilAddMenge')?.value) || 1;
            const lieferant = document.getElementById('ersatzteilAddLieferant')?.value?.trim() || '';
            const bestellLink = document.getElementById('ersatzteilAddLink')?.value?.trim() || '';

            if (!name) {
                showToast('Bitte geben Sie einen Teilenamen ein', 'warning');
                return;
            }

            if (preisOriginal <= 0) {
                showToast('Bitte geben Sie mindestens den Original-Preis ein', 'warning');
                return;
            }

            // ðŸ†• Dec 1, 2025: Service-Zuordnung fÃ¼r Multi-Service
            const serviceSelect = document.getElementById('ersatzteilAddService');
            const selectedService = serviceSelect ? serviceSelect.value : '';

            const ersatzteil = {
                name: name,
                teilenummer: teilenummer,
                // ðŸ†• Zwei Preise speichern
                preisOriginal: preisOriginal,
                preisAftermarket: preisAftermarket > 0 ? preisAftermarket : preisOriginal, // Fallback auf Original wenn leer
                // Backwards-KompatibilitÃ¤t: preis = Original (fÃ¼r alte Logik)
                preis: preisOriginal,
                menge: menge,
                lieferant: lieferant,
                bestellLink: bestellLink,
                // ðŸ†• Dec 1, 2025: Service-Zuordnung
                serviceTyp: selectedService || kalkWizardData.serviceArt || ''
            };

            kalkWizardData.ersatzteile.push(ersatzteil);

            // Log fÃ¼r Debugging
            if (selectedService) {
                console.log(`ðŸ“¦ Ersatzteil "${name}" â†’ Service: ${selectedService}`);
            }

            // In DB speichern
            saveErsatzteilToDB(ersatzteil);

            // Formular zurÃ¼cksetzen
            const nameField = document.getElementById('ersatzteilAddName');
            const teilenrField = document.getElementById('ersatzteilAddTeilenr');
            const preisOriginalField = document.getElementById('ersatzteilAddPreisOriginal');
            const preisAftermarketField = document.getElementById('ersatzteilAddPreisAftermarket');
            const mengeField = document.getElementById('ersatzteilAddMenge');
            const lieferantField = document.getElementById('ersatzteilAddLieferant');
            const linkField = document.getElementById('ersatzteilAddLink');
            if (nameField) nameField.value = '';
            if (teilenrField) teilenrField.value = '';
            if (preisOriginalField) preisOriginalField.value = '';
            if (preisAftermarketField) preisAftermarketField.value = '';
            if (mengeField) mengeField.value = '1';
            if (lieferantField) lieferantField.value = '';
            if (linkField) linkField.value = '';
            // ðŸ†• Dec 1, 2025: Service-Dropdown zurÃ¼cksetzen (Multi-Service)
            if (serviceSelect) serviceSelect.selectedIndex = 0;

            // Liste neu rendern
            renderErsatzteileTable();
            showToast(`"${name}" hinzugefÃ¼gt`, 'success');
        }

        // Ersatzteil aus Liste entfernen
        function removeErsatzteilFromList(index) {
            kalkWizardData.ersatzteile.splice(index, 1);
            renderErsatzteileTable();
        }

        // Ersatzteile-Tabelle rendern
        // ðŸ†• Nov 30, 2025: Zwei Preis-Spalten (Original + Aftermarket)
        function renderErsatzteileTable() {
            const tbody = document.getElementById('ersatzteileTableBody');
            const gesamtOriginal = document.getElementById('ersatzteileGesamtOriginal');
            const gesamtAftermarket = document.getElementById('ersatzteileGesamtAftermarket');
            if (!tbody) return;

            if (kalkWizardData.ersatzteile.length === 0) {
                tbody.innerHTML = `
                    <tr class="no-items-row">
                        <td colspan="7">Noch keine Ersatzteile hinzugefÃ¼gt</td>
                    </tr>
                `;
                if (gesamtOriginal) gesamtOriginal.textContent = '0,00 â‚¬';
                if (gesamtAftermarket) gesamtAftermarket.textContent = '0,00 â‚¬';
                return;
            }

            let totalOriginal = 0;
            let totalAftermarket = 0;
            tbody.innerHTML = kalkWizardData.ersatzteile.map((e, index) => {
                // ðŸ†• Zwei Preise berechnen
                const pOriginal = e.preisOriginal || e.preis || 0;
                const pAftermarket = e.preisAftermarket || pOriginal;
                const menge = e.menge || 1;
                const gesamtOrig = pOriginal * menge;
                const gesamtAfter = pAftermarket * menge;
                totalOriginal += gesamtOrig;
                totalAftermarket += gesamtAfter;

                // Lieferant mit optionalem Link
                let lieferantCell = e.lieferant || '-';
                if (e.bestellLink) {
                    lieferantCell = `<a href="${e.bestellLink}" target="_blank" class="ersatzteil-link" title="${e.bestellLink}">
                        ${e.lieferant || 'Link'} <i data-feather="external-link" style="width: 12px; height: 12px;"></i>
                    </a>`;
                }
                return `
                    <tr>
                        <td><strong>${e.name}</strong></td>
                        <td>${e.teilenummer || '-'}</td>
                        <td>${lieferantCell}</td>
                        <td>${menge}</td>
                        <td style="background: #f5f9ff;"><strong>${gesamtOrig.toFixed(2)} â‚¬</strong></td>
                        <td style="background: #fffaf0;"><strong>${gesamtAfter.toFixed(2)} â‚¬</strong></td>
                        <td>
                            <button class="btn-icon" onclick="removeErsatzteilFromList(${index})" title="Entfernen">
                                <i data-feather="trash-2"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            if (gesamtOriginal) gesamtOriginal.textContent = `${totalOriginal.toFixed(2)} â‚¬`;
            if (gesamtAftermarket) gesamtAftermarket.textContent = `${totalAftermarket.toFixed(2)} â‚¬`;
            feather.replace();
        }

        // Step 5: Ersatzteile-Ãœbersicht aktualisieren
        function updateStep5Ersatzteile() {
            // NEU: Teile die ersetzt werden mÃ¼ssen (aus Schritt 4)
            const teileZuErsetzen = kalkWizardData.teile.filter(t => {
                const reparaturen = t.reparaturen || [];
                return t.needsErsatzteil ||
                    reparaturen.includes('ersetzen') ||
                    reparaturen.includes('austauschen') ||
                    reparaturen.includes('wechseln');
            });

            console.log('ðŸ“‹ Step 5 - Teile zu ersetzen:', teileZuErsetzen);

            // KI-Kontext aktualisieren - KORREKTE Feldnamen aus kalkWizardData.fahrzeug
            const kontextFahrzeug = document.getElementById('kiKontextFahrzeug');
            const kontextTeile = document.getElementById('kiKontextTeile');

            if (kontextFahrzeug) {
                const marke = kalkWizardData.fahrzeug?.marke || '';
                const modell = kalkWizardData.fahrzeug?.modell || '';
                const baujahr = kalkWizardData.fahrzeug?.baujahr || '';
                const kennzeichen = kalkWizardData.fahrzeug?.kennzeichen || '';
                let fahrzeugText = `${marke} ${modell}`.trim();
                if (baujahr) fahrzeugText += ` (${baujahr})`;
                if (kennzeichen) fahrzeugText += ` - ${kennzeichen}`;
                kontextFahrzeug.textContent = fahrzeugText || '-';
            }

            if (kontextTeile) {
                if (teileZuErsetzen.length > 0) {
                    kontextTeile.textContent = teileZuErsetzen.map(t => t.teil || t.name).join(', ');
                } else {
                    kontextTeile.textContent = 'Keine Teile zum Ersetzen ausgewÃ¤hlt';
                }
            }

            // Ersatzteile aus Reparaturen anzeigen
            const fromRepairsList = document.getElementById('ersatzteileFromRepairsList');
            if (fromRepairsList) {
                // Zeige Teile die ein Ersatzteil brauchen
                if (teileZuErsetzen.length === 0) {
                    fromRepairsList.innerHTML = '<p class="no-items-hint">Keine Ersatzteile aus Reparaturen benÃ¶tigt</p>';
                } else {
                    fromRepairsList.innerHTML = teileZuErsetzen.map((t, idx) => {
                        const hasErsatzteil = t.ersatzteil && t.ersatzteil.name;
                        return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-3); background: ${hasErsatzteil ? 'rgba(16, 185, 129, 0.1)' : 'rgba(245, 158, 11, 0.1)'}; border-radius: var(--radius-button); margin-bottom: var(--space-2); border-left: 4px solid ${hasErsatzteil ? '#10b981' : '#f59e0b'};">
                            <div>
                                <strong style="display: flex; align-items: center; gap: 8px;">
                                    <span>${hasErsatzteil ? 'âœ…' : 'ðŸ”'}</span>
                                    ${t.teil}
                                </strong>
                                <span style="font-size: var(--font-size-xs); color: var(--color-text-secondary); display: block; margin-top: 4px;">
                                    ${t.reparaturen.join(', ')}
                                </span>
                                ${hasErsatzteil ? `
                                    <span style="font-size: var(--font-size-xs); color: #10b981; display: block; margin-top: 4px;">
                                        Ersatzteil: ${t.ersatzteil.name} - ${(t.ersatzteil.preis || 0).toFixed(2)} â‚¬ (${t.ersatzteil.lieferant || 'Unbekannt'})
                                    </span>
                                ` : `
                                    <span style="font-size: var(--font-size-xs); color: #f59e0b; display: block; margin-top: 4px;">
                                        âš ï¸ Ersatzteil noch nicht zugewiesen - KI-Suche starten oder manuell hinzufÃ¼gen
                                    </span>
                                `}
                            </div>
                            ${hasErsatzteil ? `
                                <span style="font-weight: var(--font-weight-semibold); color: #10b981;">${(t.ersatzteil.preis || 0).toFixed(2)} â‚¬</span>
                            ` : `
                                <span style="background: #f59e0b; color: white; padding: 4px 12px; border-radius: 12px; font-size: var(--font-size-xs); font-weight: 600;">OFFEN</span>
                            `}
                        </div>
                    `;
                    }).join('');
                }
            }

            // Ersatzteile-Tabelle rendern
            renderErsatzteileTable();

            // ðŸ†• Nov 30, 2025: Teile-Checkliste rendern
            renderTeileChecklist();

            // ðŸ†• Dec 1, 2025: Service-Dropdown fÃ¼r Multi-Service befÃ¼llen
            const serviceContainer = document.getElementById('ersatzteilServiceContainer');
            const serviceSelect = document.getElementById('ersatzteilAddService');
            if (serviceContainer && serviceSelect && kalkWizardData.isMultiService && kalkWizardData.additionalServicesFromEntwurf?.length > 0) {
                // Zeige Service-Dropdown
                serviceContainer.style.display = 'block';

                // Services ermitteln (Primary + Additional)
                const allServices = [];
                if (kalkWizardData.serviceArt) {
                    allServices.push(kalkWizardData.serviceArt);
                }
                kalkWizardData.additionalServicesFromEntwurf.forEach(svc => {
                    const svcTyp = typeof svc === 'string' ? svc : svc.serviceTyp;
                    if (svcTyp && !allServices.includes(svcTyp)) {
                        allServices.push(svcTyp);
                    }
                });

                // Dropdown befÃ¼llen
                serviceSelect.innerHTML = '<option value="">-- Service wÃ¤hlen --</option>';
                allServices.forEach(svc => {
                    const label = SERVICE_LABELS[svc] || svc;
                    serviceSelect.innerHTML += `<option value="${svc}">${label}</option>`;
                });

                console.log('ðŸ“¦ [MULTI-SERVICE] Ersatzteil-Service-Dropdown befÃ¼llt:', allServices);
            } else if (serviceContainer) {
                // Single-Service: Dropdown verstecken
                serviceContainer.style.display = 'none';
            }
        }

        /**
         * ðŸ†• Nov 30, 2025: Rendert die Teile-Checkliste fÃ¼r Bestellungen
         * Zeigt alle Teile aus allen Services mit Checkboxen
         */
        function renderTeileChecklist() {
            const section = document.getElementById('teileChecklistSection');
            const itemsContainer = document.getElementById('teileChecklistItems');
            const badge = document.getElementById('teileChecklistBadge');
            const actions = document.getElementById('teileChecklistActions');

            if (!section || !itemsContainer) return;

            const teile = kalkWizardData.teile || [];

            // Nur anzeigen wenn Teile vorhanden
            if (teile.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';

            // Initialisiere checkedTeile wenn nicht vorhanden
            if (!kalkWizardData.checkedTeile) {
                kalkWizardData.checkedTeile = {};
            }

            // ZÃ¤hle bereits abgehakte Teile
            const checkedCount = teile.filter(t => kalkWizardData.checkedTeile[t.teil + '_' + t.service]).length;

            // Badge aktualisieren
            if (badge) {
                badge.textContent = `${checkedCount}/${teile.length}`;
                badge.style.background = checkedCount === teile.length ? 'var(--color-success)' : '#ff9800';
            }

            // Actions anzeigen wenn mehr als 2 Teile
            if (actions) {
                actions.style.display = teile.length > 2 ? 'flex' : 'none';
            }

            // Checklisten-Items generieren
            itemsContainer.innerHTML = teile.map((teil, index) => {
                const checkId = teil.teil + '_' + teil.service;
                const isChecked = kalkWizardData.checkedTeile[checkId] || false;
                const partIcon = getPartIcon(teil.teil);
                const serviceLabel = teil.serviceLabel || SERVICE_LABELS[teil.service] || teil.service;
                const arbeiten = teil.arbeiten || [];

                return `
                    <div class="teile-checklist-item ${isChecked ? 'checked' : ''}" data-check-id="${checkId}">
                        <input type="checkbox"
                               class="teile-checklist-item__checkbox"
                               id="teileCheck_${index}"
                               ${isChecked ? 'checked' : ''}
                               onchange="toggleTeileCheck('${checkId}', this.checked)">
                        <span class="teile-checklist-item__icon">${partIcon}</span>
                        <div class="teile-checklist-item__content">
                            <span class="teile-checklist-item__name">${teil.teil}</span>
                            <span class="teile-checklist-item__service">${serviceLabel}</span>
                            ${arbeiten.length > 0 ? `<span class="teile-checklist-item__arbeiten">Arbeiten: ${arbeiten.join(', ')}</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            feather.replace();
        }

        /**
         * ðŸ†• Toggle Checkbox fÃ¼r ein Teil
         */
        function toggleTeileCheck(checkId, isChecked) {
            if (!kalkWizardData.checkedTeile) {
                kalkWizardData.checkedTeile = {};
            }

            kalkWizardData.checkedTeile[checkId] = isChecked;

            // UI aktualisieren
            const item = document.querySelector(`.teile-checklist-item[data-check-id="${checkId}"]`);
            if (item) {
                if (isChecked) {
                    item.classList.add('checked');
                } else {
                    item.classList.remove('checked');
                }
            }

            // Badge aktualisieren
            updateTeileChecklistBadge();

            // Toast Feedback
            if (isChecked) {
                showToast('Teil als bestellt markiert âœ“', 'success');
            }
        }

        /**
         * ðŸ†• Aktualisiert das Badge der Teile-Checkliste
         */
        function updateTeileChecklistBadge() {
            const badge = document.getElementById('teileChecklistBadge');
            const teile = kalkWizardData.teile || [];

            if (!badge || teile.length === 0) return;

            const checkedCount = teile.filter(t =>
                kalkWizardData.checkedTeile?.[t.teil + '_' + t.service]
            ).length;

            badge.textContent = `${checkedCount}/${teile.length}`;
            badge.style.background = checkedCount === teile.length ? 'var(--color-success)' : '#ff9800';

            // Alle abgehakt â†’ Erfolgsmeldung
            if (checkedCount === teile.length && teile.length > 0) {
                showToast('ðŸŽ‰ Alle Teile als bestellt markiert!', 'success');
            }
        }

        /**
         * ðŸ†• Alle Teile abhaken
         */
        function checkAllTeile() {
            const teile = kalkWizardData.teile || [];
            if (!kalkWizardData.checkedTeile) {
                kalkWizardData.checkedTeile = {};
            }

            teile.forEach(teil => {
                const checkId = teil.teil + '_' + teil.service;
                kalkWizardData.checkedTeile[checkId] = true;
            });

            // UI aktualisieren
            renderTeileChecklist();
            showToast('Alle Teile als bestellt markiert', 'success');
        }

        /**
         * ðŸ†• Alle Teile zurÃ¼cksetzen
         */
        function uncheckAllTeile() {
            kalkWizardData.checkedTeile = {};

            // UI aktualisieren
            renderTeileChecklist();
            showToast('Alle Markierungen zurÃ¼ckgesetzt', 'info');
        }

        // Step 6: Zusammenfassung aktualisieren (ehemals Step 5)
        function updateStep6Summary() {
            // Fahrzeug-Zusammenfassung
            const vehicleSummary = document.getElementById('step6VehicleSummary');
            if (vehicleSummary) {
                let html = `<strong>${kalkWizardData.fahrzeug.marke} ${kalkWizardData.fahrzeug.modell}</strong>`;
                if (kalkWizardData.fahrzeug.baujahr) html += `<br>Baujahr: ${kalkWizardData.fahrzeug.baujahr}`;
                if (kalkWizardData.fahrzeug.kennzeichen) html += `<br>Kennzeichen: ${kalkWizardData.fahrzeug.kennzeichen}`;
                if (kalkWizardData.fahrzeug.farbcode) html += `<br>Farbcode: ${kalkWizardData.fahrzeug.farbcode}`;
                if (kalkWizardData.fahrzeug.kunde) html += `<br>Kunde: ${kalkWizardData.fahrzeug.kunde}`;
                if (kalkWizardData.serviceArt) {
                    html += `<br><span style="color: var(--color-primary);">Service: ${SERVICE_LABELS[kalkWizardData.serviceArt] || kalkWizardData.serviceArt}</span>`;
                }
                vehicleSummary.innerHTML = html;
            }

            // Teile-Zusammenfassung
            const partsSummary = document.getElementById('step6PartsSummary');
            if (partsSummary) {
                let allParts = [...(kalkWizardData.teile || [])];

                // ðŸ†• Multi-Service Support: Teile haben jetzt "arbeiten" statt "reparaturen"
                // Normalisiere alle Teile fÃ¼r die Zusammenfassung
                allParts = allParts.map(item => ({
                    ...item,
                    // Fallback: arbeiten â†’ reparaturen fÃ¼r KompatibilitÃ¤t
                    reparaturen: item.reparaturen || item.arbeiten || []
                }));

                if (allParts.length === 0) {
                    partsSummary.innerHTML = '<p style="color: var(--color-text-secondary);">Keine Teile ausgewÃ¤hlt</p>';
                } else {
                    partsSummary.innerHTML = allParts.map(item => {
                        const repairs = item.reparaturen || [];
                        const serviceLabel = item.serviceLabel || SERVICE_LABELS[item.service] || item.service || '';

                        return `
                            <div style="padding: var(--space-3); background: var(--color-background); border-radius: var(--radius-button); margin-bottom: var(--space-2);">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <strong>${item.teil}</strong>
                                    ${serviceLabel ? `<span style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">${serviceLabel}</span>` : ''}
                                </div>
                                ${repairs.length > 0 ? `
                                    <div style="display: flex; flex-wrap: wrap; gap: var(--space-1); margin-top: var(--space-2);">
                                        ${repairs.map(r => `<span style="background: var(--color-primary); color: white; padding: 2px 8px; border-radius: 12px; font-size: var(--font-size-xs);">${r}</span>`).join('')}
                                    </div>
                                ` : '<div style="font-size: var(--font-size-xs); color: var(--color-text-secondary); margin-top: var(--space-1);">Keine Arbeiten zugewiesen</div>'}
                            </div>
                        `;
                    }).join('');

                    // Positionen zur aktuellenKalkulation hinzufÃ¼gen
                    generateKalkulationPositions(allParts);
                }
            }

            // Ersatzteile-Zusammenfassung
            const ersatzteileSummary = document.getElementById('step6ErsatzteileSummary');
            if (ersatzteileSummary) {
                if (kalkWizardData.ersatzteile.length === 0) {
                    ersatzteileSummary.innerHTML = '<p style="color: var(--color-text-secondary);">Keine Ersatzteile</p>';
                } else {
                    const total = kalkWizardData.ersatzteile.reduce((sum, e) => sum + ((e.preis || 0) * (e.menge || 1)), 0);
                    ersatzteileSummary.innerHTML = `
                        <div style="font-size: var(--font-size-sm);">
                            <strong>${kalkWizardData.ersatzteile.length} Ersatzteil(e)</strong>
                            <br>Gesamt: <strong style="color: var(--color-primary);">${total.toFixed(2)} â‚¬</strong>
                        </div>
                        <div style="margin-top: var(--space-2);">
                            ${kalkWizardData.ersatzteile.map(e => `
                                <div style="font-size: var(--font-size-xs); padding: var(--space-1) 0; border-bottom: 1px solid var(--color-border);">
                                    ${window.escapeHtml(e.name)} ${e.menge > 1 ? `(${e.menge}x)` : ''} - ${((e.preis || 0) * (e.menge || 1)).toFixed(2)} â‚¬
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            }

            // ðŸ†• Service-Details Zusammenfassung (fÃ¼r Folierung, Werbebeklebung, etc.)
            renderStep6ServiceDetails();

            // ðŸ†• Design-Galerie Zusammenfassung
            renderStep6DesignGallery();
        }

        // ðŸ†• Service-Details in Step 6 anzeigen
        function renderStep6ServiceDetails() {
            const section = document.getElementById('step6ServiceDetailsSection');
            const summary = document.getElementById('step6ServiceDetailsSummary');

            if (!section || !summary) return;

            const serviceDetails = kalkWizardData.serviceDetails || {};
            const serviceArt = kalkWizardData.serviceArt;
            const config = SERVICE_CONFIG[serviceArt];

            // Keine Service-Details vorhanden â†’ ausblenden
            if (Object.keys(serviceDetails).length === 0 || !config || !config.zusatzfelder) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';

            // Details formatieren
            let html = '<div class="service-details-list">';
            for (const [fieldId, value] of Object.entries(serviceDetails)) {
                if (value && typeof value !== 'object') { // Skip file arrays
                    const fieldConfig = config.zusatzfelder[fieldId];
                    const label = fieldConfig?.label || fieldId;

                    // Bei Select-Feldern: Label statt Value anzeigen
                    let displayValue = value;
                    if (fieldConfig?.typ === 'select' && fieldConfig?.options) {
                        const option = fieldConfig.options.find(o => o.value === value);
                        displayValue = option?.label || value;
                    }

                    html += `
                        <div class="service-details-row">
                            <span class="service-details-label">${label}:</span>
                            <span class="service-details-value">${displayValue}</span>
                        </div>
                    `;
                }
            }
            html += '</div>';

            summary.innerHTML = html;
        }

        // ðŸ†• Design-Galerie in Step 6 anzeigen
        function renderStep6DesignGallery() {
            const section = document.getElementById('step6DesignsSection');
            const gallery = document.getElementById('step6DesignGallery');

            if (!section || !gallery) return;

            // Alle Designs sammeln
            let allDesigns = [];
            for (const [fieldId, files] of Object.entries(uploadedDesignFiles)) {
                files.forEach(f => allDesigns.push({ ...f, fieldId }));
            }

            // Keine Designs vorhanden â†’ ausblenden
            if (allDesigns.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';

            gallery.innerHTML = allDesigns.map(file => {
                const isImage = file.type?.startsWith('image/');
                return `
                    <div class="step6-design-item">
                        ${isImage
                            ? `<img src="${file.base64}" alt="${file.name}" onclick="openDesignLightbox('${file.base64}')">`
                            : `<div class="step6-design-item__file">${getFileIcon(file.type)}</div>`
                        }
                        <div class="step6-design-item__info">
                            <div class="step6-design-item__name" title="${file.name}">${file.name}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ðŸ†• Design-Lightbox Ã¶ffnen
        function openDesignLightbox(base64) {
            // Einfaches Lightbox-Modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                cursor: pointer;
            `;
            modal.innerHTML = `<img src="${base64}" style="max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 8px;">`;
            modal.addEventListener('click', () => modal.remove());
            document.body.appendChild(modal);
        }

        // Alte Funktion fÃ¼r KompatibilitÃ¤t (wird jetzt von Step 6 aufgerufen)
        function updateStep5Summary() {
            updateStep6Summary();
        }

        function generateKalkulationPositions(allParts) {
            // Positionen aus den gewÃ¤hlten Teilen + Reparaturen generieren
            aktuelleKalkulation.positionen = [];
            aktuelleKalkulation.materialien = []; // Material zurÃ¼cksetzen
            aktuelleKalkulation.kundenName = kalkWizardData.fahrzeug.kunde;
            aktuelleKalkulation.kennzeichen = kalkWizardData.fahrzeug.kennzeichen;

            allParts.forEach(item => {
                // ðŸ†• Fallback: arbeiten â†’ reparaturen (Multi-Service Support)
                const repairs = item.reparaturen || item.arbeiten || [];
                repairs.forEach(repair => {
                    const positionName = `${item.teil} ${repair}`;

                    // Stunden und Stundensatz holen
                    const arbeitsDaten = getArbeitsDaten(item.teil, repair);

                    aktuelleKalkulation.positionen.push({
                        id: Date.now() + Math.random(),
                        name: positionName,
                        teil: item.teil,
                        arbeit: repair,
                        stunden: arbeitsDaten.stunden,
                        stundensatz: arbeitsDaten.stundensatz,
                        preis: arbeitsDaten.stunden * arbeitsDaten.stundensatz,
                        menge: 1
                    });

                    // Automatisch Material hinzufÃ¼gen
                    const materialListe = getMaterialFuerArbeit(item.teil, repair);
                    materialListe.forEach(mat => {
                        // PrÃ¼fen ob Material schon existiert
                        const existing = aktuelleKalkulation.materialien.find(m => m.name === mat.name);
                        if (existing) {
                            existing.menge += mat.menge;
                        } else {
                            aktuelleKalkulation.materialien.push({
                                id: Date.now() + Math.random(),
                                ...mat
                            });
                        }
                    });
                });
            });

            // Positionen und Material rendern
            renderPositionenNew();
            renderMaterialienNew();
            berechneGesamtsumme();
        }

        // Stunden und Stundensatz pro Arbeit/Teil
        function getArbeitsDaten(teil, arbeit) {
            // StundensÃ¤tze aus Einstellungen
            const stundensatzLack = kalkulationSaetze?.stundensatzLack || 85;
            const stundensatzKarosserie = kalkulationSaetze?.stundensatzKarosserie || 95;
            const stundensatzMechanik = kalkulationSaetze?.stundensatzMechanik || 85;

            // Standard-Arbeitszeiten (in Stunden) nach Arbeit und TeilgrÃ¶ÃŸe
            const arbeitszeiten = {
                'lackieren': {
                    'StoÃŸfÃ¤nger': 3.0, 'Motorhaube': 3.5, 'KotflÃ¼gel': 2.5, 'TÃ¼r': 3.0,
                    'Dach': 4.0, 'Heckklappe': 3.0, 'Seitenteil': 3.5, 'Schweller': 2.0,
                    'Seitenspiegel': 0.5, 'default': 2.5
                },
                'demontieren': {
                    'StoÃŸfÃ¤nger': 0.5, 'Motorhaube': 0.3, 'KotflÃ¼gel': 0.8, 'TÃ¼r': 0.5,
                    'Heckklappe': 0.4, 'Seitenspiegel': 0.2, 'default': 0.5
                },
                'montieren': {
                    'StoÃŸfÃ¤nger': 0.5, 'Motorhaube': 0.3, 'KotflÃ¼gel': 0.8, 'TÃ¼r': 0.5,
                    'Heckklappe': 0.4, 'Seitenspiegel': 0.2, 'default': 0.5
                },
                'grundieren': {
                    'default': 1.0
                },
                'spachteln': {
                    'klein': 0.5, 'mittel': 1.0, 'gross': 2.0, 'default': 1.0
                },
                'schleifen': {
                    'default': 0.75
                },
                'austauschen': {
                    'StoÃŸfÃ¤nger': 1.5, 'Motorhaube': 1.0, 'KotflÃ¼gel': 2.0, 'TÃ¼r': 2.5,
                    'Heckklappe': 1.5, 'Seitenspiegel': 0.5, 'default': 1.5
                },
                'spot-repair': {
                    'default': 1.5
                },
                'polieren': {
                    'default': 1.0
                },
                'ausbeulen': {
                    'klein': 1.0, 'mittel': 2.0, 'gross': 3.5, 'default': 2.0
                },
                'schweissen': {
                    'default': 1.5
                },
                'kleben': {
                    'default': 0.75
                }
            };

            // Stundensatz nach Arbeit
            const stundensatzMap = {
                'lackieren': stundensatzLack,
                'grundieren': stundensatzLack,
                'polieren': stundensatzLack,
                'spot-repair': stundensatzLack,
                'demontieren': stundensatzMechanik,
                'montieren': stundensatzMechanik,
                'austauschen': stundensatzKarosserie,
                'spachteln': stundensatzKarosserie,
                'schleifen': stundensatzKarosserie,
                'ausbeulen': stundensatzKarosserie,
                'schweissen': stundensatzKarosserie,
                'kleben': stundensatzKarosserie
            };

            // Stunden berechnen
            let stunden = 1.0;
            const arbeitZeiten = arbeitszeiten[arbeit] || {};

            // Suche nach passendem Teil
            for (const [key, value] of Object.entries(arbeitZeiten)) {
                if (key !== 'default' && teil.toLowerCase().includes(key.toLowerCase())) {
                    stunden = value;
                    break;
                }
            }
            if (stunden === 1.0 && arbeitZeiten.default) {
                stunden = arbeitZeiten.default;
            }

            return {
                stunden: stunden,
                stundensatz: stundensatzMap[arbeit] || 85
            };
        }

        // Material automatisch basierend auf Arbeit
        function getMaterialFuerArbeit(teil, arbeit) {
            const materialVorschlaege = {
                'lackieren': [
                    { name: 'Basislack (gemischt)', menge: 0.3, einheit: 'Liter', einzelpreis: 85, preis: 25.50 },
                    { name: 'Klarlack 2K', menge: 0.2, einheit: 'Liter', einzelpreis: 65, preis: 13.00 },
                    { name: 'HÃ¤rter', menge: 0.1, einheit: 'Liter', einzelpreis: 45, preis: 4.50 },
                    { name: 'VerdÃ¼nnung', menge: 0.1, einheit: 'Liter', einzelpreis: 25, preis: 2.50 }
                ],
                'grundieren': [
                    { name: 'FÃ¼ller/Grundierung 2K', menge: 0.2, einheit: 'Liter', einzelpreis: 55, preis: 11.00 },
                    { name: 'HÃ¤rter FÃ¼ller', menge: 0.1, einheit: 'Liter', einzelpreis: 40, preis: 4.00 }
                ],
                'spachteln': [
                    { name: 'Feinspachtel', menge: 0.15, einheit: 'kg', einzelpreis: 28, preis: 4.20 },
                    { name: 'HÃ¤rterpaste', menge: 0.02, einheit: 'kg', einzelpreis: 35, preis: 0.70 }
                ],
                'schleifen': [
                    { name: 'Schleifpapier Set (P80-P800)', menge: 1, einheit: 'Set', einzelpreis: 8.50, preis: 8.50 },
                    { name: 'Schleifvlies', menge: 2, einheit: 'StÃ¼ck', einzelpreis: 2.50, preis: 5.00 }
                ],
                'polieren': [
                    { name: 'Polierpaste Schleif', menge: 0.05, einheit: 'Liter', einzelpreis: 45, preis: 2.25 },
                    { name: 'Polierpaste Hochglanz', menge: 0.05, einheit: 'Liter', einzelpreis: 55, preis: 2.75 },
                    { name: 'Polierschwamm', menge: 1, einheit: 'StÃ¼ck', einzelpreis: 12, preis: 12.00 }
                ],
                'spot-repair': [
                    { name: 'Spot-Repair Lack Set', menge: 1, einheit: 'Set', einzelpreis: 35, preis: 35.00 },
                    { name: 'Spot-Blender', menge: 0.1, einheit: 'Liter', einzelpreis: 48, preis: 4.80 }
                ],
                'kleben': [
                    { name: 'Kunststoffkleber 2K', menge: 1, einheit: 'Set', einzelpreis: 28, preis: 28.00 },
                    { name: 'Kunststoff-Primer', menge: 0.05, einheit: 'Liter', einzelpreis: 38, preis: 1.90 }
                ],
                'schweissen': [
                    { name: 'SchweiÃŸdraht', menge: 0.5, einheit: 'kg', einzelpreis: 18, preis: 9.00 },
                    { name: 'SchweiÃŸgas CO2', menge: 1, einheit: 'Pauschale', einzelpreis: 15, preis: 15.00 }
                ],
                'demontieren': [
                    { name: 'Clips/Befestigungen (Reserve)', menge: 1, einheit: 'Set', einzelpreis: 8, preis: 8.00 }
                ],
                'montieren': [
                    { name: 'Clips/Befestigungen neu', menge: 1, einheit: 'Set', einzelpreis: 12, preis: 12.00 }
                ]
            };

            return materialVorschlaege[arbeit] || [];
        }

        function renderPositionenNew() {
            const container = document.getElementById('positionenListe');
            if (!container) return;

            if (aktuelleKalkulation.positionen.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i data-feather="clipboard"></i>
                        <h3>Keine Positionen</h3>
                        <p>Die Positionen werden automatisch aus Ihrer Auswahl generiert</p>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Position</th>
                                <th style="text-align: center;">Stunden</th>
                                <th style="text-align: center;">â‚¬/Std.</th>
                                <th style="text-align: right;">Preis</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            ${aktuelleKalkulation.positionen.map((pos, index) => `
                                <tr>
                                    <td>${pos.name}</td>
                                    <td style="text-align: center;">
                                        <input type="number"
                                               value="${pos.stunden.toFixed(2)}"
                                               step="0.25"
                                               min="0"
                                               onchange="updatePositionStunden(${index}, this.value)"
                                               style="width: 70px; text-align: center;">
                                    </td>
                                    <td style="text-align: center;">
                                        <input type="number"
                                               value="${pos.stundensatz.toFixed(2)}"
                                               step="5"
                                               min="0"
                                               onchange="updatePositionStundensatz(${index}, this.value)"
                                               style="width: 70px; text-align: center;">
                                    </td>
                                    <td style="text-align: right; font-weight: 600;">
                                        ${pos.preis.toFixed(2).replace('.', ',')} â‚¬
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-error" onclick="removePositionNew(${index})">
                                            <i data-feather="trash-2"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }

            feather.replace();
        }

        function renderMaterialienNew() {
            const container = document.getElementById('materialListe');
            if (!container) return;

            if (aktuelleKalkulation.materialien.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i data-feather="package"></i>
                        <h3>Kein Material</h3>
                        <p>Material wird automatisch basierend auf den Arbeiten hinzugefÃ¼gt</p>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Material</th>
                                <th style="text-align: center;">Menge</th>
                                <th style="text-align: center;">Einheit</th>
                                <th style="text-align: right;">Preis</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            ${aktuelleKalkulation.materialien.map((mat, index) => `
                                <tr>
                                    <td>${mat.name}</td>
                                    <td style="text-align: center;">
                                        <input type="number"
                                               value="${mat.menge}"
                                               step="0.1"
                                               min="0"
                                               onchange="updateMaterialMenge(${index}, this.value)"
                                               style="width: 60px; text-align: center;">
                                    </td>
                                    <td style="text-align: center;">${mat.einheit}</td>
                                    <td style="text-align: right;">
                                        <input type="number"
                                               value="${mat.preis.toFixed(2)}"
                                               step="0.50"
                                               min="0"
                                               onchange="updateMaterialPreis(${index}, this.value)"
                                               style="width: 80px; text-align: right;">
                                        â‚¬
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-error" onclick="removeMaterialNew(${index})">
                                            <i data-feather="trash-2"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }

            feather.replace();
        }

        function updatePositionStunden(index, value) {
            const pos = aktuelleKalkulation.positionen[index];
            pos.stunden = parseFloat(value) || 0;
            pos.preis = pos.stunden * pos.stundensatz;
            renderPositionenNew();
            berechneGesamtsumme();
        }

        function updatePositionStundensatz(index, value) {
            const pos = aktuelleKalkulation.positionen[index];
            pos.stundensatz = parseFloat(value) || 0;
            pos.preis = pos.stunden * pos.stundensatz;
            renderPositionenNew();
            berechneGesamtsumme();
        }

        function updatePositionPreis(index, value) {
            aktuelleKalkulation.positionen[index].preis = parseFloat(value) || 0;
            berechneGesamtsumme();
        }

        function removePositionNew(index) {
            aktuelleKalkulation.positionen.splice(index, 1);
            renderPositionenNew();
            berechneGesamtsumme();
        }

        function updateMaterialMenge(index, value) {
            const mat = aktuelleKalkulation.materialien[index];
            mat.menge = parseFloat(value) || 0;
            mat.preis = mat.menge * (mat.einzelpreis || mat.preis / (mat.menge || 1));
            renderMaterialienNew();
            berechneGesamtsumme();
        }

        function updateMaterialPreis(index, value) {
            aktuelleKalkulation.materialien[index].preis = parseFloat(value) || 0;
            renderMaterialienNew();
            berechneGesamtsumme();
        }

        function removeMaterialNew(index) {
            aktuelleKalkulation.materialien.splice(index, 1);
            renderMaterialienNew();
            berechneGesamtsumme();
        }

        // ============================================
        // ðŸ’° GESAMTSUMME BERECHNEN
        // ============================================

        function berechneGesamtsumme() {
            // Summe Arbeit (Positionen)
            const summeArbeit = aktuelleKalkulation.positionen.reduce((sum, p) => {
                const preis = parseFloat(p.preis) || 0;
                const menge = parseFloat(p.menge) || 1;
                return sum + (preis * menge);
            }, 0);

            // Summe Material
            // ðŸ”§ FIX Dec 2, 2025: m.preis IST bereits der Gesamtpreis (einzelpreis Ã— menge), NICHT nochmal multiplizieren!
            const summeMaterial = aktuelleKalkulation.materialien.reduce((sum, m) => {
                return sum + (parseFloat(m.preis) || parseFloat(m.verkaufspreis) || 0);
            }, 0);

            // Summe Ersatzteile (NEU!)
            const summeErsatzteile = (kalkWizardData.ersatzteile || []).reduce((sum, e) => {
                const preis = parseFloat(e.preis) || 0;
                const menge = parseFloat(e.menge) || 1;
                return sum + (preis * menge);
            }, 0);

            // ðŸš— Ersatzfahrzeug-Kosten (FIX: Nov 30, 2025)
            // Aus kalkWizardData oder Entwurf-Daten
            let summeErsatzfahrzeug = 0;
            const ersatzfahrzeugData = kalkWizardData.ersatzfahrzeug || kalkWizardData.fahrzeug?.kalkulationData?.ersatzfahrzeug;
            if (ersatzfahrzeugData && ersatzfahrzeugData.gesamt > 0) {
                summeErsatzfahrzeug = parseFloat(ersatzfahrzeugData.gesamt) || 0;
            }

            // Netto, MwSt, Brutto (jetzt inkl. Ersatzteile + Ersatzfahrzeug!)
            const summeNetto = summeArbeit + summeMaterial + summeErsatzteile + summeErsatzfahrzeug;
            const mwstSatz = kalkulationSaetze?.mwstSatz || 19;
            const mwst = summeNetto * (mwstSatz / 100);
            const summeBrutto = summeNetto + mwst;

            // UI aktualisieren
            const elSummeArbeit = document.getElementById('summeArbeit');
            const elSummeMaterial = document.getElementById('summeMaterial');
            const elSummeErsatzteile = document.getElementById('summeErsatzteile');
            const elSummeErsatzfahrzeug = document.getElementById('summeErsatzfahrzeug');
            const elErsatzfahrzeugRow = document.getElementById('ersatzfahrzeugSummaryRow');
            const elSummeNetto = document.getElementById('summeNetto');
            const elMwstSatz = document.getElementById('mwstSatzDisplay');
            const elSummeMwst = document.getElementById('summeMwst');
            const elSummeBrutto = document.getElementById('summeBrutto');

            if (elSummeArbeit) elSummeArbeit.textContent = summeArbeit.toFixed(2).replace('.', ',') + ' â‚¬';
            if (elSummeMaterial) elSummeMaterial.textContent = summeMaterial.toFixed(2).replace('.', ',') + ' â‚¬';
            if (elSummeErsatzteile) elSummeErsatzteile.textContent = summeErsatzteile.toFixed(2).replace('.', ',') + ' â‚¬';

            // ðŸš— Ersatzfahrzeug-Zeile ein-/ausblenden
            if (elErsatzfahrzeugRow && elSummeErsatzfahrzeug) {
                if (summeErsatzfahrzeug > 0) {
                    elErsatzfahrzeugRow.style.display = 'flex';
                    elSummeErsatzfahrzeug.textContent = summeErsatzfahrzeug.toFixed(2).replace('.', ',') + ' â‚¬';
                } else {
                    elErsatzfahrzeugRow.style.display = 'none';
                }
            }

            if (elSummeNetto) elSummeNetto.textContent = summeNetto.toFixed(2).replace('.', ',') + ' â‚¬';
            if (elMwstSatz) elMwstSatz.textContent = mwstSatz;
            if (elSummeMwst) elSummeMwst.textContent = mwst.toFixed(2).replace('.', ',') + ' â‚¬';
            if (elSummeBrutto) elSummeBrutto.textContent = summeBrutto.toFixed(2).replace('.', ',') + ' â‚¬';

            console.log('ðŸ’° Summen berechnet:', { summeArbeit, summeMaterial, summeErsatzteile, summeErsatzfahrzeug, summeNetto, mwst, summeBrutto });
        }

        // ============================================
        // ðŸš— FAHRZEUG-DIAGRAMM FUNKTIONEN
        // ============================================

        // ============================================
        // ðŸš— FAHRZEUGTYPEN KONFIGURATION
        // ============================================

        const VEHICLE_MODELS = {
            sedan: {
                id: '58c33766470d46e7b2aed542650494e5',
                name: 'Generic Sedan Car',
                author: 'MMC Works',
                url: 'https://sketchfab.com/3d-models/generic-sedan-car-58c33766470d46e7b2aed542650494e5'
            },
            suv: {
                id: '68341ef7bf3e4f83aa2777bfa2543719',
                name: 'Compact SUV Concept',
                author: 'MaG80',
                url: 'https://sketchfab.com/3d-models/compact-suv-concept-car-68341ef7bf3e4f83aa2777bfa2543719'
            },
            transporter: {
                id: '8c4e2162cea4498395cc5bc8064a6c20',
                name: 'Transporter Van',
                author: 'VIS-All-3D',
                url: 'https://sketchfab.com/3d-models/transporter-van-free-download-8c4e2162cea4498395cc5bc8064a6c20'
            },
            kombi: {
                id: 'aa0becb6e854422596cac6b21bf79787',
                name: '80s Station Wagon',
                author: 'Daniel Zhabotinsky',
                url: 'https://sketchfab.com/3d-models/80s-generic-usa-station-wagon-low-poly-model-aa0becb6e854422596cac6b21bf79787'
            }
        };

        let currentVehicleType = 'sedan';
        let sketchfabClient = null;
        let sketchfabApi = null;
        let nodeMap = {};

        // Mapping von 3D-Node-Namen zu deutschen Teile-Namen
        const NODE_TO_PART_MAPPING = {
            // Allgemeine Begriffe die in verschiedenen Modellen vorkommen kÃ¶nnen
            'hood': 'Motorhaube',
            'bonnet': 'Motorhaube',
            'motorhaube': 'Motorhaube',
            'bumper_front': 'StoÃŸfÃ¤nger vorne',
            'front_bumper': 'StoÃŸfÃ¤nger vorne',
            'bumper_rear': 'StoÃŸfÃ¤nger hinten',
            'rear_bumper': 'StoÃŸfÃ¤nger hinten',
            'door_fl': 'TÃ¼r vorne links',
            'door_fr': 'TÃ¼r vorne rechts',
            'door_rl': 'TÃ¼r hinten links',
            'door_rr': 'TÃ¼r hinten rechts',
            'door_front_left': 'TÃ¼r vorne links',
            'door_front_right': 'TÃ¼r vorne rechts',
            'door_rear_left': 'TÃ¼r hinten links',
            'door_rear_right': 'TÃ¼r hinten rechts',
            'fender_fl': 'KotflÃ¼gel vorne links',
            'fender_fr': 'KotflÃ¼gel vorne rechts',
            'fender': 'KotflÃ¼gel',
            'trunk': 'Heckklappe',
            'tailgate': 'Heckklappe',
            'roof': 'Dach',
            'body': 'Karosserie',
            'side_left': 'Seitenteil links',
            'side_right': 'Seitenteil rechts',
            'mirror': 'Spiegel',
            'window': 'Scheibe',
            'wheel': 'Rad',
            'tire': 'Reifen'
        };

        function initVehicleDiagram() {
            // Click handlers fÃ¼r alle Fahrzeugteile (2D)
            document.querySelectorAll('.vehicle-part').forEach(part => {
                part.addEventListener('click', (e) => {
                    const partName = e.target.dataset.part;
                    if (partName) {
                        // Neuer Wizard: selectVehiclePartNew statt selectVehiclePart
                        selectVehiclePartNew(partName, e.target);
                    }
                });
            });

            // Schnellsuche initialisieren
            initQuickSearch();

            // Feather Icons fÃ¼r Toggle-Buttons
            feather.replace();

            console.log('âœ… Fahrzeug-Diagramm initialisiert');
        }

        // ============================================
        // ðŸ”„ 2D/3D VIEW TOGGLE
        // ============================================

        function switchVehicleView(view) {
            const viewList = document.getElementById('vehicleListView');
            const view2D = document.getElementById('vehicle2DView');
            const view3D = document.getElementById('vehicle3DView');
            const viewFoto = document.getElementById('vehicleFotoView');
            const buttons = document.querySelectorAll('.view-toggle-btn');

            // Toggle Buttons aktualisieren
            buttons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });

            // Alle Views verstecken
            if (viewList) viewList.style.display = 'none';
            if (view2D) view2D.style.display = 'none';
            if (view3D) view3D.style.display = 'none';
            if (viewFoto) viewFoto.style.display = 'none';

            if (view === 'list') {
                viewList.style.display = 'block';
                // ðŸ†• Multi-Service Tabs und service-spezifische Teile laden
                renderStep3ServiceTabs();
            } else if (view === '3d') {
                view3D.style.display = 'block';
                // Sketchfab Viewer API initialisieren
                if (!sketchfabClient) {
                    initSketchfabViewerAPI();
                }
            } else if (view === 'foto') {
                viewFoto.style.display = 'block';
                initFotoDropzone();
                // ðŸ†• Entwurf-Fotos fÃ¼r KI-Analyse anzeigen
                renderEntwurfFotosForKI();
            } else {
                // 2D View
                view2D.style.display = 'flex';
            }

            feather.replace();
        }

        // Rendert die service-spezifischen Teile in Step 3
        // ðŸ†• Nov 30, 2025: Multi-Select Support
        function renderServiceParts() {
            const serviceArt = kalkWizardData.serviceArt;
            const config = SERVICE_CONFIG[serviceArt];
            const grid = document.getElementById('servicePartsGrid');
            const serviceName = document.getElementById('listServiceName');

            if (!config || !grid) return;

            // Service-Name anzeigen
            if (serviceName) {
                serviceName.textContent = SERVICE_LABELS[serviceArt] || serviceArt;
            }

            // Bereits ausgewÃ¤hlte Teile fÃ¼r diesen Service
            const selectedParts = kalkWizardData.teilePerService?.[serviceArt] || [];

            // Teile-Buttons generieren mit Multi-Select
            grid.innerHTML = config.teile.map(teil => {
                const isSelected = selectedParts.includes(teil);
                return `
                    <button class="service-part-btn ${isSelected ? 'selected' : ''}"
                            onclick="selectServicePart('${teil}', this)">
                        <span class="service-part-btn__icon">${getPartIcon(teil)}</span>
                        <span class="service-part-btn__label">${teil}</span>
                        ${isSelected ? '<span class="service-part-btn__check">âœ“</span>' : ''}
                    </button>
                `;
            }).join('');

            // AusgewÃ¤hlte Teile Anzeige aktualisieren
            updateSelectedPartsDisplay();
        }

        // ============================================
        // ðŸ†• MULTI-SERVICE TABS FÃœR STEP 3 (Nov 30, 2025)
        // ============================================

        /**
         * Rendert die Service-Tabs in Step 3 fÃ¼r Multi-Service AuftrÃ¤ge
         * Jeder Service hat seinen eigenen Tab mit service-spezifischen Teilen
         */
        function renderStep3ServiceTabs() {
            const tabsContainer = document.getElementById('step3ServiceTabs');
            const tabsInner = document.getElementById('step3ServiceTabsInner');
            const activeServiceName = document.getElementById('step3ActiveServiceName');

            if (!tabsContainer || !tabsInner) return;

            const services = kalkWizardData.services || [kalkWizardData.serviceArt];
            const isMultiService = kalkWizardData.isMultiService && services.length > 1;

            // Tabs nur bei Multi-Service anzeigen
            if (!isMultiService) {
                tabsContainer.style.display = 'none';
                // Trotzdem Service-Parts rendern fÃ¼r Single-Service
                renderServiceParts();
                return;
            }

            tabsContainer.style.display = 'block';

            // Aktiven Service-Index aus kalkWizardData oder default 0
            if (kalkWizardData.step3ActiveServiceIndex === undefined) {
                kalkWizardData.step3ActiveServiceIndex = 0;
            }

            // Teile pro Service tracken (falls nicht vorhanden)
            if (!kalkWizardData.teilePerService) {
                kalkWizardData.teilePerService = {};
            }

            // Tabs HTML generieren
            tabsInner.innerHTML = services.map((service, index) => {
                const serviceLabel = SERVICE_LABELS[service] || service;
                const isActive = index === kalkWizardData.step3ActiveServiceIndex;
                const teileCount = (kalkWizardData.teilePerService[service] || []).length;

                return `
                    <button class="service-tab ${isActive ? 'active' : ''}"
                            onclick="switchStep3ServiceTab(${index})"
                            data-service="${service}">
                        <span class="service-tab__icon">${getServiceIcon(service)}</span>
                        <span>${serviceLabel}</span>
                        ${teileCount > 0 ? `<span class="service-tab__badge">${teileCount}</span>` : ''}
                    </button>
                `;
            }).join('');

            // Aktiven Service-Namen anzeigen
            const activeService = services[kalkWizardData.step3ActiveServiceIndex];
            if (activeServiceName) {
                activeServiceName.textContent = SERVICE_LABELS[activeService] || activeService;
            }

            // Service-Art fÃ¼r aktiven Tab setzen und Teile rendern
            kalkWizardData.serviceArt = activeService;
            renderServiceParts();

            feather.replace();
        }

        /**
         * Wechselt den aktiven Service-Tab in Step 3
         */
        function switchStep3ServiceTab(index) {
            const services = kalkWizardData.services || [kalkWizardData.serviceArt];

            if (index < 0 || index >= services.length) return;

            // Vorherigen Service-Teile speichern
            const previousService = services[kalkWizardData.step3ActiveServiceIndex];
            if (kalkWizardData.currentPart) {
                // Aktuelles Teil zum vorherigen Service speichern (falls vorhanden)
                if (!kalkWizardData.teilePerService[previousService]) {
                    kalkWizardData.teilePerService[previousService] = [];
                }
                // Nur hinzufÃ¼gen wenn noch nicht vorhanden
                if (!kalkWizardData.teilePerService[previousService].includes(kalkWizardData.currentPart)) {
                    // Hinweis: Teile werden beim HinzufÃ¼gen in Step 4 gespeichert, nicht hier
                }
            }

            // Index aktualisieren
            kalkWizardData.step3ActiveServiceIndex = index;

            // Tabs neu rendern
            renderStep3ServiceTabs();

            // Current Part zurÃ¼cksetzen
            kalkWizardData.currentPart = null;
            const display = document.getElementById('selectedPartDisplay');
            if (display) display.style.display = 'none';

            // Toast-Feedback
            const newService = services[index];
            showToast(`Service gewechselt: ${SERVICE_LABELS[newService] || newService}`, 'info');
        }

        /**
         * Gibt ein Icon fÃ¼r einen Service zurÃ¼ck
         */
        function getServiceIcon(service) {
            const iconMap = {
                'lackier': 'ðŸŽ¨',
                'lackierung': 'ðŸŽ¨',
                'versicherung': 'ðŸ“‹',
                'dellen': 'ðŸ”¨',
                'glas': 'ðŸªŸ',
                'reifen': 'ðŸ›ž',
                'mechanik': 'ðŸ”§',
                'pflege': 'âœ¨',
                'tuev': 'ðŸ“',
                'klima': 'â„ï¸',
                'folierung': 'ðŸŽ­',
                'steinschutz': 'ðŸ›¡ï¸',
                'werbebeklebung': 'ðŸ“¢'
            };
            return iconMap[service] || 'ðŸ“¦';
        }

        // Icon fÃ¼r ein Teil basierend auf Namen
        function getPartIcon(teil) {
            const iconMap = {
                // Karosserie
                'StoÃŸfÃ¤nger': 'ðŸ›¡ï¸', 'Motorhaube': 'ðŸš—', 'KotflÃ¼gel': 'ðŸš™', 'TÃ¼r': 'ðŸšª',
                'Seitenwand': 'ðŸ“', 'Dach': 'â¬›', 'Heckklappe': 'ðŸš—', 'Schweller': 'âž–',
                'SÃ¤ule': 'ðŸ›ï¸', 'Spiegel': 'ðŸªž', 'Rahmen': 'ðŸ”²', 'Karosserie': 'ðŸš—',
                // Glas
                'Frontscheibe': 'ðŸªŸ', 'Heckscheibe': 'ðŸªŸ', 'Seitenscheibe': 'ðŸªŸ',
                'Scheibe': 'ðŸªŸ', 'Panoramadach': 'â˜€ï¸', 'Dreiecksfenster': 'ðŸ”º',
                // Reifen
                'Reifen': 'ðŸ›ž', 'Felge': 'âš™ï¸', 'Ersatzrad': 'ðŸ›ž',
                // Mechanik
                'Motor': 'âš¡', 'Getriebe': 'âš™ï¸', 'Bremsen': 'ðŸ›‘', 'Kupplung': 'ðŸ”„',
                'Auspuff': 'ðŸ’¨', 'Lenkung': 'ðŸŽ®', 'Fahrwerk': 'ðŸ”§', 'Achse': 'ðŸ”—',
                'Anlasser': 'ðŸ”‹', 'Lichtmaschine': 'ðŸ’¡', 'Batterie': 'ðŸ”‹',
                'Pumpe': 'ðŸ’§', 'Zahnriemen': 'âž°', 'Keilriemen': 'âž°',
                // Klima
                'Klimakompressor': 'â„ï¸', 'Kondensator': 'ðŸŒ¡ï¸', 'Verdampfer': 'ðŸ’¨',
                'Trockner': 'ðŸŒ¬ï¸', 'Leitungen': 'ðŸ”—', 'Innenraumfilter': 'ðŸŒ¬ï¸',
                // Pflege
                'AuÃŸen': 'âœ¨', 'Innenraum': 'ðŸ›‹ï¸', 'Motorraum': 'ðŸ”§',
                'Lack': 'ðŸŽ¨', 'Leder': 'ðŸª‘', 'Kunststoffe': 'ðŸ§±',
                // TÃœV
                'Beleuchtung': 'ðŸ’¡', 'Abgasanlage': 'ðŸ’¨', 'Elektronik': 'âš¡',
                // Folierung
                'Fahrzeug komplett': 'ðŸš—', 'SeitenflÃ¤chen': 'ðŸ“', 'Heck': 'ðŸ”™',
                'Einstiege': 'ðŸšª', 'Dachkanten': 'ðŸ“', 'TÃ¼rkanten': 'ðŸ“',
                // Default
                'default': 'ðŸ“¦'
            };

            // Suche nach passendem Icon basierend auf Teilname
            for (const [key, icon] of Object.entries(iconMap)) {
                if (teil.toLowerCase().includes(key.toLowerCase())) {
                    return icon;
                }
            }
            return iconMap.default;
        }

        // Service-Teil auswÃ¤hlen (aus Liste)
        // ðŸ†• Nov 30, 2025: Multi-Select Support - Mehrere Teile pro Service
        function selectServicePart(partName, element) {
            const currentService = kalkWizardData.serviceArt;

            // teilePerService initialisieren
            if (!kalkWizardData.teilePerService) {
                kalkWizardData.teilePerService = {};
            }
            if (!kalkWizardData.teilePerService[currentService]) {
                kalkWizardData.teilePerService[currentService] = [];
            }

            const serviceParts = kalkWizardData.teilePerService[currentService];

            // Toggle: Teil hinzufÃ¼gen oder entfernen
            const existingIndex = serviceParts.indexOf(partName);
            if (existingIndex > -1) {
                // Teil entfernen
                serviceParts.splice(existingIndex, 1);
                if (element) element.classList.remove('selected');
                showToast(`Teil "${partName}" entfernt`, 'info');
            } else {
                // Teil hinzufÃ¼gen
                serviceParts.push(partName);
                if (element) element.classList.add('selected');
                showToast(`Teil "${partName}" hinzugefÃ¼gt`, 'success');
            }

            // Auch currentPart setzen (fÃ¼r KompatibilitÃ¤t mit Step 4)
            kalkWizardData.currentPart = serviceParts.length > 0 ? serviceParts[serviceParts.length - 1] : null;

            // AusgewÃ¤hlte Teile Anzeige aktualisieren
            updateSelectedPartsDisplay();

            // Tabs Badge aktualisieren
            updateStep3TabsBadge();

            // Weiter-Button aktivieren wenn mindestens ein Teil in irgendeinem Service
            updateStep3NextButton();

            feather.replace();
        }

        /**
         * ðŸ†• Aktualisiert die Anzeige der ausgewÃ¤hlten Teile
         */
        function updateSelectedPartsDisplay() {
            const display = document.getElementById('selectedPartDisplay');
            const nameSpan = document.getElementById('selectedPartName');

            if (!display || !nameSpan) return;

            const currentService = kalkWizardData.serviceArt;
            const serviceParts = kalkWizardData.teilePerService?.[currentService] || [];

            if (serviceParts.length > 0) {
                display.style.display = 'flex';
                if (serviceParts.length === 1) {
                    nameSpan.textContent = serviceParts[0];
                } else {
                    nameSpan.textContent = `${serviceParts.length} Teile ausgewÃ¤hlt`;
                }
            } else {
                display.style.display = 'none';
            }
        }

        /**
         * ðŸ†• Aktualisiert die Badge-Zahlen in den Service-Tabs
         */
        function updateStep3TabsBadge() {
            const tabs = document.querySelectorAll('#step3ServiceTabsInner .service-tab');
            tabs.forEach(tab => {
                const service = tab.dataset.service;
                const count = (kalkWizardData.teilePerService?.[service] || []).length;
                let badge = tab.querySelector('.service-tab__badge');

                if (count > 0) {
                    if (!badge) {
                        badge = document.createElement('span');
                        badge.className = 'service-tab__badge';
                        tab.appendChild(badge);
                    }
                    badge.textContent = count;
                } else if (badge) {
                    badge.remove();
                }
            });
        }

        /**
         * ðŸ†• Aktualisiert den Weiter-Button in Step 3
         * Aktiviert wenn mindestens ein Teil in irgendeinem Service ausgewÃ¤hlt ist
         */
        function updateStep3NextButton() {
            const nextBtn = document.getElementById('btnStep3Next');
            if (!nextBtn) return;

            // ZÃ¤hle alle Teile Ã¼ber alle Services
            let totalParts = 0;
            if (kalkWizardData.teilePerService) {
                for (const service of Object.keys(kalkWizardData.teilePerService)) {
                    totalParts += kalkWizardData.teilePerService[service].length;
                }
            }

            nextBtn.disabled = totalParts === 0;
        }

        /**
         * ðŸ†• FÃ¼hrt alle Teile aus teilePerService in kalkWizardData.teile zusammen
         * Wird aufgerufen beim Wechsel von Step 3 zu Step 4
         */
        function mergeTeilePerServiceIntoTeile() {
            if (!kalkWizardData.teilePerService) return;

            // Bestehende teile Array leeren (um Duplikate zu vermeiden)
            kalkWizardData.teile = [];

            // Alle Teile aus teilePerService hinzufÃ¼gen
            for (const [service, parts] of Object.entries(kalkWizardData.teilePerService)) {
                for (const partName of parts) {
                    // PrÃ¼fen ob Teil bereits existiert (sollte nicht, aber sicherheitshalber)
                    const exists = kalkWizardData.teile.some(t =>
                        t.teil === partName && t.service === service
                    );

                    if (!exists) {
                        kalkWizardData.teile.push({
                            teil: partName,
                            service: service,
                            serviceLabel: SERVICE_LABELS[service] || service,
                            arbeiten: [], // Wird in Step 4 befÃ¼llt
                            addedAt: new Date().toISOString()
                        });
                    }
                }
            }

            console.log('ðŸ“¦ Teile zusammengefÃ¼hrt:', kalkWizardData.teile);

            // Ersten Teil als currentPart setzen fÃ¼r Step 4
            if (kalkWizardData.teile.length > 0) {
                kalkWizardData.currentPart = kalkWizardData.teile[0].teil;
                kalkWizardData.serviceArt = kalkWizardData.teile[0].service;
                kalkWizardData.step4ActivePartIndex = 0;
            }
        }

        /**
         * ðŸ†• Nov 30, 2025: Rendert die Teile-Tabs in Step 4 fÃ¼r Multi-Service
         * Zeigt alle ausgewÃ¤hlten Teile aus allen Services
         */
        function renderStep4PartsTabs() {
            const overview = document.getElementById('step4PartsOverview');
            const tabsContainer = document.getElementById('step4PartsTabs');
            const countSpan = document.getElementById('step4PartsCount');
            const partDisplay = document.getElementById('step4PartDisplay');
            const serviceDisplay = document.getElementById('step4PartService');

            if (!overview || !tabsContainer) return;

            const teile = kalkWizardData.teile || [];

            // Nur bei mehr als 1 Teil die Ãœbersicht anzeigen
            if (teile.length <= 1) {
                overview.style.display = 'none';
                // Standard-Anzeige fÃ¼r einzelnes Teil
                if (teile.length === 1) {
                    if (partDisplay) partDisplay.textContent = teile[0].teil;
                    if (serviceDisplay) serviceDisplay.textContent = `(${teile[0].serviceLabel || SERVICE_LABELS[teile[0].service] || teile[0].service})`;
                }
                return;
            }

            overview.style.display = 'block';
            if (countSpan) countSpan.textContent = teile.length;

            // Aktiven Index setzen
            if (kalkWizardData.step4ActivePartIndex === undefined) {
                kalkWizardData.step4ActivePartIndex = 0;
            }

            // Tabs generieren
            tabsContainer.innerHTML = teile.map((teil, index) => {
                const isActive = index === kalkWizardData.step4ActivePartIndex;
                const hasArbeiten = teil.arbeiten && teil.arbeiten.length > 0;
                const serviceLabel = teil.serviceLabel || SERVICE_LABELS[teil.service] || teil.service;
                const partIcon = getPartIcon(teil.teil);

                return `
                    <button class="step4-part-tab ${isActive ? 'active' : ''} ${hasArbeiten ? 'completed' : ''}"
                            onclick="switchStep4Part(${index})"
                            data-index="${index}">
                        <span class="step4-part-tab__icon">${partIcon}</span>
                        <span>${teil.teil}</span>
                        <span class="step4-part-tab__service">${serviceLabel}</span>
                        <span class="step4-part-check">âœ“</span>
                    </button>
                `;
            }).join('');

            // Aktuelles Teil anzeigen
            const currentTeil = teile[kalkWizardData.step4ActivePartIndex];
            if (currentTeil) {
                if (partDisplay) partDisplay.textContent = currentTeil.teil;
                if (serviceDisplay) {
                    const label = currentTeil.serviceLabel || SERVICE_LABELS[currentTeil.service] || currentTeil.service;
                    serviceDisplay.textContent = `(${label})`;
                }
                // serviceArt aktualisieren fÃ¼r die Arbeiten-Auswahl
                kalkWizardData.serviceArt = currentTeil.service;
                kalkWizardData.currentPart = currentTeil.teil;
            }

            feather.replace();
        }

        /**
         * ðŸ†• Nov 30, 2025: Wechselt das aktive Teil in Step 4
         */
        function switchStep4Part(index) {
            const teile = kalkWizardData.teile || [];
            if (index < 0 || index >= teile.length) return;

            // Vorherige Arbeiten speichern
            saveCurrentPartArbeiten();

            // Index aktualisieren
            kalkWizardData.step4ActivePartIndex = index;

            // UI aktualisieren
            renderStep4PartsTabs();
            renderServiceRepairOptions();

            // Gespeicherte Arbeiten wiederherstellen
            restorePartArbeiten(index);

            // Toast-Feedback
            showToast(`Teil gewechselt: ${teile[index].teil}`, 'info');
        }

        /**
         * ðŸ†• Speichert die aktuell ausgewÃ¤hlten Arbeiten fÃ¼r das aktive Teil
         */
        function saveCurrentPartArbeiten() {
            const teile = kalkWizardData.teile || [];
            const index = kalkWizardData.step4ActivePartIndex;

            if (index === undefined || index < 0 || index >= teile.length) return;

            const checkedRepairs = document.querySelectorAll('input[name="repair"]:checked');
            const arbeiten = Array.from(checkedRepairs).map(cb => cb.value);

            teile[index].arbeiten = arbeiten;
            console.log(`ðŸ’¾ Arbeiten gespeichert fÃ¼r Teil ${index}:`, arbeiten);
        }

        /**
         * ðŸ†• Stellt die gespeicherten Arbeiten fÃ¼r ein Teil wieder her
         */
        function restorePartArbeiten(index) {
            const teile = kalkWizardData.teile || [];
            if (index < 0 || index >= teile.length) return;

            const teil = teile[index];
            const arbeiten = teil.arbeiten || [];

            // Alle Checkboxen zurÃ¼cksetzen
            document.querySelectorAll('input[name="repair"]').forEach(cb => {
                cb.checked = arbeiten.includes(cb.value);
            });

            // Button-Status aktualisieren
            updateRepairSelection();

            console.log(`ðŸ“¥ Arbeiten wiederhergestellt fÃ¼r Teil ${index}:`, arbeiten);
        }

        // Rendert die service-spezifischen Arbeiten in Step 4
        function renderServiceRepairOptions() {
            const serviceArt = kalkWizardData.serviceArt;
            const config = SERVICE_CONFIG[serviceArt];
            const grid = document.getElementById('repairOptionsGrid');

            if (!config || !grid) return;

            // Icons fÃ¼r Arbeiten
            const arbeitIcons = {
                'lackieren': 'ðŸŽ¨', 'grundieren': 'ðŸ–Œï¸', 'spachteln': 'ðŸª£', 'schleifen': 'ðŸ“',
                'polieren': 'ðŸ’Ž', 'demontieren': 'ðŸ”§', 'montieren': 'ðŸ”©', 'austauschen': 'ðŸ”„',
                'ersetzen': 'â™»ï¸', // NEU: Teil komplett ersetzen
                'richten': 'ðŸ”¨', 'schweissen': 'âš¡', 'kleben': 'ðŸ§´', 'ausbeulen': 'ðŸ”¨',
                'drÃ¼cken': 'ðŸ‘†', 'reparieren': 'ðŸ”§', 'steinschlag-reparatur': 'ðŸªŸ',
                'kalibrieren': 'ðŸ“¡', 'wechseln': 'ðŸ”„', 'auswuchten': 'âš–ï¸',
                'einstellen': 'ðŸŽšï¸', 'prÃ¼fen': 'âœ…', 'befÃ¼llen': 'ðŸ’§', 'desinfizieren': 'ðŸ§¼',
                'reinigen': 'ðŸ§¹', 'waschen': 'ðŸ’¦', 'versiegeln': 'ðŸ›¡ï¸', 'aufbereiten': 'âœ¨',
                'pflegen': 'ðŸ’–', 'folieren': 'ðŸ“‹', 'entfolieren': 'âŒ', 'vorbereiten': 'ðŸ“',
                'schneiden': 'âœ‚ï¸', 'bekleben': 'ðŸ“‹', 'entfernen': 'ðŸ—‘ï¸', 'gestalten': 'ðŸŽ¨',
                'drucken': 'ðŸ–¨ï¸'
            };

            // Arbeiten-Checkboxen generieren
            grid.innerHTML = config.arbeiten.map(arbeit => `
                <label class="repair-option">
                    <input type="checkbox" name="repair" value="${arbeit}" onchange="updateRepairSelection()">
                    <div class="repair-option__content">
                        <span class="repair-option__icon">${arbeitIcons[arbeit] || 'ðŸ”§'}</span>
                        <span class="repair-option__label">${arbeit.charAt(0).toUpperCase() + arbeit.slice(1).replace('-', ' ')}</span>
                    </div>
                </label>
            `).join('');

            // Button deaktivieren bis Auswahl getroffen
            const nextBtn = document.getElementById('btnStep4Next');
            if (nextBtn) nextBtn.disabled = true;
        }

        // ============================================
        // ðŸŽ® SKETCHFAB VIEWER API
        // ============================================

        function initSketchfabViewerAPI() {
            const container = document.getElementById('sketchfabApiContainer');
            const modelData = VEHICLE_MODELS[currentVehicleType];

            // Iframe fÃ¼r Viewer API erstellen
            const iframe = document.createElement('iframe');
            iframe.id = 'api-frame';
            iframe.style.width = '100%';
            iframe.style.height = '100%';
            iframe.style.border = 'none';
            iframe.allow = 'autoplay; fullscreen; xr-spatial-tracking';

            // Loading-Spinner entfernen und Iframe einfÃ¼gen
            const loading = document.getElementById('sketchfabLoading');
            if (loading) loading.style.display = 'block';

            container.appendChild(iframe);

            // Sketchfab Client initialisieren
            sketchfabClient = new Sketchfab(iframe);

            sketchfabClient.init(modelData.id, {
                success: function(api) {
                    sketchfabApi = api;
                    api.start();
                    api.addEventListener('viewerready', function() {
                        console.log('âœ… Sketchfab Viewer API bereit');

                        // Loading verstecken
                        if (loading) loading.style.display = 'none';

                        // Klick-Hinweis anzeigen
                        document.getElementById('clickHint').style.display = 'block';

                        // Node Map laden fÃ¼r Teile-Namen
                        api.getNodeMap(function(err, nodes) {
                            if (!err) {
                                nodeMap = nodes;
                                console.log('ðŸ“‹ Node Map geladen:', Object.keys(nodes).length, 'Nodes');
                            }
                        });

                        // Click Event Handler
                        api.addEventListener('click', function(info) {
                            if (info.instanceID) {
                                handleModelClick(info);
                            }
                        }, { pick: 'slow' });

                        feather.replace();
                    });
                },
                error: function() {
                    console.error('âŒ Sketchfab Viewer API Fehler');
                    if (loading) {
                        loading.innerHTML = '<p style="color: var(--color-error);">âŒ 3D-Modell konnte nicht geladen werden</p>';
                    }
                },
                autostart: 1,
                preload: 1,
                ui_controls: 1,
                ui_infos: 0,
                ui_stop: 0,
                ui_watermark: 0
            });

            // Credit aktualisieren
            updateModelCredit(modelData);
        }

        function handleModelClick(info) {
            // Node-Name aus der Node Map holen
            let nodeName = 'Unbekannt';
            let partName = null;

            // Suche nach dem geklickten Node
            for (const [id, node] of Object.entries(nodeMap)) {
                if (node.instanceID === info.instanceID) {
                    nodeName = node.name || 'Node ' + id;
                    break;
                }
            }

            console.log('ðŸŽ¯ Geklickt auf:', nodeName, '(ID:', info.instanceID, ')');

            // Versuche Node-Namen auf deutsches Teil zu mappen
            const lowerName = nodeName.toLowerCase();
            for (const [key, value] of Object.entries(NODE_TO_PART_MAPPING)) {
                if (lowerName.includes(key)) {
                    partName = value;
                    break;
                }
            }

            // Wenn kein Mapping gefunden, versuche intelligente Erkennung
            if (!partName) {
                partName = guessPartFromNodeName(nodeName);
            }

            // UI aktualisieren
            const clickedInfo = document.getElementById('clickedPartInfo');
            const clickedName = document.getElementById('clickedPartName');

            if (partName) {
                clickedInfo.style.display = 'block';
                clickedName.textContent = partName;
                feather.replace();

                // Nach kurzer VerzÃ¶gerung Wizard Ã¶ffnen
                setTimeout(() => {
                    selectedPart = partName;
                    openDamageWizard(partName);
                }, 500);
            } else {
                // Zeige zumindest den Node-Namen
                clickedInfo.style.display = 'block';
                clickedInfo.style.background = 'var(--color-warning-bg)';
                clickedInfo.style.borderColor = 'var(--color-warning)';
                clickedName.textContent = nodeName + ' (nicht zugeordnet)';
                feather.replace();
            }
        }

        function guessPartFromNodeName(name) {
            const lower = name.toLowerCase();

            // Intelligente Erkennung basierend auf SchlÃ¼sselwÃ¶rtern
            if (lower.includes('tÃ¼r') || lower.includes('door')) {
                if (lower.includes('vorne') || lower.includes('front') || lower.includes('fl') || lower.includes('fr')) {
                    if (lower.includes('links') || lower.includes('left') || lower.includes('fl') || lower.includes('_l')) {
                        return 'TÃ¼r vorne links';
                    } else if (lower.includes('rechts') || lower.includes('right') || lower.includes('fr') || lower.includes('_r')) {
                        return 'TÃ¼r vorne rechts';
                    }
                    return 'TÃ¼r vorne';
                } else if (lower.includes('hinten') || lower.includes('rear') || lower.includes('rl') || lower.includes('rr')) {
                    if (lower.includes('links') || lower.includes('left') || lower.includes('rl') || lower.includes('_l')) {
                        return 'TÃ¼r hinten links';
                    } else if (lower.includes('rechts') || lower.includes('right') || lower.includes('rr') || lower.includes('_r')) {
                        return 'TÃ¼r hinten rechts';
                    }
                    return 'TÃ¼r hinten';
                }
                return 'TÃ¼r';
            }

            if (lower.includes('stoÃŸ') || lower.includes('bumper')) {
                if (lower.includes('vorne') || lower.includes('front')) return 'StoÃŸfÃ¤nger vorne';
                if (lower.includes('hinten') || lower.includes('rear')) return 'StoÃŸfÃ¤nger hinten';
                return 'StoÃŸfÃ¤nger';
            }

            if (lower.includes('motorhaube') || lower.includes('hood') || lower.includes('bonnet')) return 'Motorhaube';
            if (lower.includes('kotflÃ¼gel') || lower.includes('fender') || lower.includes('wing')) return 'KotflÃ¼gel';
            if (lower.includes('dach') || lower.includes('roof')) return 'Dach';
            if (lower.includes('heck') || lower.includes('trunk') || lower.includes('tailgate') || lower.includes('boot')) return 'Heckklappe';
            if (lower.includes('spiegel') || lower.includes('mirror')) return 'Spiegel';
            if (lower.includes('schweller') || lower.includes('sill') || lower.includes('rocker')) return 'Schweller';
            if (lower.includes('seite') || lower.includes('side')) {
                if (lower.includes('links') || lower.includes('left')) return 'Seitenteil links';
                if (lower.includes('rechts') || lower.includes('right')) return 'Seitenteil rechts';
                return 'Seitenteil';
            }

            return null;
        }

        // ============================================
        // ðŸš™ FAHRZEUGTYP WECHSELN
        // ============================================

        function changeVehicleType(type) {
            if (type === currentVehicleType) return;

            currentVehicleType = type;

            // Buttons aktualisieren
            document.querySelectorAll('.vehicle-type-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.type === type);
            });

            // Viewer neu laden
            const container = document.getElementById('sketchfabApiContainer');
            const existingFrame = document.getElementById('api-frame');
            if (existingFrame) {
                existingFrame.remove();
            }

            // Loading wieder anzeigen
            const loading = document.getElementById('sketchfabLoading');
            if (loading) {
                loading.style.display = 'block';
                loading.innerHTML = `
                    <div class="spinner" style="width: 40px; height: 40px; border: 3px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px;"></div>
                    <p style="color: var(--color-text-secondary); font-size: var(--font-size-sm);">3D-Modell wird geladen...</p>
                `;
            }

            // Klick-Info zurÃ¼cksetzen
            document.getElementById('clickedPartInfo').style.display = 'none';
            document.getElementById('clickHint').style.display = 'none';

            // Sketchfab Client zurÃ¼cksetzen
            sketchfabClient = null;
            sketchfabApi = null;
            nodeMap = {};

            // Neuen Viewer initialisieren
            initSketchfabViewerAPI();

            console.log('ðŸ”„ Fahrzeugtyp gewechselt zu:', type);
        }

        function updateModelCredit(modelData) {
            const link = document.getElementById('modelLink');
            const author = document.getElementById('modelAuthor');

            if (link) {
                link.href = modelData.url;
                link.textContent = modelData.name;
            }
            if (author) {
                author.textContent = modelData.author;
            }
        }

        // ============================================
        // ðŸ¤– KI-MODELL DROPDOWN
        // ============================================

        function toggleAIDropdown() {
            const dropdown = document.getElementById('aiDropdown');
            if (dropdown) {
                const isVisible = dropdown.style.display === 'block';
                dropdown.style.display = isVisible ? 'none' : 'block';
            }
        }

        // Dropdown schlieÃŸen wenn auÃŸerhalb geklickt wird
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('aiDropdown');
            const aiBtn = event.target.closest('.ai-btn');

            if (dropdown && !aiBtn && !event.target.closest('.ai-dropdown-content')) {
                dropdown.style.display = 'none';
            }
        });

        // ============================================
        // ðŸ” OE-NUMMERN ERSATZTEILE-SUCHE
        // ============================================

        let oeSearchTimeout = null;

        function initOeSearch() {
            // PrÃ¼fe ob ERSATZTEILE_DB verfÃ¼gbar ist
            const oeSearchStats = document.getElementById('oeSearchStats');
            if (typeof ERSATZTEILE_DB === 'undefined') {
                console.error('âŒ ERSATZTEILE_DB nicht geladen');
                if (oeSearchStats) oeSearchStats.textContent = 'Datenbank nicht verfÃ¼gbar';
                return;
            }

            // Statistiken anzeigen
            const stats = ERSATZTEILE_DB.getStatistiken();
            if (oeSearchStats) {
                oeSearchStats.textContent =
                    `${stats.marken} Marken | ${stats.modelle} Modelle | ${stats.oeNummern} OE-Nummern`;
            }

            // Marken-Dropdown befÃ¼llen
            const markeSelect = document.getElementById('oeMarkeSelect');
            if (markeSelect) {
                markeSelect.innerHTML = '<option value="">Alle Marken</option>';

                Object.keys(ERSATZTEILE_DB.marken).sort().forEach(markenKey => {
                    const marke = ERSATZTEILE_DB.marken[markenKey];
                    const option = document.createElement('option');
                    option.value = markenKey;
                    option.textContent = marke.name;
                    markeSelect.appendChild(option);
                });
            }

            console.log('âœ… OE-Suche initialisiert:', stats);
        }

        function updateOeModelle() {
            const markeSelect = document.getElementById('oeMarkeSelect');
            const modellSelect = document.getElementById('oeModellSelect');
            if (!markeSelect || !modellSelect) return;

            const markeKey = markeSelect.value;
            modellSelect.innerHTML = '<option value="">Alle Modelle</option>';

            if (markeKey && ERSATZTEILE_DB?.marken?.[markeKey]) {
                const marke = ERSATZTEILE_DB.marken[markeKey];
                Object.keys(marke.modelle).sort().forEach(modellKey => {
                    const modell = marke.modelle[modellKey];
                    const option = document.createElement('option');
                    option.value = modellKey;
                    option.textContent = `${modell.name} (${modell.baujahre})`;
                    modellSelect.appendChild(option);
                });
            }

            performOeSearch();
        }

        function performOeSearch() {
            // Debounce fÃ¼r Performance
            clearTimeout(oeSearchTimeout);
            oeSearchTimeout = setTimeout(() => {
                executeOeSearch();
            }, 200);
        }

        function executeOeSearch() {
            const searchInputEl = document.getElementById('oeSearchInput');
            const markeSelectEl = document.getElementById('oeMarkeSelect');
            const modellSelectEl = document.getElementById('oeModellSelect');
            const resultsContainer = document.getElementById('oeResults');

            // Falls DOM-Elemente nicht existieren, abbrechen
            if (!resultsContainer) return;

            const searchInput = searchInputEl?.value?.trim() || '';
            const markeKey = markeSelectEl?.value || '';
            const modellKey = modellSelectEl?.value || '';

            // Keine Suche wenn kein Input
            if (!searchInput && !markeKey) {
                resultsContainer.innerHTML = `
                    <div class="oe-no-results">
                        <span style="font-size: 2rem;">ðŸ”</span>
                        <p>Geben Sie eine OE-Nummer oder einen Teilenamen ein</p>
                    </div>
                `;
                return;
            }

            let ergebnisse = [];

            // Suche nach OE-Nummer
            if (searchInput.length >= 2) {
                // Versuche OE-Nummer-Suche
                const oeResults = ERSATZTEILE_DB.sucheNachOeNummer(searchInput);
                // Auch Namenssuche
                const nameResults = ERSATZTEILE_DB.sucheNachName(searchInput);

                // Kombinieren und Duplikate entfernen
                const combined = [...oeResults];
                nameResults.forEach(nr => {
                    const exists = combined.some(or =>
                        or.marke === nr.marke && or.modell === nr.modell && or.teil === nr.teil
                    );
                    if (!exists) combined.push(nr);
                });
                ergebnisse = combined;
            }

            // Fahrzeug-spezifische Suche
            if (markeKey) {
                const fahrzeugTeile = ERSATZTEILE_DB.getTeileNachFahrzeug(
                    ERSATZTEILE_DB.marken[markeKey].name,
                    modellKey ? ERSATZTEILE_DB.marken[markeKey].modelle[modellKey]?.name : null
                );

                if (searchInput.length >= 2) {
                    // Filter bereits gefundene Ergebnisse nach Fahrzeug
                    ergebnisse = ergebnisse.filter(e =>
                        e.marke === ERSATZTEILE_DB.marken[markeKey].name &&
                        (!modellKey || e.modell === ERSATZTEILE_DB.marken[markeKey].modelle[modellKey]?.name)
                    );
                } else {
                    // Zeige alle Teile des Fahrzeugs
                    ergebnisse = fahrzeugTeile;
                }
            }

            // Ergebnisse anzeigen
            if (ergebnisse.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="oe-no-results">
                        <span style="font-size: 2rem;">ðŸ˜”</span>
                        <p>Keine Ergebnisse gefunden</p>
                        <small>Versuchen Sie einen anderen Suchbegriff</small>
                    </div>
                `;
                return;
            }

            // Maximal 50 Ergebnisse anzeigen
            const displayResults = ergebnisse.slice(0, 50);

            resultsContainer.innerHTML = displayResults.map(result => `
                <div class="oe-result-item" onclick="selectOeResult(this, '${escapeHtml(result.teil)}', '${result.oe_nummer}', '${escapeHtml(result.marke)} ${escapeHtml(result.modell)}')">
                    <div class="oe-result-info">
                        <div class="oe-result-part">${result.teil}</div>
                        <div class="oe-result-vehicle">${result.marke} ${result.modell} (${result.baujahre || 'diverse'})</div>
                    </div>
                    <div class="oe-result-oe">${result.oe_nummer}</div>
                </div>
            `).join('');

            if (ergebnisse.length > 50) {
                resultsContainer.innerHTML += `
                    <div style="text-align: center; padding: var(--space-3); color: var(--color-text-secondary); font-size: var(--font-size-sm);">
                        ... und ${ergebnisse.length - 50} weitere Ergebnisse
                    </div>
                `;
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text.replace(/[&<>"']/g, function(m) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#39;'
                }[m];
            });
        }

        function selectOeResult(element, teileName, oeNummer, fahrzeug) {
            // Markiere als ausgewÃ¤hlt
            document.querySelectorAll('.oe-result-item').forEach(item => {
                item.style.borderColor = 'var(--color-border)';
                item.style.background = 'var(--color-background)';
            });
            element.style.borderColor = 'var(--color-success)';
            element.style.background = 'rgba(52, 199, 89, 0.1)';

            // Erstelle Material-Position mit OE-Nummer
            const materialName = `${teileName} (OE: ${oeNummer}) - ${fahrzeug}`;

            // FÃ¼ge als Material hinzu
            addMaterialWithOe(materialName, oeNummer);

            // Feedback
            showToast(`âœ… ${teileName} hinzugefÃ¼gt`, 'success');
        }

        function addMaterialWithOe(name, oeNummer) {
            const newMaterial = {
                name: name,
                kategorie: 'Ersatzteile',
                menge: 1,
                einheit: 'StÃ¼ck',
                einkaufspreis: 0, // Preis manuell eintragen
                verkaufspreis: 0, // Preis manuell eintragen
                oeNummer: oeNummer
            };

            materialien.push(newMaterial);
            renderMaterialien();
            berechneGesamtsumme();
        }

        // ============================================
        // ðŸŽ¯ 3D PART SELECTION (Button-Fallback)
        // ============================================

        function select3DPart(partName) {
            // Vorherige Auswahl entfernen
            document.querySelectorAll('.part-btn-3d').forEach(btn => {
                btn.classList.remove('selected');
            });

            // Aktiven Button markieren
            if (event && event.target) {
                event.target.classList.add('selected');
            }

            // Wizard Ã¶ffnen (gleiche Funktion wie 2D)
            selectedPart = partName;
            openDamageWizard(partName);
        }

        function selectVehiclePart(partName, element) {
            // Vorherige Auswahl entfernen
            document.querySelectorAll('.vehicle-part.selected').forEach(p => {
                p.classList.remove('selected');
            });

            // Neue Auswahl markieren
            element.classList.add('selected');
            selectedPart = partName;

            // Wizard Ã¶ffnen
            openDamageWizard(partName);
        }

        function openDamageWizard(partName) {
            selectedDamageType = null;
            selectedDamageSize = null;

            // Titel setzen
            document.getElementById('wizardPartName').textContent = partName;

            // Schritte zurÃ¼cksetzen
            document.getElementById('wizardStep1').style.display = 'block';
            document.getElementById('wizardStep2').style.display = 'none';
            document.getElementById('suggestedPositions').style.display = 'none';

            // Options zurÃ¼cksetzen
            document.querySelectorAll('.damage-option').forEach(opt => {
                opt.classList.remove('selected');
            });

            // Wizard anzeigen
            document.getElementById('damageWizard').classList.add('active');
            feather.replace();
        }

        function closeDamageWizard() {
            document.getElementById('damageWizard').classList.remove('active');

            // Auswahl im Diagramm entfernen
            document.querySelectorAll('.vehicle-part.selected').forEach(p => {
                p.classList.remove('selected');
            });

            selectedPart = null;
            selectedDamageType = null;
            selectedDamageSize = null;
        }

        function selectDamageType(element) {
            // Vorherige Auswahl entfernen
            document.querySelectorAll('#damageTypeOptions .damage-option').forEach(opt => {
                opt.classList.remove('selected');
            });

            // Neue Auswahl
            element.classList.add('selected');
            selectedDamageType = element.dataset.type;

            // Zu Schritt 2 wechseln
            document.getElementById('wizardStep1').style.display = 'none';
            document.getElementById('wizardStep2').style.display = 'block';
        }

        function selectDamageSize(element) {
            // Vorherige Auswahl entfernen
            document.querySelectorAll('#damageSizeOptions .damage-option').forEach(opt => {
                opt.classList.remove('selected');
            });

            // Neue Auswahl
            element.classList.add('selected');
            selectedDamageSize = element.dataset.size;

            // VorschlÃ¤ge generieren und anzeigen
            generateSuggestions();
        }

        function generateSuggestions() {
            suggestedItems = [];

            const mapping = partWorkMapping[selectedPart];
            if (!mapping) {
                console.warn('Kein Mapping fÃ¼r:', selectedPart);
                return;
            }

            const keywords = mapping[selectedDamageType] || [];

            // Passende Positionen aus dem Katalog finden
            keywords.forEach(keyword => {
                // GrÃ¶ÃŸe berÃ¼cksichtigen bei Spot-Repair, Delle, Spachteln
                let searchKeyword = keyword;
                if (keyword === 'Spot-Repair') {
                    searchKeyword = sizeMapping[selectedDamageSize]?.spotRepair || 'Spot-Repair M';
                } else if (keyword.includes('Delle ausbeulen')) {
                    searchKeyword = 'Delle ausbeulen ' + (sizeMapping[selectedDamageSize]?.delle || 'PDR M');
                } else if (keyword === 'Spachteln') {
                    searchKeyword = sizeMapping[selectedDamageSize]?.spachteln || 'Spachteln mittel';
                }

                // Im Katalog suchen
                const matches = katalogData.filter(item =>
                    item.name.toLowerCase().includes(searchKeyword.toLowerCase())
                );

                if (matches.length > 0) {
                    // Beste Ãœbereinstimmung nehmen
                    const bestMatch = matches[0];
                    if (!suggestedItems.find(s => s.id === bestMatch.id)) {
                        suggestedItems.push({
                            ...bestMatch,
                            added: false
                        });
                    }
                }
            });

            // VorschlÃ¤ge anzeigen
            renderSuggestions();
        }

        function renderSuggestions() {
            const container = document.getElementById('suggestedList');

            if (suggestedItems.length === 0) {
                container.innerHTML = `
                    <p style="color: var(--color-text-secondary); font-size: var(--font-size-sm);">
                        Keine passenden Positionen im Katalog gefunden.
                        <a href="?tab=katalog" style="color: var(--color-primary);">Katalog erweitern</a>
                    </p>
                `;
            } else {
                container.innerHTML = suggestedItems.map((item, index) => {
                    const preis = calculatePositionPreis(item);
                    return `
                        <div class="suggested-item ${item.added ? 'added' : ''}"
                             onclick="toggleSuggestedItem(${index})">
                            <div class="suggested-item__info">
                                <div class="suggested-item__checkbox">
                                    ${item.added ? '<i data-feather="check" style="width: 14px; height: 14px;"></i>' : ''}
                                </div>
                                <span class="suggested-item__name">${item.name}</span>
                            </div>
                            <span class="suggested-item__price">${item.arbeitswerte} AW / ${preis.toFixed(2)} â‚¬</span>
                        </div>
                    `;
                }).join('');
            }

            // VorschlÃ¤ge-Section anzeigen
            document.getElementById('suggestedPositions').style.display = 'block';
            feather.replace();
        }

        function toggleSuggestedItem(index) {
            const item = suggestedItems[index];
            item.added = !item.added;

            if (item.added) {
                // Zur Kalkulation hinzufÃ¼gen
                addPositionToKalkulation(item);
            } else {
                // Aus Kalkulation entfernen
                removePositionFromKalkulation(item.id);
            }

            renderSuggestions();
        }

        function addAllSuggested() {
            suggestedItems.forEach(item => {
                if (!item.added) {
                    item.added = true;
                    addPositionToKalkulation(item);
                }
            });

            renderSuggestions();
            showToast(`${suggestedItems.length} Positionen hinzugefÃ¼gt`, 'success');

            // Bauteil als beschÃ¤digt markieren
            const selectedElement = document.querySelector('.vehicle-part.selected');
            if (selectedElement) {
                selectedElement.classList.remove('selected');
                selectedElement.classList.add('damaged-medium');
            }
        }

        function addPositionToKalkulation(item) {
            // PrÃ¼fen ob bereits vorhanden
            if (aktuelleKalkulation.positionen.find(p => p.katalogId === item.id)) {
                return;
            }

            aktuelleKalkulation.positionen.push({
                katalogId: item.id,
                name: item.name,
                kategorie: item.kategorie,
                arbeitswerte: item.arbeitswerte,
                anzahl: 1,
                preis: calculatePositionPreis(item)
            });

            renderPositionen();
            calculateSumme();

            // Kalkulation-Content anzeigen
            document.getElementById('kalkulationContent').style.display = 'block';
            document.getElementById('freieKalkulationStart').style.display = 'none';
        }

        function removePositionFromKalkulation(katalogId) {
            aktuelleKalkulation.positionen = aktuelleKalkulation.positionen.filter(
                p => p.katalogId !== katalogId
            );
            renderPositionen();
            calculateSumme();
        }

        function calculatePositionPreis(item) {
            // Stundensatz basierend auf Kategorie
            let stundensatz = kalkulationSaetze.stundensatzSonstige;
            if (item.kategorie === 'Lackierung') {
                stundensatz = kalkulationSaetze.stundensatzLack;
            } else if (item.kategorie === 'Karosserie') {
                stundensatz = kalkulationSaetze.stundensatzKarosserie;
            } else if (item.kategorie === 'Mechanik') {
                stundensatz = kalkulationSaetze.stundensatzMechanik;
            }

            // AW â†’ Stunden â†’ Euro
            const stunden = (item.arbeitswerte * kalkulationSaetze.awInMinuten) / 60;
            return stunden * stundensatz;
        }

        // ============================================
        // ðŸ” SCHNELLSUCHE FUNKTIONEN
        // ============================================

        function initQuickSearch() {
            const input = document.getElementById('quickSearchInput');
            const results = document.getElementById('quickSearchResults');

            if (!input || !results) return;

            let debounceTimer;

            input.addEventListener('input', () => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    const query = input.value.trim().toLowerCase();

                    if (query.length < 2) {
                        results.classList.remove('active');
                        return;
                    }

                    const matches = katalogData.filter(item =>
                        item.name.toLowerCase().includes(query) ||
                        (item.kategorie && item.kategorie.toLowerCase().includes(query))
                    ).slice(0, 10);

                    if (matches.length === 0) {
                        results.innerHTML = `
                            <div class="quick-search__result" style="color: var(--color-text-secondary);">
                                Keine Ergebnisse fÃ¼r "${query}"
                            </div>
                        `;
                    } else {
                        results.innerHTML = matches.map(item => {
                            const highlightedName = item.name.replace(
                                new RegExp(`(${query})`, 'gi'),
                                '<mark>$1</mark>'
                            );
                            const preis = calculatePositionPreis(item);
                            return `
                                <div class="quick-search__result" onclick="addFromQuickSearch('${item.id}')">
                                    <span class="quick-search__result-name">${highlightedName}</span>
                                    <span class="quick-search__result-meta">${item.arbeitswerte} AW Â· ${preis.toFixed(2)} â‚¬</span>
                                </div>
                            `;
                        }).join('');
                    }

                    results.classList.add('active');
                }, 200);
            });

            // SchlieÃŸen bei Klick auÃŸerhalb
            document.addEventListener('click', (e) => {
                if (!input.contains(e.target) && !results.contains(e.target)) {
                    results.classList.remove('active');
                }
            });

            // Enter-Taste
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const firstResult = results.querySelector('.quick-search__result');
                    if (firstResult) {
                        firstResult.click();
                    }
                }
            });
        }

        function addFromQuickSearch(itemId) {
            const item = katalogData.find(k => k.id === itemId);
            if (item) {
                addPositionToKalkulation(item);
                showToast(`"${item.name}" hinzugefÃ¼gt`, 'success');

                // Suche zurÃ¼cksetzen
                const searchInput = document.getElementById('quickSearchInput');
                const searchResults = document.getElementById('quickSearchResults');
                if (searchInput) searchInput.value = '';
                if (searchResults) searchResults.classList.remove('active');
            }
        }

        // ============================================
        // TAB NAVIGATION
        // ============================================

        function switchTab(tabId) {
            console.log('ðŸ”„ switchTab called with:', tabId);

            // Update buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tab === tabId) {
                    btn.classList.add('active');
                }
            });

            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`tab-${tabId}`).classList.add('active');

            // Update URL without reload
            const url = new URL(window.location);
            url.searchParams.set('tab', tabId);
            window.history.replaceState({}, '', url);

            // Load data for specific tabs
            if (tabId === 'historie') {
                console.log('ðŸ”„ Calling loadHistorie()...');
                loadHistorie();
            } else if (tabId === 'kunden') {
                console.log('ðŸ”„ Calling loadKunden()...');
                loadKunden();
            }
        }

        // ============================================
        // STUNDENSÃ„TZE (TAB 3)
        // ============================================

        async function loadSaetze() {
            try {
                const doc = await window.getCollection('kalkulation_saetze').doc('config').get();
                if (doc.exists) {
                    kalkulationSaetze = { ...kalkulationSaetze, ...doc.data() };

                    // Update form fields (with null checks)
                    const lackEl = document.getElementById('stundensatzLack');
                    const karosserieEl = document.getElementById('stundensatzKarosserie');
                    const mechanikEl = document.getElementById('stundensatzMechanik');
                    const sonstigeEl = document.getElementById('stundensatzSonstige');
                    const awEl = document.getElementById('awInMinuten');
                    const mwstEl = document.getElementById('mwstSatz');
                    if (lackEl) lackEl.value = kalkulationSaetze.stundensatzLack;
                    if (karosserieEl) karosserieEl.value = kalkulationSaetze.stundensatzKarosserie;
                    if (mechanikEl) mechanikEl.value = kalkulationSaetze.stundensatzMechanik;
                    if (sonstigeEl) sonstigeEl.value = kalkulationSaetze.stundensatzSonstige;
                    if (awEl) awEl.value = kalkulationSaetze.awInMinuten;
                    if (mwstEl) mwstEl.value = kalkulationSaetze.mwstSatz;

                    console.log('âœ… StundensÃ¤tze geladen');
                }
            } catch (error) {
                console.warn('âš ï¸ StundensÃ¤tze nicht gefunden, verwende Standardwerte');
            }
        }

        async function saveSaetze(event) {
            event.preventDefault();

            const btn = document.getElementById('saveSaetzeBtn');
            btn.disabled = true;
            btn.innerHTML = '<i data-feather="loader"></i> Speichert...';
            feather.replace();

            try {
                kalkulationSaetze = {
                    stundensatzLack: parseFloat(document.getElementById('stundensatzLack')?.value) || 95,
                    stundensatzKarosserie: parseFloat(document.getElementById('stundensatzKarosserie')?.value) || 85,
                    stundensatzMechanik: parseFloat(document.getElementById('stundensatzMechanik')?.value) || 75,
                    stundensatzSonstige: parseFloat(document.getElementById('stundensatzSonstige')?.value) || 65,
                    awInMinuten: parseInt(document.getElementById('awInMinuten')?.value) || 5,
                    mwstSatz: parseFloat(document.getElementById('mwstSatz')?.value) || 19,
                    updatedAt: new Date().toISOString()
                };

                await window.getCollection('kalkulation_saetze').doc('config').set(kalkulationSaetze);

                showToast('Einstellungen gespeichert!', 'success');
                console.log('âœ… StundensÃ¤tze gespeichert:', kalkulationSaetze);

            } catch (error) {
                console.error('âŒ Fehler beim Speichern:', error);
                showToast('Fehler beim Speichern', 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i data-feather="save"></i> Einstellungen speichern';
                feather.replace();
            }
        }

        // ============================================
        // ARBEITSWERT-KATALOG (TAB 2)
        // ============================================

        async function loadKatalog() {
            try {
                const snapshot = await window.getCollection('kalkulation_katalog')
                    .orderBy('kategorie')
                    .orderBy('name')
                    .get();

                katalogData = [];
                snapshot.forEach(doc => {
                    katalogData.push({ id: doc.id, ...doc.data() });
                });

                renderKatalog();
                console.log(`âœ… ${katalogData.length} Katalog-EintrÃ¤ge geladen`);
            } catch (error) {
                console.warn('âš ï¸ Katalog nicht gefunden:', error);
            }
        }

        function renderKatalog() {
            const container = document.getElementById('katalogListe');

            if (katalogData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i data-feather="book-open"></i>
                        <h3>Katalog leer</h3>
                        <p>Erstellen Sie Ihren ersten Arbeitswert-Eintrag</p>
                        <button class="btn btn-primary" onclick="seedKatalog()">
                            <i data-feather="download"></i>
                            Standard-Katalog laden
                        </button>
                    </div>
                `;
                feather.replace();
                return;
            }

            // Group by category
            const grouped = {};
            katalogData.forEach(item => {
                const kat = item.kategorie || 'Sonstiges';
                if (!grouped[kat]) grouped[kat] = [];
                grouped[kat].push(item);
            });

            let html = '';
            Object.keys(grouped).sort().forEach(kategorie => {
                const items = grouped[kategorie];
                html += `
                    <div class="category-group">
                        <div class="category-header">
                            <h3>${kategorie}</h3>
                            <span class="count">${items.length}</span>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Bezeichnung</th>
                                    <th>AW</th>
                                    <th>Zeit</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${items.map(item => `
                                    <tr>
                                        <td>${item.name}</td>
                                        <td>${item.arbeitswerte} AW</td>
                                        <td>~${Math.round(item.arbeitswerte * kalkulationSaetze.awInMinuten)} Min</td>
                                        <td class="actions">
                                            <button class="btn btn-icon btn-secondary" onclick="editKatalogPosition('${item.id}')" title="Bearbeiten">
                                                <i data-feather="edit-2"></i>
                                            </button>
                                            <button class="btn btn-icon btn-secondary" onclick="deleteKatalogPosition('${item.id}')" title="LÃ¶schen" style="color: var(--color-error);">
                                                <i data-feather="trash-2"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            });

            container.innerHTML = html;
            feather.replace();
        }

        function filterKatalog() {
            const search = document.getElementById('katalogSearch').value.toLowerCase();
            const filter = document.getElementById('katalogFilter').value;

            // TODO: Implement filtering
            console.log('Filter:', search, filter);
        }

        function openKatalogModal(positionId = null) {
            const modal = document.getElementById('katalogModal');
            if (!modal) return;

            document.getElementById('katalogModalTitle').textContent = positionId ? 'Position bearbeiten' : 'Neue Position';
            document.getElementById('katalogPositionId').value = positionId || '';
            document.getElementById('katalogForm').reset();

            if (positionId) {
                const position = katalogData.find(p => p.id === positionId);
                if (position) {
                    document.getElementById('positionName').value = position.name || '';
                    document.getElementById('positionKategorie').value = position.kategorie || '';
                    document.getElementById('positionAW').value = position.arbeitswerte || '';
                    document.getElementById('positionBeschreibung').value = position.beschreibung || '';
                }
            }

            // Force display with inline styles
            modal.style.display = 'flex';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.right = '0';
            modal.style.bottom = '0';
            modal.style.zIndex = '99999';
            modal.style.background = 'rgba(0,0,0,0.7)';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.classList.add('active');

            // Force modal content to be visible
            const modalContent = modal.querySelector('.modal');
            if (modalContent) {
                modalContent.style.cssText = `
                    background: #ffffff !important;
                    padding: 0 !important;
                    border-radius: 16px !important;
                    max-width: 500px !important;
                    width: 90% !important;
                    box-shadow: 0 25px 50px rgba(0,0,0,0.5) !important;
                    z-index: 100000 !important;
                    position: relative !important;
                    display: block !important;
                    opacity: 1 !important;
                    visibility: visible !important;
                    transform: none !important;
                    pointer-events: auto !important;
                `;

                // Style header, body, footer for visibility and clickability
                const header = modalContent.querySelector('.modal-header');
                const body = modalContent.querySelector('.modal-body');
                const footer = modalContent.querySelector('.modal-footer');

                if (header) {
                    header.style.cssText = `
                        display: flex !important;
                        align-items: center !important;
                        justify-content: space-between !important;
                        padding: 16px 20px !important;
                        background: #f5f5f7 !important;
                        border-bottom: 1px solid #e0e0e0 !important;
                        border-radius: 16px 16px 0 0 !important;
                        pointer-events: auto !important;
                    `;
                }

                if (body) {
                    body.style.cssText = `
                        padding: 20px !important;
                        background: #ffffff !important;
                        pointer-events: auto !important;
                    `;
                }

                if (footer) {
                    footer.style.cssText = `
                        display: flex !important;
                        justify-content: flex-end !important;
                        gap: 12px !important;
                        padding: 16px 20px !important;
                        background: #f5f5f7 !important;
                        border-top: 1px solid #e0e0e0 !important;
                        border-radius: 0 0 16px 16px !important;
                        pointer-events: auto !important;
                    `;
                }

                // Style all buttons in modal to be clickable
                modalContent.querySelectorAll('button').forEach(btn => {
                    btn.style.pointerEvents = 'auto';
                    btn.style.cursor = 'pointer';
                });
            }

            feather.replace();
        }

        function editKatalogPosition(positionId) {
            openKatalogModal(positionId);
        }

        async function saveKatalogPosition(event) {
            event.preventDefault();

            const positionId = document.getElementById('katalogPositionId').value;
            const data = {
                name: document.getElementById('positionName').value.trim(),
                kategorie: document.getElementById('positionKategorie').value,
                arbeitswerte: parseFloat(document.getElementById('positionAW').value) || 0,
                beschreibung: document.getElementById('positionBeschreibung').value.trim(),
                updatedAt: new Date().toISOString()
            };

            try {
                if (positionId) {
                    await window.getCollection('kalkulation_katalog').doc(positionId).update(data);
                    showToast('Position aktualisiert', 'success');
                } else {
                    data.createdAt = new Date().toISOString();
                    await window.getCollection('kalkulation_katalog').add(data);
                    showToast('Position erstellt', 'success');
                }

                closeModal('katalogModal');
                await loadKatalog();

            } catch (error) {
                console.error('âŒ Fehler:', error);
                showToast('Fehler beim Speichern', 'error');
            }
        }

        async function deleteKatalogPosition(positionId) {
            if (!confirm('Position wirklich lÃ¶schen?')) return;

            try {
                await window.getCollection('kalkulation_katalog').doc(positionId).delete();
                showToast('Position gelÃ¶scht', 'success');
                await loadKatalog();
            } catch (error) {
                console.error('âŒ Fehler:', error);
                showToast('Fehler beim LÃ¶schen', 'error');
            }
        }

        async function seedKatalog() {
            // ============================================
            // ðŸ­ UMFANGREICHER ARBEITSWERT-KATALOG
            // Basierend auf DAT/Audatex Branchenstandards 2024
            // 1 AW = 5 Minuten (Branchenstandard)
            // Quellen: DEKRA, ZKF, Carrosserie Suisse
            // ============================================
            const SEED_DATA = [
                // ================================================
                // DEMONTAGE/MONTAGE - STOSSF Ã„NGER
                // ================================================
                { name: "StoÃŸfÃ¤nger vorne dem./mont.", kategorie: "Karosserie", arbeitswerte: 8.5 },
                { name: "StoÃŸfÃ¤nger vorne mit Sensoren dem./mont.", kategorie: "Karosserie", arbeitswerte: 12.0 },
                { name: "StoÃŸfÃ¤nger hinten dem./mont.", kategorie: "Karosserie", arbeitswerte: 7.0 },
                { name: "StoÃŸfÃ¤nger hinten mit Sensoren dem./mont.", kategorie: "Karosserie", arbeitswerte: 10.0 },
                { name: "PDC-Sensoren kalibrieren", kategorie: "Karosserie", arbeitswerte: 4.0 },

                // ================================================
                // DEMONTAGE/MONTAGE - AUSSENHAUT
                // ================================================
                { name: "KotflÃ¼gel vorne dem./mont.", kategorie: "Karosserie", arbeitswerte: 12.0 },
                { name: "KotflÃ¼gel vorne Aluminium dem./mont.", kategorie: "Karosserie", arbeitswerte: 15.0 },
                { name: "Motorhaube dem./mont.", kategorie: "Karosserie", arbeitswerte: 4.0 },
                { name: "Motorhaube mit DÃ¤mmung dem./mont.", kategorie: "Karosserie", arbeitswerte: 6.0 },
                { name: "TÃ¼r vorne dem./mont.", kategorie: "Karosserie", arbeitswerte: 8.0 },
                { name: "TÃ¼r hinten dem./mont.", kategorie: "Karosserie", arbeitswerte: 7.0 },
                { name: "TÃ¼rverkleidung dem./mont.", kategorie: "Karosserie", arbeitswerte: 4.0 },
                { name: "Heckklappe dem./mont.", kategorie: "Karosserie", arbeitswerte: 6.0 },
                { name: "Heckklappe Kombi mit Scheibenheizung dem./mont.", kategorie: "Karosserie", arbeitswerte: 10.0 },
                { name: "Kofferraumdeckel Limousine dem./mont.", kategorie: "Karosserie", arbeitswerte: 5.0 },
                { name: "Seitenspiegel dem./mont.", kategorie: "Karosserie", arbeitswerte: 2.0 },
                { name: "Seitenspiegel elektrisch dem./mont.", kategorie: "Karosserie", arbeitswerte: 3.5 },
                { name: "Seitenspiegel mit Kamera dem./mont.", kategorie: "Karosserie", arbeitswerte: 5.0 },

                // ================================================
                // DEMONTAGE/MONTAGE - VERGLASUNG
                // ================================================
                { name: "Frontscheibe dem./mont.", kategorie: "Karosserie", arbeitswerte: 18.0 },
                { name: "Frontscheibe mit Kamera (ADAS) dem./mont.", kategorie: "Karosserie", arbeitswerte: 24.0 },
                { name: "Heckscheibe dem./mont.", kategorie: "Karosserie", arbeitswerte: 12.0 },
                { name: "Heckscheibe mit Heizung dem./mont.", kategorie: "Karosserie", arbeitswerte: 15.0 },
                { name: "Seitenscheibe vorne dem./mont.", kategorie: "Karosserie", arbeitswerte: 6.0 },
                { name: "Seitenscheibe hinten dem./mont.", kategorie: "Karosserie", arbeitswerte: 5.0 },
                { name: "Dreiecksfenster dem./mont.", kategorie: "Karosserie", arbeitswerte: 4.0 },
                { name: "ADAS-Kalibrierung nach Scheibenwechsel", kategorie: "Karosserie", arbeitswerte: 12.0 },

                // ================================================
                // DEMONTAGE/MONTAGE - ANBAUTEILE
                // ================================================
                { name: "Scheinwerfer dem./mont.", kategorie: "Karosserie", arbeitswerte: 4.0 },
                { name: "Scheinwerfer LED/Xenon dem./mont.", kategorie: "Karosserie", arbeitswerte: 6.0 },
                { name: "Scheinwerfer Matrix-LED dem./mont.", kategorie: "Karosserie", arbeitswerte: 8.0 },
                { name: "RÃ¼ckleuchte dem./mont.", kategorie: "Karosserie", arbeitswerte: 2.0 },
                { name: "RÃ¼ckleuchte LED dem./mont.", kategorie: "Karosserie", arbeitswerte: 3.0 },
                { name: "KÃ¼hlergrill dem./mont.", kategorie: "Karosserie", arbeitswerte: 3.0 },
                { name: "KÃ¼hlergrill mit Kamera/Radar dem./mont.", kategorie: "Karosserie", arbeitswerte: 5.0 },
                { name: "Schweller-Verkleidung dem./mont.", kategorie: "Karosserie", arbeitswerte: 3.0 },
                { name: "Radlaufverkleidung dem./mont.", kategorie: "Karosserie", arbeitswerte: 2.0 },
                { name: "Unterbodenverkleidung dem./mont.", kategorie: "Karosserie", arbeitswerte: 6.0 },
                { name: "Spoiler vorne dem./mont.", kategorie: "Karosserie", arbeitswerte: 4.0 },
                { name: "Spoiler hinten dem./mont.", kategorie: "Karosserie", arbeitswerte: 3.0 },
                { name: "Dachspoiler dem./mont.", kategorie: "Karosserie", arbeitswerte: 4.0 },
                { name: "DachtrÃ¤ger dem./mont.", kategorie: "Karosserie", arbeitswerte: 2.0 },
                { name: "Dachantenne dem./mont.", kategorie: "Karosserie", arbeitswerte: 1.5 },
                { name: "Tankdeckel dem./mont.", kategorie: "Karosserie", arbeitswerte: 1.0 },
                { name: "Zierleisten Fenster dem./mont.", kategorie: "Karosserie", arbeitswerte: 6.0 },
                { name: "Zierleisten StoÃŸfÃ¤nger dem./mont.", kategorie: "Karosserie", arbeitswerte: 2.0 },
                { name: "TÃ¼rgriff auÃŸen dem./mont.", kategorie: "Karosserie", arbeitswerte: 2.0 },
                { name: "Nummernschildhalter dem./mont.", kategorie: "Karosserie", arbeitswerte: 0.5 },

                // ================================================
                // LACKIERUNG - EINZELTEILE
                // ================================================
                { name: "StoÃŸfÃ¤nger vorne lackieren", kategorie: "Lackierung", arbeitswerte: 10.0 },
                { name: "StoÃŸfÃ¤nger hinten lackieren", kategorie: "Lackierung", arbeitswerte: 9.0 },
                { name: "KotflÃ¼gel vorne lackieren", kategorie: "Lackierung", arbeitswerte: 10.0 },
                { name: "Motorhaube lackieren", kategorie: "Lackierung", arbeitswerte: 12.0 },
                { name: "TÃ¼r lackieren", kategorie: "Lackierung", arbeitswerte: 11.0 },
                { name: "Heckklappe lackieren", kategorie: "Lackierung", arbeitswerte: 11.0 },
                { name: "Kofferraumdeckel lackieren", kategorie: "Lackierung", arbeitswerte: 10.0 },
                { name: "Dach lackieren", kategorie: "Lackierung", arbeitswerte: 14.0 },
                { name: "Seitenteil lackieren", kategorie: "Lackierung", arbeitswerte: 12.0 },
                { name: "A-SÃ¤ule lackieren", kategorie: "Lackierung", arbeitswerte: 6.0 },
                { name: "B-SÃ¤ule lackieren", kategorie: "Lackierung", arbeitswerte: 5.0 },
                { name: "C-SÃ¤ule lackieren", kategorie: "Lackierung", arbeitswerte: 5.0 },
                { name: "Schweller lackieren", kategorie: "Lackierung", arbeitswerte: 8.0 },
                { name: "Spiegel lackieren (pro StÃ¼ck)", kategorie: "Lackierung", arbeitswerte: 3.0 },
                { name: "Spoiler lackieren", kategorie: "Lackierung", arbeitswerte: 6.0 },
                { name: "Tankdeckel lackieren", kategorie: "Lackierung", arbeitswerte: 2.0 },
                { name: "TÃ¼rgriff lackieren (pro StÃ¼ck)", kategorie: "Lackierung", arbeitswerte: 1.5 },

                // ================================================
                // LACKIERUNG - SPOT-REPAIR / SMART-REPAIR
                // ================================================
                { name: "Spot-Repair XS (bis 3cm)", kategorie: "Lackierung", arbeitswerte: 4.0 },
                { name: "Spot-Repair S (bis 5cm)", kategorie: "Lackierung", arbeitswerte: 5.0 },
                { name: "Spot-Repair M (bis 10cm)", kategorie: "Lackierung", arbeitswerte: 6.0 },
                { name: "Spot-Repair L (bis 15cm)", kategorie: "Lackierung", arbeitswerte: 8.0 },
                { name: "Spot-Repair XL (bis 20cm)", kategorie: "Lackierung", arbeitswerte: 10.0 },
                { name: "Steinschlag-Reparatur (pro Stelle)", kategorie: "Lackierung", arbeitswerte: 1.0 },
                { name: "Kratzer-Politur (pro Panel)", kategorie: "Lackierung", arbeitswerte: 2.0 },
                { name: "Lackreinigung vor Lackierung", kategorie: "Lackierung", arbeitswerte: 2.0 },

                // ================================================
                // LACKIERUNG - LACKAUFBAU
                // ================================================
                { name: "Grundierung auftragen (pro Teil)", kategorie: "Lackierung", arbeitswerte: 4.0 },
                { name: "FÃ¼ller auftragen (pro Teil)", kategorie: "Lackierung", arbeitswerte: 4.0 },
                { name: "FÃ¼ller schleifen (pro Teil)", kategorie: "Lackierung", arbeitswerte: 3.0 },
                { name: "Basislack auftragen (pro Teil)", kategorie: "Lackierung", arbeitswerte: 5.0 },
                { name: "Klarlack auftragen (pro Teil)", kategorie: "Lackierung", arbeitswerte: 4.0 },
                { name: "2-Schicht Metallic-Lackierung (pro Teil)", kategorie: "Lackierung", arbeitswerte: 10.0 },
                { name: "3-Schicht Perleffekt-Lackierung (pro Teil)", kategorie: "Lackierung", arbeitswerte: 14.0 },
                { name: "Mattlack-Lackierung (pro Teil)", kategorie: "Lackierung", arbeitswerte: 12.0 },
                { name: "Sonderlackierung (Effektlack)", kategorie: "Lackierung", arbeitswerte: 16.0 },
                { name: "Farbton mischen nach Farbcode", kategorie: "Lackierung", arbeitswerte: 3.0 },
                { name: "Farbton einmessen (Spectrophotometer)", kategorie: "Lackierung", arbeitswerte: 2.0 },

                // ================================================
                // LACKIERUNG - KOMPLETT
                // ================================================
                { name: "Komplettlackierung Kleinwagen", kategorie: "Lackierung", arbeitswerte: 80.0 },
                { name: "Komplettlackierung Kompaktklasse", kategorie: "Lackierung", arbeitswerte: 100.0 },
                { name: "Komplettlackierung Mittelklasse", kategorie: "Lackierung", arbeitswerte: 120.0 },
                { name: "Komplettlackierung Oberklasse/SUV", kategorie: "Lackierung", arbeitswerte: 140.0 },
                { name: "Komplettlackierung Transporter", kategorie: "Lackierung", arbeitswerte: 160.0 },
                { name: "Teillackierung (3-5 Teile)", kategorie: "Lackierung", arbeitswerte: 40.0 },
                { name: "Teillackierung (6-10 Teile)", kategorie: "Lackierung", arbeitswerte: 70.0 },

                // ================================================
                // KAROSSERIEARBEITEN - AUSBEULEN
                // ================================================
                { name: "Delle ausbeulen PDR XS (bis 1cm)", kategorie: "Karosserie", arbeitswerte: 3.0 },
                { name: "Delle ausbeulen PDR S (bis 2cm)", kategorie: "Karosserie", arbeitswerte: 5.0 },
                { name: "Delle ausbeulen PDR M (bis 5cm)", kategorie: "Karosserie", arbeitswerte: 8.0 },
                { name: "Delle ausbeulen PDR L (bis 10cm)", kategorie: "Karosserie", arbeitswerte: 12.0 },
                { name: "Delle ausbeulen PDR XL (Ã¼ber 10cm)", kategorie: "Karosserie", arbeitswerte: 18.0 },
                { name: "Hagelschaden PDR pro Delle", kategorie: "Karosserie", arbeitswerte: 2.0 },
                { name: "Hagelschaden Pauschale Kleinwagen", kategorie: "Karosserie", arbeitswerte: 60.0 },
                { name: "Hagelschaden Pauschale Mittelklasse", kategorie: "Karosserie", arbeitswerte: 80.0 },
                { name: "Hagelschaden Pauschale SUV/Kombi", kategorie: "Karosserie", arbeitswerte: 100.0 },
                { name: "Ausbeulen konventionell (pro Teil)", kategorie: "Karosserie", arbeitswerte: 15.0 },
                { name: "Ausziehen mit Spotter", kategorie: "Karosserie", arbeitswerte: 10.0 },

                // ================================================
                // KAROSSERIEARBEITEN - SPACHTELN
                // ================================================
                { name: "Spachteln klein (bis 5cm)", kategorie: "Karosserie", arbeitswerte: 4.0 },
                { name: "Spachteln mittel (bis 15cm)", kategorie: "Karosserie", arbeitswerte: 8.0 },
                { name: "Spachteln groÃŸ (bis 30cm)", kategorie: "Karosserie", arbeitswerte: 12.0 },
                { name: "Spachteln sehr groÃŸ (Ã¼ber 30cm)", kategorie: "Karosserie", arbeitswerte: 18.0 },
                { name: "Glasfaserspachtel auftragen", kategorie: "Karosserie", arbeitswerte: 6.0 },
                { name: "Kunststoffspachteln", kategorie: "Karosserie", arbeitswerte: 5.0 },
                { name: "Feinspachteln", kategorie: "Karosserie", arbeitswerte: 3.0 },
                { name: "Schleifen vor Lackierung", kategorie: "Karosserie", arbeitswerte: 4.0 },
                { name: "Nassschleifen (pro Teil)", kategorie: "Karosserie", arbeitswerte: 3.0 },

                // ================================================
                // KAROSSERIEARBEITEN - SCHWEISSEN/KLEBEN
                // ================================================
                { name: "SchweiÃŸnaht kurz (bis 10cm)", kategorie: "Karosserie", arbeitswerte: 4.0 },
                { name: "SchweiÃŸnaht mittel (bis 30cm)", kategorie: "Karosserie", arbeitswerte: 8.0 },
                { name: "SchweiÃŸnaht lang (Ã¼ber 30cm)", kategorie: "Karosserie", arbeitswerte: 12.0 },
                { name: "PunktschweiÃŸen (pro Punkt)", kategorie: "Karosserie", arbeitswerte: 0.5 },
                { name: "KunststoffschweiÃŸen", kategorie: "Karosserie", arbeitswerte: 8.0 },
                { name: "Klebereparatur Kunststoff", kategorie: "Karosserie", arbeitswerte: 6.0 },
                { name: "Strukturkleben", kategorie: "Karosserie", arbeitswerte: 5.0 },
                { name: "Hohlraumversiegelung (pro Hohlraum)", kategorie: "Karosserie", arbeitswerte: 3.0 },
                { name: "Unterbodenschutz auftragen", kategorie: "Karosserie", arbeitswerte: 10.0 },
                { name: "Nahtabdichtung", kategorie: "Karosserie", arbeitswerte: 4.0 },

                // ================================================
                // KAROSSERIEARBEITEN - TEILEERSATZ
                // ================================================
                { name: "KotflÃ¼gel einschweiÃŸen", kategorie: "Karosserie", arbeitswerte: 40.0 },
                { name: "Seitenteil ersetzen (geschweiÃŸt)", kategorie: "Karosserie", arbeitswerte: 60.0 },
                { name: "Schweller ersetzen (komplett)", kategorie: "Karosserie", arbeitswerte: 50.0 },
                { name: "Schweller Teilersatz", kategorie: "Karosserie", arbeitswerte: 30.0 },
                { name: "A-SÃ¤ule ersetzen", kategorie: "Karosserie", arbeitswerte: 45.0 },
                { name: "B-SÃ¤ule ersetzen", kategorie: "Karosserie", arbeitswerte: 50.0 },
                { name: "Radhaus ersetzen", kategorie: "Karosserie", arbeitswerte: 35.0 },
                { name: "LÃ¤ngstrÃ¤gerteil ersetzen", kategorie: "Karosserie", arbeitswerte: 55.0 },
                { name: "RÃ¼ckwand ersetzen", kategorie: "Karosserie", arbeitswerte: 45.0 },
                { name: "Bodenblech Teilersatz", kategorie: "Karosserie", arbeitswerte: 40.0 },

                // ================================================
                // MECHANIK - FAHRWERK
                // ================================================
                { name: "StoÃŸdÃ¤mpfer vorne wechseln (pro Seite)", kategorie: "Mechanik", arbeitswerte: 8.0 },
                { name: "StoÃŸdÃ¤mpfer hinten wechseln (pro Seite)", kategorie: "Mechanik", arbeitswerte: 6.0 },
                { name: "Federbein komplett wechseln", kategorie: "Mechanik", arbeitswerte: 10.0 },
                { name: "Traggelenk wechseln", kategorie: "Mechanik", arbeitswerte: 6.0 },
                { name: "Querlenker wechseln", kategorie: "Mechanik", arbeitswerte: 8.0 },
                { name: "Spurstangenkopf wechseln", kategorie: "Mechanik", arbeitswerte: 4.0 },
                { name: "Stabilisator wechseln", kategorie: "Mechanik", arbeitswerte: 4.0 },
                { name: "Koppelstange wechseln", kategorie: "Mechanik", arbeitswerte: 2.0 },
                { name: "Achsvermessung", kategorie: "Mechanik", arbeitswerte: 6.0 },
                { name: "Spureinstellung", kategorie: "Mechanik", arbeitswerte: 4.0 },

                // ================================================
                // MECHANIK - BREMSEN
                // ================================================
                { name: "BremsbelÃ¤ge vorne wechseln", kategorie: "Mechanik", arbeitswerte: 4.0 },
                { name: "BremsbelÃ¤ge hinten wechseln", kategorie: "Mechanik", arbeitswerte: 4.0 },
                { name: "Bremsscheiben vorne wechseln", kategorie: "Mechanik", arbeitswerte: 6.0 },
                { name: "Bremsscheiben hinten wechseln", kategorie: "Mechanik", arbeitswerte: 5.0 },
                { name: "Bremssattel wechseln", kategorie: "Mechanik", arbeitswerte: 5.0 },
                { name: "Bremsleitung erneuern", kategorie: "Mechanik", arbeitswerte: 6.0 },
                { name: "BremsflÃ¼ssigkeit wechseln", kategorie: "Mechanik", arbeitswerte: 3.0 },
                { name: "Handbremse einstellen", kategorie: "Mechanik", arbeitswerte: 2.0 },

                // ================================================
                // MECHANIK - BELEUCHTUNG
                // ================================================
                { name: "Scheinwerfer einstellen", kategorie: "Mechanik", arbeitswerte: 2.0 },
                { name: "Scheinwerfer-Leuchtmittel wechseln", kategorie: "Mechanik", arbeitswerte: 1.0 },
                { name: "Xenon-Brenner wechseln", kategorie: "Mechanik", arbeitswerte: 2.0 },
                { name: "LED-Scheinwerfer-Modul wechseln", kategorie: "Mechanik", arbeitswerte: 4.0 },
                { name: "RÃ¼ckleuchte Leuchtmittel wechseln", kategorie: "Mechanik", arbeitswerte: 0.5 },
                { name: "Kennzeichenbeleuchtung wechseln", kategorie: "Mechanik", arbeitswerte: 0.5 },

                // ================================================
                // MECHANIK - KÃœHLUNG/KLIMA
                // ================================================
                { name: "KÃ¼hler wechseln", kategorie: "Mechanik", arbeitswerte: 10.0 },
                { name: "KÃ¼hlerschlauch wechseln", kategorie: "Mechanik", arbeitswerte: 3.0 },
                { name: "Thermostat wechseln", kategorie: "Mechanik", arbeitswerte: 4.0 },
                { name: "Klimakondensator wechseln", kategorie: "Mechanik", arbeitswerte: 12.0 },
                { name: "Klimaservice (BefÃ¼llung)", kategorie: "Mechanik", arbeitswerte: 3.0 },
                { name: "Klimaleitung wechseln", kategorie: "Mechanik", arbeitswerte: 6.0 },

                // ================================================
                // SONSTIGES - REINIGUNG
                // ================================================
                { name: "Fahrzeug waschen", kategorie: "Sonstiges", arbeitswerte: 2.0 },
                { name: "Fahrzeug waschen & trocknen", kategorie: "Sonstiges", arbeitswerte: 3.0 },
                { name: "Fahrzeug waschen & aufbereiten", kategorie: "Sonstiges", arbeitswerte: 4.0 },
                { name: "Innenreinigung Standard", kategorie: "Sonstiges", arbeitswerte: 4.0 },
                { name: "Innenreinigung intensiv", kategorie: "Sonstiges", arbeitswerte: 8.0 },
                { name: "Lederreinigung & Pflege", kategorie: "Sonstiges", arbeitswerte: 6.0 },
                { name: "MotorwÃ¤sche", kategorie: "Sonstiges", arbeitswerte: 4.0 },
                { name: "Felgenreinigung (4 StÃ¼ck)", kategorie: "Sonstiges", arbeitswerte: 2.0 },

                // ================================================
                // SONSTIGES - POLIEREN
                // ================================================
                { name: "Polieren 1-Stufen (Fahrzeug komplett)", kategorie: "Sonstiges", arbeitswerte: 16.0 },
                { name: "Polieren 2-Stufen (Fahrzeug komplett)", kategorie: "Sonstiges", arbeitswerte: 24.0 },
                { name: "Polieren 3-Stufen (Fahrzeug komplett)", kategorie: "Sonstiges", arbeitswerte: 32.0 },
                { name: "Polieren Einzelteil", kategorie: "Sonstiges", arbeitswerte: 4.0 },
                { name: "Scheinwerfer polieren (Paar)", kategorie: "Sonstiges", arbeitswerte: 4.0 },
                { name: "Versiegelung auftragen", kategorie: "Sonstiges", arbeitswerte: 6.0 },
                { name: "Keramikversiegelung", kategorie: "Sonstiges", arbeitswerte: 16.0 },

                // ================================================
                // SONSTIGES - DIVERSES
                // ================================================
                { name: "Fahrzeug auf HebebÃ¼hne", kategorie: "Sonstiges", arbeitswerte: 1.0 },
                { name: "Fahrzeug abkleben fÃ¼r Lackierung", kategorie: "Sonstiges", arbeitswerte: 8.0 },
                { name: "Fahrzeug komplett abkleben", kategorie: "Sonstiges", arbeitswerte: 12.0 },
                { name: "Folie entfernen (pro Teil)", kategorie: "Sonstiges", arbeitswerte: 4.0 },
                { name: "Aufkleber/Beschriftung entfernen", kategorie: "Sonstiges", arbeitswerte: 3.0 },
                { name: "Steinschlagschutzfolie montieren", kategorie: "Sonstiges", arbeitswerte: 8.0 },
                { name: "Probefahrt & Endkontrolle", kategorie: "Sonstiges", arbeitswerte: 2.0 },
                { name: "Dokumentation & Fotodokumentation", kategorie: "Sonstiges", arbeitswerte: 2.0 },
                { name: "Vor- und Nachbereitung Werkzeuge", kategorie: "Sonstiges", arbeitswerte: 6.0 },
            ];

            try {
                const batch = window.db.batch();
                const collectionRef = window.getCollection('kalkulation_katalog');

                SEED_DATA.forEach(item => {
                    const docRef = collectionRef.doc();
                    batch.set(docRef, {
                        ...item,
                        createdAt: new Date().toISOString()
                    });
                });

                await batch.commit();
                showToast(`${SEED_DATA.length} Positionen geladen`, 'success');
                await loadKatalog();

            } catch (error) {
                console.error('âŒ Fehler beim Laden des Standard-Katalogs:', error);
                showToast('Fehler beim Laden', 'error');
            }
        }

        // ============================================
        // MATERIAL-KATALOG (TAB 4)
        // ============================================

        async function loadMaterial() {
            try {
                const snapshot = await window.getCollection('kalkulation_material')
                    .orderBy('kategorie')
                    .orderBy('name')
                    .get();

                materialData = [];
                snapshot.forEach(doc => {
                    materialData.push({ id: doc.id, ...doc.data() });
                });

                renderMaterialKatalog();
                console.log(`âœ… ${materialData.length} Material-EintrÃ¤ge geladen`);
            } catch (error) {
                console.warn('âš ï¸ Material nicht gefunden:', error);
            }
        }

        function renderMaterialKatalog() {
            const container = document.getElementById('materialKatalogListe');

            if (materialData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i data-feather="package"></i>
                        <h3>Material-Katalog leer</h3>
                        <p>Erstellen Sie Ihren ersten Material-Eintrag</p>
                        <button class="btn btn-primary" onclick="seedMaterial()">
                            <i data-feather="download"></i>
                            Standard-Material laden
                        </button>
                    </div>
                `;
                feather.replace();
                return;
            }

            // Group by category
            const grouped = {};
            materialData.forEach(item => {
                const kat = item.kategorie || 'Sonstiges';
                if (!grouped[kat]) grouped[kat] = [];
                grouped[kat].push(item);
            });

            let html = '';
            Object.keys(grouped).sort().forEach(kategorie => {
                const items = grouped[kategorie];
                html += `
                    <div class="category-group">
                        <div class="category-header">
                            <h3>${kategorie}</h3>
                            <span class="count">${items.length}</span>
                        </div>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Bezeichnung</th>
                                    <th>EK</th>
                                    <th>VK</th>
                                    <th>Marge</th>
                                    <th>Einheit</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${items.map(item => {
                                    const marge = item.einkaufspreis > 0
                                        ? Math.round(((item.verkaufspreis - item.einkaufspreis) / item.einkaufspreis) * 100)
                                        : '-';
                                    return `
                                        <tr>
                                            <td>${item.name}</td>
                                            <td>${item.einkaufspreis ? item.einkaufspreis.toFixed(2) + ' â‚¬' : '-'}</td>
                                            <td>${item.verkaufspreis.toFixed(2)} â‚¬</td>
                                            <td>${marge}%</td>
                                            <td>${item.einheit || 'StÃ¼ck'}</td>
                                            <td class="actions">
                                                <button class="btn btn-icon btn-secondary" onclick="editMaterialPosition('${item.id}')" title="Bearbeiten">
                                                    <i data-feather="edit-2"></i>
                                                </button>
                                                <button class="btn btn-icon btn-secondary" onclick="deleteMaterialPosition('${item.id}')" title="LÃ¶schen" style="color: var(--color-error);">
                                                    <i data-feather="trash-2"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            });

            container.innerHTML = html;
            feather.replace();
        }

        function openMaterialKatalogModal(positionId = null) {
            const modal = document.getElementById('materialKatalogModal');
            if (!modal) {
                console.error('âŒ Material Modal nicht gefunden!');
                alert('Material Modal nicht gefunden!');
                return;
            }

            document.getElementById('materialModalTitle').textContent = positionId ? 'Material bearbeiten' : 'Neues Material';
            document.getElementById('materialPositionId').value = positionId || '';
            document.getElementById('materialForm').reset();

            if (positionId) {
                const item = materialData.find(p => p.id === positionId);
                if (item) {
                    document.getElementById('materialName').value = item.name || '';
                    document.getElementById('materialKategorie').value = item.kategorie || '';
                    document.getElementById('materialEK').value = item.einkaufspreis || '';
                    document.getElementById('materialVK').value = item.verkaufspreis || '';
                    document.getElementById('materialEinheit').value = item.einheit || 'StÃ¼ck';
                }
            }

            // Force display with inline styles
            modal.style.display = 'flex';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.right = '0';
            modal.style.bottom = '0';
            modal.style.zIndex = '99999';
            modal.style.background = 'rgba(0,0,0,0.7)';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.classList.add('active');

            // Force modal content to be visible
            const modalContent = modal.querySelector('.modal');
            if (modalContent) {
                modalContent.style.cssText = `
                    background: #ffffff !important;
                    padding: 0 !important;
                    border-radius: 16px !important;
                    max-width: 500px !important;
                    width: 90% !important;
                    box-shadow: 0 25px 50px rgba(0,0,0,0.5) !important;
                    z-index: 100000 !important;
                    position: relative !important;
                    display: block !important;
                    opacity: 1 !important;
                    visibility: visible !important;
                    transform: none !important;
                    pointer-events: auto !important;
                `;

                // Style header, body, footer for visibility and clickability
                const header = modalContent.querySelector('.modal-header');
                const body = modalContent.querySelector('.modal-body');
                const footer = modalContent.querySelector('.modal-footer');

                if (header) {
                    header.style.cssText = `
                        display: flex !important;
                        align-items: center !important;
                        justify-content: space-between !important;
                        padding: 16px 20px !important;
                        background: #f5f5f7 !important;
                        border-bottom: 1px solid #e0e0e0 !important;
                        border-radius: 16px 16px 0 0 !important;
                        pointer-events: auto !important;
                    `;
                }

                if (body) {
                    body.style.cssText = `
                        padding: 20px !important;
                        background: #ffffff !important;
                        pointer-events: auto !important;
                    `;
                }

                if (footer) {
                    footer.style.cssText = `
                        display: flex !important;
                        justify-content: flex-end !important;
                        gap: 12px !important;
                        padding: 16px 20px !important;
                        background: #f5f5f7 !important;
                        border-top: 1px solid #e0e0e0 !important;
                        border-radius: 0 0 16px 16px !important;
                        pointer-events: auto !important;
                    `;
                }

                // Style all buttons in modal to be clickable
                modalContent.querySelectorAll('button').forEach(btn => {
                    btn.style.pointerEvents = 'auto';
                    btn.style.cursor = 'pointer';
                });
            }

            feather.replace();
        }

        function editMaterialPosition(positionId) {
            openMaterialKatalogModal(positionId);
        }

        async function saveMaterialPosition(event) {
            event.preventDefault();

            const positionId = document.getElementById('materialPositionId').value;
            const data = {
                name: document.getElementById('materialName').value.trim(),
                kategorie: document.getElementById('materialKategorie').value,
                einkaufspreis: parseFloat(document.getElementById('materialEK').value) || 0,
                verkaufspreis: parseFloat(document.getElementById('materialVK').value) || 0,
                einheit: document.getElementById('materialEinheit').value,
                updatedAt: new Date().toISOString()
            };

            try {
                if (positionId) {
                    await window.getCollection('kalkulation_material').doc(positionId).update(data);
                    showToast('Material aktualisiert', 'success');
                } else {
                    data.createdAt = new Date().toISOString();
                    await window.getCollection('kalkulation_material').add(data);
                    showToast('Material erstellt', 'success');
                }

                closeModal('materialKatalogModal');
                await loadMaterial();

            } catch (error) {
                console.error('âŒ Fehler:', error);
                showToast('Fehler beim Speichern', 'error');
            }
        }

        async function deleteMaterialPosition(positionId) {
            if (!confirm('Material wirklich lÃ¶schen?')) return;

            try {
                await window.getCollection('kalkulation_material').doc(positionId).delete();
                showToast('Material gelÃ¶scht', 'success');
                await loadMaterial();
            } catch (error) {
                console.error('âŒ Fehler:', error);
                showToast('Fehler beim LÃ¶schen', 'error');
            }
        }

        // ============================================
        // TEMPLATE-VERWALTUNG
        // ============================================

        async function loadTemplates() {
            try {
                const snapshot = await window.getCollection('kalkulation_templates').orderBy('name').get();
                templateData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderEigeneTemplates();
            } catch (error) {
                console.error('âŒ Fehler beim Laden der Templates:', error);
            }
        }

        function renderEigeneTemplates() {
            const container = document.getElementById('eigeneTemplateListe');
            if (!container) return;

            if (templateData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <i data-feather="bookmark"></i>
                        <h4>Keine eigenen Templates</h4>
                        <p>Erstellen Sie eigene Templates aus abgeschlossenen Kalkulationen</p>
                    </div>
                `;
                feather.replace();
                return;
            }

            const kategorieLabels = {
                'lackierung': 'Lackierung',
                'smart_repair': 'Smart Repair',
                'unfall': 'Unfall',
                'sonstiges': 'Sonstiges'
            };

            container.innerHTML = templateData.map(template => `
                <div class="template-card" onclick="loadTemplate('custom_${template.id}')">
                    <div class="template-card__icon">${template.icon || 'ðŸ“‹'}</div>
                    <div class="template-card__content">
                        <h4>${template.name}</h4>
                        <p>${template.beschreibung || 'Eigenes Template'}</p>
                        <div class="template-card__meta">
                            <span><i data-feather="clock"></i> ${template.geschaetzteZeit || 'k.A.'}</span>
                            <span><i data-feather="tag"></i> ${kategorieLabels[template.kategorie] || template.kategorie}</span>
                        </div>
                    </div>
                    <div class="template-card__actions" onclick="event.stopPropagation();">
                        <button class="btn btn-sm btn-ghost" onclick="editTemplate('${template.id}')" title="Bearbeiten">
                            <i data-feather="edit-2"></i>
                        </button>
                        <button class="btn btn-sm btn-ghost" onclick="deleteTemplate('${template.id}')" title="LÃ¶schen">
                            <i data-feather="trash-2"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            feather.replace();
        }

        function openTemplateModal(templateId = null) {
            const modal = document.getElementById('templateModal');
            if (!modal) return;

            document.getElementById('templateModalTitle').textContent = templateId ? 'Template bearbeiten' : 'Neues Template';
            document.getElementById('templateId').value = templateId || '';
            document.getElementById('templateForm').reset();

            if (templateId) {
                const template = templateData.find(t => t.id === templateId);
                if (template) {
                    document.getElementById('templateName').value = template.name || '';
                    document.getElementById('templateKategorie').value = template.kategorie || '';
                    document.getElementById('templateBeschreibung').value = template.beschreibung || '';
                    document.getElementById('templateIcon').value = template.icon || '';
                    document.getElementById('templateGeschaetzteZeit').value = template.geschaetzteZeit || '';
                }
            }

            // Force display with inline styles (same pattern as other modals)
            modal.style.display = 'flex';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.right = '0';
            modal.style.bottom = '0';
            modal.style.zIndex = '99999';
            modal.style.background = 'rgba(0,0,0,0.7)';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.classList.add('active');

            const modalContent = modal.querySelector('.modal');
            if (modalContent) {
                modalContent.style.cssText = `
                    background: #ffffff !important;
                    padding: 0 !important;
                    border-radius: 16px !important;
                    max-width: 500px !important;
                    width: 90% !important;
                    box-shadow: 0 25px 50px rgba(0,0,0,0.5) !important;
                    z-index: 100000 !important;
                    position: relative !important;
                    display: block !important;
                    opacity: 1 !important;
                    visibility: visible !important;
                    transform: none !important;
                    pointer-events: auto !important;
                `;

                const header = modalContent.querySelector('.modal-header');
                const body = modalContent.querySelector('.modal-body');
                const footer = modalContent.querySelector('.modal-footer');

                if (header) {
                    header.style.cssText = `
                        display: flex !important;
                        align-items: center !important;
                        justify-content: space-between !important;
                        padding: 16px 20px !important;
                        background: #f5f5f7 !important;
                        border-bottom: 1px solid #e0e0e0 !important;
                        border-radius: 16px 16px 0 0 !important;
                        pointer-events: auto !important;
                    `;
                }

                if (body) {
                    body.style.cssText = `
                        padding: 20px !important;
                        background: #ffffff !important;
                        pointer-events: auto !important;
                    `;
                }

                if (footer) {
                    footer.style.cssText = `
                        display: flex !important;
                        justify-content: flex-end !important;
                        gap: 12px !important;
                        padding: 16px 20px !important;
                        background: #f5f5f7 !important;
                        border-top: 1px solid #e0e0e0 !important;
                        border-radius: 0 0 16px 16px !important;
                        pointer-events: auto !important;
                    `;
                }

                modalContent.querySelectorAll('button').forEach(btn => {
                    btn.style.pointerEvents = 'auto';
                    btn.style.cursor = 'pointer';
                });
            }

            feather.replace();
        }

        function editTemplate(templateId) {
            openTemplateModal(templateId);
        }

        async function saveTemplate(event) {
            event.preventDefault();

            const templateId = document.getElementById('templateId').value;
            const uebernahmePositionen = document.getElementById('templateUebernahmePositionen').checked;
            const uebernahmeMaterial = document.getElementById('templateUebernahmeMaterial').checked;

            const data = {
                name: document.getElementById('templateName').value.trim(),
                kategorie: document.getElementById('templateKategorie').value,
                beschreibung: document.getElementById('templateBeschreibung').value.trim(),
                icon: document.getElementById('templateIcon').value.trim() || 'ðŸ“‹',
                geschaetzteZeit: document.getElementById('templateGeschaetzteZeit').value.trim(),
                updatedAt: new Date().toISOString()
            };

            // Ãœbernehme Positionen aus aktueller Kalkulation wenn gewÃ¼nscht
            if (uebernahmePositionen && aktuelleKalkulation.positionen.length > 0) {
                data.positionen = aktuelleKalkulation.positionen.map(p => ({
                    name: p.name,
                    kategorie: p.kategorie,
                    aw: p.aw,
                    beschreibung: p.beschreibung || ''
                }));
            }

            if (uebernahmeMaterial && aktuelleKalkulation.materialien.length > 0) {
                data.materialien = aktuelleKalkulation.materialien.map(m => ({
                    name: m.name,
                    kategorie: m.kategorie,
                    menge: m.menge,
                    einzelpreis: m.einzelpreis,
                    einheit: m.einheit || 'StÃ¼ck'
                }));
            }

            try {
                if (templateId) {
                    await window.getCollection('kalkulation_templates').doc(templateId).update(data);
                    showToast('Template aktualisiert', 'success');
                } else {
                    data.createdAt = new Date().toISOString();
                    await window.getCollection('kalkulation_templates').add(data);
                    showToast('Template erstellt', 'success');
                }

                closeModal('templateModal');
                await loadTemplates();

            } catch (error) {
                console.error('âŒ Fehler:', error);
                showToast('Fehler beim Speichern', 'error');
            }
        }

        async function deleteTemplate(templateId) {
            if (!confirm('Template wirklich lÃ¶schen?')) return;

            try {
                await window.getCollection('kalkulation_templates').doc(templateId).delete();
                showToast('Template gelÃ¶scht', 'success');
                await loadTemplates();
            } catch (error) {
                console.error('âŒ Fehler:', error);
                showToast('Fehler beim LÃ¶schen', 'error');
            }
        }

        function filterTemplates(category) {
            // Update active button
            document.querySelectorAll('.template-category').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.category === category);
            });

            // Filter template cards
            const cards = document.querySelectorAll('#templateListe .template-card');
            cards.forEach(card => {
                const cardCategory = card.querySelector('.template-card__meta span:last-child')?.textContent?.toLowerCase() || '';
                if (category === 'all') {
                    card.style.display = '';
                } else {
                    const match = cardCategory.includes(category.replace('_', ' '));
                    card.style.display = match ? '' : 'none';
                }
            });
        }

        // ============================================
        // LIEFERANTEN-VERWALTUNG
        // ============================================

        async function loadLieferanten() {
            try {
                const snapshot = await window.getCollection('kalkulation_lieferanten').orderBy('name').get();
                lieferantenData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderLieferanten();
                updateLieferantenDropdowns();
                await loadErsatzteileForLieferanten();
            } catch (error) {
                console.error('âŒ Fehler beim Laden der Lieferanten:', error);
            }
        }

        // Aktualisiert alle Lieferanten-Dropdowns mit DB-Daten
        function updateLieferantenDropdowns() {
            const dropdowns = [
                document.getElementById('ersatzteilInlineLieferant'),
                document.getElementById('ersatzteilAddLieferant')
            ];

            // Standard-Lieferanten (immer verfÃ¼gbar)
            const standardOptions = [
                { value: '', label: 'Lieferant wÃ¤hlen' },
                { value: 'DAT', label: 'DAT' },
                { value: 'Partslink24', label: 'Partslink24' },
                { value: 'Tecdoc', label: 'Tecdoc' },
                { value: 'Hersteller OE', label: 'Hersteller OE' },
                { value: 'Aftermarket', label: 'Aftermarket' },
                { value: 'Gebraucht', label: 'Gebraucht' }
            ];

            // Eigene Lieferanten aus DB hinzufÃ¼gen
            const eigeneOptions = lieferantenData.map(l => ({
                value: l.name,
                label: `${l.icon || 'ðŸ¢'} ${l.name}`
            }));

            dropdowns.forEach(dropdown => {
                if (!dropdown) return;

                // Aktuellen Wert merken
                const currentValue = dropdown.value;

                if (dropdown.tagName === 'SELECT') {
                    // Select-Element: Options ersetzen
                    dropdown.innerHTML = '';

                    // Standard-Optionen
                    standardOptions.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt.value;
                        option.textContent = opt.label;
                        dropdown.appendChild(option);
                    });

                    // Trennlinie wenn eigene Lieferanten vorhanden
                    if (eigeneOptions.length > 0) {
                        const divider = document.createElement('option');
                        divider.disabled = true;
                        divider.textContent = 'â”€â”€ Eigene Lieferanten â”€â”€';
                        dropdown.appendChild(divider);

                        eigeneOptions.forEach(opt => {
                            const option = document.createElement('option');
                            option.value = opt.value;
                            option.textContent = opt.label;
                            dropdown.appendChild(option);
                        });
                    }

                    // Wert wiederherstellen
                    dropdown.value = currentValue;
                } else if (dropdown.tagName === 'INPUT') {
                    // Input mit datalist: Datalist befÃ¼llen
                    const datalistId = dropdown.getAttribute('list');
                    let datalist = document.getElementById(datalistId);

                    if (!datalist) {
                        datalist = document.createElement('datalist');
                        datalist.id = datalistId || 'lieferantSuggestions';
                        dropdown.parentNode.appendChild(datalist);
                        dropdown.setAttribute('list', datalist.id);
                    }

                    datalist.innerHTML = '';

                    // Alle Optionen als VorschlÃ¤ge
                    [...standardOptions.slice(1), ...eigeneOptions].forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt.value;
                        datalist.appendChild(option);
                    });
                }
            });
        }

        // LÃ¤dt alle Ersatzteile und gruppiert sie nach Lieferant
        let ersatzteileByLieferant = {};

        async function loadErsatzteileForLieferanten() {
            try {
                const snapshot = await window.getCollection('ersatzteile').get();
                ersatzteileByLieferant = {};

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const lieferanten = data.lieferanten || [];

                    // Ersatzteil jedem Lieferanten zuordnen
                    lieferanten.forEach(lief => {
                        const lieferantName = lief.name || 'Unbekannt';
                        if (!ersatzteileByLieferant[lieferantName]) {
                            ersatzteileByLieferant[lieferantName] = [];
                        }
                        ersatzteileByLieferant[lieferantName].push({
                            id: doc.id,
                            name: data.name,
                            teilenummer: data.teilenummer || '',
                            preis: lief.preis || data.letzterPreis || 0,
                            datum: lief.datum || data.updatedAt,
                            fahrzeuge: data.fahrzeuge || [],
                            verwendetAnzahl: data.verwendetAnzahl || 0
                        });
                    });

                    // Falls keine Lieferanten-Array, aber lieferant-Feld existiert
                    if (lieferanten.length === 0 && data.lieferant) {
                        const lieferantName = data.lieferant;
                        if (!ersatzteileByLieferant[lieferantName]) {
                            ersatzteileByLieferant[lieferantName] = [];
                        }
                        ersatzteileByLieferant[lieferantName].push({
                            id: doc.id,
                            name: data.name,
                            teilenummer: data.teilenummer || '',
                            preis: data.letzterPreis || 0,
                            datum: data.updatedAt,
                            fahrzeuge: data.fahrzeuge || [],
                            verwendetAnzahl: data.verwendetAnzahl || 0
                        });
                    }
                });

                console.log(`ðŸ“¦ Ersatzteile nach Lieferant gruppiert:`, Object.keys(ersatzteileByLieferant).length, 'Lieferanten');
                renderLieferantenMitErsatzteilen();
            } catch (error) {
                console.error('âŒ Fehler beim Laden der Ersatzteile fÃ¼r Lieferanten:', error);
            }
        }

        // Rendert die Ersatzteile gruppiert nach Lieferant
        function renderLieferantenMitErsatzteilen() {
            const container = document.getElementById('ersatzteileByLieferantContainer');
            const countBadge = document.getElementById('ersatzteileCountBadge');
            if (!container) return;

            const lieferantNames = Object.keys(ersatzteileByLieferant).sort();

            if (lieferantNames.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i data-feather="package"></i>
                        <h4>Keine Ersatzteile erfasst</h4>
                        <p>Ersatzteile werden hier nach Lieferant gruppiert angezeigt, sobald Sie welche in Kalkulationen verwenden</p>
                    </div>
                `;
                if (countBadge) countBadge.textContent = '0 Teile';
                feather.replace();
                return;
            }

            // Gesamtzahl berechnen
            let totalTeile = 0;
            lieferantNames.forEach(name => {
                totalTeile += ersatzteileByLieferant[name].length;
            });
            if (countBadge) countBadge.textContent = `${totalTeile} Teile`;

            // Icon fÃ¼r Lieferant ermitteln
            function getLieferantIcon(name) {
                // PrÃ¼fen ob eigener Lieferant mit Icon
                const eigeneLieferant = lieferantenData.find(l => l.name === name);
                if (eigeneLieferant?.icon) return eigeneLieferant.icon;

                // Standard-Icons
                const iconMap = {
                    'DAT': 'ðŸ”§',
                    'Partslink24': 'ðŸš—',
                    'Tecdoc': 'ðŸ“š',
                    'TecDoc': 'ðŸ“š',
                    'Hersteller OE': 'ðŸ­',
                    'Aftermarket': 'ðŸ”„',
                    'Gebraucht': 'â™»ï¸',
                    'Stahlgruber': 'ðŸ›’'
                };
                return iconMap[name] || 'ðŸ¢';
            }

            container.innerHTML = lieferantNames.map((lieferantName, index) => {
                const teile = ersatzteileByLieferant[lieferantName];
                const gesamtWert = teile.reduce((sum, t) => sum + (t.preis || 0), 0);
                const icon = getLieferantIcon(lieferantName);

                return `
                    <div class="lieferant-ersatzteile-section">
                        <div class="lieferant-ersatzteile-header" onclick="toggleLieferantErsatzteile(${index})">
                            <div class="lieferant-ersatzteile-header__info">
                                <span style="font-size: 1.5rem;">${icon}</span>
                                <h4>${lieferantName}</h4>
                                <span class="badge badge--info">${teile.length} Teile</span>
                            </div>
                            <div class="lieferant-ersatzteile-header__stats">
                                <span>Gesamtwert: <strong>${gesamtWert.toFixed(2)} â‚¬</strong></span>
                                <i data-feather="chevron-down" class="chevron-icon" id="chevron-${index}"></i>
                            </div>
                        </div>
                        <div class="lieferant-ersatzteile-body" id="lieferant-body-${index}">
                            <div class="lieferant-ersatzteile-list">
                                ${teile.map(teil => `
                                    <div class="lieferant-ersatzteil-item">
                                        <div class="lieferant-ersatzteil-item__name">
                                            ${teil.name}
                                            ${teil.teilenummer ? `<small>Nr: ${teil.teilenummer}</small>` : ''}
                                        </div>
                                        <div class="lieferant-ersatzteil-item__preis">
                                            ${teil.preis > 0 ? teil.preis.toFixed(2) + ' â‚¬' : '-'}
                                        </div>
                                        <div class="lieferant-ersatzteil-item__count">
                                            ${teil.verwendetAnzahl}Ã— verwendet
                                        </div>
                                        <div class="lieferant-ersatzteil-item__fahrzeuge">
                                            ${teil.fahrzeuge.length > 0
                                                ? `<span class="badge badge--secondary" title="${teil.fahrzeuge.join(', ')}">${teil.fahrzeuge.length} Fahrzeuge</span>`
                                                : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            feather.replace();
        }

        // Toggle-Funktion fÃ¼r Lieferanten-Ersatzteile-Akkordeon
        function toggleLieferantErsatzteile(index) {
            const body = document.getElementById(`lieferant-body-${index}`);
            const chevron = document.getElementById(`chevron-${index}`);

            if (body) {
                body.classList.toggle('expanded');
            }
            if (chevron) {
                chevron.style.transform = body?.classList.contains('expanded') ? 'rotate(180deg)' : 'rotate(0deg)';
            }
        }

        function renderLieferanten() {
            const container = document.getElementById('lieferantenListe');
            if (!container) return;

            // Behalte die Standard-Lieferanten und fÃ¼ge eigene hinzu
            const standardLieferanten = container.querySelectorAll('.lieferant-card:not(.custom-lieferant)');

            // Entferne nur eigene Lieferanten
            container.querySelectorAll('.lieferant-card.custom-lieferant').forEach(el => el.remove());

            if (lieferantenData.length === 0) return;

            const typLabels = {
                'oem': 'OEM',
                'aftermarket': 'Aftermarket',
                'lackmaterial': 'Lackmaterial',
                'verbrauchsmaterial': 'Verbrauch',
                'werkzeug': 'Werkzeug',
                'sonstiges': 'Sonstiges'
            };

            const typBadgeClass = {
                'oem': 'badge--success',
                'aftermarket': 'badge--warning',
                'lackmaterial': 'badge--info',
                'verbrauchsmaterial': 'badge--secondary',
                'werkzeug': 'badge--primary',
                'sonstiges': 'badge--secondary'
            };

            const html = lieferantenData.map(lieferant => `
                <div class="lieferant-card custom-lieferant">
                    <div class="lieferant-card__logo">
                        <span style="font-size: 2rem;">${lieferant.icon || 'ðŸ¢'}</span>
                    </div>
                    <div class="lieferant-card__content">
                        <h4>${lieferant.name}</h4>
                        <p>${lieferant.notizen || 'Eigener Lieferant'}</p>
                        <div class="lieferant-card__meta">
                            <span class="badge ${typBadgeClass[lieferant.typ] || 'badge--secondary'}">${typLabels[lieferant.typ] || lieferant.typ}</span>
                            ${lieferant.website ? `
                                <a href="${lieferant.website}" target="_blank" class="btn btn-sm btn-secondary">
                                    <i data-feather="external-link"></i>
                                    Ã–ffnen
                                </a>
                            ` : ''}
                            <button class="btn btn-sm btn-ghost" onclick="editLieferant('${lieferant.id}')" title="Bearbeiten">
                                <i data-feather="edit-2"></i>
                            </button>
                            <button class="btn btn-sm btn-ghost" onclick="deleteLieferant('${lieferant.id}')" title="LÃ¶schen">
                                <i data-feather="trash-2"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            container.insertAdjacentHTML('beforeend', html);
            feather.replace();
        }

        function openLieferantModal(lieferantId = null) {
            const modal = document.getElementById('lieferantModal');
            if (!modal) return;

            document.getElementById('lieferantModalTitle').textContent = lieferantId ? 'Lieferant bearbeiten' : 'Neuer Lieferant';
            document.getElementById('lieferantId').value = lieferantId || '';
            document.getElementById('lieferantForm').reset();

            if (lieferantId) {
                const lieferant = lieferantenData.find(l => l.id === lieferantId);
                if (lieferant) {
                    document.getElementById('lieferantName').value = lieferant.name || '';
                    document.getElementById('lieferantTyp').value = lieferant.typ || '';
                    document.getElementById('lieferantWebsite').value = lieferant.website || '';
                    document.getElementById('lieferantTelefon').value = lieferant.telefon || '';
                    document.getElementById('lieferantEmail').value = lieferant.email || '';
                    document.getElementById('lieferantKundennummer').value = lieferant.kundennummer || '';
                    document.getElementById('lieferantIcon').value = lieferant.icon || '';
                    document.getElementById('lieferantNotizen').value = lieferant.notizen || '';
                }
            }

            // Force display with inline styles (same pattern as other modals)
            modal.style.display = 'flex';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.right = '0';
            modal.style.bottom = '0';
            modal.style.zIndex = '99999';
            modal.style.background = 'rgba(0,0,0,0.7)';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.classList.add('active');

            const modalContent = modal.querySelector('.modal');
            if (modalContent) {
                modalContent.style.cssText = `
                    background: #ffffff !important;
                    padding: 0 !important;
                    border-radius: 16px !important;
                    max-width: 500px !important;
                    width: 90% !important;
                    box-shadow: 0 25px 50px rgba(0,0,0,0.5) !important;
                    z-index: 100000 !important;
                    position: relative !important;
                    display: block !important;
                    opacity: 1 !important;
                    visibility: visible !important;
                    transform: none !important;
                    pointer-events: auto !important;
                `;

                const header = modalContent.querySelector('.modal-header');
                const body = modalContent.querySelector('.modal-body');
                const footer = modalContent.querySelector('.modal-footer');

                if (header) {
                    header.style.cssText = `
                        display: flex !important;
                        align-items: center !important;
                        justify-content: space-between !important;
                        padding: 16px 20px !important;
                        background: #f5f5f7 !important;
                        border-bottom: 1px solid #e0e0e0 !important;
                        border-radius: 16px 16px 0 0 !important;
                        pointer-events: auto !important;
                    `;
                }

                if (body) {
                    body.style.cssText = `
                        padding: 20px !important;
                        background: #ffffff !important;
                        pointer-events: auto !important;
                        max-height: 60vh !important;
                        overflow-y: auto !important;
                    `;
                }

                if (footer) {
                    footer.style.cssText = `
                        display: flex !important;
                        justify-content: flex-end !important;
                        gap: 12px !important;
                        padding: 16px 20px !important;
                        background: #f5f5f7 !important;
                        border-top: 1px solid #e0e0e0 !important;
                        border-radius: 0 0 16px 16px !important;
                        pointer-events: auto !important;
                    `;
                }

                modalContent.querySelectorAll('button').forEach(btn => {
                    btn.style.pointerEvents = 'auto';
                    btn.style.cursor = 'pointer';
                });
            }

            feather.replace();
        }

        function editLieferant(lieferantId) {
            openLieferantModal(lieferantId);
        }

        async function saveLieferant(event) {
            event.preventDefault();

            const lieferantId = document.getElementById('lieferantId').value;
            const data = {
                name: document.getElementById('lieferantName').value.trim(),
                typ: document.getElementById('lieferantTyp').value,
                website: document.getElementById('lieferantWebsite').value.trim(),
                telefon: document.getElementById('lieferantTelefon').value.trim(),
                email: document.getElementById('lieferantEmail').value.trim(),
                kundennummer: document.getElementById('lieferantKundennummer').value.trim(),
                icon: document.getElementById('lieferantIcon').value.trim() || 'ðŸ¢',
                notizen: document.getElementById('lieferantNotizen').value.trim(),
                updatedAt: new Date().toISOString()
            };

            try {
                if (lieferantId) {
                    await window.getCollection('kalkulation_lieferanten').doc(lieferantId).update(data);
                    showToast('Lieferant aktualisiert', 'success');
                } else {
                    data.createdAt = new Date().toISOString();
                    await window.getCollection('kalkulation_lieferanten').add(data);
                    showToast('Lieferant erstellt', 'success');
                }

                closeModal('lieferantModal');
                await loadLieferanten();

            } catch (error) {
                console.error('âŒ Fehler:', error);
                showToast('Fehler beim Speichern', 'error');
            }
        }

        async function deleteLieferant(lieferantId) {
            if (!confirm('Lieferant wirklich lÃ¶schen?')) return;

            try {
                await window.getCollection('kalkulation_lieferanten').doc(lieferantId).delete();
                showToast('Lieferant gelÃ¶scht', 'success');
                await loadLieferanten();
            } catch (error) {
                console.error('âŒ Fehler:', error);
                showToast('Fehler beim LÃ¶schen', 'error');
            }
        }

        async function seedMaterial() {
            // ============================================
            // ðŸŽ¨ UMFANGREICHER MATERIAL-KATALOG
            // Basierend auf Marktpreisen 2024 (Standox, Spies Hecker, Glasurit, Mipa)
            // EK = Einkaufspreis (HÃ¤ndlerpreis), VK = Verkaufspreis (Endkundenpreis)
            // Quellen: lackcolor.de, autolack-burmeister.shop, carross.eu
            // ============================================
            const SEED_DATA = [
                // ================================================
                // LACKMATERIAL - GRUNDIERUNG / PRIMER
                // ================================================
                { name: "Haftgrund 1K (1L)", kategorie: "Lackmaterial", einkaufspreis: 18.00, verkaufspreis: 35.00, einheit: "Liter" },
                { name: "FÃ¼llgrund 2K (1L)", kategorie: "Lackmaterial", einkaufspreis: 28.00, verkaufspreis: 52.00, einheit: "Liter" },
                { name: "Wash-Primer (1L)", kategorie: "Lackmaterial", einkaufspreis: 22.00, verkaufspreis: 42.00, einheit: "Liter" },
                { name: "Kunststoff-Primer (1L)", kategorie: "Lackmaterial", einkaufspreis: 32.00, verkaufspreis: 58.00, einheit: "Liter" },
                { name: "Aluminium-Primer (1L)", kategorie: "Lackmaterial", einkaufspreis: 35.00, verkaufspreis: 65.00, einheit: "Liter" },
                { name: "Zinkstaubgrund (1L)", kategorie: "Lackmaterial", einkaufspreis: 28.00, verkaufspreis: 52.00, einheit: "Liter" },
                { name: "Epoxy-Grundierung 2K (1L)", kategorie: "Lackmaterial", einkaufspreis: 38.00, verkaufspreis: 72.00, einheit: "Liter" },
                { name: "Grundierung grau RAL 7035 (1L)", kategorie: "Lackmaterial", einkaufspreis: 22.00, verkaufspreis: 42.00, einheit: "Liter" },

                // ================================================
                // LACKMATERIAL - FÃœLLER
                // ================================================
                { name: "2K-HS-FÃ¼ller grau (1L)", kategorie: "Lackmaterial", einkaufspreis: 25.00, verkaufspreis: 48.00, einheit: "Liter" },
                { name: "2K-HS-FÃ¼ller weiÃŸ (1L)", kategorie: "Lackmaterial", einkaufspreis: 26.00, verkaufspreis: 50.00, einheit: "Liter" },
                { name: "2K-HS-FÃ¼ller schwarz (1L)", kategorie: "Lackmaterial", einkaufspreis: 26.00, verkaufspreis: 50.00, einheit: "Liter" },
                { name: "Nass-in-Nass FÃ¼ller (1L)", kategorie: "Lackmaterial", einkaufspreis: 32.00, verkaufspreis: 58.00, einheit: "Liter" },
                { name: "ExpressfÃ¼ller (1L)", kategorie: "Lackmaterial", einkaufspreis: 35.00, verkaufspreis: 65.00, einheit: "Liter" },
                { name: "UV-FÃ¼ller (200ml)", kategorie: "Lackmaterial", einkaufspreis: 42.00, verkaufspreis: 78.00, einheit: "StÃ¼ck" },
                { name: "SpritzfÃ¼ller grau Spraydose (400ml)", kategorie: "Lackmaterial", einkaufspreis: 8.50, verkaufspreis: 16.00, einheit: "StÃ¼ck" },

                // ================================================
                // LACKMATERIAL - BASISLACK
                // ================================================
                { name: "Basislack Uni nach Farbcode (1L)", kategorie: "Lackmaterial", einkaufspreis: 45.00, verkaufspreis: 89.00, einheit: "Liter" },
                { name: "Basislack Metallic nach Farbcode (1L)", kategorie: "Lackmaterial", einkaufspreis: 55.00, verkaufspreis: 105.00, einheit: "Liter" },
                { name: "Basislack Perleffekt nach Farbcode (1L)", kategorie: "Lackmaterial", einkaufspreis: 65.00, verkaufspreis: 125.00, einheit: "Liter" },
                { name: "Basislack Sonderfarbe (1L)", kategorie: "Lackmaterial", einkaufspreis: 85.00, verkaufspreis: 165.00, einheit: "Liter" },
                { name: "Basislack Schwarz uni (1L)", kategorie: "Lackmaterial", einkaufspreis: 38.00, verkaufspreis: 72.00, einheit: "Liter" },
                { name: "Basislack WeiÃŸ uni (1L)", kategorie: "Lackmaterial", einkaufspreis: 38.00, verkaufspreis: 72.00, einheit: "Liter" },
                { name: "Basislack Silber metallic (1L)", kategorie: "Lackmaterial", einkaufspreis: 48.00, verkaufspreis: 92.00, einheit: "Liter" },
                { name: "Mittellack Perllack 3-Schicht (1L)", kategorie: "Lackmaterial", einkaufspreis: 75.00, verkaufspreis: 145.00, einheit: "Liter" },
                { name: "Basislack-VerdÃ¼nnung (1L)", kategorie: "Lackmaterial", einkaufspreis: 12.00, verkaufspreis: 24.00, einheit: "Liter" },

                // ================================================
                // LACKMATERIAL - KLARLACK (Standox/Spies Hecker Niveau)
                // ================================================
                { name: "2K-HS-Klarlack Standard (1L)", kategorie: "Lackmaterial", einkaufspreis: 35.00, verkaufspreis: 68.00, einheit: "Liter" },
                { name: "2K-HS-Klarlack Premium (1L)", kategorie: "Lackmaterial", einkaufspreis: 48.00, verkaufspreis: 92.00, einheit: "Liter" },
                { name: "2K-MS-Klarlack (1L)", kategorie: "Lackmaterial", einkaufspreis: 32.00, verkaufspreis: 62.00, einheit: "Liter" },
                { name: "Klarlack matt 2K (1L)", kategorie: "Lackmaterial", einkaufspreis: 52.00, verkaufspreis: 98.00, einheit: "Liter" },
                { name: "Klarlack seidenmatt 2K (1L)", kategorie: "Lackmaterial", einkaufspreis: 48.00, verkaufspreis: 92.00, einheit: "Liter" },
                { name: "Schnellklarlack Express (1L)", kategorie: "Lackmaterial", einkaufspreis: 42.00, verkaufspreis: 82.00, einheit: "Liter" },
                { name: "Scratch-Resistant Klarlack (1L)", kategorie: "Lackmaterial", einkaufspreis: 58.00, verkaufspreis: 112.00, einheit: "Liter" },
                { name: "UV-Klarlack (200ml)", kategorie: "Lackmaterial", einkaufspreis: 48.00, verkaufspreis: 92.00, einheit: "StÃ¼ck" },
                { name: "Klarlack Spraydose (400ml)", kategorie: "Lackmaterial", einkaufspreis: 9.50, verkaufspreis: 18.00, einheit: "StÃ¼ck" },

                // ================================================
                // LACKMATERIAL - HÃ„RTER
                // ================================================
                { name: "HÃ¤rter Standard (0.5L)", kategorie: "Lackmaterial", einkaufspreis: 15.00, verkaufspreis: 28.00, einheit: "Liter" },
                { name: "HÃ¤rter Standard (1L)", kategorie: "Lackmaterial", einkaufspreis: 28.00, verkaufspreis: 52.00, einheit: "Liter" },
                { name: "HÃ¤rter schnell (0.5L)", kategorie: "Lackmaterial", einkaufspreis: 18.00, verkaufspreis: 34.00, einheit: "Liter" },
                { name: "HÃ¤rter schnell (1L)", kategorie: "Lackmaterial", einkaufspreis: 32.00, verkaufspreis: 62.00, einheit: "Liter" },
                { name: "HÃ¤rter langsam (0.5L)", kategorie: "Lackmaterial", einkaufspreis: 18.00, verkaufspreis: 34.00, einheit: "Liter" },
                { name: "HÃ¤rter langsam (1L)", kategorie: "Lackmaterial", einkaufspreis: 32.00, verkaufspreis: 62.00, einheit: "Liter" },
                { name: "FÃ¼ller-HÃ¤rter (0.5L)", kategorie: "Lackmaterial", einkaufspreis: 14.00, verkaufspreis: 26.00, einheit: "Liter" },
                { name: "Epoxy-HÃ¤rter (0.5L)", kategorie: "Lackmaterial", einkaufspreis: 22.00, verkaufspreis: 42.00, einheit: "Liter" },

                // ================================================
                // LACKMATERIAL - VERDÃœNNUNG
                // ================================================
                { name: "AcrylverdÃ¼nnung normal (1L)", kategorie: "Lackmaterial", einkaufspreis: 10.00, verkaufspreis: 19.00, einheit: "Liter" },
                { name: "AcrylverdÃ¼nnung normal (5L)", kategorie: "Lackmaterial", einkaufspreis: 42.00, verkaufspreis: 78.00, einheit: "StÃ¼ck" },
                { name: "AcrylverdÃ¼nnung schnell (1L)", kategorie: "Lackmaterial", einkaufspreis: 12.00, verkaufspreis: 22.00, einheit: "Liter" },
                { name: "AcrylverdÃ¼nnung langsam (1L)", kategorie: "Lackmaterial", einkaufspreis: 12.00, verkaufspreis: 22.00, einheit: "Liter" },
                { name: "NitroverdÃ¼nnung (1L)", kategorie: "Lackmaterial", einkaufspreis: 6.00, verkaufspreis: 12.00, einheit: "Liter" },
                { name: "NitroverdÃ¼nnung (5L)", kategorie: "Lackmaterial", einkaufspreis: 22.00, verkaufspreis: 42.00, einheit: "StÃ¼ck" },
                { name: "UniversalverdÃ¼nnung (1L)", kategorie: "Lackmaterial", einkaufspreis: 8.00, verkaufspreis: 15.00, einheit: "Liter" },

                // ================================================
                // LACKMATERIAL - ADDITIVE
                // ================================================
                { name: "Antikraterzusatz (250ml)", kategorie: "Lackmaterial", einkaufspreis: 12.00, verkaufspreis: 22.00, einheit: "StÃ¼ck" },
                { name: "Silikonentferner (1L)", kategorie: "Lackmaterial", einkaufspreis: 8.00, verkaufspreis: 15.00, einheit: "Liter" },
                { name: "Silikonentferner (5L)", kategorie: "Lackmaterial", einkaufspreis: 32.00, verkaufspreis: 58.00, einheit: "StÃ¼ck" },
                { name: "Antistatikmittel (500ml)", kategorie: "Lackmaterial", einkaufspreis: 15.00, verkaufspreis: 28.00, einheit: "StÃ¼ck" },
                { name: "Verlaufsmittel (250ml)", kategorie: "Lackmaterial", einkaufspreis: 18.00, verkaufspreis: 34.00, einheit: "StÃ¼ck" },
                { name: "Trocknungsbeschleuniger (250ml)", kategorie: "Lackmaterial", einkaufspreis: 22.00, verkaufspreis: 42.00, einheit: "StÃ¼ck" },
                { name: "Elastifizierungsmittel (500ml)", kategorie: "Lackmaterial", einkaufspreis: 25.00, verkaufspreis: 48.00, einheit: "StÃ¼ck" },

                // ================================================
                // SPACHTELMASSE
                // ================================================
                { name: "Universalspachtel (1kg)", kategorie: "Spachtelmasse", einkaufspreis: 8.00, verkaufspreis: 16.00, einheit: "kg" },
                { name: "Universalspachtel (2kg)", kategorie: "Spachtelmasse", einkaufspreis: 14.00, verkaufspreis: 28.00, einheit: "kg" },
                { name: "Feinspachtel (500g)", kategorie: "Spachtelmasse", einkaufspreis: 8.00, verkaufspreis: 15.00, einheit: "StÃ¼ck" },
                { name: "Feinspachtel (1kg)", kategorie: "Spachtelmasse", einkaufspreis: 12.00, verkaufspreis: 24.00, einheit: "kg" },
                { name: "Glasfaserspachtel (500g)", kategorie: "Spachtelmasse", einkaufspreis: 12.00, verkaufspreis: 24.00, einheit: "StÃ¼ck" },
                { name: "Glasfaserspachtel (1kg)", kategorie: "Spachtelmasse", einkaufspreis: 18.00, verkaufspreis: 35.00, einheit: "kg" },
                { name: "Aluminiumspachtel (500g)", kategorie: "Spachtelmasse", einkaufspreis: 15.00, verkaufspreis: 28.00, einheit: "StÃ¼ck" },
                { name: "Kunststoffspachtel (500g)", kategorie: "Spachtelmasse", einkaufspreis: 14.00, verkaufspreis: 26.00, einheit: "StÃ¼ck" },
                { name: "Spritzspachtel (1L)", kategorie: "Spachtelmasse", einkaufspreis: 22.00, verkaufspreis: 42.00, einheit: "Liter" },
                { name: "Nitro-Spritzspachtel (1L)", kategorie: "Spachtelmasse", einkaufspreis: 18.00, verkaufspreis: 35.00, einheit: "Liter" },
                { name: "SpachtelhÃ¤rter (25g Tube)", kategorie: "Spachtelmasse", einkaufspreis: 2.50, verkaufspreis: 5.00, einheit: "StÃ¼ck" },
                { name: "SpachtelhÃ¤rter (100g)", kategorie: "Spachtelmasse", einkaufspreis: 6.00, verkaufspreis: 12.00, einheit: "StÃ¼ck" },

                // ================================================
                // SCHLEIFMATERIAL
                // ================================================
                { name: "Schleifpapier P80 (50 Blatt)", kategorie: "Schleifmaterial", einkaufspreis: 12.00, verkaufspreis: 22.00, einheit: "Set" },
                { name: "Schleifpapier P120 (50 Blatt)", kategorie: "Schleifmaterial", einkaufspreis: 12.00, verkaufspreis: 22.00, einheit: "Set" },
                { name: "Schleifpapier P180 (50 Blatt)", kategorie: "Schleifmaterial", einkaufspreis: 12.00, verkaufspreis: 22.00, einheit: "Set" },
                { name: "Schleifpapier P240 (50 Blatt)", kategorie: "Schleifmaterial", einkaufspreis: 12.00, verkaufspreis: 22.00, einheit: "Set" },
                { name: "Schleifpapier P320 (50 Blatt)", kategorie: "Schleifmaterial", einkaufspreis: 14.00, verkaufspreis: 26.00, einheit: "Set" },
                { name: "Schleifpapier P400 (50 Blatt)", kategorie: "Schleifmaterial", einkaufspreis: 14.00, verkaufspreis: 26.00, einheit: "Set" },
                { name: "Schleifpapier P600 (50 Blatt)", kategorie: "Schleifmaterial", einkaufspreis: 15.00, verkaufspreis: 28.00, einheit: "Set" },
                { name: "Schleifpapier P800 (50 Blatt)", kategorie: "Schleifmaterial", einkaufspreis: 15.00, verkaufspreis: 28.00, einheit: "Set" },
                { name: "Nassschleifpapier P1000 (50 Blatt)", kategorie: "Schleifmaterial", einkaufspreis: 16.00, verkaufspreis: 30.00, einheit: "Set" },
                { name: "Nassschleifpapier P1200 (50 Blatt)", kategorie: "Schleifmaterial", einkaufspreis: 16.00, verkaufspreis: 30.00, einheit: "Set" },
                { name: "Nassschleifpapier P1500 (50 Blatt)", kategorie: "Schleifmaterial", einkaufspreis: 18.00, verkaufspreis: 34.00, einheit: "Set" },
                { name: "Nassschleifpapier P2000 (50 Blatt)", kategorie: "Schleifmaterial", einkaufspreis: 18.00, verkaufspreis: 34.00, einheit: "Set" },
                { name: "Schleifscheiben P80 (50 Stk)", kategorie: "Schleifmaterial", einkaufspreis: 22.00, verkaufspreis: 42.00, einheit: "Set" },
                { name: "Schleifscheiben P180 (50 Stk)", kategorie: "Schleifmaterial", einkaufspreis: 22.00, verkaufspreis: 42.00, einheit: "Set" },
                { name: "Schleifscheiben P320 (50 Stk)", kategorie: "Schleifmaterial", einkaufspreis: 24.00, verkaufspreis: 45.00, einheit: "Set" },
                { name: "Schleifscheiben P500 (50 Stk)", kategorie: "Schleifmaterial", einkaufspreis: 26.00, verkaufspreis: 48.00, einheit: "Set" },
                { name: "Schleifvlies grau (fein)", kategorie: "Schleifmaterial", einkaufspreis: 2.50, verkaufspreis: 5.00, einheit: "StÃ¼ck" },
                { name: "Schleifvlies rot (mittel)", kategorie: "Schleifmaterial", einkaufspreis: 2.50, verkaufspreis: 5.00, einheit: "StÃ¼ck" },
                { name: "Schleifvlies grÃ¼n (grob)", kategorie: "Schleifmaterial", einkaufspreis: 2.50, verkaufspreis: 5.00, einheit: "StÃ¼ck" },
                { name: "Schleifschwamm fein", kategorie: "Schleifmaterial", einkaufspreis: 4.00, verkaufspreis: 8.00, einheit: "StÃ¼ck" },
                { name: "Schleifschwamm mittel", kategorie: "Schleifmaterial", einkaufspreis: 4.00, verkaufspreis: 8.00, einheit: "StÃ¼ck" },
                { name: "Schleifblock Hand", kategorie: "Schleifmaterial", einkaufspreis: 5.00, verkaufspreis: 10.00, einheit: "StÃ¼ck" },

                // ================================================
                // ABDECKMATERIAL
                // ================================================
                { name: "Abdeckpapier 60cm x 300m", kategorie: "Abdeckmaterial", einkaufspreis: 18.00, verkaufspreis: 35.00, einheit: "Rolle" },
                { name: "Abdeckpapier 90cm x 300m", kategorie: "Abdeckmaterial", einkaufspreis: 25.00, verkaufspreis: 48.00, einheit: "Rolle" },
                { name: "Abdeckpapier 120cm x 300m", kategorie: "Abdeckmaterial", einkaufspreis: 32.00, verkaufspreis: 58.00, einheit: "Rolle" },
                { name: "Abdeckfolie 4m x 150m", kategorie: "Abdeckmaterial", einkaufspreis: 15.00, verkaufspreis: 28.00, einheit: "Rolle" },
                { name: "Abdeckfolie 5m x 150m", kategorie: "Abdeckmaterial", einkaufspreis: 18.00, verkaufspreis: 35.00, einheit: "Rolle" },
                { name: "Abklebeband 18mm x 50m", kategorie: "Abdeckmaterial", einkaufspreis: 2.80, verkaufspreis: 5.50, einheit: "StÃ¼ck" },
                { name: "Abklebeband 24mm x 50m", kategorie: "Abdeckmaterial", einkaufspreis: 3.20, verkaufspreis: 6.00, einheit: "StÃ¼ck" },
                { name: "Abklebeband 36mm x 50m", kategorie: "Abdeckmaterial", einkaufspreis: 4.00, verkaufspreis: 8.00, einheit: "StÃ¼ck" },
                { name: "Abklebeband 48mm x 50m", kategorie: "Abdeckmaterial", einkaufspreis: 5.00, verkaufspreis: 10.00, einheit: "StÃ¼ck" },
                { name: "Feinlinienband 3mm x 55m", kategorie: "Abdeckmaterial", einkaufspreis: 4.50, verkaufspreis: 9.00, einheit: "StÃ¼ck" },
                { name: "Feinlinienband 6mm x 55m", kategorie: "Abdeckmaterial", einkaufspreis: 5.00, verkaufspreis: 10.00, einheit: "StÃ¼ck" },
                { name: "Kantenschutzband", kategorie: "Abdeckmaterial", einkaufspreis: 8.00, verkaufspreis: 15.00, einheit: "StÃ¼ck" },
                { name: "Schaumstoffband 13mm", kategorie: "Abdeckmaterial", einkaufspreis: 6.00, verkaufspreis: 12.00, einheit: "StÃ¼ck" },
                { name: "Radabdeckung (4 Stk Set)", kategorie: "Abdeckmaterial", einkaufspreis: 8.00, verkaufspreis: 15.00, einheit: "Set" },
                { name: "Spiegelabdeckung (2 Stk)", kategorie: "Abdeckmaterial", einkaufspreis: 3.00, verkaufspreis: 6.00, einheit: "Set" },
                { name: "TÃ¼rgriffabdeckung (4 Stk)", kategorie: "Abdeckmaterial", einkaufspreis: 4.00, verkaufspreis: 8.00, einheit: "Set" },

                // ================================================
                // POLIERMATERIAL
                // ================================================
                { name: "Polierpaste grob (1kg)", kategorie: "Poliermaterial", einkaufspreis: 25.00, verkaufspreis: 48.00, einheit: "kg" },
                { name: "Polierpaste mittel (1kg)", kategorie: "Poliermaterial", einkaufspreis: 28.00, verkaufspreis: 52.00, einheit: "kg" },
                { name: "Polierpaste fein (1kg)", kategorie: "Poliermaterial", einkaufspreis: 32.00, verkaufspreis: 58.00, einheit: "kg" },
                { name: "Hochglanz-Finish (500ml)", kategorie: "Poliermaterial", einkaufspreis: 22.00, verkaufspreis: 42.00, einheit: "StÃ¼ck" },
                { name: "Schleifpaste (500g)", kategorie: "Poliermaterial", einkaufspreis: 18.00, verkaufspreis: 35.00, einheit: "StÃ¼ck" },
                { name: "Antihologramm-Politur (500ml)", kategorie: "Poliermaterial", einkaufspreis: 28.00, verkaufspreis: 52.00, einheit: "StÃ¼ck" },
                { name: "Polierschwamm grob (2 Stk)", kategorie: "Poliermaterial", einkaufspreis: 8.00, verkaufspreis: 15.00, einheit: "Set" },
                { name: "Polierschwamm mittel (2 Stk)", kategorie: "Poliermaterial", einkaufspreis: 8.00, verkaufspreis: 15.00, einheit: "Set" },
                { name: "Polierschwamm fein (2 Stk)", kategorie: "Poliermaterial", einkaufspreis: 8.00, verkaufspreis: 15.00, einheit: "Set" },
                { name: "Lammfell-Polierpad", kategorie: "Poliermaterial", einkaufspreis: 12.00, verkaufspreis: 22.00, einheit: "StÃ¼ck" },
                { name: "Mikrofasertuch (10 Stk)", kategorie: "Poliermaterial", einkaufspreis: 8.00, verkaufspreis: 15.00, einheit: "Set" },
                { name: "Poliertuch fusselarm (50 Stk)", kategorie: "Poliermaterial", einkaufspreis: 15.00, verkaufspreis: 28.00, einheit: "Set" },

                // ================================================
                // KLEBE- UND DICHTMATERIAL
                // ================================================
                { name: "Karosseriekleber (310ml)", kategorie: "Klebematerial", einkaufspreis: 12.00, verkaufspreis: 22.00, einheit: "StÃ¼ck" },
                { name: "Strukturkleber 2K (50ml)", kategorie: "Klebematerial", einkaufspreis: 18.00, verkaufspreis: 35.00, einheit: "StÃ¼ck" },
                { name: "Scheibenklebstoff (310ml)", kategorie: "Klebematerial", einkaufspreis: 22.00, verkaufspreis: 42.00, einheit: "StÃ¼ck" },
                { name: "Scheibenklebstoff-Set komplett", kategorie: "Klebematerial", einkaufspreis: 45.00, verkaufspreis: 85.00, einheit: "Set" },
                { name: "Kunststoffkleber (20g)", kategorie: "Klebematerial", einkaufspreis: 8.00, verkaufspreis: 15.00, einheit: "StÃ¼ck" },
                { name: "Dichtmasse grau (310ml)", kategorie: "Klebematerial", einkaufspreis: 8.00, verkaufspreis: 15.00, einheit: "StÃ¼ck" },
                { name: "Dichtmasse schwarz (310ml)", kategorie: "Klebematerial", einkaufspreis: 8.00, verkaufspreis: 15.00, einheit: "StÃ¼ck" },
                { name: "Nahtabdichtung Ã¼berlackierbar (310ml)", kategorie: "Klebematerial", einkaufspreis: 12.00, verkaufspreis: 22.00, einheit: "StÃ¼ck" },
                { name: "Hohlraumversiegelung (500ml)", kategorie: "Klebematerial", einkaufspreis: 15.00, verkaufspreis: 28.00, einheit: "StÃ¼ck" },
                { name: "Hohlraumwachs Spraydose (500ml)", kategorie: "Klebematerial", einkaufspreis: 12.00, verkaufspreis: 22.00, einheit: "StÃ¼ck" },
                { name: "Unterbodenschutz (1L)", kategorie: "Klebematerial", einkaufspreis: 12.00, verkaufspreis: 22.00, einheit: "Liter" },
                { name: "Steinschlagschutz (1L)", kategorie: "Klebematerial", einkaufspreis: 15.00, verkaufspreis: 28.00, einheit: "Liter" },
                { name: "DÃ¤mmmatte selbstklebend (1mÂ²)", kategorie: "Klebematerial", einkaufspreis: 18.00, verkaufspreis: 35.00, einheit: "mÂ²" },

                // ================================================
                // REINIGUNGSMATERIAL
                // ================================================
                { name: "Entfetter/Silikonentferner (1L)", kategorie: "Reinigungsmaterial", einkaufspreis: 8.00, verkaufspreis: 15.00, einheit: "Liter" },
                { name: "Entfetter/Silikonentferner (5L)", kategorie: "Reinigungsmaterial", einkaufspreis: 32.00, verkaufspreis: 58.00, einheit: "StÃ¼ck" },
                { name: "Kunststoffreiniger (1L)", kategorie: "Reinigungsmaterial", einkaufspreis: 12.00, verkaufspreis: 22.00, einheit: "Liter" },
                { name: "Bremsenreiniger (500ml)", kategorie: "Reinigungsmaterial", einkaufspreis: 4.00, verkaufspreis: 8.00, einheit: "StÃ¼ck" },
                { name: "Bremsenreiniger (5L)", kategorie: "Reinigungsmaterial", einkaufspreis: 18.00, verkaufspreis: 35.00, einheit: "StÃ¼ck" },
                { name: "Staubbindetuch (10 Stk)", kategorie: "Reinigungsmaterial", einkaufspreis: 5.00, verkaufspreis: 10.00, einheit: "Set" },
                { name: "ReinigungstÃ¼cher Rolle (500 Stk)", kategorie: "Reinigungsmaterial", einkaufspreis: 25.00, verkaufspreis: 48.00, einheit: "Rolle" },
                { name: "Handwaschpaste (500ml)", kategorie: "Reinigungsmaterial", einkaufspreis: 6.00, verkaufspreis: 12.00, einheit: "StÃ¼ck" },
                { name: "Lackknete (100g)", kategorie: "Reinigungsmaterial", einkaufspreis: 8.00, verkaufspreis: 15.00, einheit: "StÃ¼ck" },
                { name: "Teerentferner (500ml)", kategorie: "Reinigungsmaterial", einkaufspreis: 8.00, verkaufspreis: 15.00, einheit: "StÃ¼ck" },

                // ================================================
                // VERBRAUCHSMATERIAL LACKIERKABINE
                // ================================================
                { name: "Filter Bodengitter (Set)", kategorie: "Verbrauchsmaterial", einkaufspreis: 45.00, verkaufspreis: 85.00, einheit: "Set" },
                { name: "Filter Decke (Set)", kategorie: "Verbrauchsmaterial", einkaufspreis: 65.00, verkaufspreis: 125.00, einheit: "Set" },
                { name: "Einmaloverall GrÃ¶ÃŸe L", kategorie: "Verbrauchsmaterial", einkaufspreis: 4.00, verkaufspreis: 8.00, einheit: "StÃ¼ck" },
                { name: "Einmaloverall GrÃ¶ÃŸe XL", kategorie: "Verbrauchsmaterial", einkaufspreis: 4.00, verkaufspreis: 8.00, einheit: "StÃ¼ck" },
                { name: "Einmalhandschuhe Nitril (100 Stk)", kategorie: "Verbrauchsmaterial", einkaufspreis: 12.00, verkaufspreis: 22.00, einheit: "Box" },
                { name: "Atemschutzmaske A2/P3", kategorie: "Verbrauchsmaterial", einkaufspreis: 35.00, verkaufspreis: 65.00, einheit: "StÃ¼ck" },
                { name: "Atemschutzfilter A2/P3 (2 Stk)", kategorie: "Verbrauchsmaterial", einkaufspreis: 22.00, verkaufspreis: 42.00, einheit: "Set" },
                { name: "Staubmaske FFP2 (20 Stk)", kategorie: "Verbrauchsmaterial", einkaufspreis: 15.00, verkaufspreis: 28.00, einheit: "Box" },
                { name: "RÃ¼hrstab Holz (100 Stk)", kategorie: "Verbrauchsmaterial", einkaufspreis: 8.00, verkaufspreis: 15.00, einheit: "Set" },
                { name: "Mischbecher (50 Stk)", kategorie: "Verbrauchsmaterial", einkaufspreis: 12.00, verkaufspreis: 22.00, einheit: "Set" },
                { name: "Siebe fÃ¼r Lack (100 Stk)", kategorie: "Verbrauchsmaterial", einkaufspreis: 18.00, verkaufspreis: 35.00, einheit: "Set" },
                { name: "Pistolenreiniger (1L)", kategorie: "Verbrauchsmaterial", einkaufspreis: 15.00, verkaufspreis: 28.00, einheit: "Liter" },

                // ================================================
                // ERSATZTEILE (HÃ„UFIG BENÃ–TIGT)
                // ================================================
                { name: "StoÃŸfÃ¤ngerhalter vorne (Set)", kategorie: "Ersatzteile", einkaufspreis: 25.00, verkaufspreis: 48.00, einheit: "Set" },
                { name: "StoÃŸfÃ¤ngerhalter hinten (Set)", kategorie: "Ersatzteile", einkaufspreis: 25.00, verkaufspreis: 48.00, einheit: "Set" },
                { name: "Befestigungsclips Universal (50 Stk)", kategorie: "Ersatzteile", einkaufspreis: 12.00, verkaufspreis: 22.00, einheit: "Set" },
                { name: "TÃ¼rdichtung Meter", kategorie: "Ersatzteile", einkaufspreis: 8.00, verkaufspreis: 15.00, einheit: "Meter" },
                { name: "Fensterdichtung Meter", kategorie: "Ersatzteile", einkaufspreis: 12.00, verkaufspreis: 22.00, einheit: "Meter" },
                { name: "Radlaufverbreiterung Clip (10 Stk)", kategorie: "Ersatzteile", einkaufspreis: 8.00, verkaufspreis: 15.00, einheit: "Set" },
                { name: "Zierleistenclips (20 Stk)", kategorie: "Ersatzteile", einkaufspreis: 15.00, verkaufspreis: 28.00, einheit: "Set" },
                { name: "Emblem Befestigung (Set)", kategorie: "Ersatzteile", einkaufspreis: 5.00, verkaufspreis: 10.00, einheit: "Set" },
            ];

            try {
                const batch = window.db.batch();
                const collectionRef = window.getCollection('kalkulation_material');

                SEED_DATA.forEach(item => {
                    const docRef = collectionRef.doc();
                    batch.set(docRef, {
                        ...item,
                        createdAt: new Date().toISOString()
                    });
                });

                await batch.commit();
                showToast(`${SEED_DATA.length} Materialien geladen`, 'success');
                await loadMaterial();

            } catch (error) {
                console.error('âŒ Fehler beim Laden des Standard-Materials:', error);
                showToast('Fehler beim Laden', 'error');
            }
        }

        function filterMaterial() {
            // TODO: Implement filtering
        }

        // ============================================
        // FAHRZEUGE LADEN (TAB 1)
        // ============================================

        async function loadFahrzeuge() {
            try {
                if (!window.getCollection) {
                    console.log('â³ loadFahrzeuge: getCollection nicht verfÃ¼gbar');
                    return;
                }

                const select = document.getElementById('fahrzeugSelect');
                if (!select) {
                    console.log('â³ loadFahrzeuge: fahrzeugSelect Element nicht gefunden');
                    return;
                }

                const snapshot = await window.getCollection('fahrzeuge')
                    .where('status', 'in', ['offen', 'in_arbeit', 'warte_teile', 'terminiert'])
                    .orderBy('annahmedatum', 'desc')
                    .limit(50)
                    .get();

                select.innerHTML = '<option value="">-- Fahrzeug wÃ¤hlen --</option>';

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = `${data.kennzeichen || 'Ohne Kennzeichen'} - ${data.fahrzeugmodell || 'Unbekannt'} - ${data.kundenname || 'Ohne Kunde'}`;
                    select.appendChild(option);
                });

                // Add change handler
                select.addEventListener('change', (e) => {
                    if (e.target.value) {
                        const fahrzeug = snapshot.docs.find(d => d.id === e.target.value);
                        if (fahrzeug) {
                            aktuelleKalkulation.fahrzeugId = fahrzeug.id;
                            aktuelleKalkulation.kennzeichen = fahrzeug.data().kennzeichen || '';
                            aktuelleKalkulation.kundenName = fahrzeug.data().kundenname || '';
                            document.getElementById('kalkulationContent').style.display = 'block';
                            document.getElementById('freieKalkulationStart').style.display = 'none';
                        }
                    } else {
                        document.getElementById('kalkulationContent').style.display = 'none';
                        document.getElementById('freieKalkulationStart').style.display = 'block';
                    }
                });

                console.log(`âœ… ${snapshot.size} Fahrzeuge geladen`);

            } catch (error) {
                console.warn('âš ï¸ Fahrzeuge konnten nicht geladen werden:', error);
            }
        }

        function startFreieKalkulation() {
            aktuelleKalkulation.fahrzeugId = null;
            aktuelleKalkulation.kennzeichen = 'Freie Kalkulation';
            aktuelleKalkulation.kundenName = '';
            document.getElementById('kalkulationContent').style.display = 'block';
            document.getElementById('freieKalkulationStart').style.display = 'none';
            document.getElementById('fahrzeugSelect').value = '';
        }

        // ============================================
        // KALKULATION ERSTELLEN (TAB 1)
        // ============================================

        function openPositionModal() {
            renderPositionAuswahl();
            document.getElementById('positionAuswahlModal').classList.add('active');
            document.getElementById('positionAuswahlSearch').value = '';
            feather.replace();
        }

        function renderPositionAuswahl(searchFilter = '') {
            const container = document.getElementById('positionAuswahlListe');

            let filteredData = katalogData;
            if (searchFilter) {
                filteredData = katalogData.filter(item =>
                    item.name.toLowerCase().includes(searchFilter.toLowerCase()) ||
                    item.kategorie.toLowerCase().includes(searchFilter.toLowerCase())
                );
            }

            if (filteredData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: var(--space-6);">
                        <p>Keine Positionen gefunden</p>
                    </div>
                `;
                return;
            }

            // Group by category
            const grouped = {};
            filteredData.forEach(item => {
                const kat = item.kategorie || 'Sonstiges';
                if (!grouped[kat]) grouped[kat] = [];
                grouped[kat].push(item);
            });

            let html = '';
            Object.keys(grouped).sort().forEach(kategorie => {
                html += `<div class="category-header" style="margin-top: var(--space-4);"><h3>${kategorie}</h3></div>`;
                grouped[kategorie].forEach(item => {
                    const stundensatz = getStundensatzForKategorie(item.kategorie);
                    const preis = (item.arbeitswerte * kalkulationSaetze.awInMinuten / 60) * stundensatz;
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-3); border-bottom: 1px solid var(--color-border); cursor: pointer;"
                             onclick="addPositionToKalkulation('${item.id}')"
                             onmouseover="this.style.background='rgba(var(--color-primary-rgb), 0.1)'"
                             onmouseout="this.style.background='transparent'">
                            <div>
                                <strong>${item.name}</strong>
                                <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">
                                    ${item.arbeitswerte} AW Â· ~${Math.round(item.arbeitswerte * kalkulationSaetze.awInMinuten)} Min
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <strong style="color: var(--color-primary);">${preis.toFixed(2)} â‚¬</strong>
                                <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">
                                    ${stundensatz.toFixed(2)} â‚¬/Std
                                </div>
                            </div>
                        </div>
                    `;
                });
            });

            container.innerHTML = html;
        }

        function filterPositionAuswahl() {
            const search = document.getElementById('positionAuswahlSearch').value;
            renderPositionAuswahl(search);
        }

        function getStundensatzForKategorie(kategorie) {
            switch (kategorie) {
                case 'Lackierung': return kalkulationSaetze.stundensatzLack;
                case 'Karosserie': return kalkulationSaetze.stundensatzKarosserie;
                case 'Mechanik':
                case 'Elektrik': return kalkulationSaetze.stundensatzMechanik;
                default: return kalkulationSaetze.stundensatzSonstige;
            }
        }

        function addPositionToKalkulation(positionId) {
            const position = katalogData.find(p => p.id === positionId);
            if (!position) return;

            const stundensatz = getStundensatzForKategorie(position.kategorie);
            const preis = (position.arbeitswerte * kalkulationSaetze.awInMinuten / 60) * stundensatz;

            aktuelleKalkulation.positionen.push({
                id: Date.now().toString(),
                katalogId: position.id,
                name: position.name,
                kategorie: position.kategorie,
                arbeitswerte: position.arbeitswerte,
                stundensatz: stundensatz,
                preis: preis
            });

            closeModal('positionAuswahlModal');
            renderKalkulationPositionen();
            updateKalkulationSummary();
            showToast(`"${position.name}" hinzugefÃ¼gt`, 'success');
        }

        function removePositionFromKalkulation(positionId) {
            aktuelleKalkulation.positionen = aktuelleKalkulation.positionen.filter(p => p.id !== positionId);
            renderKalkulationPositionen();
            updateKalkulationSummary();
        }

        function renderKalkulationPositionen() {
            const container = document.getElementById('positionenListe');

            if (aktuelleKalkulation.positionen.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i data-feather="clipboard"></i>
                        <h3>Keine Positionen</h3>
                        <p>FÃ¼gen Sie Arbeitspositionen aus dem Katalog hinzu</p>
                    </div>
                `;
                feather.replace();
                return;
            }

            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Position</th>
                            <th>Kategorie</th>
                            <th>AW</th>
                            <th>Stundensatz</th>
                            <th>Preis</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            aktuelleKalkulation.positionen.forEach((pos, index) => {
                html += `
                    <tr>
                        <td><strong>${index + 1}.</strong> ${pos.name}</td>
                        <td>${pos.kategorie}</td>
                        <td>${pos.arbeitswerte} AW</td>
                        <td>${pos.stundensatz.toFixed(2)} â‚¬/Std</td>
                        <td><strong>${pos.preis.toFixed(2)} â‚¬</strong></td>
                        <td>
                            <button class="btn btn-icon btn-secondary" onclick="removePositionFromKalkulation('${pos.id}')" title="Entfernen" style="color: var(--color-error);">
                                <i data-feather="x"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
            feather.replace();
        }

        // ============================================
        // MATERIAL ZUR KALKULATION HINZUFÃœGEN
        // ============================================

        function openMaterialModal() {
            renderMaterialAuswahl();
            document.getElementById('materialAuswahlModal').classList.add('active');
            document.getElementById('materialAuswahlSearch').value = '';
            feather.replace();
        }

        function renderMaterialAuswahl(searchFilter = '') {
            const container = document.getElementById('materialAuswahlListe');

            let filteredData = materialData;
            if (searchFilter) {
                filteredData = materialData.filter(item =>
                    item.name.toLowerCase().includes(searchFilter.toLowerCase()) ||
                    item.kategorie.toLowerCase().includes(searchFilter.toLowerCase())
                );
            }

            if (filteredData.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: var(--space-6);">
                        <p>Kein Material gefunden</p>
                    </div>
                `;
                return;
            }

            // Group by category
            const grouped = {};
            filteredData.forEach(item => {
                const kat = item.kategorie || 'Sonstiges';
                if (!grouped[kat]) grouped[kat] = [];
                grouped[kat].push(item);
            });

            let html = '';
            Object.keys(grouped).sort().forEach(kategorie => {
                html += `<div class="category-header" style="margin-top: var(--space-4);"><h3>${kategorie}</h3></div>`;
                grouped[kategorie].forEach(item => {
                    html += `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-3); border-bottom: 1px solid var(--color-border); cursor: pointer;"
                             onclick="addMaterialToKalkulation('${item.id}')"
                             onmouseover="this.style.background='rgba(var(--color-primary-rgb), 0.1)'"
                             onmouseout="this.style.background='transparent'">
                            <div>
                                <strong>${item.name}</strong>
                                <div style="font-size: var(--font-size-xs); color: var(--color-text-secondary);">
                                    ${item.einheit || 'StÃ¼ck'}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <strong style="color: var(--color-primary);">${item.verkaufspreis.toFixed(2)} â‚¬</strong>
                            </div>
                        </div>
                    `;
                });
            });

            container.innerHTML = html;
        }

        function filterMaterialAuswahl() {
            const search = document.getElementById('materialAuswahlSearch').value;
            renderMaterialAuswahl(search);
        }

        function addMaterialToKalkulation(materialId) {
            const material = materialData.find(m => m.id === materialId);
            if (!material) return;

            // Check if already exists
            const existing = aktuelleKalkulation.materialien.find(m => m.katalogId === materialId);
            if (existing) {
                existing.menge += 1;
                existing.preis = existing.menge * existing.einzelpreis;
            } else {
                aktuelleKalkulation.materialien.push({
                    id: Date.now().toString(),
                    katalogId: material.id,
                    name: material.name,
                    kategorie: material.kategorie,
                    einheit: material.einheit || 'StÃ¼ck',
                    einzelpreis: material.verkaufspreis,
                    menge: 1,
                    preis: material.verkaufspreis
                });
            }

            closeModal('materialAuswahlModal');
            renderKalkulationMaterial();
            updateKalkulationSummary();
            showToast(`"${material.name}" hinzugefÃ¼gt`, 'success');
        }

        function removeMaterialFromKalkulation(materialId) {
            aktuelleKalkulation.materialien = aktuelleKalkulation.materialien.filter(m => m.id !== materialId);
            renderKalkulationMaterial();
            updateKalkulationSummary();
        }

        function updateMaterialMenge(materialId, newMenge) {
            const material = aktuelleKalkulation.materialien.find(m => m.id === materialId);
            if (material) {
                material.menge = Math.max(1, parseInt(newMenge) || 1);
                material.preis = material.menge * material.einzelpreis;
                updateKalkulationSummary();
            }
        }

        function renderKalkulationMaterial() {
            const container = document.getElementById('materialListe');

            if (aktuelleKalkulation.materialien.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i data-feather="box"></i>
                        <h3>Kein Material</h3>
                        <p>FÃ¼gen Sie Materialien aus dem Katalog hinzu</p>
                    </div>
                `;
                feather.replace();
                return;
            }

            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Material</th>
                            <th>Einzelpreis</th>
                            <th>Menge</th>
                            <th>Preis</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            aktuelleKalkulation.materialien.forEach((mat, index) => {
                html += `
                    <tr>
                        <td><strong>${index + 1}.</strong> ${mat.name}</td>
                        <td>${mat.einzelpreis.toFixed(2)} â‚¬/${mat.einheit}</td>
                        <td>
                            <input type="number" min="1" value="${mat.menge}"
                                   style="width: 60px; padding: var(--space-2); border: 1px solid var(--color-border); border-radius: var(--radius-input);"
                                   onchange="updateMaterialMenge('${mat.id}', this.value)">
                        </td>
                        <td><strong>${mat.preis.toFixed(2)} â‚¬</strong></td>
                        <td>
                            <button class="btn btn-icon btn-secondary" onclick="removeMaterialFromKalkulation('${mat.id}')" title="Entfernen" style="color: var(--color-error);">
                                <i data-feather="x"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
            feather.replace();
        }

        // ============================================
        // KALKULATION BERECHNEN & ANZEIGEN
        // ============================================

        function updateKalkulationSummary() {
            // ðŸ†• FIX (2025-12-01): Delegiere an vollstÃ¤ndige Funktion berechneGesamtsumme()
            // PROBLEM: Diese Funktion zeigte nur Arbeit + Material, NICHT Ersatzteile + Ersatzfahrzeug
            // LÃ–SUNG: berechneGesamtsumme() berechnet ALLE Summen korrekt
            if (typeof berechneGesamtsumme === 'function') {
                berechneGesamtsumme();
                return;
            }

            // Fallback: Legacy-Berechnung (nur wenn berechneGesamtsumme nicht verfÃ¼gbar)
            const summeArbeit = aktuelleKalkulation.positionen.reduce((sum, p) => sum + p.preis, 0);
            const summeMaterial = aktuelleKalkulation.materialien.reduce((sum, m) => sum + m.preis, 0);

            // ðŸ†• FIX: Ersatzteile + Ersatzfahrzeug jetzt auch in Fallback
            const summeErsatzteile = (kalkWizardData?.ersatzteile || []).reduce((sum, e) => {
                return sum + (parseFloat(e.preis) || 0) * (parseFloat(e.menge) || 1);
            }, 0);
            const summeErsatzfahrzeug = parseFloat(kalkWizardData?.ersatzfahrzeug?.gesamt) || 0;

            const summeNetto = summeArbeit + summeMaterial + summeErsatzteile + summeErsatzfahrzeug;
            const mwst = summeNetto * (kalkulationSaetze.mwstSatz / 100);
            const summeBrutto = summeNetto + mwst;

            const elSummeArbeit = document.getElementById('summeArbeit');
            const elSummeMaterial = document.getElementById('summeMaterial');
            const elSummeErsatzteile = document.getElementById('summeErsatzteile');
            const elSummeErsatzfahrzeug = document.getElementById('summeErsatzfahrzeug');
            const elSummeNetto = document.getElementById('summeNetto');
            const elSummeMwst = document.getElementById('summeMwst');
            const elSummeBrutto = document.getElementById('summeBrutto');

            if (elSummeArbeit) elSummeArbeit.textContent = summeArbeit.toFixed(2) + ' â‚¬';
            if (elSummeMaterial) elSummeMaterial.textContent = summeMaterial.toFixed(2) + ' â‚¬';
            if (elSummeErsatzteile) elSummeErsatzteile.textContent = summeErsatzteile.toFixed(2) + ' â‚¬';
            if (elSummeErsatzfahrzeug) elSummeErsatzfahrzeug.textContent = summeErsatzfahrzeug.toFixed(2) + ' â‚¬';
            if (elSummeNetto) elSummeNetto.textContent = summeNetto.toFixed(2) + ' â‚¬';
            document.getElementById('mwstSatzDisplay').textContent = kalkulationSaetze.mwstSatz;
            if (elSummeMwst) elSummeMwst.textContent = mwst.toFixed(2) + ' â‚¬';
            if (elSummeBrutto) elSummeBrutto.textContent = summeBrutto.toFixed(2) + ' â‚¬';
        }

        // ============================================
        // KALKULATION SPEICHERN
        // ============================================

        async function saveKalkulationEntwurf() {
            if (aktuelleKalkulation.positionen.length === 0 && aktuelleKalkulation.materialien.length === 0) {
                showToast('Keine Positionen oder Material vorhanden', 'error');
                return;
            }

            try {
                const summeArbeit = aktuelleKalkulation.positionen.reduce((sum, p) => sum + p.preis, 0);
                const summeMaterial = aktuelleKalkulation.materialien.reduce((sum, m) => sum + m.preis, 0);
                const summeNetto = summeArbeit + summeMaterial;
                const mwst = summeNetto * (kalkulationSaetze.mwstSatz / 100);
                const summeBrutto = summeNetto + mwst;

                const kalkulationData = {
                    fahrzeugId: aktuelleKalkulation.fahrzeugId,
                    kennzeichen: aktuelleKalkulation.kennzeichen,
                    kundenName: aktuelleKalkulation.kundenName,
                    positionen: aktuelleKalkulation.positionen,
                    materialien: aktuelleKalkulation.materialien,
                    summeArbeit,
                    summeMaterial,
                    summeNetto,
                    mwstSatz: kalkulationSaetze.mwstSatz,
                    mwst,
                    summeBrutto,
                    status: 'entwurf',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    // ðŸ†• VerknÃ¼pfung zu Entwurf oder Partner-Anfrage
                    entwurfId: kalkWizardData.entwurfId || null,
                    partnerAnfrageId: kalkWizardData.partnerAnfrageId || null
                };

                const docRef = await window.getCollection('kalkulationen').add(kalkulationData);
                console.log('âœ… Kalkulation gespeichert:', docRef.id);

                // ðŸ†• KVA-Daten zurÃ¼ck in Partner-Anfrage speichern
                if (kalkWizardData.partnerAnfrageId) {
                    await saveKvaToPartnerAnfrage(kalkWizardData.partnerAnfrageId, kalkulationData, docRef.id);
                }

                // ðŸ†• Kalkulation mit Entwurf verknÃ¼pfen
                if (kalkWizardData.entwurfId) {
                    await linkKalkulationToEntwurf(kalkWizardData.entwurfId, kalkulationData, docRef.id);
                }

                showToast('Kalkulation gespeichert!', 'success');

                // Reset for new calculation
                resetKalkulation();

            } catch (error) {
                console.error('âŒ Fehler beim Speichern:', error);
                showToast('Fehler beim Speichern', 'error');
            }
        }

        // ðŸ”§ FIX (2025-11-29): Kalkulation in Entwurf speichern
        // WICHTIG: Speichert NUR in partnerAnfragen - KEIN Fahrzeug wird angelegt!
        // Fahrzeug wird erst angelegt wenn Kunde das Angebot annimmt (in meine-anfragen.html)
        async function saveKVA() {
            // PrÃ¼fen ob Entwurf oder Partner-Anfrage ausgewÃ¤hlt
            const targetId = kalkWizardData.entwurfId || kalkWizardData.partnerAnfrageId;
            if (!targetId) {
                showToast('âš ï¸ Kein Entwurf ausgewÃ¤hlt!\n\nBitte wÃ¤hlen Sie zuerst einen Entwurf aus der Liste.', 'warning');
                return;
            }

            // PrÃ¼fen ob Daten vorhanden
            if (!kalkWizardData.fahrzeug?.marke || !kalkWizardData.fahrzeug?.modell) {
                showToast('Bitte erst Fahrzeugdaten eingeben', 'warning');
                return;
            }

            if (kalkWizardData.teile.length === 0) {
                showToast('Bitte mindestens ein Teil auswÃ¤hlen', 'warning');
                return;
            }

            try {
                // ðŸ†• Design-Dateien zu Firebase Storage hochladen (falls vorhanden)
                let designUrls = {};
                if (Object.keys(uploadedDesignFiles).length > 0) {
                    showToast('ðŸ“¤ Lade Design-Dateien hoch...', 'info');
                    designUrls = await uploadDesignFilesToStorage(targetId);
                }
                // Summen berechnen
                const summeArbeit = aktuelleKalkulation.positionen.reduce((sum, p) => {
                    return sum + ((parseFloat(p.preis) || 0) * (parseFloat(p.menge) || 1));
                }, 0);

                // ðŸ”§ FIX Dec 2, 2025: m.preis IST bereits der Gesamtpreis (einzelpreis Ã— menge), NICHT nochmal multiplizieren!
                const summeMaterial = aktuelleKalkulation.materialien.reduce((sum, m) => {
                    return sum + (parseFloat(m.preis) || parseFloat(m.verkaufspreis) || 0);
                }, 0);

                // ðŸ†• Nov 30, 2025: Getrennte Ersatzteile-Summen (Original + Aftermarket)
                const summeErsatzteileOriginal = (kalkWizardData.ersatzteile || []).reduce((sum, e) => {
                    const preis = parseFloat(e.preisOriginal) || parseFloat(e.preis) || 0;
                    return sum + (preis * (parseFloat(e.menge) || 1));
                }, 0);

                const summeErsatzteileAftermarket = (kalkWizardData.ersatzteile || []).reduce((sum, e) => {
                    const preis = parseFloat(e.preisAftermarket) || parseFloat(e.preisOriginal) || parseFloat(e.preis) || 0;
                    return sum + (preis * (parseFloat(e.menge) || 1));
                }, 0);

                // Backwards-KompatibilitÃ¤t: summeErsatzteile = Original
                const summeErsatzteile = summeErsatzteileOriginal;

                // ðŸ†• Zwei Netto-Summen fÃ¼r beide Varianten
                const summeNettoOriginal = summeArbeit + summeMaterial + summeErsatzteileOriginal;
                const summeNettoAftermarket = summeArbeit + summeMaterial + summeErsatzteileAftermarket;

                const mwstSatz = kalkulationSaetze?.mwstSatz || 19;

                // Original Variante
                const mwstOriginal = summeNettoOriginal * (mwstSatz / 100);
                const summeBruttoOriginal = summeNettoOriginal + mwstOriginal;

                // Aftermarket Variante
                const mwstAftermarket = summeNettoAftermarket * (mwstSatz / 100);
                const summeBruttoAftermarket = summeNettoAftermarket + mwstAftermarket;

                // Backwards-KompatibilitÃ¤t
                const summeNetto = summeNettoOriginal;
                const mwst = mwstOriginal;
                const summeBrutto = summeBruttoOriginal;

                // Kalkulationsdaten fÃ¼r Entwurf
                // ðŸ”§ FIX Nov 29, 2025: Alle Summen auf 2 Dezimalstellen runden (Floating-Point vermeiden)
                // ðŸ†• Nov 30, 2025: Getrennte Original/Aftermarket Summen fÃ¼r KVA-Varianten
                // ðŸš— Ersatzfahrzeug-Daten aus kalkWizardData oder Entwurf (FIX: Nov 30, 2025)
                const ersatzfahrzeugData = kalkWizardData.ersatzfahrzeug || kalkWizardData.fahrzeug?.kalkulationData?.ersatzfahrzeug || null;
                const summeErsatzfahrzeug = ersatzfahrzeugData?.gesamt || 0;

                // Netto-Summen aktualisieren (inkl. Ersatzfahrzeug)
                const summeNettoMitErsatzfahrzeug = summeNettoOriginal + summeErsatzfahrzeug;
                const mwstMitErsatzfahrzeug = summeNettoMitErsatzfahrzeug * (mwstSatz / 100);
                const summeBruttoMitErsatzfahrzeug = summeNettoMitErsatzfahrzeug + mwstMitErsatzfahrzeug;

                const kalkulationData = {
                    positionen: aktuelleKalkulation.positionen,
                    materialien: aktuelleKalkulation.materialien,
                    ersatzteile: kalkWizardData.ersatzteile || [],
                    // ðŸš— Ersatzfahrzeug-Kosten (FIX: Nov 30, 2025)
                    ersatzfahrzeug: ersatzfahrzeugData,
                    summeErsatzfahrzeug: parseFloat(summeErsatzfahrzeug.toFixed(2)),
                    summeArbeit: parseFloat(summeArbeit.toFixed(2)),
                    summeMaterial: parseFloat(summeMaterial.toFixed(2)),
                    // Backwards-KompatibilitÃ¤t
                    summeErsatzteile: parseFloat(summeErsatzteile.toFixed(2)),
                    summeNetto: parseFloat(summeNettoMitErsatzfahrzeug.toFixed(2)),
                    mwstSatz,
                    mwst: parseFloat(mwstMitErsatzfahrzeug.toFixed(2)),
                    summeBrutto: parseFloat(summeBruttoMitErsatzfahrzeug.toFixed(2)),
                    // ðŸ†• Neue getrennte Summen fÃ¼r kva-erstellen.html
                    summeErsatzteileOriginal: parseFloat(summeErsatzteileOriginal.toFixed(2)),
                    summeErsatzteileAftermarket: parseFloat(summeErsatzteileAftermarket.toFixed(2)),
                    summeNettoOriginal: parseFloat((summeNettoOriginal + summeErsatzfahrzeug).toFixed(2)),
                    summeNettoAftermarket: parseFloat((summeNettoAftermarket + summeErsatzfahrzeug).toFixed(2)),
                    summeBruttoOriginal: parseFloat(summeBruttoMitErsatzfahrzeug.toFixed(2)),
                    summeBruttoAftermarket: parseFloat((summeNettoAftermarket + summeErsatzfahrzeug + ((summeNettoAftermarket + summeErsatzfahrzeug) * mwstSatz / 100)).toFixed(2))
                };

                // Update-Daten fÃ¼r partnerAnfragen
                const updateData = {
                    // Kalkulation speichern (fÃ¼r entwuerfe-bearbeiten.html)
                    kalkulation: kalkulationData,

                    // Teile & Ersatzteile auf Root-Ebene (fÃ¼r einfachen Zugriff)
                    teile: kalkWizardData.teile || [],
                    ersatzteile: kalkWizardData.ersatzteile || [],

                    // ðŸ†• Service-Details speichern (fÃ¼r Folierung, Werbebeklebung, etc.)
                    serviceDetails: kalkWizardData.serviceDetails || {},

                    // ðŸ†• MULTI-SERVICE: Service-Details pro Service speichern (2025-11-30)
                    // WICHTIG: serviceTyp und additionalServices werden NICHT Ã¼berschrieben!
                    // Diese kommen bereits vom Entwurf (annahme.html) und sind korrekt.
                    serviceDetailsPerService: kalkWizardData.serviceDetailsPerService || {},

                    // ðŸ†• Design-URLs speichern (hochgeladene Bilder/Dateien)
                    designUrls: designUrls,

                    // ðŸ”§ FIX Nov 29, 2025: entwurfStatus NICHT Ã¤ndern!
                    // Entwurf bleibt 'offen' bis Angebot in entwuerfe-bearbeiten.html versendet wird
                    // So bleibt er in der Dropdown-Liste sichtbar fÃ¼r spÃ¤tere Bearbeitung
                    // entwurfStatus: 'kalkulation_erstellt', // ENTFERNT - bleibt 'offen'

                    // Status: Kalkulation erstellt (NICHT kva_gesendet - das macht entwuerfe-bearbeiten.html!)
                    kalkulationErstelltAm: firebase.firestore.FieldValue.serverTimestamp(),
                    kalkulationErstelltDurch: getCurrentUserForAudit().user,

                    // Vereinbarter Preis (brutto) fÃ¼r Angebot
                    // ðŸ”§ FIX Nov 29, 2025: Floating-Point vermeiden mit toFixed(2)
                    vereinbarterPreis: parseFloat(summeBrutto.toFixed(2)),

                    // ðŸ†• FIX Dec 1, 2025: Varianten-Preise auf ROOT-Ebene speichern
                    // KRITISCH fÃ¼r meine-anfragen.html Varianten-Auswahl-Box!
                    // Ohne diese Felder wird nur "Annehmen/Ablehnen" angezeigt, KEINE Varianten-Buttons!
                    summeBruttoOriginal: parseFloat(summeBruttoMitErsatzfahrzeug.toFixed(2)),
                    summeBruttoAftermarket: parseFloat((summeNettoAftermarket + summeErsatzfahrzeug + ((summeNettoAftermarket + summeErsatzfahrzeug) * mwstSatz / 100)).toFixed(2)),
                    hasVarianten: summeErsatzteileOriginal !== summeErsatzteileAftermarket,

                    // Metadata
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                };

                // ðŸ†• MULTI-SERVICE: Log fÃ¼r Debugging (2025-11-30)
                if (kalkWizardData.isMultiService) {
                    console.log('ðŸ†• Multi-Service Kalkulation wird gespeichert:', {
                        services: kalkWizardData.services,
                        serviceDetailsPerService: kalkWizardData.serviceDetailsPerService
                    });
                }

                // In partnerAnfragen updaten (Entwurf oder Partner-Anfrage)
                console.log(`ðŸ“ Speichere Kalkulation in partnerAnfragen/${targetId}...`);
                await window.getCollection('partnerAnfragen').doc(targetId).update(updateData);
                console.log('âœ… Kalkulation in Entwurf gespeichert');

                // ðŸ†• FIX (Nov 30, 2025): Unterschiedliche Weiterleitung je nach Quelle
                // - Entwurf (isEntwurf=true) â†’ entwuerfe-bearbeiten.html
                // - Partner-Anfrage (isEntwurf=false) â†’ partner-app/kva-erstellen.html
                const isPartnerAnfrage = kalkWizardData.partnerAnfrageId && !kalkWizardData.entwurfId;

                if (isPartnerAnfrage) {
                    showToast('âœ… Kalkulation erfolgreich gespeichert!\n\nWeiter zur KVA-Erstellung fÃ¼r den Partner.', 'success', 5000);

                    // Nach 2 Sekunden zu kva-erstellen.html weiterleiten (Partner-App)
                    setTimeout(() => {
                        const werkstattId = window.werkstattId || 'mosbach';
                        const kvaUrl = `partner-app/kva-erstellen.html?id=${targetId}&werkstatt=${werkstattId}`;
                        console.log('ðŸ”— Weiterleitung zu Partner-KVA:', kvaUrl);
                        if (typeof safeNavigate === 'function') {
                            safeNavigate(kvaUrl);
                        } else {
                            window.location.href = kvaUrl;
                        }
                    }, 2000);
                } else {
                    showToast('âœ… Kalkulation erfolgreich gespeichert!\n\nWeiter zu "EntwÃ¼rfe bearbeiten" um das Angebot zu versenden.', 'success', 5000);

                    // Nach 2 Sekunden zu entwuerfe-bearbeiten.html weiterleiten (Werkstatt-Entwurf)
                    setTimeout(() => {
                        if (typeof safeNavigate === 'function') {
                            safeNavigate(`entwuerfe-bearbeiten.html?id=${targetId}`);
                        } else {
                            window.location.href = `entwuerfe-bearbeiten.html?id=${targetId}`;
                        }
                    }, 2000);
                }

            } catch (error) {
                console.error('âŒ Fehler beim Speichern der Kalkulation:', error);
                showToast('Fehler beim Speichern: ' + error.message, 'error');
            }
        }

        // ðŸ†• KVA-Daten zurÃ¼ck in Partner-Anfrage speichern
        async function saveKvaToPartnerAnfrage(anfrageId, kalkulationData, kalkulationId) {
            try {
                const kvaData = {
                    varianten: {
                        original: {
                            gesamt: kalkulationData.summeBrutto,
                            lackkosten: kalkulationData.summeArbeit,
                            teilekosten: kalkulationData.summeMaterial,
                            arbeitszeit: 0,
                            sonstiges: 0
                        }
                    },
                    gewaehlteVariante: null, // Partner muss noch wÃ¤hlen
                    erstelltAm: new Date().toISOString(),
                    erstelltVon: 'kalkulation',
                    kalkulationId: kalkulationId,
                    kalkulationData: {
                        positionen: kalkulationData.positionen,
                        materialien: kalkulationData.materialien,
                        summeNetto: kalkulationData.summeNetto,
                        mwst: kalkulationData.mwst,
                        summeBrutto: kalkulationData.summeBrutto
                    }
                };

                await window.getCollection('partnerAnfragen').doc(anfrageId).update({
                    kva: kvaData,
                    status: 'kva_gesendet',
                    statusText: 'Angebot erstellt',
                    kvaErstelltAm: new Date().toISOString()
                });

                console.log('âœ… KVA zurÃ¼ck in Partner-Anfrage gespeichert:', anfrageId);
            } catch (error) {
                console.error('âŒ Fehler beim Speichern des KVA in Partner-Anfrage:', error);
            }
        }

        // ðŸ†• Kalkulation mit Entwurf verknÃ¼pfen
        // ðŸ”§ FIX Dec 1, 2025: Alle wichtigen Kalkulationsdaten Ã¼bertragen (nicht nur Summen!)
        // WICHTIG: Original-Felder (ersatzfahrzeugGewuenscht, abholadresse, etc.) NICHT Ã¼berschreiben!
        async function linkKalkulationToEntwurf(entwurfId, kalkulationData, kalkulationId) {
            try {
                // ðŸ”§ FIX Dec 1, 2025: Ersatzfahrzeug-Kosten aus kalkWizardData holen
                const ersatzfahrzeugKosten = kalkWizardData.ersatzfahrzeug ||
                                             kalkWizardData.fahrzeug?.kalkulationData?.ersatzfahrzeug ||
                                             null;

                // Nur Kalkulations-spezifische Felder updaten
                // NICHT: ersatzfahrzeugGewuenscht, serviceDetails, abholadresse (kommen aus annahme.html)
                const updateData = {
                    kalkulationId: kalkulationId,
                    // ðŸ”§ FIX Dec 1, 2025: VollstÃ¤ndige Kalkulationsdaten in kalkulation-Objekt
                    kalkulation: {
                        // Summen
                        summeBrutto: kalkulationData.summeBrutto,
                        summeNetto: kalkulationData.summeNetto,
                        summeArbeit: kalkulationData.summeArbeit,
                        summeMaterial: kalkulationData.summeMaterial,
                        mwst: kalkulationData.mwst,
                        mwstSatz: kalkulationData.mwstSatz,
                        // Detaillierte Positionen
                        positionen: kalkulationData.positionen || [],
                        materialien: kalkulationData.materialien || [],
                        ersatzteile: kalkulationData.ersatzteile || kalkWizardData.ersatzteile || [],
                        // Ersatzfahrzeug-KOSTEN (nicht -Wunsch!)
                        ersatzfahrzeugKosten: ersatzfahrzeugKosten,
                        summeErsatzfahrzeug: ersatzfahrzeugKosten?.gesamt || 0,
                        // Getrennte Summen fÃ¼r Varianten
                        summeErsatzteileOriginal: kalkulationData.summeErsatzteileOriginal || 0,
                        summeErsatzteileAftermarket: kalkulationData.summeErsatzteileAftermarket || 0,
                        summeBruttoOriginal: kalkulationData.summeBruttoOriginal || kalkulationData.summeBrutto,
                        summeBruttoAftermarket: kalkulationData.summeBruttoAftermarket || kalkulationData.summeBrutto,
                        // Meta
                        erstelltAm: kalkulationData.createdAt || new Date().toISOString()
                    }
                    // ðŸ”§ FIX Nov 29, 2025: entwurfStatus NICHT Ã¤ndern!
                    // ðŸ”§ FIX Dec 1, 2025: ersatzfahrzeugGewuenscht, serviceDetails NICHT Ã¼berschreiben!
                    // Diese kommen aus annahme.html und sind bereits im Entwurf gespeichert.
                };

                await window.getCollection('partnerAnfragen').doc(entwurfId).update(updateData);

                console.log('âœ… Kalkulation mit Entwurf verknÃ¼pft:', entwurfId);
                console.log('   ðŸ“¦ Ãœbertragen: positionen:', kalkulationData.positionen?.length || 0);
                console.log('   ðŸŽ¨ Ãœbertragen: materialien:', kalkulationData.materialien?.length || 0);
                console.log('   ðŸš— Ãœbertragen: ersatzfahrzeugKosten:', ersatzfahrzeugKosten?.gesamt || 0, 'â‚¬');
            } catch (error) {
                console.error('âŒ Fehler beim VerknÃ¼pfen mit Entwurf:', error);
            }
        }

        function resetKalkulation() {
            aktuelleKalkulation = {
                positionen: [],
                materialien: [],
                fahrzeugId: null,
                kundenName: '',
                kennzeichen: ''
            };
            document.getElementById('fahrzeugSelect').value = '';
            document.getElementById('kalkulationContent').style.display = 'none';
            document.getElementById('freieKalkulationStart').style.display = 'block';
            renderKalkulationPositionen();
            renderKalkulationMaterial();
            updateKalkulationSummary();
        }

        // ============================================
        // PDF EXPORT
        // ============================================

        async function exportKalkulationPDF() {
            if (aktuelleKalkulation.positionen.length === 0 && aktuelleKalkulation.materialien.length === 0) {
                showToast('Keine Positionen oder Material vorhanden', 'error');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                const summeArbeit = aktuelleKalkulation.positionen.reduce((sum, p) => sum + p.preis, 0);
                const summeMaterial = aktuelleKalkulation.materialien.reduce((sum, m) => sum + m.preis, 0);
                const summeNetto = summeArbeit + summeMaterial;
                const mwst = summeNetto * (kalkulationSaetze.mwstSatz / 100);
                const summeBrutto = summeNetto + mwst;

                // Header
                doc.setFontSize(20);
                doc.setFont('helvetica', 'bold');
                doc.text('KOSTENVORANSCHLAG', 105, 20, { align: 'center' });

                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text(`Datum: ${new Date().toLocaleDateString('de-DE')}`, 20, 35);

                if (aktuelleKalkulation.kennzeichen) {
                    doc.text(`Kennzeichen: ${aktuelleKalkulation.kennzeichen}`, 20, 42);
                }
                if (aktuelleKalkulation.kundenName) {
                    doc.text(`Kunde: ${aktuelleKalkulation.kundenName}`, 20, 49);
                }

                let yPos = 65;

                // Arbeitspositionen
                if (aktuelleKalkulation.positionen.length > 0) {
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('ARBEITSPOSITIONEN', 20, yPos);
                    yPos += 8;

                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Pos.', 20, yPos);
                    doc.text('Bezeichnung', 35, yPos);
                    doc.text('AW', 120, yPos);
                    doc.text('Preis', 145, yPos);
                    yPos += 5;

                    doc.setFont('helvetica', 'normal');
                    aktuelleKalkulation.positionen.forEach((pos, index) => {
                        doc.text(`${index + 1}.`, 20, yPos);
                        doc.text(pos.name.substring(0, 45), 35, yPos);
                        doc.text(`${pos.arbeitswerte}`, 120, yPos);
                        doc.text(`${pos.preis.toFixed(2)} â‚¬`, 145, yPos);
                        yPos += 6;

                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 20;
                        }
                    });

                    doc.setFont('helvetica', 'bold');
                    doc.text(`Summe Arbeit: ${summeArbeit.toFixed(2)} â‚¬`, 145, yPos, { align: 'right' });
                    yPos += 12;
                }

                // Material
                if (aktuelleKalkulation.materialien.length > 0) {
                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'bold');
                    doc.text('MATERIAL', 20, yPos);
                    yPos += 8;

                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Pos.', 20, yPos);
                    doc.text('Bezeichnung', 35, yPos);
                    doc.text('Menge', 110, yPos);
                    doc.text('Preis', 145, yPos);
                    yPos += 5;

                    doc.setFont('helvetica', 'normal');
                    aktuelleKalkulation.materialien.forEach((mat, index) => {
                        doc.text(`${index + 1}.`, 20, yPos);
                        doc.text(mat.name.substring(0, 40), 35, yPos);
                        doc.text(`${mat.menge} ${mat.einheit}`, 110, yPos);
                        doc.text(`${mat.preis.toFixed(2)} â‚¬`, 145, yPos);
                        yPos += 6;

                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 20;
                        }
                    });

                    doc.setFont('helvetica', 'bold');
                    doc.text(`Summe Material: ${summeMaterial.toFixed(2)} â‚¬`, 145, yPos, { align: 'right' });
                    yPos += 15;
                }

                // Zusammenfassung
                doc.setDrawColor(0);
                doc.line(20, yPos - 5, 190, yPos - 5);

                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text('Nettobetrag:', 120, yPos);
                doc.text(`${summeNetto.toFixed(2)} â‚¬`, 190, yPos, { align: 'right' });
                yPos += 6;

                doc.text(`MwSt. ${kalkulationSaetze.mwstSatz}%:`, 120, yPos);
                doc.text(`${mwst.toFixed(2)} â‚¬`, 190, yPos, { align: 'right' });
                yPos += 8;

                doc.setFontSize(12);
                doc.setFont('helvetica', 'bold');
                doc.text('GESAMTBETRAG:', 120, yPos);
                doc.text(`${summeBrutto.toFixed(2)} â‚¬`, 190, yPos, { align: 'right' });

                // Footer
                doc.setFontSize(8);
                doc.setFont('helvetica', 'normal');
                doc.text('Dieser Kostenvoranschlag ist unverbindlich. PreisÃ¤nderungen vorbehalten.', 105, 285, { align: 'center' });

                // Download
                const filename = `KVA_${aktuelleKalkulation.kennzeichen || 'Frei'}_${new Date().toISOString().slice(0, 10)}.pdf`;
                doc.save(filename);
                showToast('PDF exportiert!', 'success');

            } catch (error) {
                console.error('âŒ Fehler beim PDF-Export:', error);
                showToast('Fehler beim PDF-Export', 'error');
            }
        }

        function sendKalkulationEmail() {
            showToast('Email-Versand wird vorbereitet...', 'info');
            // For now, just export PDF - email integration would require backend
            exportKalkulationPDF();
        }

        // ============================================
        // HISTORIE LADEN
        // ============================================

        async function loadHistorie() {
            try {
                console.log('ðŸ“œ Lade KVA-Historie aus partnerAnfragen...');

                // KVAs werden in partnerAnfragen gespeichert (kalkulationData Feld)
                const snapshot = await window.getCollection('partnerAnfragen')
                    .orderBy('createdAt', 'desc')
                    .limit(100)
                    .get();

                console.log('ðŸ“œ Alle partnerAnfragen:', snapshot.size);

                // Nur Anfragen mit kalkulationData filtern
                const kalkulationen = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.kalkulationData && data.kalkulationData.summeBrutto) {
                        kalkulationen.push({
                            id: doc.id,
                            ...data
                        });
                    }
                });

                console.log('ðŸ“œ Davon mit KVA:', kalkulationen.length);

                const container = document.getElementById('historieListe');

                if (kalkulationen.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i data-feather="file-text"></i>
                            <h3>Keine Kalkulationen</h3>
                            <p>Ihre erstellten Kalkulationen erscheinen hier</p>
                        </div>
                    `;
                    feather.replace();
                    return;
                }

                let html = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Datum</th>
                                <th>Kennzeichen</th>
                                <th>Kunde</th>
                                <th>Fahrzeug</th>
                                <th>Betrag (Brutto)</th>
                                <th>Status</th>
                                <th>Aktionen</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                kalkulationen.forEach(anfrage => {
                    const kva = anfrage.kalkulationData;
                    const datum = anfrage.createdAt ? new Date(anfrage.createdAt).toLocaleDateString('de-DE') : '-';
                    const fahrzeug = anfrage.fahrzeugMarke && anfrage.fahrzeugModell
                        ? `${anfrage.fahrzeugMarke} ${anfrage.fahrzeugModell}`
                        : (anfrage.marke && anfrage.modell ? `${anfrage.marke} ${anfrage.modell}` : '-');

                    const statusBadge = {
                        'entwurf': '<span style="background: var(--color-warning); color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">Entwurf</span>',
                        'kva_erstellt': '<span style="background: var(--color-primary); color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">KVA erstellt</span>',
                        'angebot_gesendet': '<span style="background: var(--color-info); color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">Angebot gesendet</span>',
                        'akzeptiert': '<span style="background: var(--color-success); color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">Akzeptiert</span>',
                        'abgelehnt': '<span style="background: var(--color-error); color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">Abgelehnt</span>',
                        'neu': '<span style="background: var(--color-secondary); color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px;">Neu</span>'
                    };

                    const summeBrutto = kva.summeBrutto || 0;

                    html += `
                        <tr>
                            <td>${datum}</td>
                            <td><strong>${anfrage.kennzeichen || '-'}</strong></td>
                            <td>${anfrage.kundenname || anfrage.partnerName || '-'}</td>
                            <td>${fahrzeug}</td>
                            <td><strong>${summeBrutto.toFixed(2)} â‚¬</strong></td>
                            <td>${statusBadge[anfrage.status] || anfrage.status || 'Unbekannt'}</td>
                            <td class="actions">
                                <button class="btn btn-icon btn-secondary" onclick="openKVAFromHistorie('${anfrage.id}')" title="Ã–ffnen">
                                    <i data-feather="eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                container.innerHTML = html;
                feather.replace();

            } catch (error) {
                console.error('âŒ Fehler beim Laden der Historie:', error);
            }
        }

        // KVA aus Historie Ã¶ffnen (Partner-Anfrage laden)
        async function openKVAFromHistorie(anfrageId) {
            try {
                const doc = await window.getCollection('partnerAnfragen').doc(anfrageId).get();
                if (!doc.exists) {
                    showToast('Anfrage nicht gefunden', 'error');
                    return;
                }

                const anfrage = doc.data();
                console.log('ðŸ“œ Ã–ffne KVA:', anfrage);

                // Zur KVA-Erstellen Seite navigieren mit Anfrage-ID
                window.location.href = `partner-app/kva-erstellen.html?anfrageId=${anfrageId}`;

            } catch (error) {
                console.error('âŒ Fehler beim Ã–ffnen der KVA:', error);
                showToast('Fehler beim Ã–ffnen', 'error');
            }
        }

        async function deleteKalkulation(kalkulationId) {
            if (!confirm('Kalkulation wirklich lÃ¶schen?')) return;

            try {
                await window.getCollection('kalkulationen').doc(kalkulationId).delete();
                showToast('Kalkulation gelÃ¶scht', 'success');
                await loadHistorie();
            } catch (error) {
                console.error('âŒ Fehler beim LÃ¶schen:', error);
                showToast('Fehler beim LÃ¶schen', 'error');
            }
        }

        async function loadKalkulationToEdit(kalkulationId) {
            try {
                const doc = await window.getCollection('kalkulationen').doc(kalkulationId).get();
                if (!doc.exists) {
                    showToast('Kalkulation nicht gefunden', 'error');
                    return;
                }

                const data = doc.data();
                aktuelleKalkulation = {
                    id: doc.id,
                    positionen: data.positionen || [],
                    materialien: data.materialien || [],
                    fahrzeugId: data.fahrzeugId,
                    kundenName: data.kundenName || '',
                    kennzeichen: data.kennzeichen || ''
                };

                // Switch to Kalkulation tab
                switchTab('kalkulation');
                document.getElementById('kalkulationContent').style.display = 'block';
                document.getElementById('freieKalkulationStart').style.display = 'none';

                renderKalkulationPositionen();
                renderKalkulationMaterial();
                updateKalkulationSummary();
                showToast('Kalkulation geladen', 'success');

            } catch (error) {
                console.error('âŒ Fehler beim Laden:', error);
                showToast('Fehler beim Laden', 'error');
            }
        }

        // ============================================
        // HELPER FUNCTIONS
        // ============================================

        // ðŸ†• Modal Ã¶ffnen/schlieÃŸen Funktionen
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
            } else {
                console.warn(`Modal ${modalId} nicht gefunden`);
                showToast('Diese Funktion ist noch in Entwicklung', 'info');
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
                // Reset inline styles
                modal.style.display = 'none';
                modal.style.cssText = '';

                // Reset modal content styles too
                const modalContent = modal.querySelector('.modal');
                if (modalContent) {
                    modalContent.style.cssText = '';
                }
            }
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i data-feather="${type === 'success' ? 'check-circle' : type === 'error' ? 'alert-circle' : 'info'}"></i>
                <span>${message}</span>
            `;
            container.appendChild(toast);
            feather.replace();

            setTimeout(() => {
                toast.style.animation = 'toastSlideIn 0.3s var(--ease-out) reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Close modal on overlay click
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });

        // ESC key to close modals
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal-overlay.active').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        });

        // ============================================
        // ðŸš€ SEITEN-INITIALISIERUNG
        // ============================================
        (async function initKalkulationPage() {
            console.log('ðŸ§® Kalkulations-Seite wird initialisiert...');

            // Warte auf Firebase
            if (window.firebaseInitialized) {
                await window.firebaseInitialized;
            }

            // ðŸ†• FIX: Warte auf werkstattId (Auth-Manager setzt diese nach Auth-State-Ã„nderung)
            let werkstattAttempts = 0;
            while (!window.werkstattId && werkstattAttempts < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                werkstattAttempts++;
            }

            if (!window.werkstattId) {
                console.warn('âš ï¸ initKalkulationPage: werkstattId nicht verfÃ¼gbar nach 5s');
            } else {
                console.log('âœ… initKalkulationPage: werkstattId =', window.werkstattId);
            }

            // Fahrzeuge aus DB laden
            await loadVehiclesFromDB();

            // Ersatzteile-Datenbank laden (fÃ¼r Autocomplete)
            await loadErsatzteileDB();

            // 2D SVG Vehicle-Parts klickbar machen
            initVehiclePartClickHandlers();

            // Autocomplete schlieÃŸen bei Klick auÃŸerhalb
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.ersatzteil-search-wrapper')) {
                    document.querySelectorAll('.ersatzteil-autocomplete').forEach(ac => {
                        ac.style.display = 'none';
                    });
                }
            });

            // Feather Icons initialisieren
            if (typeof feather !== 'undefined') {
                feather.replace();
            }

            console.log('âœ… Kalkulations-Seite initialisiert');

            // ðŸ†• EntwÃ¼rfe laden (erstes Tab ist jetzt Entwurf-Tab)
            await loadEntwuerfe();

            // ðŸ†• Partner-Anfragen laden (fÃ¼r Badge-Anzahl)
            loadPartnerAnfragen();

            // Templates und Kunden laden
            await loadTemplates();
            await loadKunden();
            await loadLieferanten();
        })();

        // ============================================
        // TEMPLATES FUNKTIONEN
        // ============================================

        // Standard-Templates Definitionen
        const STANDARD_TEMPLATES = {
            'standard_kotfluegel': {
                name: 'KotflÃ¼gel lackieren',
                kategorie: 'lackierung',
                icon: 'ðŸš—',
                arbeiten: [
                    { name: 'KotflÃ¼gel abkleben', aw: 4 },
                    { name: 'Schleifen/Vorbereitung', aw: 6 },
                    { name: 'Grundierung', aw: 4 },
                    { name: 'Basislack', aw: 5 },
                    { name: 'Klarlack', aw: 4 },
                    { name: 'Abkleben entfernen/Finish', aw: 3 }
                ],
                geschaetzteDauer: '~3h'
            },
            'standard_stossfaenger': {
                name: 'StoÃŸfÃ¤nger komplett',
                kategorie: 'lackierung',
                icon: 'ðŸ›¡ï¸',
                arbeiten: [
                    { name: 'StoÃŸfÃ¤nger demontieren', aw: 6 },
                    { name: 'Schleifen/Spachteln', aw: 8 },
                    { name: 'Grundierung', aw: 5 },
                    { name: 'Basislack', aw: 6 },
                    { name: 'Klarlack', aw: 5 },
                    { name: 'StoÃŸfÃ¤nger montieren', aw: 6 }
                ],
                geschaetzteDauer: '~5h'
            },
            'smart_beule': {
                name: 'Beule Smart Repair',
                kategorie: 'smart_repair',
                icon: 'ðŸ”§',
                arbeiten: [
                    { name: 'Delle lokalisieren', aw: 2 },
                    { name: 'PDR-Ausbeulen', aw: 8 },
                    { name: 'Kontrolle/Finish', aw: 2 }
                ],
                geschaetzteDauer: '~1h'
            },
            'smart_kratzer': {
                name: 'Kratzer ausbessern',
                kategorie: 'smart_repair',
                icon: 'âœ¨',
                arbeiten: [
                    { name: 'Kratzer bewerten', aw: 2 },
                    { name: 'Spot-Repair Lackierung', aw: 16 },
                    { name: 'Politur/Finish', aw: 4 }
                ],
                geschaetzteDauer: '~2h'
            },
            'unfall_seite': {
                name: 'Seitenschaden Standard',
                kategorie: 'unfall',
                icon: 'ðŸ’¥',
                arbeiten: [
                    { name: 'TÃ¼re demontieren', aw: 6 },
                    { name: 'Schweller instandsetzen', aw: 25 },
                    { name: 'KotflÃ¼gel hinten richten', aw: 20 },
                    { name: 'Spachteln/Schleifen', aw: 15 },
                    { name: 'Lackierung (3 Teile)', aw: 30 },
                    { name: 'TÃ¼re montieren', aw: 6 }
                ],
                ersatzteile: [
                    { name: 'Zierleiste TÃ¼r', preis: 85 },
                    { name: 'Dichtung TÃ¼r', preis: 45 }
                ],
                geschaetzteDauer: '~12h'
            },
            'unfall_front': {
                name: 'Frontschaden Standard',
                kategorie: 'unfall',
                icon: 'ðŸš§',
                arbeiten: [
                    { name: 'StoÃŸfÃ¤nger demontieren', aw: 6 },
                    { name: 'Motorhaube demontieren', aw: 4 },
                    { name: 'KotflÃ¼gel richten', aw: 15 },
                    { name: 'Motorhaube richten', aw: 12 },
                    { name: 'Spachteln/Schleifen', aw: 20 },
                    { name: 'Lackierung (3-4 Teile)', aw: 40 },
                    { name: 'Montage', aw: 12 }
                ],
                ersatzteile: [
                    { name: 'KÃ¼hlergrill', preis: 150 },
                    { name: 'StoÃŸfÃ¤ngerhalter', preis: 35 }
                ],
                geschaetzteDauer: '~15h'
            }
        };

        // ðŸ†• Kunden-DB Variable (wird von loadKunden gefÃ¼llt)
        let kundenDB = [];

        // ============================================
        // KUNDEN FUNKTIONEN
        // ============================================

        async function loadKunden() {
            try {
                if (!window.getCollection) {
                    console.log('â³ Kunden: Warte auf getCollection...');
                    return;
                }
                const snapshot = await window.getCollection('kalkulation_kunden')
                    .orderBy('letzteNutzung', 'desc')
                    .limit(50)
                    .get();
                kundenDB = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderKunden();
            } catch (error) {
                console.error('Fehler beim Laden der Kunden:', error);
            }
        }

        function renderKunden(filter = '') {
            const container = document.getElementById('kundenListe');
            if (!container) return;

            let filtered = kundenDB;
            if (filter) {
                const filterLower = filter.toLowerCase();
                filtered = kundenDB.filter(k =>
                    k.name?.toLowerCase().includes(filterLower) ||
                    k.fahrzeuge?.some(f =>
                        f.kennzeichen?.toLowerCase().includes(filterLower) ||
                        f.modell?.toLowerCase().includes(filterLower)
                    )
                );
            }

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <i data-feather="users"></i>
                        <h4>Keine Kunden ${filter ? 'gefunden' : 'vorhanden'}</h4>
                        <p>${filter ? 'Versuchen Sie einen anderen Suchbegriff' : 'Kunden werden automatisch aus abgeschlossenen Kalkulationen hinzugefÃ¼gt'}</p>
                    </div>
                `;
                feather.replace();
                return;
            }

            container.innerHTML = filtered.map(k => `
                <div class="kunde-card">
                    <div class="kunde-card__header">
                        <h4 class="kunde-card__name">${k.name || 'Unbekannter Kunde'}</h4>
                        <span class="kunde-card__badge">${k.anzahlAuftraege || 0} AuftrÃ¤ge</span>
                    </div>
                    <div class="kunde-card__fahrzeuge">
                        ${(k.fahrzeuge || []).slice(0, 3).map(f => `
                            <div class="kunde-fahrzeug" onclick="event.stopPropagation(); selectKundeFahrzeug('${k.id}', '${f.kennzeichen}')">
                                <div class="kunde-fahrzeug__info">
                                    <span class="kunde-fahrzeug__kennzeichen">${f.kennzeichen}</span>
                                    <span class="kunde-fahrzeug__modell">${f.marke} ${f.modell}</span>
                                </div>
                                <span class="kunde-fahrzeug__count">${f.anzahlKalkulationen || 0}x</span>
                            </div>
                        `).join('')}
                        ${(k.fahrzeuge?.length || 0) > 3 ? `<span class="text-muted">+${k.fahrzeuge.length - 3} weitere</span>` : ''}
                    </div>
                    <div class="kunde-card__actions" style="display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--color-border);">
                        <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); showKundenKVADetails('${k.id}')" style="flex: 1;">
                            <i data-feather="file-text"></i>
                            KVA-Historie
                        </button>
                        <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); selectKunde('${k.id}')" style="flex: 1;">
                            <i data-feather="plus"></i>
                            Neue KVA
                        </button>
                    </div>
                </div>
            `).join('');
            feather.replace();
        }

        function filterKunden(query) {
            renderKunden(query);
        }

        function sortKunden(sortBy) {
            if (sortBy === 'name') {
                kundenDB.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            } else if (sortBy === 'count') {
                kundenDB.sort((a, b) => (b.anzahlAuftraege || 0) - (a.anzahlAuftraege || 0));
            } else {
                kundenDB.sort((a, b) => new Date(b.letzteNutzung || 0) - new Date(a.letzteNutzung || 0));
            }
            renderKunden();
        }

        function selectKunde(kundeId) {
            const kunde = kundenDB.find(k => k.id === kundeId);
            if (!kunde) return;

            // Wechsle zur Kalkulation und setze Kundendaten
            switchTab('kalkulation');
            showToast(`Kunde "${kunde.name}" ausgewÃ¤hlt - Bitte Fahrzeug wÃ¤hlen`, 'info');
        }

        function selectKundeFahrzeug(kundeId, kennzeichen) {
            const kunde = kundenDB.find(k => k.id === kundeId);
            const fahrzeug = kunde?.fahrzeuge?.find(f => f.kennzeichen === kennzeichen);

            if (!fahrzeug) return;

            // Setze Fahrzeugdaten in den Wizard
            kalkWizardData.fahrzeug = {
                kennzeichen: fahrzeug.kennzeichen,
                marke: fahrzeug.marke,
                modell: fahrzeug.modell
            };

            // Wechsle zu Step 2 (Service)
            switchTab('kalkulation');
            goToStep(2);
            updateStep2Header();
            showToast(`Fahrzeug "${fahrzeug.kennzeichen}" geladen`, 'success');
        }

        async function saveKundeFromKalkulation(kalkulationData) {
            if (!kalkulationData.fahrzeug?.kennzeichen) return;

            const kundenName = kalkulationData.kunde?.name || 'Unbekannt';
            const fahrzeugData = {
                kennzeichen: kalkulationData.fahrzeug.kennzeichen,
                marke: kalkulationData.fahrzeug.marke,
                modell: kalkulationData.fahrzeug.modell,
                anzahlKalkulationen: 1
            };

            try {
                if (!window.getCollection) {
                    console.log('â³ saveKundeFromKalkulation: getCollection nicht verfÃ¼gbar');
                    return;
                }

                // Suche existierenden Kunden
                const existingQuery = await window.getCollection('kalkulation_kunden')
                    .where('name', '==', kundenName)
                    .get();

                if (!existingQuery.empty) {
                    // Update existierenden Kunden
                    const existingDoc = existingQuery.docs[0];
                    const existingData = existingDoc.data();
                    let fahrzeuge = existingData.fahrzeuge || [];

                    const existingFzg = fahrzeuge.find(f => f.kennzeichen === fahrzeugData.kennzeichen);
                    if (existingFzg) {
                        existingFzg.anzahlKalkulationen = (existingFzg.anzahlKalkulationen || 0) + 1;
                    } else {
                        fahrzeuge.push(fahrzeugData);
                    }

                    await existingDoc.ref.update({
                        fahrzeuge: fahrzeuge,
                        anzahlAuftraege: (existingData.anzahlAuftraege || 0) + 1,
                        letzteNutzung: new Date().toISOString()
                    });
                } else {
                    // Neuen Kunden anlegen
                    await window.getCollection('kalkulation_kunden').add({
                        name: kundenName,
                        fahrzeuge: [fahrzeugData],
                        anzahlAuftraege: 1,
                        letzteNutzung: new Date().toISOString(),
                        createdAt: new Date().toISOString()
                    });
                }

                console.log('âœ… Kunde gespeichert:', kundenName);
            } catch (error) {
                console.error('Fehler beim Speichern des Kunden:', error);
            }
        }

        // ============================================
        // ðŸ†• KVA-HISTORIE PRO KUNDE
        // ============================================

        // Cache fÃ¼r KVA-Daten pro Kunde
        let kundenKVACache = {};

        /**
         * LÃ¤dt alle KVAs fÃ¼r einen bestimmten Kunden
         * KVAs werden in partnerAnfragen gespeichert (kalkulationData Feld)
         */
        async function loadKVAsForKunde(kundenName) {
            if (!kundenName) return [];

            try {
                console.log('ðŸ“‹ Lade KVAs fÃ¼r Kunde:', kundenName);

                // KVAs sind in partnerAnfragen gespeichert
                const snapshot = await window.getCollection('partnerAnfragen')
                    .orderBy('createdAt', 'desc')
                    .limit(100)
                    .get();

                // Filtern nach Kundenname UND vorhandener Kalkulation
                const kvas = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const kundeMatch = (data.kundenname === kundenName) ||
                                       (data.partnerName === kundenName) ||
                                       (data.kundendaten?.name === kundenName);

                    if (kundeMatch && data.kalkulationData && data.kalkulationData.summeBrutto) {
                        kvas.push({
                            id: doc.id,
                            ...data,
                            // KVA-Daten fÃ¼r einfacheren Zugriff
                            summeBrutto: data.kalkulationData.summeBrutto,
                            positionen: data.kalkulationData.positionen || [],
                            materialien: data.kalkulationData.materialien || []
                        });
                    }
                });

                console.log('ðŸ“‹ KVAs gefunden fÃ¼r', kundenName + ':', kvas.length);

                kundenKVACache[kundenName] = kvas;
                return kvas;
            } catch (error) {
                console.error('âŒ Fehler beim Laden der KVAs fÃ¼r Kunde:', error);
                return [];
            }
        }

        /**
         * Zeigt KVA-Details fÃ¼r einen Kunden an
         */
        async function showKundenKVADetails(kundeId) {
            const kunde = kundenDB.find(k => k.id === kundeId);
            if (!kunde) return;

            // KVAs laden
            const kvas = await loadKVAsForKunde(kunde.name);

            // Modal Ã¶ffnen mit KVA-Historie
            const modalHtml = `
                <div class="modal-overlay" id="kundenKVAModal" style="display: flex; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 99999; background: rgba(0,0,0,0.7); justify-content: center; align-items: center;">
                    <div class="modal" style="background: #ffffff; border-radius: 16px; max-width: 800px; width: 90%; max-height: 80vh; overflow: hidden; box-shadow: 0 25px 50px rgba(0,0,0,0.5);">
                        <div class="modal-header" style="display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; background: #f5f5f7; border-bottom: 1px solid #e0e0e0;">
                            <h3 style="margin: 0; color: #1d1d1f;">ðŸ“‹ KVA-Historie: ${kunde.name}</h3>
                            <button class="modal-close" onclick="closeKundenKVAModal()" style="background: none; border: none; cursor: pointer; font-size: 24px; color: #86868b;">Ã—</button>
                        </div>
                        <div class="modal-body" style="padding: 20px; max-height: 60vh; overflow-y: auto; background: #ffffff;">
                            ${kvas.length === 0 ? `
                                <div class="empty-state" style="text-align: center; padding: 40px; color: #86868b;">
                                    <i data-feather="file-text" style="width: 48px; height: 48px; margin-bottom: 16px;"></i>
                                    <h4 style="margin: 0 0 8px; color: #1d1d1f;">Keine KVAs vorhanden</h4>
                                    <p style="margin: 0;">FÃ¼r diesen Kunden wurden noch keine Kalkulationen erstellt.</p>
                                </div>
                            ` : `
                                <table class="data-table" style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: #f5f5f7;">
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0;">Datum</th>
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0;">Kennzeichen</th>
                                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e0e0e0;">Fahrzeug</th>
                                            <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e0e0e0;">Betrag</th>
                                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e0e0e0;">Status</th>
                                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e0e0e0;">Aktionen</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${kvas.map(kva => {
                                            const datum = kva.createdAt ? new Date(kva.createdAt).toLocaleDateString('de-DE') : '-';
                                            const fahrzeug = kva.fahrzeugMarke && kva.fahrzeugModell
                                                ? `${kva.fahrzeugMarke} ${kva.fahrzeugModell}`
                                                : (kva.marke && kva.modell ? `${kva.marke} ${kva.modell}` : '-');
                                            const statusColors = {
                                                'entwurf': '#f5a623',
                                                'kva_erstellt': '#007aff',
                                                'angebot_gesendet': '#17a2b8',
                                                'akzeptiert': '#34c759',
                                                'abgelehnt': '#ff3b30',
                                                'neu': '#6c757d'
                                            };
                                            const statusLabels = {
                                                'entwurf': 'Entwurf',
                                                'kva_erstellt': 'KVA erstellt',
                                                'angebot_gesendet': 'Angebot gesendet',
                                                'akzeptiert': 'Akzeptiert',
                                                'abgelehnt': 'Abgelehnt',
                                                'neu': 'Neu'
                                            };
                                            return `
                                                <tr style="border-bottom: 1px solid #e0e0e0;">
                                                    <td style="padding: 12px;">${datum}</td>
                                                    <td style="padding: 12px; font-weight: 600;">${kva.kennzeichen || '-'}</td>
                                                    <td style="padding: 12px;">${fahrzeug}</td>
                                                    <td style="padding: 12px; text-align: right; font-weight: 600;">${(kva.summeBrutto || 0).toFixed(2)} â‚¬</td>
                                                    <td style="padding: 12px; text-align: center;">
                                                        <span style="background: ${statusColors[kva.status] || '#86868b'}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                                            ${statusLabels[kva.status] || kva.status || 'Unbekannt'}
                                                        </span>
                                                    </td>
                                                    <td style="padding: 12px; text-align: center;">
                                                        <button onclick="openKVAFromHistorie('${kva.id}'); closeKundenKVAModal();" style="background: #007aff; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                                            Ã–ffnen
                                                        </button>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                                <div style="margin-top: 16px; padding: 12px; background: #f5f5f7; border-radius: 8px; display: flex; justify-content: space-between;">
                                    <span style="color: #86868b;">Gesamt: ${kvas.length} KVA(s)</span>
                                    <span style="font-weight: 600; color: #1d1d1f;">Summe: ${kvas.reduce((sum, k) => sum + (k.summeBrutto || 0), 0).toFixed(2)} â‚¬</span>
                                </div>
                            `}
                        </div>
                        <div class="modal-footer" style="display: flex; justify-content: flex-end; gap: 12px; padding: 16px 20px; background: #f5f5f7; border-top: 1px solid #e0e0e0;">
                            <button onclick="closeKundenKVAModal()" style="background: #e0e0e0; color: #1d1d1f; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                SchlieÃŸen
                            </button>
                            <button onclick="closeKundenKVAModal(); selectKunde('${kundeId}');" style="background: #007aff; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                Neue KVA erstellen
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // Modal zum DOM hinzufÃ¼gen
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            feather.replace();
        }

        function closeKundenKVAModal() {
            const modal = document.getElementById('kundenKVAModal');
            if (modal) modal.remove();
        }

        // ============================================
        // PDF-EXPORT BESTELLLISTE
        // ============================================

        async function exportBestelllistePDF() {
            if (kalkWizardData.ersatzteile.length === 0) {
                showToast('Keine Ersatzteile zum Exportieren vorhanden', 'warning');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('Bestellliste Ersatzteile', 20, 20);

            // Fahrzeug-Info
            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            if (kalkWizardData.fahrzeug) {
                doc.text(`Fahrzeug: ${kalkWizardData.fahrzeug.marke || ''} ${kalkWizardData.fahrzeug.modell || ''}`, 20, 30);
                doc.text(`Kennzeichen: ${kalkWizardData.fahrzeug.kennzeichen || '-'}`, 20, 36);
            }

            doc.text(`Datum: ${new Date().toLocaleDateString('de-DE')}`, 20, 42);

            // Tabelle
            let y = 55;
            doc.setFillColor(240, 240, 240);
            doc.rect(20, y - 5, 170, 8, 'F');

            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('Nr.', 22, y);
            doc.text('Bezeichnung', 32, y);
            doc.text('Teilenummer', 100, y);
            doc.text('Menge', 140, y);
            doc.text('Preis', 160, y);

            doc.setFont(undefined, 'normal');
            y += 10;

            let gesamtPreis = 0;
            kalkWizardData.ersatzteile.forEach((e, index) => {
                const einzelPreis = (e.preis || 0) * (e.menge || 1);
                gesamtPreis += einzelPreis;

                doc.text(String(index + 1), 22, y);
                doc.text(e.name?.substring(0, 35) || '-', 32, y);
                doc.text(e.teilenummer?.substring(0, 20) || '-', 100, y);
                doc.text(String(e.menge || 1), 142, y);
                doc.text(`${einzelPreis.toFixed(2)} â‚¬`, 160, y);

                y += 7;

                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
            });

            // Summe
            y += 5;
            doc.line(20, y, 190, y);
            y += 8;
            doc.setFont(undefined, 'bold');
            doc.text('Gesamt (Netto):', 130, y);
            doc.text(`${gesamtPreis.toFixed(2)} â‚¬`, 160, y);

            // Speichern
            const fileName = `Bestellliste_${kalkWizardData.fahrzeug?.kennzeichen || 'Unbekannt'}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
            showToast('Bestellliste als PDF exportiert', 'success');
        }

        // ============================================
        // KI-PREISVORSCHLAG
        // ============================================

        function getKIPreisvorschlag(ersatzteilName) {
            // Suche in der Datenbank nach Ã¤hnlichen Teilen
            const queryLower = ersatzteilName.toLowerCase();
            const matches = ersatzteileDB.filter(e =>
                e.name?.toLowerCase().includes(queryLower)
            );

            if (matches.length === 0) return null;

            // Berechne Durchschnittspreis aus allen Matches
            const preise = matches
                .filter(e => e.durchschnittsPreis || e.preis)
                .map(e => e.durchschnittsPreis || e.preis);

            if (preise.length === 0) return null;

            const avgPreis = preise.reduce((a, b) => a + b, 0) / preise.length;
            const minPreis = Math.min(...preise);
            const maxPreis = Math.max(...preise);

            return {
                vorschlag: avgPreis,
                min: minPreis,
                max: maxPreis,
                basierend: matches.length
            };
        }

        function showKIPreisvorschlag(inputId) {
            const input = document.getElementById(inputId);
            if (!input) return;

            const nameInput = document.getElementById(inputId.replace('Preis', 'Name'));
            const ersatzteilName = nameInput?.value;

            if (!ersatzteilName || ersatzteilName.length < 3) {
                showToast('Bitte zuerst einen Teilenamen eingeben', 'info');
                return;
            }

            const vorschlag = getKIPreisvorschlag(ersatzteilName);

            if (!vorschlag) {
                showToast('Keine Preisdaten fÃ¼r dieses Teil verfÃ¼gbar', 'info');
                return;
            }

            const confirmMsg = `KI-Preisvorschlag fÃ¼r "${ersatzteilName}":\n\n` +
                `Empfohlen: ${vorschlag.vorschlag.toFixed(2)} â‚¬\n` +
                `(Min: ${vorschlag.min.toFixed(2)} â‚¬ / Max: ${vorschlag.max.toFixed(2)} â‚¬)\n` +
                `Basierend auf ${vorschlag.basierend} Ã¤hnlichen Teilen.\n\n` +
                `Diesen Preis Ã¼bernehmen?`;

            if (confirm(confirmMsg)) {
                input.value = vorschlag.vorschlag.toFixed(2);
                showToast('Preis Ã¼bernommen', 'success');
            }
        }

        // ============================================
        // KI FOTO-ANALYSE FUNKTIONEN
        // ============================================

        let uploadedFotos = [];
        let kiErkannteSchaeden = [];

        function initFotoDropzone() {
            const dropzone = document.getElementById('fotoDropzone');
            if (!dropzone) return;

            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.classList.add('dragover');
            });

            dropzone.addEventListener('dragleave', () => {
                dropzone.classList.remove('dragover');
            });

            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.classList.remove('dragover');
                const files = e.dataTransfer.files;
                handleFotoUpload(files);
            });
        }

        async function handleFotoUpload(files) {
            if (!files || files.length === 0) return;

            const preview = document.getElementById('fotoPreview');
            uploadedFotos = [];

            // Fotos anzeigen
            preview.innerHTML = '';
            for (const file of files) {
                if (!file.type.startsWith('image/')) continue;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    preview.appendChild(img);
                    uploadedFotos.push(e.target.result);
                };
                reader.readAsDataURL(file);
            }

            // Kurze VerzÃ¶gerung, dann KI-Analyse starten
            setTimeout(() => {
                if (uploadedFotos.length > 0) {
                    analyzeWithKI();
                }
            }, 500);
        }

        async function analyzeWithKI() {
            const loading = document.getElementById('kiAnalyseLoading');
            const result = document.getElementById('kiAnalyseResult');

            loading.style.display = 'block';
            result.style.display = 'none';

            try {
                // OpenAI API Key aus SettingsManager oder Firestore laden
                let apiKey = '';
                if (window.settingsManager?.currentSettings?.systemConfig?.openaiKey) {
                    apiKey = window.settingsManager.currentSettings.systemConfig.openaiKey;
                    console.log('âœ… API-Key aus settingsManager geladen');
                } else {
                    // Fallback: Direkt aus Firestore laden via Multi-Tenant Helper
                    console.log('ðŸ“¥ Lade API-Key aus Firestore via getCollection()');
                    const settingsDoc = await window.getCollection('einstellungen').doc('config').get();
                    if (settingsDoc.exists) {
                        apiKey = settingsDoc.data()?.systemConfig?.openaiKey || '';
                        console.log('âœ… API-Key aus Firestore geladen');
                    }
                }

                if (!apiKey) {
                    throw new Error('OpenAI API-Key nicht konfiguriert. Bitte in Admin-Einstellungen hinterlegen.');
                }

                // Bilder fÃ¼r GPT-4 Vision vorbereiten (max 4 Bilder)
                const imagesToAnalyze = uploadedFotos.slice(0, 4);

                const imageContents = imagesToAnalyze.map(base64 => ({
                    type: 'image_url',
                    image_url: {
                        url: base64,
                        detail: 'high'
                    }
                }));

                // GPT-4 Vision API aufrufen
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        messages: [
                            {
                                role: 'system',
                                content: `Du bist ein Experte fÃ¼r Fahrzeugschaden-Analyse in einer Lackierwerkstatt.
Analysiere die Bilder und identifiziere alle sichtbaren SchÃ¤den am Fahrzeug.

WICHTIG: Antworte NUR im folgenden JSON-Format (keine Markdown, keine ErklÃ¤rungen):
{
  "schaeden": [
    {
      "teil": "Bezeichnung des Fahrzeugteils (z.B. StoÃŸfÃ¤nger vorne, KotflÃ¼gel links, Motorhaube)",
      "schaden": "Art des Schadens (z.B. Kratzer, Delle, Steinschlag, Rost, Riss, Lackabplatzer)",
      "schweregrad": "leicht/mittel/schwer",
      "repairType": "lackieren/ausbeulen/spotrepair/ersetzen/polieren",
      "confidence": 0.0-1.0
    }
  ],
  "zusammenfassung": "Kurze Zusammenfassung des Gesamtschadens"
}

Fahrzeugteile die du erkennen kannst:
- StoÃŸfÃ¤nger vorne/hinten
- KotflÃ¼gel links/rechts vorne/hinten
- Motorhaube, Dach, Kofferraum
- TÃ¼ren (FahrertÃ¼r, BeifahrertÃ¼r, hinten links/rechts)
- Schweller links/rechts
- A-SÃ¤ule, B-SÃ¤ule, C-SÃ¤ule
- AuÃŸenspiegel links/rechts
- Felgen/RÃ¤der`
                            },
                            {
                                role: 'user',
                                content: [
                                    {
                                        type: 'text',
                                        text: 'Analysiere diese Fahrzeugbilder und identifiziere alle sichtbaren SchÃ¤den. Gib das Ergebnis als JSON zurÃ¼ck.'
                                    },
                                    ...imageContents
                                ]
                            }
                        ],
                        max_tokens: 1500,
                        temperature: 0.3
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'API-Fehler');
                }

                const data = await response.json();
                const content = data.choices?.[0]?.message?.content || '';

                // JSON aus der Antwort extrahieren
                let analysisResult;
                try {
                    // Versuche direkt zu parsen
                    analysisResult = JSON.parse(content);
                } catch {
                    // Fallback: JSON aus Markdown-Block extrahieren
                    const jsonMatch = content.match(/```json\s*([\s\S]*?)\s*```/) ||
                                     content.match(/\{[\s\S]*"schaeden"[\s\S]*\}/);
                    if (jsonMatch) {
                        analysisResult = JSON.parse(jsonMatch[1] || jsonMatch[0]);
                    } else {
                        throw new Error('Konnte KI-Antwort nicht parsen');
                    }
                }

                // Ergebnisse in das erwartete Format konvertieren
                kiErkannteSchaeden = (analysisResult.schaeden || []).map(s => ({
                    teil: s.teil,
                    schaden: s.schaden,
                    schweregrad: s.schweregrad || 'mittel',
                    confidence: s.confidence || 0.8,
                    repairType: s.repairType || 'lackieren'
                }));

                if (kiErkannteSchaeden.length === 0) {
                    showToast('Keine eindeutigen SchÃ¤den erkannt. Bitte andere Bilder hochladen.', 'info');
                } else {
                    // Zusammenfassung anzeigen wenn vorhanden
                    if (analysisResult.zusammenfassung) {
                        console.log('ðŸ“‹ KI-Zusammenfassung:', analysisResult.zusammenfassung);
                    }
                    showToast(`${kiErkannteSchaeden.length} SchÃ¤den erkannt!`, 'success');
                }

                renderKIErgebnisse();

            } catch (error) {
                console.error('âŒ KI-Analyse Fehler:', error);
                showToast(`KI-Analyse fehlgeschlagen: ${error.message}`, 'error');

                // Fallback: Zeige Hinweis zur manuellen Eingabe
                kiErkannteSchaeden = [];
                const liste = document.getElementById('kiSchaedenListe');
                if (liste) {
                    liste.innerHTML = `
                        <div class="empty-state" style="padding: var(--space-4);">
                            <i data-feather="alert-circle"></i>
                            <p>${error.message}</p>
                            <p class="text-muted">Bitte wÃ¤hlen Sie die beschÃ¤digten Teile manuell in der 2D-Ansicht aus.</p>
                        </div>
                    `;
                    feather.replace();
                }
            }

            loading.style.display = 'none';
            result.style.display = 'block';
            feather.replace();
        }

        function renderKIErgebnisse() {
            const liste = document.getElementById('kiSchaedenListe');
            if (!liste) return;

            if (kiErkannteSchaeden.length === 0) {
                liste.innerHTML = `
                    <div class="empty-state" style="padding: var(--space-4);">
                        <i data-feather="image"></i>
                        <p>Keine SchÃ¤den erkannt</p>
                    </div>
                `;
                feather.replace();
                return;
            }

            const schwereIcons = {
                'leicht': 'ðŸŸ¢',
                'mittel': 'ðŸŸ¡',
                'schwer': 'ðŸ”´'
            };

            const repairLabels = {
                'lackieren': 'ðŸŽ¨ Lackieren',
                'ausbeulen': 'ðŸ”§ Ausbeulen (PDR)',
                'spotrepair': 'âœ¨ Spot-Repair',
                'ersetzen': 'ðŸ”„ Ersetzen',
                'polieren': 'ðŸ’« Polieren'
            };

            liste.innerHTML = kiErkannteSchaeden.map((schaden, index) => {
                const confidenceClass = schaden.confidence >= 0.85 ? 'high' :
                                       schaden.confidence >= 0.7 ? 'medium' : 'low';
                const schwereIcon = schwereIcons[schaden.schweregrad] || 'ðŸŸ¡';
                const repairLabel = repairLabels[schaden.repairType] || schaden.repairType;

                return `
                    <div class="ki-schaden-item">
                        <div class="ki-schaden-item__info">
                            <input type="checkbox" id="kiSchaden${index}" checked>
                            <label for="kiSchaden${index}">
                                <strong>${schaden.teil}</strong> - ${schaden.schaden}
                                <br><small>${schwereIcon} ${schaden.schweregrad || 'mittel'} | ${repairLabel}</small>
                            </label>
                        </div>
                        <span class="ki-schaden-item__confidence ki-schaden-item__confidence--${confidenceClass}">
                            ${Math.round(schaden.confidence * 100)}%
                        </span>
                    </div>
                `;
            }).join('');
            feather.replace();
        }

        function applyKISchaeden() {
            // AusgewÃ¤hlte SchÃ¤den in den Wizard Ã¼bernehmen
            const selectedSchaeden = [];

            kiErkannteSchaeden.forEach((schaden, index) => {
                const checkbox = document.getElementById(`kiSchaden${index}`);
                if (checkbox?.checked) {
                    selectedSchaeden.push(schaden);

                    // Teil zum Wizard hinzufÃ¼gen
                    selectVehiclePartNew(schaden.teil, null);
                }
            });

            if (selectedSchaeden.length > 0) {
                showToast(`${selectedSchaeden.length} SchÃ¤den Ã¼bernommen - Bitte Reparaturart wÃ¤hlen`, 'success');
                // Zur 2D-Ansicht wechseln, um die ausgewÃ¤hlten Teile zu sehen
                switchVehicleView('2d');
            } else {
                showToast('Keine SchÃ¤den ausgewÃ¤hlt', 'warning');
            }
        }

        // Initialisiert Klick-Handler fÃ¼r alle vehicle-part SVG-Elemente
        function initVehiclePartClickHandlers() {
            const svgParts = document.querySelectorAll('.vehicle-part[data-part]');
            console.log(`ðŸš— ${svgParts.length} Fahrzeugteile gefunden fÃ¼r 2D-Ansicht`);

            svgParts.forEach(part => {
                part.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const partName = this.getAttribute('data-part');
                    if (partName) {
                        selectVehiclePartNew(partName, this);
                        showToast(`Teil "${partName}" ausgewÃ¤hlt`, 'success');
                    }
                });

                // Hover-Tooltip
                part.addEventListener('mouseenter', function() {
                    const partName = this.getAttribute('data-part');
                    this.style.cursor = 'pointer';
                    // Optional: Tooltip anzeigen
                });
            });
        }

        // ============================================
        // ðŸŒ“ LIGHT/DARK MODE TOGGLE
        // ============================================
        (function initThemeToggle() {
            const themeToggle = document.getElementById('dark-mode-toggle');
            const mobileThemeToggle = document.getElementById('mobile-theme-toggle');
            const html = document.documentElement;

            // Function to update Accessibility Attributes (both buttons)
            function updateAccessibility(theme) {
                // Update Desktop Toggle
                const toggleButton = document.getElementById('dark-mode-toggle');
                if (toggleButton) {
                    toggleButton.setAttribute('aria-pressed', theme === 'dark' ? 'true' : 'false');
                    toggleButton.setAttribute('aria-label',
                        theme === 'dark' ? 'Hellen Modus aktivieren' : 'Dunklen Modus aktivieren'
                    );
                    const srText = toggleButton.querySelector('.sr-only');
                    if (srText) {
                        srText.textContent = `Aktuelles Theme: ${theme === 'dark' ? 'Dunkel' : 'Hell'}`;
                    }
                }

                // Update Mobile Toggle
                const mobileToggle = document.getElementById('mobile-theme-toggle');
                if (mobileToggle) {
                    mobileToggle.setAttribute('aria-pressed', theme === 'dark' ? 'true' : 'false');
                    mobileToggle.setAttribute('aria-label',
                        theme === 'dark' ? 'Hellen Modus aktivieren' : 'Dunklen Modus aktivieren'
                    );
                }

                console.log(`â™¿ Accessibility attributes updated for ${theme} mode`);
            }

            // Function to update Theme Toggle Button Icons stroke-width only
            function updateThemeToggleIcons(theme) {
                const strokeWidth = theme === 'light' ? '2.5' : '2';

                // Update ONLY Theme Toggle Button Icons (not all icons on page!)
                const toggleButton = document.getElementById('dark-mode-toggle');
                if (toggleButton) {
                    toggleButton.querySelectorAll('svg *[stroke]').forEach(element => {
                        element.setAttribute('stroke-width', strokeWidth);
                    });
                    console.log(`ðŸŽ¨ Theme Toggle Icons stroke-width updated to ${strokeWidth} for ${theme} mode`);
                }
            }

            // Get current theme (already set in <head> for FOUC prevention)
            let currentTheme = html.getAttribute('data-theme') || 'light';
            console.log(`ðŸŒ“ Theme initialized: ${currentTheme} (from <head> pre-load)`);

            // Toggle theme on button click
            const themeToggleHandler = () => {
                currentTheme = currentTheme === 'light' ? 'dark' : 'light';
                html.setAttribute('data-theme', currentTheme);
                localStorage.setItem('theme', currentTheme);

                console.log(`ðŸŒ“ Theme switched to: ${currentTheme}`);

                // Update accessibility attributes
                updateAccessibility(currentTheme);

                // Re-initialize Feather Icons for theme change
                if (typeof feather !== 'undefined') {
                    feather.replace();
                    // Wait for feather.replace() to finish, then update stroke-width
                    setTimeout(() => updateThemeToggleIcons(currentTheme), 50);
                }
            };

            // Register Desktop theme toggle
            if (themeToggle) {
                if (window.listenerRegistry?.registerDOM) {
                    window.listenerRegistry.registerDOM(themeToggle, 'click', themeToggleHandler, 'Theme Toggle Button (Desktop)');
                } else {
                    themeToggle.addEventListener('click', themeToggleHandler);
                }
            }

            // Register Mobile theme toggle
            if (mobileThemeToggle) {
                if (window.listenerRegistry?.registerDOM) {
                    window.listenerRegistry.registerDOM(mobileThemeToggle, 'click', themeToggleHandler, 'Theme Toggle Button (Mobile)');
                } else {
                    mobileThemeToggle.addEventListener('click', themeToggleHandler);
                }
            }

            // Keyboard Shortcut: Cmd+Shift+D (Mac) or Ctrl+Shift+D (Windows/Linux)
            const keyboardShortcutHandler = (e) => {
                const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
                const modifierKey = isMac ? e.metaKey : e.ctrlKey;

                if (modifierKey && e.shiftKey && e.key.toLowerCase() === 'd') {
                    e.preventDefault();
                    themeToggleHandler();
                    console.log(`âŒ¨ï¸ Theme toggled via keyboard shortcut (${isMac ? 'Cmd' : 'Ctrl'}+Shift+D)`);
                }
            };

            document.addEventListener('keydown', keyboardShortcutHandler);

            // Initial accessibility setup
            updateAccessibility(currentTheme);

            console.log('ðŸŒ“ Theme Toggle initialized (Desktop + Mobile + Keyboard Shortcut)');
        })();
    </script>
</body>
</html>
