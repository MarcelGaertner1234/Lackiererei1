<!DOCTYPE html>
<html lang="de" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üßÆ Kalkulation - Fahrzeugannahme App</title>

    <!-- üåì FOUC Prevention: Load Theme BEFORE CSS -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>

    <!-- Design System CSS -->
    <link rel="stylesheet" href="design-system.css">
    <link rel="stylesheet" href="components.css">
    <link rel="stylesheet" href="animations.css">
    <link rel="stylesheet" href="mobile-first.css">

    <!-- üõ°Ô∏è PERFORMANCE FIX Phase 2: Ausgelagertes CSS -->
    <link rel="stylesheet" href="css/kalkulation.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="listener-registry.js"></script>
    <script src="js/auth-manager.js"></script>
    <script src="js/utils/escape-html.js"></script>

    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>

    <!-- Sketchfab Viewer API -->
    <script src="https://static.sketchfab.com/api/sketchfab-viewer-1.12.1.js"></script>

    <!-- jsPDF f√ºr PDF-Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Ersatzteile-Datenbank mit OE-Nummern -->
    <script src="ersatzteile-db.js"></script>
</head>
<body>
    <div class="page-container">
        <!-- Header -->
        <header class="page-header">
            <div class="page-header-left">
                <button class="back-button" onclick="safeNavigate('index.html')" title="Zur√ºck zum Dashboard">
                    <i data-feather="arrow-left"></i>
                </button>
                <div class="page-title">
                    <h1>üßÆ Kalkulation</h1>
                    <span class="badge">NEU</span>
                </div>
            </div>
        </header>

        <!-- Tab Navigation -->
        <nav class="tab-navigation">
            <button class="tab-button active" data-tab="kalkulation" onclick="switchTab('kalkulation')">
                <i data-feather="hash"></i>
                <span>Neue Kalkulation</span>
            </button>
            <button class="tab-button" data-tab="katalog" onclick="switchTab('katalog')">
                <i data-feather="book"></i>
                <span>Arbeitswert-Katalog</span>
            </button>
            <button class="tab-button" data-tab="saetze" onclick="switchTab('saetze')">
                <i data-feather="dollar-sign"></i>
                <span>Stundens√§tze</span>
            </button>
            <button class="tab-button" data-tab="material" onclick="switchTab('material')">
                <i data-feather="package"></i>
                <span>Material</span>
            </button>
            <button class="tab-button" data-tab="historie" onclick="switchTab('historie')">
                <i data-feather="clock"></i>
                <span>Historie</span>
            </button>
            <button class="tab-button" data-tab="templates" onclick="switchTab('templates')">
                <i data-feather="copy"></i>
                <span>Templates</span>
            </button>
            <button class="tab-button" data-tab="lieferanten" onclick="switchTab('lieferanten')">
                <i data-feather="truck"></i>
                <span>Lieferanten</span>
            </button>
            <button class="tab-button" data-tab="kunden" onclick="switchTab('kunden')">
                <i data-feather="users"></i>
                <span>Kunden</span>
            </button>
        </nav>

        <!-- ============================================ -->
        <!-- TAB 1: Neue Kalkulation erstellen -->
        <!-- ============================================ -->
        <section id="tab-kalkulation" class="tab-content active">

            <!-- ============================================ -->
            <!-- STEP PROGRESS BAR (6 Steps) -->
            <!-- ============================================ -->
            <div class="kalk-steps">
                <div class="kalk-step active" data-step="1">
                    <div class="kalk-step__number">1</div>
                    <div class="kalk-step__label">Fahrzeug</div>
                </div>
                <div class="kalk-step__line"></div>
                <div class="kalk-step" data-step="2">
                    <div class="kalk-step__number">2</div>
                    <div class="kalk-step__label">Service</div>
                </div>
                <div class="kalk-step__line"></div>
                <div class="kalk-step" data-step="3">
                    <div class="kalk-step__number">3</div>
                    <div class="kalk-step__label">Teil</div>
                </div>
                <div class="kalk-step__line"></div>
                <div class="kalk-step" data-step="4">
                    <div class="kalk-step__number">4</div>
                    <div class="kalk-step__label">Arbeiten</div>
                </div>
                <div class="kalk-step__line"></div>
                <div class="kalk-step" data-step="5">
                    <div class="kalk-step__number">5</div>
                    <div class="kalk-step__label">Ersatzteile</div>
                </div>
                <div class="kalk-step__line"></div>
                <div class="kalk-step" data-step="6">
                    <div class="kalk-step__number">6</div>
                    <div class="kalk-step__label">√úbersicht</div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- STEP 1: FAHRZEUGDATEN -->
            <!-- ============================================ -->
            <div class="kalk-step-content active" id="stepContent1">
                <div class="content-card">
                    <div class="content-card__header">
                        <div class="content-card__title">
                            <i data-feather="truck"></i>
                            <h2>Schritt 1: Fahrzeugdaten</h2>
                        </div>
                    </div>

                    <!-- TABS: Entwurf, Partner-Anfragen, Bestehendes Fahrzeug oder Neues Fahrzeug -->
                    <div class="kalk-vehicle-tabs">
                        <button class="kalk-vehicle-tab active" data-tab="entwurf" onclick="switchVehicleTab('entwurf')">
                            <i data-feather="file-text"></i>
                            üìù Aus Entwurf
                            <span class="entwurf-badge" id="entwurfCount" style="display: none;">0</span>
                        </button>
                        <button class="kalk-vehicle-tab" data-tab="partner" onclick="switchVehicleTab('partner')">
                            <i data-feather="users"></i>
                            ü§ù Partner-Anfragen
                            <span class="entwurf-badge partner-badge" id="partnerCount" style="display: none;">0</span>
                        </button>
                        <button class="kalk-vehicle-tab" data-tab="existing" onclick="switchVehicleTab('existing')">
                            <i data-feather="database"></i>
                            Bestehendes Fahrzeug
                        </button>
                        <button class="kalk-vehicle-tab" data-tab="new" onclick="switchVehicleTab('new')">
                            <i data-feather="plus-circle"></i>
                            Neues Fahrzeug
                        </button>
                    </div>

                    <!-- TAB: Entw√ºrfe aus Annahme -->
                    <div class="kalk-vehicle-tab-content active" id="tabEntwurf">
                        <div class="entwurf-info-banner">
                            <i data-feather="info"></i>
                            <div>
                                <strong>Entw√ºrfe aus der Fahrzeugannahme</strong>
                                <p>W√§hlen Sie einen Entwurf aus, um die Daten automatisch zu √ºbernehmen (Fahrzeug, Service, Fotos).</p>
                            </div>
                        </div>

                        <div class="kalk-vehicle-list" id="entwurfList">
                            <div class="kalk-vehicle-loading" id="entwurfLoading">
                                <div class="spinner-small"></div>
                                <span>Entw√ºrfe werden geladen...</span>
                            </div>
                            <div class="kalk-vehicle-empty" id="entwurfEmpty" style="display: none;">
                                <i data-feather="inbox"></i>
                                <p>Keine offenen Entw√ºrfe vorhanden</p>
                                <small>Erstellen Sie einen Entwurf √ºber die Fahrzeugannahme</small>
                            </div>
                            <div id="entwurfListItems">
                                <!-- Dynamisch gef√ºllt -->
                            </div>
                        </div>
                    </div>

                    <!-- TAB: Partner-Anfragen -->
                    <div class="kalk-vehicle-tab-content" id="tabPartner" style="display: none;">
                        <div class="entwurf-info-banner partner-banner">
                            <i data-feather="users"></i>
                            <div>
                                <strong>Partner-Anfragen</strong>
                                <p>Anfragen von Partnern, die noch kein KVA haben. W√§hlen Sie eine Anfrage um ein KVA zu erstellen.</p>
                            </div>
                        </div>

                        <div class="kalk-vehicle-list" id="partnerList">
                            <div class="kalk-vehicle-loading" id="partnerLoading">
                                <div class="spinner-small"></div>
                                <span>Partner-Anfragen werden geladen...</span>
                            </div>
                            <div class="kalk-vehicle-empty" id="partnerEmpty" style="display: none;">
                                <i data-feather="inbox"></i>
                                <p>Keine offenen Partner-Anfragen</p>
                                <small>Alle Anfragen haben bereits ein KVA oder sind abgeschlossen</small>
                            </div>
                            <div id="partnerListItems">
                                <!-- Dynamisch gef√ºllt -->
                            </div>
                        </div>
                    </div>

                    <!-- TAB: Bestehendes Fahrzeug aus DB -->
                    <div class="kalk-vehicle-tab-content" id="tabExisting" style="display: none;">
                        <div class="kalk-vehicle-search">
                            <div class="form-group">
                                <label>Fahrzeug suchen</label>
                                <input type="text" id="vehicleSearchInput"
                                       placeholder="Kennzeichen, Kunde oder Marke eingeben..."
                                       oninput="searchVehicles()">
                            </div>
                        </div>

                        <div class="kalk-vehicle-list" id="vehicleList">
                            <div class="kalk-vehicle-loading" id="vehicleLoading">
                                <div class="spinner-small"></div>
                                <span>Fahrzeuge werden geladen...</span>
                            </div>
                            <div class="kalk-vehicle-empty" id="vehicleEmpty" style="display: none;">
                                <i data-feather="inbox"></i>
                                <p>Keine Fahrzeuge gefunden</p>
                                <button class="btn btn-secondary btn-sm" onclick="switchVehicleTab('new')">
                                    Neues Fahrzeug anlegen
                                </button>
                            </div>
                            <div id="vehicleListItems">
                                <!-- Dynamisch gef√ºllt -->
                            </div>
                        </div>
                    </div>

                    <!-- TAB: Neues Fahrzeug manuell -->
                    <div class="kalk-vehicle-tab-content" id="tabNew" style="display: none;">
                        <div class="kalk-vehicle-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="kalkMarke">Marke *</label>
                                <select id="kalkMarke" onchange="updateKalkModelle()" required>
                                    <option value="">-- Marke w√§hlen --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="kalkModell">Modell *</label>
                                <select id="kalkModell" required>
                                    <option value="">-- Erst Marke w√§hlen --</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="kalkBaujahr">Baujahr *</label>
                                <select id="kalkBaujahr" required>
                                    <option value="">-- Baujahr --</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="kalkKennzeichen">Kennzeichen (optional)</label>
                                <input type="text" id="kalkKennzeichen" placeholder="z.B. MOS-AB 123">
                            </div>
                            <div class="form-group">
                                <label for="kalkFarbe">Farbcode (optional)</label>
                                <input type="text" id="kalkFarbe" placeholder="z.B. LY9T">
                            </div>
                            <div class="form-group">
                                <label for="kalkKunde">Kundenname (optional)</label>
                                <input type="text" id="kalkKunde" placeholder="z.B. Max Mustermann">
                            </div>
                        </div>

                        <!-- Fahrzeug-Info Box -->
                        <div class="kalk-vehicle-info" id="kalkVehicleInfo" style="display: none;">
                            <div class="kalk-vehicle-info__icon">üöó</div>
                            <div class="kalk-vehicle-info__details">
                                <strong id="kalkVehicleDisplay">-</strong>
                                <span id="kalkVehicleExtra">-</span>
                            </div>
                        </div>
                        </div><!-- END kalk-vehicle-form -->
                    </div><!-- END tabNew -->

                    <!-- Ausgew√§hltes Fahrzeug Anzeige (f√ºr beide Tabs) -->
                    <div class="kalk-selected-db-vehicle" id="selectedDbVehicle" style="display: none;">
                        <div class="kalk-selected-db-vehicle__header">
                            <span class="kalk-selected-db-vehicle__badge">Ausgew√§hlt</span>
                            <button class="btn btn-sm btn-secondary" onclick="clearSelectedVehicle()">
                                <i data-feather="x"></i> √Ñndern
                            </button>
                        </div>
                        <div class="kalk-selected-db-vehicle__info">
                            <div class="kalk-selected-db-vehicle__icon">üöó</div>
                            <div class="kalk-selected-db-vehicle__details">
                                <strong id="selectedVehicleName">-</strong>
                                <span id="selectedVehicleKennzeichen">-</span>
                                <span id="selectedVehicleKunde">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="kalk-step-actions">
                        <div></div>
                        <button class="btn btn-primary btn-lg" onclick="goToStep(2)" id="btnStep1Next">
                            Weiter zu Service-Art
                            <i data-feather="arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- STEP 2: SERVICE-ART W√ÑHLEN (12 Services) -->
            <!-- ============================================ -->
            <div class="kalk-step-content" id="stepContent2">
                <div class="content-card">
                    <div class="content-card__header">
                        <div class="content-card__title">
                            <i data-feather="grid"></i>
                            <h2>Schritt 2: Service-Art w√§hlen</h2>
                        </div>
                    </div>

                    <!-- üÜï AUFTRAGSINFO BOX f√ºr Step 2 (Nov 30, 2025) -->
                    <div class="auftrags-info-box" id="step2AuftragsInfo" style="display: none;">
                        <div class="auftrags-info-header">
                            <i data-feather="file-text"></i>
                            <strong>Auftragsinformationen</strong>
                            <button class="btn btn-sm btn-ghost" onclick="toggleAuftragsInfo('step2')" id="auftragsInfoToggle2">
                                <i data-feather="chevron-up"></i>
                            </button>
                        </div>
                        <div class="auftrags-info-content" id="auftragsInfoContent2">
                            <div class="auftrags-info-grid">
                                <!-- Fahrzeug -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">üöó Fahrzeug</div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Kennzeichen:</span>
                                        <span class="auftrags-info-value" id="info2Kennzeichen">-</span>
                                    </div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Fahrzeug:</span>
                                        <span class="auftrags-info-value" id="info2Fahrzeug">-</span>
                                    </div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Farbe:</span>
                                        <span class="auftrags-info-value" id="info2Farbe">-</span>
                                    </div>
                                </div>

                                <!-- Kunde -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">üë§ Kunde</div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Name:</span>
                                        <span class="auftrags-info-value" id="info2Kunde">-</span>
                                    </div>
                                    <div class="auftrags-info-row" id="info2PartnerRow" style="display: none;">
                                        <span class="auftrags-info-label">Partner:</span>
                                        <span class="auftrags-info-value" id="info2Partner">-</span>
                                    </div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Datum:</span>
                                        <span class="auftrags-info-value" id="info2Datum">-</span>
                                    </div>
                                </div>

                                <!-- Service -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">üîß Service</div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Service-Art:</span>
                                        <span class="auftrags-info-value" id="info2Service">-</span>
                                    </div>
                                    <div class="auftrags-info-row" id="info2DringlichkeitRow" style="display: none;">
                                        <span class="auftrags-info-label">Dringlichkeit:</span>
                                        <span class="auftrags-info-value" id="info2Dringlichkeit">-</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Schadensbeschreibung -->
                            <div class="auftrags-info-section auftrags-info-full" id="info2SchadenSection" style="display: none;">
                                <div class="auftrags-info-section-title">üìù Schadensbeschreibung</div>
                                <div class="auftrags-info-schaden" id="info2Schaden">-</div>
                            </div>

                            <!-- Notizen -->
                            <div class="auftrags-info-section auftrags-info-full" id="info2NotizenSection" style="display: none;">
                                <div class="auftrags-info-section-title">üìã Notizen</div>
                                <div class="auftrags-info-notizen" id="info2Notizen">-</div>
                            </div>

                            <!-- Service-Details pro Service -->
                            <div class="auftrags-info-section auftrags-info-full" id="info2ServiceDetailsSection" style="display: none;">
                                <div class="auftrags-info-section-title">üì¶ Service-Details</div>
                                <div class="auftrags-info-service-details" id="info2ServiceDetails">
                                    <!-- Dynamisch gef√ºllt -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="kalk-service-options">
                        <p class="kalk-service-hint">W√§hlen Sie die Art der Reparatur/Dienstleistung</p>

                        <div class="service-options-grid">
                            <!-- 1. Lackierung -->
                            <label class="service-option">
                                <input type="radio" name="serviceArt" value="lackier" onchange="updateServiceSelection()">
                                <div class="service-option__content">
                                    <span class="service-option__icon">üé®</span>
                                    <span class="service-option__label">Lackierung</span>
                                    <span class="service-option__desc">Lacksch√§den, Kratzer, Beulen</span>
                                </div>
                            </label>

                            <!-- 2. Versicherung (Unfall) -->
                            <label class="service-option">
                                <input type="radio" name="serviceArt" value="versicherung" onchange="updateServiceSelection()">
                                <div class="service-option__content">
                                    <span class="service-option__icon">üõ°Ô∏è</span>
                                    <span class="service-option__label">Versicherungsschaden</span>
                                    <span class="service-option__desc">Unfallreparatur, Gutachten</span>
                                </div>
                            </label>

                            <!-- 3. Dellen (Smart-Repair/PDR) -->
                            <label class="service-option">
                                <input type="radio" name="serviceArt" value="dellen" onchange="updateServiceSelection()">
                                <div class="service-option__content">
                                    <span class="service-option__icon">üî®</span>
                                    <span class="service-option__label">Dellendr√ºcken</span>
                                    <span class="service-option__desc">Smart-Repair, PDR, Hagel</span>
                                </div>
                            </label>

                            <!-- 4. Glas -->
                            <label class="service-option">
                                <input type="radio" name="serviceArt" value="glas" onchange="updateServiceSelection()">
                                <div class="service-option__content">
                                    <span class="service-option__icon">ü™ü</span>
                                    <span class="service-option__label">Glasreparatur</span>
                                    <span class="service-option__desc">Scheiben, Steinschlag</span>
                                </div>
                            </label>

                            <!-- 5. Reifen -->
                            <label class="service-option">
                                <input type="radio" name="serviceArt" value="reifen" onchange="updateServiceSelection()">
                                <div class="service-option__content">
                                    <span class="service-option__icon">üõû</span>
                                    <span class="service-option__label">Reifen-Service</span>
                                    <span class="service-option__desc">Reifenwechsel, Felgen</span>
                                </div>
                            </label>

                            <!-- 6. Mechanik -->
                            <label class="service-option">
                                <input type="radio" name="serviceArt" value="mechanik" onchange="updateServiceSelection()">
                                <div class="service-option__content">
                                    <span class="service-option__icon">üîß</span>
                                    <span class="service-option__label">Mechanik</span>
                                    <span class="service-option__desc">Reparaturen, Wartung</span>
                                </div>
                            </label>

                            <!-- 7. Pflege (Aufbereitung) -->
                            <label class="service-option">
                                <input type="radio" name="serviceArt" value="pflege" onchange="updateServiceSelection()">
                                <div class="service-option__content">
                                    <span class="service-option__icon">‚ú®</span>
                                    <span class="service-option__label">Fahrzeugpflege</span>
                                    <span class="service-option__desc">Aufbereitung, Politur</span>
                                </div>
                            </label>

                            <!-- 8. T√úV/AU -->
                            <label class="service-option">
                                <input type="radio" name="serviceArt" value="tuev" onchange="updateServiceSelection()">
                                <div class="service-option__content">
                                    <span class="service-option__icon">üìã</span>
                                    <span class="service-option__label">T√úV/AU</span>
                                    <span class="service-option__desc">Hauptuntersuchung</span>
                                </div>
                            </label>

                            <!-- 9. Klima -->
                            <label class="service-option">
                                <input type="radio" name="serviceArt" value="klima" onchange="updateServiceSelection()">
                                <div class="service-option__content">
                                    <span class="service-option__icon">‚ùÑÔ∏è</span>
                                    <span class="service-option__label">Klimaservice</span>
                                    <span class="service-option__desc">Klimaanlage, Wartung</span>
                                </div>
                            </label>

                            <!-- 10. Folierung -->
                            <label class="service-option">
                                <input type="radio" name="serviceArt" value="folierung" onchange="updateServiceSelection()">
                                <div class="service-option__content">
                                    <span class="service-option__icon">üåà</span>
                                    <span class="service-option__label">Folierung</span>
                                    <span class="service-option__desc">Car Wrapping, Design</span>
                                </div>
                            </label>

                            <!-- 11. Steinschutz -->
                            <label class="service-option">
                                <input type="radio" name="serviceArt" value="steinschutz" onchange="updateServiceSelection()">
                                <div class="service-option__content">
                                    <span class="service-option__icon">üõ°Ô∏è</span>
                                    <span class="service-option__label">Steinschutzfolie</span>
                                    <span class="service-option__desc">Lackschutz, PPF</span>
                                </div>
                            </label>

                            <!-- 12. Werbebeklebung -->
                            <label class="service-option">
                                <input type="radio" name="serviceArt" value="werbebeklebung" onchange="updateServiceSelection()">
                                <div class="service-option__content">
                                    <span class="service-option__icon">üì¢</span>
                                    <span class="service-option__label">Werbebeklebung</span>
                                    <span class="service-option__desc">Beschriftung, Logos</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="kalk-step-actions">
                        <button class="btn btn-secondary btn-lg" onclick="goToStep(1)">
                            <i data-feather="arrow-left"></i>
                            Zur√ºck
                        </button>
                        <button class="btn btn-primary btn-lg" onclick="goToStep2Next()" id="btnStep2Next" disabled>
                            Weiter
                            <i data-feather="arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- STEP 2b: SERVICE-DETAILS (Dynamisch generiert) -->
            <!-- ============================================ -->
            <div class="kalk-step-content" id="stepContent2b" style="display: none;">
                <div class="content-card">
                    <div class="content-card__header">
                        <div class="content-card__title">
                            <i data-feather="settings"></i>
                            <h2>Schritt 2b: <span id="step2bServiceName">Service</span>-Details</h2>
                        </div>
                    </div>

                    <!-- üÜï AUFTRAGSINFO BOX f√ºr Step 2b (Nov 30, 2025) -->
                    <div class="auftrags-info-box" id="step2bAuftragsInfo" style="display: none;">
                        <div class="auftrags-info-header">
                            <i data-feather="file-text"></i>
                            <strong>Auftragsinformationen</strong>
                            <button class="btn btn-sm btn-ghost" onclick="toggleAuftragsInfo('step2b')" id="auftragsInfoToggle2b">
                                <i data-feather="chevron-up"></i>
                            </button>
                        </div>
                        <div class="auftrags-info-content" id="auftragsInfoContent2b">
                            <div class="auftrags-info-grid">
                                <!-- Fahrzeug -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">üöó Fahrzeug</div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Kennzeichen:</span>
                                        <span class="auftrags-info-value" id="info2bKennzeichen">-</span>
                                    </div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Fahrzeug:</span>
                                        <span class="auftrags-info-value" id="info2bFahrzeug">-</span>
                                    </div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Farbe:</span>
                                        <span class="auftrags-info-value" id="info2bFarbe">-</span>
                                    </div>
                                    <div class="auftrags-info-row" id="info2bKmStandRow">
                                        <span class="auftrags-info-label">KM-Stand:</span>
                                        <span class="auftrags-info-value" id="info2bKmStand">-</span>
                                    </div>
                                </div>

                                <!-- Kunde -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">üë§ Kunde</div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Name:</span>
                                        <span class="auftrags-info-value" id="info2bKunde">-</span>
                                    </div>
                                    <div class="auftrags-info-row" id="info2bPartnerRow" style="display: none;">
                                        <span class="auftrags-info-label">Partner:</span>
                                        <span class="auftrags-info-value" id="info2bPartner">-</span>
                                    </div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Datum:</span>
                                        <span class="auftrags-info-value" id="info2bDatum">-</span>
                                    </div>
                                </div>

                                <!-- Service -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">üîß Service</div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Service-Art:</span>
                                        <span class="auftrags-info-value" id="info2bService">-</span>
                                    </div>
                                    <div class="auftrags-info-row" id="info2bDringlichkeitRow" style="display: none;">
                                        <span class="auftrags-info-label">Dringlichkeit:</span>
                                        <span class="auftrags-info-value" id="info2bDringlichkeit">-</span>
                                    </div>
                                </div>

                                <!-- üÜï Termine (Nov 30, 2025) - Meister braucht diese Infos -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">üìÖ Termine</div>
                                    <div class="auftrags-info-row" id="info2bAnlieferterminRow">
                                        <span class="auftrags-info-label">Anlieferung:</span>
                                        <span class="auftrags-info-value" id="info2bAnliefertermin">-</span>
                                    </div>
                                    <div class="auftrags-info-row" id="info2bAbholterminRow">
                                        <span class="auftrags-info-label">Abholung:</span>
                                        <span class="auftrags-info-value" id="info2bAbholtermin">-</span>
                                    </div>
                                    <div class="auftrags-info-row" id="info2bErsatzfahrzeugRow">
                                        <span class="auftrags-info-label">Ersatzfahrzeug:</span>
                                        <span class="auftrags-info-value" id="info2bErsatzfahrzeug">-</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Schadensbeschreibung -->
                            <div class="auftrags-info-section auftrags-info-full" id="info2bSchadenSection" style="display: none;">
                                <div class="auftrags-info-section-title">üìù Schadensbeschreibung</div>
                                <div class="auftrags-info-schaden" id="info2bSchaden">-</div>
                            </div>

                            <!-- Notizen -->
                            <div class="auftrags-info-section auftrags-info-full" id="info2bNotizenSection" style="display: none;">
                                <div class="auftrags-info-section-title">üìã Notizen</div>
                                <div class="auftrags-info-notizen" id="info2bNotizen">-</div>
                            </div>

                            <!-- Service-Details pro Service -->
                            <div class="auftrags-info-section auftrags-info-full" id="info2bServiceDetailsSection" style="display: none;">
                                <div class="auftrags-info-section-title">üì¶ Service-Details</div>
                                <div class="auftrags-info-service-details" id="info2bServiceDetails">
                                    <!-- Dynamisch gef√ºllt -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- üÜï Fotos aus Entwurf/Annahme f√ºr Step 2b (Nov 30, 2025) -->
                    <div class="entwurf-photos-section" id="step2bPhotosSection" style="display: none;">
                        <div class="entwurf-photos-header">
                            <i data-feather="camera"></i>
                            <span>Fotos aus der Annahme</span>
                            <button class="btn btn-sm btn-secondary" onclick="togglePhotoGallery('step2b')">
                                <i data-feather="maximize-2"></i> Vollbild
                            </button>
                        </div>
                        <div class="entwurf-photos-gallery" id="step2bPhotosGallery">
                            <!-- Dynamisch gef√ºllt -->
                        </div>
                    </div>

                    <!-- Dynamisch generierte Zusatzfelder -->
                    <div class="service-details-form" id="serviceDetailsForm">
                        <!-- Wird dynamisch bef√ºllt durch renderServiceDetails() -->
                    </div>

                    <!-- Design-Upload Preview (f√ºr Folierung/Werbebeklebung) -->
                    <div class="design-upload-preview" id="designUploadPreview" style="display: none;">
                        <div class="design-preview-header">
                            <i data-feather="image"></i>
                            <strong>Hochgeladene Designs</strong>
                        </div>
                        <div class="design-preview-grid" id="designPreviewGrid">
                            <!-- Wird dynamisch bef√ºllt -->
                        </div>
                    </div>

                    <div class="kalk-step-actions">
                        <button class="btn btn-secondary btn-lg" onclick="goToStep2bBack()">
                            <i data-feather="arrow-left"></i>
                            Zur√ºck
                        </button>
                        <button class="btn btn-primary btn-lg" onclick="goToStep2bNext()" id="btnStep2bNext">
                            Weiter
                            <i data-feather="arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- STEP 3: TEIL AUSW√ÑHLEN -->
            <!-- ============================================ -->
            <div class="kalk-step-content" id="stepContent3">
                <div class="content-card">
                    <div class="content-card__header">
                        <div class="content-card__title">
                            <i data-feather="crosshair"></i>
                            <h2>Schritt 3: Besch√§digtes Teil w√§hlen</h2>
                        </div>
                    </div>

                    <!-- üÜï AUFTRAGSINFO BOX - Alle Infos aus Entwurf/Anfrage -->
                    <div class="auftrags-info-box" id="step3AuftragsInfo" style="display: none;">
                        <div class="auftrags-info-header">
                            <i data-feather="file-text"></i>
                            <strong>Auftragsinformationen</strong>
                            <button class="btn btn-sm btn-ghost" onclick="toggleAuftragsInfo()" id="auftragsInfoToggle">
                                <i data-feather="chevron-up"></i>
                            </button>
                        </div>
                        <div class="auftrags-info-content" id="auftragsInfoContent">
                            <div class="auftrags-info-grid">
                                <!-- Fahrzeug -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">üöó Fahrzeug</div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Kennzeichen:</span>
                                        <span class="auftrags-info-value" id="infoKennzeichen">-</span>
                                    </div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Fahrzeug:</span>
                                        <span class="auftrags-info-value" id="infoFahrzeug">-</span>
                                    </div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Farbe:</span>
                                        <span class="auftrags-info-value" id="infoFarbe">-</span>
                                    </div>
                                </div>

                                <!-- Kunde -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">üë§ Kunde</div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Name:</span>
                                        <span class="auftrags-info-value" id="infoKunde">-</span>
                                    </div>
                                    <div class="auftrags-info-row" id="infoPartnerRow" style="display: none;">
                                        <span class="auftrags-info-label">Partner:</span>
                                        <span class="auftrags-info-value" id="infoPartner">-</span>
                                    </div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Datum:</span>
                                        <span class="auftrags-info-value" id="infoDatum">-</span>
                                    </div>
                                </div>

                                <!-- Service -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">üîß Service</div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Service-Art:</span>
                                        <span class="auftrags-info-value" id="infoService">-</span>
                                    </div>
                                    <div class="auftrags-info-row" id="infoDringlichkeitRow" style="display: none;">
                                        <span class="auftrags-info-label">Dringlichkeit:</span>
                                        <span class="auftrags-info-value" id="infoDringlichkeit">-</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Schadensbeschreibung -->
                            <div class="auftrags-info-section auftrags-info-full" id="infoSchadenSection" style="display: none;">
                                <div class="auftrags-info-section-title">üìù Schadensbeschreibung</div>
                                <div class="auftrags-info-schaden" id="infoSchaden">-</div>
                            </div>

                            <!-- Notizen -->
                            <div class="auftrags-info-section auftrags-info-full" id="infoNotizenSection" style="display: none;">
                                <div class="auftrags-info-section-title">üìã Notizen</div>
                                <div class="auftrags-info-notizen" id="infoNotizen">-</div>
                            </div>

                            <!-- üÜï Service-Details pro Service (Nov 30, 2025) -->
                            <div class="auftrags-info-section auftrags-info-full" id="infoServiceDetailsSection" style="display: none;">
                                <div class="auftrags-info-section-title">üì¶ Service-Details</div>
                                <div class="auftrags-info-service-details" id="infoServiceDetails">
                                    <!-- Dynamisch gef√ºllt -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- üÜï Fotos aus Entwurf/Annahme -->
                    <div class="entwurf-photos-section" id="step3PhotosSection" style="display: none;">
                        <div class="entwurf-photos-header">
                            <i data-feather="camera"></i>
                            <span>Fotos aus der Annahme</span>
                            <button class="btn btn-sm btn-secondary" onclick="togglePhotoGallery('step3')">
                                <i data-feather="maximize-2"></i> Vollbild
                            </button>
                        </div>
                        <div class="entwurf-photos-gallery" id="step3PhotosGallery">
                            <!-- Dynamisch gef√ºllt -->
                        </div>
                    </div>

                    <!-- üÜï MULTI-SERVICE TABS (Nov 30, 2025) -->
                    <div id="step3ServiceTabs" class="service-tabs-container" style="display: none;">
                        <div class="service-tabs-header">
                            <span class="service-tabs-label">Services:</span>
                            <div class="service-tabs" id="step3ServiceTabsInner">
                                <!-- Dynamisch generiert -->
                            </div>
                        </div>
                        <div class="service-tabs-info">
                            <i data-feather="info"></i>
                            <span>W√§hlen Sie Teile f√ºr jeden Service separat. Aktiver Service: <strong id="step3ActiveServiceName">-</strong></span>
                        </div>
                    </div>

                    <!-- Ansicht-Umschalter -->
                    <div class="view-toggle" style="margin: var(--space-4) 0; display: flex; justify-content: center; gap: var(--space-2); flex-wrap: wrap;">
                        <button class="view-toggle-btn" data-view="list" onclick="switchVehicleView('list')">
                            <i data-feather="list"></i> Service-Teile
                        </button>
                        <button class="view-toggle-btn active" data-view="2d" onclick="switchVehicleView('2d')">
                            <i data-feather="layout"></i> 2D Draufsicht
                        </button>
                        <button class="view-toggle-btn" data-view="3d" onclick="switchVehicleView('3d')">
                            <i data-feather="box"></i> 3D Modell
                        </button>
                        <button class="view-toggle-btn" data-view="foto" onclick="switchVehicleView('foto')" style="background: linear-gradient(135deg, var(--color-primary), #9333ea);">
                            <i data-feather="camera"></i> KI Foto-Analyse
                        </button>
                    </div>

                    <!-- Service-spezifische Teile-Liste (NEU) -->
                    <div id="vehicleListView" class="service-parts-list" style="display: none;">
                        <p class="service-parts-hint" style="text-align: center; margin-bottom: var(--space-4); color: var(--color-text-secondary);">
                            W√§hlen Sie das betroffene Teil f√ºr <strong id="listServiceName">-</strong>:
                        </p>
                        <div id="servicePartsGrid" class="service-parts-grid">
                            <!-- Dynamisch generiert basierend auf SERVICE_CONFIG -->
                        </div>
                    </div>

                    <!-- 3D Sketchfab Viewer (versteckt by default) -->
                    <div id="vehicle3DView" class="vehicle-3d-container" style="display: none;">

                        <!-- Fahrzeugtyp-Auswahl -->
                        <div class="vehicle-type-selector" style="display: flex; justify-content: center; gap: var(--space-2); margin-bottom: var(--space-4); flex-wrap: wrap;">
                            <button class="vehicle-type-btn active" data-type="sedan" onclick="changeVehicleType('sedan')">
                                üöó Limousine
                            </button>
                            <button class="vehicle-type-btn" data-type="suv" onclick="changeVehicleType('suv')">
                                üöô SUV
                            </button>
                            <button class="vehicle-type-btn" data-type="transporter" onclick="changeVehicleType('transporter')">
                                üöê Transporter
                            </button>
                            <button class="vehicle-type-btn" data-type="kombi" onclick="changeVehicleType('kombi')">
                                üöï Kombi
                            </button>
                            <div class="ai-model-dropdown" style="position: relative; display: inline-block;">
                                <button class="vehicle-type-btn ai-btn" onclick="toggleAIDropdown()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-color: transparent; color: white;">
                                    ü§ñ KI-Modell
                                </button>
                                <div id="aiDropdown" class="ai-dropdown-content" style="display: none; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); background: var(--color-surface-elevated); border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--space-3); margin-top: var(--space-2); min-width: 280px; box-shadow: var(--shadow-lg); z-index: 100;">
                                    <p style="font-size: var(--font-size-xs); color: var(--color-text-secondary); margin: 0 0 var(--space-3) 0; text-align: center;">
                                        Erstelle 3D-Modelle aus Fotos mit KI:
                                    </p>
                                    <a href="https://huggingface.co/spaces/alexnasa/PartCrafter" target="_blank" class="ai-link" style="display: block; padding: var(--space-2); border-radius: var(--radius-sm); text-decoration: none; color: var(--color-text-primary); background: rgba(var(--color-primary-rgb), 0.1); margin-bottom: var(--space-2); font-size: var(--font-size-sm);">
                                        <strong>PartCrafter</strong> (MIT) - 4-16 separate Teile aus 1 Foto
                                    </a>
                                    <a href="https://huggingface.co/spaces/tencent/Hunyuan3D-Part" target="_blank" class="ai-link" style="display: block; padding: var(--space-2); border-radius: var(--radius-sm); text-decoration: none; color: var(--color-text-primary); background: rgba(var(--color-primary-rgb), 0.1); margin-bottom: var(--space-2); font-size: var(--font-size-sm);">
                                        <strong>Hunyuan3D-Part</strong> (Tencent) - Teile-Segmentierung
                                    </a>
                                    <a href="https://www.meshy.ai/" target="_blank" class="ai-link" style="display: block; padding: var(--space-2); border-radius: var(--radius-sm); text-decoration: none; color: var(--color-text-primary); background: rgba(var(--color-primary-rgb), 0.1); font-size: var(--font-size-sm);">
                                        <strong>Meshy AI</strong> (Free-Tier) - Schnelle 3D-Generierung
                                    </a>
                                </div>
                            </div>
                        </div>

                        <div class="sketchfab-embed-wrapper">
                            <!-- Sketchfab Viewer API Container -->
                            <div id="sketchfabApiContainer" style="width: 100%; height: 450px; border-radius: var(--radius-card); overflow: hidden; background: var(--color-surface-elevated); position: relative;">
                                <div id="sketchfabLoading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                                    <div class="spinner" style="width: 40px; height: 40px; border: 3px solid var(--color-border); border-top-color: var(--color-primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px;"></div>
                                    <p style="color: var(--color-text-secondary); font-size: var(--font-size-sm);">3D-Modell wird geladen...</p>
                                </div>
                            </div>
                            <p id="sketchfabCredit" class="sketchfab-credit" style="font-size: 11px; color: var(--color-text-secondary); text-align: center; margin-top: var(--space-2);">
                                3D-Modell: <a id="modelLink" href="https://sketchfab.com/3d-models/generic-sedan-car-58c33766470d46e7b2aed542650494e5" target="_blank" style="color: var(--color-primary);">Generic Sedan Car</a> von <span id="modelAuthor">MMC Works</span> (CC BY)
                            </p>
                        </div>

                        <!-- Klick-Hinweis -->
                        <div id="clickHint" style="text-align: center; margin: var(--space-4) 0; padding: var(--space-3); background: rgba(var(--color-primary-rgb), 0.1); border-radius: var(--radius-md); display: none;">
                            <p style="margin: 0; font-size: var(--font-size-sm); color: var(--color-primary);">
                                <i data-feather="mouse-pointer" style="width: 14px; height: 14px; vertical-align: middle;"></i>
                                <strong>Tipp:</strong> Klicken Sie direkt auf das 3D-Modell, um ein Teil auszuw√§hlen!
                            </p>
                        </div>

                        <!-- Geklicktes Teil Anzeige -->
                        <div id="clickedPartInfo" style="display: none; text-align: center; margin-bottom: var(--space-4); padding: var(--space-3); background: var(--color-success-bg); border: 1px solid var(--color-success); border-radius: var(--radius-md);">
                            <p style="margin: 0; font-size: var(--font-size-sm); color: var(--color-success);">
                                <i data-feather="check-circle" style="width: 14px; height: 14px; vertical-align: middle;"></i>
                                Ausgew√§hlt: <strong id="clickedPartName">-</strong>
                            </p>
                        </div>

                        <!-- 3D Teil-Auswahl Buttons (Fallback) -->
                        <div class="part-buttons-3d" style="display: flex; flex-wrap: wrap; gap: var(--space-2); justify-content: center; margin-top: var(--space-4);">
                            <span style="width: 100%; text-align: center; font-size: var(--font-size-xs); color: var(--color-text-secondary); margin-bottom: var(--space-2);">Oder w√§hlen Sie manuell:</span>
                            <button class="part-btn-3d" onclick="select3DPart('Sto√üf√§nger vorne')">Sto√üf√§nger V</button>
                            <button class="part-btn-3d" onclick="select3DPart('Motorhaube')">Motorhaube</button>
                            <button class="part-btn-3d" onclick="select3DPart('Kotfl√ºgel vorne links')">Kotfl√ºgel VL</button>
                            <button class="part-btn-3d" onclick="select3DPart('Kotfl√ºgel vorne rechts')">Kotfl√ºgel VR</button>
                            <button class="part-btn-3d" onclick="select3DPart('T√ºr vorne links')">T√ºr VL</button>
                            <button class="part-btn-3d" onclick="select3DPart('T√ºr vorne rechts')">T√ºr VR</button>
                            <button class="part-btn-3d" onclick="select3DPart('T√ºr hinten links')">T√ºr HL</button>
                            <button class="part-btn-3d" onclick="select3DPart('T√ºr hinten rechts')">T√ºr HR</button>
                            <button class="part-btn-3d" onclick="select3DPart('Dach')">Dach</button>
                            <button class="part-btn-3d" onclick="select3DPart('Heckklappe')">Heckklappe</button>
                            <button class="part-btn-3d" onclick="select3DPart('Sto√üf√§nger hinten')">Sto√üf√§nger H</button>
                            <button class="part-btn-3d" onclick="select3DPart('Seitenteil links')">Seitenteil L</button>
                            <button class="part-btn-3d" onclick="select3DPart('Seitenteil rechts')">Seitenteil R</button>
                        </div>
                    </div>

                    <!-- 2D SVG Diagramm (default sichtbar) -->
                    <div id="vehicle2DView" class="vehicle-diagram">
                        <svg class="vehicle-svg" viewBox="0 0 520 340" preserveAspectRatio="xMidYMid meet">
                            <!-- ================================================== -->
                            <!-- DETAILLIERTE 2D DRAUFSICHT - Limousine/Kombi       -->
                            <!-- ================================================== -->

                            <defs>
                                <!-- Gradient f√ºr Scheiben -->
                                <linearGradient id="glassGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#87CEEB;stop-opacity:0.6"/>
                                    <stop offset="100%" style="stop-color:#4682B4;stop-opacity:0.4"/>
                                </linearGradient>
                                <!-- Gradient f√ºr Reifen -->
                                <radialGradient id="tireGradient" cx="50%" cy="50%" r="50%">
                                    <stop offset="0%" style="stop-color:#555"/>
                                    <stop offset="70%" style="stop-color:#333"/>
                                    <stop offset="100%" style="stop-color:#1a1a1a"/>
                                </radialGradient>
                                <!-- Gradient f√ºr Felgen -->
                                <radialGradient id="rimGradient" cx="50%" cy="50%" r="50%">
                                    <stop offset="0%" style="stop-color:#e8e8e8"/>
                                    <stop offset="100%" style="stop-color:#a0a0a0"/>
                                </radialGradient>
                                <!-- Schatten -->
                                <filter id="dropShadow" x="-20%" y="-20%" width="140%" height="140%">
                                    <feGaussianBlur in="SourceAlpha" stdDeviation="3"/>
                                    <feOffset dx="2" dy="2" result="offsetblur"/>
                                    <feComponentTransfer>
                                        <feFuncA type="linear" slope="0.3"/>
                                    </feComponentTransfer>
                                    <feMerge>
                                        <feMergeNode/>
                                        <feMergeNode in="SourceGraphic"/>
                                    </feMerge>
                                </filter>
                            </defs>

                            <!-- Hintergrund mit Schatten des Fahrzeugs -->
                            <ellipse cx="250" cy="165" rx="180" ry="130" fill="rgba(0,0,0,0.08)" filter="url(#dropShadow)"/>

                            <!-- ========== R√ÑDER / REIFEN ========== -->

                            <!-- Rad vorne links (au√üen sichtbar) -->
                            <g class="vehicle-part vehicle-part--wheel" id="part-rad-vl" data-part="Rad vorne links" data-keywords="rad,reifen,felge,vorne,links">
                                <ellipse cx="95" cy="85" rx="28" ry="20" fill="url(#tireGradient)" stroke="#222" stroke-width="2"/>
                                <ellipse cx="95" cy="85" rx="16" ry="11" fill="url(#rimGradient)" stroke="#888" stroke-width="1"/>
                                <circle cx="95" cy="85" r="4" fill="#666"/>
                                <!-- Felgen-Speichen -->
                                <line x1="95" y1="74" x2="95" y2="96" stroke="#999" stroke-width="1.5"/>
                                <line x1="81" y1="85" x2="109" y2="85" stroke="#999" stroke-width="1.5"/>
                            </g>

                            <!-- Rad vorne rechts -->
                            <g class="vehicle-part vehicle-part--wheel" id="part-rad-vr" data-part="Rad vorne rechts" data-keywords="rad,reifen,felge,vorne,rechts">
                                <ellipse cx="405" cy="85" rx="28" ry="20" fill="url(#tireGradient)" stroke="#222" stroke-width="2"/>
                                <ellipse cx="405" cy="85" rx="16" ry="11" fill="url(#rimGradient)" stroke="#888" stroke-width="1"/>
                                <circle cx="405" cy="85" r="4" fill="#666"/>
                                <line x1="405" y1="74" x2="405" y2="96" stroke="#999" stroke-width="1.5"/>
                                <line x1="391" y1="85" x2="419" y2="85" stroke="#999" stroke-width="1.5"/>
                            </g>

                            <!-- Rad hinten links -->
                            <g class="vehicle-part vehicle-part--wheel" id="part-rad-hl" data-part="Rad hinten links" data-keywords="rad,reifen,felge,hinten,links">
                                <ellipse cx="95" cy="245" rx="28" ry="20" fill="url(#tireGradient)" stroke="#222" stroke-width="2"/>
                                <ellipse cx="95" cy="245" rx="16" ry="11" fill="url(#rimGradient)" stroke="#888" stroke-width="1"/>
                                <circle cx="95" cy="245" r="4" fill="#666"/>
                                <line x1="95" y1="234" x2="95" y2="256" stroke="#999" stroke-width="1.5"/>
                                <line x1="81" y1="245" x2="109" y2="245" stroke="#999" stroke-width="1.5"/>
                            </g>

                            <!-- Rad hinten rechts -->
                            <g class="vehicle-part vehicle-part--wheel" id="part-rad-hr" data-part="Rad hinten rechts" data-keywords="rad,reifen,felge,hinten,rechts">
                                <ellipse cx="405" cy="245" rx="28" ry="20" fill="url(#tireGradient)" stroke="#222" stroke-width="2"/>
                                <ellipse cx="405" cy="245" rx="16" ry="11" fill="url(#rimGradient)" stroke="#888" stroke-width="1"/>
                                <circle cx="405" cy="245" r="4" fill="#666"/>
                                <line x1="405" y1="234" x2="405" y2="256" stroke="#999" stroke-width="1.5"/>
                                <line x1="391" y1="245" x2="419" y2="245" stroke="#999" stroke-width="1.5"/>
                            </g>

                            <!-- ========== KAROSSERIE OUTLINE ========== -->

                            <!-- Fahrzeug-Grundform (Schatten/Kontur) -->
                            <path class="vehicle-body-outline"
                                  d="M 130,25
                                     Q 145,18 250,18 Q 355,18 370,25
                                     L 385,35 Q 400,45 410,65 L 420,95
                                     L 422,115 L 422,215 L 420,235
                                     Q 410,285 385,295 L 370,305
                                     Q 355,312 250,312 Q 145,312 130,305
                                     L 115,295 Q 90,285 80,235
                                     L 78,215 L 78,115 L 80,95
                                     Q 90,45 115,35 Z"
                                  fill="none" stroke="var(--color-border)" stroke-width="1" opacity="0.5"/>

                            <!-- ========== STO√üF√ÑNGER VORNE ========== -->
                            <path class="vehicle-part" id="part-stossfaenger-vorne"
                                  d="M 130,25 Q 145,18 250,18 Q 355,18 370,25 L 385,35 Q 395,42 400,55 L 100,55 Q 105,42 115,35 Z"
                                  data-part="Sto√üf√§nger vorne" data-keywords="stossfaenger,vorne,front,bumper"/>
                            <text class="vehicle-part-label" x="250" y="40">Sto√üf√§nger vorne</text>

                            <!-- K√ºhlergrill -->
                            <rect x="175" y="28" width="150" height="12" rx="3" fill="rgba(0,0,0,0.2)" stroke="none"/>
                            <line x1="200" y1="28" x2="200" y2="40" stroke="rgba(0,0,0,0.3)" stroke-width="1"/>
                            <line x1="225" y1="28" x2="225" y2="40" stroke="rgba(0,0,0,0.3)" stroke-width="1"/>
                            <line x1="250" y1="28" x2="250" y2="40" stroke="rgba(0,0,0,0.3)" stroke-width="1"/>
                            <line x1="275" y1="28" x2="275" y2="40" stroke="rgba(0,0,0,0.3)" stroke-width="1"/>
                            <line x1="300" y1="28" x2="300" y2="40" stroke="rgba(0,0,0,0.3)" stroke-width="1"/>

                            <!-- Scheinwerfer vorne links -->
                            <path class="vehicle-part vehicle-part--light" id="part-scheinwerfer-vl"
                                  d="M 105,42 Q 115,35 130,35 L 145,42 L 145,55 L 105,55 Z"
                                  data-part="Scheinwerfer vorne links" data-keywords="scheinwerfer,licht,vorne,links"/>
                            <ellipse cx="125" cy="48" rx="12" ry="5" fill="rgba(255,255,200,0.6)" stroke="rgba(0,0,0,0.2)"/>

                            <!-- Scheinwerfer vorne rechts -->
                            <path class="vehicle-part vehicle-part--light" id="part-scheinwerfer-vr"
                                  d="M 355,55 L 355,42 L 370,35 Q 385,35 395,42 L 395,55 Z"
                                  data-part="Scheinwerfer vorne rechts" data-keywords="scheinwerfer,licht,vorne,rechts"/>
                            <ellipse cx="375" cy="48" rx="12" ry="5" fill="rgba(255,255,200,0.6)" stroke="rgba(0,0,0,0.2)"/>

                            <!-- ========== MOTORHAUBE ========== -->
                            <path class="vehicle-part" id="part-motorhaube"
                                  d="M 100,55 L 400,55 Q 408,55 415,70 L 420,95 L 80,95 L 85,70 Q 92,55 100,55 Z"
                                  data-part="Motorhaube" data-keywords="motorhaube,haube,hood,motor"/>
                            <text class="vehicle-part-label" x="250" y="78">Motorhaube</text>
                            <!-- Motorhauben-Kontur -->
                            <line x1="250" y1="58" x2="250" y2="92" stroke="rgba(0,0,0,0.1)" stroke-width="1"/>

                            <!-- ========== KOTFL√úGEL VORNE ========== -->

                            <!-- Kotfl√ºgel vorne links -->
                            <path class="vehicle-part" id="part-kotfluegel-vl"
                                  d="M 80,55 L 100,55 Q 92,55 85,70 L 80,95 L 78,115 L 68,115
                                     Q 60,105 60,85 Q 60,65 68,55 Z"
                                  data-part="Kotfl√ºgel vorne links" data-keywords="kotfluegel,vorne,links,fender"/>
                            <text class="vehicle-part-label" x="78" y="88" style="font-size: 9px;">KF VL</text>

                            <!-- Kotfl√ºgel vorne rechts -->
                            <path class="vehicle-part" id="part-kotfluegel-vr"
                                  d="M 400,55 L 420,55 Q 432,55 440,65 Q 440,85 440,105 L 432,115 L 422,115
                                     L 420,95 L 415,70 Q 408,55 400,55 Z"
                                  data-part="Kotfl√ºgel vorne rechts" data-keywords="kotfluegel,vorne,rechts,fender"/>
                            <text class="vehicle-part-label" x="422" y="88" style="font-size: 9px;">KF VR</text>

                            <!-- ========== A-S√ÑULEN ========== -->

                            <!-- A-S√§ule links -->
                            <path class="vehicle-part vehicle-part--pillar" id="part-a-saeule-l"
                                  d="M 78,95 L 105,95 L 115,115 L 78,115 Z"
                                  data-part="A-S√§ule links" data-keywords="saeule,a-saeule,links,pillar"/>

                            <!-- A-S√§ule rechts -->
                            <path class="vehicle-part vehicle-part--pillar" id="part-a-saeule-r"
                                  d="M 395,95 L 422,95 L 422,115 L 385,115 Z"
                                  data-part="A-S√§ule rechts" data-keywords="saeule,a-saeule,rechts,pillar"/>

                            <!-- ========== FRONTSCHEIBE ========== -->
                            <path class="vehicle-part vehicle-part--glass" id="part-frontscheibe"
                                  d="M 115,95 L 385,95 L 385,115 L 360,130 L 140,130 L 115,115 Z"
                                  data-part="Frontscheibe" data-keywords="frontscheibe,windschutzscheibe,scheibe,glas"/>
                            <text class="vehicle-part-label vehicle-part-label--glass" x="250" y="115">Frontscheibe</text>

                            <!-- ========== T√úREN VORNE ========== -->

                            <!-- T√ºr vorne links -->
                            <path class="vehicle-part" id="part-tuer-vl"
                                  d="M 68,115 L 115,115 L 140,130 L 140,175 L 68,175 Z"
                                  data-part="T√ºr vorne links" data-keywords="tuer,vorne,links,fahrer,door"/>
                            <text class="vehicle-part-label" x="100" y="150" style="font-size: 10px;">T√ºr VL</text>
                            <!-- T√ºrgriff -->
                            <rect x="100" y="155" width="25" height="6" rx="2" fill="rgba(0,0,0,0.15)"/>

                            <!-- T√ºr vorne rechts -->
                            <path class="vehicle-part" id="part-tuer-vr"
                                  d="M 385,115 L 432,115 L 432,175 L 360,175 L 360,130 Z"
                                  data-part="T√ºr vorne rechts" data-keywords="tuer,vorne,rechts,beifahrer,door"/>
                            <text class="vehicle-part-label" x="400" y="150" style="font-size: 10px;">T√ºr VR</text>
                            <!-- T√ºrgriff -->
                            <rect x="375" y="155" width="25" height="6" rx="2" fill="rgba(0,0,0,0.15)"/>

                            <!-- ========== SEITENSCHEIBEN VORNE ========== -->

                            <!-- Seitenscheibe vorne links -->
                            <path class="vehicle-part vehicle-part--glass" id="part-seitenscheibe-vl"
                                  d="M 78,118 L 112,118 L 137,132 L 137,165 L 78,165 Z"
                                  data-part="Seitenscheibe vorne links" data-keywords="seitenscheibe,scheibe,vorne,links,glas"/>

                            <!-- Seitenscheibe vorne rechts -->
                            <path class="vehicle-part vehicle-part--glass" id="part-seitenscheibe-vr"
                                  d="M 388,118 L 422,118 L 422,165 L 363,165 L 363,132 Z"
                                  data-part="Seitenscheibe vorne rechts" data-keywords="seitenscheibe,scheibe,vorne,rechts,glas"/>

                            <!-- ========== SPIEGEL ========== -->

                            <!-- Seitenspiegel links -->
                            <g class="vehicle-part" id="part-spiegel-l" data-part="Seitenspiegel links" data-keywords="spiegel,aussenspiegel,links,mirror">
                                <ellipse cx="55" cy="125" rx="14" ry="10" fill="var(--color-surface)" stroke="var(--color-border)" stroke-width="1.5"/>
                                <ellipse cx="55" cy="125" rx="10" ry="7" fill="url(#glassGradient)"/>
                            </g>

                            <!-- Seitenspiegel rechts -->
                            <g class="vehicle-part" id="part-spiegel-r" data-part="Seitenspiegel rechts" data-keywords="spiegel,aussenspiegel,rechts,mirror">
                                <ellipse cx="445" cy="125" rx="14" ry="10" fill="var(--color-surface)" stroke="var(--color-border)" stroke-width="1.5"/>
                                <ellipse cx="445" cy="125" rx="10" ry="7" fill="url(#glassGradient)"/>
                            </g>

                            <!-- ========== B-S√ÑULEN ========== -->

                            <!-- B-S√§ule links -->
                            <path class="vehicle-part vehicle-part--pillar" id="part-b-saeule-l"
                                  d="M 68,175 L 140,175 L 140,185 L 68,185 Z"
                                  data-part="B-S√§ule links" data-keywords="saeule,b-saeule,links,pillar"/>

                            <!-- B-S√§ule rechts -->
                            <path class="vehicle-part vehicle-part--pillar" id="part-b-saeule-r"
                                  d="M 360,175 L 432,175 L 432,185 L 360,185 Z"
                                  data-part="B-S√§ule rechts" data-keywords="saeule,b-saeule,rechts,pillar"/>

                            <!-- ========== T√úREN HINTEN ========== -->

                            <!-- T√ºr hinten links -->
                            <path class="vehicle-part" id="part-tuer-hl"
                                  d="M 68,185 L 140,185 L 140,230 L 68,230 Z"
                                  data-part="T√ºr hinten links" data-keywords="tuer,hinten,links,fond,door"/>
                            <text class="vehicle-part-label" x="100" y="212" style="font-size: 10px;">T√ºr HL</text>
                            <!-- T√ºrgriff -->
                            <rect x="100" y="200" width="25" height="6" rx="2" fill="rgba(0,0,0,0.15)"/>

                            <!-- T√ºr hinten rechts -->
                            <path class="vehicle-part" id="part-tuer-hr"
                                  d="M 360,185 L 432,185 L 432,230 L 360,230 Z"
                                  data-part="T√ºr hinten rechts" data-keywords="tuer,hinten,rechts,fond,door"/>
                            <text class="vehicle-part-label" x="400" y="212" style="font-size: 10px;">T√ºr HR</text>
                            <!-- T√ºrgriff -->
                            <rect x="375" y="200" width="25" height="6" rx="2" fill="rgba(0,0,0,0.15)"/>

                            <!-- ========== SEITENSCHEIBEN HINTEN ========== -->

                            <!-- Seitenscheibe hinten links -->
                            <path class="vehicle-part vehicle-part--glass" id="part-seitenscheibe-hl"
                                  d="M 78,188 L 137,188 L 137,225 L 78,225 Z"
                                  data-part="Seitenscheibe hinten links" data-keywords="seitenscheibe,scheibe,hinten,links,glas"/>

                            <!-- Seitenscheibe hinten rechts -->
                            <path class="vehicle-part vehicle-part--glass" id="part-seitenscheibe-hr"
                                  d="M 363,188 L 422,188 L 422,225 L 363,225 Z"
                                  data-part="Seitenscheibe hinten rechts" data-keywords="seitenscheibe,scheibe,hinten,rechts,glas"/>

                            <!-- ========== DACH ========== -->
                            <path class="vehicle-part" id="part-dach"
                                  d="M 140,130 L 360,130 L 360,230 L 140,230 Z"
                                  data-part="Dach" data-keywords="dach,roof,panorama"/>
                            <text class="vehicle-part-label" x="250" y="183">Dach</text>
                            <!-- Dachreling (optional) -->
                            <line x1="145" y1="135" x2="145" y2="225" stroke="rgba(0,0,0,0.1)" stroke-width="3"/>
                            <line x1="355" y1="135" x2="355" y2="225" stroke="rgba(0,0,0,0.1)" stroke-width="3"/>

                            <!-- ========== C-S√ÑULEN ========== -->

                            <!-- C-S√§ule links -->
                            <path class="vehicle-part vehicle-part--pillar" id="part-c-saeule-l"
                                  d="M 68,230 L 140,230 L 140,245 L 115,245 L 68,235 Z"
                                  data-part="C-S√§ule links" data-keywords="saeule,c-saeule,links,pillar"/>

                            <!-- C-S√§ule rechts -->
                            <path class="vehicle-part vehicle-part--pillar" id="part-c-saeule-r"
                                  d="M 360,230 L 432,230 L 432,235 L 385,245 L 360,245 Z"
                                  data-part="C-S√§ule rechts" data-keywords="saeule,c-saeule,rechts,pillar"/>

                            <!-- ========== HECKSCHEIBE ========== -->
                            <path class="vehicle-part vehicle-part--glass" id="part-heckscheibe"
                                  d="M 140,230 L 360,230 L 385,245 L 385,265 L 115,265 L 115,245 Z"
                                  data-part="Heckscheibe" data-keywords="heckscheibe,scheibe,hinten,glas"/>
                            <text class="vehicle-part-label vehicle-part-label--glass" x="250" y="252">Heckscheibe</text>

                            <!-- ========== SEITENTEILE / KOTFL√úGEL HINTEN ========== -->

                            <!-- Seitenteil links -->
                            <path class="vehicle-part" id="part-seitenteil-l"
                                  d="M 60,230 L 68,230 L 68,265 L 78,285 L 60,285 Q 55,275 55,260 L 55,245 Q 55,235 60,230 Z"
                                  data-part="Seitenteil links" data-keywords="seitenteil,kotfluegel,hinten,links,fender"/>
                            <text class="vehicle-part-label" x="68" y="260" style="font-size: 8px;">ST L</text>

                            <!-- Seitenteil rechts -->
                            <path class="vehicle-part" id="part-seitenteil-r"
                                  d="M 432,230 L 440,230 Q 445,235 445,245 L 445,260 Q 445,275 440,285 L 422,285 L 432,265 Z"
                                  data-part="Seitenteil rechts" data-keywords="seitenteil,kotfluegel,hinten,rechts,fender"/>
                            <text class="vehicle-part-label" x="432" y="260" style="font-size: 8px;">ST R</text>

                            <!-- ========== HECKKLAPPE / KOFFERRAUM ========== -->
                            <path class="vehicle-part" id="part-heckklappe"
                                  d="M 78,265 L 422,265 L 422,285 L 400,295 L 100,295 L 78,285 Z"
                                  data-part="Heckklappe" data-keywords="heckklappe,kofferraum,kofferraumdeckel,heck,trunk"/>
                            <text class="vehicle-part-label" x="250" y="283">Heckklappe</text>

                            <!-- Kennzeichen-Mulde hinten -->
                            <rect x="200" y="272" width="100" height="18" rx="2" fill="rgba(255,255,255,0.3)" stroke="rgba(0,0,0,0.2)"/>

                            <!-- ========== R√úCKLICHTER ========== -->

                            <!-- R√ºcklicht links -->
                            <path class="vehicle-part vehicle-part--light" id="part-ruecklicht-l"
                                  d="M 78,270 L 115,270 L 115,290 L 85,290 Q 78,290 78,282 Z"
                                  data-part="R√ºcklicht links" data-keywords="ruecklicht,licht,hinten,links"/>
                            <rect x="85" y="275" width="25" height="10" rx="2" fill="rgba(255,0,0,0.5)"/>

                            <!-- R√ºcklicht rechts -->
                            <path class="vehicle-part vehicle-part--light" id="part-ruecklicht-r"
                                  d="M 385,270 L 422,270 L 422,282 Q 422,290 415,290 L 385,290 Z"
                                  data-part="R√ºcklicht rechts" data-keywords="ruecklicht,licht,hinten,rechts"/>
                            <rect x="390" y="275" width="25" height="10" rx="2" fill="rgba(255,0,0,0.5)"/>

                            <!-- ========== STO√üF√ÑNGER HINTEN ========== -->
                            <path class="vehicle-part" id="part-stossfaenger-hinten"
                                  d="M 85,295 L 415,295 Q 395,305 380,310 Q 300,315 250,315 Q 200,315 120,310 Q 105,305 85,295 Z"
                                  data-part="Sto√üf√§nger hinten" data-keywords="stossfaenger,hinten,heck,bumper"/>
                            <text class="vehicle-part-label" x="250" y="308">Sto√üf√§nger hinten</text>

                            <!-- Auspuff-Blenden -->
                            <ellipse cx="140" cy="305" rx="12" ry="6" fill="rgba(50,50,50,0.6)" stroke="#444"/>
                            <ellipse cx="360" cy="305" rx="12" ry="6" fill="rgba(50,50,50,0.6)" stroke="#444"/>

                            <!-- ========== SCHWELLER ========== -->

                            <!-- Schweller links -->
                            <rect class="vehicle-part" id="part-schweller-l"
                                  x="55" y="115" width="13" height="115" rx="3"
                                  data-part="Schweller links" data-keywords="schweller,seitenschweller,links,sill"/>

                            <!-- Schweller rechts -->
                            <rect class="vehicle-part" id="part-schweller-r"
                                  x="432" y="115" width="13" height="115" rx="3"
                                  data-part="Schweller rechts" data-keywords="schweller,seitenschweller,rechts,sill"/>

                        </svg>
                    </div><!-- Ende vehicle2DView -->

                    <!-- KI Foto-Analyse View -->
                    <div id="vehicleFotoView" class="foto-analyse-view" style="display: none;">

                        <!-- üÜï Vorhandene Fotos aus Entwurf/Anfrage -->
                        <div id="entwurfFotosSection" class="entwurf-fotos-ki-section" style="display: none;">
                            <div class="entwurf-fotos-ki-header">
                                <i data-feather="image"></i>
                                <h4>Fotos aus der Annahme ausw√§hlen</h4>
                                <span class="badge badge--success" id="selectedFotosCount">0 ausgew√§hlt</span>
                            </div>
                            <p class="entwurf-fotos-ki-hint">W√§hlen Sie die Fotos aus, die von der KI analysiert werden sollen:</p>

                            <div class="entwurf-fotos-ki-grid" id="entwurfFotosGrid">
                                <!-- Dynamisch gef√ºllt mit Fotos aus kalkWizardData.entwurfPhotos -->
                            </div>

                            <div class="entwurf-fotos-ki-actions">
                                <button class="btn btn-secondary btn-sm" onclick="selectAllEntwurfFotos()">
                                    <i data-feather="check-square"></i> Alle ausw√§hlen
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="deselectAllEntwurfFotos()">
                                    <i data-feather="square"></i> Keine ausw√§hlen
                                </button>
                            </div>

                            <div style="margin-top: var(--space-4); text-align: center;">
                                <button class="btn btn-primary btn-lg" onclick="analyzeSelectedEntwurfFotos()" id="btnAnalyzeEntwurfFotos">
                                    <i data-feather="cpu"></i>
                                    KI-Analyse starten
                                </button>
                            </div>

                            <div class="entwurf-fotos-ki-divider">
                                <span>oder</span>
                            </div>
                        </div>

                        <!-- Upload f√ºr neue/zus√§tzliche Fotos -->
                        <div class="foto-analyse-container" id="fotoDropzone" onclick="document.getElementById('fotoInput').click()">
                            <i data-feather="upload"></i>
                            <h4 id="fotoUploadTitle">Weitere Fotos hochladen</h4>
                            <p>Klicken oder Fotos hierher ziehen</p>
                            <p class="text-muted" style="font-size: var(--font-size-xs);">Die KI analysiert die Bilder und erkennt automatisch Sch√§den</p>
                            <input type="file" id="fotoInput" accept="image/*" multiple style="display: none;" onchange="handleFotoUpload(this.files)">
                        </div>

                        <div class="foto-analyse-preview" id="fotoPreview"></div>

                        <div id="kiAnalyseResult" class="ki-analyse-result" style="display: none;">
                            <div class="ki-analyse-result__header">
                                <i data-feather="cpu"></i>
                                <h4>KI-Schadensanalyse</h4>
                                <span class="badge badge--info">GPT-4 Vision</span>
                            </div>
                            <div class="ki-schaeden-liste" id="kiSchaedenListe">
                                <!-- Wird dynamisch gef√ºllt -->
                            </div>
                            <div style="margin-top: var(--space-4); text-align: center;">
                                <button class="btn btn-primary" onclick="applyKISchaeden()">
                                    <i data-feather="check"></i>
                                    Erkannte Sch√§den √ºbernehmen
                                </button>
                            </div>
                        </div>

                        <div id="kiAnalyseLoading" style="display: none; text-align: center; padding: var(--space-8);">
                            <div class="spinner" style="margin: 0 auto var(--space-4);"></div>
                            <p>KI analysiert die Bilder...</p>
                        </div>
                    </div>

                    <!-- Ausgew√§hltes Teil Anzeige -->
                    <div class="kalk-selected-part" id="selectedPartDisplay" style="display: none;">
                        <div class="kalk-selected-part__icon">‚úì</div>
                        <div class="kalk-selected-part__info">
                            <strong>Ausgew√§hltes Teil:</strong>
                            <span id="selectedPartName">-</span>
                        </div>
                        <button class="btn btn-sm btn-secondary" onclick="clearSelectedPart()">
                            <i data-feather="x"></i>
                        </button>
                    </div>

                    <!-- Ausgew√§hlte Teile Liste (f√ºr mehrere Teile) -->
                    <div class="kalk-parts-list" id="selectedPartsList" style="display: none;">
                        <h4>Ausgew√§hlte Teile:</h4>
                        <div id="partsListContent"></div>
                    </div>

                    <div class="kalk-step-actions">
                        <button class="btn btn-secondary btn-lg" onclick="goToStep3Back()">
                            <i data-feather="arrow-left"></i>
                            Zur√ºck
                        </button>
                        <button class="btn btn-primary btn-lg" onclick="goToStep(4)" id="btnStep3Next" disabled>
                            Weiter zu Reparaturart
                            <i data-feather="arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- STEP 4: REPARATURART W√ÑHLEN -->
            <!-- ============================================ -->
            <div class="kalk-step-content" id="stepContent4">
                <div class="content-card">
                    <div class="content-card__header">
                        <div class="content-card__title">
                            <i data-feather="settings"></i>
                            <h2>Schritt 4: Reparaturart w√§hlen</h2>
                        </div>
                    </div>

                    <!-- üÜï Nov 30, 2025: AUFTRAGSINFO BOX - Kopie von Step 3 -->
                    <div class="auftrags-info-box" id="step4AuftragsInfo" style="display: none;">
                        <div class="auftrags-info-header">
                            <i data-feather="file-text"></i>
                            <strong>Auftragsinformationen</strong>
                            <button class="btn btn-sm btn-ghost" onclick="toggleAuftragsInfo('step4')" id="auftragsInfoToggle4">
                                <i data-feather="chevron-up"></i>
                            </button>
                        </div>
                        <div class="auftrags-info-content" id="auftragsInfoContent4">
                            <div class="auftrags-info-grid">
                                <!-- Fahrzeug -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">üöó Fahrzeug</div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Kennzeichen:</span>
                                        <span class="auftrags-info-value" id="info4Kennzeichen">-</span>
                                    </div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Fahrzeug:</span>
                                        <span class="auftrags-info-value" id="info4Fahrzeug">-</span>
                                    </div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Farbe:</span>
                                        <span class="auftrags-info-value" id="info4Farbe">-</span>
                                    </div>
                                </div>

                                <!-- Kunde -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">üë§ Kunde</div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Name:</span>
                                        <span class="auftrags-info-value" id="info4Kunde">-</span>
                                    </div>
                                    <div class="auftrags-info-row" id="info4PartnerRow" style="display: none;">
                                        <span class="auftrags-info-label">Partner:</span>
                                        <span class="auftrags-info-value" id="info4Partner">-</span>
                                    </div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Datum:</span>
                                        <span class="auftrags-info-value" id="info4Datum">-</span>
                                    </div>
                                </div>

                                <!-- Service -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">üîß Service</div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Service-Art:</span>
                                        <span class="auftrags-info-value" id="info4Service">-</span>
                                    </div>
                                    <div class="auftrags-info-row" id="info4DringlichkeitRow" style="display: none;">
                                        <span class="auftrags-info-label">Dringlichkeit:</span>
                                        <span class="auftrags-info-value" id="info4Dringlichkeit">-</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Schadensbeschreibung -->
                            <div class="auftrags-info-section auftrags-info-full" id="info4SchadenSection" style="display: none;">
                                <div class="auftrags-info-section-title">üìù Schadensbeschreibung</div>
                                <div class="auftrags-info-schaden" id="info4Schaden">-</div>
                            </div>

                            <!-- Notizen -->
                            <div class="auftrags-info-section auftrags-info-full" id="info4NotizenSection" style="display: none;">
                                <div class="auftrags-info-section-title">üìã Notizen</div>
                                <div class="auftrags-info-notizen" id="info4Notizen">-</div>
                            </div>

                            <!-- Service-Details pro Service -->
                            <div class="auftrags-info-section auftrags-info-full" id="info4ServiceDetailsSection" style="display: none;">
                                <div class="auftrags-info-section-title">üì¶ Service-Details</div>
                                <div class="auftrags-info-service-details" id="info4ServiceDetails">
                                    <!-- Dynamisch gef√ºllt -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- üÜï Nov 30, 2025: Multi-Service Teile-√úbersicht -->
                    <div class="step4-parts-overview" id="step4PartsOverview" style="display: none;">
                        <div class="step4-parts-header">
                            <i data-feather="layers"></i>
                            <span>Ausgew√§hlte Teile (<span id="step4PartsCount">0</span>)</span>
                        </div>
                        <div class="step4-parts-tabs" id="step4PartsTabs">
                            <!-- Dynamisch: Tabs f√ºr jedes Teil -->
                        </div>
                    </div>

                    <!-- Gew√§hltes Teil anzeigen -->
                    <div class="kalk-selected-vehicle" id="step4PartInfo">
                        <span class="kalk-selected-vehicle__label">Teil:</span>
                        <span class="kalk-selected-vehicle__value" id="step4PartDisplay">-</span>
                        <span class="kalk-selected-vehicle__service" id="step4PartService" style="margin-left: var(--space-2); color: var(--color-text-secondary); font-size: var(--font-size-sm);"></span>
                    </div>

                    <!-- üÜï Fotos aus Entwurf/Annahme -->
                    <div class="entwurf-photos-section" id="step4PhotosSection" style="display: none;">
                        <div class="entwurf-photos-header">
                            <i data-feather="camera"></i>
                            <span>Fotos aus der Annahme</span>
                            <button class="btn btn-sm btn-secondary" onclick="togglePhotoGallery('step4')">
                                <i data-feather="maximize-2"></i> Vollbild
                            </button>
                        </div>
                        <div class="entwurf-photos-gallery" id="step4PhotosGallery">
                            <!-- Dynamisch gef√ºllt -->
                        </div>
                    </div>

                    <!-- Reparaturarten als Checkboxen (dynamisch je nach Service) -->
                    <div class="kalk-repair-options">
                        <h4>Welche Arbeiten sollen durchgef√ºhrt werden?</h4>
                        <p class="kalk-repair-hint">W√§hlen Sie alle zutreffenden Arbeiten f√ºr <strong id="step4ServiceName">-</strong> aus</p>

                        <div class="repair-options-grid" id="repairOptionsGrid">
                            <!-- Dynamisch generiert basierend auf SERVICE_CONFIG -->
                            <label class="repair-option">
                                <input type="checkbox" name="repair" value="lackieren" onchange="updateRepairSelection()">
                                <div class="repair-option__content">
                                    <span class="repair-option__icon">üé®</span>
                                    <span class="repair-option__label">Lackieren</span>
                                </div>
                            </label>
                            <label class="repair-option">
                                <input type="checkbox" name="repair" value="demontieren" onchange="updateRepairSelection()">
                                <div class="repair-option__content">
                                    <span class="repair-option__icon">üîß</span>
                                    <span class="repair-option__label">Demontieren</span>
                                </div>
                            </label>
                            <label class="repair-option">
                                <input type="checkbox" name="repair" value="montieren" onchange="updateRepairSelection()">
                                <div class="repair-option__content">
                                    <span class="repair-option__icon">üî©</span>
                                    <span class="repair-option__label">Montieren</span>
                                </div>
                            </label>
                            <label class="repair-option">
                                <input type="checkbox" name="repair" value="grundieren" onchange="updateRepairSelection()">
                                <div class="repair-option__content">
                                    <span class="repair-option__icon">üñåÔ∏è</span>
                                    <span class="repair-option__label">Grundieren</span>
                                </div>
                            </label>
                            <label class="repair-option">
                                <input type="checkbox" name="repair" value="spachteln" onchange="updateRepairSelection()">
                                <div class="repair-option__content">
                                    <span class="repair-option__icon">ü™£</span>
                                    <span class="repair-option__label">Spachteln</span>
                                </div>
                            </label>
                            <label class="repair-option">
                                <input type="checkbox" name="repair" value="schleifen" onchange="updateRepairSelection()">
                                <div class="repair-option__content">
                                    <span class="repair-option__icon">üìê</span>
                                    <span class="repair-option__label">Schleifen</span>
                                </div>
                            </label>
                            <label class="repair-option">
                                <input type="checkbox" name="repair" value="austauschen" onchange="updateRepairSelection()">
                                <div class="repair-option__content">
                                    <span class="repair-option__icon">üîÑ</span>
                                    <span class="repair-option__label">Austauschen (Neuteil)</span>
                                </div>
                            </label>
                            <label class="repair-option">
                                <input type="checkbox" name="repair" value="spot-repair" onchange="updateRepairSelection()">
                                <div class="repair-option__content">
                                    <span class="repair-option__icon">‚ú®</span>
                                    <span class="repair-option__label">Spot-Repair</span>
                                </div>
                            </label>
                            <label class="repair-option">
                                <input type="checkbox" name="repair" value="polieren" onchange="updateRepairSelection()">
                                <div class="repair-option__content">
                                    <span class="repair-option__icon">üíé</span>
                                    <span class="repair-option__label">Polieren</span>
                                </div>
                            </label>
                            <label class="repair-option">
                                <input type="checkbox" name="repair" value="ausbeulen" onchange="updateRepairSelection()">
                                <div class="repair-option__content">
                                    <span class="repair-option__icon">üî®</span>
                                    <span class="repair-option__label">Ausbeulen (PDR)</span>
                                </div>
                            </label>
                            <label class="repair-option">
                                <input type="checkbox" name="repair" value="schweissen" onchange="updateRepairSelection()">
                                <div class="repair-option__content">
                                    <span class="repair-option__icon">‚ö°</span>
                                    <span class="repair-option__label">Schwei√üen</span>
                                </div>
                            </label>
                            <label class="repair-option">
                                <input type="checkbox" name="repair" value="kleben" onchange="updateRepairSelection()">
                                <div class="repair-option__content">
                                    <span class="repair-option__icon">üß¥</span>
                                    <span class="repair-option__label">Kleben</span>
                                </div>
                            </label>
                        </div>

                        <!-- Ersatzteil-Eingabe (erscheint bei Austauschen/Ersetzen) -->
                        <div class="kalk-ersatzteil-inline" id="ersatzteilInlineForm" style="display: none; margin-top: var(--space-6);">
                            <div class="ersatzteil-inline-header">
                                <i data-feather="package"></i>
                                <h4>Ersatzteil f√ºr dieses Teil</h4>
                                <span class="ersatzteil-hint">Wird automatisch zur Bestellliste hinzugef√ºgt</span>
                            </div>
                            <div class="ersatzteil-inline-form">
                                <div class="ersatzteil-search-wrapper">
                                    <input type="text"
                                           id="ersatzteilInlineName"
                                           class="ersatzteil-input"
                                           placeholder="Ersatzteil-Name (z.B. Sto√üf√§nger vorne)"
                                           oninput="searchErsatzteileDB(this.value)"
                                           autocomplete="off">
                                    <div class="ersatzteil-autocomplete" id="ersatzteilAutocomplete" style="display: none;">
                                        <!-- Autocomplete-Ergebnisse aus DB -->
                                    </div>
                                </div>
                                <input type="text"
                                       id="ersatzteilInlineTeilenr"
                                       class="ersatzteil-input ersatzteil-input--small"
                                       placeholder="OE-/Teilenummer">
                                <input type="number"
                                       id="ersatzteilInlinePreis"
                                       class="ersatzteil-input ersatzteil-input--small"
                                       placeholder="Preis (‚Ç¨)"
                                       step="0.01"
                                       min="0">
                                <select id="ersatzteilInlineLieferant" class="ersatzteil-input ersatzteil-input--small">
                                    <option value="">Lieferant w√§hlen</option>
                                    <option value="DAT">DAT</option>
                                    <option value="Partslink24">Partslink24</option>
                                    <option value="Tecdoc">Tecdoc</option>
                                    <option value="Hersteller OE">Hersteller OE</option>
                                    <option value="Aftermarket">Aftermarket</option>
                                    <option value="Gebraucht">Gebraucht</option>
                                    <option value="Sonstige">Sonstige</option>
                                </select>
                            </div>
                            <p class="ersatzteil-db-hint">
                                <i data-feather="database"></i>
                                Neue Teile werden automatisch in Ihrer Ersatzteile-Datenbank gespeichert
                            </p>
                        </div>

                        <!-- Weiteres Teil hinzuf√ºgen Button -->
                        <div class="kalk-add-more" style="margin-top: var(--space-6); text-align: center;">
                            <button class="btn btn-secondary" onclick="addCurrentPartAndGoBack()">
                                <i data-feather="plus-circle"></i>
                                Dieses Teil hinzuf√ºgen & weiteres Teil w√§hlen
                            </button>
                        </div>
                    </div>

                    <div class="kalk-step-actions">
                        <button class="btn btn-secondary btn-lg" onclick="goToStep(3)">
                            <i data-feather="arrow-left"></i>
                            Zur√ºck
                        </button>
                        <button class="btn btn-primary btn-lg" onclick="saveCurrentPartAndGoToStep5()" id="btnStep4Next" disabled>
                            Weiter zu Ersatzteile
                            <i data-feather="arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- STEP 5: ERSATZTEILE-√úBERSICHT (NEU) -->
            <!-- ============================================ -->
            <div class="kalk-step-content" id="stepContent5">
                <div class="content-card">
                    <div class="content-card__header">
                        <div class="content-card__title">
                            <i data-feather="package"></i>
                            <h2>Schritt 5: Ersatzteile & Bestellungen</h2>
                        </div>
                    </div>

                    <!-- üÜï Nov 30, 2025: AUFTRAGSINFO BOX f√ºr Step 5 -->
                    <div class="auftrags-info-box" id="step5AuftragsInfo" style="display: none;">
                        <div class="auftrags-info-header">
                            <i data-feather="file-text"></i>
                            <strong>Auftragsinformationen</strong>
                            <button class="btn btn-sm btn-ghost" onclick="toggleAuftragsInfo('step5')" id="auftragsInfoToggle5">
                                <i data-feather="chevron-up"></i>
                            </button>
                        </div>
                        <div class="auftrags-info-content" id="auftragsInfoContent5">
                            <div class="auftrags-info-grid">
                                <!-- Fahrzeug -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">üöó Fahrzeug</div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Kennzeichen:</span>
                                        <span class="auftrags-info-value" id="info5Kennzeichen">-</span>
                                    </div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Fahrzeug:</span>
                                        <span class="auftrags-info-value" id="info5Fahrzeug">-</span>
                                    </div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Farbe:</span>
                                        <span class="auftrags-info-value" id="info5Farbe">-</span>
                                    </div>
                                </div>

                                <!-- Kunde -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">üë§ Kunde</div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Name:</span>
                                        <span class="auftrags-info-value" id="info5Kunde">-</span>
                                    </div>
                                    <div class="auftrags-info-row" id="info5PartnerRow" style="display: none;">
                                        <span class="auftrags-info-label">Partner:</span>
                                        <span class="auftrags-info-value" id="info5Partner">-</span>
                                    </div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Datum:</span>
                                        <span class="auftrags-info-value" id="info5Datum">-</span>
                                    </div>
                                </div>

                                <!-- Service -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">üîß Service</div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Service-Art:</span>
                                        <span class="auftrags-info-value" id="info5Service">-</span>
                                    </div>
                                    <div class="auftrags-info-row" id="info5DringlichkeitRow" style="display: none;">
                                        <span class="auftrags-info-label">Dringlichkeit:</span>
                                        <span class="auftrags-info-value" id="info5Dringlichkeit">-</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Schadensbeschreibung -->
                            <div class="auftrags-info-section auftrags-info-full" id="info5SchadenSection" style="display: none;">
                                <div class="auftrags-info-section-title">üìù Schadensbeschreibung</div>
                                <div class="auftrags-info-schaden" id="info5Schaden">-</div>
                            </div>

                            <!-- Notizen -->
                            <div class="auftrags-info-section auftrags-info-full" id="info5NotizenSection" style="display: none;">
                                <div class="auftrags-info-section-title">üìã Notizen</div>
                                <div class="auftrags-info-notizen" id="info5Notizen">-</div>
                            </div>

                            <!-- Service-Details pro Service -->
                            <div class="auftrags-info-section auftrags-info-full" id="info5ServiceDetailsSection" style="display: none;">
                                <div class="auftrags-info-section-title">üì¶ Service-Details</div>
                                <div class="auftrags-info-service-details" id="info5ServiceDetails">
                                    <!-- Dynamisch gef√ºllt -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- üÜï Nov 30, 2025: TEILE-CHECKLISTE f√ºr Bestellungen -->
                    <div class="teile-checklist-section" id="teileChecklistSection" style="display: none;">
                        <div class="teile-checklist-header">
                            <i data-feather="check-square"></i>
                            <strong>Ben√∂tigte Teile - Bestellungs-Checkliste</strong>
                            <span class="teile-checklist-badge" id="teileChecklistBadge">0/0</span>
                        </div>
                        <div class="teile-checklist-info">
                            <i data-feather="alert-circle"></i>
                            <span>Haken Sie jedes Teil ab, nachdem Sie es bestellt haben, um keine Bestellung zu vergessen!</span>
                        </div>
                        <div class="teile-checklist-items" id="teileChecklistItems">
                            <!-- Dynamisch gef√ºllt mit Checkboxen f√ºr jedes Teil -->
                        </div>
                        <div class="teile-checklist-actions" id="teileChecklistActions" style="display: none;">
                            <button class="btn btn-sm btn-outline" onclick="checkAllTeile()">
                                <i data-feather="check-square"></i> Alle abhaken
                            </button>
                            <button class="btn btn-sm btn-outline" onclick="uncheckAllTeile()">
                                <i data-feather="square"></i> Alle zur√ºcksetzen
                            </button>
                        </div>
                    </div>

                    <!-- Info-Banner -->
                    <div class="ersatzteile-info-banner">
                        <i data-feather="info"></i>
                        <div>
                            <strong>Ersatzteile bestellen</strong>
                            <p>Hier k√∂nnen Sie alle ben√∂tigten Ersatzteile erfassen. Die KI sucht automatisch passende Teile aus verschiedenen Online-Shops.</p>
                        </div>
                    </div>

                    <!-- üÜï KI-GEST√úTZTE ERSATZTEIL-SUCHE -->
                    <div class="ki-ersatzteile-section" id="kiErsatzteileSection">
                        <div class="ki-ersatzteile-header">
                            <div class="ki-ersatzteile-header__title">
                                <i data-feather="search"></i>
                                <h4>ü§ñ KI-Ersatzteilsuche</h4>
                            </div>
                            <button class="btn btn-primary" onclick="startKIErsatzteilSuche()" id="btnStartKISuche">
                                <i data-feather="zap"></i>
                                Ersatzteile automatisch suchen
                            </button>
                        </div>

                        <!-- Suchkontext-Info -->
                        <div class="ki-ersatzteile-context" id="kiSuchKontext">
                            <div class="ki-kontext-item">
                                <span class="ki-kontext-label">Fahrzeug:</span>
                                <span class="ki-kontext-value" id="kiKontextFahrzeug">-</span>
                            </div>
                            <div class="ki-kontext-item">
                                <span class="ki-kontext-label">Ben√∂tigte Teile:</span>
                                <span class="ki-kontext-value" id="kiKontextTeile">-</span>
                            </div>
                        </div>

                        <!-- Ladeanzeige -->
                        <div class="ki-ersatzteile-loading" id="kiErsatzteileLoading" style="display: none;">
                            <div class="ki-loading-spinner"></div>
                            <div class="ki-loading-text">
                                <strong>KI sucht nach Ersatzteilen...</strong>
                                <p id="kiLoadingStatus">Durchsuche Online-Shops nach passenden Teilen</p>
                            </div>
                        </div>

                        <!-- Suchergebnisse -->
                        <div class="ki-ersatzteile-results" id="kiErsatzteileResults" style="display: none;">
                            <div class="ki-results-header">
                                <div class="ki-results-count">
                                    <i data-feather="check-circle"></i>
                                    <span id="kiResultsCount">0</span> Angebote gefunden
                                </div>
                                <div class="ki-results-actions">
                                    <button class="btn btn-sm btn-outline" onclick="selectAllKIErsatzteile()">
                                        Alle ausw√§hlen
                                    </button>
                                    <button class="btn btn-sm btn-outline" onclick="selectCheapestKIErsatzteile()">
                                        G√ºnstigste ausw√§hlen
                                    </button>
                                </div>
                            </div>

                            <!-- Gruppiert nach Teil -->
                            <div id="kiErsatzteileGrouped"></div>

                            <!-- √úbernehmen Button -->
                            <div class="ki-results-footer">
                                <div class="ki-selected-summary">
                                    <span id="kiSelectedCount">0</span> Teile ausgew√§hlt
                                    <strong id="kiSelectedTotal">0,00 ‚Ç¨</strong>
                                </div>
                                <button class="btn btn-primary btn-lg" onclick="addSelectedKIErsatzteile()">
                                    <i data-feather="plus-circle"></i>
                                    Ausgew√§hlte zur Bestellliste hinzuf√ºgen
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Bereits hinzugef√ºgte Ersatzteile aus Step 4 -->
                    <div class="ersatzteile-from-repairs" id="ersatzteileFromRepairs">
                        <h4><i data-feather="check-circle"></i> Ersatzteile aus Reparaturen</h4>
                        <div id="ersatzteileFromRepairsList" class="ersatzteile-list">
                            <!-- Automatisch aus Step 4 √ºbernommen -->
                            <p class="no-items-hint">Keine Ersatzteile aus Reparaturen hinzugef√ºgt</p>
                        </div>
                    </div>

                    <!-- Weitere Ersatzteile manuell hinzuf√ºgen -->
                    <div class="ersatzteile-add-section">
                        <h4><i data-feather="plus-circle"></i> Weitere Ersatzteile hinzuf√ºgen</h4>

                        <div class="ersatzteil-add-form">
                            <div class="ersatzteil-form-row">
                                <div class="ersatzteil-field ersatzteil-field--large">
                                    <label>Bezeichnung / Teilename</label>
                                    <div class="ersatzteil-search-wrapper">
                                        <input type="text"
                                               id="ersatzteilAddName"
                                               placeholder="z.B. Sto√üf√§nger vorne, Scheinwerfer links..."
                                               oninput="searchErsatzteileDBStep5(this.value)"
                                               autocomplete="off">
                                        <div class="ersatzteil-autocomplete" id="ersatzteilAutocompleteStep5" style="display: none;">
                                        </div>
                                    </div>
                                </div>
                                <div class="ersatzteil-field">
                                    <label>OE-/Teilenummer</label>
                                    <input type="text" id="ersatzteilAddTeilenr" placeholder="z.B. 5G1941005A">
                                </div>
                                <!-- üÜï Dec 1, 2025: Service-Auswahl f√ºr Multi-Service -->
                                <div class="ersatzteil-field" id="ersatzteilServiceContainer" style="display: none;">
                                    <label>F√ºr Service</label>
                                    <select id="ersatzteilAddService" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                                        <option value="">Allgemein</option>
                                        <!-- Wird dynamisch bef√ºllt bei Multi-Service -->
                                    </select>
                                </div>
                            </div>
                            <!-- üÜï Nov 30, 2025: Zwei Preis-Felder f√ºr Original und Aftermarket -->
                            <div class="ersatzteil-form-row">
                                <div class="ersatzteil-field">
                                    <label>Original-Preis (‚Ç¨ netto) *</label>
                                    <input type="number" id="ersatzteilAddPreisOriginal" placeholder="z.B. 450.00" step="0.01" min="0" style="border-color: #003366;">
                                    <small style="color: #003366;">OEM / Hersteller-Teil</small>
                                </div>
                                <div class="ersatzteil-field">
                                    <label>Aftermarket-Preis (‚Ç¨ netto)</label>
                                    <input type="number" id="ersatzteilAddPreisAftermarket" placeholder="z.B. 280.00" step="0.01" min="0" style="border-color: #ff9800;">
                                    <small style="color: #ff9800;">Zubeh√∂r / Budget (optional)</small>
                                </div>
                                <div class="ersatzteil-field">
                                    <label>Menge</label>
                                    <input type="number" id="ersatzteilAddMenge" value="1" min="1">
                                </div>
                                <div class="ersatzteil-field ersatzteil-field--lieferant">
                                    <label>Lieferant</label>
                                    <div class="lieferant-combo-input">
                                        <input type="text" id="ersatzteilAddLieferant" placeholder="z.B. Autodoc, eBay, H√§ndler XY..." list="lieferantSuggestions">
                                        <datalist id="lieferantSuggestions">
                                            <option value="Autodoc">
                                            <option value="eBay">
                                            <option value="kfzteile24">
                                            <option value="Daparto">
                                            <option value="Autoteile-Markt">
                                            <option value="Partslink24">
                                            <option value="DAT">
                                            <option value="Hersteller OE">
                                            <option value="Aftermarket">
                                            <option value="Gebraucht">
                                        </datalist>
                                    </div>
                                </div>
                                <div class="ersatzteil-field ersatzteil-field--link">
                                    <label>Bestell-Link (optional)</label>
                                    <input type="url" id="ersatzteilAddLink" placeholder="https://...">
                                </div>
                                <div class="ersatzteil-field ersatzteil-field--action">
                                    <label>&nbsp;</label>
                                    <button class="btn btn-primary" onclick="addErsatzteilToList()">
                                        <i data-feather="plus"></i>
                                        Hinzuf√ºgen
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Externe Links -->
                        <div class="ersatzteile-external-links">
                            <span>Teile suchen bei:</span>
                            <a href="https://www.dat.de" target="_blank" class="external-link">
                                <i data-feather="external-link"></i> DAT
                            </a>
                            <a href="https://www.partslink24.com" target="_blank" class="external-link">
                                <i data-feather="external-link"></i> Partslink24
                            </a>
                            <a href="https://www.tecdoc.de" target="_blank" class="external-link">
                                <i data-feather="external-link"></i> TecDoc
                            </a>
                        </div>
                    </div>

                    <!-- Ersatzteile-Liste (alle gesammelten) -->
                    <div class="ersatzteile-complete-list">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-4);">
                            <h4 style="margin: 0;"><i data-feather="list"></i> Bestellliste</h4>
                            <button class="btn btn-secondary" onclick="exportBestelllistePDF()">
                                <i data-feather="download"></i>
                                PDF Export
                            </button>
                        </div>
                        <div id="ersatzteileCompleteList" class="ersatzteile-table-wrapper">
                            <!-- üÜï Nov 30, 2025: Zwei Preis-Spalten (Original + Aftermarket) -->
                            <table class="ersatzteile-table">
                                <thead>
                                    <tr>
                                        <th>Bezeichnung</th>
                                        <th>Teilenummer</th>
                                        <th>Lieferant</th>
                                        <th>Menge</th>
                                        <th style="background: #e3f2fd; color: #003366;">Original (‚Ç¨)</th>
                                        <th style="background: #fff3e0; color: #e65100;">Aftermarket (‚Ç¨)</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody id="ersatzteileTableBody">
                                    <tr class="no-items-row">
                                        <td colspan="7">Noch keine Ersatzteile hinzugef√ºgt</td>
                                    </tr>
                                </tbody>
                                <tfoot>
                                    <tr class="ersatzteile-total-row">
                                        <td colspan="4"><strong>Gesamt Ersatzteile (netto)</strong></td>
                                        <td style="background: #e3f2fd;"><strong id="ersatzteileGesamtOriginal">0,00 ‚Ç¨</strong></td>
                                        <td style="background: #fff3e0;"><strong id="ersatzteileGesamtAftermarket">0,00 ‚Ç¨</strong></td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <div class="kalk-step-actions">
                        <button class="btn btn-secondary btn-lg" onclick="goToStep(4)">
                            <i data-feather="arrow-left"></i>
                            Zur√ºck
                        </button>
                        <button class="btn btn-primary btn-lg" onclick="goToStep(6)" id="btnStep5Next">
                            Weiter zur √úbersicht
                            <i data-feather="arrow-right"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- ============================================ -->
            <!-- STEP 6: KALKULATION √úBERSICHT -->
            <!-- ============================================ -->
            <div class="kalk-step-content" id="stepContent6">
                <div class="content-card">
                    <div class="content-card__header">
                        <div class="content-card__title">
                            <i data-feather="file-text"></i>
                            <h2>Schritt 6: Kalkulation & √úbersicht</h2>
                        </div>
                    </div>

                    <!-- üÜï Nov 30, 2025: AUFTRAGSINFO BOX f√ºr Step 6 -->
                    <div class="auftrags-info-box" id="step6AuftragsInfo" style="display: none;">
                        <div class="auftrags-info-header">
                            <i data-feather="file-text"></i>
                            <strong>Auftragsinformationen</strong>
                            <button class="btn btn-sm btn-ghost" onclick="toggleAuftragsInfo('step6')" id="auftragsInfoToggle6">
                                <i data-feather="chevron-up"></i>
                            </button>
                        </div>
                        <div class="auftrags-info-content" id="auftragsInfoContent6">
                            <div class="auftrags-info-grid">
                                <!-- Fahrzeug -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">üöó Fahrzeug</div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Kennzeichen:</span>
                                        <span class="auftrags-info-value" id="info6Kennzeichen">-</span>
                                    </div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Fahrzeug:</span>
                                        <span class="auftrags-info-value" id="info6Fahrzeug">-</span>
                                    </div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Farbe:</span>
                                        <span class="auftrags-info-value" id="info6Farbe">-</span>
                                    </div>
                                </div>

                                <!-- Kunde -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">üë§ Kunde</div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Name:</span>
                                        <span class="auftrags-info-value" id="info6Kunde">-</span>
                                    </div>
                                    <div class="auftrags-info-row" id="info6PartnerRow" style="display: none;">
                                        <span class="auftrags-info-label">Partner:</span>
                                        <span class="auftrags-info-value" id="info6Partner">-</span>
                                    </div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Datum:</span>
                                        <span class="auftrags-info-value" id="info6Datum">-</span>
                                    </div>
                                </div>

                                <!-- Service -->
                                <div class="auftrags-info-section">
                                    <div class="auftrags-info-section-title">üîß Service</div>
                                    <div class="auftrags-info-row">
                                        <span class="auftrags-info-label">Service-Art:</span>
                                        <span class="auftrags-info-value" id="info6Service">-</span>
                                    </div>
                                    <div class="auftrags-info-row" id="info6DringlichkeitRow" style="display: none;">
                                        <span class="auftrags-info-label">Dringlichkeit:</span>
                                        <span class="auftrags-info-value" id="info6Dringlichkeit">-</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Schadensbeschreibung -->
                            <div class="auftrags-info-section auftrags-info-full" id="info6SchadenSection" style="display: none;">
                                <div class="auftrags-info-section-title">üìù Schadensbeschreibung</div>
                                <div class="auftrags-info-schaden" id="info6Schaden">-</div>
                            </div>

                            <!-- Notizen -->
                            <div class="auftrags-info-section auftrags-info-full" id="info6NotizenSection" style="display: none;">
                                <div class="auftrags-info-section-title">üìã Notizen</div>
                                <div class="auftrags-info-notizen" id="info6Notizen">-</div>
                            </div>

                            <!-- Service-Details pro Service -->
                            <div class="auftrags-info-section auftrags-info-full" id="info6ServiceDetailsSection" style="display: none;">
                                <div class="auftrags-info-section-title">üì¶ Service-Details</div>
                                <div class="auftrags-info-service-details" id="info6ServiceDetails">
                                    <!-- Dynamisch gef√ºllt -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Zusammenfassung -->
                    <div class="kalk-summary">
                        <div class="kalk-summary__vehicle">
                            <h4>Fahrzeug</h4>
                            <div id="step6VehicleSummary">-</div>
                        </div>
                        <div class="kalk-summary__parts">
                            <h4>Ausgew√§hlte Teile & Arbeiten</h4>
                            <div id="step6PartsSummary">-</div>
                        </div>
                        <div class="kalk-summary__ersatzteile">
                            <h4>Ersatzteile (Bestellliste)</h4>
                            <div id="step6ErsatzteileSummary">-</div>
                        </div>
                        <!-- üÜï Service-Details & Design-Galerie (f√ºr Folierung/Werbebeklebung) -->
                        <div class="kalk-summary__service-details" id="step6ServiceDetailsSection" style="display: none;">
                            <h4>üé® Service-Details</h4>
                            <div id="step6ServiceDetailsSummary">-</div>
                        </div>
                        <div class="kalk-summary__designs" id="step6DesignsSection" style="display: none;">
                            <h4>üìé Hochgeladene Designs</h4>
                            <div class="step6-design-gallery" id="step6DesignGallery">-</div>
                        </div>
                    </div>

                <div id="kalkulationContent">
                    <!-- Arbeitspositionen -->
                    <div class="content-card" style="margin-bottom: var(--space-6);">
                        <div class="content-card__header">
                            <div class="content-card__title">
                                <i data-feather="tool"></i>
                                <h2>Arbeitspositionen</h2>
                            </div>
                            <button class="btn btn-primary" onclick="openPositionModal()">
                                <i data-feather="plus"></i>
                                Position hinzuf√ºgen
                            </button>
                        </div>

                        <div id="positionenListe">
                            <div class="empty-state">
                                <i data-feather="clipboard"></i>
                                <h3>Keine Positionen</h3>
                                <p>F√ºgen Sie Arbeitspositionen aus dem Katalog hinzu</p>
                            </div>
                        </div>
                    </div>

                    <!-- Material -->
                    <div class="content-card" style="margin-bottom: var(--space-6);">
                        <div class="content-card__header">
                            <div class="content-card__title">
                                <i data-feather="package"></i>
                                <h2>Material</h2>
                            </div>
                            <button class="btn btn-primary" onclick="openMaterialModal()">
                                <i data-feather="plus"></i>
                                Material hinzuf√ºgen
                            </button>
                        </div>

                        <div id="materialListe">
                            <div class="empty-state">
                                <i data-feather="box"></i>
                                <h3>Kein Material</h3>
                                <p>F√ºgen Sie Materialien aus dem Katalog hinzu</p>
                            </div>
                        </div>
                    </div>

                    <!-- Zusammenfassung -->
                    <div class="kalkulation-summary">
                        <div class="summary-row">
                            <span class="label">Summe Arbeit (netto)</span>
                            <span class="value" id="summeArbeit">0,00 ‚Ç¨</span>
                        </div>
                        <div class="summary-row">
                            <span class="label">Summe Material (netto)</span>
                            <span class="value" id="summeMaterial">0,00 ‚Ç¨</span>
                        </div>
                        <div class="summary-row">
                            <span class="label">Summe Ersatzteile (netto)</span>
                            <span class="value" id="summeErsatzteile">0,00 ‚Ç¨</span>
                        </div>
                        <!-- üöó Ersatzfahrzeug-Kosten (FIX: Nov 30, 2025) -->
                        <div class="summary-row" id="ersatzfahrzeugSummaryRow" style="display: none;">
                            <span class="label">üöó Ersatzfahrzeug (netto)</span>
                            <span class="value" id="summeErsatzfahrzeug">0,00 ‚Ç¨</span>
                        </div>
                        <div class="summary-row" style="border-top: 1px solid var(--color-border); padding-top: var(--space-2); margin-top: var(--space-2);">
                            <span class="label">Zwischensumme (netto)</span>
                            <span class="value" id="summeNetto">0,00 ‚Ç¨</span>
                        </div>
                        <div class="summary-row">
                            <span class="label">MwSt. <span id="mwstSatzDisplay">19</span>%</span>
                            <span class="value" id="summeMwst">0,00 ‚Ç¨</span>
                        </div>
                        <div class="summary-row total">
                            <span class="label">Gesamtbetrag (brutto)</span>
                            <span class="value" id="summeBrutto">0,00 ‚Ç¨</span>
                        </div>
                    </div>

                    <!-- Aktionen -->
                    <div style="display: flex; gap: var(--space-4); margin-top: var(--space-6); flex-wrap: wrap;">
                        <button class="btn btn-success btn-lg" onclick="saveKVA()" style="flex: 1; min-width: 200px;">
                            <i data-feather="save"></i>
                            Kalkulation speichern
                        </button>
                        <button class="btn btn-secondary" onclick="goToStep(1)" style="min-width: 150px;">
                            <i data-feather="arrow-left"></i>
                            Zur√ºck bearbeiten
                        </button>
                    </div>
                    <p style="margin-top: var(--space-3); font-size: var(--font-size-sm); color: var(--color-text-secondary);">
                        <i data-feather="info" style="width: 14px; height: 14px; vertical-align: middle;"></i>
                        Die Kalkulation wird im Entwurf gespeichert. Danach k√∂nnen Sie das Angebot an den Kunden versenden.
                    </p>
                </div>

                <!-- Freie Kalkulation starten -->
                <div id="freieKalkulationStart">
                    <button class="btn btn-secondary" onclick="startFreieKalkulation()">
                        <i data-feather="edit-3"></i>
                        Freie Kalkulation ohne Fahrzeug starten
                    </button>
                </div>
            </div>
        </section>

        <!-- ============================================ -->
        <!-- TAB 2: Arbeitswert-Katalog -->
        <!-- ============================================ -->
        <section id="tab-katalog" class="tab-content">
            <div class="content-card">
                <div class="content-card__header">
                    <div class="content-card__title">
                        <i data-feather="book"></i>
                        <h2>Arbeitswert-Katalog</h2>
                    </div>
                    <button class="btn btn-primary" onclick="openKatalogModal()">
                        <i data-feather="plus"></i>
                        Neue Position
                    </button>
                </div>

                <!-- Search & Filter -->
                <div class="search-filter-bar">
                    <div class="search-input">
                        <i data-feather="search"></i>
                        <input type="text" id="katalogSearch" placeholder="Suchen..." oninput="filterKatalog()">
                    </div>
                    <select id="katalogFilter" onchange="filterKatalog()">
                        <option value="">Alle Kategorien</option>
                        <option value="Karosserie">Karosserie</option>
                        <option value="Lackierung">Lackierung</option>
                        <option value="Mechanik">Mechanik</option>
                        <option value="Elektrik">Elektrik</option>
                        <option value="Sonstiges">Sonstiges</option>
                    </select>
                </div>

                <div id="katalogListe">
                    <div class="empty-state">
                        <i data-feather="book-open"></i>
                        <h3>Katalog leer</h3>
                        <p>Erstellen Sie Ihren ersten Arbeitswert-Eintrag</p>
                        <button class="btn btn-primary" onclick="seedKatalog()">
                            <i data-feather="download"></i>
                            Standard-Katalog laden
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ============================================ -->
        <!-- TAB 3: Stundens√§tze -->
        <!-- ============================================ -->
        <section id="tab-saetze" class="tab-content">
            <div class="content-card">
                <div class="content-card__header">
                    <div class="content-card__title">
                        <i data-feather="dollar-sign"></i>
                        <h2>Stundens√§tze & Einstellungen</h2>
                    </div>
                </div>

                <form id="saetzeForm" onsubmit="saveSaetze(event)">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="stundensatzLack">Lackierarbeiten</label>
                            <div class="input-suffix">
                                <input type="number" id="stundensatzLack" step="0.01" min="0" value="95.00" required>
                                <span>‚Ç¨/Std</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="stundensatzKarosserie">Karosseriearbeiten</label>
                            <div class="input-suffix">
                                <input type="number" id="stundensatzKarosserie" step="0.01" min="0" value="85.00" required>
                                <span>‚Ç¨/Std</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="stundensatzMechanik">Mechanik/Elektrik</label>
                            <div class="input-suffix">
                                <input type="number" id="stundensatzMechanik" step="0.01" min="0" value="75.00" required>
                                <span>‚Ç¨/Std</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="stundensatzSonstige">Sonstige Arbeiten</label>
                            <div class="input-suffix">
                                <input type="number" id="stundensatzSonstige" step="0.01" min="0" value="65.00" required>
                                <span>‚Ç¨/Std</span>
                            </div>
                        </div>
                    </div>

                    <hr style="margin: var(--space-8) 0; border: none; border-top: 1px solid var(--color-border);">

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="awInMinuten">1 Arbeitswert (AW) entspricht</label>
                            <div class="input-suffix">
                                <input type="number" id="awInMinuten" step="1" min="1" value="5" required>
                                <span>Minuten</span>
                            </div>
                            <small>Branchenstandard: 5 Minuten pro AW</small>
                        </div>

                        <div class="form-group">
                            <label for="mwstSatz">Mehrwertsteuersatz</label>
                            <div class="input-suffix">
                                <input type="number" id="mwstSatz" step="0.1" min="0" value="19" required>
                                <span>%</span>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: var(--space-6);">
                        <button type="submit" class="btn btn-success" id="saveSaetzeBtn">
                            <i data-feather="save"></i>
                            Einstellungen speichern
                        </button>
                    </div>
                </form>
            </div>
        </section>

        <!-- ============================================ -->
        <!-- TAB 4: Material-Katalog -->
        <!-- ============================================ -->
        <section id="tab-material" class="tab-content">
            <div class="content-card">
                <div class="content-card__header">
                    <div class="content-card__title">
                        <i data-feather="package"></i>
                        <h2>Material-Katalog</h2>
                    </div>
                    <button class="btn btn-primary" onclick="openMaterialKatalogModal()">
                        <i data-feather="plus"></i>
                        Neues Material
                    </button>
                </div>

                <!-- Search & Filter -->
                <div class="search-filter-bar">
                    <div class="search-input">
                        <i data-feather="search"></i>
                        <input type="text" id="materialSearch" placeholder="Suchen..." oninput="filterMaterial()">
                    </div>
                    <select id="materialFilter" onchange="filterMaterial()">
                        <option value="">Alle Kategorien</option>
                        <option value="Lackmaterial">Lackmaterial</option>
                        <option value="Verbrauchsmaterial">Verbrauchsmaterial</option>
                        <option value="Ersatzteile">Ersatzteile</option>
                        <option value="Sonstiges">Sonstiges</option>
                    </select>
                </div>

                <div id="materialKatalogListe">
                    <div class="empty-state">
                        <i data-feather="package"></i>
                        <h3>Material-Katalog leer</h3>
                        <p>Erstellen Sie Ihren ersten Material-Eintrag</p>
                        <button class="btn btn-primary" onclick="seedMaterial()">
                            <i data-feather="download"></i>
                            Standard-Material laden
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ============================================ -->
        <!-- TAB 5: Historie -->
        <!-- ============================================ -->
        <section id="tab-historie" class="tab-content">
            <div class="content-card">
                <div class="content-card__header">
                    <div class="content-card__title">
                        <i data-feather="clock"></i>
                        <h2>Kalkulations-Historie</h2>
                    </div>
                </div>

                <!-- Search & Filter -->
                <div class="search-filter-bar">
                    <div class="search-input">
                        <i data-feather="search"></i>
                        <input type="text" id="historieSearch" placeholder="Kennzeichen oder Kunde suchen...">
                    </div>
                    <select id="historieFilter">
                        <option value="">Alle Status</option>
                        <option value="entwurf">Entwurf</option>
                        <option value="gesendet">Gesendet</option>
                        <option value="akzeptiert">Akzeptiert</option>
                        <option value="abgelehnt">Abgelehnt</option>
                    </select>
                </div>

                <div id="historieListe">
                    <div class="empty-state">
                        <i data-feather="file-text"></i>
                        <h3>Keine Kalkulationen</h3>
                        <p>Ihre erstellten Kalkulationen erscheinen hier</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- ============================================ -->
        <!-- TAB 6: Schnell-Kalkulationen (Templates) -->
        <!-- ============================================ -->
        <section id="tab-templates" class="tab-content">
            <div class="content-card">
                <div class="content-card__header">
                    <div class="content-card__title">
                        <i data-feather="copy"></i>
                        <h2>Kalkulations-Templates</h2>
                    </div>
                    <button class="btn btn-primary" onclick="openModal('templateModal')">
                        <i data-feather="plus"></i>
                        Neues Template
                    </button>
                </div>
                <p class="text-muted" style="margin-bottom: var(--space-4);">
                    Speichern Sie h√§ufige Kalkulationen als Templates f√ºr schnelle Wiederverwendung.
                </p>

                <!-- Template-Kategorien -->
                <div class="template-categories">
                    <button class="template-category active" data-category="all" onclick="filterTemplates('all')">
                        Alle Templates
                    </button>
                    <button class="template-category" data-category="lackierung" onclick="filterTemplates('lackierung')">
                        Lackierung
                    </button>
                    <button class="template-category" data-category="smart_repair" onclick="filterTemplates('smart_repair')">
                        Smart Repair
                    </button>
                    <button class="template-category" data-category="unfall" onclick="filterTemplates('unfall')">
                        Unfallsch√§den
                    </button>
                    <button class="template-category" data-category="sonstiges" onclick="filterTemplates('sonstiges')">
                        Sonstiges
                    </button>
                </div>

                <!-- Template-Liste -->
                <div id="templateListe" class="template-grid">
                    <!-- Vordefinierte Standard-Templates -->
                    <div class="template-card" onclick="loadTemplate('standard_kotfluegel')">
                        <div class="template-card__icon">üöó</div>
                        <div class="template-card__content">
                            <h4>Kotfl√ºgel lackieren</h4>
                            <p>Standard-Lackierung eines Kotfl√ºgels inkl. Vor-/Nachbereitung</p>
                            <div class="template-card__meta">
                                <span><i data-feather="clock"></i> ~3h</span>
                                <span><i data-feather="tag"></i> Lackierung</span>
                            </div>
                        </div>
                    </div>

                    <div class="template-card" onclick="loadTemplate('standard_stossfaenger')">
                        <div class="template-card__icon">üõ°Ô∏è</div>
                        <div class="template-card__content">
                            <h4>Sto√üf√§nger komplett</h4>
                            <p>Demontage, Reparatur, Lackierung, Montage</p>
                            <div class="template-card__meta">
                                <span><i data-feather="clock"></i> ~5h</span>
                                <span><i data-feather="tag"></i> Lackierung</span>
                            </div>
                        </div>
                    </div>

                    <div class="template-card" onclick="loadTemplate('smart_beule')">
                        <div class="template-card__icon">üîß</div>
                        <div class="template-card__content">
                            <h4>Beule Smart Repair</h4>
                            <p>Kleine Delle ausbeulen ohne Lackierung (PDR)</p>
                            <div class="template-card__meta">
                                <span><i data-feather="clock"></i> ~1h</span>
                                <span><i data-feather="tag"></i> Smart Repair</span>
                            </div>
                        </div>
                    </div>

                    <div class="template-card" onclick="loadTemplate('smart_kratzer')">
                        <div class="template-card__icon">‚ú®</div>
                        <div class="template-card__content">
                            <h4>Kratzer ausbessern</h4>
                            <p>Spot Repair f√ºr oberfl√§chliche Kratzer</p>
                            <div class="template-card__meta">
                                <span><i data-feather="clock"></i> ~2h</span>
                                <span><i data-feather="tag"></i> Smart Repair</span>
                            </div>
                        </div>
                    </div>

                    <div class="template-card" onclick="loadTemplate('unfall_seite')">
                        <div class="template-card__icon">üí•</div>
                        <div class="template-card__content">
                            <h4>Seitenschaden Standard</h4>
                            <p>T√ºre + Schweller + Kotfl√ºgel hinten</p>
                            <div class="template-card__meta">
                                <span><i data-feather="clock"></i> ~12h</span>
                                <span><i data-feather="tag"></i> Unfall</span>
                            </div>
                        </div>
                    </div>

                    <div class="template-card" onclick="loadTemplate('unfall_front')">
                        <div class="template-card__icon">üöß</div>
                        <div class="template-card__content">
                            <h4>Frontschaden Standard</h4>
                            <p>Sto√üf√§nger + Motorhaube + Kotfl√ºgel</p>
                            <div class="template-card__meta">
                                <span><i data-feather="clock"></i> ~15h</span>
                                <span><i data-feather="tag"></i> Unfall</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Eigene Templates -->
                <h3 style="margin-top: var(--space-8); margin-bottom: var(--space-4);">
                    <i data-feather="bookmark"></i>
                    Meine gespeicherten Templates
                </h3>
                <div id="eigeneTemplateListe" class="template-grid">
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <i data-feather="bookmark"></i>
                        <h4>Keine eigenen Templates</h4>
                        <p>Erstellen Sie eigene Templates aus abgeschlossenen Kalkulationen</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- ============================================ -->
        <!-- TAB 7: Lieferanten-Vergleich -->
        <!-- ============================================ -->
        <section id="tab-lieferanten" class="tab-content">
            <div class="content-card">
                <div class="content-card__header">
                    <div class="content-card__title">
                        <i data-feather="truck"></i>
                        <h2>Lieferanten-Vergleich</h2>
                    </div>
                    <button class="btn btn-primary" onclick="openModal('lieferantModal')">
                        <i data-feather="plus"></i>
                        Neuer Lieferant
                    </button>
                </div>
                <p class="text-muted" style="margin-bottom: var(--space-4);">
                    Verwalten Sie Ihre Lieferanten und vergleichen Sie Preise f√ºr Ersatzteile.
                </p>

                <!-- Lieferanten-Liste -->
                <div id="lieferantenListe" class="lieferanten-grid">
                    <!-- Standard-Lieferanten -->
                    <div class="lieferant-card">
                        <div class="lieferant-card__logo">
                            <span style="font-size: 2rem;">üîß</span>
                        </div>
                        <div class="lieferant-card__content">
                            <h4>DAT / Audatex</h4>
                            <p>Offizieller Ersatzteilkatalog</p>
                            <div class="lieferant-card__meta">
                                <span class="badge badge--success">Prim√§r</span>
                                <a href="https://www.dat.de" target="_blank" class="btn btn-sm btn-secondary">
                                    <i data-feather="external-link"></i>
                                    √ñffnen
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="lieferant-card">
                        <div class="lieferant-card__logo">
                            <span style="font-size: 2rem;">üöó</span>
                        </div>
                        <div class="lieferant-card__content">
                            <h4>Partslink24</h4>
                            <p>OEM-Ersatzteile aller Hersteller</p>
                            <div class="lieferant-card__meta">
                                <span class="badge badge--info">OEM</span>
                                <a href="https://www.partslink24.com" target="_blank" class="btn btn-sm btn-secondary">
                                    <i data-feather="external-link"></i>
                                    √ñffnen
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="lieferant-card">
                        <div class="lieferant-card__logo">
                            <span style="font-size: 2rem;">üìö</span>
                        </div>
                        <div class="lieferant-card__content">
                            <h4>TecDoc</h4>
                            <p>Aftermarket-Ersatzteile</p>
                            <div class="lieferant-card__meta">
                                <span class="badge badge--warning">Aftermarket</span>
                                <a href="https://www.tecdoc.de" target="_blank" class="btn btn-sm btn-secondary">
                                    <i data-feather="external-link"></i>
                                    √ñffnen
                                </a>
                            </div>
                        </div>
                    </div>

                    <div class="lieferant-card">
                        <div class="lieferant-card__logo">
                            <span style="font-size: 2rem;">üõí</span>
                        </div>
                        <div class="lieferant-card__content">
                            <h4>Stahlgruber</h4>
                            <p>Gro√ühandel f√ºr Werkstattbedarf</p>
                            <div class="lieferant-card__meta">
                                <span class="badge badge--secondary">Gro√ühandel</span>
                                <a href="https://www.stahlgruber.de" target="_blank" class="btn btn-sm btn-secondary">
                                    <i data-feather="external-link"></i>
                                    √ñffnen
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Preisvergleich-Tool -->
                <h3 style="margin-top: var(--space-8); margin-bottom: var(--space-4);">
                    <i data-feather="bar-chart-2"></i>
                    Ersatzteil-Preisvergleich
                </h3>
                <div class="preisvergleich-container">
                    <div class="search-input" style="max-width: 400px; margin-bottom: var(--space-4);">
                        <i data-feather="search"></i>
                        <input type="text" id="preisvergleichSuche" placeholder="Ersatzteil suchen (Name oder Teilenummer)..." oninput="searchPreisvergleich(this.value)">
                    </div>
                    <div id="preisvergleichResult" class="preisvergleich-results">
                        <div class="empty-state">
                            <i data-feather="search"></i>
                            <h4>Ersatzteil suchen</h4>
                            <p>Geben Sie den Namen oder die Teilenummer ein, um Preise zu vergleichen</p>
                        </div>
                    </div>
                </div>

                <!-- Eigene Lieferanten -->
                <h3 style="margin-top: var(--space-8); margin-bottom: var(--space-4);">
                    <i data-feather="users"></i>
                    Meine Lieferanten
                </h3>
                <div id="eigeneLieferantenListe" class="lieferanten-grid">
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <i data-feather="truck"></i>
                        <h4>Keine eigenen Lieferanten</h4>
                        <p>F√ºgen Sie Ihre bevorzugten Lieferanten hinzu</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- ============================================ -->
        <!-- TAB 8: Wiederkehrende Kunden-Fahrzeuge -->
        <!-- ============================================ -->
        <section id="tab-kunden" class="tab-content">
            <div class="content-card">
                <div class="content-card__header">
                    <div class="content-card__title">
                        <i data-feather="users"></i>
                        <h2>Kunden & Fahrzeuge</h2>
                    </div>
                </div>
                <p class="text-muted" style="margin-bottom: var(--space-4);">
                    Alle Kunden und deren Fahrzeuge aus bisherigen Kalkulationen. Klicken Sie auf einen Kunden, um direkt eine neue Kalkulation zu starten.
                </p>

                <!-- Such- und Filterleiste -->
                <div class="search-filter-bar" style="margin-bottom: var(--space-6);">
                    <div class="search-input" style="flex: 1;">
                        <i data-feather="search"></i>
                        <input type="text" id="kundenSuche" placeholder="Kunde, Kennzeichen oder Fahrzeug suchen..." oninput="filterKunden(this.value)">
                    </div>
                    <select id="kundenSort" onchange="sortKunden(this.value)">
                        <option value="recent">Zuletzt verwendet</option>
                        <option value="name">Name A-Z</option>
                        <option value="count">Meiste Auftr√§ge</option>
                    </select>
                </div>

                <!-- Kunden-Liste -->
                <div id="kundenListe" class="kunden-grid">
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <i data-feather="users"></i>
                        <h4>Keine Kunden vorhanden</h4>
                        <p>Kunden werden automatisch aus abgeschlossenen Kalkulationen hinzugef√ºgt</p>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- ============================================ -->
    <!-- MODALS -->
    <!-- ============================================ -->

    <!-- Modal: Position aus Katalog zur Kalkulation hinzuf√ºgen -->
    <div class="modal-overlay" id="positionAuswahlModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3>Position aus Katalog hinzuf√ºgen</h3>
                <button class="modal-close" onclick="closeModal('positionAuswahlModal')">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                <div class="search-input" style="margin-bottom: var(--space-4);">
                    <i data-feather="search"></i>
                    <input type="text" id="positionAuswahlSearch" placeholder="Position suchen..." oninput="filterPositionAuswahl()">
                </div>
                <div id="positionAuswahlListe">
                    <!-- Wird dynamisch gef√ºllt -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('positionAuswahlModal')">Abbrechen</button>
            </div>
        </div>
    </div>

    <!-- Modal: Material aus Katalog zur Kalkulation hinzuf√ºgen -->
    <div class="modal-overlay" id="materialAuswahlModal">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <h3>Material aus Katalog hinzuf√ºgen</h3>
                <button class="modal-close" onclick="closeModal('materialAuswahlModal')">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                <div class="search-input" style="margin-bottom: var(--space-4);">
                    <i data-feather="search"></i>
                    <input type="text" id="materialAuswahlSearch" placeholder="Material suchen..." oninput="filterMaterialAuswahl()">
                </div>
                <div id="materialAuswahlListe">
                    <!-- Wird dynamisch gef√ºllt -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('materialAuswahlModal')">Abbrechen</button>
            </div>
        </div>
    </div>

    <!-- Modal: Katalog-Position hinzuf√ºgen/bearbeiten -->
    <div class="modal-overlay" id="katalogModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="katalogModalTitle">Neue Position</h3>
                <button class="modal-close" onclick="closeModal('katalogModal')">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="katalogForm" onsubmit="saveKatalogPosition(event)">
                    <input type="hidden" id="katalogPositionId">

                    <div class="form-group">
                        <label for="positionName">Bezeichnung *</label>
                        <input type="text" id="positionName" required placeholder="z.B. Sto√üf√§nger vorne dem./mont.">
                    </div>

                    <div class="form-group">
                        <label for="positionKategorie">Kategorie *</label>
                        <select id="positionKategorie" required>
                            <option value="">-- W√§hlen --</option>
                            <option value="Karosserie">Karosserie</option>
                            <option value="Lackierung">Lackierung</option>
                            <option value="Mechanik">Mechanik</option>
                            <option value="Elektrik">Elektrik</option>
                            <option value="Sonstiges">Sonstiges</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="positionAW">Arbeitswerte (AW) *</label>
                        <input type="number" id="positionAW" step="0.5" min="0.5" required placeholder="z.B. 8.5">
                        <small>1 AW = 5 Minuten (Standard)</small>
                    </div>

                    <div class="form-group">
                        <label for="positionBeschreibung">Beschreibung (optional)</label>
                        <input type="text" id="positionBeschreibung" placeholder="Zus√§tzliche Infos...">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('katalogModal')">Abbrechen</button>
                <button type="submit" form="katalogForm" class="btn btn-primary">
                    <i data-feather="save"></i>
                    Speichern
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Material hinzuf√ºgen/bearbeiten -->
    <div class="modal-overlay" id="materialKatalogModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="materialModalTitle">Neues Material</h3>
                <button class="modal-close" onclick="closeModal('materialKatalogModal')">
                    <i data-feather="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="materialForm" onsubmit="saveMaterialPosition(event)">
                    <input type="hidden" id="materialPositionId">

                    <div class="form-group">
                        <label for="materialName">Bezeichnung *</label>
                        <input type="text" id="materialName" required placeholder="z.B. Basislack 1L">
                    </div>

                    <div class="form-group">
                        <label for="materialKategorie">Kategorie *</label>
                        <select id="materialKategorie" required>
                            <option value="">-- W√§hlen --</option>
                            <option value="Lackmaterial">Lackmaterial</option>
                            <option value="Verbrauchsmaterial">Verbrauchsmaterial</option>
                            <option value="Ersatzteile">Ersatzteile</option>
                            <option value="Sonstiges">Sonstiges</option>
                        </select>
                    </div>

                    <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                        <div class="form-group">
                            <label for="materialEK">Einkaufspreis (EK)</label>
                            <div class="input-suffix">
                                <input type="number" id="materialEK" step="0.01" min="0" placeholder="0.00">
                                <span>‚Ç¨</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="materialVK">Verkaufspreis (VK) *</label>
                            <div class="input-suffix">
                                <input type="number" id="materialVK" step="0.01" min="0" required placeholder="0.00">
                                <span>‚Ç¨</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="materialEinheit">Einheit</label>
                        <select id="materialEinheit">
                            <option value="St√ºck">St√ºck</option>
                            <option value="Liter">Liter</option>
                            <option value="kg">kg</option>
                            <option value="Set">Set</option>
                            <option value="Meter">Meter</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('materialKatalogModal')">Abbrechen</button>
                <button type="submit" form="materialForm" class="btn btn-primary">
                    <i data-feather="save"></i>
                    Speichern
                </button>
            </div>
        </div>
    </div>


    <!-- üõ°Ô∏è PERFORMANCE FIX Phase 2: Ausgelagertes JavaScript -->
    <script src="js/kalkulation.js"></script>
</body>
</html>
