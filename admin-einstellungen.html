<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin-Einstellungen | Auto-Lackierzentrum Mosbach</title>

    <!-- Aggressive No-Cache Headers (Cache-Fix für v=a4192c4) -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- Mobile-Responsive CSS Framework -->
    <link rel="stylesheet" href="mobile-responsive.css">

    <!-- Apple Liquid Glass Design System -->
    <link rel="stylesheet" href="design-system.css">
    <link rel="stylesheet" href="components.css">
    <link rel="stylesheet" href="animations.css">
    <link rel="stylesheet" href="mobile-first.css">
    <link rel="stylesheet" href="css/ai-chat-widget.css">

    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>

    <!-- GSAP Animation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Screen Reader Only - Accessibility */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        body {
            font-family: 'SF Pro Display', 'Inter', var(--font-system);
            background: var(--color-background);
            min-height: 100vh;
            padding: var(--space-6) var(--space-4) 100px;
            color: var(--color-text-primary);
            transition: background 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        .page-header {
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-2xl);
            padding: var(--space-5) var(--space-6);
            margin-bottom: var(--space-5);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-4);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .btn-back {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border-glass);
            background: var(--color-surface);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-back:hover {
            background: var(--color-primary);
            border-color: var(--color-primary);
            transform: scale(1.05);
        }

        .btn-back:hover i {
            color: white;
        }

        .page-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--color-text-primary);
        }

        .header-actions {
            display: flex;
            gap: var(--space-3);
        }

        /* Tabs */
        .tabs-container {
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-2xl);
            padding: var(--space-4);
            margin-bottom: var(--space-5);
            box-shadow: var(--shadow-lg);
            overflow-x: auto;
        }

        .tabs {
            display: flex;
            gap: var(--space-2);
            min-width: max-content;
        }

        .tab {
            padding: var(--space-3) var(--space-5);
            border-radius: var(--radius-lg);
            border: 1px solid transparent;
            background: transparent;
            color: var(--color-text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab:hover {
            background: var(--color-surface-hover);
            color: var(--color-text-primary);
        }

        .tab.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        /* Content Sections */
        .content-section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Cards */
        .card {
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-2xl);
            padding: var(--space-6);
            margin-bottom: var(--space-5);
            box-shadow: var(--shadow-lg);
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--color-text-primary);
            margin-bottom: var(--space-4);
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .card-description {
            font-size: 14px;
            color: var(--color-text-secondary);
            margin-bottom: var(--space-5);
        }

        /* Form Groups */
        .form-group {
            margin-bottom: var(--space-5);
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: var(--space-2);
        }

        .form-label .required {
            color: var(--color-error);
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
            background: var(--color-surface);
            color: var(--color-text-primary);
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-hint {
            font-size: 12px;
            color: var(--color-text-tertiary);
            margin-top: var(--space-2);
        }

        /* Form Grid */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: var(--space-4);
        }

        /* Toggle Switch */
        .toggle-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-3);
            border-radius: var(--radius-lg);
            background: var(--color-surface-hover);
            margin-bottom: var(--space-3);
        }

        .toggle-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--color-text-primary);
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 28px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--color-border);
            transition: 0.3s;
            border-radius: 28px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--color-primary);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }

        /* Dark Mode - Toggle Switches */
        [data-theme="dark"] .toggle-group {
            background: rgba(255, 255, 255, 0.05);
        }

        [data-theme="dark"] .toggle-slider {
            background-color: rgba(255, 255, 255, 0.1);
        }

        [data-theme="dark"] .toggle-slider:before {
            background-color: rgba(255, 255, 255, 0.9);
        }

        [data-theme="dark"] .toggle-switch input:checked + .toggle-slider {
            background-color: var(--color-primary);
        }

        /* Buttons */
        .btn {
            padding: var(--space-3) var(--space-5);
            border-radius: var(--radius-lg);
            border: 1px solid transparent;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
            transform: scale(1.02);
        }

        .btn-secondary {
            background: var(--color-surface);
            color: var(--color-text-primary);
            border-color: var(--color-border);
        }

        .btn-secondary:hover {
            background: var(--color-surface-hover);
        }

        .btn-danger {
            background: var(--color-error);
            color: white;
            border-color: var(--color-error);
        }

        .btn-danger:hover {
            background: #e60000;
        }

        .btn-success {
            background: var(--color-success);
            color: white;
            border-color: var(--color-success);
        }

        .btn-group {
            display: flex;
            gap: var(--space-3);
            flex-wrap: wrap;
        }

        /* File Upload */
        .file-upload {
            display: flex;
            align-items: center;
            gap: var(--space-4);
        }

        .file-upload-preview {
            width: 100px;
            height: 100px;
            border-radius: var(--radius-lg);
            border: 2px dashed var(--color-border);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .file-upload-preview img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* Dark Mode - File Upload */
        [data-theme="dark"] .file-upload-preview {
            border-color: rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.03);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-5);
        }

        .stat-card {
            background: var(--color-surface-hover);
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: var(--space-2);
        }

        .stat-label {
            font-size: 14px;
            color: var(--color-text-secondary);
        }

        /* Alert Box */
        .alert {
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-4);
            display: flex;
            align-items: start;
            gap: var(--space-3);
        }

        .alert-info {
            background: rgba(0, 122, 255, 0.1);
            border: 1px solid rgba(0, 122, 255, 0.3);
            color: var(--color-primary);
        }

        .alert-success {
            background: rgba(52, 199, 89, 0.1);
            border: 1px solid rgba(52, 199, 89, 0.3);
            color: var(--color-success);
        }

        .alert-warning {
            background: rgba(255, 149, 0, 0.1);
            border: 1px solid rgba(255, 149, 0, 0.3);
            color: var(--color-warning);
        }

        .alert-danger {
            background: rgba(255, 59, 48, 0.1);
            border: 1px solid rgba(255, 59, 48, 0.3);
            color: var(--color-error);
        }

        /* Dark Mode - Alerts */
        [data-theme="dark"] .alert-info {
            background: rgba(10, 132, 255, 0.15);
            border-color: rgba(10, 132, 255, 0.4);
            color: rgba(10, 132, 255, 1);
        }

        [data-theme="dark"] .alert-success {
            background: rgba(52, 199, 89, 0.15);
            border-color: rgba(52, 199, 89, 0.4);
            color: rgba(52, 199, 89, 1);
        }

        [data-theme="dark"] .alert-warning {
            background: rgba(255, 149, 0, 0.15);
            border-color: rgba(255, 149, 0, 0.4);
            color: rgba(255, 149, 0, 1);
        }

        [data-theme="dark"] .alert-danger {
            background: rgba(255, 59, 48, 0.15);
            border-color: rgba(255, 59, 48, 0.4);
            color: rgba(255, 59, 48, 1);
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid var(--color-border);
            border-top: 3px solid var(--color-primary);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive - Mobile Touch Optimization */
        @media (max-width: 768px) {
            /* Page Header - Better mobile layout */
            .page-header {
                flex-direction: column;
                align-items: flex-start;
                padding: var(--space-4);
            }

            /* Back Button - Touch-friendly 48x48px */
            .btn-back {
                width: 48px;
                height: 48px;
            }

            /* Header Actions - Touch-friendly buttons */
            .header-actions {
                width: 100%;
            }

            .header-actions .btn {
                flex: 1;
                min-height: 48px;
                justify-content: center;
            }

            /* Tabs - Horizontal scroll with hints */
            .tabs-container {
                padding: var(--space-3);
                position: relative;
            }

            .tabs-container::after {
                content: '→';
                position: absolute;
                right: var(--space-3);
                top: 50%;
                transform: translateY(-50%);
                color: var(--color-text-tertiary);
                font-size: 18px;
                pointer-events: none;
                opacity: 0.5;
            }

            .tabs {
                overflow-x: auto;
                scroll-behavior: smooth;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }

            .tabs::-webkit-scrollbar {
                display: none;
            }

            .tab {
                min-height: 44px;
                padding: var(--space-2) var(--space-4);
                flex-shrink: 0;
            }

            /* Cards - Reduced padding on mobile */
            .card {
                padding: var(--space-4);
                margin-bottom: var(--space-4);
            }

            /* Toggle Switches - Larger on mobile */
            .toggle-switch {
                width: 56px;
                height: 32px;
            }

            .toggle-slider:before {
                height: 24px;
                width: 24px;
                left: 4px;
                bottom: 4px;
            }

            .toggle-switch input:checked + .toggle-slider:before {
                transform: translateX(24px);
            }

            /* Buttons - All touch-friendly */
            .btn {
                min-height: 48px;
                padding: var(--space-3) var(--space-4);
            }

            .btn-group {
                flex-direction: column;
                width: 100%;
            }

            .btn-group .btn {
                width: 100%;
            }

            /* Form Grid - Single column */
            .form-grid {
                grid-template-columns: 1fr;
            }

            /* Stats Grid - Single column */
            .stats-grid {
                grid-template-columns: 1fr;
            }

            /* File Upload - Stack vertically on mobile */
            .file-upload {
                flex-direction: column;
                align-items: flex-start;
            }

            .file-upload-preview {
                width: 120px;
                height: 120px;
                margin-bottom: var(--space-3);
            }

            /* Alert Toast - Better mobile positioning */
            .alert {
                max-width: calc(100vw - 32px) !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="page-header">
            <div class="header-left">
                <button class="btn-back" onclick="window.location.href='index.html'" title="Zurück">
                    <i data-feather="arrow-left"></i>
                </button>
                <div>
                    <!-- Werkstatt Logo (dynamisch geladen) -->
                    <div id="werkstattLogo" style="display: inline-block; vertical-align: middle; margin-right: 12px;"></div>
                    <h1 class="page-title" style="display: inline-block; vertical-align: middle;">Admin-Einstellungen</h1>
                    <p style="font-size: 14px; color: var(--color-text-secondary); margin-top: 4px;">
                        Werkstatt-Profil, Benachrichtigungen, System-Konfiguration
                    </p>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" id="dark-mode-toggle" title="Theme umschalten">
                    <i data-feather="moon"></i>
                    <span class="sr-only">Aktuelles Theme: Hell</span>
                </button>
                <button class="btn btn-secondary" onclick="loadAllSettings()" title="Neu laden">
                    <i data-feather="refresh-cw"></i>
                </button>
                <button class="btn btn-primary" onclick="saveAllSettings()" title="Alle Speichern">
                    <i data-feather="save"></i>
                    Speichern
                </button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs-container">
            <div class="tabs">
                <button class="tab active" data-tab="profil" onclick="switchTab('profil')">
                    <i data-feather="briefcase" style="width: 16px; height: 16px;"></i>
                    Werkstatt-Profil
                </button>
                <button class="tab" data-tab="benachrichtigungen" onclick="switchTab('benachrichtigungen')">
                    <i data-feather="bell" style="width: 16px; height: 16px;"></i>
                    Benachrichtigungen
                </button>
                <button class="tab" data-tab="standards" onclick="switchTab('standards')">
                    <i data-feather="settings" style="width: 16px; height: 16px;"></i>
                    Standard-Werte
                </button>
                <button class="tab" data-tab="emailvorlagen" onclick="switchTab('emailvorlagen')">
                    <i data-feather="mail" style="width: 16px; height: 16px;"></i>
                    E-Mail-Vorlagen
                </button>
                <button class="tab" data-tab="systemconfig" onclick="switchTab('systemconfig')">
                    <i data-feather="server" style="width: 16px; height: 16px;"></i>
                    System-Config
                </button>
                <button class="tab" data-tab="backup" onclick="switchTab('backup')">
                    <i data-feather="download" style="width: 16px; height: 16px;"></i>
                    Backup & Export
                </button>
                <button class="tab" data-tab="wartung" onclick="switchTab('wartung')">
                    <i data-feather="database" style="width: 16px; height: 16px;"></i>
                    Datenbank-Wartung
                </button>
            </div>
        </div>

        <!-- Section 1: Werkstatt-Profil -->
        <div id="section-profil" class="content-section active">
            <div class="card">
                <h2 class="card-title">
                    <i data-feather="briefcase"></i>
                    Werkstatt-Profil
                </h2>
                <p class="card-description">
                    Grundlegende Informationen über Ihre Werkstatt. Diese Daten werden in E-Mails, PDFs und der Website angezeigt.
                </p>

                <div class="form-group">
                    <label class="form-label">Logo <span class="required">*</span></label>
                    <div class="file-upload">
                        <div class="file-upload-preview" id="logoPreview">
                            <i data-feather="image" style="width: 40px; height: 40px; color: var(--color-text-tertiary);"></i>
                        </div>
                        <div>
                            <input type="file" id="logoFile" accept="image/png, image/jpeg, image/jpg, image/svg+xml" style="display: none;" onchange="handleLogoUpload(event)">
                            <button class="btn btn-secondary" onclick="document.getElementById('logoFile').click()">
                                <i data-feather="upload"></i>
                                Logo hochladen
                            </button>
                            <p class="form-hint">PNG, JPG, SVG | Maximal 2MB</p>
                        </div>
                    </div>
                </div>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" for="profilName">Werkstatt-Name <span class="required">*</span></label>
                        <input type="text" id="profilName" class="form-input" placeholder="Auto-Lackierzentrum Mosbach">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="profilEmail">E-Mail <span class="required">*</span></label>
                        <input type="email" id="profilEmail" class="form-input" placeholder="info@werkstatt.de">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="profilTelefon">Telefon</label>
                        <input type="tel" id="profilTelefon" class="form-input" placeholder="+49 6261 123456">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="profilWebsite">Website</label>
                        <input type="url" id="profilWebsite" class="form-input" placeholder="https://werkstatt.de">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="profilAdresse">Adresse</label>
                    <input type="text" id="profilAdresse" class="form-input" placeholder="Musterstraße 1, 74821 Mosbach">
                </div>

                <div class="form-group">
                    <label class="form-label" for="profilDescription">Beschreibung</label>
                    <textarea id="profilDescription" class="form-textarea" placeholder="Kurze Beschreibung Ihrer Werkstatt..."></textarea>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="saveSection('profil')">
                        <i data-feather="save"></i>
                        Speichern
                    </button>
                </div>
            </div>
        </div>

        <!-- Section 2: Benachrichtigungen -->
        <div id="section-benachrichtigungen" class="content-section">
            <div class="card">
                <h2 class="card-title">
                    <i data-feather="bell"></i>
                    Benachrichtigungen
                </h2>
                <p class="card-description">
                    Legen Sie fest, welche Benachrichtigungen Sie erhalten möchten.
                </p>

                <div style="margin-bottom: var(--space-5);">
                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: var(--space-3);">Benachrichtigungs-Kanäle</h3>

                    <div class="toggle-group">
                        <span class="toggle-label">E-Mail Benachrichtigungen</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="notif-email" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="toggle-group">
                        <span class="toggle-label">Push Benachrichtigungen</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="notif-push" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="toggle-group">
                        <span class="toggle-label">In-App Benachrichtigungen</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="notif-inapp" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <div>
                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: var(--space-3);">Ereignisse</h3>

                    <div class="toggle-group">
                        <span class="toggle-label">Neues Fahrzeug angenommen</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="notif-neuesFahrzeug" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="toggle-group">
                        <span class="toggle-label">Status-Änderung</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="notif-statusChange" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="toggle-group">
                        <span class="toggle-label">Abnahme-Termin fällig</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="notif-abnahmeTermin" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="toggle-group">
                        <span class="toggle-label">Material-Bestellung</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="notif-materialBestellung" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="toggle-group">
                        <span class="toggle-label">Partner-Anfrage</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="notif-partnerAnfrage" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>

                <div class="btn-group" style="margin-top: var(--space-5);">
                    <button class="btn btn-primary" onclick="saveSection('benachrichtigungen')">
                        <i data-feather="save"></i>
                        Speichern
                    </button>
                </div>
            </div>
        </div>

        <!-- Section 3: Standard-Werte -->
        <div id="section-standards" class="content-section">
            <div class="card">
                <h2 class="card-title">
                    <i data-feather="settings"></i>
                    Standard-Werte
                </h2>
                <p class="card-description">
                    Legen Sie Standard-Werte für neue Aufträge fest.
                </p>

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" for="stdBearbeitungszeit">Standard-Bearbeitungszeit (Tage)</label>
                        <input type="number" id="stdBearbeitungszeit" class="form-input" value="3" min="1">
                        <p class="form-hint">Wird bei neuen Fahrzeugen vorausgefüllt</p>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="stdWaehrung">Währung</label>
                        <select id="stdWaehrung" class="form-select">
                            <option value="EUR">EUR (€)</option>
                            <option value="USD">USD ($)</option>
                            <option value="GBP">GBP (£)</option>
                            <option value="CHF">CHF (Fr)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="stdZeitzone">Zeitzone</label>
                        <select id="stdZeitzone" class="form-select">
                            <option value="Europe/Berlin">Europe/Berlin (MEZ)</option>
                            <option value="Europe/Vienna">Europe/Vienna</option>
                            <option value="Europe/Zurich">Europe/Zurich</option>
                            <option value="Europe/Amsterdam">Europe/Amsterdam</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="stdSprache">Sprache</label>
                        <select id="stdSprache" class="form-select">
                            <option value="de">Deutsch</option>
                            <option value="en">English</option>
                            <option value="fr">Français</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="stdDatumsformat">Datumsformat</label>
                        <select id="stdDatumsformat" class="form-select">
                            <option value="DD.MM.YYYY">DD.MM.YYYY (31.12.2025)</option>
                            <option value="MM/DD/YYYY">MM/DD/YYYY (12/31/2025)</option>
                            <option value="YYYY-MM-DD">YYYY-MM-DD (2025-12-31)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="stdUhrzeitformat">Uhrzeitformat</label>
                        <select id="stdUhrzeitformat" class="form-select">
                            <option value="HH:mm">24-Stunden (14:30)</option>
                            <option value="hh:mm A">12-Stunden (02:30 PM)</option>
                        </select>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="saveSection('standards')">
                        <i data-feather="save"></i>
                        Speichern
                    </button>
                </div>
            </div>
        </div>

        <!-- Section 4: E-Mail-Vorlagen -->
        <div id="section-emailvorlagen" class="content-section">
            <div class="card">
                <h2 class="card-title">
                    <i data-feather="mail"></i>
                    E-Mail-Vorlagen
                </h2>
                <p class="card-description">
                    Passen Sie Ihre E-Mail-Vorlagen an. Verwenden Sie Platzhalter wie {{kundenName}}, {{fahrzeugMarke}}, {{kennzeichen}}.
                </p>

                <div class="alert alert-info">
                    <i data-feather="info"></i>
                    <div>
                        <strong>Verfügbare Platzhalter:</strong><br>
                        {{kundenName}}, {{fahrzeugMarke}}, {{fahrzeugModell}}, {{kennzeichen}}, {{werkstattName}}, {{fertigstellungDatum}}, {{abholungDatum}}
                    </div>
                </div>

                <!-- Bestätigung -->
                <div style="margin-bottom: var(--space-6);">
                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: var(--space-3);">Auftragsbestätigung</h3>

                    <div class="form-group">
                        <label class="form-label" for="emailBestaetSubject">Betreff</label>
                        <input type="text" id="emailBestaetSubject" class="form-input" placeholder="Auftragsbestätigung - {{fahrzeugMarke}} {{fahrzeugModell}}">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="emailBestaetBody">Nachricht</label>
                        <textarea id="emailBestaetBody" class="form-textarea" rows="6" placeholder="Sehr geehrte/r {{kundenName}},..."></textarea>
                    </div>
                </div>

                <!-- Erinnerung -->
                <div style="margin-bottom: var(--space-6);">
                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: var(--space-3);">Erinnerung Abholung</h3>

                    <div class="form-group">
                        <label class="form-label" for="emailErinnerungSubject">Betreff</label>
                        <input type="text" id="emailErinnerungSubject" class="form-input" placeholder="Erinnerung: Abholung {{fahrzeugMarke}} {{fahrzeugModell}}">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="emailErinnerungBody">Nachricht</label>
                        <textarea id="emailErinnerungBody" class="form-textarea" rows="6"></textarea>
                    </div>
                </div>

                <!-- Abschluss -->
                <div style="margin-bottom: var(--space-6);">
                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: var(--space-3);">Abschluss & Dankeschön</h3>

                    <div class="form-group">
                        <label class="form-label" for="emailAbschlussSubject">Betreff</label>
                        <input type="text" id="emailAbschlussSubject" class="form-input" placeholder="Vielen Dank für Ihren Auftrag">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="emailAbschlussBody">Nachricht</label>
                        <textarea id="emailAbschlussBody" class="form-textarea" rows="6"></textarea>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="saveSection('emailvorlagen')">
                        <i data-feather="save"></i>
                        Speichern
                    </button>
                    <button class="btn btn-secondary" onclick="resetEmailTemplates()">
                        <i data-feather="rotate-ccw"></i>
                        Auf Standard zurücksetzen
                    </button>
                </div>
            </div>
        </div>

        <!-- Section 5: System-Konfiguration -->
        <div id="section-systemconfig" class="content-section">
            <div class="card">
                <h2 class="card-title">
                    <i data-feather="cpu"></i>
                    OpenAI API-Key
                </h2>
                <p class="card-description">
                    OpenAI API-Key für den KI-Chat-Assistenten.
                </p>

                <div class="alert alert-info">
                    <i data-feather="lock"></i>
                    <div>
                        Der API-Key wird verschlüsselt gespeichert und nur für KI-Anfragen verwendet.
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="openaiKey">API-Key</label>
                    <input type="password" id="openaiKey" class="form-input" placeholder="sk-...">
                    <p class="form-hint">OpenAI API-Key von https://platform.openai.com/api-keys</p>
                </div>

                <div class="form-group">
                    <label class="form-label" for="openaiModel">Modell</label>
                    <select id="openaiModel" class="form-select">
                        <option value="gpt-4-turbo-preview">GPT-4 Turbo (Empfohlen)</option>
                        <option value="gpt-4">GPT-4</option>
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Günstiger)</option>
                    </select>
                </div>

                <div class="toggle-group">
                    <span class="toggle-label">KI-Assistent aktiviert</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="openaiEnabled">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="btn-group" style="margin-top: var(--space-5);">
                    <button class="btn btn-primary" onclick="saveSection('systemconfig')">
                        <i data-feather="save"></i>
                        Speichern
                    </button>
                    <button class="btn btn-secondary" onclick="testOpenAIKey()">
                        <i data-feather="zap"></i>
                        API-Key testen
                    </button>
                </div>

                <div id="openaiTestResult" style="margin-top: var(--space-4);"></div>
            </div>

            <div class="card">
                <h2 class="card-title">
                    <i data-feather="server"></i>
                    Firebase-Einstellungen
                </h2>
                <p class="card-description">
                    Nur zur Information. Diese Einstellungen sind schreibgeschützt.
                </p>

                <div class="form-group">
                    <label class="form-label">Projekt-ID</label>
                    <input type="text" class="form-input" value="auto-lackierzentrum-mosbach" disabled>
                </div>

                <div class="form-group">
                    <label class="form-label">Region</label>
                    <input type="text" class="form-input" value="europe-west1" disabled>
                </div>

                <div class="form-group">
                    <label class="form-label">Firestore Status</label>
                    <input type="text" id="firestoreStatus" class="form-input" value="Verbunden" disabled>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title">
                    <i data-feather="hard-drive"></i>
                    Speicher & Analytics
                </h2>
                <p class="card-description">
                    Konfigurieren Sie Speicherplatz und Analytics.
                </p>

                <div class="form-group">
                    <label class="form-label" for="storageMaxSize">Maximale Speichergröße (MB)</label>
                    <input type="number" id="storageMaxSize" class="form-input" value="500" min="100">
                    <p class="form-hint">Warnung ab diesem Wert</p>
                </div>

                <div class="toggle-group">
                    <span class="toggle-label">Automatisches Backup</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="backupEnabled" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="form-group">
                    <label class="form-label" for="backupFrequency">Backup-Häufigkeit</label>
                    <select id="backupFrequency" class="form-select">
                        <option value="daily">Täglich</option>
                        <option value="weekly" selected>Wöchentlich</option>
                        <option value="monthly">Monatlich</option>
                    </select>
                </div>

                <div class="toggle-group">
                    <span class="toggle-label">Analytics aktiviert</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="analyticsEnabled" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="btn-group" style="margin-top: var(--space-5);">
                    <button class="btn btn-primary" onclick="saveSection('systemconfig')">
                        <i data-feather="save"></i>
                        Speichern
                    </button>
                </div>
            </div>
        </div>

        <!-- Section 6: Backup & Export -->
        <div id="section-backup" class="content-section">
            <div class="card">
                <h2 class="card-title">
                    <i data-feather="download"></i>
                    Backup & Export
                </h2>
                <p class="card-description">
                    Exportieren Sie Ihre Daten als Backup oder für externe Analysen.
                </p>

                <div class="alert alert-info">
                    <i data-feather="info"></i>
                    <div>
                        <strong>Wichtig:</strong> Backups enthalten alle Werkstatt-Daten inkl. Fahrzeuge, Kunden, Mitarbeiter und Einstellungen.
                    </div>
                </div>

                <div style="margin-bottom: var(--space-5);">
                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: var(--space-3);">Schnell-Export</h3>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="exportJSON()">
                            <i data-feather="download"></i>
                            Komplett-Export (JSON)
                        </button>
                        <button class="btn btn-secondary" onclick="exportFahrzeugeCSV()">
                            <i data-feather="file-text"></i>
                            Fahrzeuge (CSV)
                        </button>
                        <button class="btn btn-secondary" onclick="exportKundenCSV()">
                            <i data-feather="users"></i>
                            Kunden (CSV)
                        </button>
                    </div>
                </div>

                <div id="exportStatus" style="margin-top: var(--space-4);"></div>
            </div>
        </div>

        <!-- Section 7: Datenbank-Wartung -->
        <div id="section-wartung" class="content-section">
            <div class="card">
                <h2 class="card-title">
                    <i data-feather="database"></i>
                    Datenbank-Statistiken
                </h2>
                <p class="card-description">
                    Übersicht über Ihre Datenbank-Nutzung.
                </p>

                <div id="dbStatsContainer">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="statFahrzeuge">-</div>
                            <div class="stat-label">Fahrzeuge</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statKunden">-</div>
                            <div class="stat-label">Kunden</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statMitarbeiter">-</div>
                            <div class="stat-label">Mitarbeiter</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statStorage">-</div>
                            <div class="stat-label">Speicher (MB)</div>
                        </div>
                    </div>
                </div>

                <div class="btn-group" style="margin-top: var(--space-5);">
                    <button class="btn btn-secondary" onclick="loadDatabaseStats()">
                        <i data-feather="refresh-cw"></i>
                        Statistiken aktualisieren
                    </button>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title">
                    <i data-feather="trash-2"></i>
                    Datenbank-Wartung
                </h2>
                <p class="card-description">
                    Bereinigen Sie alte Daten, um Speicherplatz freizugeben.
                </p>

                <div class="alert alert-warning">
                    <i data-feather="alert-triangle"></i>
                    <div>
                        <strong>Warnung:</strong> Gelöschte Daten können NICHT wiederhergestellt werden! Erstellen Sie vorher ein Backup.
                    </div>
                </div>

                <div style="margin-bottom: var(--space-5);">
                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: var(--space-3);">Alte Fahrzeuge löschen</h3>
                    <p style="font-size: 14px; color: var(--color-text-secondary); margin-bottom: var(--space-3);">
                        Löscht abgeschlossene Fahrzeuge, die älter als die angegebene Anzahl Tage sind.
                    </p>

                    <div class="form-group" style="max-width: 300px;">
                        <label class="form-label" for="deleteOlderThan">Tage</label>
                        <input type="number" id="deleteOlderThan" class="form-input" value="90" min="30">
                    </div>

                    <button class="btn btn-danger" onclick="deleteOldFahrzeuge()">
                        <i data-feather="trash-2"></i>
                        Alte Fahrzeuge löschen
                    </button>
                </div>

                <div>
                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: var(--space-3); color: var(--color-error);">Danger Zone</h3>

                    <button class="btn btn-danger" onclick="resetAllSettings()">
                        <i data-feather="rotate-ccw"></i>
                        Alle Einstellungen zurücksetzen
                    </button>
                </div>

                <div id="wartungStatus" style="margin-top: var(--space-4);"></div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

    <!-- Firebase Config -->
    <script src="firebase-config.js?v=a4192c4"></script>

    <!-- Auth Manager -->
    <script src="js/auth-manager.js"></script>

    <!-- Settings Manager -->
    <script src="js/settings-manager.js?v=fix002"></script>

    <!-- KI-Chat-Assistent -->
    <div id="aiChatWidget"></div>
    <script src="js/ai-agent-tools.js"></script>
    <script src="js/ai-agent-engine.js"></script>
    <script src="js/ai-chat-widget.js"></script>

    <script>
        // ============================================
        // GLOBAL STATE
        // ============================================

        let currentSettings = null;
        let currentTab = 'profil';

        // ============================================
        // DARK MODE TOGGLE
        // ============================================

        function initThemeToggle() {
            const themeToggle = document.getElementById('dark-mode-toggle');
            if (!themeToggle) {
                console.warn('⚠️ Dark mode toggle button not found in DOM');
                return;
            }

            const icon = themeToggle.querySelector('i[data-feather]');
            const srText = themeToggle.querySelector('.sr-only');

            // Load saved theme preference (default: light)
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeUI(savedTheme);

            // Toggle theme on click
            themeToggle.addEventListener('click', () => {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeUI(newTheme);

                console.log(`🌓 Theme umgeschaltet: ${currentTheme} → ${newTheme}`);
            });

            function updateThemeUI(theme) {
                if (theme === 'dark') {
                    icon.setAttribute('data-feather', 'sun');
                    srText.textContent = 'Aktuelles Theme: Dunkel';
                } else {
                    icon.setAttribute('data-feather', 'moon');
                    srText.textContent = 'Aktuelles Theme: Hell';
                }
                // Re-render Feather icons
                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
            }

            console.log('✅ Dark Mode Toggle initialisiert');
        }

        // ============================================
        // INITIALIZATION
        // ============================================

        window.addEventListener('DOMContentLoaded', async () => {
            console.log('🚀 Admin-Einstellungen wird geladen...');

            // Initialize Dark Mode Toggle
            initThemeToggle();

            // Wait for Firebase
            await waitForFirebase();

            // Wait for Auth Manager (Race Condition Fix)
            console.log('⏳ Warte auf Auth Manager...');
            let authReady = false;
            let attempts = 0;
            const maxAttempts = 20; // 20 * 250ms = 5 seconds

            while (!authReady && attempts < maxAttempts) {
                // Check if authManager exists AND werkstatt is loaded
                const user = window.authManager?.getCurrentUser();
                if (user && user.werkstattId) {
                    authReady = true;
                    console.log('✅ Auth Manager bereit, Werkstatt:', user.werkstattId);
                } else {
                    await new Promise(resolve => setTimeout(resolve, 250));
                    attempts++;
                }
            }

            if (!authReady) {
                console.error('❌ Auth Manager Timeout nach 5 Sekunden');
                showAlert('Auth Manager nicht verfügbar - bitte Seite neu laden', 'danger');
                return;
            }

            // Initialize Settings Manager
            const initialized = await window.settingsManager.init();
            if (!initialized) {
                showAlert('Fehler beim Initialisieren', 'danger');
                return;
            }

            // Load Settings
            await loadAllSettings();

            // Load Database Stats
            await loadDatabaseStats();

            // Initialize Feather Icons
            if (typeof feather !== 'undefined') {
                feather.replace();
            }

            console.log('✅ Admin-Einstellungen geladen');
        });

        async function waitForFirebase() {
            let attempts = 0;
            while (!window.db && attempts < 20) {
                await new Promise(resolve => setTimeout(resolve, 250));
                attempts++;
            }
            if (!window.db) {
                console.error('❌ Firebase konnte nicht initialisiert werden!');
                return false;
            }
            return true;
        }

        // ============================================
        // TAB SWITCHING
        // ============================================

        function switchTab(tabName) {
            console.log('📑 Wechsle zu Tab:', tabName);
            currentTab = tabName;

            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Update sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(`section-${tabName}`).classList.add('active');

            // Refresh Feather Icons
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        }

        // ============================================
        // LOAD SETTINGS
        // ============================================

        async function loadAllSettings() {
            try {
                console.log('📥 Lade Einstellungen...');
                showAlert('Lade Einstellungen...', 'info');

                currentSettings = await window.settingsManager.loadSettings();

                // Load Profil
                document.getElementById('profilName').value = currentSettings.profil.name || '';
                document.getElementById('profilEmail').value = currentSettings.profil.email || '';
                document.getElementById('profilTelefon').value = currentSettings.profil.telefon || '';
                document.getElementById('profilWebsite').value = currentSettings.profil.website || '';
                document.getElementById('profilAdresse').value = currentSettings.profil.adresse || '';
                document.getElementById('profilDescription').value = currentSettings.profil.description || '';

                // Load Logo
                if (currentSettings.profil.logoUrl) {
                    document.getElementById('logoPreview').innerHTML = `<img src="${currentSettings.profil.logoUrl}" alt="Logo">`;

                    // Display Logo in Header
                    const logoContainer = document.getElementById('werkstattLogo');
                    if (logoContainer) {
                        logoContainer.innerHTML = `
                            <img src="${currentSettings.profil.logoUrl}"
                                 alt="${currentSettings.profil.name || 'Werkstatt-Logo'}"
                                 style="height: 32px; width: auto; vertical-align: middle;">
                        `;
                        console.log('✅ [ADMIN-EINSTELLUNGEN] Werkstatt-Logo im Header angezeigt');
                    }
                }

                // Update Page Title
                if (currentSettings.profil.name) {
                    document.title = `${currentSettings.profil.name} | Admin-Einstellungen`;
                }

                // Load Benachrichtigungen
                document.getElementById('notif-email').checked = currentSettings.benachrichtigungen.emailEnabled !== false;
                document.getElementById('notif-push').checked = currentSettings.benachrichtigungen.pushEnabled !== false;
                document.getElementById('notif-inapp').checked = currentSettings.benachrichtigungen.inAppEnabled !== false;
                document.getElementById('notif-neuesFahrzeug').checked = currentSettings.benachrichtigungen.neuesFahrzeug !== false;
                document.getElementById('notif-statusChange').checked = currentSettings.benachrichtigungen.statusChange !== false;
                document.getElementById('notif-abnahmeTermin').checked = currentSettings.benachrichtigungen.abnahmeTermin !== false;
                document.getElementById('notif-materialBestellung').checked = currentSettings.benachrichtigungen.materialBestellung !== false;
                document.getElementById('notif-partnerAnfrage').checked = currentSettings.benachrichtigungen.partnerAnfrage !== false;

                // Load Standards
                document.getElementById('stdBearbeitungszeit').value = currentSettings.standards.bearbeitungszeit || 3;
                document.getElementById('stdWaehrung').value = currentSettings.standards.waehrung || 'EUR';
                document.getElementById('stdZeitzone').value = currentSettings.standards.zeitzone || 'Europe/Berlin';
                document.getElementById('stdSprache').value = currentSettings.standards.sprache || 'de';
                document.getElementById('stdDatumsformat').value = currentSettings.standards.datumsformat || 'DD.MM.YYYY';
                document.getElementById('stdUhrzeitformat').value = currentSettings.standards.uhrzeitformat || 'HH:mm';

                // Load Email-Vorlagen
                document.getElementById('emailBestaetSubject').value = currentSettings.emailVorlagen.bestaetigung.subject || '';
                document.getElementById('emailBestaetBody').value = currentSettings.emailVorlagen.bestaetigung.body || '';
                document.getElementById('emailErinnerungSubject').value = currentSettings.emailVorlagen.erinnerung.subject || '';
                document.getElementById('emailErinnerungBody').value = currentSettings.emailVorlagen.erinnerung.body || '';
                document.getElementById('emailAbschlussSubject').value = currentSettings.emailVorlagen.abschluss.subject || '';
                document.getElementById('emailAbschlussBody').value = currentSettings.emailVorlagen.abschluss.body || '';

                // Load System Config
                document.getElementById('openaiKey').value = currentSettings.systemConfig.openaiKey || '';
                document.getElementById('openaiModel').value = currentSettings.systemConfig.openaiModel || 'gpt-4-turbo-preview';
                document.getElementById('openaiEnabled').checked = currentSettings.systemConfig.openaiEnabled !== false;
                document.getElementById('storageMaxSize').value = currentSettings.systemConfig.storageMaxSize || 500;
                document.getElementById('backupEnabled').checked = currentSettings.systemConfig.backupEnabled !== false;
                document.getElementById('backupFrequency').value = currentSettings.systemConfig.backupFrequency || 'weekly';
                document.getElementById('analyticsEnabled').checked = currentSettings.systemConfig.analyticsEnabled !== false;

                showAlert('✅ Einstellungen geladen', 'success');
                console.log('✅ Einstellungen geladen');
            } catch (error) {
                console.error('❌ Fehler beim Laden:', error);
                showAlert('Fehler beim Laden der Einstellungen', 'danger');
            }
        }

        // ============================================
        // SAVE SETTINGS
        // ============================================

        async function saveAllSettings() {
            try {
                console.log('💾 Speichere alle Einstellungen...');
                showAlert('Speichere Einstellungen...', 'info');

                // Collect all data
                const settings = {
                    profil: {
                        name: document.getElementById('profilName').value,
                        email: document.getElementById('profilEmail').value,
                        telefon: document.getElementById('profilTelefon').value,
                        website: document.getElementById('profilWebsite').value,
                        adresse: document.getElementById('profilAdresse').value,
                        description: document.getElementById('profilDescription').value,
                        logoUrl: currentSettings.profil.logoUrl || ''
                    },
                    benachrichtigungen: {
                        emailEnabled: document.getElementById('notif-email').checked,
                        pushEnabled: document.getElementById('notif-push').checked,
                        inAppEnabled: document.getElementById('notif-inapp').checked,
                        neuesFahrzeug: document.getElementById('notif-neuesFahrzeug').checked,
                        statusChange: document.getElementById('notif-statusChange').checked,
                        abnahmeTermin: document.getElementById('notif-abnahmeTermin').checked,
                        materialBestellung: document.getElementById('notif-materialBestellung').checked,
                        partnerAnfrage: document.getElementById('notif-partnerAnfrage').checked
                    },
                    standards: {
                        bearbeitungszeit: parseInt(document.getElementById('stdBearbeitungszeit').value),
                        waehrung: document.getElementById('stdWaehrung').value,
                        zeitzone: document.getElementById('stdZeitzone').value,
                        sprache: document.getElementById('stdSprache').value,
                        datumsformat: document.getElementById('stdDatumsformat').value,
                        uhrzeitformat: document.getElementById('stdUhrzeitformat').value
                    },
                    emailVorlagen: {
                        bestaetigung: {
                            subject: document.getElementById('emailBestaetSubject').value,
                            body: document.getElementById('emailBestaetBody').value
                        },
                        erinnerung: {
                            subject: document.getElementById('emailErinnerungSubject').value,
                            body: document.getElementById('emailErinnerungBody').value
                        },
                        abschluss: {
                            subject: document.getElementById('emailAbschlussSubject').value,
                            body: document.getElementById('emailAbschlussBody').value
                        }
                    },
                    systemConfig: {
                        openaiKey: document.getElementById('openaiKey').value,
                        openaiModel: document.getElementById('openaiModel').value,
                        openaiEnabled: document.getElementById('openaiEnabled').checked,
                        firebaseRegion: 'europe-west1',
                        storageMaxSize: parseInt(document.getElementById('storageMaxSize').value),
                        backupEnabled: document.getElementById('backupEnabled').checked,
                        backupFrequency: document.getElementById('backupFrequency').value,
                        analyticsEnabled: document.getElementById('analyticsEnabled').checked
                    },
                    createdAt: currentSettings.createdAt,
                    updatedAt: new Date().toISOString(),
                    version: '1.0.0'
                };

                const success = await window.settingsManager.saveSettings(settings);

                if (success) {
                    currentSettings = settings;
                    showAlert('✅ Einstellungen gespeichert', 'success');
                    console.log('✅ Einstellungen gespeichert');
                } else {
                    showAlert('❌ Fehler beim Speichern', 'danger');
                }
            } catch (error) {
                console.error('❌ Fehler beim Speichern:', error);
                showAlert('Fehler beim Speichern: ' + error.message, 'danger');
            }
        }

        async function saveSection(sectionName) {
            try {
                console.log(`💾 Speichere ${sectionName}...`);
                showAlert(`Speichere ${sectionName}...`, 'info');

                let sectionData = {};

                if (sectionName === 'profil') {
                    // Validation: Required fields
                    const name = document.getElementById('profilName').value.trim();
                    const email = document.getElementById('profilEmail').value.trim();

                    if (!name) {
                        showAlert('❌ Werkstatt-Name ist Pflichtfeld', 'danger');
                        console.error('❌ Validation failed: Name ist leer');
                        return;
                    }

                    if (!email) {
                        showAlert('❌ E-Mail ist Pflichtfeld', 'danger');
                        console.error('❌ Validation failed: Email ist leer');
                        return;
                    }

                    // Email Format Validation
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(email)) {
                        showAlert('❌ Ungültige E-Mail-Adresse', 'danger');
                        console.error('❌ Validation failed: Ungültige Email-Format');
                        return;
                    }

                    sectionData = {
                        name: name,
                        email: email,
                        telefon: document.getElementById('profilTelefon').value.trim(),
                        website: document.getElementById('profilWebsite').value.trim(),
                        adresse: document.getElementById('profilAdresse').value.trim(),
                        description: document.getElementById('profilDescription').value.trim(),
                        logoUrl: currentSettings.profil.logoUrl || ''
                    };
                } else if (sectionName === 'benachrichtigungen') {
                    sectionData = {
                        emailEnabled: document.getElementById('notif-email').checked,
                        pushEnabled: document.getElementById('notif-push').checked,
                        inAppEnabled: document.getElementById('notif-inapp').checked,
                        neuesFahrzeug: document.getElementById('notif-neuesFahrzeug').checked,
                        statusChange: document.getElementById('notif-statusChange').checked,
                        abnahmeTermin: document.getElementById('notif-abnahmeTermin').checked,
                        materialBestellung: document.getElementById('notif-materialBestellung').checked,
                        partnerAnfrage: document.getElementById('notif-partnerAnfrage').checked
                    };
                } else if (sectionName === 'standards') {
                    sectionData = {
                        bearbeitungszeit: parseInt(document.getElementById('stdBearbeitungszeit').value),
                        waehrung: document.getElementById('stdWaehrung').value,
                        zeitzone: document.getElementById('stdZeitzone').value,
                        sprache: document.getElementById('stdSprache').value,
                        datumsformat: document.getElementById('stdDatumsformat').value,
                        uhrzeitformat: document.getElementById('stdUhrzeitformat').value
                    };
                } else if (sectionName === 'emailvorlagen') {
                    sectionData = {
                        bestaetigung: {
                            subject: document.getElementById('emailBestaetSubject').value,
                            body: document.getElementById('emailBestaetBody').value
                        },
                        erinnerung: {
                            subject: document.getElementById('emailErinnerungSubject').value,
                            body: document.getElementById('emailErinnerungBody').value
                        },
                        abschluss: {
                            subject: document.getElementById('emailAbschlussSubject').value,
                            body: document.getElementById('emailAbschlussBody').value
                        }
                    };
                } else if (sectionName === 'systemconfig') {
                    sectionData = {
                        openaiKey: document.getElementById('openaiKey').value,
                        openaiModel: document.getElementById('openaiModel').value,
                        openaiEnabled: document.getElementById('openaiEnabled').checked,
                        firebaseRegion: 'europe-west1',
                        storageMaxSize: parseInt(document.getElementById('storageMaxSize').value),
                        backupEnabled: document.getElementById('backupEnabled').checked,
                        backupFrequency: document.getElementById('backupFrequency').value,
                        analyticsEnabled: document.getElementById('analyticsEnabled').checked
                    };
                }

                const success = await window.settingsManager.updateSection(sectionName, sectionData);

                if (success) {
                    showAlert(`✅ ${sectionName} gespeichert`, 'success');
                } else {
                    showAlert(`❌ Fehler beim Speichern von ${sectionName}`, 'danger');
                }
            } catch (error) {
                console.error(`❌ Fehler beim Speichern von ${sectionName}:`, error);
                showAlert('Fehler: ' + error.message, 'danger');
            }
        }

        // ============================================
        // LOGO UPLOAD
        // ============================================

        async function handleLogoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                console.log('📤 Lade Logo hoch...');
                showAlert('Logo wird hochgeladen...', 'info');

                // Validation: File Type
                const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/svg+xml'];
                if (!allowedTypes.includes(file.type)) {
                    showAlert('❌ Nur PNG, JPG, SVG erlaubt', 'danger');
                    event.target.value = ''; // Clear input
                    console.error('❌ Upload failed: Ungültiger Dateityp', file.type);
                    return;
                }

                // Validation: File Size (max 2MB)
                const maxSize = 2 * 1024 * 1024; // 2MB in bytes
                if (file.size > maxSize) {
                    showAlert('❌ Datei zu groß (max 2MB)', 'danger');
                    event.target.value = ''; // Clear input
                    console.error('❌ Upload failed: Datei zu groß', (file.size / 1024 / 1024).toFixed(2) + 'MB');
                    return;
                }

                const logoUrl = await window.settingsManager.uploadLogo(file);

                if (logoUrl) {
                    // Update preview
                    document.getElementById('logoPreview').innerHTML = `<img src="${logoUrl}" alt="Logo">`;

                    // Update in settings
                    currentSettings.profil.logoUrl = logoUrl;
                    await window.settingsManager.updateSection('profil', currentSettings.profil);

                    showAlert('✅ Logo hochgeladen', 'success');
                    console.log('✅ Logo erfolgreich hochgeladen:', logoUrl);
                } else {
                    showAlert('❌ Logo-Upload fehlgeschlagen', 'danger');
                    event.target.value = ''; // Clear input on failure
                    console.error('❌ Upload failed: Keine URL zurückgegeben');
                }
            } catch (error) {
                console.error('❌ Logo-Upload Error:', error);
                showAlert('Fehler: ' + error.message, 'danger');
                event.target.value = ''; // Clear input on error
            }
        }

        // ============================================
        // OPENAI KEY TEST
        // ============================================

        async function testOpenAIKey() {
            const apiKey = document.getElementById('openaiKey').value;
            if (!apiKey) {
                showAlertInContainer('openaiTestResult', 'Bitte API-Key eingeben', 'warning');
                return;
            }

            try {
                showAlertInContainer('openaiTestResult', '🧪 Teste API-Key...', 'info');

                const result = await window.settingsManager.testOpenAIKey(apiKey);

                if (result.success) {
                    showAlertInContainer('openaiTestResult', `✅ ${result.message}`, 'success');
                } else {
                    showAlertInContainer('openaiTestResult', `❌ ${result.message}`, 'danger');
                }
            } catch (error) {
                showAlertInContainer('openaiTestResult', '❌ Fehler beim Testen: ' + error.message, 'danger');
            }
        }

        // ============================================
        // EXPORT FUNCTIONS
        // ============================================

        async function exportJSON() {
            try {
                showAlertInContainer('exportStatus', '📦 Exportiere Daten...', 'info');

                const data = await window.settingsManager.exportAllData();
                const filename = `backup_${window.settingsManager.werkstattId}_${new Date().toISOString().split('T')[0]}.json`;

                window.settingsManager.downloadJSON(data, filename);

                showAlertInContainer('exportStatus', `✅ Export erfolgreich: ${filename}`, 'success');
            } catch (error) {
                console.error('❌ Export Error:', error);
                showAlertInContainer('exportStatus', '❌ Fehler beim Exportieren', 'danger');
            }
        }

        async function exportFahrzeugeCSV() {
            try {
                showAlertInContainer('exportStatus', '📦 Exportiere Fahrzeuge (CSV)...', 'info');

                // Get all vehicles from Firestore
                const snapshot = await window.getCollection('fahrzeuge').get();
                const fahrzeuge = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (fahrzeuge.length === 0) {
                    showAlertInContainer('exportStatus', '⚠️ Keine Fahrzeuge vorhanden', 'warning');
                    return;
                }

                // CSV Header
                let csv = 'ID,Kennzeichen,Marke,Modell,Farbe,Kunde,Status,Aufnahmedatum,Fertigstellungsdatum\n';

                // CSV Rows
                fahrzeuge.forEach(f => {
                    const row = [
                        f.id || '',
                        f.kennzeichen || '',
                        f.marke || '',
                        f.modell || '',
                        f.farbe || '',
                        f.kundenName || '',
                        f.status || '',
                        f.aufnahmeDatum || '',
                        f.fertigstellungDatum || ''
                    ];
                    // Escape CSV values (add quotes if contains comma or quote)
                    csv += row.map(val => {
                        const str = String(val);
                        if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                            return `"${str.replace(/"/g, '""')}"`;
                        }
                        return str;
                    }).join(',') + '\n';
                });

                // Download CSV
                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' }); // BOM for Excel
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `fahrzeuge_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showAlertInContainer('exportStatus', `✅ ${fahrzeuge.length} Fahrzeuge exportiert`, 'success');
                console.log(`✅ CSV-Export erfolgreich: ${fahrzeuge.length} Fahrzeuge`);
            } catch (error) {
                console.error('❌ CSV Export Error:', error);
                showAlertInContainer('exportStatus', '❌ Fehler beim CSV-Export: ' + error.message, 'danger');
            }
        }

        async function exportKundenCSV() {
            try {
                showAlertInContainer('exportStatus', '📦 Exportiere Kunden (CSV)...', 'info');

                // Get all customers from Firestore
                const snapshot = await window.getCollection('kunden').get();
                const kunden = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (kunden.length === 0) {
                    showAlertInContainer('exportStatus', '⚠️ Keine Kunden vorhanden', 'warning');
                    return;
                }

                // CSV Header
                let csv = 'ID,Name,Email,Telefon,Adresse,Firma,B2B-Rabatt,Erstellt am\n';

                // CSV Rows
                kunden.forEach(k => {
                    const row = [
                        k.id || '',
                        k.name || '',
                        k.email || '',
                        k.telefon || '',
                        k.adresse || '',
                        k.firma || '',
                        k.b2bRabatt ? `${k.b2bRabatt}%` : '0%',
                        k.erstelltAm || ''
                    ];
                    // Escape CSV values
                    csv += row.map(val => {
                        const str = String(val);
                        if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                            return `"${str.replace(/"/g, '""')}"`;
                        }
                        return str;
                    }).join(',') + '\n';
                });

                // Download CSV
                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' }); // BOM for Excel
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `kunden_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showAlertInContainer('exportStatus', `✅ ${kunden.length} Kunden exportiert`, 'success');
                console.log(`✅ CSV-Export erfolgreich: ${kunden.length} Kunden`);
            } catch (error) {
                console.error('❌ CSV Export Error:', error);
                showAlertInContainer('exportStatus', '❌ Fehler beim CSV-Export: ' + error.message, 'danger');
            }
        }

        // ============================================
        // DATABASE STATS
        // ============================================

        async function loadDatabaseStats() {
            try {
                console.log('📊 Lade Datenbank-Statistiken...');

                // Show Loading Spinners
                const spinnerHTML = '<div class="spinner" style="margin: 0 auto;"></div>';
                document.getElementById('statFahrzeuge').innerHTML = spinnerHTML;
                document.getElementById('statKunden').innerHTML = spinnerHTML;
                document.getElementById('statMitarbeiter').innerHTML = spinnerHTML;
                document.getElementById('statStorage').innerHTML = spinnerHTML;

                const stats = await window.settingsManager.getDatabaseStats();

                if (stats) {
                    // Update with real values
                    document.getElementById('statFahrzeuge').textContent = stats.fahrzeuge.total;
                    document.getElementById('statKunden').textContent = stats.kunden.total;
                    document.getElementById('statMitarbeiter').textContent = stats.mitarbeiter.total;
                    document.getElementById('statStorage').textContent = (stats.storage.totalSize / 1024 / 1024).toFixed(2);
                    console.log('✅ Statistiken geladen:', stats);
                } else {
                    // Error State: Show question marks
                    document.getElementById('statFahrzeuge').textContent = '?';
                    document.getElementById('statKunden').textContent = '?';
                    document.getElementById('statMitarbeiter').textContent = '?';
                    document.getElementById('statStorage').textContent = '?';
                    console.error('❌ Statistiken konnten nicht geladen werden');
                }
            } catch (error) {
                console.error('❌ Stats Error:', error);
                // Error State: Show error text
                document.getElementById('statFahrzeuge').textContent = 'Fehler';
                document.getElementById('statKunden').textContent = 'Fehler';
                document.getElementById('statMitarbeiter').textContent = 'Fehler';
                document.getElementById('statStorage').textContent = 'Fehler';
            }
        }

        // ============================================
        // DATABASE MAINTENANCE
        // ============================================

        async function deleteOldFahrzeuge() {
            const days = parseInt(document.getElementById('deleteOlderThan').value);

            if (!confirm(`Wirklich ALLE abgeschlossenen Fahrzeuge älter als ${days} Tage löschen?\n\nDies kann NICHT rückgängig gemacht werden!`)) {
                return;
            }

            try {
                showAlertInContainer('wartungStatus', `🗑️ Lösche alte Fahrzeuge...`, 'info');

                const deletedCount = await window.settingsManager.deleteOldFahrzeuge(days);

                showAlertInContainer('wartungStatus', `✅ ${deletedCount} Fahrzeuge gelöscht`, 'success');
                await loadDatabaseStats();
            } catch (error) {
                console.error('❌ Delete Error:', error);
                showAlertInContainer('wartungStatus', '❌ Fehler beim Löschen', 'danger');
            }
        }

        async function resetAllSettings() {
            if (!confirm('Wirklich ALLE Einstellungen auf Standard zurücksetzen?\n\nDies kann NICHT rückgängig gemacht werden!')) {
                return;
            }

            try {
                showAlert('🔄 Setze Einstellungen zurück...', 'info');

                const success = await window.settingsManager.resetToDefaults();

                if (success) {
                    showAlert('✅ Einstellungen zurückgesetzt', 'success');
                    await loadAllSettings();
                } else {
                    showAlert('❌ Fehler beim Zurücksetzen', 'danger');
                }
            } catch (error) {
                console.error('❌ Reset Error:', error);
                showAlert('Fehler: ' + error.message, 'danger');
            }
        }

        function resetEmailTemplates() {
            if (!confirm('E-Mail-Vorlagen auf Standard zurücksetzen?')) {
                return;
            }

            const defaults = {
                bestaetigung: {
                    subject: 'Auftragsbestätigung - {{fahrzeugMarke}} {{fahrzeugModell}}',
                    body: 'Sehr geehrte/r {{kundenName}},\n\nwir haben Ihren Auftrag für {{fahrzeugMarke}} {{fahrzeugModell}} ({{kennzeichen}}) erhalten.\n\nVoraussichtliche Fertigstellung: {{fertigstellungDatum}}\n\nMit freundlichen Grüßen\n{{werkstattName}}'
                },
                erinnerung: {
                    subject: 'Erinnerung: Abholung {{fahrzeugMarke}} {{fahrzeugModell}}',
                    body: 'Sehr geehrte/r {{kundenName}},\n\nIhr Fahrzeug {{fahrzeugMarke}} {{fahrzeugModell}} ({{kennzeichen}}) ist fertig und kann ab {{abholungDatum}} abgeholt werden.\n\nBitte vereinbaren Sie einen Termin.\n\nMit freundlichen Grüßen\n{{werkstattName}}'
                },
                abschluss: {
                    subject: 'Vielen Dank für Ihren Auftrag',
                    body: 'Sehr geehrte/r {{kundenName}},\n\nvielen Dank für Ihren Auftrag.\n\nWir würden uns über eine Bewertung freuen: {{bewertungsLink}}\n\nMit freundlichen Grüßen\n{{werkstattName}}'
                }
            };

            document.getElementById('emailBestaetSubject').value = defaults.bestaetigung.subject;
            document.getElementById('emailBestaetBody').value = defaults.bestaetigung.body;
            document.getElementById('emailErinnerungSubject').value = defaults.erinnerung.subject;
            document.getElementById('emailErinnerungBody').value = defaults.erinnerung.body;
            document.getElementById('emailAbschlussSubject').value = defaults.abschluss.subject;
            document.getElementById('emailAbschlussBody').value = defaults.abschluss.body;

            showAlert('✅ Vorlagen zurückgesetzt (noch nicht gespeichert)', 'success');
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        function showAlert(message, type = 'info') {
            // Create toast notification
            const toast = document.createElement('div');
            toast.className = `alert alert-${type}`;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                max-width: 400px;
                animation: slideInRight 0.3s ease;
            `;
            toast.innerHTML = `
                <i data-feather="${type === 'success' ? 'check-circle' : type === 'danger' ? 'x-circle' : type === 'warning' ? 'alert-triangle' : 'info'}"></i>
                <div>${message}</div>
            `;
            document.body.appendChild(toast);

            if (typeof feather !== 'undefined') {
                feather.replace();
            }

            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function showAlertInContainer(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            if (!container) return;

            container.innerHTML = `
                <div class="alert alert-${type}">
                    <i data-feather="${type === 'success' ? 'check-circle' : type === 'danger' ? 'x-circle' : type === 'warning' ? 'alert-triangle' : 'info'}"></i>
                    <div>${message}</div>
                </div>
            `;

            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        }

        console.log('✅ Admin-Einstellungen Script geladen');
    </script>

    <style>
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>

    <!-- ============================================
         SERVICE WORKER REGISTRATION - Offline-Funktionalität
         ============================================ -->
    <script>
        // Service Worker nur registrieren wenn:
        // 1. Browser unterstützt Service Worker
        // 2. NICHT in Playwright Tests (navigator.webdriver)
        // 3. NICHT auf Emulator-Port (8000)
        if ('serviceWorker' in navigator && !navigator.webdriver && window.location.port !== '8000') {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('./sw.js', {
                        scope: './'
                    });

                    console.log('✅ [SW] Service Worker registriert:', registration.scope);

                    // Update-Handling: Neuen SW aktivieren wenn gefunden
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('🔄 [SW] Update gefunden, installiere...');

                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                console.log('✅ [SW] Update bereit! Seite neu laden für neue Version.');

                                // Optional: Auto-reload nach 3 Sekunden
                                // setTimeout(() => window.location.reload(), 3000);
                            }
                        });
                    });

                } catch (error) {
                    console.error('❌ [SW] Registrierung fehlgeschlagen:', error);
                }
            });
        } else {
            console.log('ℹ️ [SW] Service Worker nicht registriert (Test-Modus oder nicht unterstützt)');
        }
    </script>
</body>
</html>
