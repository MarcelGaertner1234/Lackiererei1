rules_version = '2';

// ====================================================================
// FIREBASE STORAGE RULES - PRODUCTION-READY
// ====================================================================
//
// Diese Rules definieren Zugriff auf Firebase Storage Pfade
//
// DEPLOYMENT:
// firebase deploy --only storage
//
// WICHTIG: Enth√§lt FIX f√ºr Multi-Service CORS-Fehler!
// - Neue Rule: partner-anfragen/{partnerId}/{allPaths=**}
//
// ====================================================================

service firebase.storage {
  match /b/{bucket}/o {

    // Produktionsfotos: Public Read (f√ºr Partner-Integration)
    // Pfad: progress-photos/{fahrzeugId}/{fileName}
    // Verwendet von: kanban.html (Photo Upload w√§hrend Produktion)
    // üõ°Ô∏è SECURITY FIX 2025-11-26 (Pattern 55): Auth + Size + MIME Validation
    match /progress-photos/{fahrzeugId}/{fileName} {
      allow read: if true;  // Partner k√∂nnen Fotos sehen
      allow write: if request.auth != null
                   && request.resource.size < 10 * 1024 * 1024  // Max 10 MB
                   && request.resource.contentType.matches('image/(jpeg|png|webp)')
                   && (request.auth.token.role == 'admin'
                       || request.auth.token.role == 'werkstatt'
                       || request.auth.token.role == 'superadmin'
                       || request.auth.token.role == 'mitarbeiter');
    }

    // Fahrzeug-Fotos (Schadensfotos bei Annahme/Abnahme)
    // Pfad: fahrzeuge/{fahrzeugId}/**
    // Verwendet von: annahme.html, abnahme.html
    // üõ°Ô∏è SECURITY FIX 2025-11-26 (Pattern 56): Auth + MIME Validation hinzugef√ºgt
    match /fahrzeuge/{fahrzeugId}/{allPaths=**} {
      allow read: if true;  // Public Read
      allow write: if request.auth != null
                   && request.resource.size < 10 * 1024 * 1024  // Max 10 MB
                   && request.resource.contentType.matches('image/(jpeg|png|webp)')
                   && (request.auth.token.role == 'admin'
                       || request.auth.token.role == 'werkstatt'
                       || request.auth.token.role == 'superadmin'
                       || request.auth.token.role == 'mitarbeiter');
    }

    // üÜï Partner-Anfragen Fotos (Multi-Service Anfragen)
    // Pfad: partner-anfragen/{partnerId}/**
    // Verwendet von: multi-service-anfrage.html (Mehrere Services pro Fahrzeug)
    // FIX f√ºr CORS-Fehler: Diese Rule fehlte komplett!
    // üÜï FIX #1: Content-Type Validation (2025-11-15) - OHNE Auth-Check (Partner nutzen kein Firebase Auth)
    match /partner-anfragen/{partnerId}/{allPaths=**} {
      allow read: if true;  // Public Read f√ºr Partner
      allow write: if request.resource.size < 10 * 1024 * 1024  // Max 10 MB
                   && request.resource.contentType.matches('image/(jpeg|png|webp)');  // Nur Bilder erlaubt
    }

    // üÜï PDF-SPEICHERUNG (Annahmeformulare)
    // Pfad: pdfs/{fahrzeugId}/{fileName}
    // Verwendet von: annahme.html (PDF-Export nach Fahrzeug-Annahme)
    // FIX 2025-11-13: Diese Rule fehlte ‚Üí 403 Forbidden bei PDF-Upload!
    match /pdfs/{fahrzeugId}/{fileName} {
      allow read: if true;  // Public Read: Partner k√∂nnen PDFs via QR-Code/downloadURL abrufen
      allow write: if request.auth != null
                   && request.resource.size < 50 * 1024 * 1024  // Max 50 MB f√ºr PDFs
                   && (request.auth.token.role == 'admin'
                       || request.auth.token.role == 'werkstatt'
                       || request.auth.token.role == 'superadmin');
    }

    // üÜï Werkstatt-Logos (Admin Upload in Einstellungen)
    // Pfad: werkstatt-logos/{werkstattId}/{fileName}
    // Verwendet von: admin-einstellungen.html (Settings Manager)
    // FIX f√ºr Storage 403 Fehler: Diese Rule fehlte komplett!
    match /werkstatt-logos/{werkstattId}/{fileName} {
      allow read: if true;  // Public Read (Logo wird auf allen Seiten angezeigt)
      allow write: if request.auth != null
                   && request.resource.size < 2 * 1024 * 1024  // Max 2 MB
                   && (request.auth.token.role == 'admin'
                       || request.auth.token.role == 'werkstatt'
                       || request.auth.token.role == 'superadmin');
    }

    // üÜï Angebot-PDFs (Varianten-Angebote aus KVA)
    // Pfad: angebote/{werkstattId}/{fileName}
    // Verwendet von: kva-erstellen.html (PDF-Upload nach KVA-Erstellung)
    // Phase: 2025-11-28 - Zwei separate Varianten-PDFs Feature
    match /angebote/{werkstattId}/{fileName} {
      allow read: if true;  // Public Read: Kunde kann PDFs via anfrage-detail.html abrufen
      allow write: if request.resource.size < 50 * 1024 * 1024  // Max 50 MB f√ºr PDFs
                   && request.resource.contentType == 'application/pdf';  // Nur PDFs erlaubt
      // HINWEIS: Kein Auth-Check weil Partner/Werkstatt kein Firebase Auth nutzen
      // Stattdessen: Size + MIME Validation als Schutz
    }

    // üÜï Material-Verwaltung Fotos (Ersatzteile mit Foto-Dokumentation)
    // Pfad: material_photos/{requestId}/{fileName}
    // Verwendet von: material.html (Foto-Upload f√ºr Materialbestellungen)
    // Phase: 2025-11-12 - Material-Verwaltung Feature
    // üõ°Ô∏è SECURITY FIX 2025-11-26: MIME Validation hinzugef√ºgt
    match /material_photos/{requestId}/{fileName} {
      allow read: if true;  // Public Read (Material-Datenbank sichtbar)
      allow write: if request.auth != null
                   && request.resource.size < 10 * 1024 * 1024  // Max 10 MB
                   && request.resource.contentType.matches('image/(jpeg|png|webp)')
                   && (request.auth.token.role == 'admin'
                       || request.auth.token.role == 'werkstatt'
                       || request.auth.token.role == 'lager'
                       || request.auth.token.role == 'superadmin');
    }

    // üÜï Entw√ºrfe Fotos (2-Stufen Fahrzeugannahme System)
    // Pfad: entwuerfe/{werkstattId}/{entwurfId}/**
    // Verwendet von: entwuerfe-bearbeiten.html (Foto-Upload f√ºr Entw√ºrfe)
    // Phase: 2025-11-17 - Firebase Storage Migration (fixes Firestore 1MB limit)
    match /entwuerfe/{werkstattId}/{entwurfId}/{allPaths=**} {
      allow read: if true;  // Public Read (Partner k√∂nnen Fotos in KVA sehen)
      allow write: if request.auth != null
                   && request.resource.size < 5 * 1024 * 1024  // Max 5 MB per photo
                   && request.resource.contentType.matches('image/(jpeg|jpg|png|webp)')  // Nur Bilder
                   && (request.auth.token.role == 'admin'
                       || request.auth.token.role == 'werkstatt'
                       || request.auth.token.role == 'superadmin');
      allow delete: if request.auth != null
                    && (request.auth.token.role == 'admin'
                        || request.auth.token.role == 'werkstatt'
                        || request.auth.token.role == 'superadmin');
    }

    // üÜï Entwurf-PDFs (Fahrzeugannahme Entw√ºrfe als PDF)
    // Pfad: entwurf-pdfs/{werkstattId}/{fileName}
    // Verwendet von: annahme.html (saveAsDraftWithPDF)
    // Phase: 2025-12-03 - PDF-Archivierung in Firebase Storage
    match /entwurf-pdfs/{werkstattId}/{fileName} {
      allow read: if true;  // Public Read (Partner k√∂nnen PDF via Link abrufen)
      allow write: if request.auth != null
                   && request.resource.size < 50 * 1024 * 1024  // Max 50 MB f√ºr PDFs
                   && request.resource.contentType == 'application/pdf'  // Nur PDFs erlaubt
                   && (request.auth.token.role == 'admin'
                       || request.auth.token.role == 'werkstatt'
                       || request.auth.token.role == 'superadmin'
                       || request.auth.token.role == 'mitarbeiter');
    }

    // üÜï Logistik Foto-Protokoll (Fahrzeugzustand bei Abholung/√úbergabe)
    // Pfad: logistik-protokoll/{fahrzeugId}/{fileName}
    // Verwendet von: kanban.html (Logistik-Tab Foto-Dokumentation)
    // Phase: 2025-12-07 - Rechtssicherheit bei Sch√§den-Reklamationen
    match /logistik-protokoll/{fahrzeugId}/{fileName} {
      allow read: if true;  // Public Read (Partner/Kunden k√∂nnen Protokoll einsehen)
      allow write: if request.auth != null
                   && request.resource.size < 10 * 1024 * 1024  // Max 10 MB
                   && request.resource.contentType.matches('image/(jpeg|png|webp)')
                   && (request.auth.token.role == 'admin'
                       || request.auth.token.role == 'werkstatt'
                       || request.auth.token.role == 'superadmin'
                       || request.auth.token.role == 'mitarbeiter');
    }

    // üÜï Design-Dateien (Folierung/Werbebeklebung aus Kalkulation)
    // Pfad: {werkstattId}/designs/{entwurfId}/{serviceTyp}/{fileName}
    // Verwendet von: kalkulation.html (Design-Upload f√ºr Multi-Service KVA)
    // Phase: 2025-12-03 - FIX f√ºr 403 Forbidden bei Design-Upload
    match /{werkstattId}/designs/{entwurfId}/{allPaths=**} {
      allow read: if true;  // Public Read (Partner k√∂nnen Designs in KVA sehen)
      allow write: if request.auth != null
                   && request.resource.size < 10 * 1024 * 1024  // Max 10 MB
                   && request.resource.contentType.matches('image/(jpeg|png|webp)')
                   && (request.auth.token.role == 'admin'
                       || request.auth.token.role == 'werkstatt'
                       || request.auth.token.role == 'superadmin'
                       || request.auth.token.role == 'mitarbeiter');
    }
  }
}

// ====================================================================
// HINWEISE:
// ====================================================================
//
// Max Dateigr√∂√üe: 10 MB (verhindert Missbrauch)
//
// üõ°Ô∏è SECURITY FIX 2025-11-26 (Pattern 55, 56):
// - Authentication: IMPLEMENTIERT f√ºr alle Pfade (au√üer partner-anfragen)
// - MIME-Type Validation: IMPLEMENTIERT f√ºr alle Pfade
// - Erlaubte Rollen: admin, werkstatt, superadmin, mitarbeiter (je nach Pfad)
// - Erlaubte MIME-Types: image/jpeg, image/png, image/webp
//
// Partner-Anfragen haben KEINE Auth-Pr√ºfung weil Partner kein Firebase Auth nutzen.
// Stattdessen: Size + MIME Validation als Schutz.
//
// ====================================================================
