rules_version = '2';

// ====================================================================
// FIREBASE STORAGE RULES - PRODUCTION-READY
// ====================================================================
//
// Diese Rules definieren Zugriff auf Firebase Storage Pfade
//
// DEPLOYMENT:
// firebase deploy --only storage
//
// WICHTIG: Enth√§lt FIX f√ºr Multi-Service CORS-Fehler!
// - Neue Rule: partner-anfragen/{partnerId}/{allPaths=**}
//
// ====================================================================

service firebase.storage {
  match /b/{bucket}/o {

    // Produktionsfotos: Public Read (f√ºr Partner-Integration)
    // Pfad: progress-photos/{fahrzeugId}/{fileName}
    // Verwendet von: kanban.html (Photo Upload w√§hrend Produktion)
    match /progress-photos/{fahrzeugId}/{fileName} {
      allow read: if true;  // Partner k√∂nnen Fotos sehen
      allow write: if true;  // Werkstatt kann Fotos hochladen (tempor√§r)
    }

    // Fahrzeug-Fotos (Schadensfotos bei Annahme/Abnahme)
    // Pfad: fahrzeuge/{fahrzeugId}/**
    // Verwendet von: annahme.html, abnahme.html
    match /fahrzeuge/{fahrzeugId}/{allPaths=**} {
      allow read: if true;  // Public Read
      allow write: if request.resource.size < 10 * 1024 * 1024;  // Max 10 MB
    }

    // üÜï Partner-Anfragen Fotos (Multi-Service Anfragen)
    // Pfad: partner-anfragen/{partnerId}/**
    // Verwendet von: multi-service-anfrage.html (Mehrere Services pro Fahrzeug)
    // FIX f√ºr CORS-Fehler: Diese Rule fehlte komplett!
    match /partner-anfragen/{partnerId}/{allPaths=**} {
      allow read: if true;  // Public Read f√ºr Partner
      allow write: if request.resource.size < 10 * 1024 * 1024;  // Max 10 MB
    }

    // üÜï Werkstatt-Logos (Admin Upload in Einstellungen)
    // Pfad: werkstatt-logos/{werkstattId}/{fileName}
    // Verwendet von: admin-einstellungen.html (Settings Manager)
    // FIX f√ºr Storage 403 Fehler: Diese Rule fehlte komplett!
    match /werkstatt-logos/{werkstattId}/{fileName} {
      allow read: if true;  // Public Read (Logo wird auf allen Seiten angezeigt)
      allow write: if request.auth != null
                   && request.resource.size < 2 * 1024 * 1024  // Max 2 MB
                   && (request.auth.token.role == 'admin'
                       || request.auth.token.role == 'werkstatt'
                       || request.auth.token.role == 'superadmin');
    }
  }
}

// ====================================================================
// HINWEISE:
// ====================================================================
//
// Max Dateigr√∂√üe: 10 MB (verhindert Missbrauch)
// Authentication: Noch nicht implementiert (f√ºr sp√§ter)
//
// Zukunft: Mit Firebase Authentication
// allow write: if request.auth != null &&
//              request.auth.token.email.matches('.*@auto-lackierzentrum\\.de$');
//
// ====================================================================
