â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                    MULTI-SERVICE SYSTEM - COMPLETE BUSINESS LOGIC FLOWCHART                                      â•‘
â•‘                              Auto-Lackierzentrum Mosbach v3.3.0                                                    â•‘
â•‘                                  2025-11-27 Analysis                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
1. THE 12 SERVICE TYPES (Canonical Registry: service-types.js)
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ

  ğŸ¨ LACKIER (Lackierung/Karosserie)
     â”œâ”€ Priority: 1
     â”œâ”€ Category: repair
     â”œâ”€ Display: 'ğŸ¨ Lackierung'
     â””â”€ Aliases: lackierung, lack, karosserie, bodyshop

  ğŸ› REIFEN (Reifen-Service)
     â”œâ”€ Priority: 2
     â”œâ”€ Category: maintenance
     â”œâ”€ Display: 'ğŸ› Reifen-Service'
     â””â”€ Aliases: reifenwechsel, reifenmontage, rÃ¤der, wheels

  ğŸ”§ MECHANIK (Mechanik/Reparatur)
     â”œâ”€ Priority: 3
     â”œâ”€ Category: repair
     â”œâ”€ Display: 'ğŸ”§ Mechanik'
     â””â”€ Aliases: reparatur, werkstatt, instandsetzung

  âœ¨ PFLEGE (Fahrzeugpflege/Aufbereitung)
     â”œâ”€ Priority: 4
     â”œâ”€ Category: maintenance
     â”œâ”€ Display: 'âœ¨ Fahrzeugpflege'
     â””â”€ Aliases: aufbereitung, reinigung, polierung, detailing

  ğŸ“‹ TUEV (TÃœV/HU/AU)
     â”œâ”€ Priority: 5
     â”œâ”€ Category: inspection
     â”œâ”€ Display: 'ğŸ“‹ TÃœV/AU'
     â””â”€ Aliases: tÃ¼v, tauv, tuv, au, hauptuntersuchung, hu

  ğŸ›¡ï¸ VERSICHERUNG (Versicherungsschaden)
     â”œâ”€ Priority: 6
     â”œâ”€ Category: insurance
     â”œâ”€ Display: 'ğŸ›¡ï¸ Versicherungsschaden'
     â””â”€ Aliases: unfall, unfallschaden, insurance, gutachten

  ğŸªŸ GLAS (Glasreparatur)
     â”œâ”€ Priority: 7
     â”œâ”€ Category: repair
     â”œâ”€ Display: 'ğŸªŸ Glasreparatur'
     â””â”€ Aliases: glasschaden, steinschlag, scheibe, windschutzscheibe

  â„ï¸ KLIMA (Klimaservice)
     â”œâ”€ Priority: 8
     â”œâ”€ Category: maintenance
     â”œâ”€ Display: 'â„ï¸ Klimaservice'
     â””â”€ Aliases: klimaanlage, ac, aircon

  ğŸ”¨ DELLEN (Smart Repair/PDR)
     â”œâ”€ Priority: 9
     â”œâ”€ Category: repair
     â”œâ”€ Display: 'ğŸ”¨ DellendrÃ¼cken'
     â””â”€ Aliases: smart-repair, smartrepair, smart_repair, pdr, paintless-dent-removal, beule, beulen

  ğŸŒˆ FOLIERUNG (Fahrzeugfolierung)
     â”œâ”€ Priority: 10
     â”œâ”€ Category: customization
     â”œâ”€ Display: 'ğŸŒˆ Folierung'
     â””â”€ Aliases: wrap, folie, vollfolierung

  ğŸ›¡ï¸ STEINSCHUTZ (Steinschutzfolie/PPF)
     â”œâ”€ Priority: 11
     â”œâ”€ Category: customization
     â”œâ”€ Display: 'ğŸ›¡ï¸ Steinschutzfolie'
     â””â”€ Aliases: lackschutz, ppf, paint-protection, schutzfolie

  ğŸ“¢ WERBEBEKLEBUNG (Fahrzeugbeschriftung)
     â”œâ”€ Priority: 12
     â”œâ”€ Category: customization
     â”œâ”€ Display: 'ğŸ“¢ Werbebeklebung'
     â””â”€ Aliases: werbung, beschriftung, beklebung, lettering


â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
2. DATA STRUCTURE: Fahrzeug Document (Firestore)
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ

fahrzeug: {
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // PRIMARY SERVICE (IMMUTABLE - Set once at creation, NEVER changed after)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  serviceTyp: 'lackier',  âœ… IMMUTABLE
                          â”œâ”€ Set at: Vehicle creation (annahme.html, partner-app/*)
                          â”œâ”€ Protected by: 3-Layer Defense (Pattern #21)
                          â”‚  1. Kanban: Drag-drop blocked between service types
                          â”‚  2. validateServiceTyp(): Auto-correction + fallback to 'lackier'
                          â”‚  3. Comprehensive Audit: 15+ files checked, 0 overwrites found
                          â”œâ”€ Used for: Kanban routing, Security Rules, Service selection
                          â””â”€ Breaking Change Risk: CRITICAL - Changes break Multi-Service Model

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ADDITIONAL SERVICES (MUTABLE - Services added to primary service)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  additionalServices: [  âœ… MUTABLE
    {
      serviceTyp: 'reifen',
      status: 'neu',               // Per-service status
      statusHistory: [],           // Per-service history
      serviceData: {               // Service-specific fields (varies by service type)
        reifenGrÃ¶ÃŸe: '205/55R16',
        saison: 'winter',
        montageTyp: 'vollmontage'
      }
    },
    {
      serviceTyp: 'pflege',
      status: 'in_arbeit',
      statusHistory: [],
      serviceData: {
        paket: 'premium',
        zusatzleistungen: ['polierung', 'versiegelung']
      }
    }
  ],
                          â”œâ”€ Format: Array of Objects (CURRENT - Nov 2024+)
                          â”‚  OLD FORMAT (Legacy): Array of Strings â†’ ['reifen', 'pflege']
                          â”‚  TRANSITION: Auto-migration in hasService() for backward compatibility
                          â”œâ”€ Data Rescue (kanban.html:3805-3850): 
                          â”‚  â€¢ FIX #1: additionalServices undefined â†’ Initialize to []
                          â”‚  â€¢ FIX #2: additionalServices is Object â†’ Convert to Array
                          â”‚  â€¢ FIX #3: Remove primary service duplicate
                          â”œâ”€ Used for: Tab filtering, Service-specific workflows, KVA data
                          â””â”€ Validation: 3-Layer Check (Data Rescue + Lazy Migration)

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // STATUS TRACKING - Per-Service Status (NEW - Nov 2025)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  serviceStatuses: {  âœ… MUTABLE (NEW in Nov 2025)
    'lackier': {       // Primary service status
      status: 'lackierung',
      timestamp: 1699876543000,
      statusHistory: [
        { status: 'angenommen', timestamp: 1699876543000, note: 'Created', user: 'meister' },
        { status: 'vorbereitung', timestamp: 1699876600000, note: 'Started', user: 'mitarbeiter1' },
        { status: 'lackierung', timestamp: 1699876700000, note: 'Painting', user: 'mitarbeiter2' }
      ]
    },
    'reifen': {        // Additional service status (initialized with 'neu')
      status: 'neu',
      timestamp: 1699876543000,
      statusHistory: [
        { status: 'neu', timestamp: 1699876543000, note: 'Auto-init', user: 'system' }
      ]
    },
    'pflege': {
      status: 'in_arbeit',
      timestamp: 1699876700000,
      statusHistory: [...]
    }
  },
                          â”œâ”€ Created by: getServiceStatus() (kanban.html:3474)
                          â”œâ”€ Migration Strategy: Lazy Migration
                          â”‚  â€¢ Checks prozessStatus (legacy) and migrates on-demand
                          â”‚  â€¢ Safe: Only OLD vehicles benefit from migration
                          â”‚  â€¢ Async: Non-blocking migration to Firestore
                          â”œâ”€ Status Per Service: Each service gets independent status
                          â”œâ”€ Status History: All transitions tracked with timestamps + user
                          â””â”€ Completed Statuses: ['fertig', 'bereit', 'abholbereit', 'abgeschlossen']

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // LEGACY FIELDS (Backward Compatibility - For Old Data)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  prozessStatus: 'bereit',  âš ï¸ LEGACY (For vehicles created before Nov 2025)
                            â””â”€ Maps to: serviceStatuses[serviceTyp].status
  statusHistory: [],        âš ï¸ LEGACY (Old flat array)
                            â””â”€ Migrated to: serviceStatuses[serviceTyp].statusHistory

  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // OTHER IMPORTANT FIELDS
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  kennzeichen: 'MB-KA-123',
  kundenname: 'Max Mustermann',
  timestamp: 1699876543000,
  lastModified: 1699876700000,
  createdBy: 'meister',
  lastModifiedBy: 'mitarbeiter1',
  partnerAnfrageId: 'anfrage_12345',  // Links to partner request (Critical for status sync)
}


â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
3. FILTERING LOGIC: Primary Service vs Additional Services (hasService Function)
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ

hasService(fahrzeug, serviceTyp) â†’ Boolean
â”œâ”€ PURPOSE: Check if vehicle has a specific service (primary OR additional)
â”œâ”€ USED BY: Tab filtering (Kanban columns), Service-specific UI sections
â””â”€ LOGIC:

  INPUT: fahrzeug = { serviceTyp: 'lackier', additionalServices: [{serviceTyp: 'reifen'}, {serviceTyp: 'pflege'}] }
         serviceTyp = 'reifen'
  
  EXECUTION:
  Step 1: Check PRIMARY Service
    if (fahrzeug.serviceTyp === serviceTyp)
      â”œâ”€ fahrzeug.serviceTyp = 'lackier'
      â”œâ”€ serviceTyp = 'reifen'
      â””â”€ Result: âŒ NO MATCH

  Step 2: Check ADDITIONAL Services (Array check)
    if (fahrzeug.additionalServices && Array.isArray(fahrzeug.additionalServices))
      â”œâ”€ Check if it's an ARRAY (defensive programming for legacy data)
      â”œâ”€ additionalServices = [{serviceTyp: 'reifen'}, {serviceTyp: 'pflege'}]
      â”œâ”€ Call: additionalServices.some(s => s.serviceTyp === 'reifen')
      â””â”€ Result: âœ… MATCH FOUND!

  Step 3: Return Result
    return true;  âœ… Vehicle HAS the 'reifen' service

DATA RECOVERY (kanban.html:3805-3850):
  Problem 1: additionalServices is undefined (Firestore omits empty arrays)
    Solution: Initialize to [] â†’ hasService() checks work
  
  Problem 2: additionalServices is Object (legacy data type error)
    Solution: Convert Object.values() â†’ Array â†’ hasService() works again
  
  Problem 3: Primary service duplicated in additionalServices
    Solution: Filter out â†’ Keep only unique services


â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
4. STATUS TRACKING: getServiceStatus Function (Multi-Service Status System)
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ

getServiceStatus(fahrzeug, serviceTyp) â†’ String (Status ID)
â”œâ”€ PURPOSE: Get current status for a specific service
â”œâ”€ RETURNS: Status ID (e.g., 'angenommen', 'in_arbeit', 'bereit', 'fertig')
â””â”€ PRIORITY CHAIN (Lazy Migration):

  STEP 1: Check NEW format (serviceStatuses Object)
    if (fahrzeug.serviceStatuses && fahrzeug.serviceStatuses[serviceTyp])
      return fahrzeug.serviceStatuses[serviceTyp].status;  âœ… FOUND
    
  STEP 2: Check LEGACY format (prozessStatus - for old data)
    if (fahrzeug.serviceTyp === serviceTyp && fahrzeug.prozessStatus)
      â”œâ”€ Perform LAZY MIGRATION:
      â”‚  â€¢ Create serviceStatuses object from prozessStatus
      â”‚  â€¢ Save async to Firestore (non-blocking)
      â”‚  â€¢ Return migrated value
      â””â”€ Pattern 57 FIX: Track failures instead of silent warns

  STEP 3: Check if service exists in additionalServices
    const hasAdditionalService = fahrzeug.additionalServices?.some(s => s.serviceTyp === serviceTyp);
    if (hasAdditionalService)
      â”œâ”€ Auto-Initialize serviceStatus with 'neu'
      â”œâ”€ Save async to Firestore
      â””â”€ Pattern 57 FIX: Track failures (Background Sync)

  STEP 4: Default
    return 'neu';  âœ… DEFAULT STATUS for new services

EXAMPLE:
  fahrzeug.serviceTyp = 'lackier'
  fahrzeug.additionalServices = [{serviceTyp: 'reifen'}]
  fahrzeug.serviceStatuses = { lackier: {status: 'in_arbeit', ...} }
  
  Call 1: getServiceStatus(fahrzeug, 'lackier')
    â†’ Check Step 1: serviceStatuses['lackier'] exists
    â†’ Return 'in_arbeit' âœ…
  
  Call 2: getServiceStatus(fahrzeug, 'reifen')
    â†’ Check Step 1: serviceStatuses['reifen'] NOT found
    â†’ Check Step 2: Not primary service
    â†’ Check Step 3: Found in additionalServices
    â†’ Auto-init: serviceStatuses['reifen'] = { status: 'neu', ... }
    â†’ Save to Firestore
    â†’ Return 'neu' âœ…


â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
5. KANBAN COLUMNS: Service-Specific Workflows (processDefinitions)
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ

KANBAN MASTER VIEW (processDefinitions['alle']):
  ğŸ“¦ Anlieferung
    â”œâ”€ Used by: ALL services
    â””â”€ Color: Cyan (Entry point)

  ğŸ“¥ Neu/Angenommen
    â”œâ”€ Used by: Most services (generic entry)
    â””â”€ Color: Gray

  ğŸ“… Terminiert
    â”œâ”€ Used by: ALL services (scheduling column)
    â”œâ”€ Special: Can be set from 'angenommen'/'neu' at ANY time
    â””â”€ Color: Gray

  ğŸ”§ Vorbereitung
    â”œâ”€ Used by: lackier, folierung, steinschutz
    â””â”€ Color: Blue

  âš™ï¸ In Arbeit
    â”œâ”€ Used by: lackier, folierung, steinschutz
    â””â”€ Color: Blue

  ğŸ” QualitÃ¤t / QualitÃ¤tskontrolle
    â”œâ”€ Used by: ALL services (QC is universal)
    â””â”€ Color: Orange

  âœ… Fertig/Bereit/Abholbereit
    â”œâ”€ Used by: ALL services
    â”œâ”€ Variants: 'bereit' (lackier), 'fertig' (others), 'abholbereit' (tuev)
    â””â”€ Color: Green

  
SERVICE-SPECIFIC WORKFLOWS:

  ğŸ¨ LACKIERUNG (8 Columns):
    ğŸ“¦ Anlieferung
      â†’ ğŸ“‹ Angenommen
      â†’ ğŸ“… Terminiert
      â†’ ğŸ”§ Vorbereitung
      â†’ ğŸ¨ Lackierung (Custom!)
      â†’ â±ï¸ Trocknung (Custom!)
      â†’ ğŸ” QualitÃ¤t
      â†’ âœ… Bereit

  ğŸ› REIFEN (8 Columns):
    ğŸ“¦ Anlieferung
      â†’ ğŸ“¥ Eingegangen (Status: 'neu')
      â†’ ğŸ“… Terminiert
      â†’ ğŸ›’ Bestellung
      â†’ ğŸ“¦ Angekommen
      â†’ ğŸ”§ Montage
      â†’ âš–ï¸ Wuchten
      â†’ âœ… Fertig

  ğŸ”§ MECHANIK (9 Columns):
    ğŸ“¦ Anlieferung
      â†’ ğŸ“¥ Eingegangen (Status: 'neu')
      â†’ ğŸ“… Terminiert
      â†’ ğŸ” Diagnose
      â†’ ğŸ’° Angebot
      â†’ âœ… Beauftragt
      â†’ ğŸ”§ Reparatur
      â†’ ğŸ§ª Test
      â†’ âœ… Fertig

  âœ¨ PFLEGE (7 Columns):
    ğŸ“¦ Anlieferung
      â†’ ğŸ“¥ Eingegangen (Status: 'neu')
      â†’ ğŸ“… Terminiert
      â†’ ğŸ—“ï¸ Termin
      â†’ âœ¨ Aufbereitung
      â†’ ğŸ”¬ QualitÃ¤t
      â†’ âœ… Fertig

  ğŸ“‹ TUEV (7 Columns):
    ğŸ“¦ Anlieferung
      â†’ ğŸ“¥ Eingegangen (Status: 'neu')
      â†’ ğŸ“… Terminiert
      â†’ ğŸ—“ï¸ Termin gebucht
      â†’ ğŸ” PrÃ¼fung
      â†’ âœ… Fertig
      â†’ ğŸš— Abholbereit (Custom!)

  ğŸ›¡ï¸ VERSICHERUNG (8 Columns):
    ğŸ“¦ Anlieferung
      â†’ ğŸ“¥ Eingegangen (Status: 'neu')
      â†’ ğŸ“… Terminiert
      â†’ ğŸ“‹ Gutachten
      â†’ âœ… Freigabe
      â†’ ğŸ”§ Reparatur
      â†’ ğŸ”¬ QualitÃ¤t
      â†’ âœ… Fertig

  ğŸªŸ GLAS (8 Columns):
    ğŸ“¦ Anlieferung
      â†’ ğŸ“¥ Eingegangen (Status: 'neu')
      â†’ ğŸ“… Terminiert
      â†’ ğŸ” Begutachtung
      â†’ ğŸ”§ Reparatur
      â†’ â±ï¸ AushÃ¤rten
      â†’ âœ¨ Politur
      â†’ âœ… Fertig

  â„ï¸ KLIMA (8 Columns):
    ğŸ“¦ Anlieferung
      â†’ ğŸ“¥ Eingegangen (Status: 'neu')
      â†’ ğŸ“… Terminiert
      â†’ ğŸ” Diagnose
      â†’ ğŸ”§ Wartung
      â†’ ğŸ’¨ BefÃ¼llen
      â†’ ğŸ§ª Test
      â†’ âœ… Fertig

  ğŸ”¨ DELLEN (8 Columns):
    ğŸ“¦ Anlieferung
      â†’ ğŸ“¥ Eingegangen (Status: 'neu')
      â†’ ğŸ“… Terminiert
      â†’ ğŸ” Begutachtung
      â†’ ğŸ”¨ DrÃ¼ckung
      â†’ âœ¨ Politur
      â†’ ğŸ”¬ QualitÃ¤t
      â†’ âœ… Fertig

  ğŸŒˆ FOLIERUNG (9 Columns):
    ğŸ“¦ Anlieferung
      â†’ ğŸ“‹ Angenommen
      â†’ ğŸ“… Terminiert
      â†’ ğŸ“¦ Material beschafft
      â†’ ğŸ”§ Vorbereitung
      â†’ ğŸŒˆ Folierung
      â†’ â±ï¸ Trocknung
      â†’ ğŸ” QualitÃ¤t
      â†’ âœ… Bereit

  ğŸ›¡ï¸ STEINSCHUTZ (9 Columns):
    ğŸ“¦ Anlieferung
      â†’ ğŸ“‹ Angenommen
      â†’ ğŸ“… Terminiert
      â†’ ğŸ“¦ Material bestellt
      â†’ ğŸ§¼ Reinigung
      â†’ ğŸ›¡ï¸ PPF Montage
      â†’ â±ï¸ AushÃ¤rtung
      â†’ ğŸ” Endkontrolle
      â†’ âœ… Bereit

  ğŸ“¢ WERBEBEKLEBUNG (9 Columns):
    ğŸ“¦ Anlieferung
      â†’ ğŸ“‹ Angenommen
      â†’ ğŸ¨ Design-Erstellung
      â†’ âœ… Kunden-Freigabe
      â†’ ğŸ–¨ï¸ Produktion
      â†’ ğŸ“… Terminiert
      â†’ ğŸ“¢ Beklebung
      â†’ ğŸ” Endkontrolle
      â†’ âœ… Bereit


â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
6. TAB FILTERING LOGIC: How Services Display in Service-Specific Tabs
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ

USER SELECTS TAB: "ğŸ¨ Lackierung" (currentProcess = 'lackier')
  â”œâ”€ ACTION: Filter allFahrzeuge list to show only vehicles with Lackierung service
  â””â”€ LOGIC:

    FOR EACH fahrzeug IN allFahrzeuge:

      STEP 1: Call hasService(fahrzeug, 'lackier')
        â”œâ”€ Check 1: fahrzeug.serviceTyp === 'lackier'?
        â”‚   â”œâ”€ YES â†’ Include in filtered list âœ…
        â”‚   â””â”€ NO â†’ Continue to Check 2
        â”‚
        â”œâ”€ Check 2: fahrzeug.additionalServices.some(s => s.serviceTyp === 'lackier')?
        â”‚   â”œâ”€ YES â†’ Include in filtered list âœ…
        â”‚   â””â”€ NO â†’ EXCLUDE from filtered list âŒ

      STEP 2 (If hasService returns true): Filter by status column
        â”œâ”€ Get service status: getServiceStatus(fahrzeug, 'lackier')
        â”œâ”€ Example: status = 'vorbereitung'
        â”œâ”€ Check if status matches selected column
        â”‚   â”œâ”€ Current column: 'ğŸ”§ Vorbereitung' â†’ Column ID: 'vorbereitung'
        â”‚   â””â”€ Result: fahrzeug.serviceStatuses['lackier'].status === 'vorbereitung' âœ…
        â””â”€ Include in Kanban column

    RESULT: Only vehicles with Lackierung service appear in Lackierung tab


MULTI-SERVICE EXAMPLE:
  
  fahrzeug_01: { serviceTyp: 'lackier', additionalServices: [] }
    hasService(fahrzeug_01, 'lackier') = true  âœ… Show in Lackierung tab
    hasService(fahrzeug_01, 'reifen') = false  âœ… Hide in Reifen tab

  fahrzeug_02: { serviceTyp: 'lackier', additionalServices: [{serviceTyp: 'reifen'}] }
    hasService(fahrzeug_02, 'lackier') = true  âœ… Show in Lackierung tab
    hasService(fahrzeug_02, 'reifen') = true   âœ… Show in Reifen tab (SAME VEHICLE!)

  fahrzeug_03: { serviceTyp: 'reifen', additionalServices: [] }
    hasService(fahrzeug_03, 'lackier') = false âœ… Hide in Lackierung tab
    hasService(fahrzeug_03, 'reifen') = true   âœ… Show in Reifen tab


â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
7. STATUS SYNCHRONIZATION: How Status Changes Propagate
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ

USER DRAGS FAHRZEUG in Kanban â†’ Status Changes
  â”œâ”€ EVENT: Drop fahrzeug from 'vorbereitung' column to 'lackierung' column
  â”œâ”€ CURRENT SERVICE: currentProcess = 'lackier'
  â””â”€ LOGIC:

    STEP 1: Detect new status
      newStatus = 'lackierung'  (Column ID)
      currentService = 'lackier'

    STEP 2: Validate transition (Pattern #50 FIX)
      isValidTransition('lackier', currentStatus, newStatus)
        â”œâ”€ Rule 1: Forward-only (no backward jumps)
        â”œâ”€ Rule 2: Max 2 steps forward (prevent excessive skipping)
        â”œâ”€ Rule 3: Special case: 'terminiert' can be set from 'angenommen'/'neu' anytime
        â””â”€ Result: âœ… Valid or âŒ Invalid (shows warning if invalid)

    STEP 3: Update status in Firestore
      updateData = {
        [`serviceStatuses.${serviceTyp}.status`]: newStatus,
        [`serviceStatuses.${serviceTyp}.timestamp`]: Date.now(),
        [`serviceStatuses.${serviceTyp}.statusHistory`]: FieldValue.arrayUnion({
          status: newStatus,
          timestamp: Date.now(),
          user: getCurrentUserForAudit().user,  // âœ… Bug #8 FIX
          note: 'Kanban drag-drop'
        })
      }
      
      await db.collection('fahrzeuge_mosbach').doc(fahrzeugId).update(updateData);

    STEP 4: Check if ALL services complete (Pattern #14 FIX)
      if (newStatus === 'fertig' || newStatus === 'bereit')
        â”œâ”€ Call: allServicesComplete(fahrzeug, currentService)
        â”œâ”€ Check: Are ALL services (primary + additional) in completed status?
        â”‚   â”œâ”€ Completed statuses: ['fertig', 'bereit', 'abholbereit', 'abgeschlossen']
        â”‚   â”œâ”€ Primary: getServiceStatus(fahrzeug, fahrzeug.serviceTyp) â†’ 'fertig' âœ…
        â”‚   â”œâ”€ Additional 1: getServiceStatus(fahrzeug, 'reifen') â†’ 'neu' âŒ
        â”‚   â””â”€ All Complete? NO (Reifen still pending)
        â”œâ”€ Result: âŒ DO NOT create invoice yet (wait for other services)
        â””â”€ Message: "â³ Warte auf Fertigstellung von Reifen-Service"

    STEP 5 (If ALL services complete):
      â”œâ”€ AUTO TRIGGER: Invoice creation workflow
      â”œâ”€ Call: autoCreateRechnung(fahrzeugId, fahrzeugData)
      â”œâ”€ Result: New Rechnung document created
      â””â”€ User notification: "âœ… Rechnung RE-2025-11-0042 erstellt"


MULTI-SERVICE STATUS SYNC EXAMPLE:

  fahrzeug_02: {
    serviceTyp: 'lackier',
    additionalServices: [{serviceTyp: 'reifen'}],
    serviceStatuses: {
      'lackier': { status: 'vorbereitung' },
      'reifen': { status: 'neu' }
    }
  }

  SCENARIO 1: Lackierung finishes
    User drag: vorbereitung â†’ fertig
    Call: allServicesComplete(fahrzeug_02, 'lackier')
      â”œâ”€ Check: serviceStatuses['lackier'].status â†’ 'fertig' âœ…
      â”œâ”€ Check: serviceStatuses['reifen'].status â†’ 'neu' âŒ
      â””â”€ Result: false (Reifen still pending)
    â†’ âŒ Invoice NOT created (wait for Reifen)

  SCENARIO 2: Reifen finishes
    User drag (in Reifen tab): neu â†’ fertig
    Call: allServicesComplete(fahrzeug_02, 'reifen')
      â”œâ”€ Check: serviceStatuses['lackier'].status â†’ 'fertig' âœ…
      â”œâ”€ Check: serviceStatuses['reifen'].status â†’ 'fertig' âœ…
      â””â”€ Result: true (ALL services complete)
    â†’ âœ… Invoice CREATED automatically


â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
8. COMPLETE VEHICLE LIFECYCLE: From Creation to Completion
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ

PHASE 1: VEHICLE INTAKE (annahme.html, partner-app/*/anfrage.html)
  â”‚
  â”œâ”€ ACTION: User submits vehicle intake form
  â”‚   â”œâ”€ Primary Service: Select from 12 services (radiobutton)
  â”‚   â””â”€ Additional Services: Multi-checkbox (multi-service-anfrage.html)
  â”‚
  â”œâ”€ CREATION: fahrzeug document in Firestore
  â”‚   â”œâ”€ serviceTyp: 'lackier' (IMMUTABLE)
  â”‚   â”œâ”€ additionalServices: [{serviceTyp: 'reifen'}, ...] (MUTABLE)
  â”‚   â”œâ”€ serviceStatuses: {} (Empty initially)
  â”‚   â””â”€ Validation: normalizeAndValidateServiceType() ensures valid serviceTyp
  â”‚
  â””â”€ RESULT: Vehicle appears in Kanban at 'Anlieferung' column


PHASE 2: KANBAN STATUS PROGRESSION (kanban.html)
  â”‚
  â”œâ”€ ACTION: Admin/Meister drag vehicle through workflow columns
  â”‚   â”œâ”€ Example: Anlieferung â†’ Angenommen â†’ Terminiert â†’ Vorbereitung â†’ Lackierung
  â”‚   â””â”€ For each drag:
  â”‚       1. Validate transition (isValidTransition)
  â”‚       2. Update serviceStatus for current service
  â”‚       3. Track user + timestamp + note in statusHistory
  â”‚       4. Check if ALL services complete â†’ Trigger invoice creation
  â”‚
  â”œâ”€ MULTI-SERVICE: Vehicle visible in ALL its service tabs
  â”‚   â”œâ”€ Lackierung tab: Shows fahrzeug (Primary service)
  â”‚   â”œâ”€ Reifen tab: Shows fahrzeug (In additionalServices)
  â”‚   â”œâ”€ Pflege tab: Shows fahrzeug (In additionalServices)
  â”‚   â””â”€ Each service has independent status + workflow
  â”‚
  â””â”€ RESULT: Vehicle progresses through both service workflows in parallel


PHASE 3: COMPLETION & INVOICE CREATION (kanban.html, functions/index.js)
  â”‚
  â”œâ”€ TRIGGER: When ALL services reach completed status
  â”‚   â”œâ”€ Lackierung: 'fertig' âœ…
  â”‚   â”œâ”€ Reifen: 'fertig' âœ…
  â”‚   â”œâ”€ Pflege: 'fertig' âœ…
  â”‚   â””â”€ Call: allServicesComplete() returns true
  â”‚
  â”œâ”€ AUTO ACTION: Invoice creation workflow
  â”‚   â”œâ”€ Check: allServicesComplete(fahrzeug, currentService)
  â”‚   â”œâ”€ Create: Rechnung document with:
  â”‚   â”‚   â”œâ”€ rechnungsNummer (auto-generated via counter)
  â”‚   â”‚   â”œâ”€ fahrzeugId (reference)
  â”‚   â”‚   â”œâ”€ serviceBreakdown: Per-service costs aggregated
  â”‚   â”‚   â”œâ”€ totalAmount: Sum of all service costs
  â”‚   â”‚   â”œâ”€ status: 'entwurf' (Draft initially)
  â”‚   â”‚   â””â”€ serviceStatuses: Copy of all service statuses at invoice time
  â”‚   â”‚
  â”‚   â””â”€ Result: Rechnung appears in Partner Portal (rechnungen.html)
  â”‚
  â””â”€ RESULT: Partner sees invoice + can accept/reject


PHASE 4: PARTNER RESPONSE (partner-app/rechnungen.html)
  â”‚
  â”œâ”€ ACTION: Partner reviews invoice in Partner Portal
  â”‚   â”œâ”€ View: Service breakdown (cost per service)
  â”‚   â”œâ”€ View: Total amount, payment terms, due date
  â”‚   â””â”€ Action: Accept or Reject invoice
  â”‚
  â”œâ”€ IF ACCEPTED:
  â”‚   â”œâ”€ Update: Rechnung status â†’ 'akzeptiert'
  â”‚   â”œâ”€ Firestore: Create/Update BonusRecord for Partner
  â”‚   â””â”€ Email: Send thank-you confirmation
  â”‚
  â””â”€ IF REJECTED:
      â”œâ”€ Update: Rechnung status â†’ 'abgelehnt'
      â”œâ”€ Reason: Optional note from partner
      â””â”€ Email: Send rejection notice


â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
9. KEY FUNCTIONS SUMMARY (Function Reference Guide)
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ

FUNCTION: hasService(fahrzeug, serviceTyp) â†’ Boolean
  â”œâ”€ FILE: kanban.html:3426
  â”œâ”€ PURPOSE: Check if vehicle has specific service (primary OR additional)
  â”œâ”€ INPUT: fahrzeug object, serviceTyp string
  â”œâ”€ OUTPUT: true/false
  â”œâ”€ USAGE: Tab filtering, Service visibility checks
  â””â”€ PATTERN: Multi-Service Filter

FUNCTION: getServiceStatus(fahrzeug, serviceTyp) â†’ String
  â”œâ”€ FILE: kanban.html:3474
  â”œâ”€ PURPOSE: Get current status for specific service
  â”œâ”€ INPUT: fahrzeug object, serviceTyp string
  â”œâ”€ OUTPUT: Status ID (e.g., 'angenommen', 'in_arbeit', 'fertig')
  â”œâ”€ USAGE: Status display, Kanban column mapping
  â”œâ”€ PATTERN: Lazy Migration (old â†’ new format)
  â””â”€ BUG FIX: Pattern 57 (Track failures)

FUNCTION: allServicesComplete(fahrzeug, currentService) â†’ Boolean
  â”œâ”€ FILE: kanban.html:3560
  â”œâ”€ PURPOSE: Check if ALL services reached completion
  â”œâ”€ INPUT: fahrzeug object, currentService string (for logging)
  â”œâ”€ OUTPUT: true if all services completed, false otherwise
  â”œâ”€ USAGE: Invoice creation trigger
  â”œâ”€ COMPLETED STATUSES: ['fertig', 'bereit', 'abholbereit', 'abgeschlossen']
  â””â”€ PATTERN: Multi-Service Completion Check

FUNCTION: isValidTransition(serviceTyp, currentStatus, newStatus) â†’ Object
  â”œâ”€ FILE: kanban.html:3259
  â”œâ”€ PURPOSE: Validate status transition rules
  â”œâ”€ INPUT: serviceTyp string, currentStatus string, newStatus string
  â”œâ”€ OUTPUT: {isValid: Boolean, reason: String}
  â”œâ”€ RULES:
  â”‚   â”œâ”€ Forward-only (no backward jumps)
  â”‚   â”œâ”€ Max 2 steps forward (prevent skipping)
  â”‚   â””â”€ Special: 'terminiert' can be set from 'angenommen'/'neu' anytime
  â”œâ”€ USAGE: Drag-drop validation, Status update checks
  â””â”€ BUG FIX: Pattern #50

FUNCTION: getCurrentUserForAudit() â†’ Object
  â”œâ”€ FILE: kanban.html:3382
  â”œâ”€ PURPOSE: Get user info for audit trail (replaces broken window.currentUser)
  â”œâ”€ INPUT: None
  â”œâ”€ OUTPUT: {user: String, userId: String|null, rolle: String|null, email: String|null}
  â”œâ”€ LOGIC:
  â”‚   â”œâ”€ Try 1: sessionStorage.mitarbeiter (preferred)
  â”‚   â”œâ”€ Try 2: firebase.auth().currentUser (fallback)
  â”‚   â””â”€ Try 3: 'system' (last resort)
  â”œâ”€ USAGE: Track status changes with user info
  â””â”€ BUG FIX: Pattern #8 (Audit-Trail)

FUNCTION: normalizeAndValidateServiceType(input, fallbackDefault) â†’ String
  â”œâ”€ FILE: service-types.js:355
  â”œâ”€ PURPOSE: Auto-correct typos + validate service type
  â”œâ”€ INPUT: Possibly invalid serviceTyp string
  â”œâ”€ OUTPUT: Valid canonical service type
  â”œâ”€ LOGIC:
  â”‚   â”œâ”€ Normalize (check aliases map)
  â”‚   â”œâ”€ Validate (check canonical values)
  â”‚   â””â”€ Fallback (if invalid, return default)
  â”œâ”€ USAGE: Form submissions, Data validation
  â””â”€ BUG FIX: Pattern #21 (Multi-Service Protection)


â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
10. CRITICAL PATTERNS & BUG FIXES
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ

Pattern #21: Multi-Service serviceTyp Overwrite (CRITICAL - Data Loss!)
  â”œâ”€ Problem: Kanban drag-drop overwrites primary service
  â”œâ”€ Fix: Removed serviceTyp overwrite, protect with READ-ONLY enforcement
  â””â”€ Prevention: 2-Layer Defense + Comprehensive Audit

Pattern #14: Premature Invoice Creation (Multi-Service)
  â”œâ”€ Problem: Invoice created when only ONE service finished
  â”œâ”€ Fix: allServicesComplete() checks ALL services before invoice creation
  â””â”€ Check: ['fertig', 'bereit', 'abholbereit', 'abgeschlossen']

Pattern #50: Status Transition Validation (CRITICAL!)
  â”œâ”€ Problem: Invalid transitions allowed (backward jumps, excessive skipping)
  â”œâ”€ Fix: isValidTransition() validates all transitions
  â””â”€ Rules: Forward-only, max 2 steps, special 'terminiert' handling

Pattern #8: Audit-Trail Missing (CRITICAL!)
  â”œâ”€ Problem: window.currentUser never initialized â†’ All status changes tracked as 'system'
  â”œâ”€ Fix: getCurrentUserForAudit() with 3-level fallback
  â””â”€ Result: Proper user tracking in statusHistory

Pattern #13: additionalServices Corruption (Data Loss!)
  â”œâ”€ Problem 1: additionalServices undefined (Firestore omits empty arrays)
  â”œâ”€ Problem 2: additionalServices is Object (legacy format)
  â”œâ”€ Problem 3: Primary service duplicated in additionalServices
  â””â”€ Fix: Data Rescue (kanban.html:3805) auto-corrects on load


â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ
11. ARCHITECTURE SUMMARY
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ

DESIGN PRINCIPLES:
  âœ… IMMUTABILITY: Primary service never changes after creation (data integrity)
  âœ… INDEPENDENT STATUS: Each service has own status + workflow (parallelization)
  âœ… BACKWARD COMPATIBILITY: Legacy data automatically migrated (zero breaking changes)
  âœ… LAZY MIGRATION: Old data upgraded on-demand (performance)
  âœ… AUDIT TRAIL: All changes tracked with user + timestamp (DSGVO compliance)
  âœ… VALIDATION: Transitions validated before execution (prevent invalid states)
  âœ… DEFENSIVE PROGRAMMING: Handle array/object type variations (data corruption recovery)

SCALABILITY:
  âœ… 12 services supported natively (with UI templates)
  âœ… Support for infinite additional services per vehicle (scalable array)
  âœ… Per-service workflows (customizable via processDefinitions)
  âœ… Concurrent status tracking (independent service statuses)
  âœ… Performance optimized (lazy loading, caching, async updates)

COMPLIANCE:
  âœ… GDPR-ready audit trail (user tracking, timestamps, change history)
  âœ… Multi-tenant security (werkstattId isolation)
  âœ… Field-level permissions (Security Rules validation)
  âœ… Data recovery mechanisms (3-layer duplicate prevention)


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
END OF FLOWCHART ANALYSIS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
