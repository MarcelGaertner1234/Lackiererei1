<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fahrzeug-Annahme | Auto-Lackierzentrum Mosbach</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #003366;
        }

        .header h1 {
            color: #003366;
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .section-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            margin: 30px 0 20px 0;
            font-size: 18px;
            font-weight: 600;
        }

        .section-title.paint-info {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #003366;
            margin-bottom: 8px;
            font-size: 15px;
        }

        .form-group label .required {
            color: #f5576c;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
            font-family: inherit;
        }

        .form-group input[type="text"]:focus,
        .form-group input[type="number"]:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #003366;
            box-shadow: 0 0 10px rgba(0,51,102,0.1);
        }

        .form-group.highlight {
            background: #fff3cd;
            padding: 15px;
            border-radius: 10px;
            border: 3px solid #ffc107;
        }

        .form-group.highlight label {
            color: #c7254e;
            font-size: 17px;
        }

        .form-group.highlight input {
            font-size: 20px;
            font-weight: 700;
            color: #c7254e;
            border: 3px solid #ffc107;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .radio-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: normal;
            cursor: pointer;
        }

        .radio-group input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .photo-section {
            margin-bottom: 25px;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .photo-item {
            position: relative;
            aspect-ratio: 1;
            border: 2px dashed #ddd;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
        }

        .photo-item:hover {
            border-color: #003366;
            transform: scale(1.05);
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-item.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f5f5f5;
        }

        .photo-item.empty::before {
            content: 'üì∑';
            font-size: 35px;
        }

        .remove-photo {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 16px;
            display: none;
        }

        .photo-item:hover .remove-photo {
            display: block;
        }

        #photoInput {
            display: none;
        }

        .signature-section {
            margin-bottom: 25px;
        }

        #signatureCanvas {
            width: 100%;
            height: 180px;
            border: 2px solid #ddd;
            border-radius: 10px;
            cursor: crosshair;
            touch-action: none;
        }

        .signature-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-clear {
            background: #f5f5f5;
            color: #333;
            flex: 1;
        }

        .btn-clear:hover {
            background: #e0e0e0;
        }

        .btn-save {
            background: #003366;
            color: white;
            font-size: 18px;
            padding: 15px 30px;
            width: 100%;
            margin-top: 20px;
        }

        .btn-save:hover {
            background: #00509e;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,51,102,0.3);
        }

        .btn-arbeitsauftrag {
            background: #ffc107;
            color: #000;
            margin-top: 10px;
        }

        .btn-arbeitsauftrag:hover {
            background: #ffb300;
        }

        .info-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 25px;
            color: #003366;
            font-size: 14px;
        }

        .success-message {
            display: none;
            background: #4caf50;
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .date-display {
            color: #666;
            font-size: 14px;
            text-align: right;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <!-- Firebase Konfiguration -->
    <script src="firebase-config.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöó Fahrzeug-Annahme</h1>
            <p>Auto-Lackierzentrum Mosbach</p>
        </div>

        <div class="date-display">
            Datum: <strong id="currentDate"></strong>
        </div>

        <div class="success-message" id="successMessage">
            ‚úÖ Fahrzeug erfolgreich aufgenommen!
        </div>

        <div class="info-box">
            üí° <strong>Tipp:</strong> F√ºllen Sie alle Fahrzeugdaten und die Farbnummer aus - das erleichtert die Arbeit in der Farbkabine enorm!
        </div>

        <form id="annahmeForm">
            <!-- KUNDENDATEN -->
            <div class="section-title">üë§ Kundendaten</div>

            <div class="form-row">
                <div class="form-group">
                    <label for="kennzeichen">Kennzeichen <span class="required">*</span></label>
                    <input type="text" id="kennzeichen" placeholder="z.B. MOS-CG 123" required>
                </div>

                <div class="form-group">
                    <label for="kundenname">Kundenname <span class="required">*</span></label>
                    <input type="text" id="kundenname" placeholder="z.B. Max Mustermann" required>
                </div>
            </div>

            <!-- FAHRZEUGDATEN -->
            <div class="section-title">üöô Fahrzeugdaten</div>

            <div class="form-row">
                <div class="form-group">
                    <label for="marke">Marke <span class="required">*</span></label>
                    <select id="marke" required>
                        <option value="">-- Bitte w√§hlen --</option>
                        <option value="Audi">Audi</option>
                        <option value="BMW">BMW</option>
                        <option value="Citroen">Citroen</option>
                        <option value="Cupra">Cupra</option>
                        <option value="Fiat">Fiat</option>
                        <option value="Ford">Ford</option>
                        <option value="Honda">Honda</option>
                        <option value="Hyundai">Hyundai</option>
                        <option value="Kia">Kia</option>
                        <option value="Mazda">Mazda</option>
                        <option value="Mercedes-Benz">Mercedes-Benz</option>
                        <option value="MINI">MINI</option>
                        <option value="Nissan">Nissan</option>
                        <option value="Opel">Opel</option>
                        <option value="Peugeot">Peugeot</option>
                        <option value="Porsche">Porsche</option>
                        <option value="Renault">Renault</option>
                        <option value="Seat">Seat</option>
                        <option value="Skoda">Skoda</option>
                        <option value="Suzuki">Suzuki</option>
                        <option value="Toyota">Toyota</option>
                        <option value="Volkswagen">Volkswagen</option>
                        <option value="Volvo">Volvo</option>
                        <option value="Sonstige">Sonstige</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="modell">Modell <span class="required">*</span></label>
                    <input type="text" id="modell" placeholder="z.B. Golf 8, A4, 3er" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="baujahr">Baujahr</label>
                    <select id="baujahr">
                        <option value="">-- Bitte w√§hlen --</option>
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                        <option value="2021">2021</option>
                        <option value="2020">2020</option>
                        <option value="2019">2019</option>
                        <option value="2018">2018</option>
                        <option value="2017">2017</option>
                        <option value="2016">2016</option>
                        <option value="2015">2015</option>
                        <option value="2014">2014</option>
                        <option value="2013">2013</option>
                        <option value="2012">2012</option>
                        <option value="2011">2011</option>
                        <option value="2010">2010</option>
                        <option value="2009">2009</option>
                        <option value="2008">2008</option>
                        <option value="2007">2007</option>
                        <option value="2006">2006</option>
                        <option value="2005">2005</option>
                        <option value="√Ñlter">√Ñlter als 2005</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="kmstand">KM-Stand</label>
                    <input type="number" id="kmstand" placeholder="z.B. 45000">
                </div>
            </div>

            <div class="form-group">
                <label for="vin">VIN/FIN (optional)</label>
                <input type="text" id="vin" placeholder="Fahrgestellnummer">
            </div>

            <!-- ABNAHME-TERMIN -->
            <div class="section-title">üìÖ Geplante Abnahme</div>

            <div class="form-group">
                <label for="geplantesAbnahmeDatum">Voraussichtliches Abnahme-Datum <span class="required">*</span></label>
                <input type="date" id="geplantesAbnahmeDatum" required>
            </div>

            <div class="info-box">
                üí° Das Abnahme-Datum wird im Kalender eingetragen und hilft bei der Arbeitsplanung.
            </div>

            <!-- LACKIER-INFORMATIONEN -->
            <div class="section-title paint-info">üé® Lackier-Informationen</div>

            <div class="form-group">
                <label for="farbname">Farbname</label>
                <input type="text" id="farbname" placeholder="z.B. Silber Metallic, Tiefes Schwarz Perleffekt">
            </div>

            <div class="form-group highlight">
                <label for="farbnummer">üé® FARBNUMMER / FARBCODE <span class="required">*</span></label>
                <input type="text" id="farbnummer" placeholder="z.B. LC9Z, C7A, A96, LY9B" required>
            </div>

            <div class="form-group">
                <label>Lackart <span class="required">*</span></label>
                <div class="radio-group">
                    <label>
                        <input type="radio" name="lackart" value="Uni" required>
                        Uni / Solid
                    </label>
                    <label>
                        <input type="radio" name="lackart" value="Metallic" checked>
                        Metallic
                    </label>
                    <label>
                        <input type="radio" name="lackart" value="Perleffekt">
                        Perleffekt
                    </label>
                </div>
            </div>

            <!-- FOTOS -->
            <div class="section-title">üì∑ Fotos</div>

            <div class="photo-section">
                <label>Schadensfotos (min. 1 Foto erforderlich)</label>
                <div class="photo-grid" id="photoGrid">
                    <div class="photo-item empty" onclick="document.getElementById('photoInput').click()"></div>
                </div>
                <input type="file" id="photoInput" accept="image/*" capture="environment" multiple>
            </div>

            <!-- NOTIZEN -->
            <div class="section-title">üìù Schadensbeschreibung & Preis</div>

            <div class="form-group">
                <label for="notizen">Notizen / Schadensbeschreibung</label>
                <textarea id="notizen" placeholder="z.B. Delle an linker T√ºr, Kratzer am Kotfl√ºgel hinten rechts..."></textarea>
            </div>

            <div class="form-group">
                <label for="vereinbarterPreis">üí∞ Vereinbarter Preis</label>
                <input type="number" id="vereinbarterPreis" placeholder="0.00" step="0.01" min="0" style="font-size: 18px; font-weight: bold; padding: 12px;">
                <small style="color: #666; display: block; margin-top: 5px;">Optional - kann auch sp√§ter hinzugef√ºgt werden</small>
            </div>

            <!-- UNTERSCHRIFT -->
            <div class="section-title">‚úçÔ∏è Unterschrift</div>

            <div class="signature-section">
                <label>Unterschrift Kunde <span class="required">*</span></label>
                <canvas id="signatureCanvas" width="800" height="400"></canvas>
                <div class="signature-buttons">
                    <button type="button" class="btn btn-clear" onclick="clearSignature()">L√∂schen</button>
                </div>
            </div>

            <button type="submit" class="btn btn-save">üíæ Speichern & PDF erstellen</button>
            <button type="button" class="btn btn-save btn-arbeitsauftrag" onclick="createArbeitsauftrag()">üìã Arbeitsauftrag f√ºr Werkstatt drucken</button>
        </form>
    </div>

    <script>
        // Firebase initialisieren
        let firebaseInitialized = false;
        window.addEventListener('load', function() {
            if (typeof firebaseApp !== 'undefined') {
                firebaseInitialized = firebaseApp.init();
                if (firebaseInitialized) {
                    console.log('‚úÖ Firebase f√ºr Annahme initialisiert');
                }
            } else {
                console.warn('‚ö†Ô∏è Firebase-Config nicht gefunden. LocalStorage wird verwendet.');
            }

            // Auto-Save Entwurf wiederherstellen
            loadDraft();
        });

        // Auto-Save: Entwurf speichern bei Eingabe
        let autoSaveTimeout;
        function saveDraft() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                const draft = {
                    kennzeichen: document.getElementById('kennzeichen').value,
                    kundenname: document.getElementById('kundenname').value,
                    marke: document.getElementById('marke').value,
                    modell: document.getElementById('modell').value,
                    baujahr: document.getElementById('baujahr').value,
                    kmstand: document.getElementById('kmstand').value,
                    vin: document.getElementById('vin').value,
                    farbname: document.getElementById('farbname').value,
                    farbnummer: document.getElementById('farbnummer').value,
                    notizen: document.getElementById('notizen').value,
                    vereinbarterPreis: document.getElementById('vereinbarterPreis').value,
                    timestamp: Date.now()
                };

                if (draft.kennzeichen || draft.kundenname || draft.marke) {
                    localStorage.setItem('annahme_draft', JSON.stringify(draft));
                    console.log('üíæ Entwurf gespeichert');
                }
            }, 2000); // Auto-save nach 2 Sekunden Pause
        }

        // Entwurf laden
        function loadDraft() {
            const draft = localStorage.getItem('annahme_draft');
            if (draft) {
                const data = JSON.parse(draft);
                const ageMinutes = (Date.now() - data.timestamp) / 1000 / 60;

                if (ageMinutes < 60 && confirm('üîÑ Entwurf gefunden! M√∂chten Sie Ihre letzte Eingabe wiederherstellen?')) {
                    document.getElementById('kennzeichen').value = data.kennzeichen || '';
                    document.getElementById('kundenname').value = data.kundenname || '';
                    document.getElementById('marke').value = data.marke || '';
                    document.getElementById('modell').value = data.modell || '';
                    document.getElementById('baujahr').value = data.baujahr || '';
                    document.getElementById('kmstand').value = data.kmstand || '';
                    document.getElementById('vin').value = data.vin || '';
                    document.getElementById('farbname').value = data.farbname || '';
                    document.getElementById('farbnummer').value = data.farbnummer || '';
                    document.getElementById('notizen').value = data.notizen || '';
                    document.getElementById('vereinbarterPreis').value = data.vereinbarterPreis || '';
                    console.log('‚úÖ Entwurf wiederhergestellt');
                }
            }
        }

        // Entwurf l√∂schen nach erfolgreichem Speichern
        function clearDraft() {
            localStorage.removeItem('annahme_draft');
        }

        // Auto-Save bei Eingabe aktivieren
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = document.querySelectorAll('#annahmeForm input, #annahmeForm textarea');
            inputs.forEach(input => {
                input.addEventListener('input', saveDraft);
            });
        });

        // Aktuelles Datum anzeigen
        const heute = new Date();
        document.getElementById('currentDate').textContent = heute.toLocaleDateString('de-DE', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });

        // Foto-Upload
        const photoInput = document.getElementById('photoInput');
        const photoGrid = document.getElementById('photoGrid');
        let photos = [];

        // Bild komprimieren (gegen LocalStorage QuotaExceededError)
        async function compressImage(base64Image, maxWidth = 1200, maxHeight = 1200, quality = 0.5) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    let width = img.width;
                    let height = img.height;

                    // Skalierung berechnen
                    if (width > maxWidth || height > maxHeight) {
                        const ratio = Math.min(maxWidth / width, maxHeight / height);
                        width = width * ratio;
                        height = height * ratio;
                    }

                    // Canvas f√ºr Komprimierung
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);

                    // Als JPEG mit reduzierter Qualit√§t
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.src = base64Image;
            });
        }

        photoInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = async function(event) {
                    const compressed = await compressImage(event.target.result);
                    photos.push(compressed);
                    updatePhotoGrid();
                };
                reader.readAsDataURL(file);
            });
            e.target.value = '';
        });

        function updatePhotoGrid() {
            photoGrid.innerHTML = '';
            photos.forEach((photo, index) => {
                const div = document.createElement('div');
                div.className = 'photo-item';
                div.innerHTML = `
                    <img src="${photo}" alt="Foto ${index + 1}">
                    <button class="remove-photo" onclick="removePhoto(${index})">√ó</button>
                `;
                photoGrid.appendChild(div);
            });

            if (photos.length < 10) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'photo-item empty';
                emptyDiv.onclick = () => photoInput.click();
                photoGrid.appendChild(emptyDiv);
            }
        }

        function removePhoto(index) {
            photos.splice(index, 1);
            updatePhotoGrid();
        }

        // Unterschrift Canvas
        const canvas = document.getElementById('signatureCanvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let hasDrawn = false;

        // Canvas initialisieren
        function initCanvas() {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * 2;
            canvas.height = rect.height * 2;
            ctx.scale(2, 2);

            // Zeichenstil
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            // Platzhalter-Text
            if (!hasDrawn) {
                drawPlaceholder();
            }
        }

        function drawPlaceholder() {
            ctx.save();
            ctx.setTransform(1, 0, 0, 1, 0, 0); // Reset transformation
            ctx.fillStyle = '#ccc';
            ctx.font = '20px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('‚úçÔ∏è Hier unterschreiben', canvas.width / 2, canvas.height / 2);
            ctx.restore();
        }

        initCanvas();
        window.addEventListener('resize', initCanvas);

        function getCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            if (e.touches && e.touches.length > 0) {
                return {
                    x: (e.touches[0].clientX - rect.left) * scaleX / 2,
                    y: (e.touches[0].clientY - rect.top) * scaleY / 2
                };
            } else {
                return {
                    x: (e.clientX - rect.left) * scaleX / 2,
                    y: (e.clientY - rect.top) * scaleY / 2
                };
            }
        }

        function startDrawing(e) {
            e.preventDefault();
            isDrawing = true;

            // L√∂sche Platzhalter beim ersten Zeichnen
            if (!hasDrawn) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                hasDrawn = true;
            }

            const coords = getCoordinates(e);
            ctx.beginPath();
            ctx.moveTo(coords.x, coords.y);
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();

            const coords = getCoordinates(e);
            ctx.lineTo(coords.x, coords.y);
            ctx.stroke();
        }

        function stopDrawing(e) {
            if (!isDrawing) return;
            e.preventDefault();
            isDrawing = false;
            ctx.closePath();
        }

        // Mouse Events
        canvas.addEventListener('mousedown', startDrawing, false);
        canvas.addEventListener('mousemove', draw, false);
        canvas.addEventListener('mouseup', stopDrawing, false);
        canvas.addEventListener('mouseleave', stopDrawing, false);

        // Touch Events
        canvas.addEventListener('touchstart', startDrawing, { passive: false });
        canvas.addEventListener('touchmove', draw, { passive: false });
        canvas.addEventListener('touchend', stopDrawing, { passive: false });
        canvas.addEventListener('touchcancel', stopDrawing, { passive: false });

        function clearSignature() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            hasDrawn = false;
            drawPlaceholder();
        }

        // Formular-Daten sammeln
        function getFormData() {
            return {
                id: Date.now(),
                datum: heute.toLocaleDateString('de-DE'),
                zeit: heute.toLocaleTimeString('de-DE'),
                kennzeichen: document.getElementById('kennzeichen').value,
                kundenname: document.getElementById('kundenname').value,
                marke: document.getElementById('marke').value,
                modell: document.getElementById('modell').value,
                baujahr: document.getElementById('baujahr').value,
                kmstand: document.getElementById('kmstand').value,
                vin: document.getElementById('vin').value,
                geplantesAbnahmeDatum: document.getElementById('geplantesAbnahmeDatum').value, // NEU
                farbname: document.getElementById('farbname').value,
                farbnummer: document.getElementById('farbnummer').value,
                lackart: document.querySelector('input[name="lackart"]:checked').value,
                notizen: document.getElementById('notizen').value,
                vereinbarterPreis: parseFloat(document.getElementById('vereinbarterPreis').value) || null,
                photos,
                signature: canvas.toDataURL(),
                status: 'angenommen'
            };
        }

        // Form speichern
        document.getElementById('annahmeForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Validierung
            if (!document.getElementById('kennzeichen').value || !document.getElementById('kundenname').value) {
                alert('Bitte Kennzeichen und Kundenname eingeben!');
                return;
            }

            if (!document.getElementById('marke').value || !document.getElementById('modell').value) {
                alert('Bitte Marke und Modell eingeben!');
                return;
            }

            if (!document.getElementById('farbnummer').value) {
                alert('Bitte Farbnummer eingeben!');
                return;
            }

            if (photos.length === 0) {
                alert('Bitte mindestens 1 Foto machen!');
                return;
            }

            // Pr√ºfe ob Unterschrift vorhanden
            const signatureData = canvas.toDataURL();
            const emptyCanvas = document.createElement('canvas');
            emptyCanvas.width = canvas.width;
            emptyCanvas.height = canvas.height;
            if (signatureData === emptyCanvas.toDataURL()) {
                alert('Bitte Unterschrift des Kunden einholen!');
                return;
            }

            const annahmeData = getFormData();

            // Hybrid-Speicherung: Daten in Firestore, Fotos in LocalStorage
            try {
                if (firebaseInitialized && firebaseApp) {
                    console.log('üíæ Hybrid-Speicherung: Daten ‚Üí Firestore, Fotos ‚Üí LocalStorage');

                    // 1. Fotos in LocalStorage speichern (komprimiert)
                    firebaseApp.savePhotosLocal(annahmeData.id, annahmeData.photos, 'vorher');

                    // 2. Fahrzeugdaten OHNE Fotos in Firestore speichern
                    const dataForFirestore = {...annahmeData};
                    delete dataForFirestore.photos;  // Fotos nicht in Firestore!

                    await firebaseApp.saveFahrzeug(dataForFirestore);
                    console.log('‚úÖ Fahrzeug in Firestore gespeichert (ohne Fotos)');
                    console.log('‚úÖ Fotos in LocalStorage gespeichert');

                    // 3. PDF mit Fotos aus annahmeData erstellen
                    await createPDF(annahmeData);
                } else {
                    // Fallback: LocalStorage verwenden (mit Base64)
                    let fahrzeuge = JSON.parse(localStorage.getItem('fahrzeuge') || '[]');
                    fahrzeuge.push(annahmeData);
                    localStorage.setItem('fahrzeuge', JSON.stringify(fahrzeuge));
                    console.log('‚ÑπÔ∏è Fahrzeug in LocalStorage gespeichert (Firestore nicht verf√ºgbar)');

                    // PDF erstellen
                    await createPDF(annahmeData);
                }
            } catch (error) {
                console.error('‚ùå Fehler beim Speichern:', error);
                // Fallback zu LocalStorage bei Fehler
                let fahrzeuge = JSON.parse(localStorage.getItem('fahrzeuge') || '[]');
                fahrzeuge.push(annahmeData);
                localStorage.setItem('fahrzeuge', JSON.stringify(fahrzeuge));
                console.log('‚ö†Ô∏è Fahrzeug in LocalStorage gespeichert (Firestore-Fehler)');

                // PDF erstellen
                await createPDF(annahmeData);
            }

            // Kalender-Eintrag f√ºr geplante Abnahme erstellen
            if (annahmeData.geplantesAbnahmeDatum) {
                try {
                    await createCalendarEntry(annahmeData);
                    console.log('‚úÖ Kalender-Eintrag erstellt f√ºr', annahmeData.geplantesAbnahmeDatum);
                } catch (error) {
                    console.error('‚ö†Ô∏è Fehler beim Erstellen des Kalender-Eintrags:', error);
                }
            }

            // Entwurf l√∂schen nach erfolgreichem Speichern
            clearDraft();

            // Success-Message
            document.getElementById('successMessage').style.display = 'block';
            setTimeout(() => {
                document.getElementById('successMessage').style.display = 'none';
            }, 3000);

            // Form zur√ºcksetzen
            document.getElementById('annahmeForm').reset();
            photos = [];
            updatePhotoGrid();
            clearSignature();
        });

        // PDF erstellen
        async function createPDF(data) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header
            doc.setFillColor(0, 51, 102);
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.text('Fahrzeug-Annahmeprotokoll', 105, 20, { align: 'center' });
            doc.setFontSize(12);
            doc.text('Auto-Lackierzentrum Mosbach', 105, 30, { align: 'center' });

            // Daten
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(11);
            let y = 50;

            // Kundendaten
            doc.setFont(undefined, 'bold');
            doc.text('Datum:', 20, y);
            doc.setFont(undefined, 'normal');
            doc.text(data.datum + ' ' + data.zeit, 50, y);

            y += 7;
            doc.setFont(undefined, 'bold');
            doc.text('Kennzeichen:', 20, y);
            doc.setFont(undefined, 'normal');
            doc.text(data.kennzeichen, 50, y);

            y += 7;
            doc.setFont(undefined, 'bold');
            doc.text('Kundenname:', 20, y);
            doc.setFont(undefined, 'normal');
            doc.text(data.kundenname, 50, y);

            // Fahrzeugdaten
            y += 12;
            doc.setFillColor(102, 126, 234);
            doc.rect(15, y - 5, 180, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont(undefined, 'bold');
            doc.text('FAHRZEUGDATEN', 20, y);

            y += 10;
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'bold');
            doc.text('Marke:', 20, y);
            doc.setFont(undefined, 'normal');
            doc.text(data.marke, 50, y);
            doc.setFont(undefined, 'bold');
            doc.text('Modell:', 110, y);
            doc.setFont(undefined, 'normal');
            doc.text(data.modell, 140, y);

            y += 7;
            if (data.baujahr) {
                doc.setFont(undefined, 'bold');
                doc.text('Baujahr:', 20, y);
                doc.setFont(undefined, 'normal');
                doc.text(data.baujahr, 50, y);
            }
            if (data.kmstand) {
                doc.setFont(undefined, 'bold');
                doc.text('KM-Stand:', 110, y);
                doc.setFont(undefined, 'normal');
                doc.text(data.kmstand + ' km', 140, y);
            }

            if (data.vin) {
                y += 7;
                doc.setFont(undefined, 'bold');
                doc.text('VIN/FIN:', 20, y);
                doc.setFont(undefined, 'normal');
                doc.text(data.vin, 50, y);
            }

            // LACKIER-INFO (HERVORGEHOBEN)
            y += 12;
            doc.setFillColor(245, 87, 108);
            doc.rect(15, y - 5, 180, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont(undefined, 'bold');
            doc.setFontSize(13);
            doc.text('üé® LACKIER-INFORMATIONEN (F√úR FARBKABINE)', 20, y);

            y += 10;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(11);
            if (data.farbname) {
                doc.setFont(undefined, 'bold');
                doc.text('Farbname:', 20, y);
                doc.setFont(undefined, 'normal');
                doc.text(data.farbname, 55, y);
                y += 7;
            }

            // FARBNUMMER GROSS
            doc.setFillColor(255, 243, 205);
            doc.rect(15, y - 3, 180, 12, 'F');
            doc.setFont(undefined, 'bold');
            doc.setFontSize(14);
            doc.setTextColor(199, 37, 78);
            doc.text('FARBNUMMER:', 20, y + 4);
            doc.setFontSize(18);
            doc.text(data.farbnummer, 70, y + 4);

            y += 15;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('Lackart:', 20, y);
            doc.setFont(undefined, 'normal');
            doc.text(data.lackart, 55, y);

            // Notizen
            if (data.notizen) {
                y += 12;
                doc.setFont(undefined, 'bold');
                doc.text('Schadensbeschreibung / Notizen:', 20, y);
                y += 7;
                doc.setFont(undefined, 'normal');
                const notizen = doc.splitTextToSize(data.notizen, 170);
                doc.text(notizen, 20, y);
                y += notizen.length * 5 + 10;
            } else {
                y += 12;
            }

            // Fotos (Base64 oder URLs)
            const photosForPDF = data.photosBase64 || data.photos || [];

            if (photosForPDF.length > 0) {
                if (y > 220) {
                    doc.addPage();
                    y = 20;
                }

                doc.setFont(undefined, 'bold');
                doc.text('Schadensfotos:', 20, y);
                y += 10;

                for (let i = 0; i < photosForPDF.length; i += 2) {
                    if (y > 230) {
                        doc.addPage();
                        y = 20;
                    }

                    const imgWidth = 80;
                    const imgHeight = 60;

                    doc.addImage(photosForPDF[i], 'JPEG', 20, y, imgWidth, imgHeight);
                    if (i + 1 < photosForPDF.length) {
                        doc.addImage(photosForPDF[i + 1], 'JPEG', 110, y, imgWidth, imgHeight);
                    }

                    y += imgHeight + 10;
                }
            }

            // Unterschrift
            if (y > 210) {
                doc.addPage();
                y = 20;
            }

            y += 5;
            doc.setFont(undefined, 'bold');
            doc.text('Unterschrift Kunde:', 20, y);
            y += 5;
            doc.addImage(data.signature, 'PNG', 20, y, 80, 30);

            // PDF speichern
            const filename = `Annahme_${data.kennzeichen.replace(/\s/g, '_')}_${data.datum.replace(/\./g, '')}.pdf`;
            doc.save(filename);
        }

        // Arbeitsauftrag erstellen (vereinfachtes PDF f√ºr Werkstatt)
        async function createArbeitsauftrag() {
            // Validierung
            if (!document.getElementById('kennzeichen').value || !document.getElementById('marke').value || !document.getElementById('farbnummer').value) {
                alert('Bitte mindestens Kennzeichen, Marke und Farbnummer eingeben!');
                return;
            }

            const data = getFormData();

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header
            doc.setFillColor(255, 193, 7);
            doc.rect(0, 0, 210, 50, 'F');
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(28);
            doc.setFont(undefined, 'bold');
            doc.text('ARBEITSAUFTRAG', 105, 25, { align: 'center' });
            doc.setFontSize(14);
            doc.text('Lackierwerkstatt', 105, 38, { align: 'center' });

            let y = 70;

            // Kennzeichen GROSS
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text('Kennzeichen:', 20, y);
            doc.setFontSize(32);
            doc.text(data.kennzeichen, 105, y, { align: 'center' });

            // Fahrzeug
            y += 20;
            doc.setFontSize(18);
            doc.text('Fahrzeug:', 20, y);
            doc.setFont(undefined, 'normal');
            doc.text(`${data.marke} ${data.modell}`, 70, y);

            // FARBNUMMER - SEHR GROSS
            y += 25;
            doc.setFillColor(255, 243, 205);
            doc.rect(15, y - 10, 180, 30, 'F');
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(199, 37, 78);
            doc.text('üé® FARBNUMMER:', 20, y);
            doc.setFontSize(36);
            doc.text(data.farbnummer, 105, y + 5, { align: 'center' });

            // Lackart
            y += 25;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(16);
            doc.text('Lackart:', 20, y);
            doc.setFont(undefined, 'normal');
            doc.text(data.lackart, 70, y);

            if (data.farbname) {
                y += 10;
                doc.setFont(undefined, 'bold');
                doc.text('Farbname:', 20, y);
                doc.setFont(undefined, 'normal');
                doc.text(data.farbname, 70, y);
            }

            // Notizen
            if (data.notizen) {
                y += 20;
                doc.setFont(undefined, 'bold');
                doc.setFontSize(14);
                doc.text('Schadensbeschreibung:', 20, y);
                y += 8;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(12);
                const notizen = doc.splitTextToSize(data.notizen, 170);
                doc.text(notizen, 20, y);
            }

            // Footer
            doc.setFontSize(10);
            doc.setTextColor(150, 150, 150);
            doc.text('Auto-Lackierzentrum Mosbach', 105, 280, { align: 'center' });
            doc.text(data.datum, 105, 285, { align: 'center' });

            // PDF speichern
            const filename = `Arbeitsauftrag_${data.kennzeichen.replace(/\s/g, '_')}.pdf`;
            doc.save(filename);
        }

        // Kalender-Eintrag erstellen f√ºr geplante Abnahme
        async function createCalendarEntry(fahrzeugData) {
            if (!db) {
                console.warn('Firebase nicht initialisiert, Kalender-Eintrag wird nicht erstellt');
                return;
            }

            const abnahmeDatum = fahrzeugData.geplantesAbnahmeDatum;
            if (!abnahmeDatum) return;

            // Kalender-Eintrag Daten
            const calendarEntry = {
                type: 'abnahme',
                kennzeichen: fahrzeugData.kennzeichen,
                kunde: fahrzeugData.kundenname,
                marke: fahrzeugData.marke,
                modell: fahrzeugData.modell,
                fahrzeugId: fahrzeugData.id.toString()
            };

            // Kalender-Eintrag hinzuf√ºgen (append to existing entries)
            const calendarDoc = await db.collection('calendar').doc(abnahmeDatum).get();

            if (calendarDoc.exists) {
                // Eintrag existiert, neue Abnahme hinzuf√ºgen
                const existingEntries = calendarDoc.data().entries || [];
                existingEntries.push(calendarEntry);
                await db.collection('calendar').doc(abnahmeDatum).update({
                    entries: existingEntries
                });
            } else {
                // Neuer Kalender-Tag
                await db.collection('calendar').doc(abnahmeDatum).set({
                    entries: [calendarEntry]
                });
            }

            console.log('‚úÖ Kalender-Eintrag erstellt f√ºr', abnahmeDatum);
        }
    </script>
</body>
</html>
