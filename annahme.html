<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fahrzeug-Annahme | Auto-Lackierzentrum Mosbach</title>

    <!-- Aggressive No-Cache Headers (Cache-Fix f√ºr v=a4192c4) -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- Design System -->
    <link rel="stylesheet" href="design-system.css?v=af6b90f">
    <link rel="stylesheet" href="components.css?v=af6b90f">
    <link rel="stylesheet" href="animations.css?v=af6b90f">
    <link rel="stylesheet" href="mobile-first.css?v=af6b90f">
    <link rel="stylesheet" href="css/ai-chat-widget.css">

    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body {
            background: var(--color-background);
            min-height: 100vh;
            padding: var(--space-6) var(--space-4) 100px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* Page Header */
        .page-header {
            text-align: center;
            margin-bottom: var(--space-8);
            padding: var(--space-8) var(--space-6);
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        .page-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(255, 255, 255, 0.3) 50%,
                transparent 100%
            );
            opacity: 0.5;
        }

        .page-header h1 {
            font-size: clamp(24px, 5vw, 36px);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin-bottom: var(--space-2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-3);
        }

        .page-header p {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
        }

        .date-display {
            color: var(--color-text-tertiary);
            font-size: var(--font-size-sm);
            text-align: right;
            margin-bottom: var(--space-4);
        }

        /* Form Container */
        .form-container {
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            padding: var(--space-8);
            margin-bottom: var(--space-6);
            position: relative;
            overflow: hidden;
        }

        .form-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(255, 255, 255, 0.3) 50%,
                transparent 100%
            );
            opacity: 0.3;
        }

        /* Section Title with Icon */
        .section-title {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin: var(--space-8) 0 var(--space-6) 0;
            padding-bottom: var(--space-3);
            border-bottom: 1px solid var(--color-border);
        }

        .section-title:first-child {
            margin-top: 0;
        }

        .section-title i {
            width: 24px;
            height: 24px;
            color: var(--color-primary);
        }

        /* Photo Section */
        .photo-section {
            margin-bottom: var(--space-6);
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: var(--space-4);
            margin-top: var(--space-4);
        }

        .photo-item {
            position: relative;
            aspect-ratio: 1;
            border: 2px dashed var(--color-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            cursor: pointer;
            transition: all var(--duration-base) var(--ease-out);
            background: rgba(255, 255, 255, 0.05);
        }

        .photo-item:hover {
            border-color: var(--color-primary);
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(0, 191, 255, 0.2);
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-item.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: var(--space-2);
        }

        .photo-item.empty i {
            width: 40px;
            height: 40px;
            color: var(--color-text-tertiary);
        }

        .photo-item.empty span {
            font-size: var(--font-size-xs);
            color: var(--color-text-tertiary);
        }

        .remove-photo {
            position: absolute;
            top: var(--space-2);
            right: var(--space-2);
            background: var(--color-error);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-size: 20px;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all var(--duration-base) var(--ease-out);
        }

        .remove-photo:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(255, 69, 58, 0.4);
        }

        .photo-item:hover .remove-photo {
            display: flex;
        }

        #photoInput {
            display: none;
        }

        /* Signature Canvas */
        .signature-section {
            margin-bottom: var(--space-6);
        }

        #signatureCanvas {
            width: 100%;
            height: 200px;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-lg);
            cursor: crosshair;
            touch-action: none;
            background: rgba(255, 255, 255, 0.03);
            transition: border-color var(--duration-base) var(--ease-out);
        }

        #signatureCanvas:hover {
            border-color: var(--color-primary);
        }

        .signature-buttons {
            display: flex;
            gap: var(--space-3);
            margin-top: var(--space-3);
        }

        /* Info Box */
        .info-box {
            background: rgba(0, 191, 255, 0.1);
            border: 1px solid rgba(0, 191, 255, 0.3);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin-bottom: var(--space-6);
            display: flex;
            gap: var(--space-3);
            align-items: flex-start;
        }

        .info-box i {
            color: var(--color-primary);
            flex-shrink: 0;
        }

        .info-box-content {
            flex: 1;
        }

        .info-box-content strong {
            color: var(--color-text-primary);
        }

        .info-box-content p {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
            margin: 0;
        }

        /* Success Message */
        .success-message {
            display: none;
            background: var(--color-success);
            color: white;
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            text-align: center;
            margin-bottom: var(--space-6);
            animation: slideDown var(--duration-base) var(--ease-out);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Highlight Form Group */
        .form-group.highlight {
            background: rgba(255, 193, 7, 0.1);
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            border: 2px solid var(--color-warning);
        }

        .form-group.highlight label {
            color: var(--color-warning);
            font-size: var(--font-size-lg);
        }

        .form-group.highlight input {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            border: 2px solid var(--color-warning);
        }

        /* Abholung Details Box */
        #abholungDetails {
            background: rgba(0, 191, 255, 0.05);
            padding: var(--space-5);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(0, 191, 255, 0.2);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: var(--z-fixed);
            background: var(--color-surface-elevated);
            backdrop-filter: blur(var(--glass-blur-strong)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur-strong)) saturate(var(--glass-saturation));
            border-top: 1px solid var(--color-border-glass);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
            padding: var(--space-3);
        }

        .bottom-nav-content {
            max-width: 600px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-2);
        }

        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-2);
            text-decoration: none;
            color: var(--color-text-secondary);
            border-radius: var(--radius-md);
            transition: all var(--duration-base) var(--ease-out);
        }

        .bottom-nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--color-text-primary);
        }

        .bottom-nav-item.active {
            color: var(--color-primary);
            background: rgba(0, 191, 255, 0.1);
        }

        .bottom-nav-item i {
            width: 24px;
            height: 24px;
        }

        .bottom-nav-item span {
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
        }

        /* Submit Buttons Container */
        .submit-buttons {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
            margin-top: var(--space-6);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body {
                padding: var(--space-4) var(--space-3) 100px;
            }

            .form-container {
                padding: var(--space-6) var(--space-4);
            }

            .page-header {
                padding: var(--space-6) var(--space-4);
            }

            .photo-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

    <!-- Firebase Konfiguration -->
    <script src="firebase-config.js?v=a4192c4"></script>

    <!-- Auth Manager f√ºr Multi-Tenant Support -->
    <script src="js/auth-manager.js"></script>

    <!-- Image Optimizer -->
    <script src="image-optimizer.js"></script>

    <!-- Global Chat Notifications -->
    <link rel="stylesheet" href="global-chat-notifications.css">
    <script src="global-chat-notifications.js"></script>

    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>
</head>
<body>
    <!-- THEME TOGGLE BUTTON -->
    <button id="themeToggle" class="theme-toggle" aria-label="Toggle Light/Dark Mode">
        <i data-feather="sun" class="theme-toggle__icon theme-toggle__icon--light"></i>
        <i data-feather="moon" class="theme-toggle__icon theme-toggle__icon--dark"></i>
    </button>

    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1>
                <i data-feather="file-plus"></i>
                Fahrzeug-Annahme
            </h1>
            <p>Auto-Lackierzentrum Mosbach</p>
        </div>

        <div class="date-display">
            Datum: <strong id="currentDate"></strong>
        </div>

        <div class="success-message" id="successMessage">
            ‚úÖ Fahrzeug erfolgreich aufgenommen!
        </div>

        <div class="info-box">
            <i data-feather="info"></i>
            <div class="info-box-content">
                <strong>Tipp:</strong>
                <p>F√ºllen Sie alle Fahrzeugdaten und die Farbnummer aus - das erleichtert die Arbeit in der Farbkabine enorm!</p>
            </div>
        </div>

        <!-- Form -->
        <form id="annahmeForm">
            <div class="form-container">
                <!-- KUNDENDATEN -->
                <div class="section-title">
                    <i data-feather="user"></i>
                    Kundendaten
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="kennzeichen" class="form-label">Kennzeichen <span class="required">*</span></label>
                        <input type="text" id="kennzeichen" class="form-input" placeholder="z.B. MOS-CG 123" required style="text-transform: uppercase;">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Kundenauswahl</label>
                        <select id="kundenDropdown" class="form-select" onchange="selectKunde()">
                            <option value="">üÜï Neuer Kunde</option>
                            <!-- Dynamisch gef√ºllt -->
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="kundenname" class="form-label">Kundenname <span class="required">*</span></label>
                    <input type="text" id="kundenname" class="form-input" placeholder="z.B. Max Mustermann" required>
                </div>

                <div class="form-group">
                    <label for="kundenEmail" class="form-label">Kunden-Email <span class="required">*</span></label>
                    <input type="email" id="kundenEmail" class="form-input" placeholder="z.B. kunde@example.com" required>
                    <small style="color: var(--color-text-tertiary); display: block; margin-top: var(--space-1);">
                        üìß Ben√∂tigt f√ºr automatische Status-Updates per Email
                    </small>
                </div>

                <div class="form-group">
                    <label for="geplantesAbnahmeDatum" class="form-label">Voraussichtliches Abnahme-Datum <span class="required">*</span></label>
                    <input type="date" id="geplantesAbnahmeDatum" class="form-input" required>
                </div>

                <div class="form-group">
                    <label for="serviceTyp" class="form-label">Service-Typ <span class="required">*</span></label>
                    <select id="serviceTyp" class="form-select" required>
                        <option value="lackier">üé® Lackierung</option>
                        <option value="reifen">üîß Reifen-Service</option>
                        <option value="mechanik">‚öôÔ∏è Mechanik</option>
                        <option value="pflege">‚ú® Pflege & Aufbereitung</option>
                        <option value="tuev">üìã T√úV & Pr√ºfung</option>
                        <option value="versicherung">üõ°Ô∏è Versicherungsschaden</option>
                    </select>
                    <small style="color: var(--color-text-tertiary); display: block; margin-top: var(--space-1);">
                        üí° Wichtig f√ºr korrekte Prozess√ºberwachung im Kanban-Board
                    </small>
                </div>

                <!-- ABHOLUNG -->
                <div class="section-title">
                    <i data-feather="truck"></i>
                    Fahrzeug-Abholung
                </div>

                <div class="form-group">
                    <label class="form-label">Fahrzeug abholen?</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="fahrzeugAbholung" value="nein" checked onchange="toggleAbholungDetails()">
                            <span>Nein, Kunde bringt Fahrzeug selbst</span>
                        </label>
                        <label>
                            <input type="radio" name="fahrzeugAbholung" value="ja" onchange="toggleAbholungDetails()">
                            <span>Ja, Fahrzeug abholen</span>
                        </label>
                    </div>
                </div>

                <!-- Conditional Fields -->
                <div id="abholungDetails" style="display: none;">
                    <div class="form-group">
                        <label for="abholadresse" class="form-label">Abholadresse <span class="required">*</span></label>
                        <textarea id="abholadresse" class="form-textarea" placeholder="Stra√üe, Hausnummer&#10;PLZ, Ort" rows="3"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="abholdatum" class="form-label">Gew√ºnschtes Abholdatum</label>
                            <input type="date" id="abholdatum" class="form-input">
                        </div>

                        <div class="form-group">
                            <label for="abholzeit" class="form-label">Gew√ºnschte Abholzeit</label>
                            <input type="time" id="abholzeit" class="form-input">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="abholnotiz" class="form-label">Notiz zur Abholung (optional)</label>
                        <textarea id="abholnotiz" class="form-textarea" placeholder="z.B. Zufahrt, Besonderheiten, Ansprechpartner" rows="2"></textarea>
                    </div>
                </div>

                <!-- FAHRZEUGDATEN -->
                <div class="section-title">
                    <i data-feather="truck"></i>
                    Fahrzeugdaten
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="marke" class="form-label">Marke <span class="required">*</span></label>
                        <select id="marke" class="form-select" required>
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="Audi">Audi</option>
                            <option value="BMW">BMW</option>
                            <option value="Citroen">Citroen</option>
                            <option value="Cupra">Cupra</option>
                            <option value="Fiat">Fiat</option>
                            <option value="Ford">Ford</option>
                            <option value="Honda">Honda</option>
                            <option value="Hyundai">Hyundai</option>
                            <option value="Kia">Kia</option>
                            <option value="Mazda">Mazda</option>
                            <option value="Mercedes-Benz">Mercedes-Benz</option>
                            <option value="MINI">MINI</option>
                            <option value="Nissan">Nissan</option>
                            <option value="Opel">Opel</option>
                            <option value="Peugeot">Peugeot</option>
                            <option value="Porsche">Porsche</option>
                            <option value="Renault">Renault</option>
                            <option value="Seat">Seat</option>
                            <option value="Skoda">Skoda</option>
                            <option value="Suzuki">Suzuki</option>
                            <option value="Toyota">Toyota</option>
                            <option value="Volkswagen">Volkswagen</option>
                            <option value="Volvo">Volvo</option>
                            <option value="Sonstige">Sonstige</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="modell" class="form-label">Modell <span class="required">*</span></label>
                        <input type="text" id="modell" class="form-input" placeholder="z.B. Golf 8, A4, 3er" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Baujahr</label>
                        <div style="display: flex; gap: var(--space-2); align-items: center;">
                            <select id="baujahrVon" class="form-select" style="flex: 1;">
                                <option value="">Von</option>
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                                <option value="2023">2023</option>
                                <option value="2022">2022</option>
                                <option value="2021">2021</option>
                                <option value="2020">2020</option>
                                <option value="2019">2019</option>
                                <option value="2018">2018</option>
                                <option value="2017">2017</option>
                                <option value="2016">2016</option>
                                <option value="2015">2015</option>
                                <option value="2014">2014</option>
                                <option value="2013">2013</option>
                                <option value="2012">2012</option>
                                <option value="2011">2011</option>
                                <option value="2010">2010</option>
                                <option value="2009">2009</option>
                                <option value="2008">2008</option>
                                <option value="2007">2007</option>
                                <option value="2006">2006</option>
                                <option value="2005">2005</option>
                                <option value="2004">2004</option>
                                <option value="2003">2003</option>
                                <option value="2002">2002</option>
                                <option value="2001">2001</option>
                                <option value="2000">2000</option>
                                <option value="√Ñlter">√Ñlter als 2000</option>
                            </select>
                            <span style="font-weight: 600; color: var(--color-text-secondary);">-</span>
                            <select id="baujahrBis" class="form-select" style="flex: 1;">
                                <option value="">Bis</option>
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                                <option value="2023">2023</option>
                                <option value="2022">2022</option>
                                <option value="2021">2021</option>
                                <option value="2020">2020</option>
                                <option value="2019">2019</option>
                                <option value="2018">2018</option>
                                <option value="2017">2017</option>
                                <option value="2016">2016</option>
                                <option value="2015">2015</option>
                                <option value="2014">2014</option>
                                <option value="2013">2013</option>
                                <option value="2012">2012</option>
                                <option value="2011">2011</option>
                                <option value="2010">2010</option>
                                <option value="2009">2009</option>
                                <option value="2008">2008</option>
                                <option value="2007">2007</option>
                                <option value="2006">2006</option>
                                <option value="2005">2005</option>
                                <option value="2004">2004</option>
                                <option value="2003">2003</option>
                                <option value="2002">2002</option>
                                <option value="2001">2001</option>
                                <option value="2000">2000</option>
                                <option value="√Ñlter">√Ñlter als 2000</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="kmstand" class="form-label">KM-Stand</label>
                        <input type="number" id="kmstand" class="form-input" placeholder="z.B. 45000">
                    </div>
                </div>

                <div class="form-group">
                    <label for="vin" class="form-label">VIN/FIN (optional)</label>
                    <input type="text" id="vin" class="form-input" placeholder="Fahrgestellnummer">
                </div>

                <!-- LACKIER-INFORMATIONEN -->
                <div class="section-title">
                    <i data-feather="droplet"></i>
                    Lackier-Informationen
                </div>

                <div class="form-group">
                    <label for="farbname" class="form-label">Farbname</label>
                    <input type="text" id="farbname" class="form-input" placeholder="z.B. Silber Metallic, Tiefes Schwarz Perleffekt">
                </div>

                <div class="form-group">
                    <label for="farbvariante" class="form-label">üî¨ Farbvariante (f√ºr Lackierer)</label>
                    <input type="text" id="farbvariante" class="form-input" list="farbvarianten-liste" placeholder="z.B. Variante A, Mischung 1, Hell abget√∂nt">
                    <datalist id="farbvarianten-liste">
                        <option value="Standard">
                        <option value="Variante A">
                        <option value="Variante B">
                        <option value="Variante C">
                        <option value="Mischung 1">
                        <option value="Mischung 2">
                        <option value="Hell abget√∂nt">
                        <option value="Dunkel abget√∂nt">
                        <option value="Metallic-Effekt">
                        <option value="Matt-Finish">
                    </datalist>
                    <small style="color: var(--color-text-tertiary); font-size: var(--font-size-xs); display: block; margin-top: var(--space-1);">
                        üí° Notiz f√ºr Lackierer: Welche Mischvariante wurde verwendet?
                    </small>
                </div>

                <div class="form-group highlight">
                    <label for="farbnummer" class="form-label">üé® FARBNUMMER / FARBCODE <span class="required">*</span></label>
                    <input type="text" id="farbnummer" class="form-input" placeholder="z.B. LC9Z, C7A, A96, LY9B" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Lackart <span class="required">*</span></label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="lackart" value="Uni" required>
                            <span>Uni / Solid</span>
                        </label>
                        <label>
                            <input type="radio" name="lackart" value="Metallic" checked>
                            <span>Metallic</span>
                        </label>
                        <label>
                            <input type="radio" name="lackart" value="Perleffekt">
                            <span>Perleffekt</span>
                        </label>
                    </div>
                </div>

                <!-- FOTOS -->
                <div class="section-title">
                    <i data-feather="camera"></i>
                    Fotos
                </div>

                <div class="photo-section">
                    <label class="form-label">Schadensfotos (min. 1 Foto erforderlich)</label>
                    <div class="photo-grid" id="photoGrid">
                        <div class="photo-item empty" onclick="document.getElementById('photoInput').click()">
                            <i data-feather="camera"></i>
                            <span>Foto hinzuf√ºgen</span>
                        </div>
                    </div>
                    <input type="file" id="photoInput" accept="image/*" capture="environment" multiple>
                </div>

                <!-- NOTIZEN -->
                <div class="section-title">
                    <i data-feather="file-text"></i>
                    Schadensbeschreibung & Preis
                </div>

                <div class="form-group">
                    <label for="notizen" class="form-label">Notizen / Schadensbeschreibung</label>
                    <textarea id="notizen" class="form-textarea" placeholder="z.B. Delle an linker T√ºr, Kratzer am Kotfl√ºgel hinten rechts..."></textarea>
                </div>

                <div class="form-group">
                    <label for="vereinbarterPreis" class="form-label">üí∞ Vereinbarter Preis <span class="required">*</span></label>
                    <input type="number" id="vereinbarterPreis" class="form-input" placeholder="0.00" step="0.01" min="0.01" required style="font-size: var(--font-size-lg); font-weight: bold;">
                    <small style="color: var(--color-text-tertiary); display: block; margin-top: var(--space-1);">Erforderlich f√ºr vollst√§ndige Dokumentation</small>
                </div>

                <!-- UNTERSCHRIFT -->
                <div class="section-title">
                    <i data-feather="edit-3"></i>
                    Unterschrift
                </div>

                <div class="signature-section">
                    <label class="form-label">Unterschrift Kunde <span class="required">*</span></label>
                    <canvas id="signatureCanvas" width="800" height="400"></canvas>
                    <div class="signature-buttons">
                        <button type="button" class="btn btn-secondary btn-sm" onclick="clearSignature()">
                            <i data-feather="x"></i>
                            L√∂schen
                        </button>
                    </div>
                </div>

                <div class="submit-buttons">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i data-feather="save"></i>
                        Speichern & PDF erstellen
                    </button>
                    <button type="button" class="btn btn-secondary btn-lg" onclick="createArbeitsauftrag()">
                        <i data-feather="file"></i>
                        Arbeitsauftrag f√ºr Werkstatt drucken
                    </button>
                </div>
            </div>
        </form>
    </div>

    <script>
        // Initialize Feather Icons
        feather.replace();

        // Firebase initialisieren
        let firebaseInitialized = false;

        // Auto-Save: Entwurf speichern bei Eingabe
        let autoSaveTimeout;
        function saveDraft() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                const draft = {
                    kennzeichen: document.getElementById('kennzeichen').value.trim().toUpperCase(),
                    kundenname: document.getElementById('kundenname').value,
                    kundenEmail: document.getElementById('kundenEmail').value,
                    geplantesAbnahmeDatum: document.getElementById('geplantesAbnahmeDatum').value,
                    serviceTyp: document.getElementById('serviceTyp').value,
                    fahrzeugAbholung: document.querySelector('input[name="fahrzeugAbholung"]:checked').value,
                    abholadresse: document.getElementById('abholadresse').value,
                    abholdatum: document.getElementById('abholdatum').value,
                    abholzeit: document.getElementById('abholzeit').value,
                    abholnotiz: document.getElementById('abholnotiz').value,
                    marke: document.getElementById('marke').value,
                    modell: document.getElementById('modell').value,
                    baujahrVon: document.getElementById('baujahrVon').value,
                    baujahrBis: document.getElementById('baujahrBis').value,
                    kmstand: document.getElementById('kmstand').value,
                    vin: document.getElementById('vin').value,
                    farbname: document.getElementById('farbname').value,
                    farbvariante: document.getElementById('farbvariante').value,
                    farbnummer: document.getElementById('farbnummer').value,
                    notizen: document.getElementById('notizen').value,
                    vereinbarterPreis: document.getElementById('vereinbarterPreis').value,
                    timestamp: Date.now()
                };

                if (draft.kennzeichen || draft.kundenname || draft.marke) {
                    localStorage.setItem('annahme_draft', JSON.stringify(draft));
                    console.log('üíæ Entwurf gespeichert');
                }
            }, 2000);
        }

        // Entwurf laden
        function loadDraft() {
            const draft = localStorage.getItem('annahme_draft');
            if (draft) {
                const data = JSON.parse(draft);
                const ageMinutes = (Date.now() - data.timestamp) / 1000 / 60;

                if (ageMinutes < 60 && confirm('üîÑ Entwurf gefunden! M√∂chten Sie Ihre letzte Eingabe wiederherstellen?')) {
                    document.getElementById('kennzeichen').value = data.kennzeichen || '';
                    document.getElementById('kundenname').value = data.kundenname || '';
                    document.getElementById('kundenEmail').value = data.kundenEmail || '';
                    document.getElementById('geplantesAbnahmeDatum').value = data.geplantesAbnahmeDatum || '';
                    document.getElementById('serviceTyp').value = data.serviceTyp || 'lackier';
                    document.getElementById('marke').value = data.marke || '';
                    document.getElementById('modell').value = data.modell || '';
                    document.getElementById('baujahrVon').value = data.baujahrVon || data.baujahr || '';
                    document.getElementById('baujahrBis').value = data.baujahrBis || data.baujahr || '';
                    document.getElementById('kmstand').value = data.kmstand || '';
                    document.getElementById('vin').value = data.vin || '';
                    document.getElementById('farbname').value = data.farbname || '';
                    document.getElementById('farbvariante').value = data.farbvariante || '';
                    document.getElementById('farbnummer').value = data.farbnummer || '';
                    document.getElementById('notizen').value = data.notizen || '';
                    document.getElementById('vereinbarterPreis').value = data.vereinbarterPreis || '';

                    if (data.fahrzeugAbholung) {
                        const abholungRadio = document.querySelector(`input[name="fahrzeugAbholung"][value="${data.fahrzeugAbholung}"]`);
                        if (abholungRadio) {
                            abholungRadio.checked = true;
                            toggleAbholungDetails();
                        }
                        document.getElementById('abholadresse').value = data.abholadresse || '';
                        document.getElementById('abholdatum').value = data.abholdatum || '';
                        document.getElementById('abholzeit').value = data.abholzeit || '';
                        document.getElementById('abholnotiz').value = data.abholnotiz || '';
                    }

                    console.log('‚úÖ Entwurf wiederhergestellt');
                }
            }
        }

        // Entwurf l√∂schen nach erfolgreichem Speichern
        function clearDraft() {
            localStorage.removeItem('annahme_draft');
        }

        // Auto-Save bei Eingabe aktivieren
        let allKunden = [];

        // Firebase initialisieren und Kunden laden
        document.addEventListener('DOMContentLoaded', async function() {
            // Radio-Button visuelle Effekte initialisieren
            initRadioVisuals();

            // Pr√ºfe ob Nachannahme-Modus (von Partner-Fahrzeugen)
            const urlParams = new URLSearchParams(window.location.search);
            const nachannahmeModus = urlParams.get('mode') === 'nachannahme';
            const fahrzeugId = urlParams.get('id');

            if (nachannahmeModus && fahrzeugId) {
                console.log('üîÑ Nachannahme-Modus aktiv f√ºr Fahrzeug:', fahrzeugId);

                const nachannahmeDataStr = sessionStorage.getItem('partnerFahrzeugNachannahme');
                if (nachannahmeDataStr) {
                    const nachannahmeData = JSON.parse(nachannahmeDataStr);
                    console.log('üìã Nachannahme-Daten geladen:', nachannahmeData);

                    // Hinweis-Banner anzeigen
                    const form = document.getElementById('annahmeForm');
                    const banner = document.createElement('div');
                    banner.className = 'info-box';
                    banner.style.cssText = 'background: rgba(33, 150, 243, 0.15); border-color: rgba(33, 150, 243, 0.4); margin-bottom: var(--space-6);';
                    banner.innerHTML = `
                        <i data-feather="refresh-cw"></i>
                        <div class="info-box-content">
                            <strong>üîÑ PHYSISCHE NACHANNAHME</strong>
                            <p>
                                Fahrzeug: <strong>${nachannahmeData.marke} ${nachannahmeData.modell}</strong> ‚Ä¢ Kennzeichen: <strong>${nachannahmeData.kennzeichen}</strong><br>
                                Die Fahrzeugdaten sind vorausgef√ºllt. Erg√§nzen Sie jetzt:<br>
                                üì∏ Schadenfotos ‚Ä¢ ‚úçÔ∏è Kundenunterschrift ‚Ä¢ üìã Zus√§tzliche Notizen
                            </p>
                        </div>
                    `;
                    form.insertBefore(banner, form.firstChild);
                    feather.replace();

                    // Formular vorausf√ºllen (read-only)
                    document.getElementById('kennzeichen').value = nachannahmeData.kennzeichen;
                    document.getElementById('kennzeichen').readOnly = true;
                    document.getElementById('marke').value = nachannahmeData.marke || '';
                    document.getElementById('marke').readOnly = true;
                    document.getElementById('modell').value = nachannahmeData.modell || '';
                    document.getElementById('modell').readOnly = true;
                    document.getElementById('baujahrVon').value = nachannahmeData.baujahrVon || '';
                    document.getElementById('baujahrVon').readOnly = true;
                    document.getElementById('baujahrBis').value = nachannahmeData.baujahrBis || '';
                    document.getElementById('baujahrBis').readOnly = true;
                    document.getElementById('kmstand').value = nachannahmeData.kmstand || '';
                    document.getElementById('vin').value = nachannahmeData.vin || '';
                    document.getElementById('farbnummer').value = nachannahmeData.farbnummer || '';
                    document.getElementById('farbnummer').readOnly = true;
                    document.getElementById('farbname').value = nachannahmeData.farbname || '';
                    document.getElementById('lackart').value = nachannahmeData.lackart || '';
                    document.getElementById('kundenname').value = nachannahmeData.kundenname || '';
                    document.getElementById('kundenname').readOnly = true;
                    document.getElementById('notizen').value = nachannahmeData.schadenBeschreibung || '';

                    window.istNachannahme = true;
                    window.nachannahmeFahrzeugId = fahrzeugId;
                    window.nachannahmeData = nachannahmeData;
                }
            }

            // Auto-save f√ºr Form-Inputs
            const inputs = document.querySelectorAll('#annahmeForm input, #annahmeForm textarea');
            inputs.forEach(input => {
                input.addEventListener('input', saveDraft);
            });

            // Firebase initialisieren
            try {
                if (typeof initFirebase !== 'undefined') {
                    await initFirebase();
                    if (window.firebaseInitialized && window.firebaseApp) {
                        firebaseApp = window.firebaseApp;
                        firebaseInitialized = true;
                        console.log('‚úÖ Firebase initialisiert f√ºr Annahme');
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Firebase nicht verf√ºgbar, verwende LocalStorage:', error);
            }

            // Auth-Check f√ºr Multi-Tenant Support (Race Condition Fix)
            console.log('üîê Pr√ºfe Auth State f√ºr Multi-Tenant...');
            let currentUser = null;
            let attempts = 0;
            const maxAttempts = 20; // 5 Sekunden max

            while (!currentUser && attempts < maxAttempts) {
                currentUser = window.authManager?.getCurrentUser();
                if (!currentUser) {
                    console.log(`‚è≥ Warte auf Auth State Listener (Versuch ${attempts + 1}/${maxAttempts})...`);
                    await new Promise(resolve => setTimeout(resolve, 250));
                    attempts++;
                }
            }

            if (!currentUser) {
                console.warn('‚ö†Ô∏è Kein User eingeloggt - verwende globale Collections (nicht Multi-Tenant)');
                console.warn('   Tipp: Zuerst in index.html einloggen, dann annahme.html √∂ffnen');
                // Optional: Redirect zu Login
                // alert('‚ö†Ô∏è Bitte zuerst einloggen!');
                // window.location.href = 'index.html';
                // return;
            } else {
                console.log('‚úÖ Auth State erfolgreich geladen');
                console.log('   User:', currentUser.name);
                console.log('   Rolle:', currentUser.rolle);
                console.log('   WerkstattId:', currentUser.werkstattId);
                console.log('   ‚Üí Verwende Multi-Tenant Collections (z.B. fahrzeuge_' + currentUser.werkstattId + ')');
            }

            // Kunden laden
            await loadKunden();

            // Auto-Save Entwurf wiederherstellen (nur wenn NICHT Nachannahme-Modus)
            if (!window.istNachannahme) {
                loadDraft();
            }

            // Form Submit Event Listener registrieren
            console.log('üìù Registriere Form Submit Listener...');
            document.getElementById('annahmeForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                console.log('üöÄ === ANNAHME SUBMIT GESTARTET ===');

                // Validierung
                console.log('1Ô∏è‚É£ Validierung...');
                if (!document.getElementById('kennzeichen').value || !document.getElementById('kundenname').value) {
                    console.log('‚ùå Validierung fehlgeschlagen: Kennzeichen oder Kundenname fehlt');
                    alert('Bitte Kennzeichen und Kundenname eingeben!');
                    return;
                }

                if (!document.getElementById('marke').value || !document.getElementById('modell').value) {
                    console.log('‚ùå Validierung fehlgeschlagen: Marke oder Modell fehlt');
                    alert('Bitte Marke und Modell eingeben!');
                    return;
                }

                if (!document.getElementById('farbnummer').value) {
                    console.log('‚ùå Validierung fehlgeschlagen: Farbnummer fehlt');
                    alert('Bitte Farbnummer eingeben!');
                    return;
                }

                if (photos.length === 0) {
                    console.log('‚ùå Validierung fehlgeschlagen: Keine Fotos');
                    alert('Bitte mindestens 1 Foto machen!');
                    return;
                }

                // Pr√ºfe ob Unterschrift vorhanden
                const signatureData = canvas.toDataURL();
                const emptyCanvas = document.createElement('canvas');
                emptyCanvas.width = canvas.width;
                emptyCanvas.height = canvas.height;
                if (signatureData === emptyCanvas.toDataURL()) {
                    console.log('‚ùå Validierung fehlgeschlagen: Keine Unterschrift');
                    alert('Bitte Unterschrift des Kunden einholen!');
                    return;
                }

                console.log('‚úÖ Validierung erfolgreich');
                console.log('2Ô∏è‚É£ Sammle Formulardaten...');
                const annahmeData = getFormData();
                console.log('   Fahrzeug ID:', annahmeData.id);
                console.log('   Kennzeichen:', annahmeData.kennzeichen);
                console.log('   Kunde:', annahmeData.kundenname);
                console.log('   Fotos:', annahmeData.photos.length);

                // Nachannahme-Modus? Dann Duplikat-Pr√ºfung √ºberspringen
                if (window.istNachannahme) {
                    console.log('üîÑ Nachannahme-Modus: √úberspringe Duplikat-Pr√ºfung');
                } else {
                    // Normale Duplikat-Pr√ºfung
                    console.log('3Ô∏è‚É£ Duplikat-Pr√ºfung...');
                    const kennzeichen = annahmeData.kennzeichen.toUpperCase().replace(/\s+/g, '');
                    let existingVehicles = [];

                    try {
                        if (firebaseInitialized && firebaseApp) {
                            console.log('   ‚Üí Pr√ºfe Duplikate in Firestore...');
                            existingVehicles = await firebaseApp.getAllFahrzeuge();
                            console.log('   ‚Üí Gefunden:', existingVehicles.length, 'Fahrzeuge');
                        } else {
                            console.log('   ‚Üí Pr√ºfe Duplikate in LocalStorage...');
                            existingVehicles = JSON.parse(localStorage.getItem('fahrzeuge') || '[]');
                            console.log('   ‚Üí Gefunden:', existingVehicles.length, 'Fahrzeuge');
                        }

                        const duplicate = existingVehicles.find(v => {
                            const existingKz = v.kennzeichen.toUpperCase().replace(/\s+/g, '');
                            return existingKz === kennzeichen && v.status !== 'abgeschlossen';
                        });

                        if (duplicate) {
                            console.log('‚ö†Ô∏è Duplikat gefunden:', duplicate.kennzeichen);

                            const kundenameNeu = annahmeData.kundenname.toUpperCase().trim();
                            const kundenameAlt = duplicate.kundenname.toUpperCase().trim();
                            const gleicherKunde = (kundenameNeu === kundenameAlt);

                            let message;
                            if (gleicherKunde) {
                                message = `‚ö†Ô∏è ACHTUNG: Kennzeichen "${annahmeData.kennzeichen}" ist bereits als "${duplicate.status}" vorhanden!\n\n` +
                                          `GLEICHER KUNDE: ${duplicate.kundenname}\n` +
                                          `Fahrzeug: ${duplicate.marke} ${duplicate.modell}\n` +
                                          `Annahme: ${duplicate.datum}\n\n` +
                                          `üí° M√∂glicherweise ist dieses Fahrzeug bereits in Bearbeitung!\n\n` +
                                          `Trotzdem als NEUEN Auftrag anlegen?`;
                            } else {
                                message = `‚ö†Ô∏è HINWEIS: Kennzeichen "${annahmeData.kennzeichen}" ist bereits vorhanden!\n\n` +
                                          `ABER ANDERER KUNDE:\n` +
                                          `Alter Auftrag: ${duplicate.kundenname} (${duplicate.marke} ${duplicate.modell})\n` +
                                          `Neuer Auftrag: ${annahmeData.kundenname}\n\n` +
                                          `üí° M√∂glicherweise Fahrzeugwechsel oder verschiedene Besitzer.\n\n` +
                                          `Als neuen Auftrag anlegen?`;
                            }

                            const proceed = confirm(message);

                            if (!proceed) {
                                console.log('‚ùå Annahme abgebrochen - Duplikat verhindert');
                                return;
                            }
                            console.log('‚úÖ User hat Duplikat best√§tigt - fahre fort');
                        } else {
                            console.log('‚úÖ Kein Duplikat gefunden');
                        }
                    } catch (error) {
                        console.error('‚ö†Ô∏è Duplikat-Pr√ºfung fehlgeschlagen:', error);
                        console.error('   Details:', error.message);
                    }
                }

                // Speicherung
                console.log('4Ô∏è‚É£ Speicherung starten...');
                try {
                    if (firebaseInitialized && firebaseApp) {
                        console.log('üíæ Hybrid-Speicherung: Daten ‚Üí Firestore, Fotos ‚Üí LocalStorage');

                        // Nachannahme-Modus: UPDATE statt CREATE
                        if (window.istNachannahme) {
                            console.log('üîÑ NACHANNAHME-MODUS: Aktualisiere bestehendes Fahrzeug');

                            console.log('   a) Speichere Nachannahme-Fotos in Firestore...');
                            try {
                                await firebaseApp.savePhotosToFirestore(window.nachannahmeFahrzeugId, annahmeData.photos, 'vorher');
                                console.log('   ‚úÖ Fotos in Firestore gespeichert');
                            } catch (e) {
                                console.error('   ‚ùå Foto-Speicherung in Firestore fehlgeschlagen:', e);
                                firebaseApp.savePhotosLocal(window.nachannahmeFahrzeugId, annahmeData.photos, 'vorher');
                            }

                            console.log('   b) UPDATE Fahrzeugdaten in Firestore...');
                            const updateData = {
                                photos: annahmeData.photos,
                                signature: annahmeData.signature,
                                notizen: annahmeData.notizen || window.nachannahmeData.schadenBeschreibung,
                                kmstand: annahmeData.kmstand,
                                vin: annahmeData.vin,
                                farbname: annahmeData.farbname,
                                lackart: annahmeData.lackart,
                                datum: annahmeData.datum,
                                zeit: annahmeData.zeit,
                                physischeAnnahmeErfolgt: true,
                                physischeAnnahmeDatum: new Date().toISOString(),
                                lastModified: Date.now()
                            };

                            await firebaseApp.updateFahrzeug(window.nachannahmeFahrzeugId, updateData);
                            console.log('   ‚úÖ Fahrzeug aktualisiert');

                            sessionStorage.removeItem('partnerFahrzeugNachannahme');
                            clearDraft();

                            alert('‚úÖ Physische Annahme erfolgreich!\n\nDas Fahrzeug wurde mit Fotos und Unterschrift erg√§nzt.');
                            window.location.href = 'liste.html';
                            return;
                        }

                        // NORMALE ANNAHME
                        console.log('   a) Registriere Kundenbesuch...');
                        const kundeId = await firebaseApp.registriereKundenbesuch(annahmeData.kundenname);
                        if (kundeId) {
                            annahmeData.kundenId = kundeId;
                            console.log('   ‚úÖ Kunde registriert, ID:', kundeId);
                        } else {
                            console.log('   ‚ö†Ô∏è Keine KundenID erhalten');
                        }

                        console.log('   b) Speichere Fotos in Firestore...');
                        try {
                            await firebaseApp.savePhotosToFirestore(annahmeData.id, annahmeData.photos, 'vorher');
                            console.log('   ‚úÖ Fotos in Firestore gespeichert');
                        } catch (e) {
                            console.error('   ‚ùå Fehler beim Speichern der Fotos in Firestore:', e);
                            console.warn('   ‚Üí Fallback: Speichere Fotos in LocalStorage');
                            firebaseApp.savePhotosLocal(annahmeData.id, annahmeData.photos, 'vorher');
                        }

                        console.log('   c) Speichere Fahrzeugdaten in Firestore...');
                        const dataForFirestore = {...annahmeData};
                        delete dataForFirestore.photos;

                        await firebaseApp.saveFahrzeug(dataForFirestore);
                        console.log('   ‚úÖ Fahrzeug in Firestore gespeichert');

                        console.log('   d) Registriere Kunde und setze kundenId...');
                        try {
                            const kundenId = await firebaseApp.registriereKundenbesuch(annahmeData.kundenname);
                            if (kundenId) {
                                await firebaseApp.updateFahrzeug(annahmeData.id, {
                                    kundenId: kundenId
                                });
                                console.log('   ‚úÖ Kunde registriert, kundenId:', kundenId);
                            } else {
                                console.warn('   ‚ö†Ô∏è Keine kundenId erhalten');
                            }
                        } catch (error) {
                            console.error('   ‚ùå Fehler bei Kundenregistrierung:', error);
                        }

                        console.log('   e) Erstelle PDF...');
                        await createPDF(annahmeData);
                        console.log('   ‚úÖ PDF erstellt');
                    } else {
                        console.log('üíæ LocalStorage-Modus (Firebase nicht verf√ºgbar oder offline)');
                        console.log('   navigator.onLine:', navigator.onLine);
                        console.log('   firebaseInitialized:', firebaseInitialized);

                        let fahrzeuge = JSON.parse(localStorage.getItem('fahrzeuge') || '[]');
                        fahrzeuge.push(annahmeData);

                        try {
                            localStorage.setItem('fahrzeuge', JSON.stringify(fahrzeuge));
                            console.log('‚úÖ Fahrzeug in LocalStorage gespeichert');

                            if (navigator.onLine && !firebaseInitialized) {
                                console.warn('‚ö†Ô∏è Blaze Plan aktiv aber Firebase nicht initialisiert - bitte pr√ºfen!');
                            }
                        } catch (e) {
                            console.error('‚ùå Fehler beim Speichern:', e);
                            if (e.name === 'QuotaExceededError' || e.message.includes('quota')) {
                                alert('‚ö†Ô∏è SPEICHER VOLL!\n\nMit Firebase Blaze sollte das nicht passieren.\nBitte pr√ºfen Sie Ihre Internet-Verbindung.\n\nFalls Sie online sind, kontaktieren Sie den Support.');
                                return;
                            }
                            throw e;
                        }

                        console.log('   ‚Üí Erstelle PDF...');
                        await createPDF(annahmeData);
                        console.log('   ‚úÖ PDF erstellt');
                    }

                    console.log('‚úÖ === SPEICHERUNG ERFOLGREICH ===');
                } catch (error) {
                    console.error('‚ùå Fehler beim Speichern:', error);
                    console.error('   Error Name:', error.name);
                    console.error('   Error Message:', error.message);
                    console.error('   Stack:', error.stack);

                    console.log('   ‚Üí Versuche LocalStorage Fallback...');
                    try {
                        let fahrzeuge = JSON.parse(localStorage.getItem('fahrzeuge') || '[]');
                        fahrzeuge.push(annahmeData);
                        localStorage.setItem('fahrzeuge', JSON.stringify(fahrzeuge));
                        console.log('‚ö†Ô∏è Fahrzeug in LocalStorage gespeichert (Firestore-Fehler)');

                        await createPDF(annahmeData);
                        console.log('‚úÖ PDF erstellt (Fallback)');
                    } catch (fallbackError) {
                        console.error('‚ùå Auch Fallback fehlgeschlagen:', fallbackError);
                        alert('‚ùå Speichern fehlgeschlagen! Siehe Console f√ºr Details.');
                        return;
                    }
                }

                // Aufr√§umen
                console.log('5Ô∏è‚É£ Aufr√§umen...');
                clearDraft();
                console.log('   ‚úÖ Entwurf gel√∂scht');

                // Success Message
                document.getElementById('successMessage').style.display = 'block';
                console.log('   ‚úÖ Success-Message angezeigt');

                // Auto-Redirect zur √úbersicht nach 2 Sekunden
                setTimeout(() => {
                    console.log('   ‚Üí Weiterleitung zur √úbersicht...');
                    window.location.href = 'liste.html';
                }, 2000);

                // Form zur√ºcksetzen
                document.getElementById('annahmeForm').reset();
                photos = [];
                updatePhotoGrid();
                clearSignature();
                console.log('   ‚úÖ Formular zur√ºckgesetzt');

                console.log('üéâ === ANNAHME ABGESCHLOSSEN ===');
            });
            console.log('‚úÖ Form Submit Listener registriert');
        });

        // Kunden laden
        async function loadKunden() {
            try {
                if (firebaseInitialized && firebaseApp) {
                    allKunden = await firebaseApp.getAllKunden();
                } else {
                    allKunden = JSON.parse(localStorage.getItem('kunden') || '[]');
                }

                console.log(`‚úÖ ${allKunden.length} Kunden geladen`);
                updateKundenDropdown();
            } catch (error) {
                console.error('‚ùå Fehler beim Laden der Kunden:', error);
                allKunden = [];
            }
        }

        // Kunden-Dropdown aktualisieren
        function updateKundenDropdown() {
            const dropdown = document.getElementById('kundenDropdown');
            dropdown.innerHTML = '<option value="">üÜï Neuer Kunde</option>';

            if (allKunden.length > 0) {
                const sortedKunden = [...allKunden].sort((a, b) => {
                    const dateA = a.letzterBesuch ? new Date(a.letzterBesuch) : new Date(0);
                    const dateB = b.letzterBesuch ? new Date(b.letzterBesuch) : new Date(0);
                    return dateB - dateA;
                });

                sortedKunden.forEach(kunde => {
                    const option = document.createElement('option');
                    option.value = kunde.id;
                    const besuche = kunde.anzahlBesuche || 0;
                    const icon = besuche >= 2 ? '‚≠ê' : 'üë§';
                    option.textContent = `${icon} ${kunde.name} (${besuche} Besuch${besuche !== 1 ? 'e' : ''})`;
                    dropdown.appendChild(option);
                });
            }
        }

        // Kunde aus Dropdown ausw√§hlen
        function selectKunde() {
            const dropdown = document.getElementById('kundenDropdown');
            const kundeId = dropdown.value;

            if (!kundeId) {
                document.getElementById('kundenname').value = '';
                document.getElementById('kundenname').readOnly = false;
                return;
            }

            const kunde = allKunden.find(k => window.compareIds(k.id, kundeId));
            if (kunde) {
                document.getElementById('kundenname').value = kunde.name;
                document.getElementById('kundenname').readOnly = true;
                console.log(`‚úÖ Stammkunde ausgew√§hlt: ${kunde.name} (${kunde.anzahlBesuche || 0} Besuche)`);
            }
        }

        // Toggle Abholungs-Details
        function toggleAbholungDetails() {
            const fahrzeugAbholung = document.querySelector('input[name="fahrzeugAbholung"]:checked').value;
            const abholungDetails = document.getElementById('abholungDetails');

            if (fahrzeugAbholung === 'ja') {
                abholungDetails.style.display = 'block';
                document.getElementById('abholadresse').required = true;
            } else {
                abholungDetails.style.display = 'none';
                document.getElementById('abholadresse').value = '';
                document.getElementById('abholdatum').value = '';
                document.getElementById('abholzeit').value = '';
                document.getElementById('abholnotiz').value = '';
                document.getElementById('abholadresse').required = false;
            }
        }

        // Radio-Button visuelle R√ºckmeldung
        function initRadioVisuals() {
            document.querySelectorAll('.radio-group input[type="radio"]').forEach(radio => {
                if (radio.checked) {
                    radio.parentElement.classList.add('selected');
                }

                radio.addEventListener('change', function() {
                    const groupName = this.name;
                    document.querySelectorAll(`input[name="${groupName}"]`).forEach(r => {
                        r.parentElement.classList.remove('selected');
                    });

                    if (this.checked) {
                        this.parentElement.classList.add('selected');
                    }
                });
            });
        }

        // Aktuelles Datum
        const heute = new Date();
        document.getElementById('currentDate').textContent = heute.toLocaleDateString('de-DE', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });

        // Foto-Upload
        const photoInput = document.getElementById('photoInput');
        const photoGrid = document.getElementById('photoGrid');
        let photos = [];

        async function compressImage(base64Image, profileName = 'schadenFoto') {
            const result = await ImageOptimizer.compressImage(
                base64Image,
                profileName,
                (progress, message) => {
                    if (progress === 100) {
                        console.log(`‚úÖ ${message}`);
                    }
                }
            );

            console.log(`üìä Komprimierung: ${result.savings}% gespart (${(result.originalSize/1024).toFixed(0)}KB ‚Üí ${(result.compressedSize/1024).toFixed(0)}KB)`);

            return result.compressed;
        }

        photoInput.addEventListener('change', function(e) {
            const files = Array.from(e.target.files);

            for (const file of files) {
                if (file.size > 5 * 1024 * 1024) {
                    alert(`‚ö†Ô∏è Foto "${file.name}" ist zu gro√ü (${(file.size / 1024 / 1024).toFixed(1)} MB)!\n\nBitte kleineres Foto verwenden (max. 5 MB).`);
                    e.target.value = '';
                    return;
                }
            }

            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = async function(event) {
                    const compressed = await compressImage(event.target.result);
                    photos.push(compressed);
                    updatePhotoGrid();
                };
                reader.readAsDataURL(file);
            });
            e.target.value = '';
        });

        function updatePhotoGrid() {
            photoGrid.innerHTML = '';
            photos.forEach((photo, index) => {
                const div = document.createElement('div');
                div.className = 'photo-item';
                div.innerHTML = `
                    <img src="${photo}" alt="Foto ${index + 1}">
                    <button class="remove-photo" onclick="removePhoto(${index})">√ó</button>
                `;
                photoGrid.appendChild(div);
            });

            if (photos.length < 10) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'photo-item empty';
                emptyDiv.onclick = () => photoInput.click();
                emptyDiv.innerHTML = `
                    <i data-feather="camera"></i>
                    <span>Foto hinzuf√ºgen</span>
                `;
                photoGrid.appendChild(emptyDiv);
            }

            feather.replace();
        }

        function removePhoto(index) {
            photos.splice(index, 1);
            updatePhotoGrid();
        }

        // Unterschrift Canvas
        const canvas = document.getElementById('signatureCanvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let hasDrawn = false;

        function initCanvas() {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * 2;
            canvas.height = rect.height * 2;
            ctx.scale(2, 2);

            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            if (!hasDrawn) {
                drawPlaceholder();
            }
        }

        function drawPlaceholder() {
            ctx.save();
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.font = '20px Inter';
            ctx.textAlign = 'center';
            ctx.fillText('‚úçÔ∏è Hier unterschreiben', canvas.width / 2, canvas.height / 2);
            ctx.restore();
        }

        initCanvas();
        window.addEventListener('resize', initCanvas);

        function getCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            if (e.touches && e.touches.length > 0) {
                return {
                    x: (e.touches[0].clientX - rect.left) * scaleX / 2,
                    y: (e.touches[0].clientY - rect.top) * scaleY / 2
                };
            } else {
                return {
                    x: (e.clientX - rect.left) * scaleX / 2,
                    y: (e.clientY - rect.top) * scaleY / 2
                };
            }
        }

        function startDrawing(e) {
            e.preventDefault();
            isDrawing = true;

            if (!hasDrawn) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                hasDrawn = true;
            }

            const coords = getCoordinates(e);
            ctx.beginPath();
            ctx.moveTo(coords.x, coords.y);
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();

            const coords = getCoordinates(e);
            ctx.lineTo(coords.x, coords.y);
            ctx.stroke();
        }

        function stopDrawing(e) {
            if (!isDrawing) return;
            e.preventDefault();
            isDrawing = false;
            ctx.closePath();
        }

        canvas.addEventListener('mousedown', startDrawing, false);
        canvas.addEventListener('mousemove', draw, false);
        canvas.addEventListener('mouseup', stopDrawing, false);
        canvas.addEventListener('mouseleave', stopDrawing, false);

        canvas.addEventListener('touchstart', startDrawing, { passive: false });
        canvas.addEventListener('touchmove', draw, { passive: false });
        canvas.addEventListener('touchend', stopDrawing, { passive: false });
        canvas.addEventListener('touchcancel', stopDrawing, { passive: false });

        function clearSignature() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            hasDrawn = false;
            drawPlaceholder();
        }

        // Formular-Daten sammeln
        function getFormData() {
            const timestamp = Date.now();
            return {
                id: timestamp,
                datum: heute.toLocaleDateString('de-DE'),
                zeit: heute.toLocaleTimeString('de-DE'),
                kennzeichen: document.getElementById('kennzeichen').value.trim().toUpperCase(),
                kundenname: document.getElementById('kundenname').value,
                kundenEmail: document.getElementById('kundenEmail').value,
                geplantesAbnahmeDatum: document.getElementById('geplantesAbnahmeDatum').value,
                serviceTyp: document.getElementById('serviceTyp').value,
                fahrzeugAbholung: document.querySelector('input[name="fahrzeugAbholung"]:checked').value,
                abholadresse: document.getElementById('abholadresse').value,
                abholdatum: document.getElementById('abholdatum').value,
                abholzeit: document.getElementById('abholzeit').value,
                abholnotiz: document.getElementById('abholnotiz').value,
                marke: document.getElementById('marke').value,
                modell: document.getElementById('modell').value,
                baujahrVon: document.getElementById('baujahrVon').value,
                baujahrBis: document.getElementById('baujahrBis').value,
                kmstand: document.getElementById('kmstand').value,
                vin: document.getElementById('vin').value,
                farbname: document.getElementById('farbname').value,
                farbvariante: document.getElementById('farbvariante').value,
                farbnummer: document.getElementById('farbnummer').value,
                lackart: document.querySelector('input[name="lackart"]:checked').value,
                notizen: document.getElementById('notizen').value,
                vereinbarterPreis: parseFloat(document.getElementById('vereinbarterPreis').value) || null,
                photos,
                signature: canvas.toDataURL(),
                status: 'angenommen',
                prozessStatus: 'angenommen',
                prozessTimestamps: {
                    angenommen: timestamp
                },
                lastModified: timestamp,
                bezahlt: false,
                rechnungGeschrieben: false
            };
        }

        // PDF erstellen (keeping original function)
        async function createPDF(data) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header
            doc.setFillColor(0, 51, 102);
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.text('Fahrzeug-Annahmeprotokoll', 105, 20, { align: 'center' });
            doc.setFontSize(12);
            doc.text('Auto-Lackierzentrum Mosbach', 105, 30, { align: 'center' });

            // Daten
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(11);
            let y = 50;

            doc.setFont(undefined, 'bold');
            doc.text('Datum:', 20, y);
            doc.setFont(undefined, 'normal');
            doc.text(data.datum + ' ' + data.zeit, 50, y);

            y += 7;
            doc.setFont(undefined, 'bold');
            doc.text('Kennzeichen:', 20, y);
            doc.setFont(undefined, 'normal');
            doc.text(data.kennzeichen, 50, y);

            y += 7;
            doc.setFont(undefined, 'bold');
            doc.text('Kundenname:', 20, y);
            doc.setFont(undefined, 'normal');
            doc.text(data.kundenname, 50, y);

            y += 7;
            doc.setFont(undefined, 'bold');
            doc.text('Geplante Abnahme:', 20, y);
            doc.setFont(undefined, 'normal');
            const abnahmeDatumFormatted = data.geplantesAbnahmeDatum
                ? new Date(data.geplantesAbnahmeDatum).toLocaleDateString('de-DE')
                : 'Nicht angegeben';
            doc.text(abnahmeDatumFormatted, 50, y);

            // Fahrzeugdaten
            y += 12;
            doc.setFillColor(102, 126, 234);
            doc.rect(15, y - 5, 180, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont(undefined, 'bold');
            doc.text('FAHRZEUGDATEN', 20, y);

            y += 10;
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'bold');
            doc.text('Marke:', 20, y);
            doc.setFont(undefined, 'normal');
            doc.text(data.marke, 50, y);
            doc.setFont(undefined, 'bold');
            doc.text('Modell:', 110, y);
            doc.setFont(undefined, 'normal');
            doc.text(data.modell, 140, y);

            const baujahrVon = data.baujahrVon || data.baujahr;
            const baujahrBis = data.baujahrBis || data.baujahr;

            if (baujahrVon || baujahrBis || data.kmstand) {
                y += 7;
                if (baujahrVon || baujahrBis) {
                    doc.setFont(undefined, 'bold');
                    doc.text('Baujahr:', 20, y);
                    doc.setFont(undefined, 'normal');

                    let baujahrText = '';
                    if (baujahrVon && baujahrBis) {
                        if (baujahrVon === baujahrBis) {
                            baujahrText = baujahrVon;
                        } else {
                            baujahrText = baujahrVon + ' - ' + baujahrBis;
                        }
                    } else if (baujahrVon) {
                        baujahrText = 'ab ' + baujahrVon;
                    } else if (baujahrBis) {
                        baujahrText = 'bis ' + baujahrBis;
                    }

                    doc.text(baujahrText, 50, y);
                }
                if (data.kmstand) {
                    doc.setFont(undefined, 'bold');
                    doc.text('KM-Stand:', 110, y);
                    doc.setFont(undefined, 'normal');
                    doc.text(data.kmstand + ' km', 140, y);
                }
            }

            if (data.vin) {
                y += 7;
                doc.setFont(undefined, 'bold');
                doc.text('VIN/FIN:', 20, y);
                doc.setFont(undefined, 'normal');
                doc.text(data.vin, 50, y);
            }

            // LACKIER-INFO
            y += 12;
            doc.setFillColor(245, 87, 108);
            doc.rect(15, y - 5, 180, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont(undefined, 'bold');
            doc.setFontSize(13);
            doc.text('[!] LACKIER-INFORMATIONEN (FUER FARBKABINE)', 20, y);

            y += 10;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(11);
            if (data.farbname) {
                doc.setFont(undefined, 'bold');
                doc.text('Farbname:', 20, y);
                doc.setFont(undefined, 'normal');
                doc.text(data.farbname, 55, y);
                y += 7;
            }

            if (data.farbvariante) {
                doc.setFont(undefined, 'bold');
                doc.text('Farbvariante:', 20, y);
                doc.setFont(undefined, 'normal');
                doc.text(data.farbvariante, 55, y);
                y += 7;
            }

            // FARBNUMMER GROSS
            doc.setFillColor(255, 243, 205);
            doc.rect(15, y - 3, 180, 12, 'F');
            doc.setFont(undefined, 'bold');
            doc.setFontSize(14);
            doc.setTextColor(199, 37, 78);
            doc.text('FARBNUMMER:', 20, y + 4);
            doc.setFontSize(18);
            doc.text(data.farbnummer, 70, y + 4);

            y += 15;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('Lackart:', 20, y);
            doc.setFont(undefined, 'normal');
            doc.text(data.lackart, 55, y);

            if (data.vereinbarterPreis) {
                y += 15;
                doc.setFillColor(76, 175, 80);
                doc.rect(15, y - 5, 180, 12, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(13);
                doc.text('>>> VEREINBARTER PREIS:', 20, y + 2);
                doc.setFontSize(16);
                doc.text(data.vereinbarterPreis.toFixed(2) + ' EUR', 90, y + 2);
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);
                y += 5;
            }

            if (data.notizen) {
                y += 12;
                doc.setFont(undefined, 'bold');
                doc.text('Schadensbeschreibung / Notizen:', 20, y);
                y += 7;
                doc.setFont(undefined, 'normal');
                const notizen = doc.splitTextToSize(data.notizen, 170);
                doc.text(notizen, 20, y);
                y += notizen.length * 5 + 10;
            } else {
                y += 12;
            }

            const photosForPDF = data.photosBase64 || data.photos || [];

            if (photosForPDF.length > 0) {
                if (y > 220) {
                    doc.addPage();
                    y = 20;
                }

                doc.setFont(undefined, 'bold');
                doc.text('Schadensfotos:', 20, y);
                y += 10;

                for (let i = 0; i < photosForPDF.length; i += 2) {
                    if (y > 230) {
                        doc.addPage();
                        y = 20;
                    }

                    const imgWidth = 80;
                    const imgHeight = 60;

                    doc.addImage(photosForPDF[i], 'JPEG', 20, y, imgWidth, imgHeight);
                    if (i + 1 < photosForPDF.length) {
                        doc.addImage(photosForPDF[i + 1], 'JPEG', 110, y, imgWidth, imgHeight);
                    }

                    y += imgHeight + 10;
                }
            }

            if (y > 210) {
                doc.addPage();
                y = 20;
            }

            y += 5;
            doc.setFont(undefined, 'bold');
            doc.text('Unterschrift Kunde:', 20, y);
            y += 5;
            doc.addImage(data.signature, 'PNG', 20, y, 80, 30);

            const filename = `Annahme_${data.kennzeichen.replace(/\s/g, '_')}_${data.datum.replace(/\./g, '')}.pdf`;
            doc.save(filename);
        }

        // Arbeitsauftrag erstellen
        async function createArbeitsauftrag() {
            if (!document.getElementById('kennzeichen').value || !document.getElementById('marke').value || !document.getElementById('farbnummer').value) {
                alert('Bitte mindestens Kennzeichen, Marke und Farbnummer eingeben!');
                return;
            }

            const data = getFormData();

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFillColor(255, 193, 7);
            doc.rect(0, 0, 210, 50, 'F');
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(28);
            doc.setFont(undefined, 'bold');
            doc.text('ARBEITSAUFTRAG', 105, 25, { align: 'center' });
            doc.setFontSize(14);
            doc.text('Lackierwerkstatt', 105, 38, { align: 'center' });

            let y = 70;

            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text('Kennzeichen:', 20, y);
            doc.setFontSize(32);
            doc.text(data.kennzeichen, 105, y, { align: 'center' });

            y += 20;
            doc.setFontSize(18);
            doc.text('Fahrzeug:', 20, y);
            doc.setFont(undefined, 'normal');
            doc.text(`${data.marke} ${data.modell}`, 70, y);

            y += 25;
            doc.setFillColor(255, 243, 205);
            doc.rect(15, y - 10, 180, 30, 'F');
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(199, 37, 78);
            doc.text('[!] FARBNUMMER:', 20, y);
            doc.setFontSize(36);
            doc.text(data.farbnummer, 105, y + 5, { align: 'center' });

            y += 25;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(16);
            doc.text('Lackart:', 20, y);
            doc.setFont(undefined, 'normal');
            doc.text(data.lackart, 70, y);

            if (data.farbname) {
                y += 10;
                doc.setFont(undefined, 'bold');
                doc.text('Farbname:', 20, y);
                doc.setFont(undefined, 'normal');
                doc.text(data.farbname, 70, y);
            }

            if (data.farbvariante) {
                y += 10;
                doc.setFont(undefined, 'bold');
                doc.text('Farbvariante:', 20, y);
                doc.setFont(undefined, 'normal');
                doc.text(data.farbvariante, 70, y);
            }

            if (data.notizen) {
                y += 20;
                doc.setFont(undefined, 'bold');
                doc.setFontSize(14);
                doc.text('Schadensbeschreibung:', 20, y);
                y += 8;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(12);
                const notizen = doc.splitTextToSize(data.notizen, 170);
                doc.text(notizen, 20, y);
            }

            doc.setFontSize(10);
            doc.setTextColor(150, 150, 150);
            doc.text('Auto-Lackierzentrum Mosbach', 105, 280, { align: 'center' });
            doc.text(data.datum, 105, 285, { align: 'center' });

            const filename = `Arbeitsauftrag_${data.kennzeichen.replace(/\s/g, '_')}.pdf`;
            doc.save(filename);
        }
    </script>

    <!-- Error Handler & Storage Monitor -->
    <script src="error-handler.js"></script>
    <script src="storage-monitor.js"></script>

    <!-- Theme Toggle System -->
    <script>
        // ============================================
        // üåì THEME TOGGLE SYSTEM (mit Feather Icons Stroke-Width Update)
        // ============================================

        (function initThemeToggle() {
            const themeToggle = document.getElementById('themeToggle');
            const html = document.documentElement;

            // Update Feather Icons stroke-width based on theme
            function updateFeatherIcons(theme) {
                const strokeWidth = theme === 'light' ? '2.5' : '2';
                document.querySelectorAll('i[data-feather]').forEach(icon => {
                    const svg = icon.querySelector('svg');
                    if (svg) {
                        svg.querySelectorAll('*[stroke]').forEach(element => {
                            element.setAttribute('stroke-width', strokeWidth);
                        });
                    }
                });
            }

            // Load theme from localStorage (default: dark)
            let currentTheme = localStorage.getItem('theme') || 'dark';
            html.setAttribute('data-theme', currentTheme);

            // Theme toggle on button click
            if (themeToggle) {
                themeToggle.addEventListener('click', () => {
                    currentTheme = currentTheme === 'light' ? 'dark' : 'light';
                    html.setAttribute('data-theme', currentTheme);
                    localStorage.setItem('theme', currentTheme);

                    // Re-initialize Feather Icons with updated stroke-width
                    if (typeof feather !== 'undefined') {
                        feather.replace();
                        setTimeout(() => updateFeatherIcons(currentTheme), 50);
                    }

                    console.log(`‚úÖ Theme switched to: ${currentTheme}`);
                });
            }

            // Initialize Feather Icons on load with correct stroke-width
            if (typeof feather !== 'undefined') {
                feather.replace();
                setTimeout(() => updateFeatherIcons(currentTheme), 50);
            }

            console.log(`üåì Theme loaded: ${currentTheme}`);
        })();
    </script>

    <!-- KI-Chat-Assistent -->
    <div id="aiChatWidget"></div>
    <script src="js/ai-agent-tools.js"></script>
    <script src="js/ai-agent-engine.js"></script>
    <script src="js/ai-chat-widget.js"></script>

    <!-- ============================================
         SERVICE WORKER REGISTRATION - Offline-Funktionalit√§t
         ============================================ -->
    <script>
        // Service Worker nur registrieren wenn:
        // 1. Browser unterst√ºtzt Service Worker
        // 2. NICHT in Playwright Tests (navigator.webdriver)
        // 3. NICHT auf Emulator-Port (8000)
        if ('serviceWorker' in navigator && !navigator.webdriver && window.location.port !== '8000') {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('./sw.js', {
                        scope: './'
                    });

                    console.log('‚úÖ [SW] Service Worker registriert:', registration.scope);

                    // Update-Handling: Neuen SW aktivieren wenn gefunden
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('üîÑ [SW] Update gefunden, installiere...');

                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                console.log('‚úÖ [SW] Update bereit! Seite neu laden f√ºr neue Version.');

                                // Optional: Auto-reload nach 3 Sekunden
                                // setTimeout(() => window.location.reload(), 3000);
                            }
                        });
                    });

                } catch (error) {
                    console.error('‚ùå [SW] Registrierung fehlgeschlagen:', error);
                }
            });
        } else {
            console.log('‚ÑπÔ∏è [SW] Service Worker nicht registriert (Test-Modus oder nicht unterst√ºtzt)');
        }
    </script>
</body>
</html>
