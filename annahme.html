<!DOCTYPE html>
<html lang="de">
<head>
    <!-- werkstattId will be set dynamically by auth-manager.js after login -->
    <script>
        /// <reference path="js/types.js" />
        // window.werkstattId is set automatically after successful login
        // This ensures proper multi-tenant data isolation
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fahrzeug-Annahme | Auto-Lackierzentrum Mosbach</title>

    <!-- Aggressive No-Cache Headers (Cache-Fix f√ºr v=a4192c4) -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- Design System -->
    <link rel="stylesheet" href="design-system.css?v=af6b90f">
    <link rel="stylesheet" href="components.css?v=af6b90f">
    <link rel="stylesheet" href="animations.css?v=af6b90f">
    <link rel="stylesheet" href="mobile-first.css?v=af6b90f">
    <link rel="stylesheet" href="css/ai-chat-widget.css">

    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- QRious - Browser-optimized QR Code Generator (Local Copy) -->
    <script src="./libs/qrious.min.js"></script>

    <style>
        body {
            background: var(--color-background);
            min-height: 100vh;
            padding: var(--space-6) var(--space-4) 100px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* Page Header */
        .page-header {
            text-align: center;
            margin-bottom: var(--space-8);
            padding: var(--space-8) var(--space-6);
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        .page-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(255, 255, 255, 0.3) 50%,
                transparent 100%
            );
            opacity: 0.5;
        }

        .page-header h1 {
            font-size: clamp(24px, 5vw, 36px);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin-bottom: var(--space-2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-3);
        }

        .page-header p {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
        }

        .date-display {
            color: var(--color-text-tertiary);
            font-size: var(--font-size-sm);
            text-align: right;
            margin-bottom: var(--space-4);
        }

        /* Form Container */
        .form-container {
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            padding: var(--space-8);
            margin-bottom: var(--space-6);
            position: relative;
            overflow: hidden;
        }

        .form-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(255, 255, 255, 0.3) 50%,
                transparent 100%
            );
            opacity: 0.3;
        }

        /* Section Title with Icon */
        .section-title {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin: var(--space-8) 0 var(--space-6) 0;
            padding-bottom: var(--space-3);
            border-bottom: 1px solid var(--color-border);
        }

        .section-title:first-child {
            margin-top: 0;
        }

        .section-title i {
            width: 24px;
            height: 24px;
            color: var(--color-primary);
        }

        /* Photo Section */
        .photo-section {
            margin-bottom: var(--space-6);
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: var(--space-4);
            margin-top: var(--space-4);
        }

        .photo-item {
            position: relative;
            aspect-ratio: 1;
            border: 2px dashed var(--color-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            cursor: pointer;
            transition: all var(--duration-base) var(--ease-out);
            background: rgba(255, 255, 255, 0.05);
        }

        .photo-item:hover {
            border-color: var(--color-primary);
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(0, 191, 255, 0.2);
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-item.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: var(--space-2);
        }

        .photo-item.empty i {
            width: 40px;
            height: 40px;
            color: var(--color-text-tertiary);
        }

        .photo-item.empty span {
            font-size: var(--font-size-xs);
            color: var(--color-text-tertiary);
        }

        .remove-photo {
            position: absolute;
            top: var(--space-2);
            right: var(--space-2);
            background: var(--color-error);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-size: 20px;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all var(--duration-base) var(--ease-out);
        }

        .remove-photo:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(255, 69, 58, 0.4);
        }

        .photo-item:hover .remove-photo {
            display: flex;
        }

        #photoInput {
            display: none;
        }

        /* Signature Canvas */
        .signature-section {
            margin-bottom: var(--space-6);
        }

        #signatureCanvas {
            width: 100%;
            height: 200px;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-lg);
            cursor: crosshair;
            touch-action: none;
            background: rgba(255, 255, 255, 0.03);
            transition: border-color var(--duration-base) var(--ease-out);
        }

        #signatureCanvas:hover {
            border-color: var(--color-primary);
        }

        .signature-buttons {
            display: flex;
            gap: var(--space-3);
            margin-top: var(--space-3);
        }

        /* Info Box */
        .info-box {
            background: rgba(0, 191, 255, 0.1);
            border: 1px solid rgba(0, 191, 255, 0.3);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin-bottom: var(--space-6);
            display: flex;
            gap: var(--space-3);
            align-items: flex-start;
        }

        .info-box i {
            color: var(--color-primary);
            flex-shrink: 0;
        }

        .info-box-content {
            flex: 1;
        }

        .info-box-content strong {
            color: var(--color-text-primary);
        }

        .info-box-content p {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
            margin: 0;
        }

        /* Success Message */
        .success-message {
            display: none;
            background: var(--color-success);
            color: white;
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            text-align: center;
            margin-bottom: var(--space-6);
            animation: slideDown var(--duration-base) var(--ease-out);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Highlight Form Group */
        .form-group.highlight {
            background: rgba(255, 193, 7, 0.1);
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            border: 2px solid var(--color-warning);
        }

        .form-group.highlight label {
            color: var(--color-warning);
            font-size: var(--font-size-lg);
        }

        .form-group.highlight input {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            border: 2px solid var(--color-warning);
        }

        /* Abholung Details Box */
        #abholungDetails {
            background: rgba(0, 191, 255, 0.05);
            padding: var(--space-5);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(0, 191, 255, 0.2);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: var(--z-fixed);
            background: var(--color-surface-elevated);
            backdrop-filter: blur(var(--glass-blur-strong)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur-strong)) saturate(var(--glass-saturation));
            border-top: 1px solid var(--color-border-glass);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
            padding: var(--space-3);
        }

        .bottom-nav-content {
            max-width: 600px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-2);
        }

        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-2);
            text-decoration: none;
            color: var(--color-text-secondary);
            border-radius: var(--radius-md);
            transition: all var(--duration-base) var(--ease-out);
        }

        .bottom-nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--color-text-primary);
        }

        .bottom-nav-item.active {
            color: var(--color-primary);
            background: rgba(0, 191, 255, 0.1);
        }

        .bottom-nav-item i {
            width: 24px;
            height: 24px;
        }

        .bottom-nav-item span {
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
        }

        /* Submit Buttons Container */
        .submit-buttons {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
            margin-top: var(--space-6);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body {
                padding: var(--space-4) var(--space-3) 100px;
            }

            .form-container {
                padding: var(--space-6) var(--space-4);
            }

            .page-header {
                padding: var(--space-6) var(--space-4);
            }

            .photo-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

    <!-- Firebase Konfiguration -->
    <script src="firebase-config.js?v=a4192c4"></script>

    <!-- Auth Manager f√ºr Multi-Tenant Support -->
    <script src="js/auth-manager.js"></script>
    <script src="js/settings-manager.js"></script>
    <script src="js/permissions-helper.js"></script>

    <!-- Listener Registry (must load early!) -->
    <script src="listener-registry.js?v=6020c9e"></script>

    <!-- Image Optimizer -->
    <script src="image-optimizer.js"></script>

    <!-- Global Chat Notifications -->
    <link rel="stylesheet" href="global-chat-notifications.css">
    <script src="global-chat-notifications.js"></script>

    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>
</head>
<body>
    <!-- THEME TOGGLE BUTTON -->
    <button id="themeToggle" class="theme-toggle" aria-label="Toggle Light/Dark Mode">
        <i data-feather="sun" class="theme-toggle__icon theme-toggle__icon--light"></i>
        <i data-feather="moon" class="theme-toggle__icon theme-toggle__icon--dark"></i>
    </button>

    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1>
                <i data-feather="file-plus"></i>
                Fahrzeug-Annahme
            </h1>
            <p>Auto-Lackierzentrum Mosbach</p>
        </div>

        <div class="date-display">
            Datum: <strong id="currentDate"></strong>
        </div>

        <div class="success-message" id="successMessage">
            ‚úÖ Fahrzeug erfolgreich aufgenommen!
        </div>

        <div class="info-box">
            <i data-feather="info"></i>
            <div class="info-box-content">
                <strong>Tipp:</strong>
                <p>F√ºllen Sie alle Fahrzeugdaten und die Farbnummer aus - das erleichtert die Arbeit in der Farbkabine enorm!</p>
            </div>
        </div>

        <!-- Form -->
        <form id="annahmeForm">
            <div class="form-container">
                <!-- KUNDENDATEN -->
                <div class="section-title">
                    <i data-feather="user"></i>
                    Kundendaten
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="kennzeichen" class="form-label">Kennzeichen <span class="required">*</span></label>
                        <input type="text" id="kennzeichen" class="form-input" placeholder="z.B. MOS-CG 123" required style="text-transform: uppercase;">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Kundenauswahl</label>
                        <select id="kundenDropdown" class="form-select" onchange="selectKunde()">
                            <option value="">üÜï Neuer Kunde</option>
                            <!-- Dynamisch gef√ºllt -->
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="kundenname" class="form-label">Kundenname <span class="required">*</span></label>
                    <input type="text" id="kundenname" class="form-input" placeholder="z.B. Max Mustermann" required>
                </div>

                <div class="form-group">
                    <label for="kundenEmail" class="form-label">Kunden-Email <span class="required">*</span></label>
                    <input type="email" id="kundenEmail" class="form-input" placeholder="z.B. kunde@example.com" required>
                    <small style="color: var(--color-text-tertiary); display: block; margin-top: var(--space-1);">
                        üìß Ben√∂tigt f√ºr automatische Status-Updates per Email
                    </small>
                </div>

                <div class="form-group">
                    <label for="telefon" class="form-label">Telefonnummer</label>
                    <input type="tel" id="telefon" class="form-input" placeholder="z.B. +49 6261 123456 oder 06261 123456">
                    <small style="color: var(--color-text-tertiary); display: block; margin-top: var(--space-1);">
                        üìû Optional - f√ºr telefonische R√ºckfragen
                    </small>
                </div>

                <div class="form-group">
                    <label for="geplantesAbnahmeDatum" class="form-label">Voraussichtliches Abnahme-Datum <span class="required">*</span></label>
                    <input type="date" id="geplantesAbnahmeDatum" class="form-input" required>
                </div>

                <div class="form-group">
                    <label for="serviceTyp" class="form-label">Service-Typ <span class="required">*</span></label>
                    <select id="serviceTyp" class="form-select" required>
                        <option value="lackier">üé® Lackierung</option>
                        <option value="reifen">üîß Reifen-Service</option>
                        <option value="mechanik">‚öôÔ∏è Mechanik</option>
                        <option value="pflege">‚ú® Pflege & Aufbereitung</option>
                        <option value="tuev">üìã T√úV & Pr√ºfung</option>
                        <option value="versicherung">üõ°Ô∏è Versicherungsschaden</option>
                        <option value="glas">üîç Glas-Reparatur</option>
                        <option value="klima">‚ùÑÔ∏è Klima-Service</option>
                        <option value="dellen">üî® Dellen-Dr√ºckung</option>
                        <option value="folierung">üåà Auto Folierung</option>
                        <option value="steinschutz">üõ°Ô∏è Steinschutzfolie</option>
                        <option value="werbebeklebung">üì¢ Fahrzeugbeschriftung</option>
                    </select>
                    <small style="color: var(--color-text-tertiary); display: block; margin-top: var(--space-1);">
                        üí° Wichtig f√ºr korrekte Prozess√ºberwachung im Kanban-Board
                    </small>
                </div>

                <!-- ‚ú® SERVICE-SPEZIFISCHE FELDER (dynamisch angezeigt) -->

                <!-- Reifen-Service Felder -->
                <div id="reifen-felder" class="service-felder" style="display:none;">
                    <div class="section-title" style="margin-top: var(--space-4);">
                        <i data-feather="circle"></i>
                        Reifen-Service Details
                    </div>

                    <div class="form-group">
                        <label for="reifengroesse" class="form-label">Reifengr√∂√üe</label>
                        <input type="text" id="reifengroesse" class="form-input" placeholder="z.B. 205/55 R16 91V">
                        <small style="color: var(--color-text-tertiary);">Format: Breite/H√∂he Durchmesser Lastindex</small>
                    </div>

                    <div class="form-group">
                        <label for="reifentyp" class="form-label">Reifen-Typ</label>
                        <select id="reifentyp" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="sommer">Sommerreifen</option>
                            <option value="winter">Winterreifen</option>
                            <option value="ganzjahr">Ganzjahresreifen</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="reifenanzahl" class="form-label">Anzahl Reifen</label>
                        <input type="number" id="reifenanzahl" class="form-input" min="1" max="4" value="4">
                    </div>
                </div>

                <!-- Glas-Reparatur Felder -->
                <div id="glas-felder" class="service-felder" style="display:none;">
                    <div class="section-title" style="margin-top: var(--space-4);">
                        <i data-feather="circle"></i>
                        Glas-Reparatur Details
                    </div>

                    <div class="form-group">
                        <label for="scheibentyp" class="form-label">Scheiben-Typ</label>
                        <select id="scheibentyp" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="frontscheibe">Frontscheibe</option>
                            <option value="seitenscheibe-vorne-links">Seitenscheibe vorne links</option>
                            <option value="seitenscheibe-vorne-rechts">Seitenscheibe vorne rechts</option>
                            <option value="seitenscheibe-hinten-links">Seitenscheibe hinten links</option>
                            <option value="seitenscheibe-hinten-rechts">Seitenscheibe hinten rechts</option>
                            <option value="heckscheibe">Heckscheibe</option>
                            <option value="schiebedach">Schiebedach</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="schadensgroesse" class="form-label">Schadens-Gr√∂√üe</label>
                        <select id="schadensgroesse" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="steinschlag">Steinschlag (< 2cm) - Reparatur m√∂glich</option>
                            <option value="riss-klein">Kleiner Riss (2-5cm) - Reparatur m√∂glich</option>
                            <option value="riss-mittel">Mittlerer Riss (5-10cm) - Austausch empfohlen</option>
                            <option value="riss-gross">Gro√üer Riss/Bruch (> 10cm) - Austausch n√∂tig</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="glasposition" class="form-label">Position des Schadens</label>
                        <input type="text" id="glasposition" class="form-input" placeholder="z.B. Fahrerseite Mitte, Beifahrerseite oben links">
                    </div>
                </div>

                <!-- Klima-Service Felder -->
                <div id="klima-felder" class="service-felder" style="display:none;">
                    <div class="section-title" style="margin-top: var(--space-4);">
                        <i data-feather="circle"></i>
                        Klima-Service Details
                    </div>

                    <div class="form-group">
                        <label for="klimaservice" class="form-label">Service-Art</label>
                        <select id="klimaservice" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="wartung">Wartung & Desinfektion</option>
                            <option value="fuellen">K√§ltemittel auff√ºllen</option>
                            <option value="reparatur">Reparatur (Leckage)</option>
                            <option value="komplett">Kompletter Service-Check</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="kaeltemittel" class="form-label">K√§ltemittel-Typ</label>
                        <select id="kaeltemittel" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="r134a">R134a (Fahrzeuge √§lter 2017)</option>
                            <option value="r1234yf">R1234yf (Fahrzeuge ab 2017)</option>
                            <option value="unbekannt">Unbekannt / Nicht sicher</option>
                        </select>
                        <small style="color: var(--color-text-tertiary);">Ab Erstzulassung 2017 meist R1234yf</small>
                    </div>

                    <div class="form-group">
                        <label for="klimaproblem" class="form-label">Beschreibung des Problems</label>
                        <textarea id="klimaproblem" class="form-input" rows="3" placeholder="z.B. Klimaanlage k√ºhlt nicht mehr, unangenehmer Geruch, Ger√§usche beim Einschalten"></textarea>
                    </div>
                </div>

                <!-- Dellen-Dr√ºckung Felder -->
                <div id="dellen-felder" class="service-felder" style="display:none;">
                    <div class="section-title" style="margin-top: var(--space-4);">
                        <i data-feather="circle"></i>
                        Dellen-Dr√ºckung Details
                    </div>

                    <div class="form-group">
                        <label for="dellenanzahl" class="form-label">Anzahl Dellen</label>
                        <input type="number" id="dellenanzahl" class="form-input" min="1" max="20" value="1">
                    </div>

                    <div class="form-group">
                        <label for="dellengroesse" class="form-label">Gr√∂√üte Delle</label>
                        <select id="dellengroesse" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="klein">Klein (< 5cm Durchmesser)</option>
                            <option value="mittel">Mittel (5-10cm Durchmesser)</option>
                            <option value="gross">Gro√ü (> 10cm Durchmesser)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="lackschaden" class="form-label">Lackschaden vorhanden?</label>
                        <select id="lackschaden" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="nein">Nein (nur Delle)</option>
                            <option value="ja">Ja (Delle + Lackschaden)</option>
                        </select>
                        <small style="color: var(--color-text-tertiary);">Bei Lackschaden ist zus√§tzliche Lackierung n√∂tig</small>
                    </div>

                    <div class="form-group">
                        <label for="dellenpositionen" class="form-label">Position(en) der Dellen</label>
                        <textarea id="dellenpositionen" class="form-input" rows="3" placeholder="z.B. Fahrert√ºr Mitte, Kotfl√ºgel rechts, Motorhaube links vorne"></textarea>
                    </div>
                </div>

                <!-- Mechanik-Service Felder -->
                <div id="mechanik-felder" class="service-felder" style="display:none;">
                    <div class="section-title" style="margin-top: var(--space-4);">
                        <i data-feather="circle"></i>
                        Mechanik-Service Details
                    </div>

                    <div class="form-group">
                        <label for="mechanik-problem" class="form-label">Problembeschreibung</label>
                        <textarea id="mechanik-problem" class="form-input" rows="4" placeholder="z.B. Motor ruckelt, Bremsen quietschen, Lenkung schwerg√§ngig, Warnleuchte leuchtet..."></textarea>
                        <small style="color: var(--color-text-tertiary);">Bitte so detailliert wie m√∂glich beschreiben</small>
                    </div>

                    <div class="form-group">
                        <label for="mechanik-symptome" class="form-label">Symptome / Wann tritt das Problem auf?</label>
                        <input type="text" id="mechanik-symptome" class="form-input" placeholder="z.B. nur beim Kaltstart, bei hoher Geschwindigkeit, beim Bremsen">
                    </div>
                </div>

                <!-- Versicherung-Service Felder -->
                <div id="versicherung-felder" class="service-felder" style="display:none;">
                    <div class="section-title" style="margin-top: var(--space-4);">
                        <i data-feather="circle"></i>
                        Versicherungsschaden Details
                    </div>

                    <div class="form-group">
                        <label for="versicherung-schadensnummer" class="form-label">Schadennummer</label>
                        <input type="text" id="versicherung-schadensnummer" class="form-input" placeholder="z.B. SCH-2024-123456">
                        <small style="color: var(--color-text-tertiary);">Von der Versicherung erhalten</small>
                    </div>

                    <div class="form-group">
                        <label for="versicherung-name" class="form-label">Versicherung</label>
                        <input type="text" id="versicherung-name" class="form-input" placeholder="z.B. Allianz, HUK, Ergo">
                    </div>

                    <div class="form-group">
                        <label for="versicherung-schadendatum" class="form-label">Schadendatum</label>
                        <input type="date" id="versicherung-schadendatum" class="form-input">
                    </div>

                    <div class="form-group">
                        <label for="versicherung-hergang" class="form-label">Unfallhergang / Schadenursache</label>
                        <textarea id="versicherung-hergang" class="form-input" rows="3" placeholder="z.B. Auffahrunfall, Parkrempler, Wildschaden, Hagel..."></textarea>
                    </div>
                </div>

                <!-- Pflege-Service Felder -->
                <div id="pflege-felder" class="service-felder" style="display:none;">
                    <div class="section-title" style="margin-top: var(--space-4);">
                        <i data-feather="circle"></i>
                        Fahrzeugpflege Details
                    </div>

                    <div class="form-group">
                        <label for="pflege-paket" class="form-label">Pflege-Paket</label>
                        <select id="pflege-paket" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="basis">Basis (Au√üenw√§sche + Staubsaugen)</option>
                            <option value="premium">Premium (Basis + Innenraumreinigung + Politur)</option>
                            <option value="deluxe">Deluxe (Premium + Motorw√§sche + Unterbodenw√§sche + Versiegelung)</option>
                            <option value="aufbereitung">Komplett-Aufbereitung (Deluxe + Polsterreinigung + Lederpflege)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="pflege-zusatz" class="form-label">Zusatzleistungen</label>
                        <textarea id="pflege-zusatz" class="form-input" rows="2" placeholder="z.B. Polsterreinigung, Lederpflege, Geruchsneutralisierung, Scheinwerfer-Aufbereitung"></textarea>
                    </div>
                </div>

                <!-- T√úV-Service Felder -->
                <div id="tuev-felder" class="service-felder" style="display:none;">
                    <div class="section-title" style="margin-top: var(--space-4);">
                        <i data-feather="circle"></i>
                        T√úV/AU Details
                    </div>

                    <div class="form-group">
                        <label for="tuev-pruefart" class="form-label">Pr√ºfart</label>
                        <select id="tuev-pruefart" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="hu">HU (Hauptuntersuchung)</option>
                            <option value="au">AU (Abgasuntersuchung)</option>
                            <option value="hu-au">HU + AU (Kombi)</option>
                            <option value="nachpruefung">Nachpr√ºfung</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="tuev-faelligkeit" class="form-label">F√§lligkeit T√úV</label>
                        <input type="month" id="tuev-faelligkeit" class="form-input">
                        <small style="color: var(--color-text-tertiary);">Steht im Fahrzeugschein und auf T√úV-Plakette</small>
                    </div>

                    <div class="form-group">
                        <label for="tuev-maengel" class="form-label">Bekannte M√§ngel (optional)</label>
                        <textarea id="tuev-maengel" class="form-input" rows="2" placeholder="z.B. Beleuchtung defekt, Reifen abgefahren, Rost am Schweller"></textarea>
                    </div>
                </div>

                <!-- Auto Folierung Felder -->
                <div id="folierung-felder" class="service-felder" style="display:none;">
                    <div class="section-title" style="margin-top: var(--space-4);">
                        <i data-feather="circle"></i>
                        Auto Folierung Details
                    </div>

                    <div class="form-group">
                        <label for="folierungArt" class="form-label">Art der Folierung <span class="required">*</span></label>
                        <select id="folierungArt" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="vollfolierung">üé® Vollfolierung (gesamtes Fahrzeug)</option>
                            <option value="teilfolierung">‚úÇÔ∏è Teilfolierung (bestimmte Teile)</option>
                            <option value="akzente">‚≠ê Akzente (Streifen, Logos)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="folierungMaterial" class="form-label">Materialqualit√§t <span class="required">*</span></label>
                        <select id="folierungMaterial" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="standard">üì¶ Standard (3-5 Jahre)</option>
                            <option value="premium">üíé Premium (5-7 Jahre)</option>
                            <option value="spezial">üåü Spezialfolie (Chrome, Carbon, Matt)</option>
                        </select>
                    </div>

                    <!-- Spezialfolientyp (nur wenn Material = 'spezial') -->
                    <div class="form-group" id="folierungSpezialTypGroup" style="display: none;">
                        <label for="folierungSpezialTyp" class="form-label">Spezialfolientyp <span class="required">*</span></label>
                        <select id="folierungSpezialTyp" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="chrome">‚ú® Chrome</option>
                            <option value="matt">üé≠ Matt</option>
                            <option value="hochglanz">üíé Hochglanz</option>
                            <option value="carbon">üèÅ Carbon</option>
                            <option value="brushed-metal">üîß Brushed Metal</option>
                        </select>
                    </div>

                    <!-- Bereiche (nur wenn Art != 'vollfolierung') -->
                    <div class="form-group" id="folierungBereicheGroup" style="display: none;">
                        <label class="form-label">Zu folierende Bereiche <span class="required">*</span></label>
                        <div class="checkbox-group" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="folierungBereiche" value="motorhaube"> Motorhaube
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="folierungBereiche" value="dach"> Dach
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="folierungBereiche" value="seitenspiegel"> Seitenspiegel
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="folierungBereiche" value="heckklappe"> Heckklappe
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="folierungBereiche" value="kotfluegel"> Kotfl√ºgel
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="folierungBereiche" value="spoiler"> Spoiler
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="folierungBereiche" value="tueren"> T√ºren
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="folierungBereiche" value="seitenwand"> Seitenwand
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="folierungFarbe" class="form-label">Farbauswahl <span class="required">*</span></label>
                        <input type="text" id="folierungFarbe" class="form-input" placeholder="z.B. Schwarz Matt, Blau Metallic, Rot Hochglanz">
                    </div>

                    <div class="form-group">
                        <label for="folierungDesign" class="form-label">Design-Vorstellungen</label>
                        <textarea id="folierungDesign" class="form-input" rows="3" placeholder="Muster, Streifen, Logos, etc."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="folierungInfo" class="form-label">Zus√§tzliche Informationen</label>
                        <textarea id="folierungInfo" class="form-input" rows="2" placeholder="Besondere Anforderungen, Zeitrahmen..."></textarea>
                    </div>
                </div>

                <!-- Steinschutzfolie Felder -->
                <div id="steinschutz-felder" class="service-felder" style="display:none;">
                    <div class="section-title" style="margin-top: var(--space-4);">
                        <i data-feather="circle"></i>
                        Steinschutzfolie Details
                    </div>

                    <div class="form-group">
                        <label for="steinschutzUmfang" class="form-label">Schutzumfang <span class="required">*</span></label>
                        <select id="steinschutzUmfang" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="premium">üõ°Ô∏è Premium-Paket (Komplettschutz)</option>
                            <option value="standard">üì¶ Standard-Paket (Front, Motorhaube, Spiegel)</option>
                            <option value="minimal">‚ö° Minimal-Paket (nur Front)</option>
                            <option value="individuell">üéØ Individuell (Bereiche ausw√§hlen)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="steinschutzMaterial" class="form-label">Materialqualit√§t <span class="required">*</span></label>
                        <select id="steinschutzMaterial" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="standard">üì¶ Standard PPF (5 Jahre)</option>
                            <option value="premium">üíé Premium PPF (7 Jahre)</option>
                            <option value="self-healing">üîÑ Self-Healing (10 Jahre)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="steinschutzBereiche" class="form-label">Zu sch√ºtzende Bereiche</label>
                        <textarea id="steinschutzBereiche" class="form-input" rows="2" placeholder="z.B. Front-Sto√üstange, Motorhaube, Kotfl√ºgel, Spiegel..."></textarea>
                        <small style="color: var(--color-text-tertiary);">Nur bei individueller Auswahl</small>
                    </div>

                    <div class="form-group">
                        <label for="steinschutzInfo" class="form-label">Zus√§tzliche Informationen</label>
                        <textarea id="steinschutzInfo" class="form-input" rows="2" placeholder="Besondere Anforderungen, vorhandene Lacksch√§den..."></textarea>
                    </div>
                </div>

                <!-- Fahrzeugbeschriftung Felder -->
                <div id="werbebeklebung-felder" class="service-felder" style="display:none;">
                    <div class="section-title" style="margin-top: var(--space-4);">
                        <i data-feather="circle"></i>
                        Fahrzeugbeschriftung Details
                    </div>

                    <div class="form-group">
                        <label for="werbebeklebungUmfang" class="form-label">Umfang der Beklebung <span class="required">*</span></label>
                        <select id="werbebeklebungUmfang" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="vollbeklebung">üöö Vollbeklebung (alle Seiten)</option>
                            <option value="teilbeklebung">‚úÇÔ∏è Teilbeklebung (bestimmte Bereiche)</option>
                            <option value="logo-only">üè∑Ô∏è Nur Logo</option>
                            <option value="schriftzug">‚úçÔ∏è Schriftzug</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="werbebeklebungKomplexitaet" class="form-label">Design-Komplexit√§t <span class="required">*</span></label>
                        <select id="werbebeklebungKomplexitaet" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="einfach">üìù Einfach (Text + Logo, 1-2 Farben)</option>
                            <option value="mittel">üé® Mittel (Logo + Text + Grafiken, 3-5 Farben)</option>
                            <option value="komplex">üåà Komplex (Vollfl√§chiges Design, 6+ Farben)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="werbebeklebungText" class="form-label">Textelemente <span class="required">*</span></label>
                        <textarea id="werbebeklebungText" class="form-input" rows="3" placeholder="Firmenname, Slogan, Kontaktdaten (Telefon, Website, E-Mail)..."></textarea>
                        <small style="color: var(--color-text-tertiary);">Alle Texte, die auf dem Fahrzeug erscheinen sollen</small>
                    </div>

                    <div class="form-group">
                        <label for="werbebeklebungFarbanzahl" class="form-label">Anzahl Farben</label>
                        <input type="number" id="werbebeklebungFarbanzahl" class="form-input" min="1" max="10" value="2" placeholder="Anzahl der verwendeten Farben">
                    </div>

                    <div class="form-group">
                        <label for="werbebeklebungInfo" class="form-label">Zus√§tzliche Informationen</label>
                        <textarea id="werbebeklebungInfo" class="form-input" rows="2" placeholder="Besondere W√ºnsche, Zeitrahmen, Referenzbilder..."></textarea>
                    </div>
                </div>

                <!-- ABHOLUNG -->
                <div class="section-title">
                    <i data-feather="truck"></i>
                    Fahrzeug-Abholung
                </div>

                <div class="form-group">
                    <label class="form-label">Fahrzeug abholen?</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="fahrzeugAbholung" value="nein" checked onchange="toggleAbholungDetails()">
                            <span>Nein, Kunde bringt Fahrzeug selbst</span>
                        </label>
                        <label>
                            <input type="radio" name="fahrzeugAbholung" value="ja" onchange="toggleAbholungDetails()">
                            <span>Ja, Fahrzeug abholen</span>
                        </label>
                    </div>
                </div>

                <!-- Conditional Fields -->
                <div id="abholungDetails" style="display: none;">
                    <div class="form-group">
                        <label for="abholadresse" class="form-label">Abholadresse <span class="required">*</span></label>
                        <textarea id="abholadresse" class="form-textarea" placeholder="Stra√üe, Hausnummer&#10;PLZ, Ort" rows="3"></textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="abholdatum" class="form-label">Gew√ºnschtes Abholdatum</label>
                            <input type="date" id="abholdatum" class="form-input">
                        </div>

                        <div class="form-group">
                            <label for="abholzeit" class="form-label">Gew√ºnschte Abholzeit</label>
                            <input type="time" id="abholzeit" class="form-input">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="abholnotiz" class="form-label">Notiz zur Abholung (optional)</label>
                        <textarea id="abholnotiz" class="form-textarea" placeholder="z.B. Zufahrt, Besonderheiten, Ansprechpartner" rows="2"></textarea>
                    </div>
                </div>

                <!-- FAHRZEUGDATEN -->
                <div class="section-title">
                    <i data-feather="truck"></i>
                    Fahrzeugdaten
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="marke" class="form-label">Marke <span class="required">*</span></label>
                        <select id="marke" class="form-select" required>
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="Audi">Audi</option>
                            <option value="BMW">BMW</option>
                            <option value="Citroen">Citroen</option>
                            <option value="Cupra">Cupra</option>
                            <option value="Fiat">Fiat</option>
                            <option value="Ford">Ford</option>
                            <option value="Honda">Honda</option>
                            <option value="Hyundai">Hyundai</option>
                            <option value="Kia">Kia</option>
                            <option value="Mazda">Mazda</option>
                            <option value="Mercedes-Benz">Mercedes-Benz</option>
                            <option value="MINI">MINI</option>
                            <option value="Nissan">Nissan</option>
                            <option value="Opel">Opel</option>
                            <option value="Peugeot">Peugeot</option>
                            <option value="Porsche">Porsche</option>
                            <option value="Renault">Renault</option>
                            <option value="Seat">Seat</option>
                            <option value="Skoda">Skoda</option>
                            <option value="Suzuki">Suzuki</option>
                            <option value="Toyota">Toyota</option>
                            <option value="Volkswagen">Volkswagen</option>
                            <option value="Volvo">Volvo</option>
                            <option value="Sonstige">Sonstige</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="modell" class="form-label">Modell <span class="required">*</span></label>
                        <input type="text" id="modell" class="form-input" placeholder="z.B. Golf 8, A4, 3er" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Baujahr</label>
                        <div style="display: flex; gap: var(--space-2); align-items: center;">
                            <select id="baujahrVon" class="form-select" style="flex: 1;">
                                <option value="">Von</option>
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                                <option value="2023">2023</option>
                                <option value="2022">2022</option>
                                <option value="2021">2021</option>
                                <option value="2020">2020</option>
                                <option value="2019">2019</option>
                                <option value="2018">2018</option>
                                <option value="2017">2017</option>
                                <option value="2016">2016</option>
                                <option value="2015">2015</option>
                                <option value="2014">2014</option>
                                <option value="2013">2013</option>
                                <option value="2012">2012</option>
                                <option value="2011">2011</option>
                                <option value="2010">2010</option>
                                <option value="2009">2009</option>
                                <option value="2008">2008</option>
                                <option value="2007">2007</option>
                                <option value="2006">2006</option>
                                <option value="2005">2005</option>
                                <option value="2004">2004</option>
                                <option value="2003">2003</option>
                                <option value="2002">2002</option>
                                <option value="2001">2001</option>
                                <option value="2000">2000</option>
                                <option value="√Ñlter">√Ñlter als 2000</option>
                            </select>
                            <span style="font-weight: 600; color: var(--color-text-secondary);">-</span>
                            <select id="baujahrBis" class="form-select" style="flex: 1;">
                                <option value="">Bis</option>
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                                <option value="2023">2023</option>
                                <option value="2022">2022</option>
                                <option value="2021">2021</option>
                                <option value="2020">2020</option>
                                <option value="2019">2019</option>
                                <option value="2018">2018</option>
                                <option value="2017">2017</option>
                                <option value="2016">2016</option>
                                <option value="2015">2015</option>
                                <option value="2014">2014</option>
                                <option value="2013">2013</option>
                                <option value="2012">2012</option>
                                <option value="2011">2011</option>
                                <option value="2010">2010</option>
                                <option value="2009">2009</option>
                                <option value="2008">2008</option>
                                <option value="2007">2007</option>
                                <option value="2006">2006</option>
                                <option value="2005">2005</option>
                                <option value="2004">2004</option>
                                <option value="2003">2003</option>
                                <option value="2002">2002</option>
                                <option value="2001">2001</option>
                                <option value="2000">2000</option>
                                <option value="√Ñlter">√Ñlter als 2000</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="kmstand" class="form-label">KM-Stand</label>
                        <input type="number" id="kmstand" class="form-input" placeholder="z.B. 45000">
                    </div>
                </div>

                <div class="form-group">
                    <label for="vin" class="form-label">VIN/FIN (optional)</label>
                    <input type="text" id="vin" class="form-input" placeholder="Fahrgestellnummer">
                </div>

                <!-- LACKIER-INFORMATIONEN (nur f√ºr Lackierung & Alle Services) -->
                <div id="lackierung-felder" class="service-felder" style="display:none;">
                    <div class="section-title">
                        <i data-feather="droplet"></i>
                        Lackier-Informationen
                    </div>

                    <div class="form-group">
                        <label for="farbname" class="form-label">Farbname</label>
                        <input type="text" id="farbname" class="form-input" placeholder="z.B. Silber Metallic, Tiefes Schwarz Perleffekt">
                    </div>

                    <div class="form-group">
                        <label for="farbvariante" class="form-label">üî¨ Farbvariante (f√ºr Lackierer)</label>
                        <input type="text" id="farbvariante" class="form-input" list="farbvarianten-liste" placeholder="z.B. Variante A, Mischung 1, Hell abget√∂nt">
                        <datalist id="farbvarianten-liste">
                            <option value="Standard">
                            <option value="Variante A">
                            <option value="Variante B">
                            <option value="Variante C">
                            <option value="Mischung 1">
                            <option value="Mischung 2">
                            <option value="Hell abget√∂nt">
                            <option value="Dunkel abget√∂nt">
                            <option value="Metallic-Effekt">
                            <option value="Matt-Finish">
                        </datalist>
                        <small style="color: var(--color-text-tertiary); font-size: var(--font-size-xs); display: block; margin-top: var(--space-1);">
                            üí° Notiz f√ºr Lackierer: Welche Mischvariante wurde verwendet?
                        </small>
                    </div>

                    <div class="form-group highlight">
                        <label for="farbnummer" class="form-label">üé® FARBNUMMER / FARBCODE <span class="required">*</span></label>
                        <input type="text" id="farbnummer" class="form-input" placeholder="z.B. LC9Z, C7A, A96, LY9B" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Lackart <span class="required">*</span></label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="lackart" value="Uni" required>
                                <span>Uni / Solid</span>
                            </label>
                            <label>
                                <input type="radio" name="lackart" value="Metallic" checked>
                                <span>Metallic</span>
                            </label>
                            <label>
                                <input type="radio" name="lackart" value="Perleffekt">
                                <span>Perleffekt</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- FOTOS -->
                <div class="section-title">
                    <i data-feather="camera"></i>
                    Fotos
                </div>

                <div class="photo-section">
                    <label class="form-label">Schadensfotos (min. 1 Foto erforderlich)</label>
                    <div class="photo-grid" id="photoGrid">
                        <div class="photo-item empty" onclick="document.getElementById('photoInput').click()">
                            <i data-feather="camera"></i>
                            <span>Foto hinzuf√ºgen</span>
                        </div>
                    </div>
                    <input type="file" id="photoInput" accept="image/*" capture="environment" multiple>
                </div>

                <!-- NOTIZEN -->
                <div class="section-title">
                    <i data-feather="file-text"></i>
                    Schadensbeschreibung & Preis
                </div>

                <div class="form-group">
                    <label for="notizen" class="form-label">Notizen / Schadensbeschreibung</label>
                    <textarea id="notizen" class="form-textarea" placeholder="z.B. Delle an linker T√ºr, Kratzer am Kotfl√ºgel hinten rechts..."></textarea>
                </div>

                <div class="form-group">
                    <label for="vereinbarterPreis" class="form-label">üí∞ Vereinbarter Preis <span class="required">*</span></label>
                    <input type="number" id="vereinbarterPreis" class="form-input" placeholder="0.00" step="0.01" min="0.01" required style="font-size: var(--font-size-lg); font-weight: bold;">
                    <small style="color: var(--color-text-tertiary); display: block; margin-top: var(--space-1);">Erforderlich f√ºr vollst√§ndige Dokumentation</small>
                </div>

                <!-- UNTERSCHRIFT -->
                <div class="section-title">
                    <i data-feather="edit-3"></i>
                    Unterschrift
                </div>

                <div class="signature-section">
                    <label class="form-label">Unterschrift Kunde <span class="required">*</span></label>
                    <canvas id="signatureCanvas" width="800" height="400"></canvas>
                    <div class="signature-buttons">
                        <button type="button" class="btn btn-secondary btn-sm" onclick="clearSignature()">
                            <i data-feather="x"></i>
                            L√∂schen
                        </button>
                    </div>
                </div>

                <div class="submit-buttons">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i data-feather="save"></i>
                        Speichern & PDF erstellen
                    </button>
                    <button type="button" class="btn btn-secondary btn-lg" onclick="createArbeitsauftrag()">
                        <i data-feather="file"></i>
                        Arbeitsauftrag f√ºr Werkstatt drucken
                    </button>
                </div>
            </div>
        </form>
    </div>

    <script>
        // Initialize Feather Icons
        feather.replace();

        // Firebase initialisieren
        let firebaseInitialized = false;

        // Auto-Save: Entwurf speichern bei Eingabe
        let autoSaveTimeout;
        function saveDraft() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                const draft = {
                    kennzeichen: document.getElementById('kennzeichen').value.trim().toUpperCase(),
                    kundenname: document.getElementById('kundenname').value,
                    kundenEmail: document.getElementById('kundenEmail').value,
                    telefon: document.getElementById('telefon').value,
                    geplantesAbnahmeDatum: document.getElementById('geplantesAbnahmeDatum').value,
                    serviceTyp: document.getElementById('serviceTyp').value,
                    fahrzeugAbholung: document.querySelector('input[name="fahrzeugAbholung"]:checked').value,
                    abholadresse: document.getElementById('abholadresse').value,
                    abholdatum: document.getElementById('abholdatum').value,
                    abholzeit: document.getElementById('abholzeit').value,
                    abholnotiz: document.getElementById('abholnotiz').value,
                    marke: document.getElementById('marke').value,
                    modell: document.getElementById('modell').value,
                    baujahrVon: document.getElementById('baujahrVon').value,
                    baujahrBis: document.getElementById('baujahrBis').value,
                    kmstand: document.getElementById('kmstand').value,
                    vin: document.getElementById('vin').value,
                    farbname: document.getElementById('farbname').value,
                    farbvariante: document.getElementById('farbvariante').value,
                    farbnummer: document.getElementById('farbnummer').value,
                    notizen: document.getElementById('notizen').value,
                    vereinbarterPreis: document.getElementById('vereinbarterPreis').value,
                    timestamp: Date.now()
                };

                if (draft.kennzeichen || draft.kundenname || draft.marke) {
                    localStorage.setItem('annahme_draft', JSON.stringify(draft));
                    console.log('üíæ Entwurf gespeichert');
                }
            }, 2000);
        }

        // Entwurf laden
        function loadDraft() {
            const draft = localStorage.getItem('annahme_draft');
            if (draft) {
                const data = JSON.parse(draft);
                const ageMinutes = (Date.now() - data.timestamp) / 1000 / 60;

                if (ageMinutes < 60 && confirm('üîÑ Entwurf gefunden! M√∂chten Sie Ihre letzte Eingabe wiederherstellen?')) {
                    document.getElementById('kennzeichen').value = data.kennzeichen || '';
                    document.getElementById('kundenname').value = data.kundenname || '';
                    document.getElementById('kundenEmail').value = data.kundenEmail || '';
                    document.getElementById('telefon').value = data.telefon || '';
                    document.getElementById('geplantesAbnahmeDatum').value = data.geplantesAbnahmeDatum || '';
                    document.getElementById('serviceTyp').value = data.serviceTyp || 'lackier';
                    document.getElementById('marke').value = data.marke || '';
                    document.getElementById('modell').value = data.modell || '';
                    document.getElementById('baujahrVon').value = data.baujahrVon || data.baujahr || '';
                    document.getElementById('baujahrBis').value = data.baujahrBis || data.baujahr || '';
                    document.getElementById('kmstand').value = data.kmstand || '';
                    document.getElementById('vin').value = data.vin || '';
                    document.getElementById('farbname').value = data.farbname || '';
                    document.getElementById('farbvariante').value = data.farbvariante || '';
                    document.getElementById('farbnummer').value = data.farbnummer || '';
                    document.getElementById('notizen').value = data.notizen || '';
                    document.getElementById('vereinbarterPreis').value = data.vereinbarterPreis || '';

                    if (data.fahrzeugAbholung) {
                        const abholungRadio = document.querySelector(`input[name="fahrzeugAbholung"][value="${data.fahrzeugAbholung}"]`);
                        if (abholungRadio) {
                            abholungRadio.checked = true;
                            toggleAbholungDetails();
                        }
                        document.getElementById('abholadresse').value = data.abholadresse || '';
                        document.getElementById('abholdatum').value = data.abholdatum || '';
                        document.getElementById('abholzeit').value = data.abholzeit || '';
                        document.getElementById('abholnotiz').value = data.abholnotiz || '';
                    }

                    // Service-spezifische Felder visibility & required status updaten
                    const restoredServiceTyp = data.serviceTyp || 'lackier';
                    toggleServiceFelder(); // Zeigt die richtigen Felder basierend auf serviceTyp
                    updateRequiredFields(restoredServiceTyp); // Setzt required Attribute korrekt
                    console.log('‚úÖ Required fields initialized for restored draft:', restoredServiceTyp);

                    console.log('‚úÖ Entwurf wiederhergestellt');
                }
            }
        }

        // Entwurf l√∂schen nach erfolgreichem Speichern
        function clearDraft() {
            localStorage.removeItem('annahme_draft');
        }

        // Auto-Save bei Eingabe aktivieren
        let allKunden = [];

        // ‚ú® SERVICE-SPEZIFISCHE FELDER TOGGLE
        function toggleServiceFelder() {
            // Alle service-felder verstecken
            document.querySelectorAll('.service-felder').forEach(el => el.style.display = 'none');

            // Nur relevante Felder f√ºr ausgew√§hlten Service zeigen
            const serviceTyp = document.getElementById('serviceTyp').value;
            const felderDiv = document.getElementById(`${serviceTyp}-felder`);

            if (felderDiv) {
                felderDiv.style.display = 'block';
                console.log(`‚ú® Service-Felder angezeigt f√ºr: ${serviceTyp}`);
            }

            // Lackierung-Felder auch f√ºr "alle" Services zeigen
            if (serviceTyp === 'lackier' || serviceTyp === 'alle') {
                const lackierDiv = document.getElementById('lackierung-felder');
                if (lackierDiv) {
                    lackierDiv.style.display = 'block';
                    console.log('üé® Lackier-Informationen angezeigt');
                }
            }

            // NEU: Bei Dellen ‚Üí Pr√ºfe Lackschaden-Wert f√ºr Lackier-Felder
            if (serviceTyp === 'dellen') {
                toggleDellenLackierung();
            }

            // Pflichtfelder dynamisch anpassen
            updateRequiredFields(serviceTyp);
        }

        // üé® DELLEN + LACKSCHADEN LOGIC
        function toggleDellenLackierung() {
            const serviceTyp = document.getElementById('serviceTyp').value;
            const lackschadenWert = document.getElementById('lackschaden').value;
            const lackierDiv = document.getElementById('lackierung-felder');

            if (!lackierDiv) return;

            // Nur f√ºr Dellen-Service relevant
            if (serviceTyp === 'dellen') {
                if (lackschadenWert === 'ja') {
                    lackierDiv.style.display = 'block';
                    console.log('üé® Lackier-Felder angezeigt (Dellen + Lackschaden)');

                    // Farbnummer PFLICHT machen
                    const farbnummerInput = document.getElementById('farbnummer');
                    if (farbnummerInput) {
                        farbnummerInput.required = true;
                    }
                } else {
                    lackierDiv.style.display = 'none';
                    console.log('üîß Lackier-Felder versteckt (Dellen ohne Lackschaden)');

                    // Farbnummer OPTIONAL machen
                    const farbnummerInput = document.getElementById('farbnummer');
                    if (farbnummerInput) {
                        farbnummerInput.required = false;
                    }
                }
            }
        }

        // ‚ú® DYNAMISCHE PFLICHTFELDER - Verhindert "invalid form control" Warnungen
        function updateRequiredFields(serviceTyp) {
            // Service-Feld-Mapping: Welche Felder sind f√ºr welchen Service PFLICHT?
            const serviceRequiredFields = {
                'lackierung': ['farbnummer'],
                'alle': ['farbnummer'],
                'reifen': ['reifengroesse', 'reifentyp', 'reifenanzahl'],
                'glas': ['glasart', 'schadengroesse', 'glasposition'],
                'klima': ['klimaproblem'],
                'dellen': ['dellenanzahl', 'dellengroesse'],
                'mechanik': ['mechanik-problem'],
                'versicherung': ['versicherung-schadensnummer', 'versicherung-name'],
                'pflege': ['pflege-paket'],
                'tuev': ['tuev-faelligkeit'],
                'folierung': ['folierungArt', 'folierungMaterial', 'folierungFarbe'],
                'steinschutz': ['steinschutzUmfang', 'steinschutzMaterial'],
                'werbebeklebung': ['werbebeklebungUmfang', 'werbebeklebungKomplexitaet', 'werbebeklebungText']
            };

            // ALLE m√∂glichen service-spezifischen Felder
            const allServiceFields = [
                // Lackierung
                'farbnummer',
                // Reifen
                'reifengroesse', 'reifentyp', 'reifenanzahl',
                // Glas
                'glasart', 'schadengroesse', 'glasposition',
                // Klima
                'klimaproblem', 'letzte_wartung',
                // Dellen
                'dellenanzahl', 'dellengroesse', 'dellenpositionen',
                // Mechanik
                'mechanik-problem', 'mechanik-symptome',
                // Versicherung
                'versicherung-schadensnummer', 'versicherung-name', 'versicherung-schadendatum', 'versicherung-hergang',
                // Pflege
                'pflege-paket', 'pflege-zusatz',
                // T√úV
                'tuev-faelligkeit', 'tuev-maengel',
                // Folierung
                'folierungArt', 'folierungMaterial', 'folierungFarbe', 'folierungDesign', 'folierungInfo',
                // Steinschutz
                'steinschutzUmfang', 'steinschutzMaterial', 'steinschutzBereiche', 'steinschutzInfo',
                // Werbebeklebung
                'werbebeklebungUmfang', 'werbebeklebungKomplexitaet', 'werbebeklebungText', 'werbebeklebungFarbanzahl', 'werbebeklebungInfo'
            ];

            // SCHRITT 1: ALLE Felder auf OPTIONAL setzen
            allServiceFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) field.required = false;
            });

            // SCHRITT 2: Lackart Radio-Buttons auf OPTIONAL setzen
            const lackartRadios = document.querySelectorAll('input[name="lackart"]');
            lackartRadios.forEach(radio => radio.required = false);

            // SCHRITT 3: NUR aktuelle Service-Felder PFLICHT machen
            const requiredFields = serviceRequiredFields[serviceTyp] || [];
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) field.required = true;
            });

            // SCHRITT 4: Lackart PFLICHT f√ºr Lackierung/Alle
            if (serviceTyp === 'lackier' || serviceTyp === 'alle') {
                lackartRadios.forEach(radio => radio.required = true);
            }

            // NEU - SCHRITT 5: Lackschaden bei Dellen ‚Üí Farbnummer & Lackart PFLICHT
            if (serviceTyp === 'dellen') {
                const lackschadenSelect = document.getElementById('lackschaden');
                const lackschadenWert = lackschadenSelect ? lackschadenSelect.value : '';
                const farbnummerInput = document.getElementById('farbnummer');

                if (lackschadenWert === 'ja') {
                    if (farbnummerInput) {
                        farbnummerInput.required = true;
                    }
                    lackartRadios.forEach(radio => radio.required = true);
                    console.log('üé® Farbnummer & Lackart: PFLICHT (Dellen + Lackschaden)');
                }
            }

            console.log(`‚úÖ Required fields updated: ${serviceTyp} (${requiredFields.length} Pflichtfelder)`);
        }

        // Event Listener f√ºr serviceTyp Dropdown (sofort nach Definition)
        document.addEventListener('DOMContentLoaded', function() {
            const serviceTypSelect = document.getElementById('serviceTyp');
            if (serviceTypSelect) {
                window.listenerRegistry.registerDOM(serviceTypSelect, 'change', toggleServiceFelder, 'Service Typ Select Change');
                console.log('‚úÖ serviceTyp Event Listener registered');
            }

            // NEU: Show initial service fields for default selection (Lackierung)
            toggleServiceFelder();
            console.log('‚úÖ Initial service fields toggled on page load');

            // NEU: Event Listener f√ºr Lackschaden Select (Dellen + Lackschaden)
            const lackschadenSelect = document.getElementById('lackschaden');
            if (lackschadenSelect) {
                window.listenerRegistry.registerDOM(lackschadenSelect, 'change', toggleDellenLackierung, 'Lackschaden Select Change');
                console.log('‚úÖ lackschaden Event Listener registered');
            }

            // NEU: Event Listener f√ºr Folierung Material (Spezialtyp conditional)
            const folierungMaterialSelect = document.getElementById('folierungMaterial');
            if (folierungMaterialSelect) {
                window.listenerRegistry.registerDOM(folierungMaterialSelect, 'change', function() {
                    const spezialTypGroup = document.getElementById('folierungSpezialTypGroup');
                    if (spezialTypGroup) {
                        if (folierungMaterialSelect.value === 'spezial') {
                            spezialTypGroup.style.display = 'block';
                            document.getElementById('folierungSpezialTyp').setAttribute('required', 'required');
                        } else {
                            spezialTypGroup.style.display = 'none';
                            document.getElementById('folierungSpezialTyp').removeAttribute('required');
                            document.getElementById('folierungSpezialTyp').value = '';
                        }
                    }
                }, 'Folierung Material Select Change');
                console.log('‚úÖ folierungMaterial Event Listener registered');
            }

            // NEU: Event Listener f√ºr Folierung Art (Bereiche conditional)
            const folierungArtSelect = document.getElementById('folierungArt');
            if (folierungArtSelect) {
                window.listenerRegistry.registerDOM(folierungArtSelect, 'change', function() {
                    const bereicheGroup = document.getElementById('folierungBereicheGroup');
                    if (bereicheGroup) {
                        if (folierungArtSelect.value === 'teilfolierung' || folierungArtSelect.value === 'akzente') {
                            bereicheGroup.style.display = 'block';
                            // Set required for at least one checkbox
                            document.querySelectorAll('input[name="folierungBereiche"]').forEach(cb => cb.setAttribute('required', 'required'));
                        } else {
                            bereicheGroup.style.display = 'none';
                            // Remove required and uncheck all
                            document.querySelectorAll('input[name="folierungBereiche"]').forEach(cb => {
                                cb.removeAttribute('required');
                                cb.checked = false;
                            });
                        }
                    }
                }, 'Folierung Art Select Change');
                console.log('‚úÖ folierungArt Event Listener registered');
            }
        });

        // Firebase initialisieren und Kunden laden
        document.addEventListener('DOMContentLoaded', async function() {
            // Radio-Button visuelle Effekte initialisieren
            initRadioVisuals();

            // Pr√ºfe ob Nachannahme-Modus (von Partner-Fahrzeugen)
            const urlParams = new URLSearchParams(window.location.search);
            const nachannahmeModus = urlParams.get('mode') === 'nachannahme';
            const fahrzeugId = urlParams.get('id');

            if (nachannahmeModus && fahrzeugId) {
                console.log('üîÑ Nachannahme-Modus aktiv f√ºr Fahrzeug:', fahrzeugId);

                const nachannahmeDataStr = sessionStorage.getItem('partnerFahrzeugNachannahme');
                if (nachannahmeDataStr) {
                    const nachannahmeData = JSON.parse(nachannahmeDataStr);
                    console.log('üìã Nachannahme-Daten geladen:', nachannahmeData);

                    // Hinweis-Banner anzeigen
                    const form = document.getElementById('annahmeForm');
                    const banner = document.createElement('div');
                    banner.className = 'info-box';
                    banner.style.cssText = 'background: rgba(33, 150, 243, 0.15); border-color: rgba(33, 150, 243, 0.4); margin-bottom: var(--space-6);';
                    banner.innerHTML = `
                        <i data-feather="refresh-cw"></i>
                        <div class="info-box-content">
                            <strong>üîÑ PHYSISCHE NACHANNAHME</strong>
                            <p>
                                Fahrzeug: <strong>${nachannahmeData.marke} ${nachannahmeData.modell}</strong> ‚Ä¢ Kennzeichen: <strong>${nachannahmeData.kennzeichen}</strong><br>
                                Die Fahrzeugdaten sind vorausgef√ºllt. Erg√§nzen Sie jetzt:<br>
                                üì∏ Schadenfotos ‚Ä¢ ‚úçÔ∏è Kundenunterschrift ‚Ä¢ üìã Zus√§tzliche Notizen
                            </p>
                        </div>
                    `;
                    form.insertBefore(banner, form.firstChild);
                    feather.replace();

                    // Formular vorausf√ºllen (read-only)
                    document.getElementById('kennzeichen').value = nachannahmeData.kennzeichen;
                    document.getElementById('kennzeichen').readOnly = true;
                    document.getElementById('marke').value = nachannahmeData.marke || '';
                    document.getElementById('marke').readOnly = true;
                    document.getElementById('modell').value = nachannahmeData.modell || '';
                    document.getElementById('modell').readOnly = true;
                    document.getElementById('baujahrVon').value = nachannahmeData.baujahrVon || '';
                    document.getElementById('baujahrVon').readOnly = true;
                    document.getElementById('baujahrBis').value = nachannahmeData.baujahrBis || '';
                    document.getElementById('baujahrBis').readOnly = true;
                    document.getElementById('kmstand').value = nachannahmeData.kmstand || '';
                    document.getElementById('vin').value = nachannahmeData.vin || '';
                    document.getElementById('farbnummer').value = nachannahmeData.farbnummer || '';
                    document.getElementById('farbnummer').readOnly = true;
                    document.getElementById('farbname').value = nachannahmeData.farbname || '';
                    document.getElementById('lackart').value = nachannahmeData.lackart || '';
                    document.getElementById('kundenname').value = nachannahmeData.kundenname || '';
                    document.getElementById('kundenname').readOnly = true;
                    document.getElementById('notizen').value = nachannahmeData.schadenBeschreibung || '';

                    // üîÑ NEW: Map serviceData to form fields for ALL 12 services
                    if (nachannahmeData.serviceData && nachannahmeData.serviceTyp) {
                        const sd = nachannahmeData.serviceData;
                        console.log('üîÑ Mapping serviceData f√ºr Service:', nachannahmeData.serviceTyp, sd);

                        switch (nachannahmeData.serviceTyp) {
                            case 'folierung':
                                if (sd.folierungArt) {
                                    document.getElementById('folierungArt').value = sd.folierungArt;
                                    // Trigger bereiche visibility
                                    if (sd.folierungArt === 'teilfolierung' || sd.folierungArt === 'akzente') {
                                        document.getElementById('folierungBereicheGroup').style.display = 'block';
                                    }
                                }
                                if (sd.folierungMaterial) {
                                    document.getElementById('folierungMaterial').value = sd.folierungMaterial;
                                    // Trigger spezialTyp visibility
                                    if (sd.folierungMaterial === 'spezial') {
                                        document.getElementById('folierungSpezialTypGroup').style.display = 'block';
                                    }
                                }
                                if (sd.folierungSpezialTyp) document.getElementById('folierungSpezialTyp').value = sd.folierungSpezialTyp;
                                if (sd.folierungFarbe) document.getElementById('folierungFarbe').value = sd.folierungFarbe;
                                if (sd.folierungBereiche && Array.isArray(sd.folierungBereiche)) {
                                    sd.folierungBereiche.forEach(bereich => {
                                        const checkbox = document.querySelector(`input[name="folierungBereiche"][value="${bereich}"]`);
                                        if (checkbox) checkbox.checked = true;
                                    });
                                }
                                if (sd.folierungDesign) document.getElementById('folierungDesign').value = sd.folierungDesign;
                                if (sd.folierungInfo) document.getElementById('folierungInfo').value = sd.folierungInfo;
                                console.log('‚úÖ Folierung-Felder gef√ºllt');
                                break;

                            case 'steinschutz':
                                if (sd.steinschutzUmfang) document.getElementById('steinschutzUmfang').value = sd.steinschutzUmfang;
                                if (sd.steinschutzMaterial) document.getElementById('steinschutzMaterial').value = sd.steinschutzMaterial;
                                if (sd.steinschutzBereiche) {
                                    // Convert array to comma-separated string
                                    const bereicheStr = Array.isArray(sd.steinschutzBereiche) ? sd.steinschutzBereiche.join(', ') : sd.steinschutzBereiche;
                                    document.getElementById('steinschutzBereiche').value = bereicheStr;
                                }
                                if (sd.steinschutzInfo) document.getElementById('steinschutzInfo').value = sd.steinschutzInfo;
                                console.log('‚úÖ Steinschutz-Felder gef√ºllt');
                                break;

                            case 'werbebeklebung':
                                if (sd.werbebeklebungUmfang) document.getElementById('werbebeklebungUmfang').value = sd.werbebeklebungUmfang;
                                if (sd.werbebeklebungKomplexitaet) document.getElementById('werbebeklebungKomplexitaet').value = sd.werbebeklebungKomplexitaet;
                                if (sd.werbebeklebungText) document.getElementById('werbebeklebungText').value = sd.werbebeklebungText;
                                if (sd.werbebeklebungFarbanzahl) document.getElementById('werbebeklebungFarbanzahl').value = sd.werbebeklebungFarbanzahl;
                                if (sd.werbebeklebungInfo) document.getElementById('werbebeklebungInfo').value = sd.werbebeklebungInfo;
                                console.log('‚úÖ Werbebeklebung-Felder gef√ºllt');
                                break;

                            case 'reifen':
                                if (sd.dimension) document.getElementById('reifengroesse').value = sd.dimension;
                                if (sd.typ) document.getElementById('reifentyp').value = sd.typ;
                                if (sd.anzahl) document.getElementById('reifenanzahl').value = sd.anzahl;
                                if (sd.info) document.getElementById('reifenInfo').value = sd.info;
                                console.log('‚úÖ Reifen-Felder gef√ºllt');
                                break;

                            case 'glas':
                                if (sd.art) document.getElementById('glasArt').value = sd.art;
                                if (sd.position) document.getElementById('glasPosition').value = sd.position;
                                if (sd.info) document.getElementById('glasInfo').value = sd.info;
                                console.log('‚úÖ Glas-Felder gef√ºllt');
                                break;

                            case 'klima':
                                if (sd.art) document.getElementById('klimaArt').value = sd.art;
                                if (sd.problem) document.getElementById('klimaProblem').value = sd.problem;
                                if (sd.info) document.getElementById('klimaInfo').value = sd.info;
                                console.log('‚úÖ Klima-Felder gef√ºllt');
                                break;

                            case 'dellen':
                                if (sd.anzahl) document.getElementById('dellenAnzahl').value = sd.anzahl;
                                if (sd.groesse) document.getElementById('dellenGroesse').value = sd.groesse;
                                if (sd.position) document.getElementById('dellenPosition').value = sd.position;
                                if (sd.info) document.getElementById('dellenInfo').value = sd.info;
                                console.log('‚úÖ Dellen-Felder gef√ºllt');
                                break;

                            case 'mechanik':
                                if (sd.art) document.getElementById('mechanikArt').value = sd.art;
                                if (sd.problem) document.getElementById('mechanikProblem').value = sd.problem;
                                if (sd.info) document.getElementById('mechanikInfo').value = sd.info;
                                console.log('‚úÖ Mechanik-Felder gef√ºllt');
                                break;

                            case 'pflege':
                                if (sd.art) document.getElementById('pflegeArt').value = sd.art;
                                if (sd.umfang) document.getElementById('pflegeUmfang').value = sd.umfang;
                                if (sd.info) document.getElementById('pflegeInfo').value = sd.info;
                                console.log('‚úÖ Pflege-Felder gef√ºllt');
                                break;

                            case 'tuev':
                                if (sd.art) document.getElementById('tuevArt').value = sd.art;
                                if (sd.termin) document.getElementById('tuevTermin').value = sd.termin;
                                if (sd.info) document.getElementById('tuevInfo').value = sd.info;
                                console.log('‚úÖ T√úV-Felder gef√ºllt');
                                break;

                            case 'versicherung':
                                if (sd.art) document.getElementById('versicherungArt').value = sd.art;
                                if (sd.schadenNummer) document.getElementById('versicherungSchadenNr').value = sd.schadenNummer;
                                if (sd.versicherung) document.getElementById('versicherungName').value = sd.versicherung;
                                if (sd.info) document.getElementById('versicherungInfo').value = sd.info;
                                console.log('‚úÖ Versicherung-Felder gef√ºllt');
                                break;

                            case 'lackierung':
                                if (sd.art) document.getElementById('lackArt').value = sd.art;
                                if (sd.umfang) document.getElementById('lackUmfang').value = sd.umfang;
                                if (sd.info) document.getElementById('lackInfo').value = sd.info;
                                console.log('‚úÖ Lackierung-Felder gef√ºllt');
                                break;
                        }
                    }

                    window.istNachannahme = true;
                    window.nachannahmeFahrzeugId = fahrzeugId;
                    window.nachannahmeData = nachannahmeData;
                }
            }

            // Auto-save f√ºr Form-Inputs
            const inputs = document.querySelectorAll('#annahmeForm input, #annahmeForm textarea');
            inputs.forEach(input => {
                window.listenerRegistry.registerDOM(input, 'input', saveDraft, `Form Input Auto-Save: ${input.id || input.name}`);
            });

            // Firebase initialisieren
            try {
                if (typeof initFirebase !== 'undefined') {
                    await initFirebase();
                    if (window.firebaseInitialized && window.firebaseApp) {
                        firebaseApp = window.firebaseApp;
                        firebaseInitialized = true;
                        console.log('‚úÖ Firebase initialisiert f√ºr Annahme');
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Firebase nicht verf√ºgbar, verwende LocalStorage:', error);
            }

            // Auth-Check f√ºr Multi-Tenant Support (Race Condition Fix)
            console.log('üîê Pr√ºfe Auth State f√ºr Multi-Tenant...');
            let currentUser = null;
            let attempts = 0;
            const maxAttempts = 20; // 5 Sekunden max

            while (!currentUser && attempts < maxAttempts) {
                currentUser = window.authManager?.getCurrentUser();
                if (!currentUser) {
                    console.log(`‚è≥ Warte auf Auth State Listener (Versuch ${attempts + 1}/${maxAttempts})...`);
                    await new Promise(resolve => setTimeout(resolve, 250));
                    attempts++;
                }
            }

            if (!currentUser) {
                console.warn('‚ö†Ô∏è Kein User eingeloggt - verwende globale Collections (nicht Multi-Tenant)');
                console.warn('   Tipp: Zuerst in index.html einloggen, dann annahme.html √∂ffnen');
                // Optional: Redirect zu Login
                // alert('‚ö†Ô∏è Bitte zuerst einloggen!');
                // window.location.href = 'index.html';
                // return;
            } else {
                console.log('‚úÖ Auth State erfolgreich geladen');
                console.log('   User:', currentUser.name);
                console.log('   Rolle:', currentUser.rolle);
                console.log('   WerkstattId:', currentUser.werkstattId);

                // üÜï BUGFIX 2025-11-04 (FIX #41): Partner-Zugriff auf Werkstatt-Seiten blockieren
                // Partner d√ºrfen nur das Partner-Portal nutzen, nicht Werkstatt-Seiten
                const userRole = currentUser.rolle || currentUser.role; // Support both property names
                if (userRole === 'partner') {
                    console.warn('üö´ Partner-Zugriff blockiert! Redirect zu Partner-Portal...');
                    window.location.href = './partner-app/meine-anfragen.html';
                    return; // Stop further execution
                }

                console.log('   ‚Üí Verwende Multi-Tenant Collections (z.B. fahrzeuge_' + currentUser.werkstattId + ')');
            }

            // Load Werkstatt Branding (Logo & Page Title)
            try {
                const settings = await window.settingsManager.loadSettings();
                if (settings?.profil) {
                    // Update Page Title
                    document.title = `${settings.profil.name} | Fahrzeugannahme`;

                    // Add Logo to Header (if available)
                    if (settings.profil.logoUrl) {
                        const header = document.querySelector('.mobile-header');
                        if (header) {
                            const logoContainer = document.createElement('div');
                            logoContainer.style.cssText = 'position: absolute; left: 16px; top: 50%; transform: translateY(-50%);';
                            logoContainer.innerHTML = `<img src="${settings.profil.logoUrl}" alt="${settings.profil.name}" style="height: 36px; width: auto;">`;
                            header.style.position = 'relative';
                            header.style.paddingLeft = '60px';
                            header.insertBefore(logoContainer, header.firstChild);
                        }
                    }

                    console.log('‚úÖ Werkstatt-Branding geladen:', settings.profil.name);
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Werkstatt-Branding konnte nicht geladen werden:', error);
            }

            // Kunden laden
            await loadKunden();

            // Auto-Save Entwurf wiederherstellen (nur wenn NICHT Nachannahme-Modus)
            if (!window.istNachannahme) {
                loadDraft();

                // SICHERHEITS-FIX: Farbnummer editierbar machen bei normalem Workflow
                // (Falls readOnly von fr√ºherem Nachannahme-Test noch gesetzt ist)
                const farbnummerInput = document.getElementById('farbnummer');
                if (farbnummerInput) {
                    farbnummerInput.readOnly = false;
                    console.log('‚úÖ Farbnummer: Editierbar (Normaler Workflow)');
                }
            }

            // Form Submit Event Listener registrieren
            console.log('üìù Registriere Form Submit Listener...');
            const formSubmitHandler = async function(e) {
                e.preventDefault();
                console.log('üöÄ === ANNAHME SUBMIT GESTARTET ===');

                // ============================================
                // INPUT VALIDATION (Phase 1 Quick Wins)
                // ============================================
                console.log('1Ô∏è‚É£ Validierung...');

                // Validate Kennzeichen (required)
                const kennzeichenResult = window.validateKennzeichen(document.getElementById('kennzeichen').value);
                if (!kennzeichenResult.valid) {
                    showToast(kennzeichenResult.error, 'error');
                    document.getElementById('kennzeichen').focus();
                    return;
                }

                // Validate Kundenname (required)
                if (!document.getElementById('kundenname').value || !document.getElementById('kundenname').value.trim()) {
                    showToast('Bitte Kundenname eingeben!', 'error');
                    document.getElementById('kundenname').focus();
                    return;
                }

                // Validate Marke & Modell (required)
                if (!document.getElementById('marke').value || !document.getElementById('modell').value) {
                    console.log('‚ùå Validierung fehlgeschlagen: Marke oder Modell fehlt');
                    showToast('Bitte Marke und Modell eingeben!', 'error');
                    return;
                }

                // Validate Farbnummer (NUR f√ºr Lackierung & Alle Services)
                const serviceTyp = document.getElementById('serviceTyp').value;
                if (serviceTyp === 'lackier' || serviceTyp === 'alle') {
                    const farbnummerResult = window.validateFarbnummer(document.getElementById('farbnummer').value);
                    if (!farbnummerResult.valid) {
                        showToast(farbnummerResult.error, 'error');
                        document.getElementById('farbnummer').focus();
                        return;
                    }

                    // Check if Farbnummer is provided
                    if (!document.getElementById('farbnummer').value || !document.getElementById('farbnummer').value.trim()) {
                        showToast('Bitte Farbnummer f√ºr Lackierung eingeben!', 'error');
                        document.getElementById('farbnummer').focus();
                        return;
                    }
                    console.log('‚úÖ Farbnummer validiert');
                } else {
                    console.log('‚è≠Ô∏è Farbnummer nicht ben√∂tigt f√ºr Service: ' + serviceTyp);
                }

                if (photos.length === 0) {
                    console.log('‚ùå Validierung fehlgeschlagen: Keine Fotos');
                    showToast('Bitte mindestens 1 Foto machen!', 'error');
                    return;
                }

                // Validate VIN/FIN (optional field)
                const vinValue = document.getElementById('vin').value;
                if (vinValue && vinValue.trim()) {
                    const vinResult = window.validateVIN(vinValue);
                    if (!vinResult.valid) {
                        showToast(vinResult.error, 'error');
                        document.getElementById('vin').focus();
                        return;
                    }
                }

                // Pr√ºfe ob Unterschrift vorhanden
                const signatureData = canvas.toDataURL();
                const emptyCanvas = document.createElement('canvas');
                emptyCanvas.width = canvas.width;
                emptyCanvas.height = canvas.height;
                if (signatureData === emptyCanvas.toDataURL()) {
                    console.log('‚ùå Validierung fehlgeschlagen: Keine Unterschrift');
                    showToast('Bitte Unterschrift des Kunden einholen!', 'error');
                    return;
                }

                console.log('‚úÖ Validierung erfolgreich');
                console.log('2Ô∏è‚É£ Sammle Formulardaten...');
                const annahmeData = getFormData();
                console.log('   Fahrzeug ID:', annahmeData.id);
                console.log('   Kennzeichen:', annahmeData.kennzeichen);
                console.log('   Kunde:', annahmeData.kundenname);
                console.log('   Fotos:', annahmeData.photos.length);

                // Nachannahme-Modus? Dann Duplikat-Pr√ºfung √ºberspringen
                if (window.istNachannahme) {
                    console.log('üîÑ Nachannahme-Modus: √úberspringe Duplikat-Pr√ºfung');
                } else {
                    // Normale Duplikat-Pr√ºfung
                    console.log('3Ô∏è‚É£ Duplikat-Pr√ºfung...');
                    const kennzeichen = annahmeData.kennzeichen.toUpperCase().replace(/\s+/g, '');
                    let existingVehicles = [];

                    try {
                        if (firebaseInitialized && firebaseApp) {
                            console.log('   ‚Üí Pr√ºfe Duplikate in Firestore...');
                            existingVehicles = await firebaseApp.getAllFahrzeuge();
                            console.log('   ‚Üí Gefunden:', existingVehicles.length, 'Fahrzeuge');
                        } else {
                            console.log('   ‚Üí Pr√ºfe Duplikate in LocalStorage...');
                            existingVehicles = JSON.parse(localStorage.getItem('fahrzeuge') || '[]');
                            console.log('   ‚Üí Gefunden:', existingVehicles.length, 'Fahrzeuge');
                        }

                        const duplicate = existingVehicles.find(v => {
                            const existingKz = v.kennzeichen.toUpperCase().replace(/\s+/g, '');
                            return existingKz === kennzeichen && v.status !== 'abgeschlossen';
                        });

                        if (duplicate) {
                            console.log('‚ö†Ô∏è Duplikat gefunden:', duplicate.kennzeichen);

                            const kundenameNeu = annahmeData.kundenname.toUpperCase().trim();
                            const kundenameAlt = duplicate.kundenname.toUpperCase().trim();
                            const gleicherKunde = (kundenameNeu === kundenameAlt);

                            let message;
                            if (gleicherKunde) {
                                message = `‚ö†Ô∏è ACHTUNG: Kennzeichen "${annahmeData.kennzeichen}" ist bereits als "${duplicate.status}" vorhanden!\n\n` +
                                          `GLEICHER KUNDE: ${duplicate.kundenname}\n` +
                                          `Fahrzeug: ${duplicate.marke} ${duplicate.modell}\n` +
                                          `Annahme: ${duplicate.datum}\n\n` +
                                          `üí° M√∂glicherweise ist dieses Fahrzeug bereits in Bearbeitung!\n\n` +
                                          `Trotzdem als NEUEN Auftrag anlegen?`;
                            } else {
                                message = `‚ö†Ô∏è HINWEIS: Kennzeichen "${annahmeData.kennzeichen}" ist bereits vorhanden!\n\n` +
                                          `ABER ANDERER KUNDE:\n` +
                                          `Alter Auftrag: ${duplicate.kundenname} (${duplicate.marke} ${duplicate.modell})\n` +
                                          `Neuer Auftrag: ${annahmeData.kundenname}\n\n` +
                                          `üí° M√∂glicherweise Fahrzeugwechsel oder verschiedene Besitzer.\n\n` +
                                          `Als neuen Auftrag anlegen?`;
                            }

                            const proceed = confirm(message);

                            if (!proceed) {
                                console.log('‚ùå Annahme abgebrochen - Duplikat verhindert');
                                return;
                            }
                            console.log('‚úÖ User hat Duplikat best√§tigt - fahre fort');
                        } else {
                            console.log('‚úÖ Kein Duplikat gefunden');
                        }
                    } catch (error) {
                        console.error('‚ö†Ô∏è Duplikat-Pr√ºfung fehlgeschlagen:', error);
                        console.error('   Details:', error.message);
                    }
                }

                // Speicherung
                console.log('4Ô∏è‚É£ Speicherung starten...');
                try {
                    if (firebaseInitialized && firebaseApp) {
                        console.log('üíæ Hybrid-Speicherung: Daten ‚Üí Firestore, Fotos ‚Üí LocalStorage');

                        // Nachannahme-Modus: UPDATE statt CREATE
                        if (window.istNachannahme) {
                            console.log('üîÑ NACHANNAHME-MODUS: Aktualisiere bestehendes Fahrzeug');

                            console.log('   a) Speichere Nachannahme-Fotos in Firestore...');
                            try {
                                await firebaseApp.savePhotosToFirestore(window.nachannahmeFahrzeugId, annahmeData.photos, 'vorher');
                                console.log('   ‚úÖ Fotos in Firestore gespeichert');
                            } catch (e) {
                                console.error('   ‚ùå Foto-Speicherung in Firestore fehlgeschlagen:', e);
                                firebaseApp.savePhotosLocal(window.nachannahmeFahrzeugId, annahmeData.photos, 'vorher');
                            }

                            console.log('   b) UPDATE Fahrzeugdaten in Firestore...');
                            const updateData = {
                                photos: annahmeData.photos,
                                signature: annahmeData.signature,
                                notizen: annahmeData.notizen || window.nachannahmeData.schadenBeschreibung,
                                kmstand: annahmeData.kmstand,
                                vin: annahmeData.vin,
                                farbname: annahmeData.farbname,
                                lackart: annahmeData.lackart,
                                datum: annahmeData.datum,
                                zeit: annahmeData.zeit,
                                physischeAnnahmeErfolgt: true,
                                physischeAnnahmeDatum: new Date().toISOString(),
                                serviceDetails: annahmeData.serviceDetails,
                                lastModified: Date.now()
                            };

                            await firebaseApp.updateFahrzeug(window.nachannahmeFahrzeugId, updateData);
                            console.log('   ‚úÖ Fahrzeug aktualisiert');

                            sessionStorage.removeItem('partnerFahrzeugNachannahme');
                            clearDraft();

                            showToast('Physische Annahme erfolgreich! Das Fahrzeug wurde mit Fotos und Unterschrift erg√§nzt.', 'success', 4000);
                            setTimeout(() => safeNavigate('liste.html'), 1500);
                            return;
                        }

                        // NORMALE ANNAHME
                        console.log('   a) Registriere Kundenbesuch...');
                        // BUGFIX 2025-11-04: Pass complete customer data object
                        const kundeId = await firebaseApp.registriereKundenbesuch({
                            name: annahmeData.kundenname,
                            email: annahmeData.kundenEmail || '',
                            telefon: annahmeData.telefon || '',
                            notizen: annahmeData.notizen || ''
                        });
                        if (kundeId) {
                            annahmeData.kundenId = kundeId;
                            console.log('   ‚úÖ Kunde registriert, ID:', kundeId);
                        } else {
                            console.log('   ‚ö†Ô∏è Keine KundenID erhalten');
                        }

                        console.log('   b) Speichere Fotos in Firestore...');
                        try {
                            await firebaseApp.savePhotosToFirestore(annahmeData.id, annahmeData.photos, 'vorher');
                            console.log('   ‚úÖ Fotos in Firestore gespeichert');
                        } catch (e) {
                            console.error('   ‚ùå Fehler beim Speichern der Fotos in Firestore:', e);
                            console.warn('   ‚Üí Fallback: Speichere Fotos in LocalStorage');
                            firebaseApp.savePhotosLocal(annahmeData.id, annahmeData.photos, 'vorher');
                        }

                        console.log('   c) Speichere Fahrzeugdaten in Firestore...');
                        const dataForFirestore = {...annahmeData};

                        // BUGFIX 2025-11-04: Speichere partnerEmail f√ºr Firestore Security Rules
                        // Erm√∂glicht Partner-Zugriff auf ihre eigenen Fahrzeuge
                        if (annahmeData.kundenEmail && annahmeData.kundenEmail.includes('@')) {
                            dataForFirestore.partnerEmail = annahmeData.kundenEmail;
                            console.log('   üîë partnerEmail gesetzt:', dataForFirestore.partnerEmail);
                        }

                        delete dataForFirestore.photos;

                        await firebaseApp.saveFahrzeug(dataForFirestore);
                        console.log('   ‚úÖ Fahrzeug in Firestore gespeichert');

                        console.log('   d) Registriere Kunde und setze kundenId...');
                        try {
                            // BUGFIX 2025-11-04: Pass complete customer data object
                            const kundenId = await firebaseApp.registriereKundenbesuch({
                                name: annahmeData.kundenname,
                                email: annahmeData.kundenEmail || '',
                                telefon: annahmeData.telefon || '',
                                notizen: annahmeData.notizen || ''
                            });
                            if (kundenId) {
                                await firebaseApp.updateFahrzeug(annahmeData.id, {
                                    kundenId: kundenId
                                });
                                console.log('   ‚úÖ Kunde registriert, kundenId:', kundenId);
                            } else {
                                console.warn('   ‚ö†Ô∏è Keine kundenId erhalten');
                            }
                        } catch (error) {
                            console.error('   ‚ùå Fehler bei Kundenregistrierung:', error);
                        }

                        // ============================================
                        // QR-CODE FEATURE: Partner Account & Auto-Login Token
                        // ============================================
                        console.log('   e) QR-Code Feature: Partner Account & Token...');

                        // Check ob Kunden-Email vorhanden ist
                        if (annahmeData.kundenEmail && annahmeData.kundenEmail.includes('@')) {
                            console.log('   ‚Üí Kunde hat Email:', annahmeData.kundenEmail);

                            try {
                                // STEP 1: Partner Account erstellen/pr√ºfen
                                console.log('   ‚Üí Calling ensurePartnerAccount...');
                                const ensurePartnerFn = window.functions.httpsCallable('ensurePartnerAccount');
                                const partnerResult = await ensurePartnerFn({
                                    email: annahmeData.kundenEmail,
                                    kundenname: annahmeData.kundenname,
                                    werkstattId: window.werkstattId || 'mosbach'
                                });

                                console.log('   ‚úÖ Partner Account:', partnerResult.data.message);
                                console.log('   ‚Üí Partner ID:', partnerResult.data.partnerId);
                                console.log('   ‚Üí Neuer Partner:', partnerResult.data.isNewPartner);

                                // STEP 2: Auto-Login Token erstellen
                                console.log('   ‚Üí Calling createPartnerAutoLoginToken...');
                                const createTokenFn = window.functions.httpsCallable('createPartnerAutoLoginToken');
                                const tokenResult = await createTokenFn({
                                    partnerId: partnerResult.data.partnerId,
                                    werkstattId: window.werkstattId || 'mosbach',
                                    fahrzeugId: annahmeData.id,
                                    expiresInDays: 30
                                });

                                console.log('   ‚úÖ Token erstellt');
                                console.log('   ‚Üí Login URL:', tokenResult.data.loginUrl);
                                console.log('   ‚Üí G√ºltig bis:', tokenResult.data.expiresAt);

                                // STEP 3: Daten f√ºr PDF speichern
                                annahmeData.qrCodeUrl = tokenResult.data.loginUrl;
                                annahmeData.qrCodeExpiresAt = tokenResult.data.expiresAt;
                                annahmeData.isNewPartner = partnerResult.data.isNewPartner;
                                annahmeData.partnerPassword = partnerResult.data.generatedPassword || null; // nur bei neuen Partnern

                                // STEP 2.5: Create partnerAnfrage for customer portal
                                console.log('   üîß [STEP 2.5] Creating partnerAnfrage for customer portal...');
                                try {
                                    const anfrageId = 'req_' + Date.now();

                                    // üÜï BUGFIX 2025-11-04: Werkstatt-initiiert workflow
                                    // If price is agreed on-site (vereinbarterPreis > 0), directly mark as "beauftragt"
                                    // Otherwise, normal flow: "neu" ‚Üí customer confirms ‚Üí "beauftragt"
                                    const hasAgreedPrice = annahmeData.vereinbarterPreis && parseFloat(annahmeData.vereinbarterPreis) > 0;
                                    const isWerkstattInitiiert = hasAgreedPrice;

                                    const anfrageData = {
                                        id: anfrageId,
                                        partnerId: partnerResult.data.partnerId,
                                        partnerName: annahmeData.kundenname,
                                        serviceTyp: annahmeData.serviceTyp || 'lackier',
                                        timestamp: new Date().toISOString(),
                                        erstelltAm: new Date().toISOString(),

                                        // Vehicle reference
                                        referenzType: 'kennzeichen',
                                        kennzeichen: annahmeData.kennzeichen,
                                        auftragsnummer: null,

                                        // Vehicle data from intake form
                                        marke: annahmeData.marke || null,
                                        modell: annahmeData.modell || null,
                                        baujahr: annahmeData.baujahrVon ? parseInt(annahmeData.baujahrVon) : null,
                                        kilometerstand: annahmeData.kmstand ? parseInt(annahmeData.kmstand) : null,
                                        vin: annahmeData.vin || null,

                                        // üÜï BUGFIX 2025-11-04: Add missing paint fields (CRITICAL for paint shop!)
                                        farbname: annahmeData.farbname || null,           // Paint name (e.g., "Silber Metallic")
                                        farbnummer: annahmeData.farbnummer || null,       // Paint code (e.g., "LC9Z") - CRITICAL!
                                        lackart: annahmeData.lackart || null,             // Paint type (Uni/Metallic/Perleffekt)
                                        farbvariante: annahmeData.farbvariante || null,   // Paint variant details

                                        // Service description
                                        schadenBeschreibung: annahmeData.notizen || 'Fahrzeug zur Begutachtung eingereicht',
                                        serviceData: annahmeData.serviceDetails || {},

                                        // üÜï BUGFIX 2025-11-04: Add missing customer & delivery fields
                                        kundenEmail: annahmeData.kundenEmail || null,
                                        kundenTelefon: annahmeData.telefon || null,
                                        geplantesAbnahmeDatum: annahmeData.geplantesAbnahmeDatum || null,

                                        // Delivery options
                                        lieferoption: annahmeData.fahrzeugAbholung === 'ja' ? 'abholung' : 'selbst',
                                        abholserviceGewuenscht: annahmeData.fahrzeugAbholung === 'ja',
                                        abholtermin: annahmeData.abholdatum || null,
                                        abholadresse: annahmeData.abholadresse || null,
                                        abholzeit: annahmeData.abholzeit || null,
                                        abholnotiz: annahmeData.abholnotiz || null,
                                        ersatzfahrzeugGewuenscht: false,

                                        fotos: annahmeData.photos || [],

                                        // üÜï BUGFIX 2025-11-04: Werkstatt-initiiert workflow
                                        // If price agreed on-site, directly mark as "beauftragt" (no customer confirmation needed)
                                        status: isWerkstattInitiiert ? 'beauftragt' : 'neu',
                                        statusText: isWerkstattInitiiert ? 'Beauftragt (Werkstatt-initiiert)' : 'Neu eingegangen',
                                        werkstattInitiiert: isWerkstattInitiiert,
                                        vereinbarterPreis: hasAgreedPrice ? parseFloat(annahmeData.vereinbarterPreis) : null,

                                        kva: null,
                                        fahrzeugId: annahmeData.id // Link back to vehicle intake
                                    };

                                    // Save to Firestore
                                    await window.getCollection('partnerAnfragen').doc(anfrageId).set(anfrageData);
                                    console.log('   ‚úÖ [STEP 2.5] partnerAnfrage created:', anfrageId);
                                    console.log('   üìä Data:', {
                                        partnerId: anfrageData.partnerId,
                                        status: anfrageData.status,
                                        werkstattInitiiert: anfrageData.werkstattInitiiert,
                                        vereinbarterPreis: anfrageData.vereinbarterPreis,
                                        kennzeichen: anfrageData.kennzeichen,
                                        farbnummer: anfrageData.farbnummer
                                    });

                                } catch (error) {
                                    console.error('   ‚ùå [STEP 2.5] Failed to create partnerAnfrage:', error);
                                    // Continue anyway - not critical for vehicle intake
                                    // User can still login and create manual requests
                                }

                                console.log('   ‚úÖ QR-Code Daten bereit f√ºr PDF');

                                if (annahmeData.isNewPartner) {
                                    console.log('   üÜï NEU-KUNDE ‚Üí Passwort wird im PDF angezeigt');
                                } else {
                                    console.log('   ‚úÖ BESTANDSKUNDE ‚Üí Kein Passwort im PDF');
                                }

                            } catch (error) {
                                console.error('   ‚ùå QR-Code Feature fehlgeschlagen:', error);
                                console.error('   Details:', error.message);
                                // Continue ohne QR-Code - PDF wird trotzdem erstellt
                                annahmeData.qrCodeUrl = null;
                                annahmeData.partnerPassword = null;
                            }
                        } else {
                            console.log('   ‚è≠Ô∏è Keine Kunden-Email ‚Üí QR-Code √ºbersprungen');
                            annahmeData.qrCodeUrl = null;
                            annahmeData.partnerPassword = null;
                        }

                        console.log('   f) Erstelle PDF...');
                        await createPDF(annahmeData);
                        console.log('   ‚úÖ PDF erstellt');
                    } else {
                        console.log('üíæ LocalStorage-Modus (Firebase nicht verf√ºgbar oder offline)');
                        console.log('   navigator.onLine:', navigator.onLine);
                        console.log('   firebaseInitialized:', firebaseInitialized);

                        let fahrzeuge = JSON.parse(localStorage.getItem('fahrzeuge') || '[]');
                        fahrzeuge.push(annahmeData);

                        try {
                            localStorage.setItem('fahrzeuge', JSON.stringify(fahrzeuge));
                            console.log('‚úÖ Fahrzeug in LocalStorage gespeichert');

                            if (navigator.onLine && !firebaseInitialized) {
                                console.warn('‚ö†Ô∏è Blaze Plan aktiv aber Firebase nicht initialisiert - bitte pr√ºfen!');
                            }
                        } catch (e) {
                            console.error('‚ùå Fehler beim Speichern:', e);
                            if (e.name === 'QuotaExceededError' || e.message.includes('quota')) {
                                showToast('SPEICHER VOLL! Bitte pr√ºfen Sie Ihre Internet-Verbindung. Falls Sie online sind, kontaktieren Sie den Support.', 'error', 6000);
                                return;
                            }
                            throw e;
                        }

                        console.log('   ‚Üí Erstelle PDF...');
                        await createPDF(annahmeData);
                        console.log('   ‚úÖ PDF erstellt');
                    }

                    console.log('‚úÖ === SPEICHERUNG ERFOLGREICH ===');
                } catch (error) {
                    console.error('‚ùå Fehler beim Speichern:', error);
                    console.error('   Error Name:', error.name);
                    console.error('   Error Message:', error.message);
                    console.error('   Stack:', error.stack);

                    console.log('   ‚Üí Versuche LocalStorage Fallback...');
                    try {
                        let fahrzeuge = JSON.parse(localStorage.getItem('fahrzeuge') || '[]');
                        fahrzeuge.push(annahmeData);
                        localStorage.setItem('fahrzeuge', JSON.stringify(fahrzeuge));
                        console.log('‚ö†Ô∏è Fahrzeug in LocalStorage gespeichert (Firestore-Fehler)');

                        await createPDF(annahmeData);
                        console.log('‚úÖ PDF erstellt (Fallback)');
                    } catch (fallbackError) {
                        console.error('‚ùå Auch Fallback fehlgeschlagen:', fallbackError);
                        showToast('Speichern fehlgeschlagen! Siehe Console f√ºr Details.', 'error');
                        return;
                    }
                }

                // Aufr√§umen
                console.log('5Ô∏è‚É£ Aufr√§umen...');
                clearDraft();
                console.log('   ‚úÖ Entwurf gel√∂scht');

                // Success Message
                document.getElementById('successMessage').style.display = 'block';
                console.log('   ‚úÖ Success-Message angezeigt');

                // Auto-Redirect zur √úbersicht nach 2 Sekunden
                setTimeout(() => {
                    console.log('   ‚Üí Weiterleitung zur √úbersicht...');
                    setTimeout(() => safeNavigate('liste.html'), 1500);
                }, 2000);

                // Form zur√ºcksetzen
                document.getElementById('annahmeForm').reset();
                photos = [];
                updatePhotoGrid();
                clearSignature();
                console.log('   ‚úÖ Formular zur√ºckgesetzt');

                console.log('üéâ === ANNAHME ABGESCHLOSSEN ===');
            };
            window.listenerRegistry.registerDOM(document.getElementById('annahmeForm'), 'submit', formSubmitHandler, 'Annahme Form Submit');
            console.log('‚úÖ Form Submit Listener registriert');
        });

        // Kunden laden
        async function loadKunden() {
            try {
                if (firebaseInitialized && firebaseApp) {
                    allKunden = await firebaseApp.getAllKunden();
                } else {
                    allKunden = JSON.parse(localStorage.getItem('kunden') || '[]');
                }

                console.log(`‚úÖ ${allKunden.length} Kunden geladen`);
                updateKundenDropdown();
            } catch (error) {
                console.error('‚ùå Fehler beim Laden der Kunden:', error);
                allKunden = [];
            }
        }

        // Kunden-Dropdown aktualisieren
        function updateKundenDropdown() {
            const dropdown = document.getElementById('kundenDropdown');
            dropdown.innerHTML = '<option value="">üÜï Neuer Kunde</option>';

            if (allKunden.length > 0) {
                const sortedKunden = [...allKunden].sort((a, b) => {
                    const dateA = a.letzterBesuch ? new Date(a.letzterBesuch) : new Date(0);
                    const dateB = b.letzterBesuch ? new Date(b.letzterBesuch) : new Date(0);
                    return dateB - dateA;
                });

                sortedKunden.forEach(kunde => {
                    const option = document.createElement('option');
                    option.value = kunde.id;
                    const besuche = kunde.anzahlBesuche || 0;
                    const icon = besuche >= 2 ? '‚≠ê' : 'üë§';
                    option.textContent = `${icon} ${kunde.name} (${besuche} Besuch${besuche !== 1 ? 'e' : ''})`;
                    dropdown.appendChild(option);
                });
            }
        }

        // Kunde aus Dropdown ausw√§hlen
        function selectKunde() {
            const dropdown = document.getElementById('kundenDropdown');
            const kundeId = dropdown.value;

            if (!kundeId) {
                // Neuer Kunde - alle Felder leeren und editierbar machen
                document.getElementById('kundenname').value = '';
                document.getElementById('kundenname').readOnly = false;
                document.getElementById('kundenEmail').value = '';
                document.getElementById('kundenEmail').readOnly = false;
                document.getElementById('telefon').value = '';
                document.getElementById('telefon').readOnly = false;
                return;
            }

            const kunde = allKunden.find(k => window.compareIds(k.id, kundeId));
            if (kunde) {
                // Name ausf√ºllen
                document.getElementById('kundenname').value = kunde.name;
                document.getElementById('kundenname').readOnly = true;

                // üÜï BUGFIX 2025-11-04: Email automatisch ausf√ºllen
                if (kunde.email) {
                    document.getElementById('kundenEmail').value = kunde.email;
                    document.getElementById('kundenEmail').readOnly = true;
                } else {
                    document.getElementById('kundenEmail').value = '';
                    document.getElementById('kundenEmail').readOnly = false;
                }

                // üÜï BUGFIX 2025-11-04: Telefon automatisch ausf√ºllen
                if (kunde.telefon) {
                    document.getElementById('telefon').value = kunde.telefon;
                    document.getElementById('telefon').readOnly = true;
                } else {
                    document.getElementById('telefon').value = '';
                    document.getElementById('telefon').readOnly = false;
                }

                console.log(`‚úÖ Stammkunde ausgew√§hlt: ${kunde.name} (${kunde.anzahlBesuche || 0} Besuche)`);
                if (kunde.email) console.log(`   üìß Email: ${kunde.email}`);
                if (kunde.telefon) console.log(`   üìû Telefon: ${kunde.telefon}`);
            }
        }

        // Toggle Abholungs-Details
        function toggleAbholungDetails() {
            const fahrzeugAbholung = document.querySelector('input[name="fahrzeugAbholung"]:checked').value;
            const abholungDetails = document.getElementById('abholungDetails');

            if (fahrzeugAbholung === 'ja') {
                abholungDetails.style.display = 'block';
                document.getElementById('abholadresse').required = true;
            } else {
                abholungDetails.style.display = 'none';
                document.getElementById('abholadresse').value = '';
                document.getElementById('abholdatum').value = '';
                document.getElementById('abholzeit').value = '';
                document.getElementById('abholnotiz').value = '';
                document.getElementById('abholadresse').required = false;
            }
        }

        // Radio-Button visuelle R√ºckmeldung
        function initRadioVisuals() {
            document.querySelectorAll('.radio-group input[type="radio"]').forEach(radio => {
                if (radio.checked) {
                    radio.parentElement.classList.add('selected');
                }

                const radioChangeHandler = function() {
                    const groupName = this.name;
                    document.querySelectorAll(`input[name="${groupName}"]`).forEach(r => {
                        r.parentElement.classList.remove('selected');
                    });

                    if (this.checked) {
                        this.parentElement.classList.add('selected');
                    }
                };
                window.listenerRegistry.registerDOM(radio, 'change', radioChangeHandler, `Radio Button ${radio.name}`);
            });
        }

        // Aktuelles Datum
        const heute = new Date();
        document.getElementById('currentDate').textContent = heute.toLocaleDateString('de-DE', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });

        // Foto-Upload
        const photoInput = document.getElementById('photoInput');
        const photoGrid = document.getElementById('photoGrid');
        let photos = [];

        async function compressImage(base64Image, profileName = 'schadenFoto') {
            const result = await ImageOptimizer.compressImage(
                base64Image,
                profileName,
                (progress, message) => {
                    if (progress === 100) {
                        console.log(`‚úÖ ${message}`);
                    }
                }
            );

            console.log(`üìä Komprimierung: ${result.savings}% gespart (${(result.originalSize/1024).toFixed(0)}KB ‚Üí ${(result.compressedSize/1024).toFixed(0)}KB)`);

            return result.compressed;
        }

        const photoInputHandler = function(e) {
            const files = Array.from(e.target.files);

            for (const file of files) {
                if (file.size > 5 * 1024 * 1024) {
                    showToast(`Foto "${file.name}" ist zu gro√ü (${(file.size / 1024 / 1024).toFixed(1)} MB)! Bitte kleineres Foto verwenden (max. 5 MB).`, 'warning', 5000);
                    e.target.value = '';
                    return;
                }
            }

            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = async function(event) {
                    const compressed = await compressImage(event.target.result);
                    photos.push(compressed);
                    updatePhotoGrid();
                };
                reader.readAsDataURL(file);
            });
            e.target.value = '';
        };
        window.listenerRegistry.registerDOM(photoInput, 'change', photoInputHandler, 'Photo Input Change');

        function updatePhotoGrid() {
            photoGrid.innerHTML = '';
            photos.forEach((photo, index) => {
                const div = document.createElement('div');
                div.className = 'photo-item';
                div.innerHTML = `
                    <img src="${photo}" alt="Foto ${index + 1}">
                    <button class="remove-photo" onclick="removePhoto(${index})">√ó</button>
                `;
                photoGrid.appendChild(div);
            });

            if (photos.length < 10) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'photo-item empty';
                emptyDiv.onclick = () => photoInput.click();
                emptyDiv.innerHTML = `
                    <i data-feather="camera"></i>
                    <span>Foto hinzuf√ºgen</span>
                `;
                photoGrid.appendChild(emptyDiv);
            }

            feather.replace();
        }

        function removePhoto(index) {
            photos.splice(index, 1);
            updatePhotoGrid();
        }

        // Unterschrift Canvas
        const canvas = document.getElementById('signatureCanvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let hasDrawn = false;

        // Get stroke color based on current theme
        function getCanvasStrokeColor() {
            const textColor = getComputedStyle(document.documentElement)
                .getPropertyValue('--color-text-primary').trim();
            return textColor || '#000000'; // Fallback to black
        }

        function initCanvas() {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * 2;
            canvas.height = rect.height * 2;
            ctx.scale(2, 2);

            ctx.strokeStyle = getCanvasStrokeColor();
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            if (!hasDrawn) {
                drawPlaceholder();
            }
        }

        function drawPlaceholder() {
            ctx.save();
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.fillStyle = getCanvasStrokeColor();
            ctx.globalAlpha = 0.3; // Semi-transparent
            ctx.font = '20px Inter';
            ctx.textAlign = 'center';
            ctx.fillText('‚úçÔ∏è Hier unterschreiben', canvas.width / 2, canvas.height / 2);
            ctx.restore();
        }

        initCanvas();
        window.listenerRegistry.registerDOM(window, 'resize', initCanvas, 'Signature Canvas Resize');

        function getCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            if (e.touches && e.touches.length > 0) {
                return {
                    x: (e.touches[0].clientX - rect.left) * scaleX / 2,
                    y: (e.touches[0].clientY - rect.top) * scaleY / 2
                };
            } else {
                return {
                    x: (e.clientX - rect.left) * scaleX / 2,
                    y: (e.clientY - rect.top) * scaleY / 2
                };
            }
        }

        function startDrawing(e) {
            e.preventDefault();
            isDrawing = true;

            if (!hasDrawn) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                hasDrawn = true;
            }

            const coords = getCoordinates(e);
            ctx.beginPath();
            ctx.moveTo(coords.x, coords.y);
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();

            const coords = getCoordinates(e);
            ctx.lineTo(coords.x, coords.y);
            ctx.stroke();
        }

        function stopDrawing(e) {
            if (!isDrawing) return;
            e.preventDefault();
            isDrawing = false;
            ctx.closePath();
        }

        window.listenerRegistry.registerDOM(canvas, 'mousedown', startDrawing, 'Signature Canvas Mouse Down');
        window.listenerRegistry.registerDOM(canvas, 'mousemove', draw, 'Signature Canvas Mouse Move');
        window.listenerRegistry.registerDOM(canvas, 'mouseup', stopDrawing, 'Signature Canvas Mouse Up');
        window.listenerRegistry.registerDOM(canvas, 'mouseleave', stopDrawing, 'Signature Canvas Mouse Leave');

        window.listenerRegistry.registerDOM(canvas, 'touchstart', startDrawing, 'Signature Canvas Touch Start');
        window.listenerRegistry.registerDOM(canvas, 'touchmove', draw, 'Signature Canvas Touch Move');
        window.listenerRegistry.registerDOM(canvas, 'touchend', stopDrawing, 'Signature Canvas Touch End');
        window.listenerRegistry.registerDOM(canvas, 'touchcancel', stopDrawing, 'Signature Canvas Touch Cancel');

        function clearSignature() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            hasDrawn = false;
            drawPlaceholder();
        }

        // Listen to theme changes and update canvas colors
        window.addEventListener('themeChanged', () => {
            initCanvas();
            console.log('‚úÖ Canvas colors updated for theme:', document.documentElement.getAttribute('data-theme'));
        });

        // Formular-Daten sammeln
        // ‚ú® SERVICE-DETAILS SAMMELN
        function getServiceDetails(serviceTyp) {
            const details = {};

            switch(serviceTyp) {
                case 'reifen':
                    const reifengroesse = document.getElementById('reifengroesse')?.value;
                    const reifentyp = document.getElementById('reifentyp')?.value;
                    const reifenanzahl = document.getElementById('reifenanzahl')?.value;
                    if (reifengroesse || reifentyp || reifenanzahl) {
                        details.reifengroesse = reifengroesse;
                        details.reifentyp = reifentyp;
                        details.reifenanzahl = reifenanzahl;
                    }
                    break;

                case 'glas':
                    const scheibentyp = document.getElementById('scheibentyp')?.value;
                    const schadensgroesse = document.getElementById('schadensgroesse')?.value;
                    const glasposition = document.getElementById('glasposition')?.value;
                    if (scheibentyp || schadensgroesse || glasposition) {
                        details.scheibentyp = scheibentyp;
                        details.schadensgroesse = schadensgroesse;
                        details.glasposition = glasposition;
                    }
                    break;

                case 'klima':
                    const klimaservice = document.getElementById('klimaservice')?.value;
                    const kaeltemittel = document.getElementById('kaeltemittel')?.value;
                    const klimaproblem = document.getElementById('klimaproblem')?.value;
                    if (klimaservice || kaeltemittel || klimaproblem) {
                        details.klimaservice = klimaservice;
                        details.kaeltemittel = kaeltemittel;
                        details.klimaproblem = klimaproblem;
                    }
                    break;

                case 'dellen':
                    const dellenanzahl = document.getElementById('dellenanzahl')?.value;
                    const dellengroesse = document.getElementById('dellengroesse')?.value;
                    const lackschaden = document.getElementById('lackschaden')?.value;
                    const dellenpositionen = document.getElementById('dellenpositionen')?.value;
                    if (dellenanzahl || dellengroesse || lackschaden || dellenpositionen) {
                        details.dellenanzahl = dellenanzahl;
                        details.dellengroesse = dellengroesse;
                        details.lackschaden = lackschaden;
                        details.dellenpositionen = dellenpositionen;
                    }
                    break;

                case 'mechanik':
                    const mechanikProblem = document.getElementById('mechanik-problem')?.value;
                    const mechanikSymptome = document.getElementById('mechanik-symptome')?.value;
                    if (mechanikProblem || mechanikSymptome) {
                        details.problem = mechanikProblem;
                        details.symptome = mechanikSymptome;
                    }
                    break;

                case 'versicherung':
                    const schadensnummer = document.getElementById('versicherung-schadensnummer')?.value;
                    const versicherungName = document.getElementById('versicherung-name')?.value;
                    const schadendatum = document.getElementById('versicherung-schadendatum')?.value;
                    const unfallhergang = document.getElementById('versicherung-hergang')?.value;
                    if (schadensnummer || versicherungName || schadendatum || unfallhergang) {
                        details.schadensnummer = schadensnummer;
                        details.versicherung = versicherungName;
                        details.schadendatum = schadendatum;
                        details.unfallhergang = unfallhergang;
                    }
                    break;

                case 'pflege':
                    const pflegePaket = document.getElementById('pflege-paket')?.value;
                    const pflegeZusatz = document.getElementById('pflege-zusatz')?.value;
                    if (pflegePaket || pflegeZusatz) {
                        details.paket = pflegePaket;
                        details.zusatzleistungen = pflegeZusatz;
                    }
                    break;

                case 'tuev':
                    const tuevPruefart = document.getElementById('tuev-pruefart')?.value;
                    const tuevFaelligkeit = document.getElementById('tuev-faelligkeit')?.value;
                    const tuevMaengel = document.getElementById('tuev-maengel')?.value;
                    if (tuevPruefart || tuevFaelligkeit || tuevMaengel) {
                        details.pruefart = tuevPruefart;
                        details.faelligkeit = tuevFaelligkeit;
                        details.bekannteMaengel = tuevMaengel;
                    }
                    break;

                case 'folierung':
                    const folierungArt = document.getElementById('folierungArt')?.value;
                    const folierungMaterial = document.getElementById('folierungMaterial')?.value;
                    const folierungSpezialTyp = document.getElementById('folierungSpezialTyp')?.value;
                    const folierungFarbe = document.getElementById('folierungFarbe')?.value;
                    const folierungBereiche = Array.from(document.querySelectorAll('input[name="folierungBereiche"]:checked')).map(cb => cb.value);
                    const folierungDesign = document.getElementById('folierungDesign')?.value;
                    const folierungInfo = document.getElementById('folierungInfo')?.value;
                    if (folierungArt || folierungMaterial || folierungFarbe || folierungDesign || folierungInfo) {
                        details.folierungArt = folierungArt;
                        details.folierungMaterial = folierungMaterial;
                        if (folierungSpezialTyp) details.folierungSpezialTyp = folierungSpezialTyp;
                        details.folierungFarbe = folierungFarbe;
                        if (folierungBereiche.length > 0) details.folierungBereiche = folierungBereiche;
                        details.folierungDesign = folierungDesign;
                        details.folierungInfo = folierungInfo;
                    }
                    break;

                case 'steinschutz':
                    const steinschutzUmfang = document.getElementById('steinschutzUmfang')?.value;
                    const steinschutzMaterial = document.getElementById('steinschutzMaterial')?.value;
                    const steinschutzBereiche = document.getElementById('steinschutzBereiche')?.value;
                    const steinschutzInfo = document.getElementById('steinschutzInfo')?.value;
                    if (steinschutzUmfang || steinschutzMaterial || steinschutzBereiche || steinschutzInfo) {
                        details.steinschutzUmfang = steinschutzUmfang;
                        details.steinschutzMaterial = steinschutzMaterial;
                        details.steinschutzBereiche = steinschutzBereiche;
                        details.steinschutzInfo = steinschutzInfo;
                    }
                    break;

                case 'werbebeklebung':
                    const werbebeklebungUmfang = document.getElementById('werbebeklebungUmfang')?.value;
                    const werbebeklebungKomplexitaet = document.getElementById('werbebeklebungKomplexitaet')?.value;
                    const werbebeklebungText = document.getElementById('werbebeklebungText')?.value;
                    const werbebeklebungFarbanzahl = document.getElementById('werbebeklebungFarbanzahl')?.value;
                    const werbebeklebungInfo = document.getElementById('werbebeklebungInfo')?.value;
                    if (werbebeklebungUmfang || werbebeklebungKomplexitaet || werbebeklebungText || werbebeklebungFarbanzahl || werbebeklebungInfo) {
                        details.werbebeklebungUmfang = werbebeklebungUmfang;
                        details.werbebeklebungKomplexitaet = werbebeklebungKomplexitaet;
                        details.werbebeklebungText = werbebeklebungText;
                        details.werbebeklebungFarbanzahl = werbebeklebungFarbanzahl;
                        details.werbebeklebungInfo = werbebeklebungInfo;
                    }
                    break;

                // Andere Services haben keine spezifischen Felder (nur Lackierung)
                default:
                    break;
            }

            return Object.keys(details).length > 0 ? details : null;
        }

        function getFormData() {
            const timestamp = Date.now();
            return {
                id: timestamp,
                datum: heute.toLocaleDateString('de-DE'),
                zeit: heute.toLocaleTimeString('de-DE'),
                kennzeichen: document.getElementById('kennzeichen').value.trim().toUpperCase(),
                kundenname: document.getElementById('kundenname').value,
                kundenEmail: document.getElementById('kundenEmail').value,
                telefon: document.getElementById('telefon').value,
                geplantesAbnahmeDatum: document.getElementById('geplantesAbnahmeDatum').value,
                serviceTyp: document.getElementById('serviceTyp').value,
                serviceDetails: getServiceDetails(document.getElementById('serviceTyp').value),
                fahrzeugAbholung: document.querySelector('input[name="fahrzeugAbholung"]:checked').value,
                abholadresse: document.getElementById('abholadresse').value,
                abholdatum: document.getElementById('abholdatum').value,
                abholzeit: document.getElementById('abholzeit').value,
                abholnotiz: document.getElementById('abholnotiz').value,
                marke: document.getElementById('marke').value,
                modell: document.getElementById('modell').value,
                baujahrVon: document.getElementById('baujahrVon').value,
                baujahrBis: document.getElementById('baujahrBis').value,
                kmstand: document.getElementById('kmstand').value,
                vin: document.getElementById('vin').value,
                farbname: document.getElementById('farbname').value,
                farbvariante: document.getElementById('farbvariante').value,
                farbnummer: document.getElementById('farbnummer').value,
                lackart: document.querySelector('input[name="lackart"]:checked').value,
                notizen: document.getElementById('notizen').value,
                vereinbarterPreis: parseFloat(document.getElementById('vereinbarterPreis').value) || null,
                photos,
                signature: canvas.toDataURL(),
                status: 'angenommen',
                prozessStatus: 'angenommen',
                prozessTimestamps: {
                    angenommen: timestamp
                },
                lastModified: timestamp,
                bezahlt: false,
                rechnungGeschrieben: false
            };
        }

        // PDF erstellen (keeping original function)
        async function createPDF(data) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header
            doc.setFillColor(0, 51, 102);
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.text('Fahrzeug-Annahmeprotokoll', 105, 20, { align: 'center' });
            doc.setFontSize(12);
            doc.text('Auto-Lackierzentrum Mosbach', 105, 30, { align: 'center' });

            // Daten
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(11);
            let y = 50;

            doc.setFont(undefined, 'bold');
            doc.text('Datum:', 20, y);
            doc.setFont(undefined, 'normal');
            doc.text(data.datum + ' ' + data.zeit, 50, y);

            y += 7;
            doc.setFont(undefined, 'bold');
            doc.text('Kennzeichen:', 20, y);
            doc.setFont(undefined, 'normal');
            doc.text(data.kennzeichen, 50, y);

            y += 7;
            doc.setFont(undefined, 'bold');
            doc.text('Kundenname:', 20, y);
            doc.setFont(undefined, 'normal');
            doc.text(data.kundenname, 50, y);

            // Email (immer anzeigen)
            y += 7;
            doc.setFont(undefined, 'bold');
            doc.text('Email:', 20, y);
            doc.setFont(undefined, 'normal');
            doc.text(data.kundenEmail || 'Nicht angegeben', 50, y);

            // SERVICE-TYP (farbig & prominent)
            y += 12;
            const serviceIcons = {
                'lackierung': '[LACK]',
                'lackier': '[LACK]',
                'reifen': '[REIF]',
                'glas': '[GLAS]',
                'klima': '[KLIM]',
                'dellen': '[DELL]',
                'mechanik': '[MECH]',
                'versicherung': '[VERS]',
                'pflege': '[PFLG]',
                'tuev': '[TUEV]',
                'folierung': '[FOLI]',
                'steinschutz': '[STEIN]',
                'werbebeklebung': '[WERB]',
                'alle': '[ALL]'
            };
            const serviceColors = {
                'lackierung': [220, 53, 69],
                'lackier': [220, 53, 69],
                'reifen': [255, 152, 0],
                'glas': [3, 169, 244],
                'klima': [0, 188, 212],
                'dellen': [156, 39, 176],
                'mechanik': [96, 125, 139],
                'versicherung': [76, 175, 80],
                'pflege': [233, 30, 99],
                'tuev': [76, 175, 80],
                'folierung': [156, 39, 176],
                'steinschutz': [96, 125, 139],
                'werbebeklebung': [255, 87, 34],
                'alle': [63, 81, 181]
            };
            const serviceLabels = {
                'lackierung': 'LACKIERUNG',
                'lackier': 'LACKIERUNG',
                'reifen': 'REIFEN-SERVICE',
                'glas': 'GLAS-REPARATUR',
                'klima': 'KLIMA-SERVICE',
                'dellen': 'DELLEN-REPARATUR',
                'mechanik': 'MECHANIK-SERVICE',
                'versicherung': 'VERSICHERUNGS-SCHADEN',
                'pflege': 'FAHRZEUG-PFLEGE',
                'tuev': 'T√úV/AU-PR√úFUNG',
                'folierung': 'AUTO FOLIERUNG',
                'steinschutz': 'STEINSCHUTZFOLIE',
                'werbebeklebung': 'FAHRZEUGBESCHRIFTUNG',
                'alle': 'ALLE SERVICES'
            };

            const serviceTyp = data.serviceTyp || 'lackierung';
            const color = serviceColors[serviceTyp] || [63, 81, 181];
            const icon = serviceIcons[serviceTyp] || 'üîß';
            const label = serviceLabels[serviceTyp] || 'SERVICE';

            doc.setFillColor(color[0], color[1], color[2]);
            doc.rect(15, y - 5, 140, 10, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont(undefined, 'bold');
            doc.setFontSize(14);
            doc.text(icon + ' SERVICE: ' + label, 20, y + 1);

            y += 12;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(11);

            doc.setFont(undefined, 'bold');
            doc.text('Geplante Abnahme:', 20, y);
            doc.setFont(undefined, 'normal');
            const abnahmeDatumFormatted = data.geplantesAbnahmeDatum
                ? new Date(data.geplantesAbnahmeDatum).toLocaleDateString('de-DE')
                : 'Nicht angegeben';
            doc.text(abnahmeDatumFormatted, 100, y);

            // FAHRZEUG-ABHOLUNG Section
            if (data.fahrzeugAbholung === 'ja') {
                y += 12;
                doc.setFillColor(255, 152, 0); // Orange f√ºr Abholung
                doc.rect(15, y - 5, 140, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(13);
                doc.text('[ABHOL] FAHRZEUG-ABHOLUNG', 20, y);

                y += 10;
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);

                if (data.abholadresse) {
                    doc.setFont(undefined, 'bold');
                    doc.text('Abholadresse:', 20, y);
                    doc.setFont(undefined, 'normal');
                    const adresseLines = doc.splitTextToSize(data.abholadresse, 130);
                    doc.text(adresseLines, 70, y);
                    y += adresseLines.length * 5 + 2;
                }

                if (data.abholdatum || data.abholzeit) {
                    doc.setFont(undefined, 'bold');
                    doc.text('Abholdatum/-zeit:', 20, y);
                    doc.setFont(undefined, 'normal');
                    let abholText = '';
                    if (data.abholdatum) {
                        abholText = new Date(data.abholdatum).toLocaleDateString('de-DE');
                    }
                    if (data.abholzeit) {
                        abholText += (abholText ? ' um ' : '') + data.abholzeit + ' Uhr';
                    }
                    doc.text(abholText, 70, y);
                    y += 7;
                }

                if (data.abholnotiz) {
                    doc.setFont(undefined, 'bold');
                    doc.text('Notiz:', 20, y);
                    doc.setFont(undefined, 'normal');
                    const notizLines = doc.splitTextToSize(data.abholnotiz, 130);
                    doc.text(notizLines, 70, y);
                    y += notizLines.length * 5 + 2;
                }

                y += 5; // Extra spacing
            }

            // SERVICE-DETAILS (f√ºr service-spezifische Felder)
            if (data.serviceTyp && data.serviceTyp !== 'lackierung' && data.serviceDetails) {
                y += 12;
                doc.setFillColor(156, 39, 176); // Lila f√ºr Service-Details
                doc.rect(15, y - 5, 140, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(13);

                // Service-Name Header
                const serviceNames = {
                    'reifen': 'REIFEN-SERVICE',
                    'glas': 'GLAS-REPARATUR',
                    'klima': 'KLIMA-SERVICE',
                    'dellen': 'DELLEN-REPARATUR',
                    'mechanik': 'MECHANIK-SERVICE',
                    'versicherung': 'VERSICHERUNGS-SCHADEN',
                    'pflege': 'FAHRZEUG-PFLEGE',
                    'tuev': 'T√úV/AU-PR√úFUNG',
                    'folierung': 'AUTO FOLIERUNG',
                    'steinschutz': 'STEINSCHUTZFOLIE',
                    'werbebeklebung': 'FAHRZEUGBESCHRIFTUNG'
                };
                doc.text(serviceNames[data.serviceTyp] || 'SERVICE-DETAILS', 20, y);

                y += 10;
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);

                // Service-spezifische Felder
                switch(data.serviceTyp) {
                    case 'reifen':
                        if (data.serviceDetails.reifengroesse) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Reifengr√∂√üe:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.reifengroesse, 60, y);
                            y += 7;
                        }
                        if (data.serviceDetails.reifentyp) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Reifentyp:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.reifentyp, 60, y);
                            y += 7;
                        }
                        if (data.serviceDetails.reifenanzahl) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Anzahl:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.reifenanzahl + ' Reifen', 60, y);
                            y += 7;
                        }
                        break;

                    case 'glas':
                        if (data.serviceDetails.scheibentyp) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Scheibentyp:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.scheibentyp, 60, y);
                            y += 7;
                        }
                        if (data.serviceDetails.schadensgroesse) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Schadensgr√∂√üe:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.schadensgroesse, 60, y);
                            y += 7;
                        }
                        if (data.serviceDetails.glasposition) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Position:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.glasposition, 60, y);
                            y += 7;
                        }
                        break;

                    case 'klima':
                        if (data.serviceDetails.klimaservice) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Service-Art:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.klimaservice, 60, y);
                            y += 7;
                        }
                        if (data.serviceDetails.kaeltemittel) {
                            doc.setFont(undefined, 'bold');
                            doc.text('K√§ltemittel:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.kaeltemittel, 60, y);
                            y += 7;
                        }
                        if (data.serviceDetails.klimaproblem) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Problem:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const klimaText = doc.splitTextToSize(data.serviceDetails.klimaproblem, 130);
                            doc.text(klimaText, 60, y);
                            y += klimaText.length * 5 + 2;
                        }
                        break;

                    case 'dellen':
                        if (data.serviceDetails.dellenanzahl) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Anzahl Dellen:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.dellenanzahl, 60, y);
                            y += 7;
                        }
                        if (data.serviceDetails.dellengroesse) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Gr√∂√üe:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.dellengroesse, 60, y);
                            y += 7;
                        }
                        if (data.serviceDetails.lackschaden) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Lackschaden:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.lackschaden, 60, y);
                            y += 7;
                        }
                        if (data.serviceDetails.dellenpositionen) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Positionen:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const dellenText = doc.splitTextToSize(data.serviceDetails.dellenpositionen, 130);
                            doc.text(dellenText, 60, y);
                            y += dellenText.length * 5 + 2;
                        }
                        break;

                    case 'mechanik':
                        if (data.serviceDetails.problem) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Problem:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const problemText = doc.splitTextToSize(data.serviceDetails.problem, 130);
                            doc.text(problemText, 60, y);
                            y += problemText.length * 5 + 2;
                        }
                        if (data.serviceDetails.symptome) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Symptome:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const symptomeText = doc.splitTextToSize(data.serviceDetails.symptome, 130);
                            doc.text(symptomeText, 60, y);
                            y += symptomeText.length * 5 + 2;
                        }
                        break;

                    case 'versicherung':
                        if (data.serviceDetails.schadensnummer) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Schadensnummer:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.schadensnummer, 70, y);
                            y += 7;
                        }
                        if (data.serviceDetails.versicherung) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Versicherung:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.versicherung, 70, y);
                            y += 7;
                        }
                        if (data.serviceDetails.schadendatum) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Schadendatum:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const schadenDatum = new Date(data.serviceDetails.schadendatum).toLocaleDateString('de-DE');
                            doc.text(schadenDatum, 70, y);
                            y += 7;
                        }
                        if (data.serviceDetails.unfallhergang) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Unfallhergang:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const hergangText = doc.splitTextToSize(data.serviceDetails.unfallhergang, 130);
                            doc.text(hergangText, 70, y);
                            y += hergangText.length * 5 + 2;
                        }
                        break;

                    case 'pflege':
                        if (data.serviceDetails.paket) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Pflege-Paket:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.paket, 60, y);
                            y += 7;
                        }
                        if (data.serviceDetails.zusatzleistungen) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Zusatzleistungen:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const zusatzText = doc.splitTextToSize(data.serviceDetails.zusatzleistungen, 130);
                            doc.text(zusatzText, 60, y);
                            y += zusatzText.length * 5 + 2;
                        }
                        break;

                    case 'tuev':
                        if (data.serviceDetails.pruefart) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Pr√ºfart:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.pruefart, 60, y);
                            y += 7;
                        }
                        if (data.serviceDetails.faelligkeit) {
                            doc.setFont(undefined, 'bold');
                            doc.text('F√§lligkeit:', 20, y);
                            doc.setFont(undefined, 'normal');
                            // Format YYYY-MM to "Monat YYYY"
                            const faelligkeitDate = new Date(data.serviceDetails.faelligkeit + '-01');
                            const faelligkeitText = faelligkeitDate.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
                            doc.text(faelligkeitText, 60, y);
                            y += 7;
                        }
                        if (data.serviceDetails.bekannteMaengel) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Bekannte M√§ngel:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const maengelText = doc.splitTextToSize(data.serviceDetails.bekannteMaengel, 130);
                            doc.text(maengelText, 60, y);
                            y += maengelText.length * 5 + 2;
                        }
                        break;

                    case 'folierung':
                        if (data.serviceDetails.folierungArt) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Art der Folierung:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const artLabels = {
                                'vollfolierung': 'Vollfolierung',
                                'teilfolierung': 'Teilfolierung',
                                'akzentfolierung': 'Akzentfolierung'
                            };
                            doc.text(artLabels[data.serviceDetails.folierungArt] || data.serviceDetails.folierungArt, 70, y);
                            y += 7;
                        }
                        if (data.serviceDetails.folierungMaterial) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Materialqualit√§t:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const materialLabels = {
                                'standard': 'Standard',
                                'premium': 'Premium',
                                'high_end': 'High-End'
                            };
                            doc.text(materialLabels[data.serviceDetails.folierungMaterial] || data.serviceDetails.folierungMaterial, 70, y);
                            y += 7;
                        }
                        if (data.serviceDetails.folierungFarbe) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Farbauswahl:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.folierungFarbe, 70, y);
                            y += 7;
                        }
                        if (data.serviceDetails.folierungDesign) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Design-Vorstellungen:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const designText = doc.splitTextToSize(data.serviceDetails.folierungDesign, 130);
                            doc.text(designText, 20, y + 5);
                            y += designText.length * 5 + 7;
                        }
                        if (data.serviceDetails.folierungInfo) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Zus√§tzliche Informationen:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const infoText = doc.splitTextToSize(data.serviceDetails.folierungInfo, 130);
                            doc.text(infoText, 20, y + 5);
                            y += infoText.length * 5 + 7;
                        }
                        break;

                    case 'steinschutz':
                        if (data.serviceDetails.steinschutzUmfang) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Schutzumfang:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const umfangLabels = {
                                'vollverklebung': 'Vollverklebung',
                                'frontpaket': 'Frontpaket',
                                'teilbereich': 'Teilbereich'
                            };
                            doc.text(umfangLabels[data.serviceDetails.steinschutzUmfang] || data.serviceDetails.steinschutzUmfang, 70, y);
                            y += 7;
                        }
                        if (data.serviceDetails.steinschutzMaterial) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Materialqualit√§t:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const materialLabels = {
                                'standard': 'Standard',
                                'premium': 'Premium',
                                'high_end': 'High-End'
                            };
                            doc.text(materialLabels[data.serviceDetails.steinschutzMaterial] || data.serviceDetails.steinschutzMaterial, 70, y);
                            y += 7;
                        }
                        if (data.serviceDetails.steinschutzBereiche) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Zu sch√ºtzende Bereiche:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const bereicheText = doc.splitTextToSize(data.serviceDetails.steinschutzBereiche, 130);
                            doc.text(bereicheText, 20, y + 5);
                            y += bereicheText.length * 5 + 7;
                        }
                        if (data.serviceDetails.steinschutzInfo) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Zus√§tzliche Informationen:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const infoText = doc.splitTextToSize(data.serviceDetails.steinschutzInfo, 130);
                            doc.text(infoText, 20, y + 5);
                            y += infoText.length * 5 + 7;
                        }
                        break;

                    case 'werbebeklebung':
                        if (data.serviceDetails.werbebeklebungUmfang) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Umfang der Beklebung:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const umfangLabels = {
                                'einfach': 'Einfache Beschriftung',
                                'komplex': 'Komplexe Gestaltung',
                                'teilbeklebung': 'Teilbeklebung',
                                'magnetschilder': 'Magnetschilder',
                                'logo': 'Logo/Schriftzug'
                            };
                            doc.text(umfangLabels[data.serviceDetails.werbebeklebungUmfang] || data.serviceDetails.werbebeklebungUmfang, 70, y);
                            y += 7;
                        }
                        if (data.serviceDetails.werbebeklebungKomplexitaet) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Design-Komplexit√§t:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const komplexLabels = {
                                'einfach': 'Einfach',
                                'mittel': 'Mittel',
                                'komplex': 'Komplex'
                            };
                            doc.text(komplexLabels[data.serviceDetails.werbebeklebungKomplexitaet] || data.serviceDetails.werbebeklebungKomplexitaet, 70, y);
                            y += 7;
                        }
                        if (data.serviceDetails.werbebeklebungText) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Textelemente:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const textElements = doc.splitTextToSize(data.serviceDetails.werbebeklebungText, 130);
                            doc.text(textElements, 20, y + 5);
                            y += textElements.length * 5 + 7;
                        }
                        if (data.serviceDetails.werbebeklebungFarbanzahl) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Anzahl Farben:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.werbebeklebungFarbanzahl + ' Farben', 70, y);
                            y += 7;
                        }
                        if (data.serviceDetails.werbebeklebungInfo) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Zus√§tzliche Informationen:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const infoText = doc.splitTextToSize(data.serviceDetails.werbebeklebungInfo, 130);
                            doc.text(infoText, 20, y + 5);
                            y += infoText.length * 5 + 7;
                        }
                        break;
                }

                y += 5; // Extra spacing after service details
            }

            // Fahrzeugdaten
            y += 12;
            doc.setFillColor(102, 126, 234);
            doc.rect(15, y - 5, 140, 8, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFont(undefined, 'bold');
            doc.text('FAHRZEUGDATEN', 20, y);

            y += 10;
            doc.setTextColor(0, 0, 0);
            doc.setFont(undefined, 'bold');
            doc.text('Marke:', 20, y);
            doc.setFont(undefined, 'normal');
            doc.text(data.marke, 50, y);
            doc.setFont(undefined, 'bold');
            doc.text('Modell:', 110, y);
            doc.setFont(undefined, 'normal');
            doc.text(data.modell, 140, y);

            const baujahrVon = data.baujahrVon || data.baujahr;
            const baujahrBis = data.baujahrBis || data.baujahr;

            // Baujahr + KM-Stand immer anzeigen
            y += 7;
            doc.setFont(undefined, 'bold');
            doc.text('Baujahr:', 20, y);
            doc.setFont(undefined, 'normal');

            let baujahrText = '';
            if (baujahrVon && baujahrBis) {
                if (baujahrVon === baujahrBis) {
                    baujahrText = baujahrVon;
                } else {
                    baujahrText = baujahrVon + ' - ' + baujahrBis;
                }
            } else if (baujahrVon) {
                baujahrText = 'ab ' + baujahrVon;
            } else if (baujahrBis) {
                baujahrText = 'bis ' + baujahrBis;
            } else {
                baujahrText = 'Nicht angegeben';
            }
            doc.text(baujahrText, 50, y);

            // KM-Stand immer anzeigen
            doc.setFont(undefined, 'bold');
            doc.text('KM-Stand:', 110, y);
            doc.setFont(undefined, 'normal');
            doc.text(data.kmstand ? (data.kmstand + ' km') : 'Nicht angegeben', 140, y);

            // VIN immer anzeigen
            y += 7;
            doc.setFont(undefined, 'bold');
            doc.text('VIN/FIN:', 20, y);
            doc.setFont(undefined, 'normal');
            doc.text(data.vin || 'Nicht angegeben', 50, y);

            // LACKIER-INFO (NUR f√ºr Lackierung & Alle Services ODER wenn Lack-Felder ausgef√ºllt)
            const hasPaintData = data.farbnummer || data.farbname || data.farbvariante;
            if (data.serviceTyp === 'lackier' || data.serviceTyp === 'lackier' || data.serviceTyp === 'alle' || hasPaintData) {
                y += 12;
                doc.setFillColor(245, 87, 108);
                doc.rect(15, y - 5, 140, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(13);
                doc.text('[!] LACKIER-INFORMATIONEN (FUER FARBKABINE)', 20, y);

                y += 10;
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);

                // Farbname
                doc.setFont(undefined, 'bold');
                doc.text('Farbname:', 20, y);
                doc.setFont(undefined, 'normal');
                doc.text(data.farbname || 'Nicht angegeben', 55, y);
                y += 7;

                // Farbvariante
                doc.setFont(undefined, 'bold');
                doc.text('Farbvariante:', 20, y);
                doc.setFont(undefined, 'normal');
                doc.text(data.farbvariante || 'Nicht angegeben', 55, y);
                y += 7;

                // FARBNUMMER GROSS
                doc.setFillColor(255, 243, 205);
                doc.rect(15, y - 3, 140, 12, 'F');
                doc.setFont(undefined, 'bold');
                doc.setFontSize(14);
                doc.setTextColor(199, 37, 78);
                doc.text('FARBNUMMER:', 20, y + 4);
                doc.setFontSize(18);
                doc.text(data.farbnummer || 'Nicht angegeben', 70, y + 4);

                y += 15;
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text('Lackart:', 20, y);
                doc.setFont(undefined, 'normal');
                doc.text(data.lackart || 'Standard', 55, y);

                y += 7; // Extra spacing after Lackier-Info
            }

            // PREIS-KALKULATION (Partner-Anfrage mit KVA ODER einfacher Preis)
            // üí∞ PREISE-BERECHTIGUNG: Nur anzeigen wenn Berechtigung vorhanden
            const canShowPrices = typeof window.canViewPrices === 'function' ? window.canViewPrices() : true;

            if (canShowPrices && data.kva && data.kva.varianten && data.gewaehlteVariante) {
                // Partner-Anfrage: KVA-Details anzeigen
                y += 15;

                // Header
                doc.setFillColor(33, 150, 243);  // Blau f√ºr KVA
                doc.rect(15, y - 5, 140, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(13);
                doc.text('PREIS-KALKULATION (Partner-Anfrage)', 20, y);

                y += 10;
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);

                // Partner-Info
                if (data.quelle === 'Partner-Portal' && data.partnerName) {
                    doc.setFont(undefined, 'normal');
                    doc.text('Partner: ' + data.partnerName, 20, y);
                    y += 5;
                }

                y += 5;

                // Tabellen-Header
                doc.setFillColor(240, 240, 240);
                doc.rect(15, y - 3, 140, 7, 'F');
                doc.setFont(undefined, 'bold');
                doc.setFontSize(9);
                doc.text('Beschreibung', 20, y);
                doc.text('Menge', 120, y);
                doc.text('Einzelpreis', 140, y);
                doc.text('Gesamt', 170, y);

                y += 7;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);

                // Positionen
                const variante = data.kva.varianten[data.gewaehlteVariante];
                const positionen = variante.positionen || [];

                for (let i = 0; i < positionen.length; i++) {
                    const pos = positionen[i];

                    if (y > 250) {
                        doc.addPage();
                        y = 20;
                    }

                    const beschreibung = doc.splitTextToSize(pos.beschreibung || 'Position', 95);
                    doc.text(beschreibung, 20, y);

                    const menge = (pos.menge || 1).toString();
                    const einzelpreis = (pos.einzelpreis || 0).toFixed(2);
                    const gesamt = (pos.gesamt || (pos.menge * pos.einzelpreis) || 0).toFixed(2);

                    doc.text(menge + 'x', 120, y);
                    doc.text(einzelpreis + ' ‚Ç¨', 140, y);
                    doc.setFont(undefined, 'bold');
                    doc.text(gesamt + ' ‚Ç¨', 170, y);
                    doc.setFont(undefined, 'normal');

                    y += Math.max(5, beschreibung.length * 4);
                }

                y += 5;

                // Summen-Block
                doc.setDrawColor(200, 200, 200);
                doc.line(15, y, 195, y);
                y += 7;

                // Netto
                if (variante.netto) {
                    doc.setFont(undefined, 'normal');
                    doc.text('Netto:', 140, y);
                    doc.text((variante.netto || 0).toFixed(2) + ' EUR', 170, y);
                    y += 5;
                }

                // MwSt
                if (variante.mwst) {
                    doc.text('MwSt 19%:', 140, y);
                    doc.text((variante.mwst || 0).toFixed(2) + ' EUR', 170, y);
                    y += 5;
                }

                // Gesamt (fett & gr√ºn)
                y += 3;
                doc.setFillColor(76, 175, 80);
                doc.rect(135, y - 5, 60, 10, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(12);
                doc.text('GESAMT:', 140, y);
                doc.setFontSize(14);
                doc.text((variante.gesamt || data.vereinbarterPreis || 0).toFixed(2) + ' EUR', 170, y);

                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);
                y += 10;

            } else if (canShowPrices && data.vereinbarterPreis) {
                // Direkte Annahme: Einfacher Preis (wie bisher)
                y += 15;
                doc.setFillColor(76, 175, 80);
                doc.rect(15, y - 5, 140, 12, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(13);
                doc.text('>>> VEREINBARTER PREIS:', 20, y + 2);
                doc.setFontSize(16);
                doc.text(data.vereinbarterPreis.toFixed(2) + ' EUR', 90, y + 2);
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);
                y += 5;
            }

            // Notizen immer anzeigen
            y += 8;  // Optimiert: 12 ‚Üí 8 (4px weniger f√ºr bessere Seitenauslastung)
            doc.setFont(undefined, 'bold');
            doc.text('Schadensbeschreibung / Notizen:', 20, y);
            y += 7;
            doc.setFont(undefined, 'normal');
            if (data.notizen) {
                const notizen = doc.splitTextToSize(data.notizen, 170);
                doc.text(notizen, 20, y);
                y += notizen.length * 5 + 5;  // Optimiert: 10 ‚Üí 5 (weniger Padding nach Notizen)
            } else {
                doc.text('Keine Notizen', 20, y);
                y += 12;
            }

            const photosForPDF = data.photosBase64 || data.photos || [];

            if (photosForPDF.length > 0) {
                if (y > 245) {  // Optimiert: 220 ‚Üí 245 (mehr Content auf Seite 1)
                    doc.addPage();
                    y = 20;
                }

                doc.setFont(undefined, 'bold');
                doc.text('Schadensfotos:', 20, y);
                y += 10;

                for (let i = 0; i < photosForPDF.length; i += 2) {
                    if (y > 230) {
                        doc.addPage();
                        y = 20;
                    }

                    const imgWidth = 80;
                    const imgHeight = 60;

                    doc.addImage(photosForPDF[i], 'JPEG', 20, y, imgWidth, imgHeight);
                    if (i + 1 < photosForPDF.length) {
                        doc.addImage(photosForPDF[i + 1], 'JPEG', 110, y, imgWidth, imgHeight);
                    }

                    y += imgHeight + 10;
                }
            }

            if (y > 210) {
                doc.addPage();
                y = 20;
            }

            y += 5;
            doc.setFont(undefined, 'bold');
            doc.text('Unterschrift Kunde:', 20, y);
            y += 5;
            const signatureY = y; // Save Y position for QR code alignment
            doc.addImage(data.signature, 'PNG', 20, y, 80, 30);

            // ============================================
            // QR-CODE SECTION (rechts neben Unterschrift)
            // ============================================
            if (data.qrCodeUrl) {
                try {
                    console.log('üî≤ Generiere QR-Code f√ºr PDF (neben Unterschrift)...');

                    // Safety check: Verify QRious loaded
                    if (typeof QRious === 'undefined') {
                        throw new Error('QRious library not loaded');
                    }

                    // Generate QR Code Canvas with QRious
                    const qrCanvas = document.createElement('canvas');
                    new QRious({
                        element: qrCanvas,
                        value: data.qrCodeUrl,
                        size: 200,
                        background: '#FFFFFF',
                        foreground: '#003366',  // Auto-Lackierzentrum blue
                        padding: 4,
                        backgroundAlpha: 1,
                        foregroundAlpha: 1,
                        level: 'H'               // High error correction (30%)
                    });

                    // Convert canvas to image data URL
                    const qrImageData = qrCanvas.toDataURL('image/png');

                    // Position QR Code next to signature
                    const qrX = 110;  // Right next to signature (signature is 80mm wide, ends at x=100)
                    const qrY = signatureY - 5;  // Align with "Unterschrift Kunde:" label
                    const qrSize = 30;

                    // Light gray background box
                    doc.setFillColor(245, 245, 245);
                    doc.roundedRect(qrX - 2, qrY - 2, qrSize + 4, qrSize + 39, 2, 2, 'F');

                    // Add QR Code image
                    doc.addImage(qrImageData, 'PNG', qrX, qrY, qrSize, qrSize);

                    // Border around QR code
                    doc.setDrawColor(0, 51, 102);
                    doc.setLineWidth(0.5);
                    doc.rect(qrX, qrY, qrSize, qrSize);

                    // "PARTNER-PORTAL" Label above QR
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(0, 51, 102);
                    doc.text('PARTNER-PORTAL', qrX + (qrSize / 2), qrY - 2, { align: 'center' });

                    // Expiration Date below QR code
                    if (data.qrCodeExpiresAt) {
                        const expiryDate = new Date(data.qrCodeExpiresAt).toLocaleDateString('de-DE');
                        doc.setFontSize(6);
                        doc.setFont(undefined, 'normal');
                        doc.setTextColor(80, 80, 80);
                        doc.text('G√ºltig bis: ' + expiryDate, qrX + (qrSize / 2), qrY + qrSize + 3, { align: 'center' });
                    }

                    // PASSWORT SECTION (nur f√ºr NEU-KUNDEN)
                    if (data.isNewPartner && data.partnerPassword) {
                        console.log('üÜï NEU-KUNDE ‚Üí Passwort wird im PDF angezeigt');

                        const pwY = qrY + qrSize + 8;

                        // Yellow background box for password
                        doc.setFillColor(255, 243, 205);
                        doc.roundedRect(qrX - 2, pwY - 2, qrSize + 4, 14, 2, 2, 'F');

                        // "PASSWORT" Label
                        doc.setFontSize(7);
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(139, 69, 19);
                        doc.text('PASSWORT:', qrX + (qrSize / 2), pwY + 2, { align: 'center' });

                        // Password
                        doc.setFontSize(9);
                        doc.setFont('courier', 'bold');
                        doc.setTextColor(0, 0, 0);
                        doc.text(data.partnerPassword, qrX + (qrSize / 2), pwY + 7, { align: 'center' });

                        // Security hint
                        doc.setFontSize(5);
                        doc.setFont(undefined, 'italic');
                        doc.setTextColor(100, 100, 100);
                        doc.text('(Beim 1. Login √§ndern)', qrX + (qrSize / 2), pwY + 11, { align: 'center' });

                        console.log('   ‚úÖ Passwort im PDF angezeigt:', data.partnerPassword);
                    } else {
                        console.log('   ‚úÖ BESTANDSKUNDE ‚Üí Kein Passwort im PDF');
                    }

                    // Reset text color
                    doc.setTextColor(0, 0, 0);
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(11);

                    console.log('‚úÖ QR-Code erfolgreich neben Unterschrift platziert');

                } catch (qrError) {
                    console.error('‚ùå QR-Code Generierung fehlgeschlagen:', qrError);
                }
            } else {
                console.log('‚è≠Ô∏è Kein QR-Code URL ‚Üí √úbersprungen');
            }

            const filename = `Annahme_${data.kennzeichen.replace(/\s/g, '_')}_${data.datum.replace(/\./g, '')}.pdf`;
            doc.save(filename);
        }

        // Arbeitsauftrag erstellen
        async function createArbeitsauftrag() {
            const serviceTyp = document.getElementById('serviceTyp').value;

            // Grundvalidierung
            if (!document.getElementById('kennzeichen').value || !document.getElementById('marke').value) {
                showToast('Bitte mindestens Kennzeichen und Marke eingeben!', 'error');
                return;
            }

            // Farbnummer nur bei Lackierung & Alle Services pr√ºfen
            if ((serviceTyp === 'lackier' || serviceTyp === 'alle') && !document.getElementById('farbnummer').value) {
                showToast('Bitte Farbnummer f√ºr Lackierung/Arbeitsauftrag eingeben!', 'error');
                return;
            }

            const data = getFormData();

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFillColor(255, 193, 7);
            doc.rect(0, 0, 210, 50, 'F');
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(28);
            doc.setFont(undefined, 'bold');
            doc.text('ARBEITSAUFTRAG', 105, 25, { align: 'center' });
            doc.setFontSize(14);
            doc.text('Lackierwerkstatt', 105, 38, { align: 'center' });

            let y = 70;

            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text('Kennzeichen:', 20, y);
            doc.setFontSize(32);
            doc.text(data.kennzeichen, 105, y, { align: 'center' });

            y += 20;
            doc.setFontSize(18);
            doc.text('Fahrzeug:', 20, y);
            doc.setFont(undefined, 'normal');
            doc.text(`${data.marke} ${data.modell}`, 70, y);

            y += 25;
            doc.setFillColor(255, 243, 205);
            doc.rect(15, y - 10, 140, 30, 'F');
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(199, 37, 78);
            doc.text('[!] FARBNUMMER:', 20, y);
            doc.setFontSize(36);
            doc.text(data.farbnummer, 105, y + 5, { align: 'center' });

            y += 25;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(16);
            doc.text('Lackart:', 20, y);
            doc.setFont(undefined, 'normal');
            doc.text(data.lackart, 70, y);

            if (data.farbname) {
                y += 10;
                doc.setFont(undefined, 'bold');
                doc.text('Farbname:', 20, y);
                doc.setFont(undefined, 'normal');
                doc.text(data.farbname, 70, y);
            }

            if (data.farbvariante) {
                y += 10;
                doc.setFont(undefined, 'bold');
                doc.text('Farbvariante:', 20, y);
                doc.setFont(undefined, 'normal');
                doc.text(data.farbvariante, 70, y);
            }

            if (data.notizen) {
                y += 20;
                doc.setFont(undefined, 'bold');
                doc.setFontSize(14);
                doc.text('Schadensbeschreibung:', 20, y);
                y += 8;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(12);
                const notizen = doc.splitTextToSize(data.notizen, 170);
                doc.text(notizen, 20, y);
            }

            doc.setFontSize(10);
            doc.setTextColor(150, 150, 150);
            doc.text('Auto-Lackierzentrum Mosbach', 105, 280, { align: 'center' });
            doc.text(data.datum, 105, 285, { align: 'center' });

            const filename = `Arbeitsauftrag_${data.kennzeichen.replace(/\s/g, '_')}.pdf`;
            doc.save(filename);
        }
    </script>

    <!-- Error Handler & Storage Monitor -->
    <script src="error-handler.js"></script>
    <script src="storage-monitor.js"></script>

    <!-- Theme Toggle System -->
    <script>
        // ============================================
        // üåì THEME TOGGLE SYSTEM (mit Feather Icons Stroke-Width Update)
        // ============================================

        (function initThemeToggle() {
            const themeToggle = document.getElementById('themeToggle');
            const html = document.documentElement;

            // Update Feather Icons stroke-width based on theme
            function updateFeatherIcons(theme) {
                const strokeWidth = theme === 'light' ? '2.5' : '2';
                document.querySelectorAll('i[data-feather]').forEach(icon => {
                    const svg = icon.querySelector('svg');
                    if (svg) {
                        svg.querySelectorAll('*[stroke]').forEach(element => {
                            element.setAttribute('stroke-width', strokeWidth);
                        });
                    }
                });
            }

            // Load theme from localStorage (default: dark)
            let currentTheme = localStorage.getItem('theme') || 'dark';
            html.setAttribute('data-theme', currentTheme);

            // Theme toggle on button click
            if (themeToggle) {
                const themeToggleHandler = () => {
                    currentTheme = currentTheme === 'light' ? 'dark' : 'light';
                    html.setAttribute('data-theme', currentTheme);
                    localStorage.setItem('theme', currentTheme);

                    // Re-initialize Feather Icons with updated stroke-width
                    if (typeof feather !== 'undefined') {
                        feather.replace();
                        setTimeout(() => updateFeatherIcons(currentTheme), 50);
                    }

                    console.log(`‚úÖ Theme switched to: ${currentTheme}`);
                };
                window.listenerRegistry.registerDOM(themeToggle, 'click', themeToggleHandler, 'Theme Toggle Button');
            }

            // Initialize Feather Icons on load with correct stroke-width
            if (typeof feather !== 'undefined') {
                feather.replace();
                setTimeout(() => updateFeatherIcons(currentTheme), 50);
            }

            console.log(`üåì Theme loaded: ${currentTheme}`);
        })();
    </script>

    <!-- KI-Chat-Assistent -->
    <div id="aiChatWidget"></div>
    <script src="js/ai-agent-tools.js"></script>
    <script src="js/ai-agent-engine.js"></script>
    <script src="js/ai-chat-widget.js"></script>

    <!-- ============================================
         SERVICE WORKER REGISTRATION - Offline-Funktionalit√§t
         ============================================ -->
    <script>
        // Service Worker nur registrieren wenn:
        // 1. Browser unterst√ºtzt Service Worker
        // 2. NICHT in Playwright Tests (navigator.webdriver)
        // 3. NICHT auf Emulator-Port (8000)
        if ('serviceWorker' in navigator && !navigator.webdriver && window.location.port !== '8000') {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('./sw.js', {
                        scope: './'
                    });

                    console.log('‚úÖ [SW] Service Worker registriert:', registration.scope);

                    // Update-Handling: Neuen SW aktivieren wenn gefunden
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('üîÑ [SW] Update gefunden, installiere...');

                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                console.log('‚úÖ [SW] Update bereit! Seite neu laden f√ºr neue Version.');

                                // Optional: Auto-reload nach 3 Sekunden
                                // setTimeout(() => window.location.reload(), 3000);
                            }
                        });
                    });

                } catch (error) {
                    console.error('‚ùå [SW] Registrierung fehlgeschlagen:', error);
                }
            });
        } else {
            console.log('‚ÑπÔ∏è [SW] Service Worker nicht registriert (Test-Modus oder nicht unterst√ºtzt)');
        }
    </script>
</body>
</html>
