<!DOCTYPE html>
<!-- CACHE BUSTER: v2025-12-03-frontend-ux-v2 -->
<html lang="de">
<head>
    <!-- werkstattId will be set dynamically by auth-manager.js after login -->
    <script>
        /// <reference path="js/types.js" />
        // window.werkstattId is set automatically after successful login
        // This ensures proper multi-tenant data isolation
    </script>
    <script>
        // üÜï FIX #2: PDF UPLOAD VALIDATION (2025-11-15)
        // Prevents: Non-PDF uploads, Storage quota exhaustion, Malware-disguised PDFs
        window.validatePDFFile = function(file) {
            const allowedType = 'application/pdf';
            const maxSize = 50 * 1024 * 1024; // 50 MB

            if (!file) {
                throw new Error('‚ùå Keine PDF-Datei!');
            }

            // Check 1: File-Type Validation
            if (file.type !== allowedType) {
                throw new Error(`‚ùå Nur PDF erlaubt!\n\nDein Typ: ${file.type || 'unbekannt'}`);
            }

            // Check 2: Size Validation
            if (file.size > maxSize) {
                throw new Error(`‚ùå PDF zu gro√ü!\n\nMaximum: 50 MB\nDeine Gr√∂√üe: ${(file.size / 1024 / 1024).toFixed(2)} MB`);
            }

            // console.log('‚úÖ [validatePDFFile] PDF validiert:', {
                type: file.type,
                sizeMB: (file.size / 1024 / 1024).toFixed(2)
            });

            return { isValid: true };
        };
    </script>
    <script>
        // ‚úÖ BUG #5 FIX: Global DEBUG flag for conditional logging
        window.DEBUG = (
            localStorage.getItem('DEBUG') === 'true' ||
            window.location.search.includes('debug=true') ||
            window.location.hostname === 'localhost' ||
            window.location.port === '8000'
        );
    </script>

    <!-- ‚úÖ BUG #7 FIX: Service Type Normalization Registry -->
    <script src="js/service-types.js?v=bug7-normalization"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fahrzeug-Annahme | Auto-Lackierzentrum Mosbach</title>

    <!-- Aggressive No-Cache Headers (Cache-Fix f√ºr v=a4192c4) -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- üåì FOUC Prevention: Load Theme BEFORE CSS to prevent flash -->
    <script>
        (function() {
            // Load saved theme from localStorage (default: light)
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            // console.log(`üåì Theme pre-loaded in <head>: ${savedTheme} (FOUC Prevention)`);
        })();
    </script>

    <!-- Design System -->
    <!-- Critical CSS (render-blocking) -->
    <link rel="stylesheet" href="design-system.css?v=af6b90f">
    <link rel="stylesheet" href="components.css?v=af6b90f">
    <link rel="stylesheet" href="mobile-first.css?v=af6b90f">
    <!-- üöÄ PERF: Non-critical CSS deferred -->
    <link rel="stylesheet" href="animations.css?v=af6b90f" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="css/ai-chat-widget.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="css/quota-display.css" media="print" onload="this.media='all'">

    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- jsPDF autoTable Plugin for Excel-Style Tables (Nov 20, 2025) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <!-- PDF.js for PDF Parsing -->
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>

    <!-- QRious - Browser-optimized QR Code Generator (Local Copy) -->
    <script src="./libs/qrious.min.js"></script>

    <!-- GSAP Animation Library (Phase 1 UX Redesign) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

    <style>
        /* ========== LIGHT MODE ENHANCEMENT (Option 1 + 3) ========== */
        body {
            background: var(--color-background);
            min-height: 100vh;
            padding: var(--space-6) var(--space-4) 100px;
        }

        /* Light Mode: Subtiler Gradient-Hintergrund f√ºr mehr Tiefe */
        [data-theme="light"] body {
            background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 50%, #f8f9fa 100%);
            background-attachment: fixed;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* Page Header */
        .page-header {
            text-align: center;
            margin-bottom: var(--space-8);
            padding: var(--space-8) var(--space-6);
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        /* Light Mode: Page Header mit mehr Tiefe */
        [data-theme="light"] .page-header {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08), 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .page-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(255, 255, 255, 0.3) 50%,
                transparent 100%
            );
            opacity: 0.5;
        }

        .page-header h1 {
            font-size: clamp(24px, 5vw, 36px);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin-bottom: var(--space-2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-3);
        }

        .page-header p {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
        }

        .date-display {
            color: var(--color-text-tertiary);
            font-size: var(--font-size-sm);
            text-align: right;
            margin-bottom: var(--space-4);
        }

        /* Form Container */
        .form-container {
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            padding: var(--space-8);
            margin-bottom: var(--space-6);
            position: relative;
            overflow: hidden;
        }

        /* Light Mode: Form Container mit st√§rkerem Schatten */
        [data-theme="light"] .form-container {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1), 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .form-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(255, 255, 255, 0.3) 50%,
                transparent 100%
            );
            opacity: 0.3;
        }

        /* Section Title with Icon */
        .section-title {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin: var(--space-8) 0 var(--space-6) 0;
            padding-bottom: var(--space-3);
            border-bottom: 1px solid var(--color-border);
        }

        .section-title:first-child {
            margin-top: 0;
        }

        .section-title i {
            width: 24px;
            height: 24px;
            color: var(--color-primary);
        }

        /* ========== COLLAPSIBLE SECTIONS (Phase 2 UX) ========== */
        .collapsible-section {
            margin: var(--space-4) 0;
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            background: var(--color-surface);
            border-left: 4px solid var(--color-primary);
            transition: box-shadow 0.3s ease, transform 0.2s ease;
        }

        /* Option 6: Schatten-Animation beim Hover */
        .collapsible-section:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
            transform: translateY(-2px);
        }

        /* Light Mode: Collapsible mit subtiler Grau-Abstufung */
        [data-theme="light"] .collapsible-section {
            border: 1px solid #d0d0d0;
            border-left: 4px solid var(--section-accent, #0066cc);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        }

        [data-theme="light"] .collapsible-section:hover {
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.1);
        }

        /* Option 3: Farbige Section-Akzente */
        #service-collapsible {
            --section-accent: #00BCD4; /* Cyan - Service-Auswahl */
            border-left-color: #00BCD4;
        }

        #kunden-collapsible {
            --section-accent: #2196F3; /* Blau - Kundendaten */
            border-left-color: #2196F3;
        }

        #zusatz-services-collapsible {
            --section-accent: #9C27B0; /* Lila - Zus√§tzliche Services */
            border-left-color: #9C27B0;
        }

        #abholung-collapsible {
            --section-accent: #4CAF50; /* Gr√ºn - Abholung & Extras */
            border-left-color: #4CAF50;
        }

        #fahrzeug-collapsible {
            --section-accent: #FF9800; /* Orange - Fahrzeugdaten */
            border-left-color: #FF9800;
        }

        #kosten-collapsible {
            --section-accent: #F44336; /* Rot - Kostenaufschl√ºsselung */
            border-left-color: #F44336;
        }

        .collapsible-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--space-4) var(--space-5);
            background: var(--color-bg-secondary);
            cursor: pointer;
            user-select: none;
            transition: background var(--duration-fast) var(--ease-out);
        }

        /* Light Mode: Header mit warmem Grau */
        [data-theme="light"] .collapsible-header {
            background: linear-gradient(180deg, #f5f5f5 0%, #ebebeb 100%);
            border-bottom: 1px solid #d8d8d8;
        }

        /* Farbiger Akzent-Punkt im Header */
        .collapsible-header-title::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 10px;
            background: var(--section-accent, var(--color-primary));
        }

        #kunden-collapsible .collapsible-header-title::before {
            background: #2196F3;
        }

        #zusatz-services-collapsible .collapsible-header-title::before {
            background: #9C27B0;
        }

        #abholung-collapsible .collapsible-header-title::before {
            background: #4CAF50;
        }

        #fahrzeug-collapsible .collapsible-header-title::before {
            background: #FF9800;
        }

        #kosten-collapsible .collapsible-header-title::before {
            background: #F44336;
        }

        .collapsible-header:hover {
            background: var(--color-bg-tertiary);
        }

        [data-theme="light"] .collapsible-header:hover {
            background: linear-gradient(180deg, #ebebeb 0%, #e0e0e0 100%);
        }

        .collapsible-header-left {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .collapsible-header-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
        }

        .collapsible-header-badge {
            font-size: var(--font-size-xs);
            padding: 2px 8px;
            background: var(--color-primary);
            color: white;
            border-radius: var(--radius-full);
            margin-left: var(--space-2);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height var(--duration-base) var(--ease-out);
        }

        .collapsible-section.is-open .collapsible-content {
            max-height: 2000px;
        }

        .collapsible-content-inner {
            padding: var(--space-5);
            border-top: 1px solid var(--color-border);
        }

        /* Optional badge for collapsible */
        .collapsible-header-hint {
            font-size: var(--font-size-sm);
            color: var(--color-text-tertiary);
            font-weight: normal;
        }

        /* Photo Section */
        .photo-section {
            margin-bottom: var(--space-6);
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: var(--space-4);
            margin-top: var(--space-4);
        }

        .photo-item {
            position: relative;
            aspect-ratio: 1;
            border: 2px dashed var(--color-border);
            border-radius: var(--radius-lg);
            overflow: hidden;
            cursor: pointer;
            transition: all var(--duration-base) var(--ease-out);
            background: rgba(255, 255, 255, 0.05);
        }

        /* Light Mode: Photo Item mit hellem Grau */
        [data-theme="light"] .photo-item {
            background: #f5f5f5;
            border: 2px dashed #c0c0c0;
        }

        .photo-item:hover {
            border-color: var(--color-primary);
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(0, 191, 255, 0.2);
        }

        [data-theme="light"] .photo-item:hover {
            background: #eef6ff;
            border-color: #0066cc;
            box-shadow: 0 4px 15px rgba(0, 102, 204, 0.15);
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-item.empty {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: var(--space-2);
        }

        .photo-item.empty i {
            width: 40px;
            height: 40px;
            color: var(--color-text-tertiary);
        }

        .photo-item.empty span {
            font-size: var(--font-size-xs);
            color: var(--color-text-tertiary);
        }

        .remove-photo {
            position: absolute;
            top: var(--space-2);
            right: var(--space-2);
            background: var(--color-error);
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-size: 20px;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all var(--duration-base) var(--ease-out);
        }

        .remove-photo:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(255, 69, 58, 0.4);
        }

        .photo-item:hover .remove-photo {
            display: flex;
        }

        #photoInput {
            display: none;
        }

        /* Signature Canvas */
        .signature-section {
            margin-bottom: var(--space-6);
        }

        #signatureCanvas {
            width: 100%;
            height: 200px;
            border: 2px solid var(--color-border);
            border-radius: var(--radius-lg);
            cursor: crosshair;
            touch-action: none;
            background: rgba(255, 255, 255, 0.03);
            transition: border-color var(--duration-base) var(--ease-out);
        }

        #signatureCanvas:hover {
            border-color: var(--color-primary);
        }

        .signature-buttons {
            display: flex;
            gap: var(--space-3);
            margin-top: var(--space-3);
        }

        /* Info Box */
        .info-box {
            background: rgba(0, 191, 255, 0.1);
            border: 1px solid rgba(0, 191, 255, 0.3);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            margin-bottom: var(--space-6);
            display: flex;
            gap: var(--space-3);
            align-items: flex-start;
        }

        /* Light Mode: Info Box mit besserem Kontrast */
        [data-theme="light"] .info-box {
            background: linear-gradient(135deg, rgba(0, 150, 200, 0.08) 0%, rgba(0, 191, 255, 0.12) 100%);
            border: 1px solid rgba(0, 150, 200, 0.25);
            box-shadow: 0 2px 8px rgba(0, 150, 200, 0.08);
        }

        .info-box i {
            color: var(--color-primary);
            flex-shrink: 0;
        }

        .info-box-content {
            flex: 1;
        }

        .info-box-content strong {
            color: var(--color-text-primary);
        }

        .info-box-content p {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
            margin: 0;
        }

        /* Success Message */
        .success-message {
            display: none;
            background: var(--color-success);
            color: white;
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            text-align: center;
            margin-bottom: var(--space-6);
            animation: slideDown var(--duration-base) var(--ease-out);
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Highlight Form Group */
        .form-group.highlight {
            background: rgba(255, 193, 7, 0.1);
            padding: var(--space-4);
            border-radius: var(--radius-lg);
            border: 2px solid var(--color-warning);
        }

        .form-group.highlight label {
            color: var(--color-warning);
            font-size: var(--font-size-lg);
        }

        .form-group.highlight input {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            border: 2px solid var(--color-warning);
        }

        /* Abholung Details Box */
        #abholungDetails {
            background: rgba(0, 191, 255, 0.05);
            padding: var(--space-5);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(0, 191, 255, 0.2);
        }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: var(--z-fixed);
            background: var(--color-surface-elevated);
            backdrop-filter: blur(var(--glass-blur-strong)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur-strong)) saturate(var(--glass-saturation));
            border-top: 1px solid var(--color-border-glass);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
            padding: var(--space-3);
        }

        .bottom-nav-content {
            max-width: 600px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-2);
        }

        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-2);
            text-decoration: none;
            color: var(--color-text-secondary);
            border-radius: var(--radius-md);
            transition: all var(--duration-base) var(--ease-out);
        }

        .bottom-nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--color-text-primary);
        }

        .bottom-nav-item.active {
            color: var(--color-primary);
            background: rgba(0, 191, 255, 0.1);
        }

        .bottom-nav-item i {
            width: 24px;
            height: 24px;
        }

        .bottom-nav-item span {
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
        }

        /* Submit Buttons Container */
        .submit-buttons {
            display: flex;
            flex-direction: column;
            gap: var(--space-3);
            margin-top: var(--space-6);
        }

        /* Submit Button Styling - H√§kchen-Fix */
        .submit-buttons .btn {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-weight: 600;
            font-size: 16px;
            padding: 14px 24px;
            border-radius: 10px;
            transition: all 0.3s ease;
            text-transform: none;
            letter-spacing: 0;
        }

        .submit-buttons .btn-success {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.85) 0%, rgba(129, 199, 132, 0.85) 100%);
            border: 1px solid rgba(76, 175, 80, 0.3);
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.2);
        }

        .submit-buttons .btn-success:hover {
            transform: translateY(-2px);
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.95) 0%, rgba(129, 199, 132, 0.95) 100%);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
        }

        [data-theme="light"] .submit-buttons .btn-success {
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.8) 0%, rgba(102, 187, 106, 0.8) 100%);
            border: 1px solid rgba(76, 175, 80, 0.4);
        }

        /* ========== NEUE FRONTEND-VERBESSERUNGEN ========== */

        /* 1. Smooth Scroll f√ºr die ganze Seite */
        html {
            scroll-behavior: smooth;
        }

        /* 2. Focus-Styles f√ºr bessere Accessibility */
        .form-control:focus,
        .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
            outline: none;
        }

        /* 3. Placeholder-Styling */
        .form-control::placeholder {
            color: var(--text-tertiary);
            opacity: 0.7;
        }

        /* 4. Subtle Animation f√ºr Labels */
        .form-group label {
            transition: color 0.2s ease;
        }

        .form-group:focus-within label {
            color: var(--primary);
        }

        /* 5. Info-Badge Styling */
        .info-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(147, 51, 234, 0.1) 100%);
            border-radius: 20px;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 16px;
        }

        [data-theme="light"] .info-badge {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(147, 51, 234, 0.08) 100%);
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        /* 6. Sch√∂nere Trennlinien zwischen Sections */
        .collapsible-section + .collapsible-section {
            margin-top: 20px;
        }

        /* 7. Micro-Interaction f√ºr Checkboxes */
        input[type="checkbox"] {
            cursor: pointer;
            transition: transform 0.15s ease;
        }

        input[type="checkbox"]:active {
            transform: scale(0.95);
        }

        /* 8. Better Radio Button Styling */
        input[type="radio"] {
            cursor: pointer;
            accent-color: var(--primary);
        }

        /* 9. Textarea mit besserem Resize */
        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        /* 10. Loading State f√ºr Buttons */
        .btn.loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .btn.loading::after {
            content: '';
            width: 16px;
            height: 16px;
            margin-left: 8px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            display: inline-block;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ========== SECTION-√úBERSCHRIFTEN ========== */
        .section-title {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-tertiary);
            margin-bottom: 12px;
            padding-left: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title::before {
            content: '';
            width: 3px;
            height: 14px;
            background: var(--section-color, var(--primary));
            border-radius: 2px;
        }

        /* Section-spezifische Farben */
        .section-title.kunde { --section-color: #2196F3; }
        .section-title.service { --section-color: #00BCD4; }
        .section-title.abholung { --section-color: #4CAF50; }
        .section-title.fahrzeug { --section-color: #FF9800; }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body {
                padding: var(--space-4) var(--space-3) 100px;
            }

            .form-container {
                padding: var(--space-6) var(--space-4);
            }

            .page-header {
                padding: var(--space-6) var(--space-4);
            }

            .photo-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* ============================================
           üíÄ PHASE 1: SKELETON LOADING STATES
           Apple-Style Shimmer Animation
           ============================================ */

        .skeleton {
            background: linear-gradient(
                90deg,
                rgba(255, 255, 255, 0.06) 0%,
                rgba(255, 255, 255, 0.15) 50%,
                rgba(255, 255, 255, 0.06) 100%
            );
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.5s ease-in-out infinite;
            border-radius: var(--radius-md);
        }

        [data-theme="light"] .skeleton {
            background: linear-gradient(
                90deg,
                rgba(0, 0, 0, 0.04) 0%,
                rgba(0, 0, 0, 0.08) 50%,
                rgba(0, 0, 0, 0.04) 100%
            );
            background-size: 200% 100%;
        }

        @keyframes skeleton-shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .form-container.is-loading .section-title,
        .form-container.is-loading .form-group label {
            color: transparent !important;
            background: linear-gradient(
                90deg,
                rgba(255, 255, 255, 0.06) 0%,
                rgba(255, 255, 255, 0.15) 50%,
                rgba(255, 255, 255, 0.06) 100%
            );
            background-size: 200% 100%;
            animation: skeleton-shimmer 1.5s ease-in-out infinite;
            border-radius: 4px;
        }

        /* ============================================
           üéØ PHASE 2: MICRO-INTERACTIONS
           3D Tilt, Glow Effects, Ripple Animation
           ============================================ */

        /* 3D Tilt Effect on Checkbox Cards */
        .checkbox-card {
            transform-style: preserve-3d;
            transform: perspective(1000px) rotateX(0deg) rotateY(0deg);
            transition: transform 0.15s ease-out, box-shadow 0.3s ease-out, background 0.3s ease-out, border-color 0.3s ease-out;
        }

        .checkbox-card.tilt-active {
            transition: transform 0.05s ease-out;
        }

        /* Enhanced Glow on Hover */
        .checkbox-card:hover {
            box-shadow:
                0 0 30px rgba(0, 191, 255, 0.2),
                0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .checkbox-card:has(input:checked) {
            box-shadow:
                0 0 40px rgba(0, 191, 255, 0.3),
                0 8px 25px rgba(0, 0, 0, 0.3);
        }

        /* Light Mode Glow Adjustments */
        [data-theme="light"] .checkbox-card:hover {
            box-shadow:
                0 0 25px rgba(0, 122, 255, 0.15),
                0 8px 20px rgba(0, 0, 0, 0.1);
        }

        /* Ripple Effect Container */
        .ripple-container {
            position: relative;
            overflow: hidden;
        }

        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
            transform: scale(0);
            animation: ripple-effect 0.6s ease-out forwards;
            pointer-events: none;
            z-index: 100;
        }

        [data-theme="light"] .ripple {
            background: rgba(0, 122, 255, 0.2);
        }

        @keyframes ripple-effect {
            0% { transform: scale(0); opacity: 1; }
            100% { transform: scale(4); opacity: 0; }
        }

        /* Button Enhanced Hover */
        .btn {
            position: relative;
            overflow: hidden;
        }

        .btn::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(
                circle at center,
                rgba(255, 255, 255, 0.3) 0%,
                transparent 60%
            );
            opacity: 0;
            transition: opacity 0.3s ease-out;
            pointer-events: none;
        }

        .btn:hover::after {
            opacity: 1;
        }

        /* Icon Hover Glow */
        .checkbox-card i,
        .form-container i {
            transition: filter 0.3s ease-out, transform 0.3s ease-out;
        }

        .checkbox-card:hover i {
            filter: drop-shadow(0 0 8px rgba(0, 191, 255, 0.6));
            transform: scale(1.1);
        }

        /* ============================================
           üé® PHASE 3: MODERN 2025 DESIGN
           Gradient Mesh, Noise Texture, Floating Elements
           ============================================ */

        .gradient-mesh {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -2;
            opacity: 0.4;
            pointer-events: none;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(0, 191, 255, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 30%, rgba(138, 43, 226, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 40% 80%, rgba(0, 255, 136, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 90% 90%, rgba(255, 107, 107, 0.08) 0%, transparent 50%);
            animation: mesh-drift 20s ease-in-out infinite;
        }

        [data-theme="light"] .gradient-mesh {
            opacity: 0.25;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(0, 122, 255, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 30%, rgba(88, 86, 214, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 40% 80%, rgba(52, 199, 89, 0.06) 0%, transparent 50%),
                radial-gradient(ellipse at 90% 90%, rgba(255, 149, 0, 0.06) 0%, transparent 50%);
        }

        @keyframes mesh-drift {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(2%, 1%) scale(1.02); }
            50% { transform: translate(-1%, 2%) scale(1); }
            75% { transform: translate(1%, -1%) scale(1.01); }
        }

        .noise-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9998;
            pointer-events: none;
            opacity: 0.03;
            mix-blend-mode: overlay;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }

        [data-theme="light"] .noise-overlay {
            opacity: 0.02;
            mix-blend-mode: multiply;
        }

        .floating-orb {
            position: fixed;
            border-radius: 50%;
            pointer-events: none;
            z-index: -1;
            filter: blur(60px);
        }

        .floating-orb--1 {
            width: 300px;
            height: 300px;
            background: rgba(0, 191, 255, 0.15);
            top: 10%;
            right: -5%;
            animation: orb-float-1 25s ease-in-out infinite;
        }

        .floating-orb--2 {
            width: 200px;
            height: 200px;
            background: rgba(138, 43, 226, 0.1);
            bottom: 20%;
            left: -5%;
            animation: orb-float-2 30s ease-in-out infinite;
        }

        .floating-orb--3 {
            width: 150px;
            height: 150px;
            background: rgba(0, 255, 136, 0.08);
            top: 50%;
            right: 10%;
            animation: orb-float-3 20s ease-in-out infinite;
        }

        [data-theme="light"] .floating-orb--1 { background: rgba(0, 122, 255, 0.08); }
        [data-theme="light"] .floating-orb--2 { background: rgba(88, 86, 214, 0.06); }
        [data-theme="light"] .floating-orb--3 { background: rgba(52, 199, 89, 0.05); }

        @keyframes orb-float-1 {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(-30px, 40px) scale(1.1); }
            66% { transform: translate(20px, -30px) scale(0.95); }
        }

        @keyframes orb-float-2 {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(40px, -20px) scale(1.05); }
            66% { transform: translate(-20px, 30px) scale(0.9); }
        }

        @keyframes orb-float-3 {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(-40px, 40px) scale(1.15); }
        }

        /* Enhanced Section Titles with Gradient */
        .section-title {
            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(0, 191, 255, 0.9) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        [data-theme="light"] .section-title {
            background: linear-gradient(135deg, rgba(30,30,30,0.95) 0%, rgba(0, 122, 255, 0.9) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* ============================================
           ‚òÄÔ∏è PHASE 4: LIGHT MODE OVERHAUL
           Neumorphism, Warm Colors, Better Contrast
           ============================================ */

        [data-theme="light"] body {
            background: linear-gradient(180deg, #fafbfc 0%, #f0f2f5 100%);
        }

        [data-theme="light"] .page-header {
            background: linear-gradient(145deg, #ffffff 0%, #f5f7fa 100%);
            border: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow:
                8px 8px 24px rgba(0, 0, 0, 0.08),
                -8px -8px 24px rgba(255, 255, 255, 0.9);
        }

        [data-theme="light"] .page-header h1 {
            color: #1a1a2e;
        }

        [data-theme="light"] .page-header p {
            color: #5a6678;
        }

        [data-theme="light"] .form-container {
            background: linear-gradient(145deg, #ffffff 0%, #f5f7fa 100%);
            border: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow:
                8px 8px 24px rgba(0, 0, 0, 0.08),
                -8px -8px 24px rgba(255, 255, 255, 0.9);
        }

        [data-theme="light"] .checkbox-card {
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid rgba(0, 0, 0, 0.08);
            box-shadow:
                4px 4px 12px rgba(0, 0, 0, 0.06),
                -4px -4px 12px rgba(255, 255, 255, 0.8);
        }

        [data-theme="light"] .checkbox-card:hover {
            border-color: rgba(0, 122, 255, 0.3);
            background: linear-gradient(145deg, #f0f8ff 0%, #e6f2ff 100%);
        }

        [data-theme="light"] .checkbox-card:has(input:checked) {
            background: linear-gradient(145deg, #e6f2ff 0%, #d9ecff 100%);
            border-color: rgba(0, 122, 255, 0.4);
        }

        [data-theme="light"] .form-group label {
            color: #3d4f63;
        }

        /* ============================================
           üåô DARK MODE FORM FIELDS (HOTFIX)
           Formularfelder im Dark Mode sichtbar machen
           ============================================ */

        .form-group input,
        .form-group select,
        .form-group textarea {
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid rgba(255, 255, 255, 0.15);
            color: var(--color-text-primary);
            border-radius: var(--radius-md);
            padding: var(--space-3) var(--space-4);
            font-size: var(--font-size-base);
            transition: all var(--duration-base) var(--ease-out);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(0, 191, 255, 0.2);
            outline: none;
            background: rgba(255, 255, 255, 0.12);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: var(--color-text-tertiary);
            opacity: 0.7;
        }

        .form-group select {
            cursor: pointer;
        }

        .form-group select option {
            background: var(--color-surface);
            color: var(--color-text-primary);
            padding: 8px;
        }

        .form-group label {
            color: var(--color-text-secondary);
            font-weight: var(--font-weight-medium);
            margin-bottom: var(--space-2);
            display: block;
        }

        /* ============================================
           ‚òÄÔ∏è LIGHT MODE FORM FIELDS (Override)
           ============================================ */

        [data-theme="light"] .form-group input,
        [data-theme="light"] .form-group select,
        [data-theme="light"] .form-group textarea {
            background: #f8f9fa;
            border: 1px solid #d0d0d0;
            color: #1a1a2e;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.04);
        }

        [data-theme="light"] .form-group select {
            /* No custom icon - use native dropdown */
        }

        [data-theme="light"] .form-group input:focus,
        [data-theme="light"] .form-group select:focus,
        [data-theme="light"] .form-group textarea:focus {
            background: #ffffff;
            border-color: #0066cc;
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.15), inset 0 1px 2px rgba(0, 0, 0, 0.02);
        }

        [data-theme="light"] .form-group input:hover,
        [data-theme="light"] .form-group select:hover,
        [data-theme="light"] .form-group textarea:hover {
            border-color: #b0b0b0;
            background: #fcfcfc;
        }

        /* ============================================
           üêõ HOTFIX #2: Weitere Dark Mode Dropdown Fixes
           Selects au√üerhalb von .form-group
           ============================================ */

        /* Fix #1: Baujahr Selects (keine .form-group Wrapper) */
        #baujahrVon, #baujahrBis {
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid rgba(255, 255, 255, 0.15);
            color: var(--color-text-primary);
            border-radius: var(--radius-md);
            padding: var(--space-3) var(--space-4);
            cursor: pointer;
        }

        [data-theme="light"] #baujahrVon,
        [data-theme="light"] #baujahrBis {
            background: #ffffff;
            border: 2px solid rgba(0, 0, 0, 0.1);
            color: #1a1a2e;
        }

        #baujahrVon option, #baujahrBis option {
            background: var(--color-surface);
            color: var(--color-text-primary);
        }

        /* Fix #2: MwSt Select (nutzt form-input statt form-select) */
        select.form-input,
        #mwstSatz {
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid rgba(255, 255, 255, 0.15);
            color: var(--color-text-primary);
            border-radius: var(--radius-md);
            padding: var(--space-3) var(--space-4);
            cursor: pointer;
        }

        [data-theme="light"] select.form-input,
        [data-theme="light"] #mwstSatz {
            background: #ffffff;
            border: 2px solid rgba(0, 0, 0, 0.1);
            color: #1a1a2e;
        }

        select.form-input option,
        #mwstSatz option {
            background: var(--color-surface);
            color: var(--color-text-primary);
        }

        /* Fix #3: Tabellen Selects (Materialien, Ersatzteile) */
        table select,
        .ersatzteile-table select,
        .materialien-table select {
            background: rgba(255, 255, 255, 0.08) !important;
            border: 1px solid rgba(255, 255, 255, 0.15) !important;
            color: var(--color-text-primary) !important;
            border-radius: 4px;
            padding: 4px 8px;
        }

        [data-theme="light"] table select,
        [data-theme="light"] .ersatzteile-table select,
        [data-theme="light"] .materialien-table select {
            background: #ffffff !important;
            border: 1px solid rgba(0, 0, 0, 0.1) !important;
            color: #1a1a2e !important;
        }

        table select option,
        .ersatzteile-table select option,
        .materialien-table select option {
            background: var(--color-surface);
            color: var(--color-text-primary);
        }

        [data-theme="light"] .btn-primary {
            background: linear-gradient(135deg, #0066cc 0%, #0052a3 100%);
            box-shadow: 0 4px 16px rgba(0, 102, 204, 0.3);
        }

        [data-theme="light"] .btn-primary:hover {
            box-shadow: 0 8px 24px rgba(0, 102, 204, 0.4);
        }

        /* ============================================
           üì± PHASE 5: MOBILE POLISH
           Enhanced Touch, Smooth Scroll, Scroll Animations
           ============================================ */

        html {
            scroll-behavior: smooth;
        }

        @media (hover: none) and (pointer: coarse) {
            .checkbox-card:active {
                transform: scale(0.97) !important;
                transition: transform 0.1s ease-out !important;
            }

            .btn:active {
                transform: scale(0.96) !important;
            }

            * {
                -webkit-tap-highlight-color: transparent;
            }

            .checkbox-card {
                transform: none !important;
            }

            .checkbox-card.tilt-active {
                transform: none !important;
            }
        }

        .scroll-animate {
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }

        .scroll-animate.is-visible {
            opacity: 1;
            transform: translateY(0);
        }

        @media (max-width: 768px) {
            .floating-orb { opacity: 0.5; }
            .noise-overlay { opacity: 0.015; }
            .scroll-animate { transition-duration: 0.4s; }
        }

        /* ============================================
           ‚ôø BARRIEREFREIHEIT - Reduced Motion
           ============================================ */

        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }

            .gradient-mesh, .floating-orb, .noise-overlay {
                animation: none;
            }

            .skeleton { animation: none; }
        }

        /* ============================================
           üîô ZUR√úCK-BUTTON (Fixed Position)
           ============================================ */
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-4);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-primary);
            font-weight: 500;
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(-2px);
            border-color: var(--color-primary);
        }

        .back-button svg {
            width: 18px;
            height: 18px;
        }

        [data-theme="light"] .back-button {
            background: rgba(255, 255, 255, 0.8);
            border-color: rgba(0, 0, 0, 0.1);
            color: #1a1a2e;
        }

        [data-theme="light"] .back-button:hover {
            background: rgba(255, 255, 255, 0.95);
            border-color: var(--color-primary);
        }

        @media (max-width: 768px) {
            .back-button {
                top: 10px;
                left: 10px;
                padding: var(--space-2);
            }

            .back-button span {
                display: none;
            }
        }
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

    <!-- Firebase Konfiguration -->
    <script src="firebase-config.js?v=a4192c4"></script>

    <!-- Auth Manager f√ºr Multi-Tenant Support -->
    <script src="js/auth-manager.js"></script>
    <script src="js/settings-manager.js"></script>
    <script src="js/permissions-helper.js"></script>

    <!-- Listener Registry (must load early!) -->
    <script src="listener-registry.js?v=6020c9e"></script>

    <!-- Image Optimizer -->
    <script src="image-optimizer.js"></script>

    <!-- AGI Training: Damage Labeling System (2025-12-11) -->
    <script src="js/damage-codes.js?v=agi-phase1"></script>
    <script src="js/damage-labeler.js?v=agi-phase1"></script>

    <!-- Global Chat Notifications -->
    <link rel="stylesheet" href="global-chat-notifications.css">
    <script src="global-chat-notifications.js"></script>

    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>
</head>
<body class="has-ai-features">
    <!-- üé® Modern 2025 Background Effects -->
    <div class="gradient-mesh" aria-hidden="true"></div>
    <div class="noise-overlay" aria-hidden="true"></div>
    <div class="floating-orb floating-orb--1" aria-hidden="true"></div>
    <div class="floating-orb floating-orb--2" aria-hidden="true"></div>
    <div class="floating-orb floating-orb--3" aria-hidden="true"></div>

    <!-- üîô ZUR√úCK-BUTTON -->
    <button class="back-button" onclick="history.back()" title="Zur√ºck">
        <span>‚Üê Zur√ºck</span>
    </button>

    <!-- THEME TOGGLE BUTTON -->
    <button id="themeToggle" class="theme-toggle" aria-label="Toggle Light/Dark Mode">
        <span class="theme-toggle__icon theme-toggle__icon--light">‚òÄÔ∏è</span>
        <span class="theme-toggle__icon theme-toggle__icon--dark">üåô</span>
    </button>

    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <div id="werkstattLogo" style="margin-bottom: 12px;"></div>
            <h1>Fahrzeug-Annahme</h1>
            <p id="werkstattName">Auto-Lackierzentrum Mosbach</p>
        </div>

        <div class="date-display">
            Datum: <strong id="currentDate"></strong>
        </div>

        <div class="success-message" id="successMessage">
            ‚úÖ Fahrzeug erfolgreich aufgenommen!
        </div>

        <div class="info-box">
            <div class="info-box-content">
                <strong>Tipp:</strong>
                <p>Je mehr Angaben Sie machen, desto schneller und pr√§ziser kann der Kostenvoranschlag erstellt werden!</p>
            </div>
        </div>

        <!-- Form -->
        <form id="annahmeForm">
            <div class="form-container">
                <!-- KUNDE Section-√úberschrift -->
                <div class="section-title kunde">Kunde</div>

                <!-- KUNDENDATEN (Collapsible - Phase 2 UX) -->
                <div class="collapsible-section is-open" id="kunden-collapsible">
                    <div class="collapsible-header" onclick="toggleCollapsible('kunden-collapsible')">
                        <div class="collapsible-header-left">
                            <span class="collapsible-header-title">Kunde & Auftrag</span>
                        </div>
                    </div>
                    <div class="collapsible-content">
                        <div class="collapsible-content-inner">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="kennzeichen" class="form-label">Kennzeichen <span class="required">*</span></label>
                                    <input type="text" id="kennzeichen" class="form-input" placeholder="z.B. MOS-CG 123" required style="text-transform: uppercase;">
                                    <!-- Neuwagen ohne Kennzeichen Option (2026-01-08) -->
                                    <div style="margin-top: var(--space-2); display: flex; align-items: center; gap: var(--space-2);">
                                        <input type="checkbox" id="neuwagenOhneKennzeichen" onchange="handleNeuwagenCheckbox()">
                                        <label for="neuwagenOhneKennzeichen" style="font-size: 0.85rem; color: var(--color-text-secondary); cursor: pointer; margin: 0;">
                                            Neuwagen ohne Kennzeichen
                                        </label>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Bestandskunde?</label>
                                    <select id="kundenDropdown" class="form-select" onchange="selectKunde()">
                                        <option value="">Neuer Kunde</option>
                                        <!-- Dynamisch gef√ºllt -->
                                    </select>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="kundenname" class="form-label">Name <span class="required">*</span></label>
                                <input type="text" id="kundenname" class="form-input" placeholder="Max Mustermann" required>
                            </div>

                            <div class="form-group">
                                <label for="kundenEmail" class="form-label">E-Mail <span class="required">*</span></label>
                                <input type="email" id="kundenEmail" class="form-input" placeholder="kunde@beispiel.de" required>
                                <small style="color: var(--color-text-tertiary); display: block; margin-top: var(--space-1);">
                                    F√ºr Status-Updates und Abholung-Benachrichtigung
                                </small>
                            </div>

                            <div class="form-group">
                                <label for="telefon" class="form-label">Telefon <span style="color: var(--color-text-tertiary); font-weight: normal;">(optional)</span></label>
                                <input type="tel" id="telefon" class="form-input" placeholder="06261 123456">
                            </div>

                            <!-- Fertig bis: Wird in entwuerfe-bearbeiten.html gesetzt -->
                            <div class="form-group" style="display: none;">
                                <label for="geplantesAbnahmeDatum" class="form-label">Fertig bis</label>
                                <input type="date" id="geplantesAbnahmeDatum" class="form-input">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SERVICE Section-√úberschrift -->
                <div class="section-title service">Service</div>

                <!-- üéØ SERVICE-AUSWAHL (Collapsible - Phase 2 UX) -->
                <div class="collapsible-section is-open" id="service-collapsible">
                    <div class="collapsible-header" onclick="toggleCollapsible('service-collapsible')">
                        <div class="collapsible-header-left">
                            <span class="collapsible-header-title">Service-Auswahl</span>
                            <span class="collapsible-header-hint">Pflichtfeld</span>
                        </div>
                    </div>
                    <div class="collapsible-content">
                        <div class="collapsible-content-inner">
                            <div class="form-group" style="margin-bottom: 0;">
                                <label for="serviceTyp" class="form-label">Welcher Service? <span class="required">*</span></label>
                                <select id="serviceTyp" class="form-select" required>
                                    <option value="">‚Äî Bitte w√§hlen ‚Äî</option>
                                    <option value="lackier">üé® Lackierung</option>
                                    <option value="reifen">üõû Reifen-Service</option>
                                    <option value="mechanik">üîß Mechanik</option>
                                    <option value="pflege">‚ú® Pflege & Aufbereitung</option>
                                    <option value="tuev">üìã T√úV / HU</option>
                                    <option value="versicherung">üõ°Ô∏è Versicherungsschaden</option>
                                    <option value="glas">ü™ü Glas-Reparatur</option>
                                    <option value="klima">‚ùÑÔ∏è Klima-Service</option>
                                    <option value="dellen">üî® Dellendr√ºcken</option>
                                    <option value="folierung">üé≠ Folierung</option>
                                    <option value="steinschutz">üíé Steinschutzfolie</option>
                                    <option value="werbebeklebung">üìù Fahrzeugbeschriftung</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- üÜï MULTI-SERVICE FEATURE: Zus√§tzliche Services (Collapsible - Phase 2 UX) -->
                <div class="collapsible-section" id="zusatz-services-collapsible">
                    <div class="collapsible-header" onclick="toggleCollapsible('zusatz-services-collapsible')">
                        <div class="collapsible-header-left">
                            <span class="collapsible-header-title">Zus√§tzliche Services</span>
                            <span class="collapsible-header-hint">Optional</span>
                        </div>
                    </div>
                    <div class="collapsible-content">
                        <div class="collapsible-content-inner">
                            <div id="zusaetzliche-services-container" class="form-group" style="padding: 0; background: transparent; border: none;">
                                <small style="color: var(--color-text-secondary); display: block; margin-bottom: var(--space-4);">
                                    Mehrere Services gleichzeitig buchen
                                </small>

                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--space-3);">
                                    <!-- Checkboxen werden dynamisch basierend auf Haupt-Service generiert -->
                                    <label class="checkbox-card" data-service="lackier">
                                        <input type="checkbox" value="lackier" class="additional-service-checkbox">
                                        <span class="checkbox-label">Lackierung</span>
                                    </label>
                                    <label class="checkbox-card" data-service="reifen">
                                        <input type="checkbox" value="reifen" class="additional-service-checkbox">
                                        <span class="checkbox-label">Reifen-Service</span>
                                    </label>
                                    <label class="checkbox-card" data-service="mechanik">
                                        <input type="checkbox" value="mechanik" class="additional-service-checkbox">
                                        <span class="checkbox-label">Mechanik</span>
                                    </label>
                                    <label class="checkbox-card" data-service="pflege">
                                        <input type="checkbox" value="pflege" class="additional-service-checkbox">
                                        <span class="checkbox-label">Pflege & Aufbereitung</span>
                                    </label>
                                    <label class="checkbox-card" data-service="tuev">
                                        <input type="checkbox" value="tuev" class="additional-service-checkbox">
                                        <span class="checkbox-label">T√úV / HU</span>
                                    </label>
                                    <label class="checkbox-card" data-service="versicherung">
                                        <input type="checkbox" value="versicherung" class="additional-service-checkbox">
                                        <span class="checkbox-label">Versicherungsschaden</span>
                                    </label>
                                    <label class="checkbox-card" data-service="glas">
                                        <input type="checkbox" value="glas" class="additional-service-checkbox">
                                        <span class="checkbox-label">Glas-Reparatur</span>
                                    </label>
                                    <label class="checkbox-card" data-service="klima">
                                        <input type="checkbox" value="klima" class="additional-service-checkbox">
                                        <span class="checkbox-label">Klima-Service</span>
                                    </label>
                                    <label class="checkbox-card" data-service="dellen">
                                        <input type="checkbox" value="dellen" class="additional-service-checkbox">
                                        <span class="checkbox-label">Dellendr√ºcken</span>
                                    </label>
                                    <label class="checkbox-card" data-service="folierung">
                                        <input type="checkbox" value="folierung" class="additional-service-checkbox">
                                        <span class="checkbox-label">Folierung</span>
                                    </label>
                                    <label class="checkbox-card" data-service="steinschutz">
                                        <input type="checkbox" value="steinschutz" class="additional-service-checkbox">
                                        <span class="checkbox-label">Steinschutzfolie</span>
                                    </label>
                                    <label class="checkbox-card" data-service="werbebeklebung">
                                        <input type="checkbox" value="werbebeklebung" class="additional-service-checkbox">
                                        <span class="checkbox-label">Fahrzeugbeschriftung</span>
                                    </label>
                                </div>

                                <style>
                                    .checkbox-card {
                                        display: flex;
                                        align-items: center;
                                        gap: var(--space-2);
                                        padding: var(--space-3);
                                        background: var(--color-surface);
                                        border: 2px solid var(--color-border);
                                        border-radius: var(--radius-md);
                                        cursor: pointer;
                                        transition: all var(--duration-base) var(--ease-out);
                                    }

                                    .checkbox-card:hover {
                                        border-color: var(--color-primary);
                                        transform: translateY(-2px);
                                        box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);
                                    }

                                    .checkbox-card input[type="checkbox"] {
                                        width: 20px;
                                        height: 20px;
                                        cursor: pointer;
                                    }

                                    .checkbox-card input[type="checkbox"]:checked + .checkbox-label {
                                        font-weight: var(--font-weight-semibold);
                                        color: var(--color-primary);
                                    }

                                    .checkbox-card.disabled {
                                        opacity: 0.5;
                                        cursor: not-allowed;
                                        pointer-events: none;
                                    }

                                    .checkbox-label {
                                        font-size: var(--font-size-sm);
                                        color: var(--color-text-primary);
                                    }
                                </style>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ‚ú® SERVICE-SPEZIFISCHE FELDER (dynamisch angezeigt) -->

                <!-- Reifen-Service Felder -->
                <div id="reifen-felder" class="service-felder" style="display:none;">
                    <div class="section-title" style="margin-top: var(--space-4);">
                        Reifen-Service Details
                    </div>

                    <div class="form-group">
                        <label for="reifengroesse" class="form-label">Reifengr√∂√üe</label>
                        <input type="text" id="reifengroesse" class="form-input" placeholder="z.B. 205/55 R16 91V">
                        <small style="color: var(--color-text-tertiary);">Format: Breite/H√∂he Durchmesser Lastindex</small>
                    </div>

                    <div class="form-group">
                        <label for="reifentyp" class="form-label">Reifen-Typ</label>
                        <select id="reifentyp" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="sommer">Sommerreifen</option>
                            <option value="winter">Winterreifen</option>
                            <option value="ganzjahr">Ganzjahresreifen</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="reifenanzahl" class="form-label">Anzahl Reifen</label>
                        <input type="number" id="reifenanzahl" class="form-input" min="1" max="4" value="4">
                    </div>
                </div>

                <!-- Glas-Reparatur Felder -->
                <div id="glas-felder" class="service-felder" style="display:none;">
                    <div class="section-title" style="margin-top: var(--space-4);">
                        Glas-Reparatur Details
                    </div>

                    <div class="form-group">
                        <label for="scheibentyp" class="form-label">Scheiben-Typ</label>
                        <select id="scheibentyp" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="frontscheibe">Frontscheibe</option>
                            <option value="seitenscheibe-vorne-links">Seitenscheibe vorne links</option>
                            <option value="seitenscheibe-vorne-rechts">Seitenscheibe vorne rechts</option>
                            <option value="seitenscheibe-hinten-links">Seitenscheibe hinten links</option>
                            <option value="seitenscheibe-hinten-rechts">Seitenscheibe hinten rechts</option>
                            <option value="heckscheibe">Heckscheibe</option>
                            <option value="schiebedach">Schiebedach</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="schadensgroesse" class="form-label">Schadens-Gr√∂√üe</label>
                        <select id="schadensgroesse" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="steinschlag">Steinschlag (< 2cm) - Reparatur m√∂glich</option>
                            <option value="riss-klein">Kleiner Riss (2-5cm) - Reparatur m√∂glich</option>
                            <option value="riss-mittel">Mittlerer Riss (5-10cm) - Austausch empfohlen</option>
                            <option value="riss-gross">Gro√üer Riss/Bruch (> 10cm) - Austausch n√∂tig</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="glasposition" class="form-label">Position des Schadens</label>
                        <input type="text" id="glasposition" class="form-input" placeholder="z.B. Fahrerseite Mitte, Beifahrerseite oben links">
                    </div>
                </div>

                <!-- Klima-Service Felder -->
                <div id="klima-felder" class="service-felder" style="display:none;">
                    <div class="section-title" style="margin-top: var(--space-4);">
                        Klima-Service Details
                    </div>

                    <div class="form-group">
                        <label for="klimaservice" class="form-label">Service-Art</label>
                        <select id="klimaservice" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="wartung">Wartung & Desinfektion</option>
                            <option value="fuellen">K√§ltemittel auff√ºllen</option>
                            <option value="reparatur">Reparatur (Leckage)</option>
                            <option value="komplett">Kompletter Service-Check</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="kaeltemittel" class="form-label">K√§ltemittel-Typ</label>
                        <select id="kaeltemittel" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="r134a">R134a (Fahrzeuge √§lter 2017)</option>
                            <option value="r1234yf">R1234yf (Fahrzeuge ab 2017)</option>
                            <option value="unbekannt">Unbekannt / Nicht sicher</option>
                        </select>
                        <small style="color: var(--color-text-tertiary);">Ab Erstzulassung 2017 meist R1234yf</small>
                    </div>

                    <div class="form-group">
                        <label for="klimaproblem" class="form-label">Beschreibung des Problems</label>
                        <textarea id="klimaproblem" class="form-input" rows="3" placeholder="z.B. Klimaanlage k√ºhlt nicht mehr, unangenehmer Geruch, Ger√§usche beim Einschalten"></textarea>
                    </div>
                </div>

                <!-- Dellen-Dr√ºckung Felder -->
                <div id="dellen-felder" class="service-felder" style="display:none;">
                    <div class="section-title" style="margin-top: var(--space-4);">
                        Dellen-Dr√ºckung Details
                    </div>

                    <div class="form-group">
                        <label for="dellenanzahl" class="form-label">Anzahl Dellen</label>
                        <input type="number" id="dellenanzahl" class="form-input" min="1" max="20" value="1">
                    </div>

                    <div class="form-group">
                        <label for="dellengroesse" class="form-label">Gr√∂√üte Delle</label>
                        <select id="dellengroesse" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="klein">Klein (< 5cm Durchmesser)</option>
                            <option value="mittel">Mittel (5-10cm Durchmesser)</option>
                            <option value="gross">Gro√ü (> 10cm Durchmesser)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="lackschaden" class="form-label">Lackschaden vorhanden?</label>
                        <select id="lackschaden" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="nein">Nein (nur Delle)</option>
                            <option value="ja">Ja (Delle + Lackschaden)</option>
                        </select>
                        <small style="color: var(--color-text-tertiary);">Bei Lackschaden ist zus√§tzliche Lackierung n√∂tig</small>
                    </div>

                    <div class="form-group">
                        <label for="dellenpositionen" class="form-label">Position(en) der Dellen</label>
                        <textarea id="dellenpositionen" class="form-input" rows="3" placeholder="z.B. Fahrert√ºr Mitte, Kotfl√ºgel rechts, Motorhaube links vorne"></textarea>
                    </div>
                </div>

                <!-- Mechanik-Service Felder -->
                <div id="mechanik-felder" class="service-felder" style="display:none;">
                    <div class="section-title" style="margin-top: var(--space-4);">
                        Mechanik-Service Details
                    </div>

                    <div class="form-group">
                        <label for="mechanik-problem" class="form-label">Problembeschreibung</label>
                        <textarea id="mechanik-problem" class="form-input" rows="4" placeholder="z.B. Motor ruckelt, Bremsen quietschen, Lenkung schwerg√§ngig, Warnleuchte leuchtet..."></textarea>
                        <small style="color: var(--color-text-tertiary);">Bitte so detailliert wie m√∂glich beschreiben</small>
                    </div>

                    <div class="form-group">
                        <label for="mechanik-symptome" class="form-label">Symptome / Wann tritt das Problem auf?</label>
                        <input type="text" id="mechanik-symptome" class="form-input" placeholder="z.B. nur beim Kaltstart, bei hoher Geschwindigkeit, beim Bremsen">
                    </div>
                </div>

                <!-- Versicherung-Service Felder -->
                <div id="versicherung-felder" class="service-felder" style="display:none;">
                    <div class="section-title" style="margin-top: var(--space-4);">
                        Versicherungsschaden Details
                    </div>

                    <div class="form-group">
                        <label for="versicherung-schadensnummer" class="form-label">Schadennummer</label>
                        <input type="text" id="versicherung-schadensnummer" class="form-input" placeholder="z.B. SCH-2024-123456">
                        <small style="color: var(--color-text-tertiary);">Von der Versicherung erhalten</small>
                    </div>

                    <div class="form-group">
                        <label for="versicherung-name" class="form-label">Versicherung</label>
                        <input type="text" id="versicherung-name" class="form-input" placeholder="z.B. Allianz, HUK, Ergo">
                    </div>

                    <div class="form-group">
                        <label for="versicherung-schadendatum" class="form-label">Schadendatum</label>
                        <input type="date" id="versicherung-schadendatum" class="form-input">
                    </div>

                    <div class="form-group">
                        <label for="versicherung-hergang" class="form-label">Unfallhergang / Schadenursache</label>
                        <textarea id="versicherung-hergang" class="form-input" rows="3" placeholder="z.B. Auffahrunfall, Parkrempler, Wildschaden, Hagel..."></textarea>
                    </div>
                </div>

                <!-- Pflege-Service Felder -->
                <div id="pflege-felder" class="service-felder" style="display:none;">
                    <div class="section-title" style="margin-top: var(--space-4);">
                        Fahrzeugpflege Details
                    </div>

                    <div class="form-group">
                        <label for="pflege-paket" class="form-label">Pflege-Paket</label>
                        <select id="pflege-paket" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="basis">Basis (Au√üenw√§sche + Staubsaugen)</option>
                            <option value="premium">Premium (Basis + Innenraumreinigung + Politur)</option>
                            <option value="deluxe">Deluxe (Premium + Motorw√§sche + Unterbodenw√§sche + Versiegelung)</option>
                            <option value="aufbereitung">Komplett-Aufbereitung (Deluxe + Polsterreinigung + Lederpflege)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="pflege-zusatz" class="form-label">Zusatzleistungen</label>
                        <textarea id="pflege-zusatz" class="form-input" rows="2" placeholder="z.B. Polsterreinigung, Lederpflege, Geruchsneutralisierung, Scheinwerfer-Aufbereitung"></textarea>
                    </div>
                </div>

                <!-- T√úV-Service Felder -->
                <div id="tuev-felder" class="service-felder" style="display:none;">
                    <div class="section-title" style="margin-top: var(--space-4);">
                        T√úV/AU Details
                    </div>

                    <div class="form-group">
                        <label for="tuev-pruefart" class="form-label">Pr√ºfart</label>
                        <select id="tuev-pruefart" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="hu">HU (Hauptuntersuchung)</option>
                            <option value="au">AU (Abgasuntersuchung)</option>
                            <option value="hu-au">HU + AU (Kombi)</option>
                            <option value="nachpruefung">Nachpr√ºfung</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="tuev-faelligkeit" class="form-label">F√§lligkeit T√úV</label>
                        <input type="month" id="tuev-faelligkeit" class="form-input">
                        <small style="color: var(--color-text-tertiary);">Steht im Fahrzeugschein und auf T√úV-Plakette</small>
                    </div>

                    <div class="form-group">
                        <label for="tuev-maengel" class="form-label">Bekannte M√§ngel (optional)</label>
                        <textarea id="tuev-maengel" class="form-input" rows="2" placeholder="z.B. Beleuchtung defekt, Reifen abgefahren, Rost am Schweller"></textarea>
                    </div>
                </div>

                <!-- Auto Folierung Felder -->
                <div id="folierung-felder" class="service-felder" style="display:none;">
                    <div class="section-title" style="margin-top: var(--space-4);">
                        Auto Folierung Details
                    </div>

                    <div class="form-group">
                        <label for="folierungArt" class="form-label">Art der Folierung <span class="required">*</span></label>
                        <select id="folierungArt" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="vollfolierung">üé® Vollfolierung (gesamtes Fahrzeug)</option>
                            <option value="teilfolierung">‚úÇÔ∏è Teilfolierung (bestimmte Teile)</option>
                            <option value="akzente">‚≠ê Akzente (Streifen, Logos)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="folierungMaterial" class="form-label">Materialqualit√§t <span class="required">*</span></label>
                        <select id="folierungMaterial" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="standard">üì¶ Standard (3-5 Jahre)</option>
                            <option value="premium">üíé Premium (5-7 Jahre)</option>
                            <option value="spezial">üåü Spezialfolie (Chrome, Carbon, Matt)</option>
                        </select>
                    </div>

                    <!-- Spezialfolientyp (nur wenn Material = 'spezial') -->
                    <div class="form-group" id="folierungSpezialTypGroup" style="display: none;">
                        <label for="folierungSpezialTyp" class="form-label">Spezialfolientyp <span class="required">*</span></label>
                        <select id="folierungSpezialTyp" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="chrome">‚ú® Chrome</option>
                            <option value="matt">üé≠ Matt</option>
                            <option value="hochglanz">üíé Hochglanz</option>
                            <option value="carbon">üèÅ Carbon</option>
                            <option value="brushed-metal">üîß Brushed Metal</option>
                        </select>
                    </div>

                    <!-- Bereiche (nur wenn Art != 'vollfolierung') -->
                    <div class="form-group" id="folierungBereicheGroup" style="display: none;">
                        <label class="form-label">Zu folierende Bereiche <span class="required">*</span></label>
                        <div class="checkbox-group" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="folierungBereiche" value="motorhaube"> Motorhaube
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="folierungBereiche" value="dach"> Dach
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="folierungBereiche" value="seitenspiegel"> Seitenspiegel
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="folierungBereiche" value="heckklappe"> Heckklappe
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="folierungBereiche" value="kotfluegel"> Kotfl√ºgel
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="folierungBereiche" value="spoiler"> Spoiler
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="folierungBereiche" value="tueren"> T√ºren
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" name="folierungBereiche" value="seitenwand"> Seitenwand
                            </label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="folierungFarbe" class="form-label">Farbauswahl <span class="required">*</span></label>
                        <input type="text" id="folierungFarbe" class="form-input" placeholder="z.B. Schwarz Matt, Blau Metallic, Rot Hochglanz">
                    </div>

                    <div class="form-group">
                        <label for="folierungDesign" class="form-label">Design-Vorstellungen</label>
                        <textarea id="folierungDesign" class="form-input" rows="3" placeholder="Muster, Streifen, Logos, etc."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="folierungInfo" class="form-label">Zus√§tzliche Informationen</label>
                        <textarea id="folierungInfo" class="form-input" rows="2" placeholder="Besondere Anforderungen, Zeitrahmen..."></textarea>
                    </div>
                </div>

                <!-- Steinschutzfolie Felder -->
                <div id="steinschutz-felder" class="service-felder" style="display:none;">
                    <div class="section-title" style="margin-top: var(--space-4);">
                        Steinschutzfolie Details
                    </div>

                    <div class="form-group">
                        <label for="steinschutzUmfang" class="form-label">Schutzumfang <span class="required">*</span></label>
                        <select id="steinschutzUmfang" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="premium">üõ°Ô∏è Premium-Paket (Komplettschutz)</option>
                            <option value="standard">üì¶ Standard-Paket (Front, Motorhaube, Spiegel)</option>
                            <option value="minimal">‚ö° Minimal-Paket (nur Front)</option>
                            <option value="individuell">üéØ Individuell (Bereiche ausw√§hlen)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="steinschutzMaterial" class="form-label">Materialqualit√§t <span class="required">*</span></label>
                        <select id="steinschutzMaterial" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="standard">üì¶ Standard PPF (5 Jahre)</option>
                            <option value="premium">üíé Premium PPF (7 Jahre)</option>
                            <option value="self-healing">üîÑ Self-Healing (10 Jahre)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="steinschutzBereiche" class="form-label">Zu sch√ºtzende Bereiche</label>
                        <textarea id="steinschutzBereiche" class="form-input" rows="2" placeholder="z.B. Front-Sto√üstange, Motorhaube, Kotfl√ºgel, Spiegel..."></textarea>
                        <small style="color: var(--color-text-tertiary);">Nur bei individueller Auswahl</small>
                    </div>

                    <div class="form-group">
                        <label for="steinschutzInfo" class="form-label">Zus√§tzliche Informationen</label>
                        <textarea id="steinschutzInfo" class="form-input" rows="2" placeholder="Besondere Anforderungen, vorhandene Lacksch√§den..."></textarea>
                    </div>
                </div>

                <!-- Fahrzeugbeschriftung Felder -->
                <div id="werbebeklebung-felder" class="service-felder" style="display:none;">
                    <div class="section-title" style="margin-top: var(--space-4);">
                        Fahrzeugbeschriftung Details
                    </div>

                    <div class="form-group">
                        <label for="werbebeklebungUmfang" class="form-label">Umfang der Beklebung <span class="required">*</span></label>
                        <select id="werbebeklebungUmfang" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="vollbeklebung">üöö Vollbeklebung (alle Seiten)</option>
                            <option value="teilbeklebung">‚úÇÔ∏è Teilbeklebung (bestimmte Bereiche)</option>
                            <option value="logo-only">üè∑Ô∏è Nur Logo</option>
                            <option value="schriftzug">‚úçÔ∏è Schriftzug</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="werbebeklebungKomplexitaet" class="form-label">Design-Komplexit√§t <span class="required">*</span></label>
                        <select id="werbebeklebungKomplexitaet" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="einfach">üìù Einfach (Text + Logo, 1-2 Farben)</option>
                            <option value="mittel">üé® Mittel (Logo + Text + Grafiken, 3-5 Farben)</option>
                            <option value="komplex">üåà Komplex (Vollfl√§chiges Design, 6+ Farben)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="werbebeklebungText" class="form-label">Textelemente <span class="required">*</span></label>
                        <textarea id="werbebeklebungText" class="form-input" rows="3" placeholder="Firmenname, Slogan, Kontaktdaten (Telefon, Website, E-Mail)..."></textarea>
                        <small style="color: var(--color-text-tertiary);">Alle Texte, die auf dem Fahrzeug erscheinen sollen</small>
                    </div>

                    <div class="form-group">
                        <label for="werbebeklebungFarbanzahl" class="form-label">Anzahl Farben</label>
                        <input type="number" id="werbebeklebungFarbanzahl" class="form-input" min="1" max="10" value="2" placeholder="Anzahl der verwendeten Farben">
                    </div>

                    <div class="form-group">
                        <label for="werbebeklebungInfo" class="form-label">Zus√§tzliche Informationen</label>
                        <textarea id="werbebeklebungInfo" class="form-input" rows="2" placeholder="Besondere W√ºnsche, Zeitrahmen, Referenzbilder..."></textarea>
                    </div>
                </div>

                <!-- ABHOLUNG Section-√úberschrift -->
                <div class="section-title abholung">Abholung</div>

                <!-- ABHOLUNG (Collapsible) -->
                <div class="collapsible-section" id="abholung-collapsible">
                    <div class="collapsible-header" onclick="toggleCollapsible('abholung-collapsible')">
                        <div class="collapsible-header-left">
                            <span class="collapsible-header-title">Abholung & Extras</span>
                            <span class="collapsible-header-hint">Optional</span>
                        </div>
                    </div>
                    <div class="collapsible-content">
                        <div class="collapsible-content-inner">
                            <div class="form-group">
                                <label class="form-label">Fahrzeug abholen?</label>
                                <div class="radio-group">
                                    <label>
                                        <input type="radio" name="fahrzeugAbholung" value="nein" checked onchange="toggleAbholungDetails()">
                                        <span>Nein, Kunde bringt Fahrzeug</span>
                                    </label>
                                    <label>
                                        <input type="radio" name="fahrzeugAbholung" value="ja" onchange="toggleAbholungDetails()">
                                        <span>Ja, abholen</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Conditional Fields -->
                            <div id="abholungDetails" style="display: none;">
                                <div class="form-group">
                                    <label for="abholadresse" class="form-label">Abholadresse <span class="required">*</span></label>
                                    <textarea id="abholadresse" class="form-textarea" placeholder="Stra√üe, Hausnummer&#10;PLZ Ort" rows="3"></textarea>
                                </div>

                                <!-- Wann/Uhrzeit: Wird in Tagesplanung gesetzt -->
                                <div class="form-row" style="display: none;">
                                    <div class="form-group">
                                        <label for="abholdatum" class="form-label">Wann?</label>
                                        <input type="date" id="abholdatum" class="form-input">
                                    </div>

                                    <div class="form-group">
                                        <label for="abholzeit" class="form-label">Uhrzeit</label>
                                        <input type="time" id="abholzeit" class="form-input">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="abholnotiz" class="form-label">Hinweis <span style="color: var(--color-text-tertiary); font-weight: normal;">(optional)</span></label>
                                    <textarea id="abholnotiz" class="form-textarea" placeholder="Zufahrt, Ansprechpartner..." rows="2"></textarea>
                                </div>
                            </div>

                            <div class="form-group" style="margin-top: var(--space-4);">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="ersatzfahrzeugGewuenscht" name="ersatzfahrzeugGewuenscht">
                                    <span>Ersatzfahrzeug ben√∂tigt</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- üîß ENTFERNT (2025-11-27): √úbergabeadresse war redundant mit Abholadresse -->
                <!-- Ersatzfahrzeug-√úbergabe = Abholadresse (wenn Abholung) oder Werkstatt -->

                <!-- FAHRZEUGDATEN -->
                <div id="fahrzeugdaten-section" class="section-title">
                    Fahrzeug
                </div>

                <!-- PDF-UPLOAD SECTION (HIDDEN - Phase 2 UX: Wird in entwuerfe-bearbeiten.html ausgef√ºllt) -->
                <div class="form-group" style="display: none; background: var(--color-bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <label class="form-label">
                        DAT-Kalkulation (optional)
                        <span style="color: var(--color-text-tertiary); font-size: 12px; font-weight: normal; display: block; margin-top: 4px;">
                            PDF hochladen ‚Üí Daten automatisch ausf√ºllen
                        </span>
                    </label>
                    <div class="pdf-upload-container" style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                        <!-- üîß FIX Safari (2025-12-24): label statt button+onclick f√ºr native File-Input Trigger -->
                        <label for="datPdfInput" class="btn btn-secondary" style="font-size: 14px; cursor: pointer;">
                            PDF ausw√§hlen
                        </label>
                        <input type="file" id="datPdfInput" accept="application/pdf" style="display: none;">
                        <span id="pdfFileName" class="pdf-filename" style="color: var(--color-success); font-size: 14px; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></span>
                        <button type="button" id="pdfRemoveBtn" class="btn-icon-small"
                                style="display: none; background: transparent; border: none; cursor: pointer; font-size: 18px;"
                                onclick="removePdf()">‚ùå</button>
                    </div>
                </div>

                <!-- TEXT-PARSING SECTION (HIDDEN - Phase 2 UX: Wird in entwuerfe-bearbeiten.html ausgef√ºllt) -->
                <div class="form-group" style="display: none; background: var(--color-bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <label class="form-label">
                        Oder: DAT-Text einf√ºgen
                        <span style="color: var(--color-text-tertiary); font-size: 12px; font-weight: normal; display: block; margin-top: 4px;">
                            Text einf√ºgen ‚Üí "Text auslesen" klicken
                        </span>
                    </label>
                    <textarea id="datTextInput"
                              placeholder="F√ºge hier den DAT-Auftrag Text ein (Ersatzteile, Arbeitslohn, Lackierung)..."
                              style="
                                  width: 100%;
                                  min-height: 150px;
                                  padding: 12px;
                                  border: 2px solid var(--color-border);
                                  border-radius: 8px;
                                  background: var(--color-surface);
                                  color: var(--color-text-primary);
                                  font-family: 'Courier New', monospace;
                                  font-size: 12px;
                                  resize: vertical;
                                  margin-top: 10px;
                                  white-space: pre-wrap;
                                  word-break: break-all;
                                  overflow-wrap: anywhere;
                                  tab-size: 4;
                              "></textarea>
                    <script>
                    // FIX #1: Paste Event Sanitization (2025-11-11)
                    // Bereinigt Copy-Paste von Word/Excel/PDF
                    document.getElementById('datTextInput').addEventListener('paste', (e) => {
                        e.preventDefault();
                        const text = (e.clipboardData || window.clipboardData).getData('text/plain');

                        // Normalisierung
                        const cleaned = text
                            .replace(/\r\n/g, '\n')     // Windows ‚Üí Unix line endings
                            .replace(/\r/g, '\n')       // Old Mac ‚Üí Unix
                            .replace(/\u00a0/g, ' ')    // Non-breaking space ‚Üí regular
                            .replace(/\u2009/g, ' ')    // Thin space ‚Üí regular
                            .replace(/\u202F/g, ' ')    // Narrow no-break space ‚Üí regular
                            .replace(/\t/g, '    ')     // Tab ‚Üí 4 spaces
                            .replace(/[""]/g, '"')      // Smart quotes ‚Üí regular
                            .replace(/['']/g, "'");     // Smart apostrophes ‚Üí regular

                        document.execCommand('insertText', false, cleaned);

                        // Visual Feedback
                        if (window.showToast) {
                            showToast('‚úÖ Text eingef√ºgt und bereinigt', 'success');
                        }
                        const textarea = document.getElementById('datTextInput');
                        textarea.style.borderColor = 'var(--color-success)';
                        setTimeout(() => {
                            textarea.style.borderColor = '';
                        }, 2000);
                    });
                    </script>
                    <div style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                        <button type="button" id="parseTextBtn" class="btn btn-primary" style="font-size: 14px;" onclick="handleTextParsing()">
                            Text auslesen
                        </button>
                        <span id="textParseStatus" style="color: var(--color-success); font-size: 14px;"></span>
                        <button type="button" id="clearTextBtn" class="btn-icon-small"
                                style="display: none; background: transparent; border: none; cursor: pointer; font-size: 18px;"
                                onclick="clearDatText()">‚ùå</button>
                    </div>

                    <!-- ERSATZTEILE TABELLE (Permanent, Editierbar) -->
                    <div id="ersatzteileSection" style="margin-top: 20px; padding: 15px; background: rgba(79, 172, 254, 0.1); border-radius: 8px; border-left: 4px solid var(--color-primary);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h4 style="color: var(--color-primary); font-size: 16px; margin: 0;">
                                Ersatzteile (<span id="ersatzteileCount">0</span>)
                            </h4>
                            <button type="button" id="addErsatzteilBtn" onclick="addErsatzteilRow()" style="padding: 6px 12px; background: var(--color-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                + Zeile hinzuf√ºgen
                            </button>
                        </div>
                        <div style="overflow-x: auto;">
                            <table id="ersatzteileTable" style="width: 100%; border-collapse: collapse; font-size: 13px;">
                                <thead>
                                    <tr style="background: rgba(0,0,0,0.1); text-align: left;">
                                        <th style="padding: 8px; border-bottom: 2px solid var(--color-primary); width: 120px;">ETN</th>
                                        <th style="padding: 8px; border-bottom: 2px solid var(--color-primary);">Benennung</th>
                                        <th style="padding: 8px; border-bottom: 2px solid var(--color-primary); text-align: center; width: 80px;">Anzahl</th>
                                        <th style="padding: 8px; border-bottom: 2px solid var(--color-primary); text-align: right; width: 100px;">Einzelpreis</th>
                                        <th style="padding: 8px; border-bottom: 2px solid var(--color-primary); text-align: right; width: 100px;">Gesamtpreis</th>
                                        <th style="padding: 8px; border-bottom: 2px solid var(--color-primary); text-align: center; width: 60px;">Aktion</th>
                                    </tr>
                                </thead>
                                <tbody id="ersatzteileTableBody">
                                    <!-- Dynamisch gef√ºllt - Zeilen werden durch JavaScript hinzugef√ºgt -->
                                </tbody>
                                <tfoot style="background: rgba(79, 172, 254, 0.1); font-weight: 600;">
                                    <tr>
                                        <td colspan="4" style="padding: 8px; text-align: right;">SUMME:</td>
                                        <td style="padding: 8px; text-align: right; color: var(--color-primary);" id="ersatzteileSumme">0.00 ‚Ç¨</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <p style="font-size: 11px; color: var(--color-text-secondary); margin-top: 10px; font-style: italic;">
                            üí° Tipp: PDF hochladen bef√ºllt die Tabelle automatisch. Oder manuell Zeilen hinzuf√ºgen mit dem "+ Zeile hinzuf√ºgen" Button.
                        </p>
                    </div>

                    <!-- ARBEITSLOHN TABELLE (Permanent, Editierbar) -->
                    <div id="arbeitslohnSection" style="margin-top: 20px; padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 8px; border-left: 4px solid #4caf50;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h4 style="color: #4caf50; font-size: 16px; margin: 0;">
                                Arbeitslohn (<span id="arbeitslohnCount">0</span>)
                            </h4>
                            <button type="button" id="addArbeitslohnBtn" onclick="addArbeitslohnRow()" style="padding: 8px 14px; background: #4caf50; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s;">
                                + Zeile hinzuf√ºgen
                            </button>
                        </div>
                        <div style="overflow-x: auto;">
                            <table id="arbeitslohnTable" style="width: 100%; border-collapse: collapse; font-size: 13px; background: white; border-radius: 4px; overflow: hidden;">
                                <thead>
                                    <tr style="background: rgba(76, 175, 80, 0.1); text-align: left;">
                                        <th style="padding: 8px; border-bottom: 2px solid #4caf50;">Position</th>
                                        <th style="padding: 8px; border-bottom: 2px solid #4caf50; text-align: center;">Art</th>
                                        <th style="padding: 8px; border-bottom: 2px solid #4caf50; text-align: right;">Stunden</th>
                                        <th style="padding: 8px; border-bottom: 2px solid #4caf50; text-align: right;">Stundensatz</th>
                                        <th style="padding: 8px; border-bottom: 2px solid #4caf50; text-align: right;">Gesamtpreis</th>
                                        <th style="padding: 8px; border-bottom: 2px solid #4caf50; text-align: center; width: 60px;">Aktion</th>
                                    </tr>
                                </thead>
                                <tbody id="arbeitslohnTableBody">
                                    <!-- Dynamisch gef√ºllt -->
                                </tbody>
                                <tfoot style="background: rgba(76, 175, 80, 0.1); font-weight: 600;">
                                    <tr>
                                        <td colspan="4" style="padding: 8px; text-align: right;">SUMME:</td>
                                        <td style="padding: 8px; text-align: right; color: #4caf50;" id="arbeitslohnTotal">0.00 ‚Ç¨</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- LACKIERUNG TABELLE (HIDDEN - Phase 2 UX: Wird in entwuerfe-bearbeiten.html ausgef√ºllt) -->
                <div id="lackierungSection" style="display: none; margin-top: 20px; padding: 15px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; border-left: 4px solid #9c27b0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h4 style="color: #9c27b0; font-size: 16px; margin: 0;">
                            Lackierung (<span id="lackierungCount">0</span>)
                        </h4>
                        <button type="button" id="addLackierungBtn" onclick="addLackierungRow()" style="padding: 8px 14px; background: #9c27b0; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s;">
                            + Zeile hinzuf√ºgen
                        </button>
                    </div>
                    <table id="lackierungTable" style="width: 100%; border-collapse: collapse; font-size: 13px; background: white; border-radius: 4px; overflow: hidden;">
                        <thead style="background: rgba(156, 39, 176, 0.1);">
                            <tr>
                                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #9c27b0;">Position</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #9c27b0;">Bereich</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #9c27b0;">Stunden</th>
                                <th style="padding: 10px; text-align: right; border-bottom: 2px solid #9c27b0;">Stundensatz</th>
                                <th style="padding: 10px; text-align: right; border-bottom: 2px solid #9c27b0;">Gesamtpreis</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #9c27b0; width: 60px;">Aktion</th>
                            </tr>
                        </thead>
                        <tbody id="lackierungTableBody"></tbody>
                        <tfoot style="background: rgba(156, 39, 176, 0.15); font-weight: bold;">
                            <tr>
                                <td colspan="4" style="padding: 10px; text-align: right; border-top: 2px solid #9c27b0;">SUMME:</td>
                                <td id="lackierungTotal" style="padding: 10px; text-align: right; color: #9c27b0; font-size: 1.1em; border-top: 2px solid #9c27b0;">0.00 ‚Ç¨</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- MATERIALIEN TABELLE (Permanent, Editierbar) -->
                <div id="materialienSection" style="margin-top: 20px; padding: 15px; background: rgba(255, 152, 0, 0.1); border-radius: 8px; border-left: 4px solid #ff9800;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h4 style="color: #ff9800; font-size: 16px; margin: 0;">
                            Materialien (<span id="materialienCount">0</span>)
                        </h4>
                        <button type="button" id="addMaterialienBtn" onclick="addMaterialienRow()" style="padding: 8px 14px; background: #ff9800; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s;">
                            + Material hinzuf√ºgen
                        </button>
                    </div>
                    <table id="materialienTable" style="width: 100%; border-collapse: collapse; font-size: 13px; background: white; border-radius: 4px; overflow: hidden;">
                        <thead style="background: rgba(255, 152, 0, 0.1);">
                            <tr>
                                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ff9800;">Material-Typ</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #ff9800;">Menge</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ff9800;">Einheit</th>
                                <th style="padding: 10px; text-align: right; border-bottom: 2px solid #ff9800;">Einheitspreis (‚Ç¨)</th>
                                <th style="padding: 10px; text-align: right; border-bottom: 2px solid #ff9800;">Gesamtpreis</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #ff9800; width: 60px;">Aktion</th>
                            </tr>
                        </thead>
                        <tbody id="materialienTableBody"></tbody>
                        <tfoot style="background: rgba(255, 152, 0, 0.15); font-weight: bold;">
                            <tr>
                                <td colspan="4" style="padding: 10px; text-align: right; border-top: 2px solid #ff9800;">SUMME:</td>
                                <td id="materialienTotal" style="padding: 10px; text-align: right; color: #ff9800; font-size: 1.1em; border-top: 2px solid #ff9800;">0.00 ‚Ç¨</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- GESAMTSUMME (GRAND TOTAL) -->
                <div id="gesamtsummePreview" style="display: none; margin-top: 25px; padding: 20px; background: linear-gradient(135deg, rgba(255, 215, 0, 0.15), rgba(255, 165, 0, 0.15)); border-radius: 12px; border: 3px solid #ffa500; box-shadow: 0 4px 12px rgba(255, 165, 0, 0.2);">
                    <h3 style="color: #ff8c00; margin: 0 0 15px 0;">
                        KOSTEN√úBERSICHT - GESAMTSUMME
                    </h3>
                    <div style="background: white; border-radius: 8px; padding: 15px;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <tbody>
                                <tr style="border-bottom: 1px solid rgba(0,0,0,0.1);">
                                    <td style="padding: 8px; color: #666;">Ersatzteile:</td>
                                    <td id="summeErsatzteile" style="padding: 8px; text-align: right; font-family: 'Courier New', monospace; font-weight: 600; color: var(--color-primary);">0.00 ‚Ç¨</td>
                                </tr>
                                <tr style="border-bottom: 1px solid rgba(0,0,0,0.1);">
                                    <td style="padding: 8px; color: #666;">Arbeitslohn:</td>
                                    <td id="summeArbeitslohn" style="padding: 8px; text-align: right; font-family: 'Courier New', monospace; font-weight: 600; color: #4caf50;">0.00 ‚Ç¨</td>
                                </tr>
                                <tr style="border-bottom: 1px solid rgba(0,0,0,0.1);">
                                    <td style="padding: 8px; color: #666;">Lackierung:</td>
                                    <td id="summeLackierung" style="padding: 8px; text-align: right; font-family: 'Courier New', monospace; font-weight: 600; color: #9c27b0;">0.00 ‚Ç¨</td>
                                </tr>
                                <tr style="border-bottom: 2px solid #ffa500;">
                                    <td style="padding: 8px; color: #666;">Materialien:</td>
                                    <td id="summeMaterialien" style="padding: 8px; text-align: right; font-family: 'Courier New', monospace; font-weight: 600; color: #ff9800;">0.00 ‚Ç¨</td>
                                </tr>
                                <tr style="background: rgba(255, 165, 0, 0.1);">
                                    <td style="padding: 12px; font-size: 1.2em; font-weight: bold; color: #ff8c00;">
                                        GESAMTPREIS:
                                    </td>
                                    <td id="gesamtpreis" style="padding: 12px; text-align: right; font-family: 'Courier New', monospace; font-size: 1.3em; font-weight: bold; color: #ff8c00;">0.00 ‚Ç¨</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- FAHRZEUGDATEN (Collapsible - Phase 2 UX) -->
                <div class="collapsible-section" id="fahrzeug-collapsible">
                    <div class="collapsible-header" onclick="toggleCollapsible('fahrzeug-collapsible')">
                        <div class="collapsible-header-left">
                            <span class="collapsible-header-title">Fahrzeugdaten</span>
                            <span class="collapsible-header-hint">Optional</span>
                        </div>
                    </div>
                    <div class="collapsible-content">
                        <div class="collapsible-content-inner">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="marke" class="form-label">Marke</label>
                                    <select id="marke" class="form-select">
                                        <option value="">-- Bitte w√§hlen --</option>
                                        <option value="Audi">Audi</option>
                                        <option value="BMW">BMW</option>
                                        <option value="Citroen">Citroen</option>
                                        <option value="Cupra">Cupra</option>
                                        <option value="Fiat">Fiat</option>
                                        <option value="Ford">Ford</option>
                                        <option value="Honda">Honda</option>
                                        <option value="Hyundai">Hyundai</option>
                                        <option value="Kia">Kia</option>
                                        <option value="Mazda">Mazda</option>
                                        <option value="Mercedes-Benz">Mercedes-Benz</option>
                                        <option value="MINI">MINI</option>
                                        <option value="Nissan">Nissan</option>
                                        <option value="Opel">Opel</option>
                                        <option value="Peugeot">Peugeot</option>
                                        <option value="Porsche">Porsche</option>
                                        <option value="Renault">Renault</option>
                                        <option value="Seat">Seat</option>
                                        <option value="Skoda">Skoda</option>
                                        <option value="Suzuki">Suzuki</option>
                                        <option value="Toyota">Toyota</option>
                                        <option value="Volkswagen">Volkswagen</option>
                                        <option value="Volvo">Volvo</option>
                                        <option value="Sonstige">Sonstige</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label for="modell" class="form-label">Modell</label>
                                    <input type="text" id="modell" class="form-input" placeholder="z.B. Golf 8, A4, 3er">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Baujahr</label>
                                    <div style="display: flex; gap: var(--space-2); align-items: center;">
                                        <select id="baujahrVon" class="form-select" style="flex: 1;">
                                            <option value="">Von</option>
                                            <option value="2025">2025</option>
                                            <option value="2024">2024</option>
                                            <option value="2023">2023</option>
                                            <option value="2022">2022</option>
                                            <option value="2021">2021</option>
                                            <option value="2020">2020</option>
                                            <option value="2019">2019</option>
                                            <option value="2018">2018</option>
                                            <option value="2017">2017</option>
                                            <option value="2016">2016</option>
                                            <option value="2015">2015</option>
                                            <option value="2014">2014</option>
                                            <option value="2013">2013</option>
                                            <option value="2012">2012</option>
                                            <option value="2011">2011</option>
                                            <option value="2010">2010</option>
                                            <option value="2009">2009</option>
                                            <option value="2008">2008</option>
                                            <option value="2007">2007</option>
                                            <option value="2006">2006</option>
                                            <option value="2005">2005</option>
                                            <option value="2004">2004</option>
                                            <option value="2003">2003</option>
                                            <option value="2002">2002</option>
                                            <option value="2001">2001</option>
                                            <option value="2000">2000</option>
                                            <option value="√Ñlter">√Ñlter als 2000</option>
                                        </select>
                                        <span style="font-weight: 600; color: var(--color-text-secondary);">-</span>
                                        <select id="baujahrBis" class="form-select" style="flex: 1;">
                                            <option value="">Bis</option>
                                            <option value="2025">2025</option>
                                            <option value="2024">2024</option>
                                            <option value="2023">2023</option>
                                            <option value="2022">2022</option>
                                            <option value="2021">2021</option>
                                            <option value="2020">2020</option>
                                            <option value="2019">2019</option>
                                            <option value="2018">2018</option>
                                            <option value="2017">2017</option>
                                            <option value="2016">2016</option>
                                            <option value="2015">2015</option>
                                            <option value="2014">2014</option>
                                            <option value="2013">2013</option>
                                            <option value="2012">2012</option>
                                            <option value="2011">2011</option>
                                            <option value="2010">2010</option>
                                            <option value="2009">2009</option>
                                            <option value="2008">2008</option>
                                            <option value="2007">2007</option>
                                            <option value="2006">2006</option>
                                            <option value="2005">2005</option>
                                            <option value="2004">2004</option>
                                            <option value="2003">2003</option>
                                            <option value="2002">2002</option>
                                            <option value="2001">2001</option>
                                            <option value="2000">2000</option>
                                            <option value="√Ñlter">√Ñlter als 2000</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="kmstand" class="form-label">KM-Stand</label>
                                    <input type="number" id="kmstand" class="form-input" placeholder="z.B. 45000">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="vin" class="form-label">VIN/FIN (optional)</label>
                                <input type="text" id="vin" class="form-input" placeholder="Fahrgestellnummer">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- LACKIER-INFORMATIONEN (nur f√ºr Lackierung & Alle Services) -->
                <!-- LACKIER-INFORMATIONEN (HIDDEN - Phase 2 UX: Wird in entwuerfe-bearbeiten.html ausgef√ºllt) -->
                <div id="lackierung-felder" class="service-felder" style="display:none;">
                    <div class="section-title" style="display: none;">
                        Lackier-Informationen
                    </div>

                    <div class="form-group" style="display: none;">
                        <label for="farbname" class="form-label">Farbname</label>
                        <input type="text" id="farbname" class="form-input" placeholder="z.B. Silber Metallic, Tiefes Schwarz Perleffekt">
                    </div>

                    <div class="form-group" style="display: none;">
                        <label for="farbvariante" class="form-label">Farbvariante (f√ºr Lackierer)</label>
                        <input type="text" id="farbvariante" class="form-input" list="farbvarianten-liste" placeholder="z.B. Variante A, Mischung 1, Hell abget√∂nt">
                        <datalist id="farbvarianten-liste">
                            <option value="Standard">
                            <option value="Variante A">
                            <option value="Variante B">
                            <option value="Variante C">
                            <option value="Mischung 1">
                            <option value="Mischung 2">
                            <option value="Hell abget√∂nt">
                            <option value="Dunkel abget√∂nt">
                            <option value="Metallic-Effekt">
                            <option value="Matt-Finish">
                        </datalist>
                        <small style="color: var(--color-text-tertiary); font-size: var(--font-size-xs); display: block; margin-top: var(--space-1);">
                            Notiz f√ºr Lackierer: Welche Mischvariante wurde verwendet?
                        </small>
                    </div>

                    <div class="form-group highlight" style="display: none;">
                        <label for="farbnummer" class="form-label">FARBNUMMER / FARBCODE</label>
                        <input type="text" id="farbnummer" class="form-input" placeholder="z.B. LC9Z, C7A, A96, LY9B">
                    </div>

                    <div class="form-group" style="display: none;">
                        <label class="form-label">Lackart</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="lackart" value="Uni">
                                <span>Uni / Solid</span>
                            </label>
                            <label>
                                <input type="radio" name="lackart" value="Metallic" checked>
                                <span>Metallic</span>
                            </label>
                            <label>
                                <input type="radio" name="lackart" value="Perleffekt">
                                <span>Perleffekt</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- FOTOS -->
                <div class="section-title">
                    Fotos
                </div>

                <div id="photo-section" class="photo-section">
                    <label class="form-label">Fotos (mind. 1)</label>
                    <div class="photo-grid" id="photoGrid">
                        <!-- üîß FIX Safari (2025-12-24): label statt div+onclick f√ºr native File-Input Trigger -->
                        <label for="photoInput" class="photo-item empty">
                            <span>+ Foto hinzuf√ºgen</span>
                        </label>
                    </div>
                    <input type="file" id="photoInput" accept="image/*" capture="environment" multiple>
                </div>

                <!-- NOTIZEN -->
                <div id="notizen-section" class="section-title">
                    Beschreibung & Preis
                </div>

                <div class="form-group">
                    <label for="notizen" class="form-label">Schadensbeschreibung / Notizen</label>
                    <textarea id="notizen" class="form-textarea" placeholder="z.B. Delle linke T√ºr, Kratzer Kotfl√ºgel hinten rechts..."></textarea>
                </div>

                <!-- KOSTENAUFSCHL√úSSELUNG (HIDDEN - Phase 2 UX: Wird in entwuerfe-bearbeiten.html ausgef√ºllt) -->
                <div class="collapsible-section" id="kosten-collapsible" style="display: none;">
                    <div class="collapsible-header" onclick="toggleCollapsible('kosten-collapsible')">
                        <div class="collapsible-header-left">
                            <span class="collapsible-header-title">Kostenaufschl√ºsselung</span>
                            <span class="collapsible-header-hint">F√ºr Buchhaltung</span>
                        </div>
                    </div>
                    <div class="collapsible-content">
                        <div class="collapsible-content-inner">
                            <p style="font-size: 0.9em; color: var(--color-text-secondary); margin-bottom: 15px;">
                                Automatisch aus DAT-PDF √ºbernommen. Bei Bedarf anpassbar.
                            </p>

                            <!-- Netto-Positionen -->
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                                <div class="form-group">
                                    <label for="kostenErsatzteile" class="form-label">Ersatzteile (Netto)</label>
                                    <input type="number" id="kostenErsatzteile" class="form-input" placeholder="0.00" step="0.01" min="0" readonly style="background: #f5f5f5;">
                                    <small style="color: var(--color-text-tertiary);">Materialkosten</small>
                                </div>

                                <div class="form-group">
                                    <label for="kostenArbeitslohn" class="form-label">Arbeitslohn (Netto)</label>
                                    <input type="number" id="kostenArbeitslohn" class="form-input" placeholder="0.00" step="0.01" min="0" readonly style="background: #f5f5f5;">
                                    <small style="color: var(--color-text-tertiary);">Personalkosten</small>
                                </div>

                                <div class="form-group">
                                    <label for="kostenLackierung" class="form-label">Lackierung (Netto)</label>
                                    <input type="number" id="kostenLackierung" class="form-input" placeholder="0.00" step="0.01" min="0" readonly style="background: #f5f5f5;">
                                    <small style="color: var(--color-text-tertiary);">Lackierarbeiten</small>
                                </div>

                                <div class="form-group">
                                    <label for="kostenMaterialien" class="form-label">Materialien (Netto)</label>
                                    <input type="number" id="kostenMaterialien" class="form-input" placeholder="0.00" step="0.01" min="0" readonly style="background: #f5f5f5;">
                                    <small style="color: var(--color-text-tertiary);">Folien, Pflegeprodukte, etc.</small>
                                </div>
                            </div>

                            <!-- Netto-Summe -->
                            <div style="padding: 15px; background: rgba(255,255,255,0.8); border-radius: 6px; margin-bottom: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <strong style="font-size: 1.1em;">Summe Netto:</strong>
                                    <input type="number" id="summeNetto" readonly style="background: transparent; border: none; text-align: right; font-size: 1.2em; font-weight: bold; color: var(--color-primary); width: 150px; padding: 0;">
                                </div>
                            </div>

                            <!-- MwSt-Berechnung -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div class="form-group">
                                    <label for="mwstSatz" class="form-label">MwSt-Satz</label>
                                    <select id="mwstSatz" class="form-input">
                                        <option value="19">19% (Standard)</option>
                                        <option value="7">7% (erm√§√üigt)</option>
                                        <option value="0">0% (befreit)</option>
                                    </select>
                                    <small style="color: var(--color-text-tertiary);">Standard: 19%</small>
                                </div>

                                <div class="form-group">
                                    <label for="mwstBetrag" class="form-label">MwSt-Betrag</label>
                                    <input type="number" id="mwstBetrag" class="form-input" placeholder="0.00" readonly style="background: #f5f5f5; font-weight: 600;">
                                    <small style="color: var(--color-text-tertiary);">Automatisch berechnet</small>
                                </div>
                            </div>

                            <!-- Brutto-Summe (= Vereinbarter Preis) -->
                            <div style="padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <strong style="font-size: 1.2em;">Summe Brutto (inkl. MwSt):</strong>
                                    <span id="summeBrutto" style="font-size: 1.5em; font-weight: bold;">0.00 ‚Ç¨</span>
                                </div>
                                <small style="opacity: 0.9;">= Vereinbarter Preis</small>
                            </div>

                            <!-- Edit Button -->
                            <button type="button" id="btnEditKosten" style="margin-top: 15px; padding: 10px 20px; background: var(--color-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9em;">
                                Werte manuell bearbeiten
                            </button>
                        </div>
                    </div>
                </div>

                <!-- VEREINBARTER PREIS (HIDDEN - Phase 2 UX: Wird in entwuerfe-bearbeiten.html ausgef√ºllt) -->
                <div class="form-group" style="display: none; margin-top: 25px; padding: 20px; background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 165, 0, 0.1)); border-radius: 12px; border: 3px solid #ffa500;">
                    <label for="vereinbarterPreis" class="form-label" style="font-size: 1.2em; color: #ff8c00; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                        Preis (Brutto) <span class="required">*</span>
                    </label>

                    <div style="display: flex; gap: 15px; align-items: center; margin-top: 10px;">
                        <input type="number" id="vereinbarterPreis" class="form-input" placeholder="0.00" step="0.01" min="0" readonly
                               style="flex: 1; font-size: 1.5em; font-weight: bold; background: #f0f8ff; border: 2px solid var(--color-primary); text-align: right; padding: 12px;">

                        <label style="display: flex; align-items: center; gap: 8px; padding: 10px 15px; background: white; border-radius: 8px; cursor: pointer; user-select: none; border: 2px solid #ddd;">
                            <input type="checkbox" id="manualPriceOverride" style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="font-weight: 500; white-space: nowrap;">Manuell √ºberschreiben</span>
                        </label>
                    </div>

                    <small style="color: var(--color-text-tertiary); display: block; margin-top: 10px; font-style: italic;">
                        Automatisch berechnet. Checkbox f√ºr manuelle Eingabe.
                    </small>
                </div>

                <!-- UNTERSCHRIFT -->
                <div id="signature-section" class="section-title">
                    Unterschrift
                </div>

                <div class="signature-section">
                    <label class="form-label">Unterschrift <span class="required">*</span></label>
                    <canvas id="signatureCanvas" width="800" height="400"></canvas>
                    <div class="signature-buttons">
                        <button type="button" class="btn btn-secondary btn-sm" onclick="clearSignature()">
                            L√∂schen
                        </button>
                    </div>

                    <!-- Vollst√§ndiger Name f√ºr Nachvollziehbarkeit -->
                    <div class="form-group" style="margin-top: 16px;">
                        <label for="unterschriftName" class="form-label">Vollst√§ndiger Name <span class="required">*</span></label>
                        <input type="text" id="unterschriftName" class="form-input" placeholder="Vor- und Nachname des Unterzeichners" required>
                    </div>
                </div>

                <!-- ENTWURF QUICK MODE TOGGLE (HIDDEN - Phase 2 UX: Vereinfacht) -->
                <div class="form-group" style="display: none; margin-top: 20px; padding: 15px; background: rgba(255, 193, 7, 0.1); border-radius: 8px; border-left: 4px solid #ffc107;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 600;">
                        <input type="checkbox" id="quickModeToggle" onchange="toggleQuickMode()" style="width: 20px; height: 20px; cursor: pointer;">
                        <span>Quick Mode (nur Kennzeichen, Kunde, E-Mail)</span>
                    </label>
                    <small style="display: block; margin-top: 8px; color: var(--color-text-secondary); margin-left: 30px;">
                        Schnell-Entwurf mit Mindestdaten. B√ºro vervollst√§ndigt sp√§ter.
                    </small>
                </div>

                <div class="submit-buttons">
                    <!-- Entwurf speichern Button (HIDDEN - Phase 2 UX) -->
                    <button type="button" class="btn btn-warning btn-lg" onclick="saveAsDraft()" style="display: none;">
                        <span style="font-family: Arial, sans-serif;">Entwurf speichern</span>
                    </button>
                    <button type="button" class="btn btn-success btn-lg" onclick="saveAsDraftWithPDF()">
                        <span style="font-family: Arial, sans-serif; font-weight: 600;">Speichern und PDF erstellen</span>
                    </button>
                </div>
            </div>
        </form>
    </div>

    <script>
        // Initialize Feather Icons
        feather.replace();

        // ========== COLLAPSIBLE SECTIONS (Phase 2 UX) ==========
        function toggleCollapsible(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.toggle('is-open');
                // Re-initialize feather icons in case they weren't rendered
                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
            }
        }

        // Firebase initialisieren
        let firebaseInitialized = false;

        // üîß FIX Dec 3, 2025: photos Variable an den Anfang des Script-Blocks verschoben
        // Problem: saveAsDraft() (Zeile 4504) konnte photos nicht lesen, da let nicht gehoisted wird
        // und photos erst in Zeile 5196 deklariert wurde (NACH saveAsDraft)
        let photos = [];

        // Auto-Save: Entwurf speichern bei Eingabe
        let autoSaveTimeout;
        function saveDraft() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                // üîß FIX A3 (2025-12-12): Null-Safety f√ºr Formular-Felder
                const draft = {
                    kennzeichen: document.getElementById('kennzeichen')?.value?.trim()?.toUpperCase() || '',
                    neuwagenOhneKennzeichen: document.getElementById('neuwagenOhneKennzeichen')?.checked || false, // 2026-01-08
                    kundenname: document.getElementById('kundenname')?.value || '',
                    kundenEmail: document.getElementById('kundenEmail')?.value?.trim()?.toLowerCase() || '',
                    telefon: document.getElementById('telefon')?.value || '',
                    geplantesAbnahmeDatum: document.getElementById('geplantesAbnahmeDatum')?.value || '',
                    serviceTyp: document.getElementById('serviceTyp')?.value || '',
                    fahrzeugAbholung: document.querySelector('input[name="fahrzeugAbholung"]:checked')?.value || 'nein',
                    abholadresse: document.getElementById('abholadresse')?.value || '',
                    abholdatum: document.getElementById('abholdatum')?.value || '',
                    abholzeit: document.getElementById('abholzeit')?.value || '',
                    abholnotiz: document.getElementById('abholnotiz')?.value || '',
                    marke: document.getElementById('marke')?.value || '',
                    modell: document.getElementById('modell')?.value || '',
                    baujahrVon: document.getElementById('baujahrVon')?.value || '',
                    baujahrBis: document.getElementById('baujahrBis')?.value || '',
                    kmstand: document.getElementById('kmstand')?.value || '',
                    vin: document.getElementById('vin')?.value || '',
                    farbname: document.getElementById('farbname')?.value || '',
                    farbvariante: document.getElementById('farbvariante')?.value || '',
                    farbnummer: document.getElementById('farbnummer')?.value || '',
                    notizen: document.getElementById('notizen')?.value || '',
                    vereinbarterPreis: document.getElementById('vereinbarterPreis')?.value || '',
                    timestamp: Date.now()
                };

                if (draft.kennzeichen || draft.kundenname || draft.marke) {
                    localStorage.setItem('annahme_draft', JSON.stringify(draft));
                    // console.log('üíæ Entwurf gespeichert');
                }
            }, 2000);
        }

        // Entwurf laden
        function loadDraft() {
            const draft = localStorage.getItem('annahme_draft');
            if (draft) {
                const data = JSON.parse(draft);
                const ageMinutes = (Date.now() - data.timestamp) / 1000 / 60;

                if (ageMinutes < 60 && confirm('üîÑ Entwurf gefunden! M√∂chten Sie Ihre letzte Eingabe wiederherstellen?')) {
                    document.getElementById('kennzeichen').value = data.kennzeichen || '';
                    // Neuwagen-Checkbox wiederherstellen (2026-01-08)
                    if (data.neuwagenOhneKennzeichen) {
                        document.getElementById('neuwagenOhneKennzeichen').checked = true;
                        handleNeuwagenCheckbox();
                    }
                    document.getElementById('kundenname').value = data.kundenname || '';
                    document.getElementById('kundenEmail').value = data.kundenEmail || '';
                    document.getElementById('telefon').value = data.telefon || '';
                    document.getElementById('geplantesAbnahmeDatum').value = data.geplantesAbnahmeDatum || '';
                    document.getElementById('serviceTyp').value = data.serviceTyp || 'lackier';
                    document.getElementById('marke').value = data.marke || '';
                    document.getElementById('modell').value = data.modell || '';
                    document.getElementById('baujahrVon').value = data.baujahrVon || data.baujahr || '';
                    document.getElementById('baujahrBis').value = data.baujahrBis || data.baujahr || '';
                    document.getElementById('kmstand').value = data.kmstand || '';
                    document.getElementById('vin').value = data.vin || '';
                    document.getElementById('farbname').value = data.farbname || '';
                    document.getElementById('farbvariante').value = data.farbvariante || '';
                    document.getElementById('farbnummer').value = data.farbnummer || '';
                    document.getElementById('notizen').value = data.notizen || '';
                    document.getElementById('vereinbarterPreis').value = data.vereinbarterPreis || '';

                    if (data.fahrzeugAbholung) {
                        const abholungRadio = document.querySelector(`input[name="fahrzeugAbholung"][value="${data.fahrzeugAbholung}"]`);
                        if (abholungRadio) {
                            abholungRadio.checked = true;
                            toggleAbholungDetails();
                        }
                        document.getElementById('abholadresse').value = data.abholadresse || '';
                        document.getElementById('abholdatum').value = data.abholdatum || '';
                        document.getElementById('abholzeit').value = data.abholzeit || '';
                        document.getElementById('abholnotiz').value = data.abholnotiz || '';
                    }

                    // Service-spezifische Felder visibility & required status updaten
                    const restoredServiceTyp = data.serviceTyp || 'lackier';
                    toggleServiceFelder(); // Zeigt die richtigen Felder basierend auf serviceTyp
                    updateRequiredFields(restoredServiceTyp); // Setzt required Attribute korrekt
                    // console.log('‚úÖ Required fields initialized for restored draft:', restoredServiceTyp);

                    // console.log('‚úÖ Entwurf wiederhergestellt');
                }
            }
        }

        // Entwurf l√∂schen nach erfolgreichem Speichern
        function clearDraft() {
            localStorage.removeItem('annahme_draft');
        }

        // Auto-Save bei Eingabe aktivieren
        let allKunden = [];

        // üîß 2025-11-25: Filter disabled services from UI elements
        function filterDisabledServices(enabledServices) {
            // console.log('üîß Filtere deaktivierte Services:', enabledServices);

            // 1. Filter dropdown options
            const dropdown = document.getElementById('serviceTyp');
            if (dropdown) {
                Array.from(dropdown.options).forEach(option => {
                    const serviceKey = option.value;
                    // Hide option if explicitly disabled (false)
                    if (enabledServices[serviceKey] === false) {
                        option.style.display = 'none';
                        option.disabled = true;
                        // console.log(`   ‚ùå Dropdown: ${serviceKey} ausgeblendet`);
                    }
                });

                // If current selection is disabled, select first enabled option
                const currentValue = dropdown.value;
                if (enabledServices[currentValue] === false) {
                    const firstEnabled = Array.from(dropdown.options).find(opt =>
                        enabledServices[opt.value] !== false && !opt.disabled
                    );
                    if (firstEnabled) {
                        dropdown.value = firstEnabled.value;
                        // console.log(`   üîÑ Dropdown: Wechsel zu ${firstEnabled.value}`);
                        toggleServiceFelder(); // Aktualisiere Felder
                    }
                }
            }

            // 2. Filter additional service checkboxes
            document.querySelectorAll('.checkbox-card[data-service]').forEach(card => {
                const serviceKey = card.getAttribute('data-service');
                if (enabledServices[serviceKey] === false) {
                    card.style.display = 'none';
                    const checkbox = card.querySelector('.additional-service-checkbox');
                    if (checkbox) {
                        checkbox.disabled = true;
                        checkbox.checked = false;
                    }
                    // console.log(`   ‚ùå Checkbox: ${serviceKey} ausgeblendet`);
                }
            });

            // Count remaining visible services
            const enabledCount = Object.values(enabledServices).filter(v => v !== false).length;
            // console.log(`‚úÖ ${enabledCount}/12 Services aktiv`);
        }

        // ‚ú® SERVICE-SPEZIFISCHE FELDER TOGGLE
        function toggleServiceFelder() {
            // Alle service-felder verstecken
            document.querySelectorAll('.service-felder').forEach(el => el.style.display = 'none');

            // Nur relevante Felder f√ºr ausgew√§hlten Service zeigen
            const serviceTyp = document.getElementById('serviceTyp').value;
            const felderDiv = document.getElementById(`${serviceTyp}-felder`);

            if (felderDiv) {
                felderDiv.style.display = 'block';
                // console.log(`‚ú® Service-Felder angezeigt f√ºr: ${serviceTyp}`);
            }

            // Lackierung-Felder auch f√ºr "alle" Services zeigen
            if (serviceTyp === 'lackier' || serviceTyp === 'alle') {
                const lackierDiv = document.getElementById('lackierung-felder');
                if (lackierDiv) {
                    lackierDiv.style.display = 'block';
                    // console.log('üé® Lackier-Informationen angezeigt');
                }
            }

            // NEU: Bei Dellen ‚Üí Pr√ºfe Lackschaden-Wert f√ºr Lackier-Felder
            if (serviceTyp === 'dellen') {
                toggleDellenLackierung();
            }

            // Pflichtfelder dynamisch anpassen
            updateRequiredFields(serviceTyp);

            // NEU: Tabellen ein/ausblenden basierend auf Service
            toggleTabellenByService(serviceTyp);

            // üÜï MULTI-SERVICE: Disable checkbox for current primary service
            updateAdditionalServicesCheckboxes(serviceTyp);
        }

        // üÜï MULTI-SERVICE: Update Additional Services Checkboxes
        function updateAdditionalServicesCheckboxes(primaryService) {
            // Reset all checkboxes: enable and uncheck
            document.querySelectorAll('.checkbox-card').forEach(card => {
                const checkbox = card.querySelector('.additional-service-checkbox');
                const serviceValue = card.getAttribute('data-service');

                if (serviceValue === primaryService) {
                    // Disable and uncheck primary service checkbox
                    card.classList.add('disabled');
                    checkbox.disabled = true;
                    checkbox.checked = false;
                } else {
                    // Enable all other checkboxes
                    card.classList.remove('disabled');
                    checkbox.disabled = false;
                }
            });

            // console.log(`üÜï Multi-Service: Haupt-Service "${primaryService}" von zus√§tzlichen Services ausgeschlossen`);
        }

        // üÜï MULTI-SERVICE: Show/Hide service fields for additional services
        function toggleAdditionalServiceFields() {
            // Get all checked additional services
            const checkedServices = Array.from(document.querySelectorAll('.additional-service-checkbox:checked'))
                .map(cb => cb.value);

            // console.log(`üÜï Multi-Service: ${checkedServices.length} zus√§tzliche Services ausgew√§hlt:`, checkedServices);

            // Show service-specific fields for each checked additional service
            checkedServices.forEach(serviceTyp => {
                const felderDiv = document.getElementById(`${serviceTyp}-felder`);
                if (felderDiv) {
                    felderDiv.style.display = 'block';
                    // console.log(`   ‚úÖ Felder angezeigt f√ºr: ${serviceTyp}`);
                }
            });
        }

        // üé® DELLEN + LACKSCHADEN LOGIC
        function toggleDellenLackierung() {
            const serviceTyp = document.getElementById('serviceTyp').value;
            const lackschadenWert = document.getElementById('lackschaden').value;
            const lackierDiv = document.getElementById('lackierung-felder');
            const lackierungSection = document.getElementById('lackierungSection');

            if (!lackierDiv) return;

            // Nur f√ºr Dellen-Service relevant
            // Phase 2 UX: Lackierung-Tabelle IMMER versteckt (wird in entwuerfe-bearbeiten.html ausgef√ºllt)
            if (serviceTyp === 'dellen') {
                if (lackschadenWert === 'ja') {
                    // Phase 2 UX: Lackier-Felder bleiben versteckt
                    lackierDiv.style.display = 'none';
                    if (lackierungSection) lackierungSection.style.display = 'none';
                    // console.log('üé® Phase 2 UX: Lackier-Felder versteckt (wird in entwuerfe-bearbeiten.html ausgef√ºllt)');
                } else {
                    lackierDiv.style.display = 'none';
                    if (lackierungSection) lackierungSection.style.display = 'none';
                    // console.log('üîß Lackier-Felder versteckt (Dellen ohne Lackschaden)');
                }
            }
        }

        // ‚ú® DYNAMISCHE PFLICHTFELDER - Verhindert "invalid form control" Warnungen
        function updateRequiredFields(serviceTyp) {
            // Service-Feld-Mapping: Welche Felder sind f√ºr welchen Service PFLICHT?
            const serviceRequiredFields = {
                'lackierung': ['farbnummer'],
                'alle': ['farbnummer'],
                'reifen': ['reifengroesse', 'reifentyp', 'reifenanzahl'],
                'glas': ['glasart', 'schadengroesse', 'glasposition'],
                'klima': ['klimaproblem'],
                'dellen': ['dellenanzahl', 'dellengroesse'],
                'mechanik': ['mechanik-problem'],
                'versicherung': ['versicherung-schadensnummer', 'versicherung-name'],
                'pflege': ['pflege-paket'],
                'tuev': ['tuev-faelligkeit'],
                'folierung': ['folierungArt', 'folierungMaterial', 'folierungFarbe'],
                'steinschutz': ['steinschutzUmfang', 'steinschutzMaterial'],
                'werbebeklebung': ['werbebeklebungUmfang', 'werbebeklebungKomplexitaet', 'werbebeklebungText']
            };

            // ALLE m√∂glichen service-spezifischen Felder
            const allServiceFields = [
                // Lackierung
                'farbnummer',
                // Reifen
                'reifengroesse', 'reifentyp', 'reifenanzahl',
                // Glas
                'glasart', 'schadengroesse', 'glasposition',
                // Klima
                'klimaproblem', 'letzte_wartung',
                // Dellen
                'dellenanzahl', 'dellengroesse', 'dellenpositionen',
                // Mechanik
                'mechanik-problem', 'mechanik-symptome',
                // Versicherung
                'versicherung-schadensnummer', 'versicherung-name', 'versicherung-schadendatum', 'versicherung-hergang',
                // Pflege
                'pflege-paket', 'pflege-zusatz',
                // T√úV
                'tuev-faelligkeit', 'tuev-maengel',
                // Folierung
                'folierungArt', 'folierungMaterial', 'folierungFarbe', 'folierungDesign', 'folierungInfo',
                // Steinschutz
                'steinschutzUmfang', 'steinschutzMaterial', 'steinschutzBereiche', 'steinschutzInfo',
                // Werbebeklebung
                'werbebeklebungUmfang', 'werbebeklebungKomplexitaet', 'werbebeklebungText', 'werbebeklebungFarbanzahl', 'werbebeklebungInfo'
            ];

            // SCHRITT 1: ALLE Felder auf OPTIONAL setzen
            allServiceFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) field.required = false;
            });

            // SCHRITT 2: Lackart Radio-Buttons auf OPTIONAL setzen
            const lackartRadios = document.querySelectorAll('input[name="lackart"]');
            lackartRadios.forEach(radio => radio.required = false);

            // SCHRITT 3: NUR aktuelle Service-Felder PFLICHT machen
            const requiredFields = serviceRequiredFields[serviceTyp] || [];
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) field.required = true;
            });

            // SCHRITT 4: Lackart PFLICHT f√ºr Lackierung/Alle
            if (serviceTyp === 'lackier' || serviceTyp === 'alle') {
                lackartRadios.forEach(radio => radio.required = true);
            }

            // NEU - SCHRITT 5: Lackschaden bei Dellen ‚Üí Farbnummer & Lackart PFLICHT
            if (serviceTyp === 'dellen') {
                const lackschadenSelect = document.getElementById('lackschaden');
                const lackschadenWert = lackschadenSelect ? lackschadenSelect.value : '';
                const farbnummerInput = document.getElementById('farbnummer');

                if (lackschadenWert === 'ja') {
                    if (farbnummerInput) {
                        farbnummerInput.required = true;
                    }
                    lackartRadios.forEach(radio => radio.required = true);
                    // console.log('üé® Farbnummer & Lackart: PFLICHT (Dellen + Lackschaden)');
                }
            }

            // console.log(`‚úÖ Required fields updated: ${serviceTyp} (${requiredFields.length} Pflichtfelder)`);
        }

        /**
         * Blendet Tabellen ein/aus basierend auf Service-Typ
         * @param {string} serviceTyp - Der gew√§hlte Service (z.B. "lackier", "dellen", etc.)
         */
        function toggleTabellenByService(serviceTyp) {
            const ersatzteileSection = document.getElementById('ersatzteileSection');
            const arbeitslohnSection = document.getElementById('arbeitslohnSection');
            const lackierungSection = document.getElementById('lackierungSection');
            const materialienSection = document.getElementById('materialienSection');

            // Service-Matrix: Welche Tabellen f√ºr welchen Service?
            // Phase 2 UX: lackierung IMMER false (wird in entwuerfe-bearbeiten.html ausgef√ºllt)
            const tabellenConfig = {
                'lackier': { ersatzteile: false, arbeitslohn: false, lackierung: false, materialien: false },
                'reifen': { ersatzteile: false, arbeitslohn: false, lackierung: false, materialien: false },
                'mechanik': { ersatzteile: false, arbeitslohn: false, lackierung: false, materialien: false },
                'pflege': { ersatzteile: false, arbeitslohn: false, lackierung: false, materialien: false },
                'tuev': { ersatzteile: false, arbeitslohn: false, lackierung: false, materialien: false },
                'versicherung': { ersatzteile: false, arbeitslohn: false, lackierung: false, materialien: false },
                'glas': { ersatzteile: false, arbeitslohn: false, lackierung: false, materialien: false },
                'klima': { ersatzteile: false, arbeitslohn: false, lackierung: false, materialien: false },
                'dellen': { ersatzteile: false, arbeitslohn: false, lackierung: false, materialien: false },
                'folierung': { ersatzteile: false, arbeitslohn: false, lackierung: false, materialien: false },
                'steinschutz': { ersatzteile: false, arbeitslohn: false, lackierung: false, materialien: false },
                'werbebeklebung': { ersatzteile: false, arbeitslohn: false, lackierung: false, materialien: false }
            };

            // Default: Alle versteckt (Phase 2 UX)
            const config = tabellenConfig[serviceTyp] || { ersatzteile: false, arbeitslohn: false, lackierung: false, materialien: false };

            // Tabellen ein/ausblenden
            if (ersatzteileSection) ersatzteileSection.style.display = config.ersatzteile ? 'block' : 'none';
            if (arbeitslohnSection) arbeitslohnSection.style.display = config.arbeitslohn ? 'block' : 'none';
            if (lackierungSection) lackierungSection.style.display = config.lackierung ? 'block' : 'none';
            if (materialienSection) materialienSection.style.display = config.materialien ? 'block' : 'none';

            // Dellen-Spezial-Fall: Lackierung conditional basierend auf "Lackschaden"
            if (serviceTyp === 'dellen') {
                toggleDellenLackierung(); // Bestehende Funktion nutzen
            }

        }

        // Event Listener f√ºr serviceTyp Dropdown (sofort nach Definition)
        document.addEventListener('DOMContentLoaded', function() {
            const serviceTypSelect = document.getElementById('serviceTyp');
            if (serviceTypSelect) {
                window.listenerRegistry.registerDOM(serviceTypSelect, 'change', function() {
                    toggleServiceFelder();
                    toggleAdditionalServiceFields();
                }, 'Service Typ Select Change');
            }

            toggleServiceFelder();

            // MULTI-SERVICE: Event Listeners f√ºr Additional Service Checkboxes
            const additionalServiceCheckboxes = document.querySelectorAll('.additional-service-checkbox');
            additionalServiceCheckboxes.forEach(checkbox => {
                window.listenerRegistry.registerDOM(checkbox, 'change', function() {
                    toggleServiceFelder();
                    toggleAdditionalServiceFields();
                }, `Additional Service Checkbox: ${checkbox.value}`);
            });

            // Initiale Tabellen-Sichtbarkeit setzen
            const initialService = document.getElementById('serviceTyp')?.value || 'lackier';
            toggleTabellenByService(initialService);

            // Event Listener f√ºr Lackschaden Select (Dellen + Lackschaden)
            const lackschadenSelect = document.getElementById('lackschaden');
            if (lackschadenSelect) {
                window.listenerRegistry.registerDOM(lackschadenSelect, 'change', toggleDellenLackierung, 'Lackschaden Select Change');
            }

            // Event Listener f√ºr Folierung Material (Spezialtyp conditional)
            const folierungMaterialSelect = document.getElementById('folierungMaterial');
            if (folierungMaterialSelect) {
                window.listenerRegistry.registerDOM(folierungMaterialSelect, 'change', function() {
                    const spezialTypGroup = document.getElementById('folierungSpezialTypGroup');
                    if (spezialTypGroup) {
                        if (folierungMaterialSelect.value === 'spezial') {
                            spezialTypGroup.style.display = 'block';
                            document.getElementById('folierungSpezialTyp').setAttribute('required', 'required');
                        } else {
                            spezialTypGroup.style.display = 'none';
                            document.getElementById('folierungSpezialTyp').removeAttribute('required');
                            document.getElementById('folierungSpezialTyp').value = '';
                        }
                    }
                }, 'Folierung Material Select Change');
            }

            // NEU: Event Listener f√ºr Folierung Art (Bereiche conditional)
            const folierungArtSelect = document.getElementById('folierungArt');
            if (folierungArtSelect) {
                window.listenerRegistry.registerDOM(folierungArtSelect, 'change', function() {
                    const bereicheGroup = document.getElementById('folierungBereicheGroup');
                    if (bereicheGroup) {
                        if (folierungArtSelect.value === 'teilfolierung' || folierungArtSelect.value === 'akzente') {
                            bereicheGroup.style.display = 'block';
                            // Set required for at least one checkbox
                            document.querySelectorAll('input[name="folierungBereiche"]').forEach(cb => cb.setAttribute('required', 'required'));
                        } else {
                            bereicheGroup.style.display = 'none';
                            // Remove required and uncheck all
                            document.querySelectorAll('input[name="folierungBereiche"]').forEach(cb => {
                                cb.removeAttribute('required');
                                cb.checked = false;
                            });
                        }
                    }
                }, 'Folierung Art Select Change');
            }
        });

        // Firebase initialisieren und Kunden laden
        document.addEventListener('DOMContentLoaded', async function() {
            initRadioVisuals();

            // Werkstatt-Branding laden (Logo + Name aus admin-einstellungen)
            try {
                const settings = await window.settingsManager.loadSettings();
                if (settings?.profil) {
                    document.title = `Fahrzeug-Annahme | ${settings.profil.name}`;

                    const werkstattNameEl = document.getElementById('werkstattName');
                    if (werkstattNameEl && settings.profil.name) {
                        werkstattNameEl.textContent = settings.profil.name;
                    }

                    if (settings.profil.logoUrl) {
                        const logoContainer = document.getElementById('werkstattLogo');
                        if (logoContainer) {
                            logoContainer.innerHTML = `
                                <img src="${settings.profil.logoUrl}"
                                     alt="${settings.profil.name}"
                                     style="height: 60px; width: auto; object-fit: contain;">
                            `;
                        }
                    }
                }
            } catch (error) {
                console.warn('[annahme] Werkstatt-Branding konnte nicht geladen werden:', error);
            }

            // Pr√ºfe ob Nachannahme-Modus (von Partner-Fahrzeugen)
            const urlParams = new URLSearchParams(window.location.search);
            const nachannahmeModus = urlParams.get('mode') === 'nachannahme';
            const fahrzeugId = urlParams.get('id');

            if (nachannahmeModus && fahrzeugId) {
                const nachannahmeDataStr = sessionStorage.getItem('partnerFahrzeugNachannahme');
                if (nachannahmeDataStr) {
                    const nachannahmeData = JSON.parse(nachannahmeDataStr);

                    // Hinweis-Banner anzeigen
                    const form = document.getElementById('annahmeForm');
                    const banner = document.createElement('div');
                    banner.className = 'info-box';
                    banner.style.cssText = 'background: rgba(33, 150, 243, 0.15); border-color: rgba(33, 150, 243, 0.4); margin-bottom: var(--space-6);';
                    banner.innerHTML = `
                        <div class="info-box-content">
                            <strong>üîÑ PHYSISCHE NACHANNAHME</strong>
                            <p>
                                Fahrzeug: <strong>${nachannahmeData.marke} ${nachannahmeData.modell}</strong> ‚Ä¢ Kennzeichen: <strong>${nachannahmeData.kennzeichen}</strong><br>
                                Die Fahrzeugdaten sind vorausgef√ºllt. Erg√§nzen Sie jetzt:<br>
                                üì∏ Schadenfotos ‚Ä¢ ‚úçÔ∏è Kundenunterschrift ‚Ä¢ üìã Zus√§tzliche Notizen
                            </p>
                        </div>
                    `;
                    form.insertBefore(banner, form.firstChild);
                    feather.replace();

                    // Formular vorausf√ºllen (read-only)
                    document.getElementById('kennzeichen').value = nachannahmeData.kennzeichen;
                    document.getElementById('kennzeichen').readOnly = true;
                    document.getElementById('marke').value = nachannahmeData.marke || '';
                    document.getElementById('marke').readOnly = true;
                    document.getElementById('modell').value = nachannahmeData.modell || '';
                    document.getElementById('modell').readOnly = true;
                    document.getElementById('baujahrVon').value = nachannahmeData.baujahrVon || '';
                    document.getElementById('baujahrVon').readOnly = true;
                    document.getElementById('baujahrBis').value = nachannahmeData.baujahrBis || '';
                    document.getElementById('baujahrBis').readOnly = true;
                    document.getElementById('kmstand').value = nachannahmeData.kmstand || '';
                    document.getElementById('vin').value = nachannahmeData.vin || '';
                    document.getElementById('farbnummer').value = nachannahmeData.farbnummer || '';
                    document.getElementById('farbnummer').readOnly = true;
                    document.getElementById('farbname').value = nachannahmeData.farbname || '';
                    document.getElementById('lackart').value = nachannahmeData.lackart || '';
                    document.getElementById('kundenname').value = nachannahmeData.kundenname || '';
                    document.getElementById('kundenname').readOnly = true;
                    document.getElementById('notizen').value = nachannahmeData.schadenBeschreibung || '';

                    // üîÑ NEW: Map serviceData to form fields for ALL 12 services
                    if (nachannahmeData.serviceData && nachannahmeData.serviceTyp) {
                        const sd = nachannahmeData.serviceData;
                        // console.log('üîÑ Mapping serviceData f√ºr Service:', nachannahmeData.serviceTyp, sd);

                        switch (nachannahmeData.serviceTyp) {
                            case 'folierung':
                                if (sd.folierungArt) {
                                    document.getElementById('folierungArt').value = sd.folierungArt;
                                    // Trigger bereiche visibility
                                    if (sd.folierungArt === 'teilfolierung' || sd.folierungArt === 'akzente') {
                                        document.getElementById('folierungBereicheGroup').style.display = 'block';
                                    }
                                }
                                if (sd.folierungMaterial) {
                                    document.getElementById('folierungMaterial').value = sd.folierungMaterial;
                                    // Trigger spezialTyp visibility
                                    if (sd.folierungMaterial === 'spezial') {
                                        document.getElementById('folierungSpezialTypGroup').style.display = 'block';
                                    }
                                }
                                if (sd.folierungSpezialTyp) document.getElementById('folierungSpezialTyp').value = sd.folierungSpezialTyp;
                                if (sd.folierungFarbe) document.getElementById('folierungFarbe').value = sd.folierungFarbe;
                                if (sd.folierungBereiche && Array.isArray(sd.folierungBereiche)) {
                                    sd.folierungBereiche.forEach(bereich => {
                                        const checkbox = document.querySelector(`input[name="folierungBereiche"][value="${bereich}"]`);
                                        if (checkbox) checkbox.checked = true;
                                    });
                                }
                                if (sd.folierungDesign) document.getElementById('folierungDesign').value = sd.folierungDesign;
                                if (sd.folierungInfo) document.getElementById('folierungInfo').value = sd.folierungInfo;
                                break;

                            case 'steinschutz':
                                if (sd.steinschutzUmfang) document.getElementById('steinschutzUmfang').value = sd.steinschutzUmfang;
                                if (sd.steinschutzMaterial) document.getElementById('steinschutzMaterial').value = sd.steinschutzMaterial;
                                if (sd.steinschutzBereiche) {
                                    const bereicheStr = Array.isArray(sd.steinschutzBereiche) ? sd.steinschutzBereiche.join(', ') : sd.steinschutzBereiche;
                                    document.getElementById('steinschutzBereiche').value = bereicheStr;
                                }
                                if (sd.steinschutzInfo) document.getElementById('steinschutzInfo').value = sd.steinschutzInfo;
                                break;

                            case 'werbebeklebung':
                                if (sd.werbebeklebungUmfang) document.getElementById('werbebeklebungUmfang').value = sd.werbebeklebungUmfang;
                                if (sd.werbebeklebungKomplexitaet) document.getElementById('werbebeklebungKomplexitaet').value = sd.werbebeklebungKomplexitaet;
                                if (sd.werbebeklebungText) document.getElementById('werbebeklebungText').value = sd.werbebeklebungText;
                                if (sd.werbebeklebungFarbanzahl) document.getElementById('werbebeklebungFarbanzahl').value = sd.werbebeklebungFarbanzahl;
                                if (sd.werbebeklebungInfo) document.getElementById('werbebeklebungInfo').value = sd.werbebeklebungInfo;
                                break;

                            case 'reifen':
                                if (sd.dimension) document.getElementById('reifengroesse').value = sd.dimension;
                                if (sd.typ) document.getElementById('reifentyp').value = sd.typ;
                                if (sd.anzahl) document.getElementById('reifenanzahl').value = sd.anzahl;
                                if (sd.info) document.getElementById('reifenInfo').value = sd.info;
                                break;

                            case 'glas':
                                if (sd.art) document.getElementById('glasArt').value = sd.art;
                                if (sd.position) document.getElementById('glasPosition').value = sd.position;
                                if (sd.info) document.getElementById('glasInfo').value = sd.info;
                                break;

                            case 'klima':
                                if (sd.art) document.getElementById('klimaArt').value = sd.art;
                                if (sd.problem) document.getElementById('klimaProblem').value = sd.problem;
                                if (sd.info) document.getElementById('klimaInfo').value = sd.info;
                                break;

                            case 'dellen':
                                if (sd.anzahl) document.getElementById('dellenAnzahl').value = sd.anzahl;
                                if (sd.groesse) document.getElementById('dellenGroesse').value = sd.groesse;
                                if (sd.position) document.getElementById('dellenPosition').value = sd.position;
                                if (sd.info) document.getElementById('dellenInfo').value = sd.info;
                                break;

                            case 'mechanik':
                                if (sd.art) document.getElementById('mechanikArt').value = sd.art;
                                if (sd.problem) document.getElementById('mechanikProblem').value = sd.problem;
                                if (sd.info) document.getElementById('mechanikInfo').value = sd.info;
                                break;

                            case 'pflege':
                                if (sd.art) document.getElementById('pflegeArt').value = sd.art;
                                if (sd.umfang) document.getElementById('pflegeUmfang').value = sd.umfang;
                                if (sd.info) document.getElementById('pflegeInfo').value = sd.info;
                                break;

                            case 'tuev':
                                if (sd.art) document.getElementById('tuevArt').value = sd.art;
                                if (sd.termin) document.getElementById('tuevTermin').value = sd.termin;
                                if (sd.info) document.getElementById('tuevInfo').value = sd.info;
                                break;

                            case 'versicherung':
                                if (sd.art) document.getElementById('versicherungArt').value = sd.art;
                                if (sd.schadenNummer) document.getElementById('versicherungSchadenNr').value = sd.schadenNummer;
                                if (sd.versicherung) document.getElementById('versicherungName').value = sd.versicherung;
                                if (sd.info) document.getElementById('versicherungInfo').value = sd.info;
                                break;

                            case 'lackierung':
                                if (sd.art) document.getElementById('lackArt').value = sd.art;
                                if (sd.umfang) document.getElementById('lackUmfang').value = sd.umfang;
                                if (sd.info) document.getElementById('lackInfo').value = sd.info;
                                break;
                        }
                    }

                    window.istNachannahme = true;
                    window.nachannahmeFahrzeugId = fahrzeugId;
                    window.nachannahmeData = nachannahmeData;
                }
            }

            // Auto-save f√ºr Form-Inputs
            const inputs = document.querySelectorAll('#annahmeForm input, #annahmeForm textarea');
            inputs.forEach(input => {
                window.listenerRegistry.registerDOM(input, 'input', saveDraft, `Form Input Auto-Save: ${input.id || input.name}`);
            });

            // Firebase initialisieren
            try {
                if (typeof initFirebase !== 'undefined') {
                    await initFirebase();
                    if (window.firebaseInitialized && window.firebaseApp) {
                        firebaseApp = window.firebaseApp;
                        firebaseInitialized = true;
                    }
                }
            } catch (error) {
                console.warn('[annahme] Firebase nicht verf√ºgbar, verwende LocalStorage:', error);
            }

            // Auth-Check f√ºr Multi-Tenant Support
            let currentUser = null;
            let attempts = 0;
            const maxAttempts = 20;

            while (!currentUser && attempts < maxAttempts) {
                currentUser = window.authManager?.getCurrentUser();
                if (!currentUser) {
                    await new Promise(resolve => setTimeout(resolve, 250));
                    attempts++;
                }
            }

            if (!currentUser) {
                console.warn('[annahme] Kein User eingeloggt - verwende globale Collections');
            } else {
                // Partner-Zugriff auf Werkstatt-Seiten blockieren
                const userRole = currentUser.rolle || currentUser.role;
                if (userRole === 'partner') {
                    safeNavigate('./partner-app/meine-anfragen.html');
                    return;
                }
            }

            // Load Werkstatt Branding
            try {
                const settings = await window.settingsManager.loadSettings();
                if (settings?.profil) {
                    document.title = `${settings.profil.name} | Fahrzeugannahme`;

                    if (settings.profil.logoUrl) {
                        const header = document.querySelector('.mobile-header');
                        if (header) {
                            const logoContainer = document.createElement('div');
                            logoContainer.style.cssText = 'position: absolute; left: 16px; top: 50%; transform: translateY(-50%);';
                            logoContainer.innerHTML = `<img src="${settings.profil.logoUrl}" alt="${settings.profil.name}" style="height: 36px; width: auto;">`;
                            header.style.position = 'relative';
                            header.style.paddingLeft = '60px';
                            header.insertBefore(logoContainer, header.firstChild);
                        }
                    }
                }

                if (settings?.enabledServices) {
                    filterDisabledServices(settings.enabledServices);
                }
            } catch (error) {
                console.warn('[annahme] Werkstatt-Branding konnte nicht geladen werden:', error);
            }

            await loadKunden();

            // Auto-Save Entwurf wiederherstellen (nur wenn NICHT Nachannahme-Modus)
            if (!window.istNachannahme) {
                loadDraft();

                const farbnummerInput = document.getElementById('farbnummer');
                if (farbnummerInput) {
                    farbnummerInput.readOnly = false;
                }
            }

            // Form Submit Event Listener registrieren
            const formSubmitHandler = async function(e) {
                e.preventDefault();

                // ============================================
                // INPUT VALIDATION (Phase 1 Quick Wins)
                // ============================================

                // Validate Kennzeichen (required) - Neuwagen ohne Kennzeichen erlauben (2026-01-08)
                const kennzeichenValue = document.getElementById('kennzeichen').value;
                const isNeuwagen = document.getElementById('neuwagenOhneKennzeichen')?.checked || kennzeichenValue === 'NEUWAGEN';

                if (!isNeuwagen) {
                    const kennzeichenResult = window.validateKennzeichen(kennzeichenValue);
                    if (!kennzeichenResult.valid) {
                        showToast(kennzeichenResult.error, 'error');
                        document.getElementById('kennzeichen').focus();
                        return;
                    }
                } else if (!kennzeichenValue) {
                    // Neuwagen checkbox checked but no value
                    showToast('Bitte Kennzeichen eingeben oder "Neuwagen ohne Kennzeichen" aktivieren!', 'error');
                    document.getElementById('kennzeichen').focus();
                    return;
                }

                // Validate Kundenname (required)
                if (!document.getElementById('kundenname').value || !document.getElementById('kundenname').value.trim()) {
                    showToast('Bitte Kundenname eingeben!', 'error');
                    document.getElementById('kundenname').focus();
                    return;
                }

                // Validate Marke & Modell (required)
                if (!document.getElementById('marke').value || !document.getElementById('modell').value) {
                    showToast('Bitte Marke und Modell eingeben!', 'error');
                    return;
                }

                // Validate Farbnummer (NUR f√ºr Lackierung & Alle Services)
                const serviceTyp = document.getElementById('serviceTyp').value;
                if (serviceTyp === 'lackier' || serviceTyp === 'alle') {
                    const farbnummerResult = window.validateFarbnummer(document.getElementById('farbnummer').value);
                    if (!farbnummerResult.valid) {
                        showToast(farbnummerResult.error, 'error');
                        document.getElementById('farbnummer').focus();
                        return;
                    }

                    // Check if Farbnummer is provided
                    if (!document.getElementById('farbnummer').value || !document.getElementById('farbnummer').value.trim()) {
                        showToast('Bitte Farbnummer f√ºr Lackierung eingeben!', 'error');
                        document.getElementById('farbnummer').focus();
                        return;
                    }
                }

                if (photos.length === 0) {
                    showToast('Bitte mindestens 1 Foto machen!', 'error');
                    return;
                }

                // Validate VIN/FIN (optional field)
                const vinValue = document.getElementById('vin').value;
                if (vinValue && vinValue.trim()) {
                    const vinResult = window.validateVIN(vinValue);
                    if (!vinResult.valid) {
                        showToast(vinResult.error, 'error');
                        document.getElementById('vin').focus();
                        return;
                    }
                }

                // Pr√ºfe ob Unterschrift vorhanden
                const signatureData = canvas.toDataURL();
                const emptyCanvas = document.createElement('canvas');
                emptyCanvas.width = canvas.width;
                emptyCanvas.height = canvas.height;
                if (signatureData === emptyCanvas.toDataURL()) {
                    showToast('Bitte Unterschrift des Kunden einholen!', 'error');
                    return;
                }

                // werkstattId Validierung
                if (!window.werkstattId) {
                    console.error('werkstattId nicht gesetzt');
                    showToast('Fehler: Werkstatt nicht identifiziert. Bitte erneut einloggen.', 'error');
                    return;
                }

                const annahmeData = getFormData();
                const totalRows = ersatzteileData.length + arbeitslohnData.length + lackierungData.length + materialienData.length;

                // Nachannahme-Modus? Dann Duplikat-Pr√ºfung √ºberspringen
                if (!window.istNachannahme) {
                    // Normale Duplikat-Pr√ºfung
                    const kennzeichen = annahmeData.kennzeichen.toUpperCase().replace(/\s+/g, '');
                    let existingVehicles = [];

                    try {
                        if (firebaseInitialized && firebaseApp) {
                            // console.log('   ‚Üí Pr√ºfe Duplikate in Firestore...');
                            existingVehicles = await firebaseApp.getAllFahrzeuge();
                            // console.log('   ‚Üí Gefunden:', existingVehicles.length, 'Fahrzeuge');
                        } else {
                            // console.log('   ‚Üí Pr√ºfe Duplikate in LocalStorage...');
                            existingVehicles = JSON.parse(localStorage.getItem('fahrzeuge') || '[]');
                            // console.log('   ‚Üí Gefunden:', existingVehicles.length, 'Fahrzeuge');
                        }

                        const duplicate = existingVehicles.find(v => {
                            // üÜï BUGFIX 2025-11-15 (FIX #4): Safe toUpperCase() mit Null-Check
                            const existingKz = (v.kennzeichen || '').toUpperCase().replace(/\s+/g, '');
                            return existingKz === kennzeichen && v.status !== 'abgeschlossen';
                        });

                        if (duplicate) {
                            // console.log('‚ö†Ô∏è Duplikat gefunden:', duplicate.kennzeichen);

                            // üÜï BUGFIX 2025-11-15 (FIX #4): Safe toUpperCase() mit Null-Check
                            const kundenameNeu = (annahmeData.kundenname || '').toUpperCase().trim();
                            const kundenameAlt = (duplicate.kundenname || '').toUpperCase().trim();
                            const gleicherKunde = (kundenameNeu === kundenameAlt);

                            let message;
                            if (gleicherKunde) {
                                message = `‚ö†Ô∏è ACHTUNG: Kennzeichen "${annahmeData.kennzeichen}" ist bereits als "${duplicate.status}" vorhanden!\n\n` +
                                          `GLEICHER KUNDE: ${duplicate.kundenname}\n` +
                                          `Fahrzeug: ${duplicate.marke} ${duplicate.modell}\n` +
                                          `Annahme: ${duplicate.datum}\n\n` +
                                          `üí° M√∂glicherweise ist dieses Fahrzeug bereits in Bearbeitung!\n\n` +
                                          `Trotzdem als NEUEN Auftrag anlegen?`;
                            } else {
                                message = `‚ö†Ô∏è HINWEIS: Kennzeichen "${annahmeData.kennzeichen}" ist bereits vorhanden!\n\n` +
                                          `ABER ANDERER KUNDE:\n` +
                                          `Alter Auftrag: ${duplicate.kundenname} (${duplicate.marke} ${duplicate.modell})\n` +
                                          `Neuer Auftrag: ${annahmeData.kundenname}\n\n` +
                                          `üí° M√∂glicherweise Fahrzeugwechsel oder verschiedene Besitzer.\n\n` +
                                          `Als neuen Auftrag anlegen?`;
                            }

                            const proceed = confirm(message);

                            if (!proceed) {
                                // console.log('‚ùå Annahme abgebrochen - Duplikat verhindert');
                                return;
                            }
                            // console.log('‚úÖ User hat Duplikat best√§tigt - fahre fort');
                        } else {
                            // console.log('‚úÖ Kein Duplikat gefunden');
                        }
                    } catch (error) {
                        console.error('‚ö†Ô∏è Duplikat-Pr√ºfung fehlgeschlagen:', error);
                        console.error('   Details:', error.message);
                    }
                }

                // Speicherung
                // console.log('4Ô∏è‚É£ Speicherung starten...');
                let materialRequestsCreated = 0; // Track PDF-imported material requests
                try {
                    if (firebaseInitialized && firebaseApp) {
                        // console.log('üíæ Hybrid-Speicherung: Daten ‚Üí Firestore, Fotos ‚Üí LocalStorage');

                        // Nachannahme-Modus: UPDATE statt CREATE
                        if (window.istNachannahme) {
                            // console.log('üîÑ NACHANNAHME-MODUS: Aktualisiere bestehendes Fahrzeug');

                            // console.log('   a) Speichere Nachannahme-Fotos in Firestore...');
                            try {
                                await firebaseApp.savePhotosToFirestore(window.nachannahmeFahrzeugId, annahmeData.photos, 'vorher');
                                // console.log('   ‚úÖ Fotos in Firestore gespeichert');
                            } catch (e) {
                                console.error('   ‚ùå Foto-Speicherung in Firestore fehlgeschlagen:', e);
                                firebaseApp.savePhotosLocal(window.nachannahmeFahrzeugId, annahmeData.photos, 'vorher');
                            }

                            // console.log('   b) UPDATE Fahrzeugdaten in Firestore...');
                            const updateData = {
                                photos: annahmeData.photos,
                                signature: annahmeData.signature,
                                notizen: annahmeData.notizen || window.nachannahmeData.schadenBeschreibung,
                                kmstand: annahmeData.kmstand,
                                vin: annahmeData.vin,
                                farbname: annahmeData.farbname,
                                lackart: annahmeData.lackart,
                                datum: annahmeData.datum,
                                zeit: annahmeData.zeit,
                                physischeAnnahmeErfolgt: true,
                                physischeAnnahmeDatum: new Date().toISOString(),
                                serviceDetails: annahmeData.serviceDetails,
                                lastModified: Date.now()
                            };

                            await firebaseApp.updateFahrzeug(window.nachannahmeFahrzeugId, updateData);
                            // console.log('   ‚úÖ Fahrzeug aktualisiert');

                            sessionStorage.removeItem('partnerFahrzeugNachannahme');
                            clearDraft();

                            showToast('Physische Annahme erfolgreich! Das Fahrzeug wurde mit Fotos und Unterschrift erg√§nzt.', 'success', 4000);
                            setTimeout(() => safeNavigate('index.html'), 1500);
                            return;
                        }

                        // NORMALE ANNAHME
                        // console.log('   a) Registriere Kundenbesuch...');

                        // üîß BUG #9 FIX (2025-11-20): Email-Format-Validierung BEFORE customer registration
                        // üîß SEC-3.1 FIX (2025-12-14): RFC 5322 compliant regex
                        if (annahmeData.kundenEmail) {
                            const emailRegex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
                            if (!emailRegex.test(annahmeData.kundenEmail)) {
                                showToast('‚ùå Ung√ºltige Email-Adresse. Bitte korrigieren Sie die Email.', 'error');
                                console.error('‚ùå Email-Validierung fehlgeschlagen:', annahmeData.kundenEmail);
                                return;
                            }
                        }

                        // üîß BUG #6 FIX (2025-11-30): Telefon-Format-Validierung
                        if (annahmeData.telefon) {
                            const digitsOnly = annahmeData.telefon.replace(/\D/g, '');
                            if (digitsOnly.length < 6 || digitsOnly.length > 15) {
                                showToast('‚ùå Ung√ºltige Telefonnummer. Mindestens 6, maximal 15 Ziffern.', 'error');
                                console.error('‚ùå Telefon-Validierung fehlgeschlagen:', annahmeData.telefon);
                                return;
                            }
                        }

                        // BUGFIX 2025-11-04: Pass complete customer data object
                        const kundeId = await firebaseApp.registriereKundenbesuch({
                            name: annahmeData.kundenname,
                            email: annahmeData.kundenEmail || '',
                            telefon: annahmeData.telefon || '',
                            notizen: annahmeData.notizen || ''
                        });
                        if (kundeId) {
                            annahmeData.kundenId = kundeId;
                            // console.log('   ‚úÖ Kunde registriert, ID:', kundeId);
                        } else {
                            // console.log('   ‚ö†Ô∏è Keine KundenID erhalten');
                        }

                        // console.log('   b) Speichere Fotos in Firestore...');
                        try {
                            await firebaseApp.savePhotosToFirestore(annahmeData.id, annahmeData.photos, 'vorher');
                            // console.log('   ‚úÖ Fotos in Firestore gespeichert');
                        } catch (e) {
                            console.error('   ‚ùå Fehler beim Speichern der Fotos in Firestore:', e);
                            console.warn('   ‚Üí Fallback: Speichere Fotos in LocalStorage');
                            firebaseApp.savePhotosLocal(annahmeData.id, annahmeData.photos, 'vorher');
                        }

                        // console.log('   c) Speichere Fahrzeugdaten in Firestore...');
                        const dataForFirestore = {...annahmeData};

                        // BUGFIX 2025-11-04: Speichere partnerEmail f√ºr Firestore Security Rules
                        // Erm√∂glicht Partner-Zugriff auf ihre eigenen Fahrzeuge
                        if (annahmeData.kundenEmail && annahmeData.kundenEmail.includes('@')) {
                            dataForFirestore.partnerEmail = annahmeData.kundenEmail;
                            // console.log('   üîë partnerEmail gesetzt:', dataForFirestore.partnerEmail);
                        }

                        delete dataForFirestore.photos;

                        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                        // SAFETY CHECK: Sicherstellen, dass editedData existiert
                        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                        if (!dataForFirestore.pdfImport || !dataForFirestore.pdfImport.editedData) {
                            console.error('‚ùå KRITISCHER FEHLER: pdfImport.editedData fehlt!');
                            console.error('   Wiederherstelle von globalen Arrays...');

                            dataForFirestore.pdfImport = {
                                imported: !!pdfData,
                                editedData: {
                                    ersatzteile: JSON.parse(JSON.stringify(ersatzteileData)),
                                    arbeitslohn: JSON.parse(JSON.stringify(arbeitslohnData)),
                                    lackierung: JSON.parse(JSON.stringify(lackierungData)),
                                    materialien: JSON.parse(JSON.stringify(materialienData))
                                },
                                manualPriceOverride: document.getElementById('manualPriceOverride')?.checked || false
                            };

                            // console.log('‚úÖ editedData wiederhergestellt:', {
                                ersatzteile: dataForFirestore.pdfImport.editedData.ersatzteile.length,
                                arbeitslohn: dataForFirestore.pdfImport.editedData.arbeitslohn.length,
                                lackierung: dataForFirestore.pdfImport.editedData.lackierung.length,
                                materialien: dataForFirestore.pdfImport.editedData.materialien.length
                            });
                        }

                        // Zus√§tzliche Validierung: Warnen wenn Daten verloren gegangen sind
                        const totalRows = ersatzteileData.length + arbeitslohnData.length + lackierungData.length + materialienData.length;
                        const savedRows = (dataForFirestore.pdfImport.editedData.ersatzteile?.length || 0) +
                                          (dataForFirestore.pdfImport.editedData.arbeitslohn?.length || 0) +
                                          (dataForFirestore.pdfImport.editedData.lackierung?.length || 0) +
                                          (dataForFirestore.pdfImport.editedData.materialien?.length || 0);

                        if (totalRows > 0 && savedRows === 0) {
                            console.error('‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è WARNUNG: Tabellen-Daten gehen verloren!');
                            console.error('   Global:', totalRows, 'Zeilen | Zu speichern:', savedRows, 'Zeilen');
                        } else if (totalRows === savedRows) {
                            // console.log(`‚úÖ Tabellen-Daten-Validierung erfolgreich: ${totalRows} Zeilen werden gespeichert`);
                        }

                        await firebaseApp.saveFahrzeug(dataForFirestore);
                        // console.log('   ‚úÖ Fahrzeug in Firestore gespeichert');

                        // ============================================
                        // ZENTRALE ERSATZTEILE-DB: Dual Save (Auftrag + Collection)
                        // ============================================
                        if (ersatzteileData && ersatzteileData.length > 0) {
                            // console.log('   üóÑÔ∏è ZENTRALE DB: Speichere Ersatzteile in zentrale Collection...');
                            try {
                                await saveErsatzteileToCentralDB(
                                    ersatzteileData,
                                    annahmeData.id,
                                    annahmeData.kennzeichen,
                                    annahmeData.kundenname
                                );
                                // console.log(`   ‚úÖ ${ersatzteileData.length} Ersatzteile in zentraler DB gespeichert`);
                            } catch (error) {
                                console.error('   ‚ùå Fehler beim Speichern in zentrale Ersatzteile-DB:', error);
                            }

                            // üîß BUG FIX (2025-11-27): Manuell eingegebene Ersatzteile zu Bestellungen konvertieren
                            // PROBLEM: ersatzteileData (manuell) wurde NICHT zu Bestellungen konvertiert
                            // L√ñSUNG: autoConvertErsatzteileToBestellungen auch f√ºr ersatzteileData aufrufen
                            // console.log('   üîÑ AUTO-PIPELINE: Konvertiere manuell eingegebene Ersatzteile zu Bestellungen...');
                            try {
                                const bestellungenCreated = await autoConvertErsatzteileToBestellungen(
                                    ersatzteileData,
                                    annahmeData.kennzeichen,
                                    annahmeData.id
                                );
                                if (bestellungenCreated > 0) {
                                    // console.log(`   ‚úÖ ${bestellungenCreated} Bestellungen aus manuellen Ersatzteilen erstellt`);
                                }
                            } catch (error) {
                                console.error('   ‚ùå Fehler bei Auto-Konvertierung (manuell):', error);
                            }
                        }

                        // ============================================
                        // PDF-IMPORT: Ersatzteile als Material-Requests speichern
                        // ============================================
                        if (pdfData && pdfData.ersatzteile && pdfData.ersatzteile.length > 0) {
                            // console.log('   üì¶ PDF-Import: Speichere Ersatzteile als Material-Requests...');
                            try {
                                materialRequestsCreated = await savePdfErsatzteileAsRequests(
                                    pdfData.ersatzteile,
                                    annahmeData.kennzeichen
                                );
                                if (materialRequestsCreated > 0) {
                                    // console.log(`   ‚úÖ ${materialRequestsCreated} Ersatzteile als Material-Requests gespeichert`);
                                }
                            } catch (error) {
                                console.error('   ‚ùå Fehler beim Speichern der Ersatzteile:', error);
                            }

                            // ‚ùå REMOVED (2025-11-27): pdfData.ersatzteile Konvertierung
                            // GRUND: PDF-Ersatzteile werden via renderErsatzteilePreview() in ersatzteileData geladen.
                            //        ersatzteileData wird jetzt oben (Zeile 3583-3598) zu Bestellungen konvertiert.
                            //        Diese alte Konvertierung w√ºrde DUPLIKATE erzeugen!
                            // SIEHE: Fix f√ºr Bug B - alle Ersatzteile (manuell + PDF) werden jetzt unified behandelt
                        }

                        // üîß FIX (2025-12-10): Doppelte Kunden-Registrierung entfernt
                        // kundenId wird bereits bei Zeile 3908 registriert und in annahmeData.kundenId gespeichert
                        // saveFahrzeug() (Zeile 3983) speichert dann annahmeData inkl. kundenId
                        // Dieser zweite Aufruf war √ºberfl√ºssig und erzeugte Duplikat-Risiko

                        // ============================================
                        // QR-CODE FEATURE: Partner Account & Auto-Login Token
                        // ============================================
                        // console.log('   e) QR-Code Feature: Partner Account & Token...');

                        // Check ob Kunden-Email vorhanden ist
                        if (annahmeData.kundenEmail && annahmeData.kundenEmail.includes('@')) {
                            // console.log('   ‚Üí Kunde hat Email:', annahmeData.kundenEmail);

                            try {
                                // STEP 1: Partner Account erstellen/pr√ºfen
                                // console.log('   ‚Üí Calling ensurePartnerAccount...');
                                const ensurePartnerFn = window.functions.httpsCallable('ensurePartnerAccount');
                                const partnerResult = await ensurePartnerFn({
                                    email: annahmeData.kundenEmail,
                                    kundenname: annahmeData.kundenname,
                                    werkstattId: window.werkstattId // ‚úÖ SECURITY FIX: No 'mosbach' fallback
                                });

                                // console.log('   ‚úÖ Partner Account:', partnerResult.data.message);
                                // console.log('   ‚Üí Partner ID:', partnerResult.data.partnerId);
                                // console.log('   ‚Üí Neuer Partner:', partnerResult.data.isNewPartner);

                                // STEP 2: Auto-Login Token erstellen
                                // console.log('   ‚Üí Calling createPartnerAutoLoginToken...');
                                const createTokenFn = window.functions.httpsCallable('createPartnerAutoLoginToken');
                                const tokenResult = await createTokenFn({
                                    partnerId: partnerResult.data.partnerId,
                                    werkstattId: window.werkstattId, // ‚úÖ SECURITY FIX: No 'mosbach' fallback
                                    fahrzeugId: annahmeData.id,
                                    expiresInDays: 30
                                });

                                // console.log('   ‚úÖ Token erstellt');
                                // console.log('   ‚Üí Login URL:', tokenResult.data.loginUrl);
                                // console.log('   ‚Üí G√ºltig bis:', tokenResult.data.expiresAt);

                                // STEP 3: Daten f√ºr PDF speichern
                                annahmeData.qrCodeUrl = tokenResult.data.loginUrl;
                                annahmeData.qrCodeExpiresAt = tokenResult.data.expiresAt;
                                annahmeData.isNewPartner = partnerResult.data.isNewPartner;
                                annahmeData.partnerPassword = partnerResult.data.generatedPassword || null; // nur bei neuen Partnern

                                // STEP 2.5: Create partnerAnfrage for customer portal
                                // console.log('   üîß [STEP 2.5] Creating partnerAnfrage for customer portal...');
                                try {
                                    const anfrageId = 'req_' + Date.now();

                                    // üÜï BUGFIX 2025-11-04: Werkstatt-initiiert workflow
                                    // If price is agreed on-site (vereinbarterPreis > 0), directly mark as "beauftragt"
                                    // Otherwise, normal flow: "neu" ‚Üí customer confirms ‚Üí "beauftragt"
                                    const hasAgreedPrice = annahmeData.vereinbarterPreis && parseFloat(annahmeData.vereinbarterPreis) > 0;
                                    const isWerkstattInitiiert = hasAgreedPrice;

                                    const anfrageData = {
                                        id: anfrageId,
                                        partnerId: partnerResult.data.partnerId,
                                        partnerName: annahmeData.kundenname,
                                        serviceTyp: annahmeData.serviceTyp || 'lackier',
                                        timestamp: new Date().toISOString(),
                                        erstelltAm: new Date().toISOString(),

                                        // Vehicle reference
                                        referenzType: 'kennzeichen',
                                        kennzeichen: annahmeData.kennzeichen,
                                        auftragsnummer: null,

                                        // Vehicle data from intake form
                                        marke: annahmeData.marke || null,
                                        modell: annahmeData.modell || null,
                                        baujahr: annahmeData.baujahrVon ? parseInt(annahmeData.baujahrVon) : null,
                                        kilometerstand: annahmeData.kmstand ? parseInt(annahmeData.kmstand) : null,
                                        vin: annahmeData.vin || null,

                                        // üÜï BUGFIX 2025-11-04: Add missing paint fields (CRITICAL for paint shop!)
                                        farbname: annahmeData.farbname || null,           // Paint name (e.g., "Silber Metallic")
                                        farbnummer: annahmeData.farbnummer || null,       // Paint code (e.g., "LC9Z") - CRITICAL!
                                        lackart: annahmeData.lackart || null,             // Paint type (Uni/Metallic/Perleffekt)
                                        farbvariante: annahmeData.farbvariante || null,   // Paint variant details

                                        // Service description
                                        schadenBeschreibung: annahmeData.notizen || 'Fahrzeug zur Begutachtung eingereicht',
                                        serviceData: annahmeData.serviceDetails || {},

                                        // üÜï BUGFIX 2025-11-04: Add missing customer & delivery fields
                                        kundenEmail: annahmeData.kundenEmail || null,
                                        kundenTelefon: annahmeData.telefon || null,
                                        geplantesAbnahmeDatum: annahmeData.geplantesAbnahmeDatum || null,

                                        // Delivery options
                                        lieferoption: annahmeData.fahrzeugAbholung === 'ja' ? 'abholung' : 'selbst',
                                        abholserviceGewuenscht: annahmeData.fahrzeugAbholung === 'ja',
                                        abholtermin: annahmeData.abholdatum || null,
                                        abholadresse: annahmeData.abholadresse || null,
                                        abholzeit: annahmeData.abholzeit || null,
                                        abholnotiz: annahmeData.abholnotiz || null,
                                        ersatzfahrzeugGewuenscht: document.getElementById('ersatzfahrzeugGewuenscht')?.checked || false,
                                        // üîß ENTFERNT (2025-11-27): ersatzfahrzeugAdresse war redundant mit abholadresse

                                        fotos: annahmeData.photos || [],

                                        // üÜï BUGFIX 2025-11-04: Werkstatt-initiiert workflow
                                        // If price agreed on-site, directly mark as "beauftragt" (no customer confirmation needed)
                                        status: isWerkstattInitiiert ? 'beauftragt' : 'neu',
                                        statusText: isWerkstattInitiiert ? 'Beauftragt (Werkstatt-initiiert)' : 'Neu eingegangen',
                                        werkstattInitiiert: isWerkstattInitiiert,
                                        vereinbarterPreis: hasAgreedPrice ? parseFloat(annahmeData.vereinbarterPreis) : null,

                                        kva: null,
                                        fahrzeugId: annahmeData.id // Link back to vehicle intake
                                    };

                                    // üîß BUG #8 FIX #3 (2025-11-20): Add createdBy audit trail
                                    const currentUser = firebase.auth().currentUser;

                                    // Save to Firestore with audit trail
                                    await window.getCollection('partnerAnfragen').doc(anfrageId).set({
                                        ...anfrageData,
                                        // üÜï AUDIT-TRAIL: User-Tracking f√ºr Compliance
                                        createdBy: currentUser?.displayName || currentUser?.email || 'Werkstatt',
                                        createdByUserId: currentUser?.uid || null,
                                        createdByEmail: currentUser?.email || null,
                                        createdAt: new Date().toISOString(),
                                        lastModified: firebase.firestore.FieldValue.serverTimestamp()
                                    });
                                    // console.log('   ‚úÖ [STEP 2.5] partnerAnfrage created:', anfrageId);
                                    // console.log('   üìä Data:', {
                                        partnerId: anfrageData.partnerId,
                                        status: anfrageData.status,
                                        werkstattInitiiert: anfrageData.werkstattInitiiert,
                                        vereinbarterPreis: anfrageData.vereinbarterPreis,
                                        kennzeichen: anfrageData.kennzeichen,
                                        farbnummer: anfrageData.farbnummer
                                    });

                                } catch (error) {
                                    console.error('   ‚ùå [STEP 2.5] Failed to create partnerAnfrage:', error);
                                    // Continue anyway - not critical for vehicle intake
                                    // User can still login and create manual requests
                                }

                                // console.log('   ‚úÖ QR-Code Daten bereit f√ºr PDF');

                                if (annahmeData.isNewPartner) {
                                    // console.log('   üÜï NEU-KUNDE ‚Üí Passwort wird im PDF angezeigt');
                                } else {
                                    // console.log('   ‚úÖ BESTANDSKUNDE ‚Üí Kein Passwort im PDF');
                                }

                            } catch (error) {
                                console.error('   ‚ùå QR-Code Feature fehlgeschlagen:', error);
                                console.error('   Details:', error.message);
                                // Continue ohne QR-Code - PDF wird trotzdem erstellt
                                annahmeData.qrCodeUrl = null;
                                annahmeData.partnerPassword = null;
                            }
                        } else {
                            // console.log('   ‚è≠Ô∏è Keine Kunden-Email ‚Üí QR-Code √ºbersprungen');
                            annahmeData.qrCodeUrl = null;
                            annahmeData.partnerPassword = null;
                        }

                        // üñºÔ∏è FIX: Nov 20, 2025 - Pattern 35: Convert Photo URLs to Base64 for PDF
                        // console.log('   e.5) Konvertiere Fotos zu Base64...');
                        if (annahmeData.photos && annahmeData.photos.length > 0) {
                            annahmeData.photosBase64 = await convertPhotoUrlsToBase64(annahmeData.photos);
                            // console.log(`   ‚úÖ ${annahmeData.photosBase64.length} Fotos konvertiert`);
                        } else {
                            // console.log('   ‚è≠Ô∏è Keine Fotos vorhanden');
                            annahmeData.photosBase64 = [];
                        }

                        // console.log('   f) Erstelle PDF...');
                        const pdfBlob = await createPDF(annahmeData);  // FIX 2025-11-13: Capture pdfBlob for upload
                        // console.log('   ‚úÖ PDF erstellt');

                        // Upload PDF zu Firebase Storage (FIX 2025-11-13: Moved here from localStorage path)
                        if (pdfBlob && window.storage) {
                            try {
                                // console.log('   ‚Üí Lade PDF zu Firebase Storage hoch...');
                                const pdfFileName = `Annahme_${annahmeData.kennzeichen.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toLocaleDateString('de-DE').replace(/\./g, '')}.pdf`;
                                const pdfRef = window.storage.ref(`pdfs/${annahmeData.id}/${pdfFileName}`);

                                // üÜï FIX #2: Validate PDF BEFORE upload (Security)
                                try {
                                    window.validatePDFFile(pdfBlob);
                                } catch (validationError) {
                                    console.error('‚ùå [PDF-UPLOAD] Validation failed:', validationError.message);
                                    alert(validationError.message);
                                    return; // Stop upload
                                }

                                const uploadTask = await pdfRef.put(pdfBlob);
                                const pdfUrl = await uploadTask.ref.getDownloadURL();
                                // console.log('   ‚úÖ PDF hochgeladen:', pdfUrl);

                                // Update Firestore mit PDF URL
                                await window.getCollection('fahrzeuge').doc(annahmeData.id).update({
                                    pdfUrl: pdfUrl,
                                    pdfUploadedAt: new Date().toISOString()
                                });
                                // console.log('   ‚úÖ PDF URL in Firestore gespeichert');
                            } catch (uploadError) {
                                console.error('   ‚ö†Ô∏è PDF-Upload fehlgeschlagen:', uploadError);
                                // PDF-Upload ist optional, Fahrzeug ist bereits gespeichert
                            }
                        } else {
                            console.warn('   ‚ö†Ô∏è PDF-Upload √ºbersprungen (pdfBlob oder Storage nicht verf√ºgbar)');
                        }
                    } else {
                        // console.log('üíæ LocalStorage-Modus (Firebase nicht verf√ºgbar oder offline)');
                        // console.log('   navigator.onLine:', navigator.onLine);
                        // console.log('   firebaseInitialized:', firebaseInitialized);

                        let fahrzeuge = JSON.parse(localStorage.getItem('fahrzeuge') || '[]');
                        fahrzeuge.push(annahmeData);

                        try {
                            localStorage.setItem('fahrzeuge', JSON.stringify(fahrzeuge));
                            // console.log('‚úÖ Fahrzeug in LocalStorage gespeichert');

                            if (navigator.onLine && !firebaseInitialized) {
                                console.warn('‚ö†Ô∏è Blaze Plan aktiv aber Firebase nicht initialisiert - bitte pr√ºfen!');
                            }
                        } catch (e) {
                            console.error('‚ùå Fehler beim Speichern:', e);
                            if (e.name === 'QuotaExceededError' || e.message.includes('quota')) {
                                showToast('SPEICHER VOLL! Bitte pr√ºfen Sie Ihre Internet-Verbindung. Falls Sie online sind, kontaktieren Sie den Support.', 'error', 6000);
                                return;
                            }
                            throw e;
                        }

                        // console.log('   ‚Üí Erstelle PDF...');
                        const pdfBlob = await createPDF(annahmeData);
                        // console.log('   ‚úÖ PDF erstellt');

                        // Upload PDF zu Firebase Storage
                        if (pdfBlob && window.storage) {
                            try {
                                // console.log('   ‚Üí Lade PDF zu Firebase Storage hoch...');
                                const pdfFileName = `Annahme_${annahmeData.kennzeichen.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toLocaleDateString('de-DE').replace(/\./g, '')}.pdf`;
                                const pdfRef = window.storage.ref(`pdfs/${annahmeData.id}/${pdfFileName}`);

                                // üÜï FIX #2: Validate PDF BEFORE upload (Security)
                                try {
                                    window.validatePDFFile(pdfBlob);
                                } catch (validationError) {
                                    console.error('‚ùå [PDF-UPLOAD] Validation failed:', validationError.message);
                                    alert(validationError.message);
                                    return; // Stop upload
                                }

                                const uploadTask = await pdfRef.put(pdfBlob);
                                const pdfUrl = await uploadTask.ref.getDownloadURL();

                                // console.log('   ‚úÖ PDF hochgeladen:', pdfUrl);

                                // Update Firestore mit PDF URL
                                await window.getCollection('fahrzeuge').doc(annahmeData.id).update({
                                    pdfUrl: pdfUrl,
                                    pdfUploadedAt: new Date().toISOString()
                                });
                                // console.log('   ‚úÖ Firestore mit pdfUrl aktualisiert');
                            } catch (uploadError) {
                                console.error('   ‚ö†Ô∏è PDF-Upload fehlgeschlagen:', uploadError);
                                // Fahrzeug ist bereits gespeichert, PDF-Upload ist optional
                            }
                        }
                    }

                    // console.log('‚úÖ === SPEICHERUNG ERFOLGREICH ===');
                } catch (error) {
                    console.error('‚ùå Fehler beim Speichern:', error);
                    console.error('   Error Name:', error.name);
                    console.error('   Error Message:', error.message);
                    console.error('   Stack:', error.stack);

                    // console.log('   ‚Üí Versuche LocalStorage Fallback...');
                    try {
                        let fahrzeuge = JSON.parse(localStorage.getItem('fahrzeuge') || '[]');
                        fahrzeuge.push(annahmeData);
                        localStorage.setItem('fahrzeuge', JSON.stringify(fahrzeuge));
                        // console.log('‚ö†Ô∏è Fahrzeug in LocalStorage gespeichert (Firestore-Fehler)');

                        await createPDF(annahmeData);
                        // console.log('‚úÖ PDF erstellt (Fallback)');
                    } catch (fallbackError) {
                        console.error('‚ùå Auch Fallback fehlgeschlagen:', fallbackError);
                        showToast('Speichern fehlgeschlagen! Siehe Console f√ºr Details.', 'error');
                        return;
                    }
                }

                // Aufr√§umen
                // console.log('5Ô∏è‚É£ Aufr√§umen...');
                clearDraft();
                // console.log('   ‚úÖ Entwurf gel√∂scht');

                // Success Message
                const successMessage = document.getElementById('successMessage');
                if (materialRequestsCreated > 0) {
                    successMessage.innerHTML = `‚úÖ Fahrzeug erfolgreich aufgenommen!<br>
                        <small style="font-size: 0.9em; margin-top: 8px; display: block;">
                            üì¶ ${materialRequestsCreated} Ersatzteil${materialRequestsCreated > 1 ? 'e' : ''} aus PDF importiert
                            ‚Üí Siehe <a href="material.html" style="color: #4f46e5; text-decoration: underline;">Material-√úbersicht</a>
                        </small>`;
                } else {
                    successMessage.innerHTML = '‚úÖ Fahrzeug erfolgreich aufgenommen!';
                }
                successMessage.style.display = 'block';
                // console.log('   ‚úÖ Success-Message angezeigt');

                // Auto-Redirect zur √úbersicht nach 2 Sekunden
                setTimeout(() => {
                    // console.log('   ‚Üí Weiterleitung zur √úbersicht...');
                    setTimeout(() => safeNavigate('index.html'), 1500);
                }, 2000);

                // Form zur√ºcksetzen
                document.getElementById('annahmeForm').reset();
                photos = [];
                updatePhotoGrid();
                clearSignature();
                // console.log('   ‚úÖ Formular zur√ºckgesetzt');

                // console.log('üéâ === ANNAHME ABGESCHLOSSEN ===');
            };
            window.listenerRegistry.registerDOM(document.getElementById('annahmeForm'), 'submit', formSubmitHandler, 'Annahme Form Submit');
            // console.log('‚úÖ Form Submit Listener registriert');
        });

        // ============================================
        // QUICK MODE TOGGLE: Hide/Show Sections
        // ============================================

        /**
         * Toggles Quick Mode for Entwurf creation
         * Shows only 3 fields: Kennzeichen, Kundenname, Email
         * Hides all other sections for Meister's fast draft creation
         */
        function toggleQuickMode() {
            const isQuickMode = document.getElementById('quickModeToggle').checked;

            // Sections to hide/show
            const sectionsToHide = [
                'fahrzeugdaten-section',          // Section 2: Fahrzeugdaten (Marke, Modell, etc.)
                'zusaetzliche-services-container', // Section 3: Multi-Service Checkboxes
                'photo-section',                   // Section 4: Photo Upload
                'notizen-section',                 // Section 5: Schadensbeschreibung & Preis
                'signature-section'                // Section 6: Unterschrift
            ];

            // Individual fields to hide (not in sections)
            const fieldsToHide = [
                'kostenAufschluesselungSection',  // Kostenaufschl√ºsselung (beneath notizen)
                'vereinbarterPreisGroup'           // Vereinbarter Preis (beneath kostenAufschluesselung)
            ];

            if (isQuickMode) {
                // Quick Mode ON: Hide sections
                // console.log('‚ö° Quick Mode aktiviert - zeige nur 3 Felder');

                // Hide sections
                sectionsToHide.forEach(id => {
                    const section = document.getElementById(id);
                    if (section) {
                        // Hide the section-title AND all siblings until next section-title
                        let currentElement = section;
                        while (currentElement && !currentElement.classList.contains('submit-buttons')) {
                            if (currentElement.classList.contains('section-title') && currentElement !== section) {
                                break; // Stop at next section
                            }
                            currentElement.style.display = 'none';
                            currentElement = currentElement.nextElementSibling;
                        }
                    }
                });

                // Hide individual fields
                fieldsToHide.forEach(id => {
                    const field = document.getElementById(id);
                    if (field) {
                        field.style.display = 'none';
                    }
                });

                // Remove 'required' from hidden fields
                document.querySelectorAll('input[required], textarea[required], select[required]').forEach(field => {
                    if (field.id !== 'kennzeichen' && field.id !== 'kundenname' && field.id !== 'kundenEmail') {
                        field.removeAttribute('required');
                        field.dataset.wasRequired = 'true'; // Remember for restore
                    }
                });

                showToast('‚ö° Quick Mode aktiviert - nur 3 Felder sichtbar', 'info', 3000);

            } else {
                // Quick Mode OFF: Show all sections
                // console.log('üîÑ Quick Mode deaktiviert - zeige alle Felder');

                // Show sections
                sectionsToHide.forEach(id => {
                    const section = document.getElementById(id);
                    if (section) {
                        let currentElement = section;
                        while (currentElement && !currentElement.classList.contains('submit-buttons')) {
                            if (currentElement.classList.contains('section-title') && currentElement !== section) {
                                break;
                            }
                            currentElement.style.display = '';
                            currentElement = currentElement.nextElementSibling;
                        }
                    }
                });

                // Show individual fields
                fieldsToHide.forEach(id => {
                    const field = document.getElementById(id);
                    if (field) {
                        field.style.display = '';
                    }
                });

                // Restore 'required' attributes
                document.querySelectorAll('[data-was-required="true"]').forEach(field => {
                    field.setAttribute('required', '');
                    delete field.dataset.wasRequired;
                });

                showToast('üîÑ Quick Mode deaktiviert - alle Felder sichtbar', 'info', 3000);
            }
        }

        // ============================================
        // ENTWURF-SYSTEM (MVP): Save as Draft
        // ============================================

        /**
         * Speichert Annahme als Entwurf (partnerAnfrage mit isEntwurf=true)
         * Minimum-Validierung: Nur Kennzeichen, Kunde, Email
         * Workflow: Meister ‚Üí B√ºro vervollst√§ndigt sp√§ter ‚Üí Kunde best√§tigt
         */
        async function saveAsDraft() {
            // console.log('üìù === ENTWURF SPEICHERN ===');

            // üõ°Ô∏è SECURITY: Only werkstatt users can create drafts (Pattern 6)
            // Partner-Accounts d√ºrfen KEINE Entw√ºrfe erstellen
            if (window.currentUser?.role === 'partner') {
                console.warn('üö´ Partner-Zugriff blockiert! Partner k√∂nnen keine Entw√ºrfe erstellen.');
                showToast('‚ö†Ô∏è Zugriff verweigert. Partner k√∂nnen keine Entw√ºrfe erstellen.', 'error', 5000);
                return;
            }

            // üîß FIX A1 (2025-12-12): Double-Click Prevention
            if (window.savingDraft) {
                console.warn('‚ö†Ô∏è saveAsDraft already in progress');
                return;
            }
            window.savingDraft = true;
            const saveBtn = document.querySelector('button[onclick*="saveAsDraft"]');
            if (saveBtn) saveBtn.disabled = true;

            try {
                // ============================================
                // 1. MINIMUM-VALIDIERUNG (nur essentials!)
                // ============================================

                const kennzeichen = document.getElementById('kennzeichen').value.trim();
                const kundenname = document.getElementById('kundenname').value.trim();
                const kundenEmail = document.getElementById('kundenEmail').value.trim();

                if (!kennzeichen || !kundenname || !kundenEmail) {
                    showToast('‚ö†Ô∏è Mindestens Kennzeichen, Kunde und Email erforderlich!', 'error', 5000);
                    return;
                }

                // Email-Format validieren (SEC-3.1 fix: RFC 5322 compliant)
                const emailRegex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
                if (!emailRegex.test(kundenEmail)) {
                    showToast('‚ö†Ô∏è Ung√ºltiges Email-Format!', 'error', 5000);
                    return;
                }

                // console.log('‚úÖ Minimum-Validierung erfolgreich');

                // ============================================
                // 2. DATEN SAMMELN (partial data OK f√ºr Entwurf)
                // ============================================

                const timestamp = Date.now();
                const entwurfId = String(timestamp);

                const entwurfData = {
                    id: entwurfId,
                    timestamp: timestamp,
                    datum: new Date().toLocaleDateString('de-DE'),
                    zeit: new Date().toLocaleTimeString('de-DE'),

                    // Kunden-Daten (REQUIRED)
                    kennzeichen: kennzeichen,
                    kundenname: kundenname,
                    kundenEmail: kundenEmail.toLowerCase(), // Normalize
                    telefon: document.getElementById('telefon')?.value || '',

                    // ‚úÖ FIX Bug #5L Phase 5g (2025-11-23): Partner-Daten f√ºr Security Rule
                    // CRITICAL: Security Rule (firestore.rules:982) requires partnerEmail == request.auth.token.email
                    // When Partner accepts KVA, annehmenKVA() uses anfrage.partnerEmail - must be set here!
                    partnerId: kundenEmail?.includes('@') ? kundenEmail.split('@')[0] : (kundenEmail || ''),  // Extract ID from email
                    partnerName: kundenname || kundenEmail || '',
                    partnerEmail: kundenEmail.toLowerCase(),

                    // Fahrzeug-Daten (OPTIONAL f√ºr Entwurf)
                    marke: document.getElementById('marke')?.value || '',
                    modell: document.getElementById('modell')?.value || '',
                    baujahrVon: document.getElementById('baujahrVon')?.value || '',
                    kmstand: document.getElementById('kmstand')?.value || '',
                    vin: document.getElementById('vin')?.value || '',

                    // Service-Daten (OPTIONAL) - ‚úÖ FIX: Nov 17, 2025 - Multi-Service Support (BUG #3)
                    serviceTyp: (() => {
                        const primaryService = document.getElementById('serviceTyp')?.value || 'lackier';
                        const additionalServices = Array.from(document.querySelectorAll('.additional-service-checkbox:checked'))
                            .map(cb => cb.value)
                            .filter(service => service !== primaryService);  // Don't duplicate primary

                        if (additionalServices.length > 0) {
                            const allServices = [primaryService, ...additionalServices];
                            // console.log(`üÜï Multi-Service Entwurf: ${allServices.length} Services`, allServices);
                            return allServices;  // Array format
                        } else {
                            // console.log(`üìù Single-Service Entwurf: ${primaryService}`);
                            return primaryService;  // String format (backwards compatible)
                        }
                    })(),

                    // üîß FIX: Nov 17, 2025 - Pattern 33 - Service-Specific Data Collection
                    serviceDetails: getServiceDetails(document.getElementById('serviceTyp')?.value || 'lackier'),

                    // üîß FIX: Nov 17, 2025 - Pattern 33 - Additional Services with Details
                    additionalServices: (() => {
                        const primaryService = document.getElementById('serviceTyp')?.value || 'lackier';
                        const additionalServices = Array.from(document.querySelectorAll('.additional-service-checkbox:checked'))
                            .filter(checkbox => checkbox.value !== primaryService)
                            .map(checkbox => ({
                                serviceTyp: checkbox.value,
                                serviceDetails: getServiceDetails(checkbox.value)
                            }));
                        // console.log(`üìã Entwurf Additional Services mit Details:`, additionalServices);
                        return additionalServices.length > 0 ? additionalServices : null;
                    })(),

                    notizen: document.getElementById('notizen')?.value || '',
                    vereinbarterPreis: parseFloat(document.getElementById('vereinbarterPreis')?.value) || 0,
                    geplantesAbnahmeDatum: document.getElementById('geplantesAbnahmeDatum')?.value || '',  // FIX: Nov 17, 2025 - BUG #1

                    // üñºÔ∏è Fotos & Unterschrift (FIX: Nov 17, 2025 - Pipeline Data Mapping)
                    photoUrls: photos || [],  // ‚úÖ FIX Bug #7 (2025-11-23): Standardized field name (was: photos)
                    signature: canvas.toDataURL() || null,  // Base64 signature
                    unterschriftName: document.getElementById('unterschriftName')?.value || null, // Name des Unterzeichners

                    // üöó Abholungs-Daten (FIX: 2025-11-27)
                    fahrzeugAbholen: document.querySelector('input[name="fahrzeugAbholung"]:checked')?.value === 'ja',
                    abholadresse: document.getElementById('abholadresse')?.value || '',
                    abholdatum: document.getElementById('abholdatum')?.value || '',
                    abholzeit: document.getElementById('abholzeit')?.value || '',
                    abholnotiz: document.getElementById('abholnotiz')?.value || '',

                    // Entwurf-Spezifische Felder
                    isEntwurf: true,
                    entwurfStatus: 'offen',  // Status: offen ‚Üí angebot_erstellt ‚Üí bestaetigt/abgelehnt
                    status: 'warte_kva',  // PartnerAnfrage Standard-Status

                    // Multi-Tenant
                    werkstattId: window.werkstattId, // ‚úÖ SECURITY FIX: No 'mosbach' fallback

                    // Metadaten
                    createdAt: new Date().toISOString(),
                    createdBy: window.currentUser?.name || 'Meister',
                };

                // console.log('üì¶ Entwurf-Daten:', entwurfData);

                // üÜï FIX DATA-PIPELINE Bug #1 (Nov 27, 2025): pdfImport Daten hinzuf√ºgen
                // CRITICAL: PDF-Daten m√ºssen von Entwurf‚ÜíKVA‚ÜíFahrzeug weitergegeben werden!
                if (pdfData || ersatzteileData.length > 0 || arbeitslohnData.length > 0) {
                    entwurfData.pdfImport = {
                        imported: true,
                        source: pdfData?.source || 'manual',
                        editedData: {
                            ersatzteile: JSON.parse(JSON.stringify(ersatzteileData)),
                            arbeitslohn: JSON.parse(JSON.stringify(arbeitslohnData)),
                            lackierung: JSON.parse(JSON.stringify(lackierungData)),
                            materialien: JSON.parse(JSON.stringify(materialienData))
                        }
                    };

                    // kalkulationData f√ºr Rechnungs-Pipeline
                    entwurfData.kalkulationData = {
                        ersatzteile: JSON.parse(JSON.stringify(ersatzteileData)),
                        arbeitslohn: JSON.parse(JSON.stringify(arbeitslohnData)),
                        lackierung: JSON.parse(JSON.stringify(lackierungData)),
                        materialien: JSON.parse(JSON.stringify(materialienData)),
                        summen: {
                            ersatzteile: ersatzteileData.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0),
                            arbeitslohn: arbeitslohnData.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0),
                            lackierung: lackierungData.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0),
                            materialien: materialienData.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0)
                        }
                    };

                    // kostenAufschluesselung f√ºr KVA-PDF
                    const nettoSumme = ersatzteileData.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0) +
                                       arbeitslohnData.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0) +
                                       lackierungData.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0) +
                                       materialienData.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0);

                    entwurfData.kostenAufschluesselung = {
                        ersatzteile: ersatzteileData.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0),
                        arbeitslohn: arbeitslohnData.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0),
                        lackierung: lackierungData.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0),
                        materialien: materialienData.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0),
                        netto: nettoSumme,
                        mwst: nettoSumme * 0.19,
                        brutto: nettoSumme * 1.19
                    };

                    // console.log('üìã pdfImport hinzugef√ºgt:', entwurfData.pdfImport);
                    // console.log('üí∞ kostenAufschluesselung:', entwurfData.kostenAufschluesselung);
                }

                // ============================================
                // 3. SPEICHERN als partnerAnfrage (MVP Approach)
                // ============================================

                if (!window.db) {
                    throw new Error('Firebase nicht initialisiert');
                }

                // üîß BUG #8 FIX #4 (2025-11-20): Add createdBy audit trail
                const currentUser = firebase.auth().currentUser;

                // üîß BUG #4 FIX (2025-11-26): Use getCollection() instead of manual collection name
                await window.getCollection('partnerAnfragen').doc(entwurfId).set({
                    ...entwurfData,
                    // üÜï AUDIT-TRAIL: User-Tracking f√ºr Compliance (Meister der Entwurf erstellt hat)
                    createdBy: currentUser?.displayName || currentUser?.email || 'Meister',
                    createdByUserId: currentUser?.uid || null,
                    createdByEmail: currentUser?.email || null
                });

                // console.log(`‚úÖ Entwurf gespeichert in: partnerAnfragen_${window.werkstattId}/${entwurfId}`);

                // ============================================
                // 4. SUCCESS FEEDBACK
                // ============================================

                showToast('‚úÖ Entwurf gespeichert! Sie k√∂nnen ihn sp√§ter vervollst√§ndigen.', 'success', 4000);

                // Kurz warten, dann redirect
                setTimeout(() => {
                    safeNavigate('index.html');
                }, 1500);

            } catch (error) {
                console.error('‚ùå Fehler beim Speichern des Entwurfs:', error);
                showToast(`‚ùå Fehler: ${error.message}`, 'error', 6000);
            } finally {
                // üîß FIX A1 (2025-12-12): Reset Double-Click Prevention
                window.savingDraft = false;
                if (saveBtn) saveBtn.disabled = false;
            }
        }

        /**
         * Als Entwurf speichern + PDF f√ºr Kunde erstellen
         * Like saveAsDraft() but also generates QR-Code PDF for customer
         */
        async function saveAsDraftWithPDF() {
            // console.log('üìÑ === ENTWURF SPEICHERN + PDF ERSTELLEN ===');

            // üõ°Ô∏è SECURITY: Only werkstatt users can create drafts
            if (window.currentUser?.role === 'partner') {
                console.warn('üö´ Partner-Zugriff blockiert!');
                showToast('‚ö†Ô∏è Zugriff verweigert. Partner k√∂nnen keine Entw√ºrfe erstellen.', 'error', 5000);
                return;
            }

            // üîß FIX A2 (2025-12-12): Double-Click Prevention
            if (window.savingWithPDF) {
                console.warn('‚ö†Ô∏è saveAsDraftWithPDF already in progress');
                return;
            }
            window.savingWithPDF = true;
            const savePdfBtn = document.querySelector('button[onclick*="saveAsDraftWithPDF"]');
            if (savePdfBtn) savePdfBtn.disabled = true;

            try {
                // ============================================
                // 1. MINIMUM-VALIDIERUNG
                // ============================================

                const kennzeichen = document.getElementById('kennzeichen').value.trim();
                const kundenname = document.getElementById('kundenname').value.trim();
                const kundenEmail = document.getElementById('kundenEmail').value.trim();

                // FIX: Bug #6a - Quick Mode validation (Nov 22, 2025)
                // Quick Mode: kundenname is OPTIONAL (fallback to 'Kunde' at Line 3646)
                // Normal Mode: kundenname is REQUIRED
                const isQuickMode = document.getElementById('quickModeToggle')?.checked || false;

                if (!kennzeichen || !kundenEmail) {
                    showToast('‚ö†Ô∏è Mindestens Kennzeichen und Email erforderlich!', 'error', 5000);
                    return;
                }

                // kundenname nur im Normalen Mode required
                if (!isQuickMode && !kundenname) {
                    showToast('‚ö†Ô∏è Kundenname erforderlich im Normalen Modus!', 'error', 5000);
                    return;
                }

                // Email-Format validieren (SEC-3.1 fix: RFC 5322 compliant)
                const emailRegex = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
                if (!emailRegex.test(kundenEmail)) {
                    showToast('‚ö†Ô∏è Ung√ºltiges Email-Format!', 'error', 5000);
                    return;
                }

                // console.log('‚úÖ Minimum-Validierung erfolgreich');

                // ============================================
                // 2. DATEN SAMMELN
                // ============================================

                const timestamp = Date.now();
                const entwurfId = String(timestamp);
                const notizen = document.getElementById('notizen')?.value || '';

                const entwurfData = {
                    id: entwurfId,
                    timestamp: timestamp,
                    datum: new Date().toLocaleDateString('de-DE'),
                    zeit: new Date().toLocaleTimeString('de-DE'),

                    // Kunden-Daten
                    kennzeichen: kennzeichen,
                    kundenname: kundenname,
                    kundenEmail: kundenEmail.toLowerCase(),
                    telefon: document.getElementById('telefon')?.value || '',

                    // ‚úÖ FIX Bug #5L Phase 5g (2025-11-23): Partner-Daten f√ºr Security Rule
                    // CRITICAL: Security Rule (firestore.rules:982) requires partnerEmail == request.auth.token.email
                    // When Partner accepts KVA, annehmenKVA() uses anfrage.partnerEmail - must be set here!
                    partnerId: kundenEmail?.includes('@') ? kundenEmail.split('@')[0] : (kundenEmail || ''),  // Extract ID from email (e.g. 'hallo123' from 'hallo123@web.de')
                    partnerName: kundenname || kundenEmail || '',
                    partnerEmail: kundenEmail.toLowerCase(),

                    // Fahrzeug-Daten
                    marke: document.getElementById('marke')?.value || '',
                    modell: document.getElementById('modell')?.value || '',
                    baujahrVon: document.getElementById('baujahrVon')?.value || '',
                    kmstand: document.getElementById('kmstand')?.value || '',
                    vin: document.getElementById('vin')?.value || '',

                    // Service-Daten - ‚úÖ FIX: Nov 17, 2025 - Multi-Service Support (BUG #3)
                    serviceTyp: (() => {
                        const primaryService = document.getElementById('serviceTyp')?.value || 'lackier';
                        const additionalServices = Array.from(document.querySelectorAll('.additional-service-checkbox:checked'))
                            .map(cb => cb.value)
                            .filter(service => service !== primaryService);  // Don't duplicate primary

                        if (additionalServices.length > 0) {
                            const allServices = [primaryService, ...additionalServices];
                            // console.log(`üÜï Multi-Service Entwurf (with PDF): ${allServices.length} Services`, allServices);
                            return allServices;  // Array format
                        } else {
                            // console.log(`üìù Single-Service Entwurf (with PDF): ${primaryService}`);
                            return primaryService;  // String format (backwards compatible)
                        }
                    })(),

                    // üîß FIX: Nov 17, 2025 - Pattern 33 - Service-Specific Data Collection
                    serviceDetails: getServiceDetails(document.getElementById('serviceTyp')?.value || 'lackier'),

                    // üîß FIX: Nov 17, 2025 - Pattern 33 - Additional Services with Details
                    additionalServices: (() => {
                        const primaryService = document.getElementById('serviceTyp')?.value || 'lackier';
                        const additionalServices = Array.from(document.querySelectorAll('.additional-service-checkbox:checked'))
                            .filter(checkbox => checkbox.value !== primaryService)
                            .map(checkbox => ({
                                serviceTyp: checkbox.value,
                                serviceDetails: getServiceDetails(checkbox.value)
                            }));
                        // console.log(`üìã Entwurf (with PDF) Additional Services mit Details:`, additionalServices);
                        return additionalServices.length > 0 ? additionalServices : null;
                    })(),

                    notizen: notizen,
                    vereinbarterPreis: parseFloat(document.getElementById('vereinbarterPreis')?.value) || 0,
                    geplantesAbnahmeDatum: document.getElementById('geplantesAbnahmeDatum')?.value || '',  // FIX: Nov 17, 2025 - BUG #1

                    // üñºÔ∏è Fotos & Unterschrift (FIX: Nov 17, 2025 - Pipeline Data Mapping)
                    photoUrls: photos || [],  // ‚úÖ FIX Bug #7 (2025-11-23): Standardized field name (was: photos)
                    signature: canvas.toDataURL() || null,  // Base64 signature
                    unterschriftName: document.getElementById('unterschriftName')?.value || null, // Name des Unterzeichners

                    // üöó Abholungs-Daten (FIX: 2025-11-27)
                    fahrzeugAbholen: document.querySelector('input[name="fahrzeugAbholung"]:checked')?.value === 'ja',
                    abholadresse: document.getElementById('abholadresse')?.value || '',
                    abholdatum: document.getElementById('abholdatum')?.value || '',
                    abholzeit: document.getElementById('abholzeit')?.value || '',
                    abholnotiz: document.getElementById('abholnotiz')?.value || '',

                    // Entwurf-Felder
                    isEntwurf: true,
                    entwurfStatus: 'offen',
                    status: 'warte_kva',

                    // Multi-Tenant
                    werkstattId: window.werkstattId, // ‚úÖ SECURITY FIX: No 'mosbach' fallback

                    // Metadaten
                    createdAt: new Date().toISOString(),
                    createdBy: window.currentUser?.name || 'Meister',
                };

                // console.log('üì¶ Entwurf-Daten:', entwurfData);

                // üÜï FIX DATA-PIPELINE Bug #1 (Nov 27, 2025): pdfImport Daten hinzuf√ºgen
                // CRITICAL: PDF-Daten m√ºssen von Entwurf‚ÜíKVA‚ÜíFahrzeug weitergegeben werden!
                if (pdfData || ersatzteileData.length > 0 || arbeitslohnData.length > 0) {
                    entwurfData.pdfImport = {
                        imported: true,
                        source: pdfData?.source || 'manual',
                        editedData: {
                            ersatzteile: JSON.parse(JSON.stringify(ersatzteileData)),
                            arbeitslohn: JSON.parse(JSON.stringify(arbeitslohnData)),
                            lackierung: JSON.parse(JSON.stringify(lackierungData)),
                            materialien: JSON.parse(JSON.stringify(materialienData))
                        }
                    };

                    // kalkulationData f√ºr Rechnungs-Pipeline
                    entwurfData.kalkulationData = {
                        ersatzteile: JSON.parse(JSON.stringify(ersatzteileData)),
                        arbeitslohn: JSON.parse(JSON.stringify(arbeitslohnData)),
                        lackierung: JSON.parse(JSON.stringify(lackierungData)),
                        materialien: JSON.parse(JSON.stringify(materialienData)),
                        summen: {
                            ersatzteile: ersatzteileData.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0),
                            arbeitslohn: arbeitslohnData.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0),
                            lackierung: lackierungData.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0),
                            materialien: materialienData.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0)
                        }
                    };

                    // kostenAufschluesselung f√ºr KVA-PDF
                    const nettoSumme = ersatzteileData.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0) +
                                       arbeitslohnData.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0) +
                                       lackierungData.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0) +
                                       materialienData.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0);

                    entwurfData.kostenAufschluesselung = {
                        ersatzteile: ersatzteileData.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0),
                        arbeitslohn: arbeitslohnData.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0),
                        lackierung: lackierungData.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0),
                        materialien: materialienData.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0),
                        netto: nettoSumme,
                        mwst: nettoSumme * 0.19,
                        brutto: nettoSumme * 1.19
                    };

                    // console.log('üìã pdfImport hinzugef√ºgt:', entwurfData.pdfImport);
                    // console.log('üí∞ kostenAufschluesselung:', entwurfData.kostenAufschluesselung);
                }

                // ============================================
                // 3. AUTO-LOGIN TOKEN ERSTELLEN
                // ============================================

                // console.log('üîë Erstelle Auto-Login Token f√ºr Partner-Login...');
                showToast('‚è≥ Erstelle Partner-Login...', 'info', 2000);

                // Step 1: Ensure Partner Account exists (FIX: Nov 21, 2025 - Capture password)
                const ensurePartnerAccount = window.functions.httpsCallable('ensurePartnerAccount');
                const partnerResult = await ensurePartnerAccount({
                    email: kundenEmail.toLowerCase(),
                    name: kundenname || 'Kunde',  // FIX: Nov 21, 2025 - Fallback if Quick Mode (name not required)
                    werkstattId: window.werkstattId
                });

                // Extract password data for PDF (Pattern from Annahme workflow Lines 2915-2945)
                entwurfData.partnerPassword = partnerResult.data.generatedPassword || null;
                entwurfData.isNewPartner = partnerResult.data.isNewPartner || false;

                // console.log('üîë Partner Account:', {
                    email: kundenEmail,
                    isNew: entwurfData.isNewPartner,
                    hasPassword: !!entwurfData.partnerPassword
                });

                // Step 2: Create Auto-Login Token
                const createToken = window.functions.httpsCallable('createPartnerAutoLoginToken');
                const tokenResult = await createToken({
                    email: kundenEmail.toLowerCase(),
                });

                const autoLoginToken = tokenResult.data.token;
                const baseUrl = window.location.origin + window.location.pathname.replace(/[^/]+$/, '');
                const qrCodeUrl = `${baseUrl}partner-app/auto-login.html?token=${autoLoginToken}`;

                // console.log('‚úÖ Auto-Login Token erstellt');
                // console.log('üîó QR-Code URL:', qrCodeUrl);

                // ============================================
                // 4. SPEICHERN in Firestore
                // ============================================

                if (!window.db) {
                    throw new Error('Firebase nicht initialisiert');
                }

                // üîß BUG #8 FIX #4 (2025-11-20): Add createdBy audit trail
                const currentUser = firebase.auth().currentUser;

                // üîß BUG #4 FIX (2025-11-26): Use getCollection() instead of manual collection name
                await window.getCollection('partnerAnfragen').doc(entwurfId).set({
                    ...entwurfData,
                    // üÜï AUDIT-TRAIL: User-Tracking f√ºr Compliance (Meister der Entwurf erstellt hat)
                    createdBy: currentUser?.displayName || currentUser?.email || 'Meister',
                    createdByUserId: currentUser?.uid || null,
                    createdByEmail: currentUser?.email || null
                });

                // console.log(`‚úÖ Entwurf gespeichert in: partnerAnfragen_${window.werkstattId}/${entwurfId}`);

                // ============================================
                // 5. PDF ERSTELLEN mit QR-Code
                // ============================================

                // console.log('üìÑ Generiere PDF mit QR-Code...');
                showToast('üìÑ Erstelle PDF...', 'info', 2000);

                // FIX: Nov 21, 2025 - Pass full entwurfData instead of only 4 params
                const pdfBlob = await erstelleEntwurfPDF(entwurfData, qrCodeUrl);

                // ============================================
                // 6. PDF IN FIREBASE STORAGE HOCHLADEN
                // ============================================

                let pdfUrl = null;
                if (pdfBlob && firebase.storage) {
                    try {
                        // console.log('‚òÅÔ∏è Lade PDF in Firebase Storage hoch...');
                        showToast('‚òÅÔ∏è Speichere PDF in Cloud...', 'info', 2000);

                        const storage = firebase.storage();
                        const pdfFileName = `Entwurf_${entwurfData.kennzeichen.replace(/\s/g, '_')}_${entwurfId}.pdf`;
                        const pdfRef = storage.ref(`entwurf-pdfs/${window.werkstattId}/${pdfFileName}`);

                        // Upload PDF Blob
                        const uploadTask = await pdfRef.put(pdfBlob, {
                            contentType: 'application/pdf',
                            customMetadata: {
                                entwurfId: entwurfId,
                                kennzeichen: entwurfData.kennzeichen,
                                kundenEmail: entwurfData.kundenEmail,
                                createdAt: new Date().toISOString()
                            }
                        });

                        // Get Download URL
                        pdfUrl = await uploadTask.ref.getDownloadURL();
                        // console.log('‚úÖ PDF hochgeladen:', pdfUrl);

                        // Update Firestore Dokument mit PDF-URL
                        await window.getCollection('partnerAnfragen').doc(entwurfId).update({
                            pdfUrl: pdfUrl,
                            pdfFileName: pdfFileName,
                            pdfUploadedAt: new Date().toISOString()
                        });

                        // console.log('‚úÖ PDF-URL in Firestore gespeichert');
                    } catch (uploadError) {
                        console.warn('‚ö†Ô∏è PDF-Upload fehlgeschlagen (PDF wurde trotzdem lokal gespeichert):', uploadError.message);
                        // Kein throw - PDF wurde lokal gespeichert, Upload ist optional
                    }
                }

                // ============================================
                // 7. SUCCESS FEEDBACK
                // ============================================

                const successMsg = pdfUrl
                    ? '‚úÖ Entwurf gespeichert, PDF heruntergeladen & in Cloud gesichert!'
                    : '‚úÖ Entwurf gespeichert & PDF heruntergeladen!';
                showToast(successMsg, 'success', 4000);

                // Kurz warten, dann redirect
                setTimeout(() => {
                    safeNavigate('index.html');
                }, 2000);

            } catch (error) {
                console.error('‚ùå Fehler beim Speichern des Entwurfs + PDF:', error);

                let errorMsg = '‚ùå Fehler beim Speichern.\n\n';
                if (error.message.includes('Token') || error.message.includes('ensurePartnerAccount')) {
                    errorMsg += 'üîë Partner-Account-Erstellung fehlgeschlagen.\n';
                    errorMsg += 'Der Entwurf wurde NICHT gespeichert.\n\n';
                    errorMsg += 'Bitte versuchen Sie es erneut oder verwenden Sie\n';
                    errorMsg += '"Als Entwurf speichern" (ohne PDF).';
                } else {
                    errorMsg += `Details: ${error.message}`;
                }

                showToast(errorMsg, 'error', 8000);
            } finally {
                // üîß FIX A2 (2025-12-12): Reset Double-Click Prevention
                window.savingWithPDF = false;
                if (savePdfBtn) savePdfBtn.disabled = false;
            }
        }

        // Kunden laden
        async function loadKunden() {
            try {
                if (firebaseInitialized && firebaseApp) {
                    allKunden = await firebaseApp.getAllKunden();
                } else {
                    allKunden = JSON.parse(localStorage.getItem('kunden') || '[]');
                }

                // console.log(`‚úÖ ${allKunden.length} Kunden geladen`);
                updateKundenDropdown();
            } catch (error) {
                console.error('‚ùå Fehler beim Laden der Kunden:', error);
                allKunden = [];
            }
        }

        // Kunden-Dropdown aktualisieren
        function updateKundenDropdown() {
            const dropdown = document.getElementById('kundenDropdown');
            dropdown.innerHTML = '<option value="">üÜï Neuer Kunde</option>';

            if (allKunden.length > 0) {
                const sortedKunden = [...allKunden].sort((a, b) => {
                    const dateA = a.letzterBesuch ? (a.letzterBesuch.toDate?.() || new Date(a.letzterBesuch)) : new Date(0);
                    const dateB = b.letzterBesuch ? (b.letzterBesuch.toDate?.() || new Date(b.letzterBesuch)) : new Date(0);
                    return dateB - dateA;
                });

                sortedKunden.forEach(kunde => {
                    const option = document.createElement('option');
                    option.value = kunde.id;
                    const besuche = kunde.anzahlBesuche || 0;
                    const icon = besuche >= 2 ? '‚≠ê' : 'üë§';
                    option.textContent = `${icon} ${kunde.name} (${besuche} Besuch${besuche !== 1 ? 'e' : ''})`;
                    dropdown.appendChild(option);
                });
            }
        }

        // Neuwagen ohne Kennzeichen Handler (2026-01-08)
        function handleNeuwagenCheckbox() {
            const checkbox = document.getElementById('neuwagenOhneKennzeichen');
            const kennzeichenInput = document.getElementById('kennzeichen');

            if (checkbox.checked) {
                // Neuwagen - Platzhalter setzen und Feld deaktivieren
                kennzeichenInput.value = 'NEUWAGEN';
                kennzeichenInput.readOnly = true;
                kennzeichenInput.style.backgroundColor = 'var(--color-surface-tertiary)';
                kennzeichenInput.removeAttribute('required');
            } else {
                // Normal - Feld wieder aktivieren
                kennzeichenInput.value = '';
                kennzeichenInput.readOnly = false;
                kennzeichenInput.style.backgroundColor = '';
                kennzeichenInput.setAttribute('required', 'required');
            }
        }

        // Kunde aus Dropdown ausw√§hlen
        function selectKunde() {
            const dropdown = document.getElementById('kundenDropdown');
            const kundeId = dropdown.value;

            if (!kundeId) {
                // Neuer Kunde - alle Felder leeren und editierbar machen
                document.getElementById('kundenname').value = '';
                document.getElementById('kundenname').readOnly = false;
                document.getElementById('kundenEmail').value = '';
                document.getElementById('kundenEmail').readOnly = false;
                document.getElementById('telefon').value = '';
                document.getElementById('telefon').readOnly = false;
                return;
            }

            const kunde = allKunden.find(k => window.compareIds(k.id, kundeId));
            if (kunde) {
                // Name ausf√ºllen
                document.getElementById('kundenname').value = kunde.name;
                document.getElementById('kundenname').readOnly = true;

                // üÜï BUGFIX 2025-11-04: Email automatisch ausf√ºllen
                if (kunde.email) {
                    document.getElementById('kundenEmail').value = kunde.email;
                    document.getElementById('kundenEmail').readOnly = true;
                } else {
                    document.getElementById('kundenEmail').value = '';
                    document.getElementById('kundenEmail').readOnly = false;
                }

                // üÜï BUGFIX 2025-11-04: Telefon automatisch ausf√ºllen
                if (kunde.telefon) {
                    document.getElementById('telefon').value = kunde.telefon;
                    document.getElementById('telefon').readOnly = true;
                } else {
                    document.getElementById('telefon').value = '';
                    document.getElementById('telefon').readOnly = false;
                }

                // console.log(`‚úÖ Stammkunde ausgew√§hlt: ${kunde.name} (${kunde.anzahlBesuche || 0} Besuche)`);
                if (kunde.email) // console.log(`   üìß Email: ${kunde.email}`);
                if (kunde.telefon) // console.log(`   üìû Telefon: ${kunde.telefon}`);
            }
        }

        // Toggle Abholungs-Details
        function toggleAbholungDetails() {
            const fahrzeugAbholung = document.querySelector('input[name="fahrzeugAbholung"]:checked')?.value || 'nein';
            const abholungDetails = document.getElementById('abholungDetails');

            if (fahrzeugAbholung === 'ja') {
                abholungDetails.style.display = 'block';
                document.getElementById('abholadresse').required = true;
            } else {
                abholungDetails.style.display = 'none';
                document.getElementById('abholadresse').value = '';
                document.getElementById('abholdatum').value = '';
                document.getElementById('abholzeit').value = '';
                document.getElementById('abholnotiz').value = '';
                document.getElementById('abholadresse').required = false;
            }
        }

        // Radio-Button visuelle R√ºckmeldung
        function initRadioVisuals() {
            document.querySelectorAll('.radio-group input[type="radio"]').forEach(radio => {
                if (radio.checked) {
                    radio.parentElement.classList.add('selected');
                }

                const radioChangeHandler = function() {
                    const groupName = this.name;
                    document.querySelectorAll(`input[name="${groupName}"]`).forEach(r => {
                        r.parentElement.classList.remove('selected');
                    });

                    if (this.checked) {
                        this.parentElement.classList.add('selected');
                    }
                };
                window.listenerRegistry.registerDOM(radio, 'change', radioChangeHandler, `Radio Button ${radio.name}`);
            });
        }

        // Aktuelles Datum
        const heute = new Date();
        document.getElementById('currentDate').textContent = heute.toLocaleDateString('de-DE', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });

        // Foto-Upload
        const photoInput = document.getElementById('photoInput');
        const photoGrid = document.getElementById('photoGrid');
        // üîß FIX Dec 3, 2025: photos Variable nach oben verschoben (Zeile 2861)
        // damit saveAsDraft() und saveAsDraftWithPDF() Zugriff haben

        async function compressImage(base64Image, profileName = 'schadenFoto') {
            const result = await ImageOptimizer.compressImage(
                base64Image,
                profileName,
                (progress, message) => {
                    if (progress === 100) {
                        // console.log(`‚úÖ ${message}`);
                    }
                }
            );

            // console.log(`üìä Komprimierung: ${result.savings}% gespart (${(result.originalSize/1024).toFixed(0)}KB ‚Üí ${(result.compressedSize/1024).toFixed(0)}KB)`);

            return result.compressed;
        }

        const photoInputHandler = function(e) {
            const files = Array.from(e.target.files);

            for (const file of files) {
                if (file.size > 5 * 1024 * 1024) {
                    showToast(`Foto "${file.name}" ist zu gro√ü (${(file.size / 1024 / 1024).toFixed(1)} MB)! Bitte kleineres Foto verwenden (max. 5 MB).`, 'warning', 5000);
                    e.target.value = '';
                    return;
                }
            }

            // ‚úÖ MIGRATED TO FIREBASE STORAGE (Phase: Nov 17, 2025)
            // Old: Base64 compression ‚Üí Firestore (1MB limit issues)
            // New: Direct upload to Firebase Storage ‚Üí Store URLs
            // ‚úÖ SECURITY FIX: No 'mosbach' fallback - werkstattId must be validated at login
            if (!window.werkstattId) {
                showToast('Fehler: Werkstatt-Zuordnung fehlt. Foto-Upload abgebrochen.', 'error');
                return;
            }
            const werkstattId = window.werkstattId;
            const timestamp = Date.now();
            const entwurfId = `temp_${timestamp}`; // Temporary ID for photos before final save

            (async () => {
                for (const file of files) {
                    try {
                        // Create unique filename
                        const fileTimestamp = Date.now();
                        const sanitizedFilename = file.name.replace(/[^a-zA-Z0-9._-]/g, '_');
                        const storagePath = `entwuerfe/${werkstattId}/${entwurfId}/photo_${fileTimestamp}_${sanitizedFilename}`;

                        // Upload to Firebase Storage
                        const storage = firebase.storage();
                        const storageRef = storage.ref(storagePath);
                        await storageRef.put(file);

                        // Get download URL
                        const downloadURL = await storageRef.getDownloadURL();

                        // Store URL instead of Base64
                        photos.push(downloadURL);
                        // console.log(`‚úÖ Foto hochgeladen: ${storagePath}`);

                    } catch (error) {
                        console.error('‚ùå Fehler beim Foto-Upload:', error);
                        showToast(`Fehler beim Upload von "${file.name}": ${error.message}`, 'error', 5000);
                    }
                }
                updatePhotoGrid();
            })();
            e.target.value = '';
        };
        window.listenerRegistry.registerDOM(photoInput, 'change', photoInputHandler, 'Photo Input Change');

        // AGI Training: Temporaere Labels fuer Photos (vor dem Speichern)
        let photoLabels = [];

        function updatePhotoGrid() {
            photoGrid.innerHTML = '';
            photos.forEach((photo, index) => {
                const div = document.createElement('div');
                div.className = 'photo-item';
                const isLabeled = photoLabels[index] && photoLabels[index].schadenLabels;
                div.innerHTML = `
                    <img src="${photo}" alt="Foto ${index + 1}">
                    <button class="remove-photo" onclick="removePhoto(${index})">√ó</button>
                    <button class="foto-label-btn ${isLabeled ? 'labeled' : ''}" onclick="openPhotoLabeler(${index})" title="Schaden labeln (AGI-Training)">
                        ${isLabeled ? '‚úì Gelabelt' : 'üè∑Ô∏è Labeln'}
                    </button>
                    ${isLabeled ? '<span class="foto-label-badge">ML</span>' : ''}
                `;
                photoGrid.appendChild(div);
            });

            if (photos.length < 10) {
                // üîß FIX Safari (2025-12-24): label statt div+onclick f√ºr native File-Input Trigger
                const emptyLabel = document.createElement('label');
                emptyLabel.className = 'photo-item empty';
                emptyLabel.setAttribute('for', 'photoInput');
                emptyLabel.innerHTML = `
                    <span>+ Foto hinzuf√ºgen</span>
                `;
                photoGrid.appendChild(emptyLabel);
            }

            feather.replace();
        }

        // AGI Training: Oeffnet den Schaden-Labeler fuer ein Foto
        function openPhotoLabeler(index) {
            if (typeof window.DamageLabeler === 'undefined') {
                console.warn('[AGI Training] DamageLabeler nicht geladen');
                showToast('Labeling-Modul wird geladen...', 'info');
                return;
            }

            const photoUrl = photos[index];
            const existingLabel = photoLabels[index] || {};

            // Oeffne Modal mit temporaerer Callback-Funktion
            // Da wir noch keine Fahrzeug-ID haben, speichern wir lokal
            window.DamageLabeler.currentFahrzeugId = 'temp_' + Date.now();
            window.DamageLabeler.currentFotoIndex = index;
            window.DamageLabeler.currentFotoData = {
                url: photoUrl,
                schadenLabels: existingLabel.schadenLabels || null
            };

            // Override saveLabel to store locally instead of Firestore
            window.DamageLabeler.saveLabelToFirestore = async function(labelData) {
                // Speichere temporaer im photoLabels Array
                photoLabels[index] = labelData;
                // console.log('‚úÖ [AGI Training] Label temporaer gespeichert:', labelData);
                updatePhotoGrid(); // UI aktualisieren
            };

            window.DamageLabeler.openModal('temp', index, {
                url: photoUrl,
                schadenLabels: existingLabel.schadenLabels || null
            });
        }

        // Event Listener fuer gespeicherte Labels (falls das Modal Event feuert)
        window.addEventListener('damageLabelSaved', function(e) {
            if (e.detail && e.detail.fotoIndex !== undefined) {
                photoLabels[e.detail.fotoIndex] = e.detail.labelData;
                updatePhotoGrid();
            }
        });

        async function removePhoto(index) {
            const photoUrl = photos[index];

            // ‚úÖ If it's a Storage URL (not Base64), delete from Storage
            if (photoUrl && photoUrl.startsWith('https://firebasestorage.googleapis.com')) {
                try {
                    const storage = firebase.storage();
                    const photoRef = storage.refFromURL(photoUrl);
                    await photoRef.delete();
                    // console.log(`‚úÖ Foto aus Storage gel√∂scht: ${photoRef.fullPath}`);
                } catch (error) {
                    // Ignore errors (file might already be deleted or not exist)
                    console.warn('‚ö†Ô∏è Konnte Foto nicht aus Storage l√∂schen:', error.message);
                }
            }

            photos.splice(index, 1);
            // AGI Training: Auch das zugehoerige Label entfernen
            photoLabels.splice(index, 1);
            updatePhotoGrid();
        }

        // Unterschrift Canvas
        const canvas = document.getElementById('signatureCanvas');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;
        let hasDrawn = false;

        // Get stroke color based on current theme
        function getCanvasStrokeColor() {
            const textColor = getComputedStyle(document.documentElement)
                .getPropertyValue('--color-text-primary').trim();
            return textColor || '#000000'; // Fallback to black
        }

        function initCanvas() {
            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * 2;
            canvas.height = rect.height * 2;
            ctx.scale(2, 2);

            ctx.strokeStyle = getCanvasStrokeColor();
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            if (!hasDrawn) {
                drawPlaceholder();
            }
        }

        function drawPlaceholder() {
            ctx.save();
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.fillStyle = getCanvasStrokeColor();
            ctx.globalAlpha = 0.3; // Semi-transparent
            ctx.font = '20px Inter';
            ctx.textAlign = 'center';
            ctx.fillText('‚úçÔ∏è Hier unterschreiben', canvas.width / 2, canvas.height / 2);
            ctx.restore();
        }

        initCanvas();
        window.listenerRegistry.registerDOM(window, 'resize', initCanvas, 'Signature Canvas Resize');

        function getCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            if (e.touches && e.touches.length > 0) {
                return {
                    x: (e.touches[0].clientX - rect.left) * scaleX / 2,
                    y: (e.touches[0].clientY - rect.top) * scaleY / 2
                };
            } else {
                return {
                    x: (e.clientX - rect.left) * scaleX / 2,
                    y: (e.clientY - rect.top) * scaleY / 2
                };
            }
        }

        function startDrawing(e) {
            e.preventDefault();
            isDrawing = true;

            if (!hasDrawn) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                hasDrawn = true;
            }

            const coords = getCoordinates(e);
            ctx.beginPath();
            ctx.moveTo(coords.x, coords.y);
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();

            const coords = getCoordinates(e);
            ctx.lineTo(coords.x, coords.y);
            ctx.stroke();
        }

        function stopDrawing(e) {
            if (!isDrawing) return;
            e.preventDefault();
            isDrawing = false;
            ctx.closePath();
        }

        window.listenerRegistry.registerDOM(canvas, 'mousedown', startDrawing, 'Signature Canvas Mouse Down');
        window.listenerRegistry.registerDOM(canvas, 'mousemove', draw, 'Signature Canvas Mouse Move');
        window.listenerRegistry.registerDOM(canvas, 'mouseup', stopDrawing, 'Signature Canvas Mouse Up');
        window.listenerRegistry.registerDOM(canvas, 'mouseleave', stopDrawing, 'Signature Canvas Mouse Leave');

        window.listenerRegistry.registerDOM(canvas, 'touchstart', startDrawing, 'Signature Canvas Touch Start');
        window.listenerRegistry.registerDOM(canvas, 'touchmove', draw, 'Signature Canvas Touch Move');
        window.listenerRegistry.registerDOM(canvas, 'touchend', stopDrawing, 'Signature Canvas Touch End');
        window.listenerRegistry.registerDOM(canvas, 'touchcancel', stopDrawing, 'Signature Canvas Touch Cancel');

        function clearSignature() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            hasDrawn = false;
            drawPlaceholder();
        }

        // Listen to theme changes and update canvas colors
        window.addEventListener('themeChanged', () => {
            initCanvas();
            // console.log('‚úÖ Canvas colors updated for theme:', document.documentElement.getAttribute('data-theme'));
        });

        // Formular-Daten sammeln
        // ‚ú® SERVICE-DETAILS SAMMELN
        function getServiceDetails(serviceTyp) {
            const details = {};

            switch(serviceTyp) {
                case 'reifen':
                    const reifengroesse = document.getElementById('reifengroesse')?.value;
                    const reifentyp = document.getElementById('reifentyp')?.value;
                    const reifenanzahl = document.getElementById('reifenanzahl')?.value;
                    if (reifengroesse || reifentyp || reifenanzahl) {
                        details.reifengroesse = reifengroesse;
                        details.reifentyp = reifentyp;
                        details.reifenanzahl = reifenanzahl;
                    }
                    break;

                case 'glas':
                    const scheibentyp = document.getElementById('scheibentyp')?.value;
                    const schadensgroesse = document.getElementById('schadensgroesse')?.value;
                    const glasposition = document.getElementById('glasposition')?.value;
                    if (scheibentyp || schadensgroesse || glasposition) {
                        details.scheibentyp = scheibentyp;
                        details.schadensgroesse = schadensgroesse;
                        details.glasposition = glasposition;
                    }
                    break;

                case 'klima':
                    const klimaservice = document.getElementById('klimaservice')?.value;
                    const kaeltemittel = document.getElementById('kaeltemittel')?.value;
                    const klimaproblem = document.getElementById('klimaproblem')?.value;
                    if (klimaservice || kaeltemittel || klimaproblem) {
                        details.klimaservice = klimaservice;
                        details.kaeltemittel = kaeltemittel;
                        details.klimaproblem = klimaproblem;
                    }
                    break;

                case 'dellen':
                    const dellenanzahl = document.getElementById('dellenanzahl')?.value;
                    const dellengroesse = document.getElementById('dellengroesse')?.value;
                    const lackschaden = document.getElementById('lackschaden')?.value;
                    const dellenpositionen = document.getElementById('dellenpositionen')?.value;
                    if (dellenanzahl || dellengroesse || lackschaden || dellenpositionen) {
                        details.dellenanzahl = dellenanzahl;
                        details.dellengroesse = dellengroesse;
                        details.lackschaden = lackschaden;
                        details.dellenpositionen = dellenpositionen;
                    }
                    break;

                case 'mechanik':
                    const mechanikProblem = document.getElementById('mechanik-problem')?.value;
                    const mechanikSymptome = document.getElementById('mechanik-symptome')?.value;
                    if (mechanikProblem || mechanikSymptome) {
                        details.problem = mechanikProblem;  // FIX: Nov 20, 2025 - Remove prefix for PDF/Display compatibility (Pattern 34)
                        details.symptome = mechanikSymptome;  // FIX: Nov 20, 2025 - Remove prefix for PDF/Display compatibility (Pattern 34)
                    }
                    break;

                case 'versicherung':
                    const schadensnummer = document.getElementById('versicherung-schadensnummer')?.value;
                    const versicherungName = document.getElementById('versicherung-name')?.value;
                    const schadendatum = document.getElementById('versicherung-schadendatum')?.value;
                    const unfallhergang = document.getElementById('versicherung-hergang')?.value;
                    if (schadensnummer || versicherungName || schadendatum || unfallhergang) {
                        details.schadensnummer = schadensnummer;
                        details.versicherung = versicherungName;
                        details.schadendatum = schadendatum;
                        details.unfallhergang = unfallhergang;
                    }
                    break;

                case 'pflege':
                    const pflegePaket = document.getElementById('pflege-paket')?.value;
                    const pflegeZusatz = document.getElementById('pflege-zusatz')?.value;
                    if (pflegePaket || pflegeZusatz) {
                        details.paket = pflegePaket;
                        details.zusatzleistungen = pflegeZusatz;
                    }
                    break;

                case 'tuev':
                    const tuevPruefart = document.getElementById('tuev-pruefart')?.value;
                    const tuevFaelligkeit = document.getElementById('tuev-faelligkeit')?.value;
                    const tuevMaengel = document.getElementById('tuev-maengel')?.value;
                    if (tuevPruefart || tuevFaelligkeit || tuevMaengel) {
                        details.pruefart = tuevPruefart;
                        details.faelligkeit = tuevFaelligkeit;
                        details.bekannteMaengel = tuevMaengel;
                    }
                    break;

                case 'folierung':
                    const folierungArt = document.getElementById('folierungArt')?.value;
                    const folierungMaterial = document.getElementById('folierungMaterial')?.value;
                    const folierungSpezialTyp = document.getElementById('folierungSpezialTyp')?.value;
                    const folierungFarbe = document.getElementById('folierungFarbe')?.value;
                    const folierungBereiche = Array.from(document.querySelectorAll('input[name="folierungBereiche"]:checked')).map(cb => cb.value);
                    const folierungDesign = document.getElementById('folierungDesign')?.value;
                    const folierungInfo = document.getElementById('folierungInfo')?.value;
                    if (folierungArt || folierungMaterial || folierungFarbe || folierungDesign || folierungInfo) {
                        details.folierungArt = folierungArt;
                        details.folierungMaterial = folierungMaterial;
                        if (folierungSpezialTyp) details.folierungSpezialTyp = folierungSpezialTyp;
                        details.folierungFarbe = folierungFarbe;
                        if (folierungBereiche.length > 0) details.folierungBereiche = folierungBereiche;
                        details.folierungDesign = folierungDesign;
                        details.folierungInfo = folierungInfo;
                    }
                    break;

                case 'steinschutz':
                    const steinschutzUmfang = document.getElementById('steinschutzUmfang')?.value;
                    const steinschutzMaterial = document.getElementById('steinschutzMaterial')?.value;
                    const steinschutzBereiche = document.getElementById('steinschutzBereiche')?.value;
                    const steinschutzInfo = document.getElementById('steinschutzInfo')?.value;
                    if (steinschutzUmfang || steinschutzMaterial || steinschutzBereiche || steinschutzInfo) {
                        details.steinschutzUmfang = steinschutzUmfang;
                        details.steinschutzMaterial = steinschutzMaterial;
                        details.steinschutzBereiche = steinschutzBereiche;
                        details.steinschutzInfo = steinschutzInfo;
                    }
                    break;

                case 'werbebeklebung':
                    const werbebeklebungUmfang = document.getElementById('werbebeklebungUmfang')?.value;
                    const werbebeklebungKomplexitaet = document.getElementById('werbebeklebungKomplexitaet')?.value;
                    const werbebeklebungText = document.getElementById('werbebeklebungText')?.value;
                    const werbebeklebungFarbanzahl = document.getElementById('werbebeklebungFarbanzahl')?.value;
                    const werbebeklebungInfo = document.getElementById('werbebeklebungInfo')?.value;
                    if (werbebeklebungUmfang || werbebeklebungKomplexitaet || werbebeklebungText || werbebeklebungFarbanzahl || werbebeklebungInfo) {
                        details.werbebeklebungUmfang = werbebeklebungUmfang;
                        details.werbebeklebungKomplexitaet = werbebeklebungKomplexitaet;
                        details.werbebeklebungText = werbebeklebungText;
                        details.werbebeklebungFarbanzahl = werbebeklebungFarbanzahl;
                        details.werbebeklebungInfo = werbebeklebungInfo;
                    }
                    break;

                case 'lackier':
                    // FIX (2025-11-12): lackier case war komplett missing in getServiceDetails()
                    // Verwendet die gleichen Felder wie Primary Lackierung-Service
                    const farbname = document.getElementById('farbname')?.value;
                    const farbvariante = document.getElementById('farbvariante')?.value;
                    const farbnummer = document.getElementById('farbnummer')?.value;
                    const lackartRadio = document.querySelector('input[name="lackart"]:checked')?.value;
                    if (farbname || farbvariante || farbnummer || lackartRadio) {
                        details.farbname = farbname;
                        details.farbvariante = farbvariante;
                        details.farbnummer = farbnummer;
                        details.lackart = lackartRadio;
                    }

                    // üîß FIX (2025-11-27): Ersatzfahrzeug-Daten f√ºr Primary Lackier-Service
                    // Dies war der ECHTE Bug - 'lackier' ist der aktive serviceTyp, nicht 'lackierung'!
                    details.ersatzfahrzeugGewuenscht = document.getElementById('ersatzfahrzeugGewuenscht')?.checked || false;
                    // ersatzfahrzeugAdresse ENTFERNT - redundant mit abholadresse
                    break;

                // üÜï FIX (2025-11-27): case 'lackierung' f√ºr Primary Lackierung-Service
                // War vorher NICHT vorhanden - nur 'lackier' f√ºr Secondary Services
                case 'lackierung':
                    const lackFarbname = document.getElementById('farbname')?.value || '';
                    const lackFarbvariante = document.getElementById('farbvariante')?.value || '';
                    const lackFarbnummer = document.getElementById('farbnummer')?.value || '';
                    const lackLackart = document.querySelector('input[name="lackart"]:checked')?.value || '';
                    const lackErsatzfahrzeugGewuenscht = document.getElementById('ersatzfahrzeugGewuenscht')?.checked || false;
                    // ersatzfahrzeugAdresse ENTFERNT - redundant mit abholadresse

                    if (lackFarbname || lackFarbvariante || lackFarbnummer || lackLackart) {
                        details.farbname = lackFarbname;
                        details.farbvariante = lackFarbvariante;
                        details.farbnummer = lackFarbnummer;
                        details.lackart = lackLackart;
                    }

                    // Ersatzfahrzeug-Daten IMMER hinzuf√ºgen
                    details.ersatzfahrzeugGewuenscht = lackErsatzfahrzeugGewuenscht;
                    // ersatzfahrzeugAdresse ENTFERNT - redundant mit abholadresse
                    break;

                // Andere Services haben keine spezifischen Felder
                default:
                    break;
            }

            return Object.keys(details).length > 0 ? details : null;
        }

        // ============================================
        // PDF-PARSING FUNKTIONEN (DAT-Kalkulation)
        // ============================================

        let pdfData = null;  // Gespeicherte PDF-Daten

        async function handlePdfUpload(event) {
            const file = event.target.files[0];
            if (!file || file.type !== 'application/pdf') {
                showToast('‚ùå Bitte w√§hlen Sie eine PDF-Datei', 'error');
                return;
            }

            // UI Feedback
            document.getElementById('pdfFileName').textContent = file.name;
            document.getElementById('pdfRemoveBtn').style.display = 'inline-block';

            try {
                // =====================================================================
                // OPENAI PRIMARY STRATEGY (2025-11-11)
                // OpenAI GPT-4 Vision ist PRIMARY f√ºr 100% Genauigkeit
                // Regex nur als Fallback wenn OpenAI fehlschl√§gt
                // =====================================================================

                let pdfExtraction;

                try {
                    // PRIMARY: OpenAI GPT-4 Vision (100% accuracy, any layout)
                    // console.log('ü§ñ [PRIMARY] Trying OpenAI GPT-4 Vision...');
                    pdfExtraction = await parseWithOpenAI(file);
                    // console.log('‚úÖ [PRIMARY] OpenAI parsing successful');
                } catch (openaiError) {
                    // FALLBACK: Regex-based parsing (only if OpenAI fails)
                    console.warn('‚ö†Ô∏è [FALLBACK] OpenAI parsing failed, falling back to regex:', openaiError);
                    showToast('‚ö†Ô∏è AI-Parsing fehlgeschlagen, verwende Regex-Fallback...', 'warning', 3000);

                    pdfExtraction = await parseDatPdf(file);
                    pdfExtraction.source = 'pdf-regex';
                    // console.log('‚úÖ [FALLBACK] Regex parsing completed');
                }

                // =====================================================================
                // STUFE 3: BIDIRECTIONAL MERGE (2025-11-11)
                // PDF-Upload triggert merge wenn Text bereits existiert
                // =====================================================================

                // Check if text was already parsed
                if (pdfData && pdfData.source === 'text' && pdfData.ersatzteile && pdfData.ersatzteile.length > 0) {
                    const confirmed = confirm(
                        `üí° Es wurden bereits ${pdfData.ersatzteile.length} Ersatzteile aus Text extrahiert.\n\n` +
                        `M√∂chten Sie diese mit PDF-Daten KOMBINIEREN f√ºr h√∂here Zuverl√§ssigkeit?\n\n` +
                        `‚úÖ JA ‚Üí Beide Methoden kombinieren (empfohlen! 97-98% Zuverl√§ssigkeit)\n` +
                        `‚ùå NEIN ‚Üí Nur PDF-Daten verwenden`
                    );

                    if (confirmed) {
                        // Merge: PDF is primary (higher accuracy from column detection)
                        // console.log('üîÑ User w√§hlte MERGE ‚Üí Kombiniere PDF (primary) + Text (secondary)');
                        pdfData = mergeExtractions(pdfExtraction, pdfData, 'pdf-primary');
                        fillFormFromPdf(pdfData);
                        renderErsatzteilePreview(pdfData.ersatzteile);
                        renderArbeitslohnPreview(pdfData.arbeitslohn);
                        renderLackierungPreview(pdfData.lackierung);
                        updateGesamtsumme(pdfData);
                        showToast(`‚úÖ Kombiniert: ${pdfData.ersatzteile.length} Ersatzteile (PDF + Text)`, 'success');
                    } else {
                        // Replace text with PDF
                        // console.log('‚ö†Ô∏è User w√§hlte REPLACE ‚Üí Text-Daten werden √ºberschrieben');
                        pdfData = pdfExtraction;
                        fillFormFromPdf(pdfData);
                        renderErsatzteilePreview(pdfData.ersatzteile);
                        renderArbeitslohnPreview(pdfData.arbeitslohn);
                        renderLackierungPreview(pdfData.lackierung);
                        updateGesamtsumme(pdfData);
                        showToast('‚úÖ Fahrzeugdaten aus PDF √ºbernommen!', 'success');
                    }
                } else {
                    // No text data, just use PDF
                    pdfData = pdfExtraction;
                    fillFormFromPdf(pdfData);
                    renderErsatzteilePreview(pdfData.ersatzteile);
                    renderArbeitslohnPreview(pdfData.arbeitslohn);
                    renderLackierungPreview(pdfData.lackierung);
                    updateGesamtsumme(pdfData);
                    showToast('‚úÖ Fahrzeugdaten aus PDF √ºbernommen!', 'success');
                }
            } catch (error) {
                console.error('‚ùå PDF-Parsing Fehler:', error);
                showToast('Fehler beim Lesen der PDF. Bitte Daten manuell eingeben.', 'error');
                removePdf();
            }
        }

        // ============================================
        // OPENAI GPT-4 VISION PDF PARSER (PRIMARY)
        // ============================================

        /**
         * Convert PDF to PNG Images using PDF.js + Canvas
         *
         * OpenAI Vision API only accepts images (PNG/JPEG/WEBP), not PDFs
         * This function converts ALL pages of a PDF to high-quality PNG images
         *
         * @param {File} pdfFile - PDF file to convert
         * @returns {Promise<Array<string>>} Array of Base64-encoded PNG images (without data URI prefix)
         */
        async function convertPdfToImage(pdfFile) {
            // console.log('üñºÔ∏è [PDF‚ÜíPNG] Converting PDF to PNG images for OpenAI Vision API...');

            try {
                // Read PDF as ArrayBuffer
                const arrayBuffer = await pdfFile.arrayBuffer();
                const uint8Array = new Uint8Array(arrayBuffer);

                // Load PDF with PDF.js
                const loadingTask = pdfjsLib.getDocument({ data: uint8Array });
                const pdf = await loadingTask.promise;

                // console.log(`üìÑ [PDF‚ÜíPNG] PDF loaded: ${pdf.numPages} page(s)`);

                const pngImages = [];

                // Convert ALL pages to PNG
                for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                    // console.log(`üé® [PDF‚ÜíPNG] Processing page ${pageNum}/${pdf.numPages}...`);

                    // Get page
                    const page = await pdf.getPage(pageNum);

                    // Set scale for high quality (2x for better OCR results)
                    const scale = 2.0;
                    const viewport = page.getViewport({ scale });

                    // Create canvas
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;

                    // Render PDF page to canvas
                    const renderContext = {
                        canvasContext: context,
                        viewport: viewport
                    };

                    await page.render(renderContext).promise;

                    // Convert canvas to PNG base64
                    const pngDataUrl = canvas.toDataURL('image/png', 1.0); // Max quality
                    const pngBase64 = pngDataUrl?.includes(',') ? pngDataUrl.split(',')[1] : pngDataUrl; // Remove "data:image/png;base64," prefix

                    const sizeKB = (pngBase64.length / 1024).toFixed(2);
                    // console.log(`   ‚úÖ Page ${pageNum}: ${sizeKB} KB PNG`);

                    pngImages.push(pngBase64);
                }

                const totalSizeKB = (pngImages.reduce((sum, img) => sum + img.length, 0) / 1024).toFixed(2);
                // console.log(`‚úÖ [PDF‚ÜíPNG] All ${pdf.numPages} pages converted: ${totalSizeKB} KB total`);

                return pngImages;

            } catch (error) {
                console.error('‚ùå [PDF‚ÜíPNG] Conversion failed:', error);
                throw new Error(`PDF to PNG conversion failed: ${error.message}`);
            }
        }

        /**
         * Parse PDF with OpenAI GPT-4 Vision API
         * PRIMARY method for 100% accurate extraction
         *
         * Extracts: Fahrzeugdaten, Ersatzteile, Arbeitszeiten, Lackierung
         * Supports: ANY invoice layout (DAT, other platforms)
         *
         * Cost: ~$0.01-0.03 per PDF
         */
        async function parseWithOpenAI(pdfFile) {
            // console.log('ü§ñ [OPENAI] Starte PDF-Parsing mit OpenAI GPT-4 Vision...');

            showToast('‚è≥ PDF wird analysiert mit AI...', 'info', 3000);

            try {
                // Convert PDF to PNG images (ALL pages - OpenAI Vision API only accepts images, not PDFs)
                // console.log('üìÑ [OPENAI] Converting PDF to PNG images...');
                const pngImagesArray = await convertPdfToImage(pdfFile);

                const totalSizeKB = (pngImagesArray.reduce((sum, img) => sum + img.length, 0) / 1024).toFixed(2);
                // console.log(`‚úÖ [OPENAI] ${pngImagesArray.length} PNG images ready: ${totalSizeKB} KB total`);

                // Call Cloud Function (Region bereits in firebase-config.js auf europe-west3 gesetzt!)
                // console.log('‚òÅÔ∏è [OPENAI] Calling Cloud Function parseDATPDF (europe-west3)...');
                const parseDATPDF = window.functions.httpsCallable('parseDATPDF');
                const result = await parseDATPDF({ imagesBase64: pngImagesArray });

                if (!result.data.success) {
                    throw new Error('OpenAI Parsing fehlgeschlagen');
                }

                const extractedData = result.data.data;
                extractedData.source = 'openai';

                // console.log('‚úÖ [OPENAI] Parsing erfolgreich:', extractedData);
                // console.log(`   - Fahrzeugdaten: ${extractedData.fahrzeugdaten ? 'ja' : 'nein'}`);
                // console.log(`   - Ersatzteile: ${extractedData.ersatzteile?.length || 0}`);
                // console.log(`   - Arbeitszeiten: ${extractedData.arbeitslohn?.length || 0}`);
                // console.log(`   - Lackierung: ${extractedData.lackierung?.length || 0}`);
                // console.log(`   - Tokens: ${result.data.meta.tokensUsed}`);
                // console.log(`   - Cost: $${result.data.meta.estimatedCost}`);

                showToast('‚úÖ PDF erfolgreich analysiert mit AI!', 'success');

                return extractedData;

            } catch (error) {
                console.error('‚ùå [OPENAI] Fehler:', error);

                // Show detailed error to user
                let errorMsg = 'PDF-Analyse mit AI fehlgeschlagen';
                if (error.message.includes('unauthenticated')) {
                    errorMsg = 'Authentifizierung fehlgeschlagen. Bitte erneut einloggen.';
                } else if (error.message.includes('OPENAI_API_KEY')) {
                    errorMsg = 'OpenAI API Key nicht konfiguriert. Kontaktieren Sie den Administrator.';
                }

                showToast('‚ùå ' + errorMsg, 'error', 5000);
                throw error;
            }
        }

        // ============================================
        // REGEX-BASED PDF PARSER (FALLBACK)
        // ============================================

        async function parseDatPdf(file) {
            // PDF.js Worker konfigurieren
            if (typeof pdfjsLib === 'undefined') {
                throw new Error('PDF.js Library nicht geladen');
            }

            pdfjsLib.GlobalWorkerOptions.workerSrc =
                'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';

            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

            let extractedData = {
                fahrzeugdaten: {},
                ersatzteile: [],
                arbeitslohn: [],
                lackierung: []
            };

            // Alle Seiten durchgehen
            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                const page = await pdf.getPage(pageNum);
                const textContent = await page.getTextContent();

                // =====================================================================
                // PHASE 2: COLUMN-BASED EXTRACTION (2025-11-11)
                // Nutze x/y-Koordinaten statt flattened text f√ºr 95% Erfolgsrate
                // =====================================================================

                // Alte Methode (60% success): Flatten text, verliert Struktur
                const text = textContent.items.map(item => item.str).join(' ');

                // Neue Methode (95% success): Table rows mit Spalten-Erkennung
                const tableRows = extractTableRows(textContent.items);

                // =====================================================================
                // STAGE 1 DEBUG: Verstehe warum Column-based nichts findet
                // =====================================================================
                if (window.DEBUG) // console.log(`üîç [COLUMN-DEBUG] Page ${pageNum}: ${tableRows.length} rows found`);
                tableRows.forEach((row, i) => {
                    // console.log(`   Row ${i+1}: ${row.columns.length} columns -`, row.columns.slice(0, 5));

                    // Zeige auch welche Spalte wie ein ETN aussieht
                    row.columns.forEach((col, colIdx) => {
                        if (/^\d{10}$/.test(col)) {
                            // console.log(`      ‚úì Column ${colIdx} matches 10-digit ETN: "${col}"`);
                        } else if (/^\d{4,8}[A-Z]\d{0,2}$/.test(col)) {
                            // console.log(`      ‚ö†Ô∏è Column ${colIdx} matches 6-8 digit ETN: "${col}" (NOT YET SUPPORTED)`);
                        }
                    });
                });
                // console.log('---');

                // Fahrzeugdaten: Nutze alte Regex-Methode (funktioniert gut f√ºr Header-Daten)
                extractFahrzeugdaten(text, extractedData);

                // Ersatzteile: NEUE Column-based extraction
                tableRows.forEach(row => {
                    // DAT Ersatzteil-Zeilen haben typischerweise 5-7 Spalten:
                    // [RC] [DVN] [ETN] [Benennung] [Anzahl] [Einzelpreis] [Gesamtpreis]
                    // Beispiel: "E" "45612" "9853894380" "SCHEINWERFER R. KOMPL" "1" "1532.10" "1532.10"

                    if (row.columns.length >= 5) {
                        // =====================================================================
                        // STAGE 2: Erweiterte ETN-Erkennung (10-digit ODER 6-8 digit mit Buchstabe)
                        // =====================================================================
                        // Finde ETN-Spalte (10-stellige Nummer oder 6-8 Stellen + Buchstabe)
                        let etnIndex = row.columns.findIndex(col => /^\d{10}$/.test(col));
                        let etnPattern = '10-digit';

                        // Fallback: 6-8 Stellen + Buchstabe (z.B. "6925P8")
                        if (etnIndex < 0) {
                            etnIndex = row.columns.findIndex(col => /^\d{4,8}[A-Z]\d{0,2}$/.test(col));
                            etnPattern = '6-8-digit';
                        }

                        if (etnIndex >= 0 && etnIndex < row.columns.length - 2) {
                            // console.log(`   üîç [STAGE2] Found ETN at column ${etnIndex} (${etnPattern}): "${row.columns[etnIndex]}"`);

                            const etn = row.columns[etnIndex];
                            const benennung = row.columns[etnIndex + 1];
                            const anzahl = parseInt(row.columns[etnIndex + 2]) || 1;

                            // Preise k√∂nnen in den letzten 2 Spalten sein
                            let einzelpreis = 0;
                            let gesamtpreis = 0;

                            if (row.columns.length >= etnIndex + 4) {
                                einzelpreis = parseGermanPrice(row.columns[etnIndex + 3]);
                            }
                            if (row.columns.length >= etnIndex + 5) {
                                gesamtpreis = parseGermanPrice(row.columns[etnIndex + 4]);
                            }

                            // Validierung: Nur wenn ETN + Benennung vorhanden
                            if (etn && benennung && benennung.length > 2) {
                                extractedData.ersatzteile.push({
                                    etn: etn.trim(),
                                    benennung: benennung.trim(),
                                    anzahl: anzahl,
                                    einzelpreis: einzelpreis,
                                    gesamtpreis: gesamtpreis || (einzelpreis * anzahl)
                                });

                                // console.log(`‚úÖ [COLUMN] Ersatzteil ${extractedData.ersatzteile.length}:`, {
                                    etn,
                                    benennung: benennung.substring(0, 30) + '...',
                                    anzahl,
                                    einzelpreis: einzelpreis.toFixed(2),
                                    gesamtpreis: (gesamtpreis || einzelpreis * anzahl).toFixed(2)
                                });
                            }
                        }
                    }
                });

                // Fallback-Chain: Column ‚Üí Row-based ‚Üí Flattened text
                const ersatzteilCountAfterColumn = extractedData.ersatzteile.length;

                // Fallback 1: Row-basiertes Regex Parsing
                if (ersatzteilCountAfterColumn === 0) {
                    // console.log('‚ö†Ô∏è Column-based extraction fand nichts, versuche Row-basiertes Regex...');
                    extractErsatzteileFromRows(tableRows, extractedData);
                }

                // Fallback 2: Flattened text Regex (letzte Option)
                const ersatzteilCountAfterRows = extractedData.ersatzteile.length;
                if (ersatzteilCountAfterRows === 0) {
                    // console.log('‚ö†Ô∏è Row-based Regex fand nichts, fallback zu flattened text...');
                    extractErsatzteile(text, extractedData);
                }

                // Arbeitslohn: Nutze alte Regex-Methode (funktioniert gut)
                extractArbeitslohn(text, extractedData);
            }

            // console.log('üìÑ Extracted PDF Data:', extractedData);
            return extractedData;
        }

        function extractFahrzeugdaten(text, extractedData) {
            // Hersteller: "Hersteller: Peugeot" oder "Hersteller Peugeot"
            const herstellerMatch = text.match(/Hersteller:?\s*([A-Z√Ñ√ñ√úa-z√§√∂√º√ü]+)/i);
            if (herstellerMatch && !extractedData.fahrzeugdaten.marke) {
                extractedData.fahrzeugdaten.marke = herstellerMatch[1];
                // console.log('‚úÖ Marke gefunden:', herstellerMatch[1]);
            }

            // Haupttyp: "Haupttyp: 508 SW (10.2018->)" oder "Typ: 508 SW"
            const haupttypMatch = text.match(/(?:Haupt)?[Tt]yp:?\s*([^\n\r]{3,50}?)(?:\s+\(|\s+$)/i);
            if (haupttypMatch && !extractedData.fahrzeugdaten.modell) {
                extractedData.fahrzeugdaten.modell = haupttypMatch[1].trim().split(' ').slice(0, 3).join(' ');
                // console.log('‚úÖ Modell gefunden:', extractedData.fahrzeugdaten.modell);
            }

            // VIN: "VIN: VR3FCYHZTPY554388" oder "Fahrgestell-Nr. VR3FCYHZTPY554388"
            const vinMatch = text.match(/(?:VIN|Fahrgestell[-\s]?Nr\.?)[:\s]+([A-HJ-NPR-Z0-9]{17})/i);
            if (vinMatch && !extractedData.fahrzeugdaten.vin) {
                extractedData.fahrzeugdaten.vin = vinMatch[1];
                // console.log('‚úÖ VIN gefunden:', vinMatch[1]);
            }

            // Kennzeichen: Multiple Patterns
            // Pattern 1: "Kontrollschild ROW-M 9044"
            // Pattern 2: "Kennzeichen: MOS-CG 1234"
            // Pattern 3: "amtl. Kennzeichen MOS CG 1234"
            const kennzeichenPatterns = [
                /(?:Kontrollschild|Kennzeichen|amtl\.\s+Kennzeichen)[:\s]+([A-Z√Ñ√ñ√ú]{1,3}[-\s][A-Z√Ñ√ñ√ú]{1,2}\s?\d{1,4}[A-Z]?)/i,
                /([A-Z√Ñ√ñ√ú]{1,3}[-\s][A-Z√Ñ√ñ√ú]{1,2}\s?\d{1,4}[A-Z]?)\s+(?:Kennzeichen|Kontrollschild)/i
            ];

            for (const pattern of kennzeichenPatterns) {
                const match = text.match(pattern);
                if (match && !extractedData.fahrzeugdaten.kennzeichen) {
                    extractedData.fahrzeugdaten.kennzeichen = match[1].replace(/\s+/g, ' ').trim();
                    break;
                }
            }

            // Farbcode: "Farbcode: B0NVL/B0MM0/EVL" oder "Farbnummer: B0NVL"
            const farbcodeMatch = text.match(/(?:Farbcode|Farbnummer|Lackcode)[:\s]+([A-Z0-9\/\-]+)/i);
            if (farbcodeMatch && !extractedData.fahrzeugdaten.farbcode) {
                extractedData.fahrzeugdaten.farbcode = farbcodeMatch[1];
            }

            // Fahrzeugfarbe: "LACKIERUNG PLATINIUM-GRAU/TYP" oder "Farbe: Grau"
            const farbMatch = text.match(/(?:LACKIERUNG|Farbe)[:\s]+([A-Z√Ñ√ñ√ú\-\s]+?)(?:\s+\/|\s+TYP|$)/i);
            if (farbMatch && !extractedData.fahrzeugdaten.farbname) {
                extractedData.fahrzeugdaten.farbname = farbMatch[1].trim().replace(/-/g, ' ');
            }
        }

        function extractErsatzteile(text, extractedData) {
            if (window.DEBUG) // console.log('üîç Extracting Ersatzteile from PDF...');

            // =====================================================================
            // STAGE 3: Verbessertes Regex Pattern f√ºr zuverl√§ssige Preis-Extraktion
            // STAGE 4: Unterst√ºtzung f√ºr optionalen RC/DVN Prefix (z.B. "E 45612")
            // =====================================================================
            // DAT-Tabelle Regex (ETN | Benennung | Anzahl | Preis/St√ºck | Gesamtpreis)
            // Improved pattern: Support mixed case, German characters, ETN variants (e.g., "6925P8"), Swiss number format
            // ETN can be:
            //   - 10 digits (standard): 1622749580
            //   - 4-8 digits + capital letter + 0-2 digits (variant): 6925P8
            // Optional prefix: RC (E/K/M) + DVN (45612) vor der ETN
            // STAGE 5: Benennung-Pattern von non-greedy zu greedy (2025-11-11)
            //
            // WICHTIG: Preise ohne \s (spaces) im Pattern - Spaces nur als Trenner zwischen Feldern
            // Benennung: GREEDY (nicht non-greedy!) - matched alle W√∂rter bis zur Anzahl
            //   - Non-greedy *? stoppte zu fr√ºh bei "SCHEINWERFER R." ‚Üí matched nur "SCHEINWERFER"
            //   - Greedy * matched alle W√∂rter inkl. "R." ‚Üí "SCHEINWERFER R." ‚úì
            // (?:[A-Z]\s+\d+\s+)? = Optional: RC Code + DVN vor ETN (z.B. "E 45612")
            const ersatzteilRegex = /(?:[A-Z]\s+\d+\s+)?(\d{10}|\d{4,8}[A-Z]\d{0,2})\s+([A-Z√Ñ√ñ√úa-z√§√∂√º√ü0-9\.\,\-\(\)\/]+(?:\s+[A-Z√Ñ√ñ√úa-z√§√∂√º√ü0-9\.\,\-\(\)\/]+)*)\s+(\d+)\s+([\d\'\.\,]+)\s+([\d\'\.\,]+)/g;

            let match;
            let count = 0;
            while ((match = ersatzteilRegex.exec(text)) !== null) {
                const etn = match[1].trim();
                const benennung = match[2].trim();
                const anzahl = parseInt(match[3]);

                // Handle different number formats (Swiss: 1'234.50, German: 1.234,50)
                const einzelpreisStr = match[4].replace(/\s/g, '').replace(/'/g, '').replace(',', '.');
                const gesamtpreisStr = match[5].replace(/\s/g, '').replace(/'/g, '').replace(',', '.');

                const einzelpreis = parseFloat(einzelpreisStr);
                const gesamtpreis = parseFloat(gesamtpreisStr);

                // Validate extracted data
                if (etn && benennung && anzahl > 0 && einzelpreis > 0) {
                    extractedData.ersatzteile.push({
                        etn: etn,
                        benennung: benennung,
                        anzahl: anzahl,
                        einzelpreis: einzelpreis,
                        gesamtpreis: gesamtpreis
                    });
                    count++;
                    // console.log(`‚úÖ Ersatzteil ${count} gefunden:`, {
                        etn,
                        benennung,
                        anzahl,
                        einzelpreis: einzelpreis.toFixed(2),
                        gesamtpreis: gesamtpreis.toFixed(2)
                    });
                }
            }

            if (count === 0) {
                console.warn('‚ö†Ô∏è Keine Ersatzteile gefunden. √úberpr√ºfe PDF-Format.');
            } else {
                // console.log(`‚úÖ Insgesamt ${count} Ersatzteile extrahiert`);
            }
        }

        // =====================================================================
        // STAGE 6: Row-basiertes Regex Parsing (2025-11-11)
        // Parsed jede PDF-Zeile EINZELN statt flattened text
        // Verhindert dass greedy pattern √ºber mehrere Zeilen matcht
        // =====================================================================
        function extractErsatzteileFromRows(tableRows, extractedData) {
            if (window.DEBUG) // console.log('üîç [ROW-BASED] Extracting Ersatzteile from table rows...');

            // Gleiches Regex wie extractErsatzteile() - aber angewendet auf einzelne Rows
            const ersatzteilRegex = /(?:[A-Z]\s+\d+\s+)?(\d{10}|\d{4,8}[A-Z]\d{0,2})\s+([A-Z√Ñ√ñ√úa-z√§√∂√º√ü0-9\.\,\-\(\)\/]+(?:\s+[A-Z√Ñ√ñ√úa-z√§√∂√º√ü0-9\.\,\-\(\)\/]+)*)\s+(\d+)\s+([\d\'\.\,]+)\s+([\d\'\.\,]+)/;

            let count = 0;
            tableRows.forEach((row, rowIndex) => {
                // Join columns zu einem String f√ºr diese Row
                const rowText = row.columns.join(' ');

                // Parse diese Row mit Regex (nicht global, nur erste Match)
                const match = rowText.match(ersatzteilRegex);

                if (match) {
                    const etn = match[1].trim();
                    const benennung = match[2].trim();
                    const anzahl = parseInt(match[3]);

                    // Handle different number formats (Swiss: 1'234.50, German: 1.234,50)
                    const einzelpreisStr = match[4].replace(/\s/g, '').replace(/'/g, '').replace(',', '.');
                    const gesamtpreisStr = match[5].replace(/\s/g, '').replace(/'/g, '').replace(',', '.');

                    const einzelpreis = parseFloat(einzelpreisStr);
                    const gesamtpreis = parseFloat(gesamtpreisStr);

                    // Validate extracted data
                    if (etn && benennung && anzahl > 0 && einzelpreis > 0) {
                        extractedData.ersatzteile.push({
                            etn: etn,
                            benennung: benennung,
                            anzahl: anzahl,
                            einzelpreis: einzelpreis,
                            gesamtpreis: gesamtpreis
                        });
                        count++;
                        // console.log(`‚úÖ [ROW ${rowIndex}] Ersatzteil ${count}:`, {
                            etn,
                            benennung: benennung.substring(0, 40) + (benennung.length > 40 ? '...' : ''),
                            anzahl,
                            einzelpreis: einzelpreis.toFixed(2),
                            gesamtpreis: gesamtpreis.toFixed(2)
                        });
                    }
                }
            });

            if (count === 0) {
                console.warn('‚ö†Ô∏è [ROW-BASED] Keine Ersatzteile gefunden');
            } else {
                // console.log(`‚úÖ [ROW-BASED] Insgesamt ${count} Ersatzteile extrahiert`);
            }
        }

        function extractArbeitslohn(text, extractedData) {
            // Arbeitslohn-Tabelle Regex
            const arbeitslohnRegex = /(ARBEITSAUFWAND|ZUSATZARBEIT)\s+([A-Z\s\.\-]+?)\s+([EKM])\s+([\d\.]+)\s+([\d\.]+)\s+([\d\.]+)/g;

            let match;
            while ((match = arbeitslohnRegex.exec(text)) !== null) {
                extractedData.arbeitslohn.push({
                    position: match[2].trim(),
                    art: match[3],
                    stunden: parseFloat(match[4]),
                    stundensatz: parseFloat(match[5]),
                    gesamtpreis: parseFloat(match[6])
                });
            }
        }

        // ============================================================================
        // PHASE 2: COLUMN-BASED PDF PARSING (2025-11-11)
        // ChatGPT-Style Extraction mit x/y-Koordinaten f√ºr 95% Erfolgsrate
        // ============================================================================

        /**
         * Extrahiert Tabellen-Zeilen aus PDF.js textContent items
         * Nutzt x/y-Koordinaten f√ºr Spalten-Erkennung (wie ChatGPT)
         * @param {Array} items - textContent.items from PDF.js
         * @returns {Array} rows - Array of {y, columns: []} objects
         */
        function extractTableRows(items) {
            // Gruppiere nach Y-Koordinate (Zeilen-Erkennung)
            const rowMap = new Map();
            const TOLERANCE = 5; // Pixel-Toleranz f√ºr gleiche Zeile

            items.forEach(item => {
                const y = item.transform[5]; // Y-Position aus transform matrix
                const rowKey = Math.round(y / TOLERANCE) * TOLERANCE;

                if (!rowMap.has(rowKey)) {
                    rowMap.set(rowKey, []);
                }

                rowMap.get(rowKey).push({
                    x: item.transform[4],  // X-Position
                    y: y,
                    text: item.str,
                    width: item.width
                });
            });

            // Sortiere jede Zeile nach X-Koordinate und erkenne Spalten
            const rows = [];
            for (const [y, items] of rowMap.entries()) {
                items.sort((a, b) => a.x - b.x);

                // Erkenne Spalten-Breaks (L√ºcke > 20px zwischen Items)
                const columns = [];
                let currentColumn = '';
                let lastX = -1;

                items.forEach(item => {
                    if (lastX >= 0 && item.x - lastX > 20) {
                        // Neue Spalte beginnt
                        columns.push(currentColumn.trim());
                        currentColumn = '';
                    }
                    currentColumn += item.text;
                    lastX = item.x + item.width;
                });

                // Letzte Spalte nicht vergessen
                if (currentColumn) {
                    columns.push(currentColumn.trim());
                }

                rows.push({ y, columns });
            }

            // Sortiere von oben nach unten (Y absteigend in PDF-Koordinaten)
            return rows.sort((a, b) => b.y - a.y);
        }

        /**
         * Parsed German/Swiss number formats
         * Beispiel: "1'532.10" oder "1.532,10" ‚Üí 1532.10
         * @param {string} priceStr - Price string
         * @returns {number} parsed price
         */
        function parseGermanPrice(priceStr) {
            if (!priceStr) return 0;

            // Entferne Tausender-Trennzeichen (' . oder whitespace)
            // und ersetze Komma durch Punkt
            const cleaned = priceStr
                .replace(/['\s]/g, '')    // Entferne ' und whitespace
                .replace(/\./g, '')       // Entferne Punkte (Tausender)
                .replace(',', '.');       // Komma ‚Üí Punkt (Dezimaltrennzeichen)

            return parseFloat(cleaned) || 0;
        }

        // ============================================================================
        // STUFE 2: HYBRID MERGE FUNCTION (2025-11-11)
        // Kombiniert PDF + Text Extraktionen intelligent f√ºr 97-98% Zuverl√§ssigkeit
        // ============================================================================

        /**
         * Merged two extractions intelligently
         * @param {Object} primary - Primary extraction (higher confidence)
         * @param {Object} secondary - Secondary extraction (fallback/fill gaps)
         * @param {string} strategy - 'hybrid' or 'pdf-primary' or 'text-primary'
         * @returns {Object} Merged extraction with combined ersatzteile
         */
        function mergeExtractions(primary, secondary, strategy = 'hybrid') {
            // console.log(`üîÑ [MERGE] Starting merge - Strategy: ${strategy}`);
            // console.log(`üìä Primary: ${primary.ersatzteile.length} parts (source: ${primary.source || 'unknown'})`);
            // console.log(`üìä Secondary: ${secondary.ersatzteile.length} parts (source: ${secondary.source || 'unknown'})`);

            const merged = {
                fahrzeugdaten: primary.fahrzeugdaten || secondary.fahrzeugdaten || {},
                ersatzteile: [],
                arbeitslohn: primary.arbeitslohn || secondary.arbeitslohn || [],
                lackierung: primary.lackierung || secondary.lackierung || [],
                source: strategy,
                mergeStats: {
                    primaryCount: primary.ersatzteile.length,
                    secondaryCount: secondary.ersatzteile.length,
                    matched: 0,
                    uniqueToPrimary: 0,
                    uniqueToSecondary: 0,
                    priceConflicts: [],
                    descriptionConflicts: []
                }
            };

            // Build ETN map from secondary for fast lookup
            const secondaryMap = new Map(
                secondary.ersatzteile.map(part => [part.etn, part])
            );

            // Process primary parts
            primary.ersatzteile.forEach(primaryPart => {
                const secondaryPart = secondaryMap.get(primaryPart.etn);

                if (secondaryPart) {
                    // Found in both ‚Üí VALIDATE
                    merged.mergeStats.matched++;

                    // Check price conflict (>5% difference)
                    const priceDiff = Math.abs(primaryPart.einzelpreis - secondaryPart.einzelpreis);
                    const priceDiffPercent = primaryPart.einzelpreis > 0
                        ? (priceDiff / primaryPart.einzelpreis) * 100
                        : 0;

                    if (priceDiffPercent > 5) {
                        merged.mergeStats.priceConflicts.push({
                            etn: primaryPart.etn,
                            primaryPrice: primaryPart.einzelpreis,
                            secondaryPrice: secondaryPart.einzelpreis,
                            difference: priceDiffPercent.toFixed(1) + '%'
                        });
                        console.warn(`‚ö†Ô∏è [MERGE] Preiskonflikt bei ${primaryPart.etn}: Primary=${primaryPart.einzelpreis.toFixed(2)}‚Ç¨, Secondary=${secondaryPart.einzelpreis.toFixed(2)}‚Ç¨ (${priceDiffPercent.toFixed(1)}%)`);
                    }

                    // Check description conflict
                    if (primaryPart.benennung !== secondaryPart.benennung) {
                        merged.mergeStats.descriptionConflicts.push({
                            etn: primaryPart.etn,
                            primaryDesc: primaryPart.benennung,
                            secondaryDesc: secondaryPart.benennung
                        });
                    }

                    // Keep primary (assumed higher confidence)
                    merged.ersatzteile.push({
                        ...primaryPart,
                        source: 'both',
                        validated: true
                    });

                    secondaryMap.delete(primaryPart.etn); // Mark as processed

                } else {
                    // Only in primary
                    merged.mergeStats.uniqueToPrimary++;
                    merged.ersatzteile.push({
                        ...primaryPart,
                        source: 'primary-only'
                    });
                }
            });

            // Add remaining secondary parts (unique to secondary)
            secondaryMap.forEach(secondaryPart => {
                merged.mergeStats.uniqueToSecondary++;
                merged.ersatzteile.push({
                    ...secondaryPart,
                    source: 'secondary-fill'
                });
                // console.log(`‚ûï [MERGE] Added from secondary: ${secondaryPart.etn} - ${secondaryPart.benennung.substring(0, 30)}...`);
            });

            // Summary logging
            // console.log(`‚úÖ [MERGE] Complete! Results:`);
            // console.log(`   - Total: ${merged.ersatzteile.length} parts`);
            // console.log(`   - Matched (in both): ${merged.mergeStats.matched}`);
            // console.log(`   - Unique to primary: ${merged.mergeStats.uniqueToPrimary}`);
            // console.log(`   - Unique to secondary: ${merged.mergeStats.uniqueToSecondary}`);
            // console.log(`   - Price conflicts: ${merged.mergeStats.priceConflicts.length}`);
            // console.log(`   - Description conflicts: ${merged.mergeStats.descriptionConflicts.length}`);

            // Show user feedback if conflicts exist
            if (merged.mergeStats.priceConflicts.length > 0) {
                showToast(
                    `‚ö†Ô∏è ${merged.mergeStats.priceConflicts.length} Preiskonflikt${merged.mergeStats.priceConflicts.length > 1 ? 'e' : ''} gefunden (siehe Console)`,
                    'warning',
                    5000
                );
            }

            return merged;
        }

        function fillFormFromPdf(pdfData) {
            const fd = pdfData.fahrzeugdaten;

            // Kennzeichen
            if (fd.kennzeichen) {
                document.getElementById('kennzeichen').value = fd.kennzeichen.toUpperCase();
            }

            // Marke
            if (fd.marke) {
                const markeSelect = document.getElementById('marke');
                // Pr√ºfe ob Marke im Dropdown existiert
                const option = Array.from(markeSelect.options).find(opt =>
                    opt.value.toLowerCase() === fd.marke.toLowerCase()
                );
                if (option) {
                    markeSelect.value = option.value;
                } else {
                    markeSelect.value = 'Sonstige';
                }
            }

            // Modell
            if (fd.modell) {
                document.getElementById('modell').value = fd.modell;
            }

            // VIN
            if (fd.vin) {
                document.getElementById('vin').value = fd.vin;
            }

            // Farbe
            if (fd.farbcode) {
                document.getElementById('farbnummer').value = fd.farbcode;
            }
            if (fd.farbname) {
                document.getElementById('farbname').value = fd.farbname;
            }
        }

        /**
         * Speichert Ersatzteile in zentrale Ersatzteile-DB (ersatzteile_mosbach)
         * Erm√∂glicht sp√§tere Statistiken, API-Integrationen und Ersatzteil-Suche
         * @param {Array} ersatzteile - Array von Ersatzteilen (ersatzteileData)
         * @param {string} fahrzeugId - ID des Fahrzeugs
         * @param {string} kennzeichen - Kennzeichen des Fahrzeugs
         * @param {string} kundenname - Name des Kunden
         * @returns {Promise<number>} Anzahl der gespeicherten Ersatzteile
         */
        async function saveErsatzteileToCentralDB(ersatzteile, fahrzeugId, kennzeichen, kundenname) {
            if (!ersatzteile || ersatzteile.length === 0) {
                // console.log('‚ÑπÔ∏è Keine Ersatzteile zum Speichern');
                return 0;
            }

            if (!window.db) {
                console.error('‚ùå Firebase nicht initialisiert');
                return 0;
            }

            // ‚úÖ SECURITY FIX: No 'mosbach' fallback - werkstattId must be validated at login
            if (!window.werkstattId) {
                console.error('‚ùå werkstattId nicht gesetzt - Ersatzteile werden nicht gespeichert');
                return 0;
            }
            // console.log(`üóÑÔ∏è Speichere ${ersatzteile.length} Ersatzteile in zentrale DB (ersatzteile_${window.werkstattId})...`);

            const userName = localStorage.getItem('userName') || 'Admin';
            const werkstattId = window.werkstattId;
            const batch = window.db.batch();
            let successCount = 0;

            for (const teil of ersatzteile) {
                try {
                    const ersatzteilId = 'et_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

                    // Zentrale Ersatzteil-Daten
                    const ersatzteilData = {
                        id: ersatzteilId,
                        etn: teil.etn || '',
                        benennung: teil.benennung || '',
                        einzelpreis: teil.einzelpreis || 0,
                        // Referenz-Daten
                        fahrzeugId: fahrzeugId,
                        kennzeichen: kennzeichen,
                        kundenname: kundenname,
                        // Meta-Daten
                        werkstattId: werkstattId,
                        createdAt: new Date().toISOString(),
                        createdBy: userName,
                        // Optional: Anzahl aus diesem spezifischen Auftrag
                        anzahlInAuftrag: teil.anzahl || 1,
                        gesamtpreisInAuftrag: teil.gesamtpreis || 0
                    };

                    // In Batch hinzuf√ºgen
                    const docRef = window.getCollection('ersatzteile').doc(ersatzteilId);
                    batch.set(docRef, ersatzteilData);

                    successCount++;
                } catch (error) {
                    console.error('‚ùå Fehler beim Speichern von Ersatzteil:', teil, error);
                }
            }

            // Batch commit
            try {
                await batch.commit();
                // console.log(`‚úÖ ${successCount} Ersatzteile erfolgreich in zentraler DB gespeichert`);
                return successCount;
            } catch (error) {
                console.error('‚ùå Batch-Commit fehlgeschlagen:', error);
                throw error;
            }
        }

        /**
         * Speichert PDF-extrahierte Ersatzteile als Material-Requests
         * @param {Array} ersatzteile - Array von Ersatzteil-Objekten aus PDF
         * @param {string} kennzeichen - Kennzeichen des Fahrzeugs f√ºr Zuordnung
         * @returns {Promise<number>} Anzahl der erstellten Requests
         */
        async function savePdfErsatzteileAsRequests(ersatzteile, kennzeichen) {
            if (!ersatzteile || ersatzteile.length === 0) {
                // console.log('‚ÑπÔ∏è Keine Ersatzteile zum Speichern');
                return 0;
            }

            if (!window.db) {
                console.error('‚ùå Firebase nicht initialisiert');
                return 0;
            }

            // console.log(`üì¶ Speichere ${ersatzteile.length} Ersatzteile als Material-Requests...`);

            const today = new Date().toISOString().split('T')[0];
            const userName = localStorage.getItem('userName') || 'Admin';
            const batch = window.db.batch();
            let successCount = 0;

            // Kalender-Eintr√§ge sammeln
            const calendarEntries = [];

            for (const teil of ersatzteile) {
                try {
                    const requestId = 'req_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

                    // Material-Request Daten
                    const requestData = {
                        id: requestId,
                        photo: null, // Kein Foto bei PDF-Import
                        description: `ETN: ${teil.etn} - ${teil.benennung} (Anzahl: ${teil.anzahl}, Einzelpreis: ${teil.einzelpreis.toFixed(2)} ‚Ç¨)`,
                        requestedBy: userName,
                        timestamp: new Date().toISOString(),
                        status: 'pending',
                        // Zus√§tzliche Daten f√ºr PDF-Import
                        source: 'pdf-import',
                        kennzeichen: kennzeichen || 'Unbekannt',
                        etn: teil.etn,
                        benennung: teil.benennung,
                        anzahl: teil.anzahl,
                        einzelpreis: teil.einzelpreis,
                        gesamtpreis: teil.gesamtpreis
                    };

                    // In Batch hinzuf√ºgen
                    const docRef = window.getCollection('materialRequests').doc(requestId);
                    batch.set(docRef, requestData);

                    // Kalender-Eintrag vorbereiten
                    calendarEntries.push({
                        type: 'material',
                        requestId: requestId,
                        description: `PDF-Import: ${teil.benennung}`,
                        requestedBy: userName,
                        zeit: new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })
                    });

                    successCount++;
                } catch (error) {
                    console.error('‚ùå Fehler beim Erstellen von Request f√ºr Teil:', teil, error);
                }
            }

            // Batch commit
            try {
                await batch.commit();
                // console.log(`‚úÖ ${successCount} Material-Requests erfolgreich erstellt`);

                // Kalender-Eintr√§ge hinzuf√ºgen
                const calendarDoc = await window.getCollection('calendar').doc(today).get();

                if (calendarDoc.exists) {
                    const existingEntries = calendarDoc.data().entries || [];
                    await window.getCollection('calendar').doc(today).update({
                        entries: [...existingEntries, ...calendarEntries]
                    });
                } else {
                    await window.getCollection('calendar').doc(today).set({
                        entries: calendarEntries
                    });
                }

                // console.log(`‚úÖ ${calendarEntries.length} Kalender-Eintr√§ge erstellt`);

            } catch (error) {
                console.error('‚ùå Fehler beim Speichern der Material-Requests:', error);
                return 0;
            }

            return successCount;
        }

        /**
         * ============================================
         * AUTOMATISCHE ERSATZTEILE-PIPELINE (2025-11-11)
         * ============================================
         * Konvertiert PDF-extrahierte Ersatzteile automatisch zu Bestellungen
         * WICHTIG: Nur Teile mit ETN werden bestellt (ETN = Identifikationsnummer)
         *
         * @param {Array} ersatzteile - Array von Ersatzteil-Objekten aus PDF
         * @param {string} kennzeichen - Kennzeichen des Fahrzeugs
         * @param {string} fahrzeugId - ID des Fahrzeugs in Firestore
         * @returns {Promise<number>} Anzahl der erstellten Bestellungen
         */
        async function autoConvertErsatzteileToBestellungen(ersatzteile, kennzeichen, fahrzeugId) {
            if (!ersatzteile || ersatzteile.length === 0) {
                // console.log('‚ÑπÔ∏è Keine Ersatzteile f√ºr Auto-Konvertierung');
                return 0;
            }

            if (!window.db) {
                console.error('‚ùå Firebase nicht initialisiert');
                return 0;
            }

            // console.log(`üîÑ AUTO-PIPELINE: Konvertiere ${ersatzteile.length} Ersatzteile zu Bestellungen...`);

            const userName = localStorage.getItem('userName') || 'Admin';
            // ‚úÖ SECURITY FIX: No 'mosbach' fallback - werkstattId must be validated at login
            if (!window.werkstattId) {
                console.error('‚ùå werkstattId nicht gesetzt - Bestellungen werden nicht erstellt');
                return 0;
            }
            const werkstattId = window.werkstattId;
            const batch = window.db.batch();
            let bestellungenCreated = 0;
            let bestellungenSkipped = 0;

            for (const teil of ersatzteile) {
                // Skip wenn kein ETN vorhanden (keine Teilenummer = nicht bestellbar)
                if (!teil.etn || teil.etn.trim() === '') {
                    // console.log(`   ‚è≠Ô∏è √úberspringe Teil ohne ETN: ${teil.benennung}`);
                    bestellungenSkipped++;
                    continue;
                }

                try {
                    const bestellungId = 'best_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

                    const bestellungData = {
                        id: bestellungId,
                        etn: teil.etn,
                        benennung: teil.benennung,
                        menge: teil.anzahl || 1,
                        einzelpreis: parseFloat(teil.einzelpreis) || 0,
                        gesamtpreis: parseFloat(teil.gesamtpreis) || 0,
                        status: 'bestellt',
                        bestelltVon: userName,
                        bestelltAm: new Date().toISOString(),
                        werkstattId: werkstattId,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        fahrzeugId: String(fahrzeugId),  // FIX 2025-11-13: Force String for Firestore query consistency
                        kennzeichen: kennzeichen,
                        source: 'pdf-auto',  // Markierung f√ºr automatische Erstellung
                        sourceRequestId: null,  // Keine Material-Request (direkt aus PDF)

                        // ============================================
                        // NEUE FELDER (2025-11-11): Erweiterte Bestellverwaltung
                        // ============================================
                        preisGeschaetzt: parseFloat(teil.einzelpreis) || 0,    // Gesch√§tzter Preis (f√ºr sp√§tere Varianz-Berechnung)
                        preisTatsaechlich: null,                                // Tats√§chlicher Preis (wird sp√§ter editiert)
                        voraussichtlicheAnkunft: null,                          // Erwartetes Lieferdatum (ISO 8601)
                        lieferant: {                                            // Lieferanten-Informationen
                            name: '',                                           // Name des Lieferanten
                            kontakt: '',                                        // Kontaktinformationen
                            bestellnummer: ''                                   // Bestellnummer beim Lieferanten
                        },
                        notizen: ''                                             // Interne Notizen zur Bestellung
                    };

                    const docRef = window.getCollection('bestellungen').doc(bestellungId);
                    batch.set(docRef, bestellungData);

                    bestellungenCreated++;
                    // console.log(`   ‚úÖ Bestellung erstellt: ${teil.etn} - ${teil.benennung}`);

                } catch (error) {
                    console.error(`   ‚ùå Fehler beim Erstellen von Bestellung f√ºr Teil:`, teil, error);
                }
            }

            // Batch commit
            if (bestellungenCreated > 0) {
                try {
                    await batch.commit();
                    // console.log(`‚úÖ AUTO-PIPELINE: ${bestellungenCreated} Bestellungen automatisch erstellt`);
                    if (bestellungenSkipped > 0) {
                        // console.log(`‚ÑπÔ∏è AUTO-PIPELINE: ${bestellungenSkipped} Teile √ºbersprungen (kein ETN)`);
                    }
                } catch (error) {
                    console.error('‚ùå Fehler beim Speichern der Auto-Bestellungen:', error);
                    return 0;
                }
            } else {
                // console.log('‚ÑπÔ∏è AUTO-PIPELINE: Keine Bestellungen erstellt (alle Teile ohne ETN)');
            }

            return bestellungenCreated;
        }

        function removePdf() {
            document.getElementById('datPdfInput').value = '';
            document.getElementById('pdfFileName').textContent = '';
            document.getElementById('pdfRemoveBtn').style.display = 'none';
            pdfData = null;
        }

        /**
         * Handler f√ºr Text-Parsing Button
         */
        function handleTextParsing() {
            const textInput = document.getElementById('datTextInput');
            const text = textInput.value.trim();

            if (!text) {
                showToast('‚ùå Bitte Text einf√ºgen', 'error');
                return;
            }

            try {
                // console.log('üìã Parsing DAT-Text...');
                const parsedData = parseDatText(text);
                parsedData.source = 'text';

                // =====================================================================
                // STUFE 1: OVERWRITE PROTECTION (2025-11-11)
                // Verhindert Datenverlust wenn User beide Methoden nutzt
                // =====================================================================

                // Check if PDF data already exists
                if (pdfData && pdfData.ersatzteile && pdfData.ersatzteile.length > 0) {
                    const confirmed = confirm(
                        `‚ö†Ô∏è Es wurden bereits ${pdfData.ersatzteile.length} Ersatzteile aus PDF extrahiert.\n\n` +
                        `M√∂chten Sie diese mit der Text-Extraktion ERSETZEN?\n\n` +
                        `üí° TIPP: Klicken Sie "Abbrechen" - Wir k√∂nnen beide Methoden KOMBINIEREN f√ºr h√∂here Zuverl√§ssigkeit (97-98%)!`
                    );

                    if (!confirmed) {
                        // User wants to MERGE ‚Üí Trigger hybrid merge!
                        // console.log('üîÑ User w√§hlte MERGE ‚Üí Kombiniere PDF + Text');
                        pdfData = mergeExtractions(pdfData, parsedData, 'hybrid');

                        // Fill Form with merged data
                        fillFormFromPdf(pdfData);
                        renderErsatzteilePreview(pdfData.ersatzteile);
                        renderArbeitslohnPreview(pdfData.arbeitslohn);
                        renderLackierungPreview(pdfData.lackierung);
                        updateGesamtsumme(pdfData);

                        // UI Feedback
                        const statusSpan = document.getElementById('textParseStatus');
                        const clearBtn = document.getElementById('clearTextBtn');
                        const teileCount = pdfData.ersatzteile.length;

                        statusSpan.textContent = `‚úÖ ${teileCount} Ersatzteil${teileCount > 1 ? 'e' : ''} kombiniert (PDF + Text)`;
                        clearBtn.style.display = 'inline-block';

                        showToast(`‚úÖ Kombiniert: ${teileCount} Ersatzteile (PDF + Text)`, 'success');
                        return;
                    } else {
                        // User confirmed REPLACE
                        // console.log('‚ö†Ô∏è User w√§hlte REPLACE ‚Üí PDF-Daten werden √ºberschrieben');
                    }
                }

                // Normal flow: Replace or no PDF data exists
                pdfData = parsedData;

                // Fill Form
                fillFormFromPdf(parsedData);

                // WICHTIG: Zeige Preview-Tabelle
                renderErsatzteilePreview(parsedData.ersatzteile);
                renderArbeitslohnPreview(parsedData.arbeitslohn);
                renderLackierungPreview(parsedData.lackierung);
                updateGesamtsumme(parsedData);

                // UI Feedback
                const statusSpan = document.getElementById('textParseStatus');
                const clearBtn = document.getElementById('clearTextBtn');

                const teileCount = parsedData.ersatzteile.length;
                statusSpan.textContent = `‚úÖ ${teileCount} Ersatzteil${teileCount > 1 ? 'e' : ''} gefunden`;
                clearBtn.style.display = 'inline-block';

                showToast(`‚úÖ ${teileCount} Ersatzteile extrahiert`, 'success');

            } catch (error) {
                console.error('‚ùå Fehler beim Text-Parsing:', error);
                showToast('‚ùå Fehler beim Auslesen des Textes', 'error');
            }
        }

        /**
         * Parse DAT-Text (kopierter Kostenvoranschlag)
         * @param {string} text - DAT-Auftrag Text
         * @returns {Object} Parsed data {fahrzeugdaten, ersatzteile, arbeitslohn, lackierung}
         */
        function parseDatText(text) {
            const data = {
                fahrzeugdaten: {},
                ersatzteile: [],
                arbeitslohn: [],
                lackierung: []
            };

            // Ersatzteile extrahieren (Hauptfunktion)
            extractErsatzteileFromText(text, data);

            // Optional: Arbeitslohn + Lackierung (sp√§ter implementieren)
            // extractArbeitslohnFromText(text, data);
            // extractLackierungFromText(text, data);

            return data;
        }

        /**
         * Normalisiert DAT-Text f√ºr zuverl√§ssiges Parsing
         * Fixes:
         * - Entfernt Header-Zeilen
         * - Merged broken lines (Zeilen ohne ETN)
         * - Stoppt bei "Arbeitslohn"
         *
         * @param {string} text - Raw DAT-Text
         * @returns {string} Normalized text
         */
        function normalizeDatText(text) {
            // console.log('üîß Normalizing DAT-Text...');

            // Split into lines
            const lines = text.split('\n');
            const normalizedLines = [];
            let currentLine = '';

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();

                // Skip empty lines
                if (!line) {
                    continue;
                }

                // Stop at "Arbeitslohn" (only parse Ersatzteile section)
                if (line.includes('Arbeitslohn')) {
                    break;
                }

                // Skip header lines
                if (line.startsWith('RC DVN ETN') || line.startsWith('Reparaturkosten') || line.includes('Gesamtpreis')) {
                    continue;
                }

                // Check if line starts with ETN pattern OR RC/DVN prefix
                const startsWithETN = /^(\d{10}|\d{4,8}[A-Z]\d{0,2})/.test(line);
                const startsWithPrefix = /^[A-Z]\s+\d+/.test(line);

                if (startsWithETN || startsWithPrefix) {
                    // New entry starts
                    if (currentLine) {
                        normalizedLines.push(currentLine);
                    }
                    currentLine = line;
                } else {
                    // Continuation of previous line (broken line)
                    currentLine += ' ' + line;
                }
            }

            // Add last line
            if (currentLine) {
                normalizedLines.push(currentLine);
            }

            const normalizedText = normalizedLines.join('\n');
            // console.log('‚úÖ Text normalized:', normalizedLines.length, 'lines');
            return normalizedText;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ERSATZTEILE TABELLE: Permanent, Editierbar
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        let ersatzteileData = []; // Global array to store all Ersatzteile

        /**
         * L√§dt Ersatzteile in die editierbare Tabelle
         * @param {Array} ersatzteile - Array von Ersatzteil-Objekten (aus PDF oder manuell)
         */
        function renderErsatzteilePreview(ersatzteile) {
            if (ersatzteile && ersatzteile.length > 0) {
                // PDF-Daten ‚Üí in globales Array laden
                ersatzteile.forEach(teil => addErsatzteilRow(teil));
                // console.log(`‚úÖ ${ersatzteile.length} Ersatzteile in Tabelle geladen (PDF-Import)`);
            }
        }

        /**
         * F√ºgt eine neue Ersatzteil-Zeile hinzu (leer oder mit Daten)
         * @param {Object} data - Optional: { etn, benennung, anzahl, einzelpreis }
         */
        function addErsatzteilRow(data = {}) {
            const tableBody = document.getElementById('ersatzteileTableBody');
            const rowIndex = ersatzteileData.length;

            // Daten mit Defaults
            const teil = {
                etn: data.etn || '',
                benennung: data.benennung || '',
                anzahl: data.anzahl || 1,
                einzelpreis: data.einzelpreis || 0,
                gesamtpreis: data.gesamtpreis || (data.anzahl || 1) * (data.einzelpreis || 0)
            };

            // In globales Array speichern
            ersatzteileData.push(teil);

            // Neue Zeile erstellen
            const row = document.createElement('tr');
            row.dataset.index = rowIndex;
            row.style.borderBottom = '1px solid rgba(0,0,0,0.1)';
            row.style.background = rowIndex % 2 === 0 ? 'rgba(255,255,255,0.5)' : 'transparent';

            row.innerHTML = `
                <td style="padding: 4px;">
                    <input type="text" value="${teil.etn}" onchange="updateErsatzteil(${rowIndex}, 'etn', this.value)"
                           style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 12px;">
                </td>
                <td style="padding: 4px;">
                    <input type="text" value="${teil.benennung}" onchange="updateErsatzteil(${rowIndex}, 'benennung', this.value)"
                           style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                </td>
                <td style="padding: 4px;">
                    <input type="number" value="${teil.anzahl}" onchange="updateErsatzteil(${rowIndex}, 'anzahl', this.value)" min="1" step="1"
                           style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px; text-align: center; font-size: 12px;">
                </td>
                <td style="padding: 4px;">
                    <input type="number" value="${teil.einzelpreis.toFixed(2)}" onchange="updateErsatzteil(${rowIndex}, 'einzelpreis', this.value)" min="0" step="0.01"
                           style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px; text-align: right; font-family: 'Courier New', monospace; font-size: 12px;">
                </td>
                <td style="padding: 4px;">
                    <input type="number" value="${teil.gesamtpreis.toFixed(2)}" readonly
                           style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px; text-align: right; background: #f5f5f5; font-weight: 600; color: var(--color-success); font-family: 'Courier New', monospace; font-size: 12px;">
                </td>
                <td style="padding: 4px; text-align: center;">
                    <button type="button" onclick="deleteErsatzteilRow(${rowIndex})"
                            style="padding: 4px 8px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                        üóëÔ∏è
                    </button>
                </td>
            `;

            tableBody.appendChild(row);
            updateErsatzteileSumme();

            // Feather icons neu rendern
            if (typeof feather !== 'undefined') feather.replace();
        }

        /**
         * Aktualisiert ein Ersatzteil-Feld
         */
        function updateErsatzteil(index, field, value) {
            if (!ersatzteileData[index]) return;

            // Wert aktualisieren
            if (field === 'anzahl' || field === 'einzelpreis') {
                ersatzteileData[index][field] = parseFloat(value) || 0;
                // Gesamtpreis neu berechnen
                ersatzteileData[index].gesamtpreis = ersatzteileData[index].anzahl * ersatzteileData[index].einzelpreis;

                // Gesamtpreis-Feld aktualisieren
                const row = document.querySelector(`tr[data-index="${index}"]`);
                if (row) {
                    // üîß FIX A4 (2025-12-12): Array Bounds-Check
                    const inputs = row.querySelectorAll('input');
                    const gesamtpreisInput = inputs.length > 4 ? inputs[4] : null; // 5. Input = Gesamtpreis
                    if (gesamtpreisInput) {
                        gesamtpreisInput.value = ersatzteileData[index].gesamtpreis.toFixed(2);
                    }
                }
            } else {
                ersatzteileData[index][field] = value;
            }

            updateErsatzteileSumme();
            updateKostenaufschluesselung();
        }

        /**
         * L√∂scht eine Ersatzteil-Zeile
         */
        function deleteErsatzteilRow(index) {
            if (!confirm('Diese Zeile wirklich l√∂schen?')) return;

            // Aus Array entfernen
            ersatzteileData.splice(index, 1);

            // Tabelle neu rendern
            reRenderErsatzteileTable();
            updateErsatzteileSumme();
            updateKostenaufschluesselung();
        }

        /**
         * Rendert die komplette Tabelle neu (nach Delete)
         */
        function reRenderErsatzteileTable() {
            const tableBody = document.getElementById('ersatzteileTableBody');
            tableBody.innerHTML = '';

            // Alle Zeilen neu erstellen
            const tempData = [...ersatzteileData];
            ersatzteileData = [];
            tempData.forEach(teil => addErsatzteilRow(teil));
        }

        /**
         * Berechnet und aktualisiert die Summe
         */
        function updateErsatzteileSumme() {
            const summe = ersatzteileData.reduce((sum, teil) => sum + (teil.gesamtpreis || 0), 0);
            document.getElementById('ersatzteileSumme').textContent = summe.toFixed(2) + ' ‚Ç¨';
            document.getElementById('ersatzteileCount').textContent = ersatzteileData.length;
        }

        /**
         * Aktualisiert die Kostenaufschl√ºsselung (sync mit allen 3 Tabellen)
         */
        function updateKostenaufschluesselung() {
            const ersatzteileSumme = ersatzteileData.reduce((sum, t) => sum + (t.gesamtpreis || 0), 0);
            const arbeitslohnSumme = arbeitslohnData.reduce((sum, t) => sum + (t.gesamtpreis || 0), 0);
            const lackierungSumme = lackierungData.reduce((sum, t) => sum + (t.gesamtpreis || 0), 0);
            const materialienSumme = materialienData.reduce((sum, t) => sum + (t.gesamtpreis || 0), 0);

            // Update alle 4 Kostenfelder
            const kostenErsatzteile = document.getElementById('kostenErsatzteile');
            const kostenArbeitslohn = document.getElementById('kostenArbeitslohn');
            const kostenLackierung = document.getElementById('kostenLackierung');
            const kostenMaterialien = document.getElementById('kostenMaterialien');

            if (kostenErsatzteile) kostenErsatzteile.value = ersatzteileSumme.toFixed(2);
            if (kostenArbeitslohn) kostenArbeitslohn.value = arbeitslohnSumme.toFixed(2);
            if (kostenLackierung) kostenLackierung.value = lackierungSumme.toFixed(2);
            if (kostenMaterialien) kostenMaterialien.value = materialienSumme.toFixed(2);

            // Netto-Summe berechnen
            const nettoSumme = ersatzteileSumme + arbeitslohnSumme + lackierungSumme + materialienSumme;
            const summeNetto = document.getElementById('summeNetto');
            if (summeNetto) summeNetto.value = nettoSumme.toFixed(2);

            // MwSt berechnen
            const mwstSatz = parseFloat(document.getElementById('mwstSatz')?.value) || 19;
            const mwstBetrag = nettoSumme * (mwstSatz / 100);
            const mwstBetragField = document.getElementById('mwstBetrag');
            if (mwstBetragField) mwstBetragField.value = mwstBetrag.toFixed(2);

            // Brutto-Summe berechnen
            const bruttoSumme = nettoSumme + mwstBetrag;
            const summeBrutto = document.getElementById('summeBrutto');
            if (summeBrutto) summeBrutto.textContent = bruttoSumme.toFixed(2) + ' ‚Ç¨';

            // Vereinbarter Preis NUR aktualisieren wenn nicht manuell overridden
            const manualOverride = document.getElementById('manualPriceOverride')?.checked;
            const vereinbarterPreis = document.getElementById('vereinbarterPreis');

            if (vereinbarterPreis && !manualOverride) {
                vereinbarterPreis.value = bruttoSumme.toFixed(2);
                // console.log(`‚úÖ Vereinbarter Preis auto-updated: ${bruttoSumme.toFixed(2)} ‚Ç¨`);
            } else if (manualOverride) {
                // console.log(`‚è≠Ô∏è Vereinbarter Preis NICHT √ºberschrieben (Manual Override aktiv)`);
            }
        }

        // ========================================
        // ARBEITSLOHN EDITABLE TABLE
        // ========================================
        let arbeitslohnData = [];

        /**
         * Rendert Arbeitslohn-Preview (Labor Costs) - L√§dt Daten in editierbare Tabelle
         * @param {Array} arbeitslohn - Array von Arbeitslohn-Objekten aus PDF
         */
        function renderArbeitslohnPreview(arbeitslohn) {
            if (arbeitslohn && arbeitslohn.length > 0) {
                arbeitslohn.forEach(item => addArbeitslohnRow(item));
                // console.log(`‚úÖ ${arbeitslohn.length} Arbeitslohn-Eintr√§ge in Tabelle geladen`);
            }
        }

        function addArbeitslohnRow(data = {}) {
            const rowIndex = arbeitslohnData.length;
            const item = {
                position: data.position || '',
                art: data.art || '',
                stunden: data.stunden || 0,
                stundensatz: data.stundensatz || 0,
                gesamtpreis: data.gesamtpreis || (data.stunden || 0) * (data.stundensatz || 0)
            };
            arbeitslohnData.push(item);

            const tableBody = document.getElementById('arbeitslohnTableBody');
            const row = document.createElement('tr');
            row.style.borderBottom = '1px solid rgba(0,0,0,0.1)';
            row.style.background = rowIndex % 2 === 0 ? 'rgba(255,255,255,0.5)' : 'transparent';

            row.innerHTML = `
                <td style="padding: 8px;">
                    <input type="text" value="${item.position}" onchange="updateArbeitslohn(${rowIndex}, 'position', this.value)" style="width: 100%; border: 1px solid #ddd; border-radius: 4px; padding: 4px;">
                </td>
                <td style="padding: 8px; text-align: center;">
                    <input type="text" value="${item.art}" onchange="updateArbeitslohn(${rowIndex}, 'art', this.value)" style="width: 100%; border: 1px solid #ddd; border-radius: 4px; padding: 4px; text-align: center;">
                </td>
                <td style="padding: 8px; text-align: center;">
                    <input type="number" value="${item.stunden.toFixed(2)}" onchange="updateArbeitslohn(${rowIndex}, 'stunden', this.value)" step="0.1" min="0" style="width: 80px; border: 1px solid #ddd; border-radius: 4px; padding: 4px; text-align: center; font-family: 'Courier New', monospace;">
                </td>
                <td style="padding: 8px; text-align: right;">
                    <input type="number" value="${item.stundensatz.toFixed(2)}" onchange="updateArbeitslohn(${rowIndex}, 'stundensatz', this.value)" step="0.01" min="0" style="width: 100px; border: 1px solid #ddd; border-radius: 4px; padding: 4px; text-align: right; font-family: 'Courier New', monospace;">
                </td>
                <td style="padding: 8px; text-align: right;">
                    <input type="number" value="${item.gesamtpreis.toFixed(2)}" readonly style="width: 100px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; padding: 4px; text-align: right; font-weight: 600; color: #4caf50; font-family: 'Courier New', monospace;">
                </td>
                <td style="padding: 8px; text-align: center;">
                    <button type="button" onclick="deleteArbeitslohnRow(${rowIndex})" style="background: #f44336; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 14px;">üóëÔ∏è</button>
                </td>
            `;

            tableBody.appendChild(row);
            updateArbeitslohnSumme();
        }

        function updateArbeitslohn(index, field, value) {
            if (field === 'stunden' || field === 'stundensatz') {
                arbeitslohnData[index][field] = parseFloat(value) || 0;
                arbeitslohnData[index].gesamtpreis = arbeitslohnData[index].stunden * arbeitslohnData[index].stundensatz;

                // Update readonly Gesamtpreis field
                const rows = document.querySelectorAll('#arbeitslohnTableBody tr');
                const gesamtpreisInput = rows[index]?.querySelectorAll('input')[4];
                if (gesamtpreisInput) {
                    gesamtpreisInput.value = arbeitslohnData[index].gesamtpreis.toFixed(2);
                }
            } else {
                arbeitslohnData[index][field] = value;
            }

            updateArbeitslohnSumme();
            updateKostenaufschluesselung();
        }

        function deleteArbeitslohnRow(index) {
            if (!confirm('Diese Zeile wirklich l√∂schen?')) return;
            arbeitslohnData.splice(index, 1);
            reRenderArbeitslohnTable();
        }

        function reRenderArbeitslohnTable() {
            const tableBody = document.getElementById('arbeitslohnTableBody');
            tableBody.innerHTML = '';
            const tempData = [...arbeitslohnData];
            arbeitslohnData = [];
            tempData.forEach(item => addArbeitslohnRow(item));
        }

        function updateArbeitslohnSumme() {
            const summe = arbeitslohnData.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0);
            document.getElementById('arbeitslohnTotal').textContent = summe.toFixed(2) + ' ‚Ç¨';
            document.getElementById('arbeitslohnCount').textContent = arbeitslohnData.length;
        }

        // ========================================
        // LACKIERUNG EDITABLE TABLE
        // ========================================
        let lackierungData = [];

        // ========================================
        // MATERIALIEN EDITABLE TABLE
        // ========================================
        let materialienData = [];

        /**
         * Rendert Lackierung-Preview (Painting Work) - L√§dt Daten in editierbare Tabelle
         * @param {Array} lackierung - Array von Lackierung-Objekten aus PDF
         */
        function renderLackierungPreview(lackierung) {
            if (lackierung && lackierung.length > 0) {
                lackierung.forEach(item => addLackierungRow(item));
                // console.log(`‚úÖ ${lackierung.length} Lackierung-Eintr√§ge in Tabelle geladen`);
            }
        }

        function addLackierungRow(data = {}) {
            const rowIndex = lackierungData.length;
            const item = {
                position: data.position || 'Lackierung',
                bereich: data.bereich || 'Lackierung',
                stunden: data.stunden || 0,
                stundensatz: data.stundensatz || 0,
                gesamtpreis: data.gesamtpreis || (data.stunden || 0) * (data.stundensatz || 0)
            };
            lackierungData.push(item);

            const tableBody = document.getElementById('lackierungTableBody');
            const row = document.createElement('tr');
            row.style.borderBottom = '1px solid rgba(0,0,0,0.1)';
            row.style.background = rowIndex % 2 === 0 ? 'rgba(255,255,255,0.5)' : 'transparent';

            row.innerHTML = `
                <td style="padding: 10px;">
                    <input type="text" value="${item.position}" onchange="updateLackierung(${rowIndex}, 'position', this.value)" style="width: 100%; border: 1px solid #ddd; border-radius: 4px; padding: 4px;">
                </td>
                <td style="padding: 10px;">
                    <input type="text" value="${item.bereich}" onchange="updateLackierung(${rowIndex}, 'bereich', this.value)" style="width: 100%; border: 1px solid #ddd; border-radius: 4px; padding: 4px; color: #9c27b0; font-weight: 600;">
                </td>
                <td style="padding: 10px; text-align: center;">
                    <input type="number" value="${item.stunden.toFixed(2)}" onchange="updateLackierung(${rowIndex}, 'stunden', this.value)" step="0.1" min="0" style="width: 80px; border: 1px solid #ddd; border-radius: 4px; padding: 4px; text-align: center; font-family: 'Courier New', monospace;">
                </td>
                <td style="padding: 10px; text-align: right;">
                    <input type="number" value="${item.stundensatz.toFixed(2)}" onchange="updateLackierung(${rowIndex}, 'stundensatz', this.value)" step="0.01" min="0" style="width: 100px; border: 1px solid #ddd; border-radius: 4px; padding: 4px; text-align: right; font-family: 'Courier New', monospace;">
                </td>
                <td style="padding: 10px; text-align: right;">
                    <input type="number" value="${item.gesamtpreis.toFixed(2)}" readonly style="width: 100px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; padding: 4px; text-align: right; font-weight: 600; color: #9c27b0; font-family: 'Courier New', monospace;">
                </td>
                <td style="padding: 10px; text-align: center;">
                    <button type="button" onclick="deleteLackierungRow(${rowIndex})" style="background: #f44336; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 14px;">üóëÔ∏è</button>
                </td>
            `;

            tableBody.appendChild(row);
            updateLackierungSumme();
        }

        function updateLackierung(index, field, value) {
            if (field === 'stunden' || field === 'stundensatz') {
                lackierungData[index][field] = parseFloat(value) || 0;
                lackierungData[index].gesamtpreis = lackierungData[index].stunden * lackierungData[index].stundensatz;

                // Update readonly Gesamtpreis field
                const rows = document.querySelectorAll('#lackierungTableBody tr');
                const gesamtpreisInput = rows[index]?.querySelectorAll('input')[4];
                if (gesamtpreisInput) {
                    gesamtpreisInput.value = lackierungData[index].gesamtpreis.toFixed(2);
                }
            } else {
                lackierungData[index][field] = value;
            }

            updateLackierungSumme();
            updateKostenaufschluesselung();
        }

        function deleteLackierungRow(index) {
            if (!confirm('Diese Zeile wirklich l√∂schen?')) return;
            lackierungData.splice(index, 1);
            reRenderLackierungTable();
        }

        function reRenderLackierungTable() {
            const tableBody = document.getElementById('lackierungTableBody');
            tableBody.innerHTML = '';
            const tempData = [...lackierungData];
            lackierungData = [];
            tempData.forEach(item => addLackierungRow(item));
        }

        function updateLackierungSumme() {
            const summe = lackierungData.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0);
            document.getElementById('lackierungTotal').textContent = summe.toFixed(2) + ' ‚Ç¨';
            document.getElementById('lackierungCount').textContent = lackierungData.length;
        }

        // ========================================
        // MATERIALIEN TABLE FUNCTIONS
        // ========================================

        /**
         * Rendert Materialien-Preview - L√§dt Daten in editierbare Tabelle
         * @param {Array} materialien - Array von Materialien-Objekten aus PDF
         */
        function renderMaterialienPreview(materialien) {
            if (!materialien || materialien.length === 0) {
                console.warn('‚ö†Ô∏è PDF enth√§lt keine Materialien-Daten. Materialien-Tabelle bleibt leer.');
                console.warn('   üí° Hinweis: Materialien k√∂nnen manuell √ºber "+ Material hinzuf√ºgen" Button eingegeben werden.');
                return;
            }

            materialien.forEach(item => addMaterialienRow(item));
            // console.log(`‚úÖ ${materialien.length} Materialien-Eintr√§ge in Tabelle geladen`);
        }

        function addMaterialienRow(data = {}) {
            const rowIndex = materialienData.length;
            const item = {
                materialTyp: data.materialTyp || '',
                menge: data.menge || 0,
                einheit: data.einheit || 'm¬≤',
                einheitspreis: data.einheitspreis || 0,
                gesamtpreis: data.gesamtpreis || (data.menge || 0) * (data.einheitspreis || 0)
            };
            materialienData.push(item);

            const tableBody = document.getElementById('materialienTableBody');
            const row = document.createElement('tr');
            row.style.borderBottom = '1px solid rgba(0,0,0,0.1)';
            row.style.background = rowIndex % 2 === 0 ? 'rgba(255,255,255,0.5)' : 'transparent';

            row.innerHTML = `
                <td style="padding: 10px;">
                    <input type="text" value="${item.materialTyp}" onchange="updateMaterialien(${rowIndex}, 'materialTyp', this.value)" placeholder="z.B. 3M Folie matt schwarz" style="width: 100%; border: 1px solid #ddd; border-radius: 4px; padding: 4px;">
                </td>
                <td style="padding: 10px; text-align: center;">
                    <input type="number" value="${item.menge.toFixed(2)}" onchange="updateMaterialien(${rowIndex}, 'menge', this.value)" step="0.01" min="0" style="width: 80px; border: 1px solid #ddd; border-radius: 4px; padding: 4px; text-align: center; font-family: 'Courier New', monospace;">
                </td>
                <td style="padding: 10px;">
                    <select onchange="updateMaterialien(${rowIndex}, 'einheit', this.value)" style="width: 100%; border: 1px solid #ddd; border-radius: 4px; padding: 4px;">
                        <option value="m¬≤" ${item.einheit === 'm¬≤' ? 'selected' : ''}>m¬≤</option>
                        <option value="St√ºck" ${item.einheit === 'St√ºck' ? 'selected' : ''}>St√ºck</option>
                        <option value="Liter" ${item.einheit === 'Liter' ? 'selected' : ''}>Liter</option>
                        <option value="kg" ${item.einheit === 'kg' ? 'selected' : ''}>kg</option>
                        <option value="Meter" ${item.einheit === 'Meter' ? 'selected' : ''}>Meter</option>
                        <option value="Set" ${item.einheit === 'Set' ? 'selected' : ''}>Set</option>
                    </select>
                </td>
                <td style="padding: 10px; text-align: right;">
                    <input type="number" value="${item.einheitspreis.toFixed(2)}" onchange="updateMaterialien(${rowIndex}, 'einheitspreis', this.value)" step="0.01" min="0" style="width: 100px; border: 1px solid #ddd; border-radius: 4px; padding: 4px; text-align: right; font-family: 'Courier New', monospace;">
                </td>
                <td style="padding: 10px; text-align: right;">
                    <input type="number" value="${item.gesamtpreis.toFixed(2)}" readonly style="width: 100px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; padding: 4px; text-align: right; font-weight: 600; color: #ff9800; font-family: 'Courier New', monospace;">
                </td>
                <td style="padding: 10px; text-align: center;">
                    <button type="button" onclick="deleteMaterialienRow(${rowIndex})" style="background: #f44336; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 14px;">üóëÔ∏è</button>
                </td>
            `;

            tableBody.appendChild(row);
            updateMaterialienSumme();
        }

        function updateMaterialien(index, field, value) {
            if (field === 'menge' || field === 'einheitspreis') {
                materialienData[index][field] = parseFloat(value) || 0;
                materialienData[index].gesamtpreis = materialienData[index].menge * materialienData[index].einheitspreis;

                // Update readonly Gesamtpreis field
                const rows = document.querySelectorAll('#materialienTableBody tr');
                const gesamtpreisInput = rows[index]?.querySelectorAll('input[type="number"]')[2];
                if (gesamtpreisInput) {
                    gesamtpreisInput.value = materialienData[index].gesamtpreis.toFixed(2);
                }
            } else {
                materialienData[index][field] = value;
            }

            updateMaterialienSumme();
            updateKostenaufschluesselung();
        }

        function deleteMaterialienRow(index) {
            if (!confirm('Diese Zeile wirklich l√∂schen?')) return;
            materialienData.splice(index, 1);
            reRenderMaterialienTable();
        }

        function reRenderMaterialienTable() {
            const tableBody = document.getElementById('materialienTableBody');
            tableBody.innerHTML = '';
            const tempData = [...materialienData];
            materialienData = [];
            tempData.forEach(item => addMaterialienRow(item));
        }

        function updateMaterialienSumme() {
            const summe = materialienData.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0);
            document.getElementById('materialienTotal').textContent = summe.toFixed(2) + ' ‚Ç¨';
            document.getElementById('materialienCount').textContent = materialienData.length;
        }

        /**
         * Aktualisiert die Gesamtsumme (Grand Total) aller Kosten
         * @param {Object} pdfData - Parsed PDF data mit ersatzteile, arbeitslohn, lackierung
         */
        function updateGesamtsumme(pdfData) {
            const gesamtsummeDiv = document.getElementById('gesamtsummePreview');

            if (!pdfData) {
                gesamtsummeDiv.style.display = 'none';
                return;
            }

            // Calculate subtotals (NETTO-Werte aus PDF)
            const ersatzteileSumme = (pdfData.ersatzteile || []).reduce((sum, item) => sum + item.gesamtpreis, 0);
            const arbeitslohnSumme = (pdfData.arbeitslohn || []).reduce((sum, item) => sum + item.gesamtpreis, 0);
            const lackierungSumme = (pdfData.lackierung || []).reduce((sum, item) => sum + item.gesamtpreis, 0);
            const materialienSumme = (pdfData.materialien || []).reduce((sum, item) => sum + item.gesamtpreis, 0);

            // Netto-Gesamtsumme (ALLE 4 Tabellen)
            const nettoSumme = ersatzteileSumme + arbeitslohnSumme + lackierungSumme + materialienSumme;

            // MwSt-Berechnung (Standard: 19%)
            const mwstSatz = parseFloat(document.getElementById('mwstSatz')?.value) || 19;
            const mwstBetrag = nettoSumme * (mwstSatz / 100);
            const bruttoSumme = nettoSumme + mwstBetrag;

            // Update display (only show if at least one cost exists)
            if (nettoSumme > 0) {
                // Preview-Box (Gesamtsumme)
                document.getElementById('summeErsatzteile').textContent = ersatzteileSumme.toFixed(2) + ' ‚Ç¨';
                document.getElementById('summeArbeitslohn').textContent = arbeitslohnSumme.toFixed(2) + ' ‚Ç¨';
                document.getElementById('summeLackierung').textContent = lackierungSumme.toFixed(2) + ' ‚Ç¨';
                const summeMaterialienElement = document.getElementById('summeMaterialien');
                if (summeMaterialienElement) {
                    summeMaterialienElement.textContent = materialienSumme.toFixed(2) + ' ‚Ç¨';
                }
                document.getElementById('gesamtpreis').textContent = nettoSumme.toFixed(2) + ' ‚Ç¨'; // Netto in Preview

                gesamtsummeDiv.style.display = 'block';

                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // NEU: AUTO-FILL KOSTENAUFSCHL√úSSELUNG (f√ºr Buchhaltung)
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

                // Netto-Positionen (ALLE 4 Tabellen)
                document.getElementById('kostenErsatzteile').value = ersatzteileSumme.toFixed(2);
                document.getElementById('kostenArbeitslohn').value = arbeitslohnSumme.toFixed(2);
                document.getElementById('kostenLackierung').value = lackierungSumme.toFixed(2);
                const kostenMaterialienElement = document.getElementById('kostenMaterialien');
                if (kostenMaterialienElement) {
                    kostenMaterialienElement.value = materialienSumme.toFixed(2);
                }
                document.getElementById('summeNetto').value = nettoSumme.toFixed(2) + ' ‚Ç¨';

                // MwSt-Berechnung
                document.getElementById('mwstBetrag').value = mwstBetrag.toFixed(2);
                document.getElementById('summeBrutto').textContent = bruttoSumme.toFixed(2) + ' ‚Ç¨';

                // AUTO-FILL "Vereinbarter Preis" (= BRUTTO)
                const vereinbarterPreisInput = document.getElementById('vereinbarterPreis');
                if (vereinbarterPreisInput) {
                    vereinbarterPreisInput.value = bruttoSumme.toFixed(2);
                    // console.log(`üí∞ Vereinbarter Preis auto-filled: ${bruttoSumme.toFixed(2)} ‚Ç¨ (Netto: ${nettoSumme.toFixed(2)} ‚Ç¨ + MwSt ${mwstSatz}%: ${mwstBetrag.toFixed(2)} ‚Ç¨)`);
                }

                // Re-render feather icons
                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
            } else {
                gesamtsummeDiv.style.display = 'none';
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // EVENT HANDLER: MwSt-Satz √Ñnderung + Manual Edit
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        // MwSt-Dropdown: Neu-Berechnung bei Satz-√Ñnderung
        document.getElementById('mwstSatz')?.addEventListener('change', function() {
            const netto = parseFloat(document.getElementById('summeNetto')?.value.replace(' ‚Ç¨', '')) || 0;
            const mwstSatz = parseFloat(this.value);
            const mwstBetrag = netto * (mwstSatz / 100);
            const brutto = netto + mwstBetrag;

            document.getElementById('mwstBetrag').value = mwstBetrag.toFixed(2);
            document.getElementById('summeBrutto').textContent = brutto.toFixed(2) + ' ‚Ç¨';

            // Nur √ºberschreiben wenn nicht manuell overridden
            const manualOverride = document.getElementById('manualPriceOverride')?.checked;
            if (!manualOverride) {
                document.getElementById('vereinbarterPreis').value = brutto.toFixed(2);
            }

            // console.log(`üìä MwSt-Satz ge√§ndert: ${mwstSatz}% ‚Üí Brutto: ${brutto.toFixed(2)} ‚Ç¨ ${manualOverride ? '(Manual Override aktiv)' : ''}`);
        });

        // Manual Price Override Checkbox
        document.getElementById('manualPriceOverride')?.addEventListener('change', function() {
            const preisInput = document.getElementById('vereinbarterPreis');

            if (this.checked) {
                // MANUAL MODE: Feld editierbar machen
                preisInput.removeAttribute('readonly');
                preisInput.style.background = '#fff3cd'; // Gelber Hintergrund
                preisInput.style.border = '2px solid #ffc107';
                preisInput.focus();
                preisInput.select();

                // console.log('‚úèÔ∏è Manual Price Override: AKTIVIERT - Preis kann jetzt manuell editiert werden');
                showToast('‚úèÔ∏è Preis kann jetzt manuell editiert werden', 'info', 3000);
            } else {
                // AUTO MODE: Feld readonly + neu berechnen
                preisInput.setAttribute('readonly', 'readonly');
                preisInput.style.background = '#f0f8ff';
                preisInput.style.border = '2px solid var(--color-primary)';

                // Neu berechnen aus Tabellen
                updateKostenaufschluesselung();

                // console.log('üîÑ Manual Price Override: DEAKTIVIERT - Preis wird automatisch berechnet');
                showToast('üîÑ Preis wird automatisch aus Tabellen berechnet', 'success', 3000);
            }
        });

        // üîß ENTFERNT (2025-11-27): Ersatzfahrzeug-Adresse Toggle
        // ersatzfahrzeugAdresseGroup war redundant mit abholadresse - UI entfernt

        // Edit Button: Felder editierbar machen
        document.getElementById('btnEditKosten')?.addEventListener('click', function() {
            const fields = ['kostenErsatzteile', 'kostenArbeitslohn', 'kostenLackierung'];
            const isReadonly = document.getElementById('kostenErsatzteile').hasAttribute('readonly');

            if (isReadonly) {
                // Enable editing
                fields.forEach(id => {
                    const input = document.getElementById(id);
                    input.removeAttribute('readonly');
                    input.style.background = '#fff3cd';
                    input.style.border = '2px solid #ffc107';
                });
                this.innerHTML = '‚úì √Ñnderungen √ºbernehmen';
                this.style.background = '#28a745';

                if (typeof feather !== 'undefined') feather.replace();

                // Show notification
                alert('‚úèÔ∏è Kostenaufschl√ºsselung kann jetzt bearbeitet werden.\n\nDie MwSt und Gesamtsumme werden automatisch neu berechnet.');
            } else {
                // Save and lock
                fields.forEach(id => {
                    const input = document.getElementById(id);
                    input.setAttribute('readonly', 'readonly');
                    input.style.background = '#f5f5f5';
                    input.style.border = '';
                });
                this.innerHTML = 'Werte manuell bearbeiten';
                this.style.background = 'var(--color-primary)';

                if (typeof feather !== 'undefined') feather.replace();

                // Recalculate totals
                const netto = fields.reduce((sum, id) => {
                    return sum + (parseFloat(document.getElementById(id).value) || 0);
                }, 0);

                const mwstSatz = parseFloat(document.getElementById('mwstSatz').value);
                const mwstBetrag = netto * (mwstSatz / 100);
                const brutto = netto + mwstBetrag;

                document.getElementById('summeNetto').value = netto.toFixed(2) + ' ‚Ç¨';
                document.getElementById('mwstBetrag').value = mwstBetrag.toFixed(2);
                document.getElementById('summeBrutto').textContent = brutto.toFixed(2) + ' ‚Ç¨';
                document.getElementById('vereinbarterPreis').value = brutto.toFixed(2);

                // console.log(`‚úÖ Kostenaufschl√ºsselung manuell aktualisiert: Netto=${netto.toFixed(2)} ‚Üí Brutto=${brutto.toFixed(2)}`);
                alert('‚úÖ Kostenaufschl√ºsselung aktualisiert!\n\nNeue Summe Brutto: ' + brutto.toFixed(2) + ' ‚Ç¨');
            }
        });

        /**
         * Extrahiert Ersatzteile aus DAT-Text
         * Format:
         * E 43864 REPARATURSATZ, BESTEHT AUS:
         *         1622749580 NIET RADLAUFABDECKUNG V.R.    4    0.28      1.12
         * E 45612 9853894380 SCHEINWERFER R.               1    1'532.10  1'532.10
         */
        function extractErsatzteileFromText(text, data) {
            if (window.DEBUG) // console.log('üîç Extracting Ersatzteile from Text...');

            // CRITICAL: Normalize text first (fix broken lines)
            const normalizedText = normalizeDatText(text);

            // Split into lines
            const lines = normalizedText.split('\n');

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();

                // Skip empty lines or header lines
                if (!line || line.startsWith('RC DVN') || line.startsWith('Summenblock')) {
                    continue;
                }

                // Pattern 1: ETN mit RC/DVN Prefix (z.B. "E 45612 9853894380 SCHEINWERFER R. ...")
                // Pattern: [E/K/M] [DVN] [ETN] [Benennung] [Anzahl] [Einzelpreis] [Gesamtpreis]
                // STAGE 3 FIX: Preise OHNE \s (spaces) - nur als Trenner zwischen Feldern (2025-11-11)
                const pattern1 = /^[A-Z]\s+\d+\s+(\d{10}|\d{4,8}[A-Z]\d{0,2})\s+(.+?)\s+(\d+)\s+([\d\'\.\,]+)\s+([\d\'\.\,]+)\s*$/;

                // Pattern 2: ETN ohne Prefix (einger√ºckt, Teil von REPARATURSATZ)
                // Pattern: [whitespace] [ETN] [Benennung] [Anzahl] [Einzelpreis] [Gesamtpreis]
                // STAGE 3 FIX: Preise OHNE \s (spaces) - nur als Trenner zwischen Feldern (2025-11-11)
                const pattern2 = /^\s*(\d{10}|\d{4,8}[A-Z]\d{0,2})\s+(.+?)\s+(\d+)\s+([\d\'\.\,]+)\s+([\d\'\.\,]+)\s*$/;

                let match = line.match(pattern1) || line.match(pattern2);

                if (match) {
                    const etn = match[1].trim();
                    const benennung = match[2].trim();
                    const anzahl = parseInt(match[3]);

                    // Swiss number format: 1'532.10 ‚Üí 1532.10
                    const einzelpreisStr = match[4].replace(/'/g, '').replace(',', '.');
                    const gesamtpreisStr = match[5].replace(/'/g, '').replace(',', '.');

                    const einzelpreis = parseFloat(einzelpreisStr);
                    const gesamtpreis = parseFloat(gesamtpreisStr);

                    // Validate
                    if (etn && benennung && anzahl > 0 && einzelpreis > 0 && gesamtpreis > 0) {
                        data.ersatzteile.push({
                            etn,
                            benennung,
                            anzahl,
                            einzelpreis,
                            gesamtpreis
                        });
                        // FIX #4: Verbessertes Debug Logging (2025-11-11)
                        // console.log(`‚úÖ Ersatzteil ${data.ersatzteile.length} gefunden:`, {
                            etn,
                            benennung,
                            anzahl,
                            einzelpreis: einzelpreis.toFixed(2),
                            gesamtpreis: gesamtpreis.toFixed(2)
                        });
                    } else {
                        // FIX #4: Warn bei fehlschlagenden Pattern-Matches (2025-11-11)
                        if (line.match(/\d{10}|\d{4,8}[A-Z]\d{0,2}/)) {
                            console.warn(`‚ö†Ô∏è Pattern-Match fehlgeschlagen f√ºr Zeile ${index + 1}:`, line);
                        }
                    }
                }
            }

            if (data.ersatzteile.length === 0) {
                console.warn('‚ö†Ô∏è Keine Ersatzteile im Text gefunden');
            } else {
                // console.log(`‚úÖ Insgesamt ${data.ersatzteile.length} Ersatzteile aus Text extrahiert`);
            }
        }

        /**
         * Clear DAT-Text Textarea
         */
        function clearDatText() {
            document.getElementById('datTextInput').value = '';
            document.getElementById('textParseStatus').textContent = '';
            document.getElementById('clearTextBtn').style.display = 'none';
            document.getElementById('ersatzteilePreview').style.display = 'none';
            // Keep pdfData (user might have parsed from PDF)
        }

        function getFormData() {
            const timestamp = Date.now();

            // üÜï MULTI-SERVICE: Collect additional services
            const primaryServiceTyp = document.getElementById('serviceTyp').value;
            const additionalServices = Array.from(document.querySelectorAll('.additional-service-checkbox:checked'))
                // üÜï BUGFIX 2025-11-15 (FIX #2): Prevent duplicates
                .filter((checkbox, index, self) => {
                    const serviceTyp = checkbox.value;

                    // Check 1: Nicht den Haupt-Service hinzuf√ºgen
                    if (serviceTyp === primaryServiceTyp) {
                        console.warn(`‚ö†Ô∏è [DUPLIKAT-CHECK] Service "${serviceTyp}" ist bereits Haupt-Service ‚Üí wird √ºbersprungen`);
                        return false;
                    }

                    // Check 2: Keine Duplikate in additionalServices
                    const firstIndex = self.findIndex(cb => cb.value === serviceTyp);
                    if (firstIndex !== index) {
                        console.warn(`‚ö†Ô∏è [DUPLIKAT-CHECK] Service "${serviceTyp}" bereits in additionalServices ‚Üí wird √ºbersprungen`);
                        return false;
                    }

                    return true;
                })
                .map(checkbox => ({
                    serviceTyp: checkbox.value,
                    serviceDetails: getServiceDetails(checkbox.value)  // üîß FIX (2025-11-13): Renamed from serviceData to serviceDetails for consistency
                }));

            return {
                id: String(timestamp),  // FIX 2025-11-13: Force String for Firestore query consistency
                datum: heute.toLocaleDateString('de-DE'),
                zeit: heute.toLocaleTimeString('de-DE'),
                kennzeichen: document.getElementById('kennzeichen').value.trim().toUpperCase(),
                neuwagenOhneKennzeichen: document.getElementById('neuwagenOhneKennzeichen')?.checked || false, // 2026-01-08: Flag f√ºr Neuwagen
                kundenname: document.getElementById('kundenname').value,
                kundenEmail: document.getElementById('kundenEmail').value,
                telefon: document.getElementById('telefon').value,
                geplantesAbnahmeDatum: document.getElementById('geplantesAbnahmeDatum').value,
                serviceTyp: document.getElementById('serviceTyp').value,
                serviceDetails: getServiceDetails(document.getElementById('serviceTyp').value),
                // üÜï MULTI-SERVICE: Additional Services Array (Option C)
                additionalServices: additionalServices.length > 0 ? additionalServices : null,
                fahrzeugAbholung: document.querySelector('input[name="fahrzeugAbholung"]:checked')?.value || 'nein',
                abholadresse: document.getElementById('abholadresse').value,
                abholdatum: document.getElementById('abholdatum').value,
                abholzeit: document.getElementById('abholzeit').value,
                abholnotiz: document.getElementById('abholnotiz').value,
                marke: document.getElementById('marke').value,
                modell: document.getElementById('modell').value,
                baujahrVon: document.getElementById('baujahrVon').value,
                baujahrBis: document.getElementById('baujahrBis').value,
                kmstand: document.getElementById('kmstand').value,
                vin: document.getElementById('vin').value,
                farbname: document.getElementById('farbname').value,
                farbvariante: document.getElementById('farbvariante').value,
                farbnummer: document.getElementById('farbnummer').value,
                lackart: document.querySelector('input[name="lackart"]:checked')?.value || 'uni',
                notizen: document.getElementById('notizen').value,
                vereinbarterPreis: parseFloat(document.getElementById('vereinbarterPreis').value) || null,
                photos,
                // AGI Training: Schadenslabels f√ºr ML-Training (2025-12-11)
                // Format: Array von { url, schadenLabels, labeledAt, labeledBy, confidence, damageCode }
                schaedensfotos: photos.map((photoUrl, index) => {
                    const label = photoLabels[index];
                    if (label && label.schadenLabels) {
                        return {
                            url: photoUrl,
                            schadenLabels: label.schadenLabels,
                            labeledAt: label.labeledAt,
                            labeledBy: label.labeledBy,
                            confidence: label.confidence,
                            damageCode: label.damageCode
                        };
                    }
                    return { url: photoUrl }; // Nicht-gelabeltes Foto
                }),
                signature: canvas.toDataURL(),
                unterschriftName: document.getElementById('unterschriftName')?.value || null, // Name des Unterzeichners f√ºr Nachvollziehbarkeit
                pdfUrl: null, // Wird nach Upload gesetzt
                pdfUploadedAt: null,
                status: 'neu',  // Pipeline-Optimierung: Startet in 'neu' ‚Üí nur in kalkulation.html sichtbar
                // üì¶ ANLIEFERUNG (2025-11-27): Wenn Fahrzeug abgeholt werden muss ODER Ersatzfahrzeug gew√ºnscht, startet es in "anlieferung"
                // üîß FIX (2025-11-27): 'angenommen' ‚Üí 'terminiert' f√ºr Konsistenz mit Partner-App
                // üÜï FIX (2025-11-29): Auch ersatzfahrzeugGewuenscht pr√ºfen (wie meine-anfragen.html)
                // Pipeline-Optimierung: prozessStatus auf 'neu' setzen f√ºr kalkulation.html
                prozessStatus: 'neu',
                // ‚úÖ BUG #9 FIX (2025-11-26): werkstattId im Dokument speichern
                // KRITISCH: Ohne dieses Feld schlagen Duplikat-Queries fehl!
                // Queries in anfrage-detail.html nutzen .where('werkstattId', '==', ...)
                werkstattId: window.werkstattId || null,
                // Pipeline-Optimierung: prozessTimestamps f√ºr 'neu' Status
                prozessTimestamps: {
                    neu: timestamp
                },
                // üÜï NEW (2025-11-13): Multi-Service Status-Tracking
                // Erm√∂glicht paralleles Status-Tracking f√ºr Primary + Additional Services
                // Pipeline-Optimierung (2025-12-08): Initial Status 'neu' f√ºr kalkulation.html
                serviceStatuses: (() => {
                    const statuses = {};
                    const primaryService = document.getElementById('serviceTyp').value;
                    // üÜï FIX (Bug 43): Besseres User-Tracking aus sessionStorage
                    const mitarbeiterSession = JSON.parse(sessionStorage.getItem('currentMitarbeiter') || 'null');
                    const currentUser = mitarbeiterSession?.email || mitarbeiterSession?.name || window.currentUser?.email || window.authManager?.getCurrentUser()?.email || 'system';
                    // Pipeline-Optimierung: Initial Status ist 'neu' f√ºr kalkulation.html
                    const initialStatus = 'neu';

                    // Primary Service: Status 'neu' f√ºr Pipeline
                    statuses[primaryService] = {
                        status: initialStatus,
                        timestamp: timestamp,
                        statusHistory: [{
                            status: initialStatus,
                            timestamp: timestamp,
                            user: currentUser
                        }]
                    };

                    // Additional Services: Status sollte KONSISTENT mit Primary Service sein
                    // üêõ FIX #4 (2025-12-07): Nutze initialStatus statt hardcoded 'neu'
                    // Damit erscheinen Multi-Service Fahrzeuge korrekt im Kanban
                    if (additionalServices && additionalServices.length > 0) {
                        additionalServices.forEach(service => {
                            statuses[service.serviceTyp] = {
                                status: initialStatus,  // üîß FIX: War vorher 'neu' hardcoded!
                                timestamp: timestamp,
                                statusHistory: [{
                                    status: initialStatus,
                                    timestamp: timestamp,
                                    user: currentUser,
                                    note: (isAbholung || isErsatzfahrzeug) ? 'Wartet auf Anlieferung' : 'Bereit zur Terminierung'
                                }]
                            };
                        });
                    }

                    return statuses;
                })(),
                lastModified: timestamp,
                bezahlt: false,
                rechnungGeschrieben: false,
                // NEU: PDF-Import Daten (falls vorhanden) + Editierte Tabellen-Daten
                pdfImport: pdfData ? {
                    imported: true,
                    importDate: new Date().toISOString(),
                    originalPdf: {
                        ersatzteile: pdfData.ersatzteile,
                        arbeitslohn: pdfData.arbeitslohn,
                        lackierung: pdfData.lackierung,
                        materialien: pdfData.materialien || []
                    },
                    editedData: {
                        ersatzteile: JSON.parse(JSON.stringify(ersatzteileData)),  // Deep Copy (verhindert Referenz-Mutation)
                        arbeitslohn: JSON.parse(JSON.stringify(arbeitslohnData)),
                        lackierung: JSON.parse(JSON.stringify(lackierungData)),
                        materialien: JSON.parse(JSON.stringify(materialienData))
                    },
                    originalPdfName: document.getElementById('pdfFileName').textContent
                } : {
                    // Kein PDF-Import, aber manuelle Eingabe
                    imported: false,
                    editedData: {
                        ersatzteile: JSON.parse(JSON.stringify(ersatzteileData)),  // Deep Copy
                        arbeitslohn: JSON.parse(JSON.stringify(arbeitslohnData)),
                        lackierung: JSON.parse(JSON.stringify(lackierungData)),
                        materialien: JSON.parse(JSON.stringify(materialienData))
                    }
                },
                // Manual Price Override Flag
                manualPriceOverride: document.getElementById('manualPriceOverride')?.checked || false,
                // NEU: Kostenaufschl√ºsselung f√ºr Buchhaltung/Steuerberater
                kostenAufschluesselung: {
                    ersatzteile: parseFloat(document.getElementById('kostenErsatzteile')?.value) || 0,
                    arbeitslohn: parseFloat(document.getElementById('kostenArbeitslohn')?.value) || 0,
                    lackierung: parseFloat(document.getElementById('kostenLackierung')?.value) || 0,
                    summeNetto: parseFloat(document.getElementById('summeNetto')?.value) || 0,
                    mwstSatz: parseFloat(document.getElementById('mwstSatz')?.value) || 19,
                    mwstBetrag: parseFloat(document.getElementById('mwstBetrag')?.value) || 0,
                    summeGesamt: parseFloat(document.getElementById('vereinbarterPreis')?.value) || 0
                },

                // üÜï FIX (2025-11-29): Ersatzfahrzeug-Felder in getFormData() hinzuf√ºgen
                // PROBLEM: Diese Felder wurden in prozessStatus-Berechnung verwendet, aber nicht gespeichert
                // L√ñSUNG: Alle Ersatzfahrzeug-relevanten Felder explizit hinzuf√ºgen
                ersatzfahrzeugGewuenscht: document.getElementById('ersatzfahrzeugGewuenscht')?.checked || false,
                zugewiesenesErsatzfahrzeug: document.getElementById('zugewiesenesErsatzfahrzeug')?.value || null,
                ersatzfahrzeugKosten: (() => {
                    const tagesmiete = parseFloat(document.getElementById('ersatzfahrzeugTagesmieteInput')?.value) || 0;
                    const tage = parseInt(document.getElementById('ersatzfahrzeugTageInput')?.value) || 0;
                    if (tagesmiete === 0 || tage === 0) return null;
                    return {
                        tagesmiete: tagesmiete,
                        tage: tage,
                        gesamt: tagesmiete * tage
                    };
                })()
            };
        }

        // üñºÔ∏è PHOTO URL‚ÜíBASE64 CONVERTER (FIX: Nov 20, 2025 - Pattern 35: PDF Photo Bug)
        // Converts Firebase Storage URLs to Base64 for jsPDF embedding
        async function convertPhotoUrlsToBase64(photoUrls) {
            if (!photoUrls || photoUrls.length === 0) return [];

            // console.log(`üñºÔ∏è Konvertiere ${photoUrls.length} Fotos zu Base64 f√ºr PDF...`);
            const base64Photos = [];

            for (let i = 0; i < photoUrls.length; i++) {
                const photoUrl = photoUrls[i];

                try {
                    const base64 = await new Promise((resolve, reject) => {
                        const img = new Image();
                        img.crossOrigin = 'Anonymous';

                        const timeout = setTimeout(() => {
                            reject(new Error(`Photo ${i+1} loading timeout`));
                        }, 10000);  // 10 seconds timeout

                        img.onload = () => {
                            clearTimeout(timeout);
                            const canvas = document.createElement('canvas');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0);
                            resolve(canvas.toDataURL('image/jpeg', 0.9));  // 90% quality
                        };

                        img.onerror = (error) => {
                            clearTimeout(timeout);
                            reject(error);
                        };

                        img.src = photoUrl;
                    });

                    base64Photos.push(base64);
                    // console.log(`   ‚úÖ Foto ${i+1}/${photoUrls.length} konvertiert`);

                } catch (error) {
                    console.error(`   ‚ùå Foto ${i+1} konnte nicht geladen werden:`, error);
                    // Continue with remaining photos (graceful degradation)
                }
            }

            // console.log(`‚úÖ ${base64Photos.length}/${photoUrls.length} Fotos erfolgreich konvertiert`);
            return base64Photos;
        }

        // PDF erstellen (keeping original function)
        async function createPDF(data) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // üÜï PROFESSIONAL HEADER WITH BRANDING (2025-11-13)
            // Load werkstatt settings for dynamic branding
            const settings = window.settingsManager ? await window.settingsManager.loadSettings() : null;
            const werkstattName = settings?.profil?.name || 'Auto-Lackierzentrum Mosbach';
            const logoUrl = settings?.profil?.logoUrl;

            // Header background - Modern gradient-style
            doc.setFillColor(0, 51, 102);  // Dark blue
            doc.rect(0, 0, 210, 45, 'F');

            // Add logo if available
            let logoLoaded = false;
            if (logoUrl) {
                try {
                    // Convert logo to base64 for PDF embedding
                    const logoBase64 = await new Promise((resolve, reject) => {
                        const img = new Image();
                        img.crossOrigin = 'Anonymous';

                        // Set timeout for logo loading (5 seconds)
                        const timeout = setTimeout(() => {
                            reject(new Error('Logo loading timeout'));
                        }, 5000);

                        img.onload = () => {
                            clearTimeout(timeout);
                            const canvas = document.createElement('canvas');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0);
                            resolve(canvas.toDataURL('image/png'));
                        };

                        img.onerror = (error) => {
                            clearTimeout(timeout);
                            reject(error);
                        };

                        img.src = logoUrl;
                    });

                    // Add logo to PDF (left side, centered vertically)
                    doc.addImage(logoBase64, 'PNG', 15, 12, 30, 20);  // x, y, width, height
                    logoLoaded = true;
                    // console.log('‚úÖ Logo successfully loaded for PDF');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Logo konnte nicht geladen werden (CORS-Fehler oder Netzwerkproblem)');
                    console.warn('   ‚Üí PDF wird ohne Logo erstellt');
                    console.warn('   ‚Üí L√∂sung: Firebase Storage CORS konfigurieren');
                    // PDF continues without logo (graceful degradation)
                }
            }

            // üé® EXCEL-STYLE HEADER (FIX: Nov 20, 2025 - Pattern 36: Header abgeschnitten)
            // K√ºrzerer Text + kleinere Schrift f√ºr bessere Lesbarkeit
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(18);  // Kleiner: 22 ‚Üí 18
            doc.setFont(undefined, 'bold');
            doc.text('Annahmeprotokoll', logoLoaded ? 115 : 105, 18, { align: logoLoaded ? 'left' : 'center' });

            doc.setFontSize(10);  // Kleiner: 12 ‚Üí 10
            doc.setFont(undefined, 'normal');
            doc.text(werkstattName, logoLoaded ? 115 : 105, 26, { align: logoLoaded ? 'left' : 'center' });

            // Datum rechts oben
            doc.setFontSize(9);
            doc.text(data.datum, 190, 18, { align: 'right' });

            // Add subtle separator line
            doc.setDrawColor(255, 255, 255);
            doc.setLineWidth(0.5);
            doc.line(15, 42, 195, 42);

            // üé® EXCEL-STYLE TABELLEN (FIX: Nov 20, 2025 - Pattern 36)
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(11);

            // Baujahr-Logik berechnen (vor Tabelle)
            const baujahrVon = data.baujahrVon || data.baujahr;
            const baujahrBis = data.baujahrBis || data.baujahr;
            let baujahrText = '';
            if (baujahrVon && baujahrBis) {
                baujahrText = (baujahrVon === baujahrBis) ? baujahrVon : `${baujahrVon} - ${baujahrBis}`;
            } else if (baujahrVon) {
                baujahrText = 'ab ' + baujahrVon;
            } else if (baujahrBis) {
                baujahrText = 'bis ' + baujahrBis;
            } else {
                baujahrText = 'Nicht angegeben';
            }

            // ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            // ‚îÇ TABELLE 1: KUNDENDATEN                      ‚îÇ
            // ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            doc.autoTable({
                startY: 48,
                head: [['KUNDENDATEN', '']],
                body: [
                    ['Datum / Zeit', data.datum + ' ' + data.zeit],
                    ['Kennzeichen', data.kennzeichen],
                    ['Kundenname', data.kundenname],
                    ['Email', data.kundenEmail || 'Nicht angegeben'],
                    ['Telefon', data.telefon || 'Nicht angegeben']
                ],
                theme: 'grid',
                headStyles: {
                    fillColor: [0, 51, 102],  // Dark blue
                    textColor: 255,
                    fontStyle: 'bold',
                    fontSize: 11
                },
                bodyStyles: {
                    fontSize: 10
                },
                columnStyles: {
                    0: { fontStyle: 'bold', cellWidth: 50 },
                    1: { cellWidth: 130 }
                },
                margin: { left: 15, right: 15 }
            });

            // ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            // ‚îÇ TABELLE 2: FAHRZEUGDATEN                    ‚îÇ
            // ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 5,
                head: [['FAHRZEUGDATEN', '']],
                body: [
                    ['Marke / Modell', `${data.marke} ${data.modell}`],
                    ['Baujahr', baujahrText],
                    ['KM-Stand', data.kmstand ? (data.kmstand + ' km') : 'Nicht angegeben'],
                    ['VIN/FIN', data.vin || 'Nicht angegeben'],
                    ['Farbe', `${data.farbname || ''} ${data.farbvariante || ''} (${data.farbnummer || 'n/a'})`.trim()]
                ],
                theme: 'grid',
                headStyles: {
                    fillColor: [0, 51, 102],
                    textColor: 255,
                    fontStyle: 'bold',
                    fontSize: 11
                },
                bodyStyles: {
                    fontSize: 10
                },
                columnStyles: {
                    0: { fontStyle: 'bold', cellWidth: 50 },
                    1: { cellWidth: 130 }
                },
                margin: { left: 15, right: 15 }
            });

            // Y-Position f√ºr n√§chsten Inhalt
            let y = doc.lastAutoTable.finalY + 10;

            // üé® TABELLE 3: SERVICES (Excel-Style - Pattern 36)
            // PDF-safe text labels (emojis don't render in jsPDF)
            const serviceIcons = {
                'lackierung': '[LACK]',
                'lackier': '[LACK]',
                'reifen': '[REIF]',
                'glas': '[GLAS]',
                'klima': '[KLIM]',
                'dellen': '[DELL]',
                'mechanik': '[MECH]',
                'versicherung': '[VERS]',
                'pflege': '[PFLG]',
                'tuev': '[T√úV]',
                'folierung': '[FOLI]',
                'steinschutz': '[STEIN]',
                'werbebeklebung': '[WERB]',
                'alle': '[ALL]'
            };
            const serviceColors = {
                'lackierung': [220, 53, 69],
                'lackier': [220, 53, 69],
                'reifen': [255, 152, 0],
                'glas': [3, 169, 244],
                'klima': [0, 188, 212],
                'dellen': [156, 39, 176],
                'mechanik': [96, 125, 139],
                'versicherung': [76, 175, 80],
                'pflege': [233, 30, 99],
                'tuev': [76, 175, 80],
                'folierung': [156, 39, 176],
                'steinschutz': [96, 125, 139],
                'werbebeklebung': [255, 87, 34],
                'alle': [63, 81, 181]
            };
            const serviceLabels = {
                'lackierung': 'LACKIERUNG',
                'lackier': 'LACKIERUNG',
                'reifen': 'REIFEN-SERVICE',
                'glas': 'GLAS-REPARATUR',
                'klima': 'KLIMA-SERVICE',
                'dellen': 'DELLEN-REPARATUR',
                'mechanik': 'MECHANIK-SERVICE',
                'versicherung': 'VERSICHERUNGS-SCHADEN',
                'pflege': 'FAHRZEUG-PFLEGE',
                'tuev': 'T√úV/AU-PR√úFUNG',
                'folierung': 'AUTO-FOLIERUNG',
                'steinschutz': 'STEINSCHUTZFOLIE',
                'werbebeklebung': 'FAHRZEUGBESCHRIFTUNG',
                'alle': 'ALLE SERVICES'
            };

            const serviceTyp = data.serviceTyp || 'lackierung';
            const icon = serviceIcons[serviceTyp] || 'üîß';
            const label = serviceLabels[serviceTyp] || 'SERVICE';

            // Build service rows for table
            const serviceRows = [[icon, label + ' (Haupt-Service)']];

            // Add additional services to table
            if (data.additionalServices && Array.isArray(data.additionalServices)
                && data.additionalServices.length > 0) {
                data.additionalServices.forEach(addService => {
                    const addServiceTyp = addService.serviceTyp;
                    const addIcon = serviceIcons[addServiceTyp] || '[?]';
                    const addLabel = serviceLabels[addServiceTyp] || 'SERVICE';
                    serviceRows.push([addIcon, addLabel]);
                });
            }

            // ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
            // ‚îÇ TABELLE 3: SERVICES (Excel-Style)           ‚îÇ
            // ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 5,
                head: [['SERVICE', 'BESCHREIBUNG']],
                body: serviceRows,
                theme: 'grid',
                headStyles: {
                    fillColor: [0, 51, 102],
                    textColor: 255,
                    fontStyle: 'bold',
                    fontSize: 11
                },
                bodyStyles: {
                    fontSize: 10
                },
                columnStyles: {
                    0: { fontStyle: 'bold', cellWidth: 30, halign: 'center' },
                    1: { cellWidth: 150 }
                },
                margin: { left: 15, right: 15 }
            });

            // Y-Position f√ºr Service-Details (NICHT √ÑNDERN - Bug #2 Fix!)
            y = doc.lastAutoTable.finalY + 10;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(11);

            // üÜï MULTI-SERVICE: Render Additional Services Details (NICHT √ÑNDERN!)
            if (data.additionalServices && Array.isArray(data.additionalServices)
                && data.additionalServices.length > 0) {
                doc.setFont(undefined, 'normal');
                y += 6;

                data.additionalServices.forEach((additionalService) => {
                    const addServiceTyp = additionalService.serviceTyp;
                    const addIcon = serviceIcons[addServiceTyp] || '[?]';
                    const addLabel = serviceLabels[addServiceTyp] || 'SERVICE';
                    const addServiceData = additionalService.serviceDetails || additionalService.serviceData || {};

                    // üÜï PAGE BREAK CHECK: Prevent header cutoff with many Additional Services
                    if (y > 210) {
                        doc.addPage();
                        y = 20;
                    }

                    // Service name header
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text(`   ${addIcon} ${addLabel}`, 25, y);
                    y += 6;

                    // Render service-specific details
                    if (Object.keys(addServiceData).length > 0) {
                        doc.setFontSize(9);
                        doc.setFont(undefined, 'normal');

                        switch(addServiceTyp) {
                            case 'reifen':
                                if (addServiceData.reifengroesse) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Reifengr√∂√üe:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    doc.text(addServiceData.reifengroesse, 70, y);
                                    y += 6;
                                }
                                if (addServiceData.reifentyp) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Reifentyp:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    doc.text(addServiceData.reifentyp, 70, y);
                                    y += 6;
                                }
                                if (addServiceData.reifenanzahl) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Anzahl:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    doc.text(addServiceData.reifenanzahl + ' Reifen', 70, y);
                                    y += 6;
                                }
                                // üÜï Partner-Felder (FIX 2025-11-12)
                                if (addServiceData.art) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Service-Art:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    const artLabels = {'montage': 'Montage', 'wechsel': 'Wechsel', 'einlagerung': 'Einlagerung'};
                                    doc.text(artLabels[addServiceData.art] || addServiceData.art, 70, y);
                                    y += 6;
                                }
                                if (addServiceData.marke) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Marke:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    doc.text(addServiceData.marke, 70, y);
                                    y += 6;
                                }
                                if (addServiceData.anliefertermin) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Anliefertermin:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    const datum = formatFirestoreDate(addServiceData.anliefertermin) || 'Nicht angegeben';
                                    doc.text(datum, 70, y);
                                    y += 6;
                                }
                                if (addServiceData.dringlichkeitLabel) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Dringlichkeit:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    if (addServiceData.dringlichkeitLabel === 'DRINGEND') {
                                        doc.setTextColor(199, 37, 78);
                                        doc.setFont(undefined, 'bold');
                                    }
                                    doc.text(addServiceData.dringlichkeitLabel, 70, y);
                                    doc.setTextColor(0, 0, 0);
                                    doc.setFont(undefined, 'normal');
                                    y += 6;
                                }
                                break;

                            case 'glas':
                                if (addServiceData.scheibentyp) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Scheibentyp:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    doc.text(addServiceData.scheibentyp, 70, y);
                                    y += 6;
                                }
                                if (addServiceData.schadensgroesse) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Schadensgr√∂√üe:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    doc.text(addServiceData.schadensgroesse, 70, y);
                                    y += 6;
                                }
                                if (addServiceData.glasposition) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Position:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    doc.text(addServiceData.glasposition, 70, y);
                                    y += 6;
                                }
                                // üÜï Partner-Felder (FIX 2025-11-12)
                                if (addServiceData.art) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Service-Art:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    const artLabels = {'reparatur': 'Reparatur', 'austausch': 'Austausch'};
                                    doc.text(artLabels[addServiceData.art] || addServiceData.art, 70, y);
                                    y += 6;
                                }
                                if (addServiceData.anliefertermin) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Anliefertermin:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    const datum = formatFirestoreDate(addServiceData.anliefertermin) || 'Nicht angegeben';
                                    doc.text(datum, 70, y);
                                    y += 6;
                                }
                                if (addServiceData.dringlichkeitLabel) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Dringlichkeit:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    if (addServiceData.dringlichkeitLabel === 'DRINGEND') {
                                        doc.setTextColor(199, 37, 78);
                                        doc.setFont(undefined, 'bold');
                                    }
                                    doc.text(addServiceData.dringlichkeitLabel, 70, y);
                                    doc.setTextColor(0, 0, 0);
                                    doc.setFont(undefined, 'normal');
                                    y += 6;
                                }
                                break;

                            case 'klima':
                                if (addServiceData.klimaservice) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Service-Art:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    doc.text(addServiceData.klimaservice, 70, y);
                                    y += 6;
                                }
                                if (addServiceData.kaeltemittel) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('K√§ltemittel:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    doc.text(addServiceData.kaeltemittel, 70, y);
                                    y += 6;
                                }
                                if (addServiceData.klimaproblem) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Problem:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    const klimaText = doc.splitTextToSize(addServiceData.klimaproblem, 140);
                                    doc.text(klimaText, 70, y);
                                    y += klimaText.length * 5 + 2;
                                }
                                // üÜï Partner-Felder (FIX 2025-11-12)
                                if (addServiceData.art) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Art:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    const artLabels = {'inspektion': 'Inspektion', 'desinfektion': 'Desinfektion', 'reparatur': 'Reparatur'};
                                    doc.text(artLabels[addServiceData.art] || addServiceData.art, 70, y);
                                    y += 6;
                                }
                                if (addServiceData.anliefertermin) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Anliefertermin:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    const datum = formatFirestoreDate(addServiceData.anliefertermin) || 'Nicht angegeben';
                                    doc.text(datum, 70, y);
                                    y += 6;
                                }
                                if (addServiceData.dringlichkeitLabel) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Dringlichkeit:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    if (addServiceData.dringlichkeitLabel === 'DRINGEND') {
                                        doc.setTextColor(199, 37, 78);
                                        doc.setFont(undefined, 'bold');
                                    }
                                    doc.text(addServiceData.dringlichkeitLabel, 70, y);
                                    doc.setTextColor(0, 0, 0);
                                    doc.setFont(undefined, 'normal');
                                    y += 6;
                                }
                                break;

                            case 'dellen':
                                if (addServiceData.dellenanzahl) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Anzahl Dellen:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    doc.text(addServiceData.dellenanzahl, 70, y);
                                    y += 6;
                                }
                                if (addServiceData.dellengroesse) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Gr√∂√üe:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    doc.text(addServiceData.dellengroesse, 70, y);
                                    y += 6;
                                }
                                if (addServiceData.lackschaden) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Lackschaden:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    doc.text(addServiceData.lackschaden, 70, y);
                                    y += 6;
                                }
                                if (addServiceData.dellenpositionen) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Positionen:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    const dellenText = doc.splitTextToSize(addServiceData.dellenpositionen, 140);
                                    doc.text(dellenText, 70, y);
                                    y += dellenText.length * 5 + 2;
                                }
                                // üÜï Partner-Felder (FIX 2025-11-12)
                                if (addServiceData.anliefertermin) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Anliefertermin:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    const datum = formatFirestoreDate(addServiceData.anliefertermin) || 'Nicht angegeben';
                                    doc.text(datum, 70, y);
                                    y += 6;
                                }
                                if (addServiceData.dringlichkeitLabel) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Dringlichkeit:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    if (addServiceData.dringlichkeitLabel === 'DRINGEND') {
                                        doc.setTextColor(199, 37, 78);
                                        doc.setFont(undefined, 'bold');
                                    }
                                    doc.text(addServiceData.dringlichkeitLabel, 70, y);
                                    doc.setTextColor(0, 0, 0);
                                    doc.setFont(undefined, 'normal');
                                    y += 6;
                                }
                                break;

                            case 'mechanik':
                                if (addServiceData.problem) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Problem:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    const problemText = doc.splitTextToSize(addServiceData.problem, 140);
                                    doc.text(problemText, 70, y);
                                    y += problemText.length * 5 + 2;
                                }
                                if (addServiceData.symptome) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Symptome:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    const symptomeText = doc.splitTextToSize(addServiceData.symptome, 140);
                                    doc.text(symptomeText, 70, y);
                                    y += symptomeText.length * 5 + 2;
                                }
                                // üÜï Partner-Felder (FIX 2025-11-12)
                                if (addServiceData.kategorie) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Kategorie:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    const kategorieLabels = {'motor': 'Motor', 'bremsen': 'Bremsen', 'fahrwerk': 'Fahrwerk', 'elektrik': 'Elektrik', 'abgasanlage': 'Abgasanlage', 'sonstiges': 'Sonstiges'};
                                    doc.text(kategorieLabels[addServiceData.kategorie] || addServiceData.kategorie, 70, y);
                                    y += 6;
                                }
                                if (addServiceData.anliefertermin) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Anliefertermin:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    const datum = formatFirestoreDate(addServiceData.anliefertermin) || 'Nicht angegeben';
                                    doc.text(datum, 70, y);
                                    y += 6;
                                }
                                if (addServiceData.dringlichkeitLabel) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Dringlichkeit:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    if (addServiceData.dringlichkeitLabel === 'DRINGEND') {
                                        doc.setTextColor(199, 37, 78);
                                        doc.setFont(undefined, 'bold');
                                    }
                                    doc.text(addServiceData.dringlichkeitLabel, 70, y);
                                    doc.setTextColor(0, 0, 0);
                                    doc.setFont(undefined, 'normal');
                                    y += 6;
                                }
                                break;

                            case 'versicherung':
                                if (addServiceData.schadensnummer) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Schadensnummer:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    doc.text(addServiceData.schadensnummer, 80, y);
                                    y += 6;
                                }
                                if (addServiceData.versicherung) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Versicherung:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    doc.text(addServiceData.versicherung, 80, y);
                                    y += 6;
                                }
                                if (addServiceData.schadendatum) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Schadendatum:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    const schadenDatum = formatFirestoreDate(addServiceData.schadendatum) || 'Nicht angegeben';
                                    doc.text(schadenDatum, 80, y);
                                    y += 6;
                                }
                                if (addServiceData.unfallhergang) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Unfallhergang:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    const hergangText = doc.splitTextToSize(addServiceData.unfallhergang, 140);
                                    doc.text(hergangText, 80, y);
                                    y += hergangText.length * 5 + 2;
                                }
                                break;

                            case 'pflege':
                                if (addServiceData.paket) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Pflege-Paket:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    doc.text(addServiceData.paket, 70, y);
                                    y += 6;
                                }
                                if (addServiceData.zusatzleistungen) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Zusatzleistungen:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    const zusatzText = doc.splitTextToSize(addServiceData.zusatzleistungen, 140);
                                    doc.text(zusatzText, 70, y);
                                    y += zusatzText.length * 5 + 2;
                                }
                                break;

                            case 'tuev':
                                if (addServiceData.pruefart) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Pr√ºfart:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    doc.text(addServiceData.pruefart, 70, y);
                                    y += 6;
                                }
                                if (addServiceData.faelligkeit) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('F√§lligkeit:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    // faelligkeit ist String-Format "YYYY-MM", daher + '-01' f√ºr vollst√§ndiges Datum
                                    const faelligkeitValue = typeof addServiceData.faelligkeit === 'string'
                                        ? addServiceData.faelligkeit
                                        : (addServiceData.faelligkeit.toDate?.() || new Date(addServiceData.faelligkeit)).toISOString().slice(0, 7);
                                    const faelligkeitDate = new Date(faelligkeitValue + '-01');
                                    const faelligkeitText = faelligkeitDate.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
                                    doc.text(faelligkeitText, 70, y);
                                    y += 6;
                                }
                                if (addServiceData.bekannteMaengel) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Bekannte M√§ngel:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    const maengelText = doc.splitTextToSize(addServiceData.bekannteMaengel, 140);
                                    doc.text(maengelText, 70, y);
                                    y += maengelText.length * 5 + 2;
                                }
                                break;

                            case 'folierung':
                                if (addServiceData.folierungArt) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Art der Folierung:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    const artLabels = {
                                        'vollfolierung': 'Vollfolierung',
                                        'teilfolierung': 'Teilfolierung',
                                        'akzentfolierung': 'Akzentfolierung'
                                    };
                                    doc.text(artLabels[addServiceData.folierungArt] || addServiceData.folierungArt, 80, y);
                                    y += 6;
                                }
                                if (addServiceData.folierungMaterial) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Materialqualit√§t:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    const materialLabels = {
                                        'standard': 'Standard',
                                        'premium': 'Premium',
                                        'high_end': 'High-End'
                                    };
                                    doc.text(materialLabels[addServiceData.folierungMaterial] || addServiceData.folierungMaterial, 80, y);
                                    y += 6;
                                }
                                if (addServiceData.folierungSpezialTyp) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Spezialtyp:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    const spezialLabels = {
                                        'carbon': 'Carbon-Look',
                                        'chrom': 'Chrom-Look',
                                        'matt': 'Matte Optik',
                                        'glanz': 'Hochglanz',
                                        'metallic': 'Metallic-Effekt',
                                        'geb√ºrstet': 'Geb√ºrstetes Finish'
                                    };
                                    doc.text(spezialLabels[addServiceData.folierungSpezialTyp] || addServiceData.folierungSpezialTyp, 80, y);
                                    y += 6;
                                }
                                if (addServiceData.folierungFarbe) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Farbauswahl:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    doc.text(addServiceData.folierungFarbe, 80, y);
                                    y += 6;
                                }
                                if (addServiceData.folierungBereiche && addServiceData.folierungBereiche.length > 0) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Zu folierende Bereiche:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    const bereicheText = addServiceData.folierungBereiche.join(', ');
                                    const bereicheLines = doc.splitTextToSize(bereicheText, 140);
                                    doc.text(bereicheLines, 30, y + 3);
                                    y += bereicheLines.length * 5 + 5;
                                }
                                if (addServiceData.folierungDesign) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Design-Vorstellungen:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    const designText = doc.splitTextToSize(addServiceData.folierungDesign, 140);
                                    doc.text(designText, 30, y + 3);
                                    y += designText.length * 5 + 5;
                                }
                                if (addServiceData.folierungInfo) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Zus√§tzliche Informationen:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    const infoText = doc.splitTextToSize(addServiceData.folierungInfo, 140);
                                    doc.text(infoText, 30, y + 3);
                                    y += infoText.length * 5 + 5;
                                }
                                break;

                            case 'steinschutz':
                                if (addServiceData.steinschutzUmfang) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Schutzumfang:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    const umfangLabels = {
                                        'vollverklebung': 'Vollverklebung',
                                        'frontpaket': 'Frontpaket',
                                        'teilbereich': 'Teilbereich'
                                    };
                                    doc.text(umfangLabels[addServiceData.steinschutzUmfang] || addServiceData.steinschutzUmfang, 80, y);
                                    y += 6;
                                }
                                if (addServiceData.steinschutzMaterial) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Materialqualit√§t:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    const materialLabels = {
                                        'standard': 'Standard',
                                        'premium': 'Premium',
                                        'high_end': 'High-End'
                                    };
                                    doc.text(materialLabels[addServiceData.steinschutzMaterial] || addServiceData.steinschutzMaterial, 80, y);
                                    y += 6;
                                }
                                if (addServiceData.steinschutzBereiche) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Zu sch√ºtzende Bereiche:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    const bereicheText = doc.splitTextToSize(addServiceData.steinschutzBereiche, 140);
                                    doc.text(bereicheText, 30, y + 3);
                                    y += bereicheText.length * 5 + 5;
                                }
                                if (addServiceData.steinschutzInfo) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Zus√§tzliche Informationen:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    const infoText = doc.splitTextToSize(addServiceData.steinschutzInfo, 140);
                                    doc.text(infoText, 30, y + 3);
                                    y += infoText.length * 5 + 5;
                                }
                                break;

                            case 'werbebeklebung':
                                if (addServiceData.werbebeklebungUmfang) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Umfang der Beklebung:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    const umfangLabels = {
                                        'einfach': 'Einfache Beschriftung',
                                        'komplex': 'Komplexe Gestaltung',
                                        'teilbeklebung': 'Teilbeklebung',
                                        'magnetschilder': 'Magnetschilder',
                                        'logo': 'Logo/Schriftzug'
                                    };
                                    doc.text(umfangLabels[addServiceData.werbebeklebungUmfang] || addServiceData.werbebeklebungUmfang, 80, y);
                                    y += 6;
                                }
                                if (addServiceData.werbebeklebungKomplexitaet) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Design-Komplexit√§t:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    const komplexLabels = {
                                        'einfach': 'Einfach',
                                        'mittel': 'Mittel',
                                        'komplex': 'Komplex'
                                    };
                                    doc.text(komplexLabels[addServiceData.werbebeklebungKomplexitaet] || addServiceData.werbebeklebungKomplexitaet, 80, y);
                                    y += 6;
                                }
                                if (addServiceData.werbebeklebungText) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Textelemente:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    const textElements = doc.splitTextToSize(addServiceData.werbebeklebungText, 140);
                                    doc.text(textElements, 30, y + 3);
                                    y += textElements.length * 5 + 5;
                                }
                                if (addServiceData.werbebeklebungFarbanzahl) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Anzahl Farben:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    doc.text(addServiceData.werbebeklebungFarbanzahl + ' Farben', 80, y);
                                    y += 6;
                                }
                                if (addServiceData.werbebeklebungInfo) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Zus√§tzliche Informationen:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    const infoText = doc.splitTextToSize(addServiceData.werbebeklebungInfo, 140);
                                    doc.text(infoText, 30, y + 3);
                                    y += infoText.length * 5 + 5;
                                }
                                break;

                            case 'lackier':
                                // FIX (2025-11-12): Verwende tats√§chliche HTML-Feldnamen (farbname, farbnummer, etc.)
                                if (addServiceData.farbname) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Farbname:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    doc.text(addServiceData.farbname, 70, y);
                                    y += 6;
                                }
                                if (addServiceData.farbvariante) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Farbvariante:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    doc.text(addServiceData.farbvariante, 70, y);
                                    y += 6;
                                }
                                if (addServiceData.farbnummer) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Farbnummer:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    doc.setFontSize(11);
                                    doc.setTextColor(199, 37, 78);
                                    doc.text(addServiceData.farbnummer, 70, y);
                                    doc.setTextColor(0, 0, 0);
                                    doc.setFontSize(9);
                                    y += 6;
                                }
                                if (addServiceData.lackart) {
                                    doc.setFont(undefined, 'bold');
                                    doc.text('Lackart:', 30, y);
                                    doc.setFont(undefined, 'normal');
                                    doc.text(addServiceData.lackart, 70, y);
                                    y += 6;
                                }
                                break;
                        }

                        y += 3; // Extra spacing after details
                        doc.setFontSize(10);
                    } else {
                        y += 2; // Minimal spacing when no details
                    }
                });

                y += 3;  // Extra space after additional services
                doc.setFontSize(11);
            }

            doc.setFont(undefined, 'bold');
            doc.text('Geplante Abnahme:', 20, y);
            doc.setFont(undefined, 'normal');
            const abnahmeDatumFormatted = data.geplantesAbnahmeDatum
                ? new Date(data.geplantesAbnahmeDatum).toLocaleDateString('de-DE')
                : 'Nicht angegeben';
            doc.text(abnahmeDatumFormatted, 100, y);

            // FAHRZEUG-ABHOLUNG Section
            if (data.fahrzeugAbholung === 'ja') {
                y += 12;
                doc.setFillColor(255, 152, 0); // Orange f√ºr Abholung
                doc.roundedRect(15, y - 5, 180, 10, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(12);
                doc.text('[ABHOL]  FAHRZEUG-ABHOLUNG', 20, y + 1);

                y += 10;
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);

                if (data.abholadresse) {
                    doc.setFont(undefined, 'bold');
                    doc.text('Abholadresse:', 20, y);
                    doc.setFont(undefined, 'normal');
                    const adresseLines = doc.splitTextToSize(data.abholadresse, 130);
                    doc.text(adresseLines, 70, y);
                    y += adresseLines.length * 5 + 2;
                }

                if (data.abholdatum || data.abholzeit) {
                    doc.setFont(undefined, 'bold');
                    doc.text('Abholdatum/-zeit:', 20, y);
                    doc.setFont(undefined, 'normal');
                    let abholText = '';
                    if (data.abholdatum) {
                        abholText = new Date(data.abholdatum).toLocaleDateString('de-DE');
                    }
                    if (data.abholzeit) {
                        abholText += (abholText ? ' um ' : '') + data.abholzeit + ' Uhr';
                    }
                    doc.text(abholText, 70, y);
                    y += 7;
                }

                if (data.abholnotiz) {
                    doc.setFont(undefined, 'bold');
                    doc.text('Notiz:', 20, y);
                    doc.setFont(undefined, 'normal');
                    const notizLines = doc.splitTextToSize(data.abholnotiz, 130);
                    doc.text(notizLines, 70, y);
                    y += notizLines.length * 5 + 2;
                }

                y += 5; // Extra spacing
            }

            // SERVICE-DETAILS (f√ºr service-spezifische Felder)
            if (data.serviceTyp && data.serviceTyp !== 'lackierung' && data.serviceDetails) {
                y += 12;
                doc.setFillColor(156, 39, 176); // Lila f√ºr Service-Details
                doc.roundedRect(15, y - 5, 180, 10, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(12);

                // Service-Name Header
                const serviceNames = {
                    'reifen': 'REIFEN-SERVICE',
                    'glas': 'GLAS-REPARATUR',
                    'klima': 'KLIMA-SERVICE',
                    'dellen': 'DELLEN-REPARATUR',
                    'mechanik': 'MECHANIK-SERVICE',
                    'versicherung': 'VERSICHERUNGS-SCHADEN',
                    'pflege': 'FAHRZEUG-PFLEGE',
                    'tuev': 'T√úV/AU-PR√úFUNG',
                    'folierung': 'AUTO-FOLIERUNG',
                    'steinschutz': 'STEINSCHUTZFOLIE',
                    'werbebeklebung': 'FAHRZEUGBESCHRIFTUNG'
                };
                doc.text(serviceNames[data.serviceTyp] || 'SERVICE-DETAILS', 20, y);

                y += 10;
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);

                // Service-spezifische Felder
                switch(data.serviceTyp) {
                    case 'reifen':
                        if (data.serviceDetails.reifengroesse) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Reifengr√∂√üe:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.reifengroesse, 60, y);
                            y += 7;
                        }
                        if (data.serviceDetails.reifentyp) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Reifentyp:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.reifentyp, 60, y);
                            y += 7;
                        }
                        if (data.serviceDetails.reifenanzahl) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Anzahl:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.reifenanzahl + ' Reifen', 60, y);
                            y += 7;
                        }

                        // üÜï Partner-Felder (FIX 2025-11-12)
                        if (data.serviceDetails.art) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Service-Art:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const artLabels = {
                                'montage': 'Montage (neue Reifen aufziehen)',
                                'wechsel': 'Reifenwechsel (Sommer/Winter)',
                                'einlagerung': 'Einlagerung'
                            };
                            const artText = doc.splitTextToSize(artLabels[data.serviceDetails.art] || data.serviceDetails.art, 120);
                            doc.text(artText, 60, y);
                            y += artText.length * 5 + 2;
                        }
                        if (data.serviceDetails.marke) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Reifenmarke:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.marke, 60, y);
                            y += 7;
                        }
                        if (data.serviceDetails.anliefertermin) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Anliefertermin:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const datum = new Date(data.serviceDetails.anliefertermin).toLocaleDateString('de-DE');
                            doc.text(datum, 60, y);
                            y += 7;
                        }
                        if (data.serviceDetails.dringlichkeitLabel) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Dringlichkeit:', 20, y);
                            doc.setFont(undefined, 'normal');
                            if (data.serviceDetails.dringlichkeitLabel === 'DRINGEND') {
                                doc.setTextColor(199, 37, 78); // ROT f√ºr DRINGEND
                                doc.setFont(undefined, 'bold');
                            }
                            doc.text(data.serviceDetails.dringlichkeitLabel, 60, y);
                            doc.setTextColor(0, 0, 0); // Reset
                            doc.setFont(undefined, 'normal');
                            y += 7;
                        }
                        if (data.serviceDetails.lieferoption) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Lieferoption:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const lieferLabels = {
                                'abholung': 'Abholung durch Werkstatt',
                                'selbstanlieferung': 'Selbstanlieferung'
                            };
                            doc.text(lieferLabels[data.serviceDetails.lieferoption] || data.serviceDetails.lieferoption, 60, y);
                            y += 7;
                        }
                        if (data.serviceDetails.abholadresse) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Abholadresse:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const adresseText = doc.splitTextToSize(data.serviceDetails.abholadresse, 120);
                            doc.text(adresseText, 60, y);
                            y += adresseText.length * 5 + 2;
                        }
                        if (data.serviceDetails.ersatzfahrzeugGewuenscht) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Ersatzfahrzeug:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.ersatzfahrzeugGewuenscht ? 'Ja, gew√ºnscht' : 'Nein', 60, y);
                            y += 7;
                        }
                        if (data.serviceDetails.info) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Zusatzinfo:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const infoText = doc.splitTextToSize(data.serviceDetails.info, 120);
                            doc.text(infoText, 60, y);
                            y += infoText.length * 5 + 2;
                        }
                        break;

                    case 'glas':
                        if (data.serviceDetails.scheibentyp) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Scheibentyp:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.scheibentyp, 60, y);
                            y += 7;
                        }
                        if (data.serviceDetails.schadensgroesse) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Schadensgr√∂√üe:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.schadensgroesse, 60, y);
                            y += 7;
                        }
                        if (data.serviceDetails.glasposition) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Position:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.glasposition, 60, y);
                            y += 7;
                        }

                        // üÜï Partner-Felder (FIX 2025-11-12)
                        if (data.serviceDetails.art) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Service-Art:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const artLabels = {
                                'reparatur': 'Reparatur (Steinschlag)',
                                'austausch': 'Austausch (komplette Scheibe)'
                            };
                            const artText = doc.splitTextToSize(artLabels[data.serviceDetails.art] || data.serviceDetails.art, 120);
                            doc.text(artText, 60, y);
                            y += artText.length * 5 + 2;
                        }
                        if (data.serviceDetails.anliefertermin) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Anliefertermin:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const datum = new Date(data.serviceDetails.anliefertermin).toLocaleDateString('de-DE');
                            doc.text(datum, 60, y);
                            y += 7;
                        }
                        if (data.serviceDetails.dringlichkeitLabel) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Dringlichkeit:', 20, y);
                            doc.setFont(undefined, 'normal');
                            if (data.serviceDetails.dringlichkeitLabel === 'DRINGEND') {
                                doc.setTextColor(199, 37, 78); // ROT f√ºr DRINGEND
                                doc.setFont(undefined, 'bold');
                            }
                            doc.text(data.serviceDetails.dringlichkeitLabel, 60, y);
                            doc.setTextColor(0, 0, 0); // Reset
                            doc.setFont(undefined, 'normal');
                            y += 7;
                        }
                        if (data.serviceDetails.lieferoption) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Lieferoption:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const lieferoptionLabels = {
                                'selbst': 'Kunde bringt Fahrzeug selbst',
                                'abholung': 'Abholservice gew√ºnscht'
                            };
                            const lieferText = doc.splitTextToSize(lieferoptionLabels[data.serviceDetails.lieferoption] || data.serviceDetails.lieferoption, 120);
                            doc.text(lieferText, 60, y);
                            y += lieferText.length * 5 + 2;
                        }
                        if (data.serviceDetails.abholadresse) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Abholadresse:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const adresseText = doc.splitTextToSize(data.serviceDetails.abholadresse, 120);
                            doc.text(adresseText, 60, y);
                            y += adresseText.length * 5 + 2;
                        }
                        if (data.serviceDetails.ersatzfahrzeugGewuenscht !== undefined) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Ersatzfahrzeug:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.ersatzfahrzeugGewuenscht ? 'Ja, gew√ºnscht' : 'Nein', 60, y);
                            y += 7;
                        }
                        if (data.serviceDetails.info) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Zusatzinfo:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const infoText = doc.splitTextToSize(data.serviceDetails.info, 120);
                            doc.text(infoText, 60, y);
                            y += infoText.length * 5 + 2;
                        }
                        break;

                    case 'klima':
                        if (data.serviceDetails.klimaservice) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Service-Art:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.klimaservice, 60, y);
                            y += 7;
                        }
                        if (data.serviceDetails.kaeltemittel) {
                            doc.setFont(undefined, 'bold');
                            doc.text('K√§ltemittel:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.kaeltemittel, 60, y);
                            y += 7;
                        }
                        if (data.serviceDetails.klimaproblem) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Problem:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const klimaText = doc.splitTextToSize(data.serviceDetails.klimaproblem, 130);
                            doc.text(klimaText, 60, y);
                            y += klimaText.length * 5 + 2;
                        }

                        // üÜï Partner-Felder (FIX 2025-11-12)
                        if (data.serviceDetails.art) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Art:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const artLabels = {
                                'inspektion': 'Klimaanlagen-Inspektion',
                                'desinfektion': 'Klimaanlagen-Desinfektion',
                                'reparatur': 'Klimaanlagen-Reparatur'
                            };
                            const artText = doc.splitTextToSize(artLabels[data.serviceDetails.art] || data.serviceDetails.art, 120);
                            doc.text(artText, 60, y);
                            y += artText.length * 5 + 2;
                        }
                        if (data.serviceDetails.anliefertermin) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Anliefertermin:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const datum = new Date(data.serviceDetails.anliefertermin).toLocaleDateString('de-DE');
                            doc.text(datum, 60, y);
                            y += 7;
                        }
                        if (data.serviceDetails.dringlichkeitLabel) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Dringlichkeit:', 20, y);
                            doc.setFont(undefined, 'normal');
                            if (data.serviceDetails.dringlichkeitLabel === 'DRINGEND') {
                                doc.setTextColor(199, 37, 78); // ROT f√ºr DRINGEND
                                doc.setFont(undefined, 'bold');
                            }
                            doc.text(data.serviceDetails.dringlichkeitLabel, 60, y);
                            doc.setTextColor(0, 0, 0); // Reset
                            doc.setFont(undefined, 'normal');
                            y += 7;
                        }
                        if (data.serviceDetails.lieferoption) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Lieferoption:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const lieferoptionLabels = {
                                'selbst': 'Kunde bringt Fahrzeug selbst',
                                'abholung': 'Abholservice gew√ºnscht'
                            };
                            const lieferText = doc.splitTextToSize(lieferoptionLabels[data.serviceDetails.lieferoption] || data.serviceDetails.lieferoption, 120);
                            doc.text(lieferText, 60, y);
                            y += lieferText.length * 5 + 2;
                        }
                        if (data.serviceDetails.abholadresse) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Abholadresse:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const adresseText = doc.splitTextToSize(data.serviceDetails.abholadresse, 120);
                            doc.text(adresseText, 60, y);
                            y += adresseText.length * 5 + 2;
                        }
                        if (data.serviceDetails.ersatzfahrzeugGewuenscht !== undefined) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Ersatzfahrzeug:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.ersatzfahrzeugGewuenscht ? 'Ja, gew√ºnscht' : 'Nein', 60, y);
                            y += 7;
                        }
                        if (data.serviceDetails.info) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Zusatzinfo:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const infoText = doc.splitTextToSize(data.serviceDetails.info, 120);
                            doc.text(infoText, 60, y);
                            y += infoText.length * 5 + 2;
                        }
                        break;

                    case 'dellen':
                        if (data.serviceDetails.dellenanzahl) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Anzahl Dellen:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.dellenanzahl, 60, y);
                            y += 7;
                        }
                        if (data.serviceDetails.dellengroesse) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Gr√∂√üe:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.dellengroesse, 60, y);
                            y += 7;
                        }
                        if (data.serviceDetails.lackschaden) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Lackschaden:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.lackschaden, 60, y);
                            y += 7;
                        }
                        if (data.serviceDetails.dellenpositionen) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Positionen:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const dellenText = doc.splitTextToSize(data.serviceDetails.dellenpositionen, 130);
                            doc.text(dellenText, 60, y);
                            y += dellenText.length * 5 + 2;
                        }

                        // üÜï Partner-Felder (FIX 2025-11-12)
                        if (data.serviceDetails.anliefertermin) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Anliefertermin:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const datum = new Date(data.serviceDetails.anliefertermin).toLocaleDateString('de-DE');
                            doc.text(datum, 60, y);
                            y += 7;
                        }
                        if (data.serviceDetails.dringlichkeitLabel) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Dringlichkeit:', 20, y);
                            doc.setFont(undefined, 'normal');
                            if (data.serviceDetails.dringlichkeitLabel === 'DRINGEND') {
                                doc.setTextColor(199, 37, 78); // ROT f√ºr DRINGEND
                                doc.setFont(undefined, 'bold');
                            }
                            doc.text(data.serviceDetails.dringlichkeitLabel, 60, y);
                            doc.setTextColor(0, 0, 0); // Reset
                            doc.setFont(undefined, 'normal');
                            y += 7;
                        }
                        if (data.serviceDetails.lieferoption) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Lieferoption:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const lieferoptionLabels = {
                                'selbst': 'Kunde bringt Fahrzeug selbst',
                                'abholung': 'Abholservice gew√ºnscht'
                            };
                            const lieferText = doc.splitTextToSize(lieferoptionLabels[data.serviceDetails.lieferoption] || data.serviceDetails.lieferoption, 120);
                            doc.text(lieferText, 60, y);
                            y += lieferText.length * 5 + 2;
                        }
                        if (data.serviceDetails.abholadresse) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Abholadresse:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const adresseText = doc.splitTextToSize(data.serviceDetails.abholadresse, 120);
                            doc.text(adresseText, 60, y);
                            y += adresseText.length * 5 + 2;
                        }
                        if (data.serviceDetails.ersatzfahrzeugGewuenscht !== undefined) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Ersatzfahrzeug:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.ersatzfahrzeugGewuenscht ? 'Ja, gew√ºnscht' : 'Nein', 60, y);
                            y += 7;
                        }
                        if (data.serviceDetails.info) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Zusatzinfo:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const infoText = doc.splitTextToSize(data.serviceDetails.info, 120);
                            doc.text(infoText, 60, y);
                            y += infoText.length * 5 + 2;
                        }
                        break;

                    case 'mechanik':
                        if (data.serviceDetails.problem) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Problem:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const problemText = doc.splitTextToSize(data.serviceDetails.problem, 130);
                            doc.text(problemText, 60, y);
                            y += problemText.length * 5 + 2;
                        }
                        if (data.serviceDetails.symptome) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Symptome:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const symptomeText = doc.splitTextToSize(data.serviceDetails.symptome, 130);
                            doc.text(symptomeText, 60, y);
                            y += symptomeText.length * 5 + 2;
                        }

                        // üÜï Partner-Felder (FIX 2025-11-12)
                        if (data.serviceDetails.kategorie) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Kategorie:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const kategorieLabels = {
                                'motor': 'Motor',
                                'bremsen': 'Bremsen',
                                'fahrwerk': 'Fahrwerk',
                                'elektrik': 'Elektrik',
                                'abgasanlage': 'Abgasanlage',
                                'sonstiges': 'Sonstiges'
                            };
                            doc.text(kategorieLabels[data.serviceDetails.kategorie] || data.serviceDetails.kategorie, 60, y);
                            y += 7;
                        }
                        if (data.serviceDetails.anliefertermin) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Anliefertermin:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const datum = new Date(data.serviceDetails.anliefertermin).toLocaleDateString('de-DE');
                            doc.text(datum, 60, y);
                            y += 7;
                        }
                        if (data.serviceDetails.dringlichkeitLabel) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Dringlichkeit:', 20, y);
                            doc.setFont(undefined, 'normal');
                            if (data.serviceDetails.dringlichkeitLabel === 'DRINGEND') {
                                doc.setTextColor(199, 37, 78); // ROT f√ºr DRINGEND
                                doc.setFont(undefined, 'bold');
                            }
                            doc.text(data.serviceDetails.dringlichkeitLabel, 60, y);
                            doc.setTextColor(0, 0, 0); // Reset
                            doc.setFont(undefined, 'normal');
                            y += 7;
                        }
                        if (data.serviceDetails.lieferoption) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Lieferoption:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const lieferoptionLabels = {
                                'selbst': 'Kunde bringt Fahrzeug selbst',
                                'abholung': 'Abholservice gew√ºnscht'
                            };
                            const lieferText = doc.splitTextToSize(lieferoptionLabels[data.serviceDetails.lieferoption] || data.serviceDetails.lieferoption, 120);
                            doc.text(lieferText, 60, y);
                            y += lieferText.length * 5 + 2;
                        }
                        if (data.serviceDetails.abholadresse) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Abholadresse:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const adresseText = doc.splitTextToSize(data.serviceDetails.abholadresse, 120);
                            doc.text(adresseText, 60, y);
                            y += adresseText.length * 5 + 2;
                        }
                        if (data.serviceDetails.ersatzfahrzeugGewuenscht !== undefined) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Ersatzfahrzeug:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.ersatzfahrzeugGewuenscht ? 'Ja, gew√ºnscht' : 'Nein', 60, y);
                            y += 7;
                        }
                        if (data.serviceDetails.info) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Zusatzinfo:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const infoText = doc.splitTextToSize(data.serviceDetails.info, 120);
                            doc.text(infoText, 60, y);
                            y += infoText.length * 5 + 2;
                        }
                        break;

                    case 'versicherung':
                        if (data.serviceDetails.schadensnummer) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Schadensnummer:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.schadensnummer, 70, y);
                            y += 7;
                        }
                        if (data.serviceDetails.versicherung) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Versicherung:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.versicherung, 70, y);
                            y += 7;
                        }
                        if (data.serviceDetails.schadendatum) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Schadendatum:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const schadenDatum = new Date(data.serviceDetails.schadendatum).toLocaleDateString('de-DE');
                            doc.text(schadenDatum, 70, y);
                            y += 7;
                        }
                        if (data.serviceDetails.unfallhergang) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Unfallhergang:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const hergangText = doc.splitTextToSize(data.serviceDetails.unfallhergang, 130);
                            doc.text(hergangText, 70, y);
                            y += hergangText.length * 5 + 2;
                        }
                        break;

                    case 'pflege':
                        if (data.serviceDetails.paket) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Pflege-Paket:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.paket, 60, y);
                            y += 7;
                        }
                        if (data.serviceDetails.zusatzleistungen) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Zusatzleistungen:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const zusatzText = doc.splitTextToSize(data.serviceDetails.zusatzleistungen, 130);
                            doc.text(zusatzText, 60, y);
                            y += zusatzText.length * 5 + 2;
                        }
                        break;

                    case 'tuev':
                        if (data.serviceDetails.pruefart) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Pr√ºfart:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.pruefart, 60, y);
                            y += 7;
                        }
                        if (data.serviceDetails.faelligkeit) {
                            doc.setFont(undefined, 'bold');
                            doc.text('F√§lligkeit:', 20, y);
                            doc.setFont(undefined, 'normal');
                            // Format YYYY-MM to "Monat YYYY"
                            const faelligkeitDate = new Date(data.serviceDetails.faelligkeit + '-01');
                            const faelligkeitText = faelligkeitDate.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' });
                            doc.text(faelligkeitText, 60, y);
                            y += 7;
                        }
                        if (data.serviceDetails.bekannteMaengel) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Bekannte M√§ngel:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const maengelText = doc.splitTextToSize(data.serviceDetails.bekannteMaengel, 130);
                            doc.text(maengelText, 60, y);
                            y += maengelText.length * 5 + 2;
                        }
                        break;

                    case 'folierung':
                        if (data.serviceDetails.folierungArt) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Art der Folierung:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const artLabels = {
                                'vollfolierung': 'Vollfolierung',
                                'teilfolierung': 'Teilfolierung',
                                'akzentfolierung': 'Akzentfolierung'
                            };
                            doc.text(artLabels[data.serviceDetails.folierungArt] || data.serviceDetails.folierungArt, 70, y);
                            y += 7;
                        }
                        if (data.serviceDetails.folierungMaterial) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Materialqualit√§t:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const materialLabels = {
                                'standard': 'Standard',
                                'premium': 'Premium',
                                'high_end': 'High-End'
                            };
                            doc.text(materialLabels[data.serviceDetails.folierungMaterial] || data.serviceDetails.folierungMaterial, 70, y);
                            y += 7;
                        }
                        if (data.serviceDetails.folierungSpezialTyp) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Spezialtyp:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const spezialLabels = {
                                'carbon': 'Carbon-Look',
                                'chrom': 'Chrom-Look',
                                'matt': 'Matte Optik',
                                'glanz': 'Hochglanz',
                                'metallic': 'Metallic-Effekt',
                                'geb√ºrstet': 'Geb√ºrstetes Finish'
                            };
                            doc.text(spezialLabels[data.serviceDetails.folierungSpezialTyp] || data.serviceDetails.folierungSpezialTyp, 70, y);
                            y += 7;
                        }
                        if (data.serviceDetails.folierungFarbe) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Farbauswahl:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.folierungFarbe, 70, y);
                            y += 7;
                        }
                        if (data.serviceDetails.folierungBereiche && data.serviceDetails.folierungBereiche.length > 0) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Zu folierende Bereiche:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const bereicheText = data.serviceDetails.folierungBereiche.join(', ');
                            const bereicheLines = doc.splitTextToSize(bereicheText, 130);
                            doc.text(bereicheLines, 20, y + 5);
                            y += bereicheLines.length * 5 + 7;
                        }
                        if (data.serviceDetails.folierungDesign) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Design-Vorstellungen:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const designText = doc.splitTextToSize(data.serviceDetails.folierungDesign, 130);
                            doc.text(designText, 20, y + 5);
                            y += designText.length * 5 + 7;
                        }
                        if (data.serviceDetails.folierungInfo) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Zus√§tzliche Informationen:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const infoText = doc.splitTextToSize(data.serviceDetails.folierungInfo, 130);
                            doc.text(infoText, 20, y + 5);
                            y += infoText.length * 5 + 7;
                        }
                        break;

                    case 'steinschutz':
                        if (data.serviceDetails.steinschutzUmfang) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Schutzumfang:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const umfangLabels = {
                                'vollverklebung': 'Vollverklebung',
                                'frontpaket': 'Frontpaket',
                                'teilbereich': 'Teilbereich'
                            };
                            doc.text(umfangLabels[data.serviceDetails.steinschutzUmfang] || data.serviceDetails.steinschutzUmfang, 70, y);
                            y += 7;
                        }
                        if (data.serviceDetails.steinschutzMaterial) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Materialqualit√§t:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const materialLabels = {
                                'standard': 'Standard',
                                'premium': 'Premium',
                                'high_end': 'High-End'
                            };
                            doc.text(materialLabels[data.serviceDetails.steinschutzMaterial] || data.serviceDetails.steinschutzMaterial, 70, y);
                            y += 7;
                        }
                        if (data.serviceDetails.steinschutzBereiche) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Zu sch√ºtzende Bereiche:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const bereicheText = doc.splitTextToSize(data.serviceDetails.steinschutzBereiche, 130);
                            doc.text(bereicheText, 20, y + 5);
                            y += bereicheText.length * 5 + 7;
                        }
                        if (data.serviceDetails.steinschutzInfo) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Zus√§tzliche Informationen:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const infoText = doc.splitTextToSize(data.serviceDetails.steinschutzInfo, 130);
                            doc.text(infoText, 20, y + 5);
                            y += infoText.length * 5 + 7;
                        }
                        break;

                    case 'werbebeklebung':
                        if (data.serviceDetails.werbebeklebungUmfang) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Umfang der Beklebung:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const umfangLabels = {
                                'einfach': 'Einfache Beschriftung',
                                'komplex': 'Komplexe Gestaltung',
                                'teilbeklebung': 'Teilbeklebung',
                                'magnetschilder': 'Magnetschilder',
                                'logo': 'Logo/Schriftzug'
                            };
                            doc.text(umfangLabels[data.serviceDetails.werbebeklebungUmfang] || data.serviceDetails.werbebeklebungUmfang, 70, y);
                            y += 7;
                        }
                        if (data.serviceDetails.werbebeklebungKomplexitaet) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Design-Komplexit√§t:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const komplexLabels = {
                                'einfach': 'Einfach',
                                'mittel': 'Mittel',
                                'komplex': 'Komplex'
                            };
                            doc.text(komplexLabels[data.serviceDetails.werbebeklebungKomplexitaet] || data.serviceDetails.werbebeklebungKomplexitaet, 70, y);
                            y += 7;
                        }
                        if (data.serviceDetails.werbebeklebungText) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Textelemente:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const textElements = doc.splitTextToSize(data.serviceDetails.werbebeklebungText, 130);
                            doc.text(textElements, 20, y + 5);
                            y += textElements.length * 5 + 7;
                        }
                        if (data.serviceDetails.werbebeklebungFarbanzahl) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Anzahl Farben:', 20, y);
                            doc.setFont(undefined, 'normal');
                            doc.text(data.serviceDetails.werbebeklebungFarbanzahl + ' Farben', 70, y);
                            y += 7;
                        }
                        if (data.serviceDetails.werbebeklebungInfo) {
                            doc.setFont(undefined, 'bold');
                            doc.text('Zus√§tzliche Informationen:', 20, y);
                            doc.setFont(undefined, 'normal');
                            const infoText = doc.splitTextToSize(data.serviceDetails.werbebeklebungInfo, 130);
                            doc.text(infoText, 20, y + 5);
                            y += infoText.length * 5 + 7;
                        }
                        break;
                }

                y += 5; // Extra spacing after service details
            }

            // üÜï LACKIER-INFO (Moved from after Fahrzeugdaten - now appears with Service Details)
            const hasPaintData = data.farbnummer || data.farbname || data.farbvariante;
            if (data.serviceTyp === 'lackier' || data.serviceTyp === 'alle' || hasPaintData) {
                // üÜï Page-Break-Check VOR LACKIER-INFO (Fix: Sektion wurde abgeschnitten!)
                // Der Lackier-Info Block braucht ca. 55mm H√∂he (Header + 4 Felder + FARBNUMMER-Box)
                if (y > 200) {
                    doc.addPage();
                    y = 20;
                }

                y += 12;
                doc.setFillColor(245, 87, 108);  // Red
                doc.roundedRect(15, y - 5, 180, 10, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(12);
                doc.text('[LACK]  LACKIER-INFORMATIONEN (FUER FARBKABINE)', 20, y + 1);

                y += 10;
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);

                // Farbname
                doc.setFont(undefined, 'bold');
                doc.text('Farbname:', 20, y);
                doc.setFont(undefined, 'normal');
                doc.text(data.farbname || 'Nicht angegeben', 55, y);
                y += 7;

                // Farbvariante
                doc.setFont(undefined, 'bold');
                doc.text('Farbvariante:', 20, y);
                doc.setFont(undefined, 'normal');
                doc.text(data.farbvariante || 'Nicht angegeben', 55, y);
                y += 7;

                // FARBNUMMER GROSS
                doc.setFillColor(255, 243, 205);
                doc.rect(15, y - 3, 140, 12, 'F');
                doc.setFont(undefined, 'bold');
                doc.setFontSize(14);
                doc.setTextColor(199, 37, 78);
                doc.text('FARBNUMMER:', 20, y + 4);
                doc.setFontSize(18);
                doc.text(data.farbnummer || 'Nicht angegeben', 70, y + 4);

                y += 15;
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text('Lackart:', 20, y);
                doc.setFont(undefined, 'normal');
                doc.text(data.lackart || 'Standard', 55, y);

                y += 7; // Extra spacing after Lackier-Info
            }

            // üÜï PAGE BREAK CHECK (2025-11-13): Prevent page 1 cutoff
            // After Fahrzeugdaten + Service Badge + Lackier-Info, check if we need new page
            if (y > 215) {
                doc.addPage();
                y = 20;
            }

            // PREIS-KALKULATION (Partner-Anfrage mit KVA ODER einfacher Preis)
            // üí∞ PREISE-BERECHTIGUNG: Nur anzeigen wenn Berechtigung vorhanden
            const canShowPrices = typeof window.canViewPrices === 'function' ? window.canViewPrices() : true;

            if (canShowPrices && data.kva && data.kva.varianten && data.gewaehlteVariante) {
                // Partner-Anfrage: KVA-Details anzeigen
                y += 15;

                // Header
                doc.setFillColor(33, 150, 243);  // Blau f√ºr KVA
                doc.rect(15, y - 5, 140, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(13);
                doc.text('PREIS-KALKULATION (Partner-Anfrage)', 20, y);

                y += 10;
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(10);

                // Partner-Info
                if (data.quelle === 'Partner-Portal' && data.partnerName) {
                    doc.setFont(undefined, 'normal');
                    doc.text('Partner: ' + data.partnerName, 20, y);
                    y += 5;
                }

                y += 5;

                // Tabellen-Header
                doc.setFillColor(240, 240, 240);
                doc.rect(15, y - 3, 140, 7, 'F');
                doc.setFont(undefined, 'bold');
                doc.setFontSize(9);
                doc.text('Beschreibung', 20, y);
                doc.text('Menge', 120, y);
                doc.text('Einzelpreis', 140, y);
                doc.text('Gesamt', 170, y);

                y += 7;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);

                // üÜï MULTI-SERVICE BREAKDOWN RENDERING
                const variante = data.kva.varianten[data.gewaehlteVariante];

                if (data.kva.isMultiService && data.kva.breakdown) {
                    // Multi-Service: Render breakdown by service
                    // console.log('üì¶ [PDF] Rendere Multi-Service Breakdown');

                    const breakdown = data.kva.breakdown;
                    const serviceLabels = data.kva.serviceLabels || {};
                    const serviceNames = {
                        'lackierung': 'üé® Lackierung',  // üîß FIX: lackierung (konsistent mit SERVICE_TEMPLATES)
                        'reifen': 'üõû Reifen-Service',
                        'mechanik': 'üîß Mechanik-Service',
                        'pflege': '‚ú® Fahrzeug-Pflege',
                        'tuev': 'üìã T√úV/AU',
                        'versicherung': 'üõ°Ô∏è Versicherung',
                        'glas': 'üîç Glas-Reparatur',
                        'klima': '‚ùÑÔ∏è Klima-Service',
                        'dellen': 'üî® Dellen-Reparatur',
                        'folierung': 'üåà Folierung',
                        'steinschutz': 'üõ°Ô∏è Steinschutz',
                        'werbebeklebung': 'üì¢ Fahrzeugbeschriftung'
                    };

                    // F√ºr jeden Service eine Section
                    Object.keys(breakdown).forEach((serviceTyp, index) => {
                        const service = breakdown[serviceTyp];

                        if (y > 240) {
                            doc.addPage();
                            y = 20;
                        }

                        // Service-√úberschrift
                        if (index > 0) y += 5; // Abstand zwischen Services
                        doc.setFillColor(230, 242, 253);
                        doc.rect(15, y - 3, 140, 7, 'F');
                        doc.setFont(undefined, 'bold');
                        doc.setFontSize(10);
                        doc.setTextColor(0, 51, 102);
                        doc.text(serviceNames[serviceTyp] || serviceTyp, 20, y);
                        doc.setTextColor(0, 0, 0);
                        y += 7;
                        doc.setFont(undefined, 'normal');
                        doc.setFontSize(9);

                        // Fields f√ºr diesen Service
                        service.fields.forEach(fieldName => {
                            const value = variante[fieldName] || 0;
                            if (value === 0) return; // Skip 0‚Ç¨ Felder

                            if (y > 250) {
                                doc.addPage();
                                y = 20;
                            }

                            const label = serviceLabels[fieldName] || fieldName;
                            const beschreibung = doc.splitTextToSize(label, 110);
                            doc.text(beschreibung, 20, y);
                            doc.setFont(undefined, 'bold');
                            doc.text(value.toFixed(2) + ' ‚Ç¨', 170, y);
                            doc.setFont(undefined, 'normal');

                            y += Math.max(5, beschreibung.length * 4);
                        });

                        // Service-Summe
                        y += 2;
                        doc.setFont(undefined, 'bold');
                        doc.setFontSize(10);
                        doc.text(`Summe ${serviceNames[serviceTyp] || serviceTyp}:`, 120, y);
                        doc.text(service.gesamt.toFixed(2) + ' ‚Ç¨', 170, y);
                        doc.setFont(undefined, 'normal');
                        doc.setFontSize(9);
                        y += 8;
                    });

                    y -= 3; // Korrektur nach letztem Service

                } else {
                    // Single-Service: Existing positionen logic
                    const positionen = variante.positionen || [];

                for (let i = 0; i < positionen.length; i++) {
                    const pos = positionen[i];

                    if (y > 250) {
                        doc.addPage();
                        y = 20;
                    }

                    const beschreibung = doc.splitTextToSize(pos.beschreibung || 'Position', 95);
                    doc.text(beschreibung, 20, y);

                    const menge = (pos.menge || 1).toString();
                    const einzelpreis = (pos.einzelpreis || 0).toFixed(2);
                    const gesamt = (pos.gesamt || (pos.menge * pos.einzelpreis) || 0).toFixed(2);

                    doc.text(menge + 'x', 120, y);
                    doc.text(einzelpreis + ' ‚Ç¨', 140, y);
                    doc.setFont(undefined, 'bold');
                    doc.text(gesamt + ' ‚Ç¨', 170, y);
                    doc.setFont(undefined, 'normal');

                    y += Math.max(5, beschreibung.length * 4);
                }

                y += 5;
                }  // üÜï Ende des else-Blocks (Single-Service)

                // Summen-Block
                doc.setDrawColor(200, 200, 200);
                doc.line(15, y, 195, y);
                y += 7;

                // Netto
                if (variante.netto) {
                    doc.setFont(undefined, 'normal');
                    doc.text('Netto:', 140, y);
                    doc.text((variante.netto || 0).toFixed(2) + ' EUR', 170, y);
                    y += 5;
                }

                // MwSt
                if (variante.mwst) {
                    doc.text('MwSt 19%:', 140, y);
                    doc.text((variante.mwst || 0).toFixed(2) + ' EUR', 170, y);
                    y += 5;
                }

                // Gesamt (fett & gr√ºn)
                y += 3;
                doc.setFillColor(76, 175, 80);
                doc.rect(135, y - 5, 60, 10, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(12);
                doc.text('GESAMT:', 140, y);
                doc.setFontSize(14);
                doc.text((variante.gesamt || data.vereinbarterPreis || 0).toFixed(2) + ' EUR', 170, y);

                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);
                y += 10;

            } else if (canShowPrices && data.vereinbarterPreis) {
                // Direkte Annahme: Einfacher Preis (wie bisher)
                y += 15;
                doc.setFillColor(76, 175, 80);
                doc.rect(15, y - 5, 140, 12, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont(undefined, 'bold');
                doc.setFontSize(13);
                doc.text('>>> VEREINBARTER PREIS:', 20, y + 2);
                doc.setFontSize(16);
                doc.text(data.vereinbarterPreis.toFixed(2) + ' EUR', 90, y + 2);
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(11);
                y += 5;
            }

            // Notizen immer anzeigen
            y += 8;  // Optimiert: 12 ‚Üí 8 (4px weniger f√ºr bessere Seitenauslastung)
            doc.setFont(undefined, 'bold');
            doc.text('Schadensbeschreibung / Notizen:', 20, y);
            y += 7;
            doc.setFont(undefined, 'normal');
            if (data.notizen) {
                const notizen = doc.splitTextToSize(data.notizen, 170);
                doc.text(notizen, 20, y);
                y += notizen.length * 5 + 5;  // Optimiert: 10 ‚Üí 5 (weniger Padding nach Notizen)
            } else {
                doc.text('Keine Notizen', 20, y);
                y += 12;
            }

            const photosForPDF = data.photosBase64 || data.photos || [];

            if (photosForPDF.length > 0) {
                if (y > 245) {  // Optimiert: 220 ‚Üí 245 (mehr Content auf Seite 1)
                    doc.addPage();
                    y = 20;
                }

                doc.setFont(undefined, 'bold');
                doc.text('Schadensfotos:', 20, y);
                y += 10;

                for (let i = 0; i < photosForPDF.length; i += 2) {
                    if (y > 230) {
                        doc.addPage();
                        y = 20;
                    }

                    const imgWidth = 80;
                    const imgHeight = 60;

                    doc.addImage(photosForPDF[i], 'JPEG', 20, y, imgWidth, imgHeight);
                    if (i + 1 < photosForPDF.length) {
                        doc.addImage(photosForPDF[i + 1], 'JPEG', 110, y, imgWidth, imgHeight);
                    }

                    y += imgHeight + 10;
                }
            }

            if (y > 210) {
                doc.addPage();
                y = 20;
            }

            y += 5;
            doc.setFont(undefined, 'bold');
            doc.text('Unterschrift Kunde:', 20, y);
            y += 5;
            const signatureY = y; // Save Y position for QR code alignment
            doc.addImage(data.signature, 'PNG', 20, y, 80, 30);

            // ============================================
            // QR-CODE SECTION (rechts neben Unterschrift)
            // ============================================
            if (data.qrCodeUrl) {
                try {
                    // console.log('üî≤ Generiere QR-Code f√ºr PDF (neben Unterschrift)...');

                    // Safety check: Verify QRious loaded
                    if (typeof QRious === 'undefined') {
                        throw new Error('QRious library not loaded');
                    }

                    // Generate QR Code Canvas with QRious
                    const qrCanvas = document.createElement('canvas');
                    new QRious({
                        element: qrCanvas,
                        value: data.qrCodeUrl,
                        size: 200,
                        background: '#FFFFFF',
                        foreground: '#003366',  // Auto-Lackierzentrum blue
                        padding: 4,
                        backgroundAlpha: 1,
                        foregroundAlpha: 1,
                        level: 'H'               // High error correction (30%)
                    });

                    // Convert canvas to image data URL
                    const qrImageData = qrCanvas.toDataURL('image/png');

                    // Position QR Code next to signature
                    const qrX = 110;  // Right next to signature (signature is 80mm wide, ends at x=100)
                    const qrY = signatureY - 5;  // Align with "Unterschrift Kunde:" label
                    const qrSize = 30;

                    // Light gray background box
                    doc.setFillColor(245, 245, 245);
                    doc.roundedRect(qrX - 2, qrY - 2, qrSize + 4, qrSize + 39, 2, 2, 'F');

                    // Add QR Code image
                    doc.addImage(qrImageData, 'PNG', qrX, qrY, qrSize, qrSize);

                    // Border around QR code
                    doc.setDrawColor(0, 51, 102);
                    doc.setLineWidth(0.5);
                    doc.rect(qrX, qrY, qrSize, qrSize);

                    // "PARTNER-PORTAL" Label above QR
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(0, 51, 102);
                    doc.text('PARTNER-PORTAL', qrX + (qrSize / 2), qrY - 2, { align: 'center' });

                    // Expiration Date below QR code
                    if (data.qrCodeExpiresAt) {
                        const expiryDate = formatFirestoreDate(data.qrCodeExpiresAt) || 'Nicht angegeben';
                        doc.setFontSize(6);
                        doc.setFont(undefined, 'normal');
                        doc.setTextColor(80, 80, 80);
                        doc.text('G√ºltig bis: ' + expiryDate, qrX + (qrSize / 2), qrY + qrSize + 3, { align: 'center' });
                    }

                    // PASSWORT SECTION (nur f√ºr NEU-KUNDEN)
                    if (data.isNewPartner && data.partnerPassword) {
                        // console.log('üÜï NEU-KUNDE ‚Üí Passwort wird im PDF angezeigt');

                        const pwY = qrY + qrSize + 8;

                        // Yellow background box for password
                        doc.setFillColor(255, 243, 205);
                        doc.roundedRect(qrX - 2, pwY - 2, qrSize + 4, 14, 2, 2, 'F');

                        // "PASSWORT" Label
                        doc.setFontSize(7);
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(139, 69, 19);
                        doc.text('PASSWORT:', qrX + (qrSize / 2), pwY + 2, { align: 'center' });

                        // Password
                        doc.setFontSize(9);
                        doc.setFont('courier', 'bold');
                        doc.setTextColor(0, 0, 0);
                        doc.text(data.partnerPassword, qrX + (qrSize / 2), pwY + 7, { align: 'center' });

                        // Security hint
                        doc.setFontSize(5);
                        doc.setFont(undefined, 'italic');
                        doc.setTextColor(100, 100, 100);
                        doc.text('(Beim 1. Login √§ndern)', qrX + (qrSize / 2), pwY + 11, { align: 'center' });

                        // üÜï FIX #4: Passwort nicht mehr loggen (Security) - 2025-11-15
                        // console.log('   ‚úÖ Passwort im PDF angezeigt (L√§nge:', data.partnerPassword?.length || 0, 'Zeichen)');
                    } else {
                        // console.log('   ‚úÖ BESTANDSKUNDE ‚Üí Kein Passwort im PDF');
                    }

                    // Reset text color
                    doc.setTextColor(0, 0, 0);
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(11);

                    // console.log('‚úÖ QR-Code erfolgreich neben Unterschrift platziert');

                } catch (qrError) {
                    console.error('‚ùå QR-Code Generierung fehlgeschlagen:', qrError);
                }
            } else {
                // console.log('‚è≠Ô∏è Kein QR-Code URL ‚Üí √úbersprungen');
            }

            const filename = `Annahme_${data.kennzeichen.replace(/\s/g, '_')}_${data.datum.replace(/\./g, '')}.pdf`;
            doc.save(filename);

            // Return PDF Blob for Firebase Storage upload
            return doc.output('blob');
        }

        // ============================================
        // ENTWURF-PDF ERSTELLEN (Excel-Style - FIX: Nov 21, 2025)
        // Pattern: annahme.html Lines 6518-6710 (Excel-Style Tables)
        // ============================================
        async function erstelleEntwurfPDF(entwurfData, qrCodeUrl) {
            // console.log('üìÑ Erstelle Entwurf-PDF mit Excel-Style Layout...');

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Load Settings
            const settings = window.settingsManager ? await window.settingsManager.loadSettings() : null;
            const werkstattName = settings?.profil?.name || 'Auto-Lackierzentrum Mosbach';
            const logoUrl = settings?.profil?.logoUrl || null;

            // üé® HEADER (Professional style - optimierte Farben)
            doc.setFillColor(30, 58, 95);  // Dunkelblau (weniger ges√§ttigt)
            doc.rect(0, 0, 210, 50, 'F');

            // Logo laden (falls vorhanden) - mit korrektem Seitenverh√§ltnis
            let logoLoaded = false;
            let logoWidth = 0;
            if (logoUrl) {
                try {
                    const logoData = await new Promise((resolve, reject) => {
                        const img = new Image();
                        img.crossOrigin = 'Anonymous';
                        const timeout = setTimeout(() => reject(new Error('Logo timeout')), 3000);
                        img.onload = () => {
                            clearTimeout(timeout);
                            const canvas = document.createElement('canvas');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0);
                            resolve({
                                base64: canvas.toDataURL('image/png'),
                                width: img.width,
                                height: img.height
                            });
                        };
                        img.onerror = () => { clearTimeout(timeout); reject(new Error('Logo error')); };
                        img.src = logoUrl;
                    });

                    // Proportionale Skalierung - max 32mm H√∂he im Header
                    const maxHeight = 32;
                    const aspectRatio = logoData.width / logoData.height;
                    const scaledHeight = maxHeight;
                    const scaledWidth = scaledHeight * aspectRatio;
                    logoWidth = scaledWidth;

                    doc.addImage(logoData.base64, 'PNG', 12, 9, scaledWidth, scaledHeight);
                    logoLoaded = true;
                    // console.log('‚úÖ Logo in PDF eingef√ºgt (proportional skaliert)');
                } catch (e) {
                    console.warn('‚ö†Ô∏è Logo konnte nicht geladen werden:', e.message);
                }
            }

            // Text-Position basierend auf Logo-Breite berechnen
            const textStartX = logoLoaded ? (12 + logoWidth + 8) : 105;
            const textAlign = logoLoaded ? 'left' : 'center';

            doc.setTextColor(255, 255, 255);
            doc.setFontSize(22);
            doc.setFont(undefined, 'bold');
            doc.text('Fahrzeug-Annahme', textStartX, 20, { align: textAlign });

            // ENTWURF Badge - eleganter gestaltet
            const badgeX = logoLoaded ? textStartX : 80;
            doc.setFillColor(255, 193, 7);  // Gelb/Orange f√ºr Entwurf
            doc.roundedRect(badgeX, 24, 40, 8, 2, 2, 'F');
            doc.setTextColor(50, 50, 50);
            doc.setFontSize(9);
            doc.setFont(undefined, 'bold');
            doc.text('ENTWURF', badgeX + 20, 29.5, { align: 'center' });

            doc.setTextColor(180, 195, 215);  // Dezentes Grau f√ºr Werkstatt-Name
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(werkstattName, textStartX, 40, { align: textAlign });

            // Akzent-Linie unten
            doc.setFillColor(76, 175, 80);  // Gr√ºner Akzent
            doc.rect(0, 48, 210, 2, 'F');

            // üé® EXCEL-STYLE KUNDENDATEN TABLE
            doc.setTextColor(0, 0, 0);
            let y = 55;  // Nach Header + Akzent-Linie

            doc.autoTable({
                startY: y,
                head: [['KUNDENDATEN', '']],
                body: [
                    ['Kennzeichen', entwurfData.kennzeichen],
                    ['Kundenname', entwurfData.kundenname],
                    ['Email', entwurfData.kundenEmail || 'Nicht angegeben'],
                    ['Telefon', entwurfData.telefon || 'Nicht angegeben']
                ],
                theme: 'grid',
                headStyles: {
                    fillColor: [30, 58, 95],  // Passend zum Header
                    textColor: 255,
                    fontStyle: 'bold',
                    fontSize: 11
                },
                bodyStyles: { fontSize: 10 },
                alternateRowStyles: { fillColor: [245, 247, 250] },  // Leichtes Grau f√ºr Zebra
                columnStyles: {
                    0: { fontStyle: 'bold', cellWidth: 50, textColor: [60, 60, 60] },
                    1: { cellWidth: 130 }
                },
                margin: { left: 15, right: 15 }
            });

            // üé® EXCEL-STYLE FAHRZEUGDATEN TABLE
            y = doc.lastAutoTable.finalY + 8;

            doc.autoTable({
                startY: y,
                head: [['FAHRZEUGDATEN', '']],
                body: [
                    ['Marke / Modell', `${entwurfData.marke || 'Nicht angegeben'} ${entwurfData.modell || ''}`],
                    ['Baujahr', entwurfData.baujahrVon || 'Nicht angegeben'],
                    ['KM-Stand', entwurfData.kmstand ? `${entwurfData.kmstand} km` : 'Nicht angegeben'],
                    ['VIN/FIN', entwurfData.vin || 'Nicht angegeben']
                ],
                theme: 'grid',
                headStyles: {
                    fillColor: [30, 58, 95],  // Passend zum Header
                    textColor: 255,
                    fontStyle: 'bold',
                    fontSize: 11
                },
                bodyStyles: { fontSize: 10 },
                alternateRowStyles: { fillColor: [245, 247, 250] },  // Leichtes Grau f√ºr Zebra
                columnStyles: {
                    0: { fontStyle: 'bold', cellWidth: 50, textColor: [60, 60, 60] },
                    1: { cellWidth: 130 }
                },
                margin: { left: 15, right: 15 }
            });

            // üé® EXCEL-STYLE SERVICES TABLE (Multi-Service Support)
            y = doc.lastAutoTable.finalY + 5;

            const serviceIcons = {
                'lackierung': '[LACK]', 'lackier': '[LACK]', 'reifen': '[REIF]',
                'glas': '[GLAS]', 'klima': '[KLIM]', 'dellen': '[DELL]',
                'mechanik': '[MECH]', 'versicherung': '[VERS]', 'pflege': '[PFLG]',
                'tuev': '[TUEV]', 'alle': '[ALL]', 'folierung': '[FOLI]',
                'steinschutz': '[STEIN]', 'werbebeklebung': '[WERB]'
            };
            const serviceLabels = {
                'lackierung': 'LACKIERUNG', 'lackier': 'LACKIERUNG', 'reifen': 'REIFEN-SERVICE',
                'glas': 'GLAS-REPARATUR', 'klima': 'KLIMA-SERVICE', 'dellen': 'DELLEN-REPARATUR',
                'mechanik': 'MECHANIK-SERVICE', 'versicherung': 'VERSICHERUNGS-SCHADEN',
                'pflege': 'FAHRZEUG-PFLEGE', 'tuev': 'T√úV/AU-PR√úFUNG', 'alle': 'ALLE SERVICES',
                'folierung': 'AUTO-FOLIERUNG', 'steinschutz': 'STEINSCHUTZFOLIE',
                'werbebeklebung': 'FAHRZEUGBESCHRIFTUNG'
            };

            const serviceRows = [];
            // Handle Multi-Service Array (Bug #3 Fix pattern)
            if (Array.isArray(entwurfData.serviceTyp)) {
                entwurfData.serviceTyp.forEach(service => {
                    const icon = serviceIcons[service] || '[?]';
                    const label = serviceLabels[service] || 'SERVICE';
                    serviceRows.push([icon, label]);
                });
            } else {
                // Fallback for old format
                const icon = serviceIcons[entwurfData.serviceTyp] || '[?]';
                const label = serviceLabels[entwurfData.serviceTyp] || 'SERVICE';
                serviceRows.push([icon, label]);
            }

            doc.autoTable({
                startY: y + 3,
                head: [['SERVICE', 'BESCHREIBUNG']],
                body: serviceRows,
                theme: 'grid',
                headStyles: {
                    fillColor: [30, 58, 95],  // Passend zum Header
                    textColor: 255,
                    fontStyle: 'bold',
                    fontSize: 11
                },
                bodyStyles: { fontSize: 10 },
                alternateRowStyles: { fillColor: [245, 247, 250] },
                columnStyles: {
                    0: { fontStyle: 'bold', cellWidth: 30, halign: 'center', textColor: [76, 175, 80] },  // Gr√ºner Akzent
                    1: { cellWidth: 150 }
                },
                margin: { left: 15, right: 15 }
            });

            y = doc.lastAutoTable.finalY + 15;

            // üî≤ QR-CODE SECTION
            if (qrCodeUrl) {
                try {
                    // console.log('üî≤ Generiere QR-Code f√ºr Partner-Login...');

                    // Safety check: Verify QRious loaded
                    if (typeof QRious === 'undefined') {
                        throw new Error('QRious library not loaded');
                    }

                    // Generate QR Code Canvas with QRious
                    const qrCanvas = document.createElement('canvas');
                    new QRious({
                        element: qrCanvas,
                        value: qrCodeUrl,
                        size: 300,
                        background: '#FFFFFF',
                        foreground: '#1E3A5F',  // Passend zum PDF Header
                        padding: 4,
                        backgroundAlpha: 1,
                        foregroundAlpha: 1,
                        level: 'H'               // High error correction (30%)
                    });

                    // Convert canvas to image data URL
                    const qrImageData = qrCanvas.toDataURL('image/png');

                    // Position QR Code (centered, large)
                    y += 20;
                    if (y > 230) {
                        doc.addPage();
                        y = 30;
                    }

                    const qrX = 105;  // Centered
                    const qrY = y;
                    const qrSize = 60;

                    // Light background box mit Schatten-Effekt
                    doc.setFillColor(248, 250, 252);
                    doc.roundedRect(qrX - (qrSize / 2) - 10, qrY - 15, qrSize + 20, qrSize + 35, 4, 4, 'F');

                    // "PARTNER-PORTAL" Label above QR
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(30, 58, 95);  // Passend zum Header
                    doc.text('PARTNER-PORTAL ZUGANG', qrX, qrY - 5, { align: 'center' });

                    // Add QR Code image (centered)
                    doc.addImage(qrImageData, 'PNG', qrX - (qrSize / 2), qrY, qrSize, qrSize);

                    // Border around QR code
                    doc.setDrawColor(30, 58, 95);
                    doc.setLineWidth(0.5);
                    doc.rect(qrX - (qrSize / 2), qrY, qrSize, qrSize);

                    // Instruction below QR code
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(80, 80, 80);
                    doc.text('QR-Code scannen f√ºr Partner-Login', qrX, qrY + qrSize + 8, { align: 'center' });

                    // URL below (kleinere Schrift)
                    doc.setFontSize(7);
                    doc.text(qrCodeUrl, qrX, qrY + qrSize + 13, { align: 'center' });

                    // console.log('‚úÖ QR-Code erfolgreich im Entwurf-PDF platziert');

                    // FIX: Nov 21, 2025 - Update Y position to prevent overlap with password section
                    y = qrY + qrSize + 20;  // QR height (60mm) + spacing for text below

                } catch (qrError) {
                    console.error('‚ùå QR-Code Generierung fehlgeschlagen:', qrError);
                    // Continue without QR code
                }
            }

            // üîë PASSWORD SECTION (for new partners only - FIX: Nov 21, 2025)
            if (entwurfData.isNewPartner && entwurfData.partnerPassword) {
                // FIX: Nov 21, 2025 - Conditional spacing based on QR code presence
                y += qrCodeUrl ? 10 : 25;  // Smaller gap if QR present (Y already updated), larger if not

                if (y > 230) {
                    doc.addPage();
                    y = 30;
                }

                const pwX = 105;  // Centered
                const pwWidth = 80;  // Box width

                // Yellow highlight box
                doc.setFillColor(255, 255, 200);
                doc.roundedRect(pwX - (pwWidth / 2), y - 5, pwWidth, 28, 3, 3, 'F');

                // Password label
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('[PWD] AKTUELLES PASSWORT:', pwX, y, { align: 'center' });

                // Password value (red)
                doc.setFontSize(12);
                doc.setTextColor(200, 0, 0);
                doc.text(entwurfData.partnerPassword, pwX, y + 7, { align: 'center' });

                // Warning
                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                doc.text('(!) Passwort muss beim ersten Login ge√§ndert werden', pwX, y + 14, { align: 'center' });

                y += 25;  // Update y for footer

                // console.log('‚úÖ Passwort erfolgreich im Entwurf-PDF platziert');
            }

            // üìå FOOTER
            doc.setFontSize(8);
            doc.setTextColor(120, 130, 140);
            doc.text(`Erstellt am: ${new Date().toLocaleDateString('de-DE')} ${new Date().toLocaleTimeString('de-DE')}`, 105, 280, { align: 'center' });
            doc.setTextColor(200, 120, 60);  // Orange/Warnung f√ºr Entwurf-Hinweis
            doc.text('Dies ist ein ENTWURF - noch keine finale Annahme', 105, 285, { align: 'center' });

            // Download PDF
            const filename = `Entwurf_${entwurfData.kennzeichen.replace(/\s/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(filename);

            // console.log('‚úÖ Entwurf-PDF erfolgreich erstellt:', filename);
            return doc.output('blob');
        }

        // Arbeitsauftrag erstellen
        async function createArbeitsauftrag() {
            const serviceTyp = document.getElementById('serviceTyp').value;

            // Grundvalidierung
            if (!document.getElementById('kennzeichen').value || !document.getElementById('marke').value) {
                showToast('Bitte mindestens Kennzeichen und Marke eingeben!', 'error');
                return;
            }

            // Farbnummer nur bei Lackierung & Alle Services pr√ºfen
            if ((serviceTyp === 'lackier' || serviceTyp === 'alle') && !document.getElementById('farbnummer').value) {
                showToast('Bitte Farbnummer f√ºr Lackierung/Arbeitsauftrag eingeben!', 'error');
                return;
            }

            const data = getFormData();

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFillColor(255, 193, 7);
            doc.rect(0, 0, 210, 50, 'F');
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(28);
            doc.setFont(undefined, 'bold');
            doc.text('ARBEITSAUFTRAG', 105, 25, { align: 'center' });
            doc.setFontSize(14);
            doc.text('Lackierwerkstatt', 105, 38, { align: 'center' });

            let y = 70;

            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text('Kennzeichen:', 20, y);
            doc.setFontSize(32);
            doc.text(data.kennzeichen, 105, y, { align: 'center' });

            y += 20;
            doc.setFontSize(18);
            doc.text('Fahrzeug:', 20, y);
            doc.setFont(undefined, 'normal');
            doc.text(`${data.marke} ${data.modell}`, 70, y);

            y += 25;
            doc.setFillColor(255, 243, 205);
            doc.rect(15, y - 10, 140, 30, 'F');
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(199, 37, 78);
            doc.text('[!] FARBNUMMER:', 20, y);
            doc.setFontSize(36);
            doc.text(data.farbnummer, 105, y + 5, { align: 'center' });

            y += 25;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(16);
            doc.text('Lackart:', 20, y);
            doc.setFont(undefined, 'normal');
            doc.text(data.lackart, 70, y);

            if (data.farbname) {
                y += 10;
                doc.setFont(undefined, 'bold');
                doc.text('Farbname:', 20, y);
                doc.setFont(undefined, 'normal');
                doc.text(data.farbname, 70, y);
            }

            if (data.farbvariante) {
                y += 10;
                doc.setFont(undefined, 'bold');
                doc.text('Farbvariante:', 20, y);
                doc.setFont(undefined, 'normal');
                doc.text(data.farbvariante, 70, y);
            }

            if (data.notizen) {
                y += 20;
                doc.setFont(undefined, 'bold');
                doc.setFontSize(14);
                doc.text('Schadensbeschreibung:', 20, y);
                y += 8;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(12);
                const notizen = doc.splitTextToSize(data.notizen, 170);
                doc.text(notizen, 20, y);
            }

            doc.setFontSize(10);
            doc.setTextColor(150, 150, 150);
            doc.text('Auto-Lackierzentrum Mosbach', 105, 280, { align: 'center' });
            doc.text(data.datum, 105, 285, { align: 'center' });

            const filename = `Arbeitsauftrag_${data.kennzeichen.replace(/\s/g, '_')}.pdf`;
            doc.save(filename);
        }
    </script>

    <!-- Error Handler & Storage Monitor -->
    <script src="error-handler.js"></script>
    <script src="storage-monitor.js"></script>

    <!-- Theme Toggle System -->
    <script>
        // ============================================
        // üåì THEME TOGGLE SYSTEM (mit Feather Icons Stroke-Width Update)
        // ============================================

        (function initThemeToggle() {
            const themeToggle = document.getElementById('themeToggle');
            const html = document.documentElement;

            // Update Feather Icons stroke-width based on theme
            function updateFeatherIcons(theme) {
                const strokeWidth = theme === 'light' ? '2.5' : '2';
                document.querySelectorAll('i[data-feather]').forEach(icon => {
                    const svg = icon.querySelector('svg');
                    if (svg) {
                        svg.querySelectorAll('*[stroke]').forEach(element => {
                            element.setAttribute('stroke-width', strokeWidth);
                        });
                    }
                });
            }

            // Load theme from localStorage (default: dark)
            let currentTheme = localStorage.getItem('theme') || 'dark';
            html.setAttribute('data-theme', currentTheme);

            // Theme toggle on button click
            if (themeToggle) {
                const themeToggleHandler = () => {
                    currentTheme = currentTheme === 'light' ? 'dark' : 'light';
                    html.setAttribute('data-theme', currentTheme);
                    localStorage.setItem('theme', currentTheme);

                    // Re-initialize Feather Icons with updated stroke-width
                    if (typeof feather !== 'undefined') {
                        feather.replace();
                        setTimeout(() => updateFeatherIcons(currentTheme), 50);
                    }

                    // console.log(`‚úÖ Theme switched to: ${currentTheme}`);
                };
                window.listenerRegistry.registerDOM(themeToggle, 'click', themeToggleHandler, 'Theme Toggle Button');
            }

            // Initialize Feather Icons on load with correct stroke-width
            if (typeof feather !== 'undefined') {
                feather.replace();
                setTimeout(() => updateFeatherIcons(currentTheme), 50);
            }

            // console.log(`üåì Theme loaded: ${currentTheme}`);
        })();
    </script>

    <!-- KI-Chat-Assistent -->
    <div id="aiChatWidget"></div>
    <!-- üöÄ PERF: AI Tools deferred -->
    <script src="js/ai-agent-tools.js" defer></script>
    <script src="js/ai-agent-engine.js" defer></script>
    <script src="js/ai-chat-widget.js"></script>
    <script src="js/quota-display.js"></script>

    <!-- ============================================
         SERVICE WORKER REGISTRATION - Offline-Funktionalit√§t
         ============================================ -->
    <script>
        // ============================================
        // PDF-UPLOAD EVENT LISTENER
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            const pdfInput = document.getElementById('datPdfInput');
            if (pdfInput) {
                pdfInput.addEventListener('change', handlePdfUpload);
            }
        });

        // Service Worker nur registrieren wenn:
        // 1. Browser unterst√ºtzt Service Worker
        // 2. NICHT in Playwright Tests (navigator.webdriver)
        // 3. NICHT auf Emulator-Port (8000)
        if ('serviceWorker' in navigator && !navigator.webdriver && window.location.port !== '8000') {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('./sw.js', {
                        scope: './'
                    });

                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            // Update ready - could notify user here
                        });
                    });

                } catch (error) {
                    console.error('[SW] Registrierung fehlgeschlagen:', error);
                }
            });
        }
    </script>

    <!-- ============================================
         üé® UX REDESIGN PHASE 1-5 JavaScript
         3D Tilt, Ripple, Scroll Animations
         ============================================ -->
    <script>
        // ============================================
        // PHASE 2: 3D TILT EFFECT (Mouse-based)
        // ============================================
        function init3DTiltEffect() {
            const checkboxCards = document.querySelectorAll('.checkbox-card');
            const maxTilt = 8;

            checkboxCards.forEach(card => {
                const tiltHandler = function(e) {
                    const rect = card.getBoundingClientRect();
                    const centerX = rect.left + rect.width / 2;
                    const centerY = rect.top + rect.height / 2;
                    const percentX = (e.clientX - centerX) / (rect.width / 2);
                    const percentY = (e.clientY - centerY) / (rect.height / 2);
                    const rotateX = -percentY * maxTilt;
                    const rotateY = percentX * maxTilt;

                    card.classList.add('tilt-active');
                    card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) translateY(-2px)`;
                };

                const resetTiltHandler = function() {
                    card.classList.remove('tilt-active');
                    card.style.transform = 'perspective(1000px) rotateX(0deg) rotateY(0deg) translateY(0)';
                };

                if (window.listenerRegistry?.registerDOM) {
                    window.listenerRegistry.registerDOM(card, 'mousemove', tiltHandler, '3D Tilt Handler');
                    window.listenerRegistry.registerDOM(card, 'mouseleave', resetTiltHandler, '3D Tilt Reset');
                } else {
                    card.addEventListener('mousemove', tiltHandler);
                    card.addEventListener('mouseleave', resetTiltHandler);
                }
            });
        }

        // ============================================
        // PHASE 2: RIPPLE EFFECT (Click-based)
        // ============================================
        function initRippleEffect() {
            const rippleElements = document.querySelectorAll('.btn, .btn-primary, .btn-secondary');

            rippleElements.forEach(element => {
                element.classList.add('ripple-container');

                const rippleClickHandler = function(e) {
                    const ripple = document.createElement('span');
                    ripple.classList.add('ripple');
                    const rect = element.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    const size = Math.max(rect.width, rect.height) * 2;
                    ripple.style.width = ripple.style.height = size + 'px';
                    ripple.style.left = x - size / 2 + 'px';
                    ripple.style.top = y - size / 2 + 'px';
                    element.appendChild(ripple);
                    setTimeout(() => ripple.remove(), 600);
                };

                if (window.listenerRegistry?.registerDOM) {
                    window.listenerRegistry.registerDOM(element, 'click', rippleClickHandler, 'Ripple Effect');
                } else {
                    element.addEventListener('click', rippleClickHandler);
                }
            });
        }

        // ============================================
        // PHASE 5: SCROLL ANIMATIONS (Intersection Observer)
        // ============================================
        function initScrollAnimations() {
            if (!('IntersectionObserver' in window)) return;

            const animatableElements = document.querySelectorAll('.form-section, .checkbox-grid, .photo-grid');
            animatableElements.forEach(el => el.classList.add('scroll-animate'));

            const observerOptions = {
                root: null,
                rootMargin: '0px 0px -50px 0px',
                threshold: 0.1
            };

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('is-visible');
                        observer.unobserve(entry.target);
                    }
                });
            }, observerOptions);

            animatableElements.forEach(el => observer.observe(el));
        }

        // ============================================
        // PHASE 1: GSAP Entry Animations
        // ============================================
        function initGSAPAnimations() {
            if (typeof gsap === 'undefined') {
                console.warn('‚ö†Ô∏è GSAP not loaded - entry animations disabled');
                return;
            }

            // Fade-in body
            gsap.fromTo("body",
                { opacity: 0 },
                { opacity: 1, duration: 0.5, ease: "power2.out" }
            );

            // Page header entrance
            gsap.fromTo(".page-header",
                { opacity: 0, y: 20, scale: 0.98 },
                { opacity: 1, y: 0, scale: 1, duration: 0.6, delay: 0.1, ease: "back.out(1.2)" }
            );

            // Form container entrance
            gsap.fromTo(".form-container",
                { opacity: 0, y: 30 },
                { opacity: 1, y: 0, duration: 0.7, delay: 0.3, ease: "power2.out" }
            );

            // Stagger checkbox cards
            gsap.fromTo(".checkbox-card",
                { opacity: 0, scale: 0.9, y: 15 },
                { opacity: 1, scale: 1, y: 0, duration: 0.4, stagger: 0.05, delay: 0.5, ease: "back.out(1.4)" }
            );
        }

        // ============================================
        // Initialize all UX Features on DOMContentLoaded
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            initGSAPAnimations();
            init3DTiltEffect();
            initRippleEffect();
            initScrollAnimations();
        });
    </script>
</body>
</html>
