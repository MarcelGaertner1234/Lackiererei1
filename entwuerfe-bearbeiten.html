<!DOCTYPE html>
<!-- CACHE BUSTER: v2025-11-17-storage-migration -->
<html lang="de">
<head>
    <!-- üåì FOUC Prevention: Load Theme BEFORE CSS to prevent flash -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>

    <script>
        /// <reference path="js/types.js" />
        // window.werkstattId is set automatically after successful login
        // This ensures proper multi-tenant data isolation
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entw√ºrfe Bearbeiten | Auto-Lackierzentrum Mosbach</title>

    <!-- Aggressive No-Cache Headers -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- Design System -->
    <link rel="stylesheet" href="design-system.css?v=af6b90f">
    <link rel="stylesheet" href="components.css?v=af6b90f">
    <link rel="stylesheet" href="animations.css?v=af6b90f">
    <link rel="stylesheet" href="mobile-first.css?v=af6b90f">

    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Feather Icons -->
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>

    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- PDF.js for PDF Parsing -->
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>

    <!-- QRious - Browser-optimized QR Code Generator -->
    <script src="./libs/qrious.min.js"></script>

    <!-- Firebase SDK (Compat Mode) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

    <!-- Listener Registry - Memory Leak Prevention (defines safeNavigate) -->
    <script src="listener-registry.js"></script>

    <style>
        body {
            background: var(--color-background);
            min-height: 100vh;
            padding: var(--space-6) var(--space-4) 100px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        /* Page Header */
        .page-header {
            text-align: center;
            margin-bottom: var(--space-8);
            padding: var(--space-8) var(--space-6);
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
        }

        .page-header h1 {
            font-size: clamp(24px, 5vw, 36px);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin-bottom: var(--space-2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-3);
        }

        .page-header p {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
        }

        /* Draft Selector */
        .draft-selector {
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            padding: var(--space-8);
            margin-bottom: var(--space-6);
        }

        .draft-selector h2 {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin-bottom: var(--space-4);
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        /* Form Container */
        .form-container {
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            padding: var(--space-8);
            display: none; /* Hidden until draft selected */
        }

        .form-container.visible {
            display: block;
        }

        /* Section Title */
        .section-title {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin: var(--space-8) 0 var(--space-6) 0;
            padding-bottom: var(--space-3);
            border-bottom: 1px solid var(--color-border);
        }

        .section-title:first-child {
            margin-top: 0;
        }

        .section-title i {
            width: 24px;
            height: 24px;
            color: var(--color-primary);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: var(--space-12) var(--space-4);
            color: var(--color-text-secondary);
        }

        .empty-state i {
            width: 64px;
            height: 64px;
            margin-bottom: var(--space-4);
            opacity: 0.3;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: var(--space-4);
            margin-top: var(--space-8);
            flex-wrap: wrap;
        }

        .action-buttons .btn {
            flex: 1;
            min-width: 200px;
        }

        /* Loading Indicator */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Success Message */
        .success-message {
            display: none;
            background: var(--color-success);
            color: white;
            padding: var(--space-4) var(--space-6);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-6);
            text-align: center;
            font-weight: var(--font-weight-medium);
            box-shadow: var(--shadow-md);
        }

        .success-message.show {
            display: block;
            animation: slideInDown 0.3s ease-out;
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Required Asterisk */
        .required {
            color: var(--color-error);
        }

        /* Photo Grid */
        .photo-section {
            margin: var(--space-6) 0;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: var(--space-4);
            margin-top: var(--space-4);
        }

        .photo-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: var(--radius-lg);
            overflow: hidden;
            background: var(--color-bg-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .photo-item:hover {
            transform: scale(1.02);
            box-shadow: var(--shadow-md);
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-item.empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px dashed var(--color-border);
            gap: var(--space-2);
        }

        .photo-item.empty i {
            width: 32px;
            height: 32px;
            opacity: 0.5;
        }

        .photo-item.empty span {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
        }

        .remove-photo {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(244, 67, 54, 0.9);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .photo-item:hover .remove-photo {
            opacity: 1;
        }

        /* Signature Canvas */
        .signature-section {
            margin: var(--space-6) 0;
        }

        #signatureCanvas {
            width: 100%;
            max-width: 800px;
            height: 400px;  /* FIX: Match canvas height attribute to prevent scaling issues */
            display: block;  /* üÜï BUGFIX 2025-11-18: Ensure block layout (not inline) for proper dimensions */
            border: 2px solid var(--color-border);
            border-radius: var(--radius-lg);
            background: rgba(255, 255, 255, 0.03);  /* FIX: Theme-aware background (Nov 21, 2025) - adapts to light/dark mode */
            cursor: crosshair;
            touch-action: none;
        }

        .signature-buttons {
            display: flex;
            gap: var(--space-3);
            margin-top: var(--space-3);
        }

        /* üåì THEME TOGGLE */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid var(--color-border);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .theme-toggle:hover { transform: scale(1.05); background: rgba(255, 255, 255, 0.15); }
        .theme-toggle__icon { width: 20px; height: 20px; color: var(--color-text-primary); }
        .theme-toggle__icon--light { display: none; }
        [data-theme="light"] .theme-toggle__icon--light { display: block; }
        [data-theme="light"] .theme-toggle__icon--dark { display: none; }
        [data-theme="light"] .theme-toggle { background: rgba(255,255,255,0.8); border-color: rgba(0,0,0,0.1); }
        /* üîô ZUR√úCK-BUTTON (Fixed Position) */
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--color-border, rgba(255,255,255,0.1));
            border-radius: 8px;
            color: var(--color-text-primary, #e0e0e0);
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .back-button:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(-2px);
        }
        [data-theme="light"] .back-button {
            background: rgba(255, 255, 255, 0.8);
            border-color: rgba(0, 0, 0, 0.1);
            color: #1a1a2e;
        }
        @media (max-width: 768px) {
            .back-button { top: 10px; left: 10px; padding: 8px; }
            .back-button span { display: none; }
        }

        /* üì± MOBILE RESPONSIVE - Additional Rules */
        @media (max-width: 768px) {
            .container, .form-container, .main-content, main {
                padding: 15px;
                margin: 10px;
            }
            h1, .page-title {
                font-size: 1.5rem;
            }
            .btn, button {
                padding: 12px 20px;
                font-size: 14px;
            }
            .theme-toggle {
                top: 10px;
                right: 10px;
                width: 40px;
                height: 40px;
            }
        }

        @media (max-width: 480px) {
            body {
                font-size: 14px;
            }
            .container, .form-container, .main-content, main {
                padding: 10px;
                margin: 5px;
            }
            h1, .page-title {
                font-size: 1.3rem;
            }
            input, select, textarea {
                font-size: 16px; /* Prevents iOS zoom on focus */
            }
        }
    </style>
</head>
<body>
    <!-- üîô ZUR√úCK-BUTTON -->
    <button class="back-button" onclick="history.back()" title="Zur√ºck">
        <i data-feather="arrow-left"></i>
        <span>Zur√ºck</span>
    </button>
    <!-- üåì THEME TOGGLE -->
    <button id="themeToggle" class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle Theme">
        <i data-feather="sun" class="theme-toggle__icon theme-toggle__icon--light"></i>
        <i data-feather="moon" class="theme-toggle__icon theme-toggle__icon--dark"></i>
    </button>

    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1>
                <i data-feather="edit"></i>
                Entw√ºrfe Bearbeiten
            </h1>
            <p>Vervollst√§ndigen Sie offene Entw√ºrfe und erstellen Sie Angebote</p>
        </div>

        <!-- Success Message -->
        <div class="success-message" id="successMessage">
            ‚úÖ Angebot erfolgreich versendet!
        </div>

        <!-- Draft Selector -->
        <div class="draft-selector">
            <h2>
                <i data-feather="file-text"></i>
                Entwurf ausw√§hlen
            </h2>

            <div class="form-group">
                <label for="entwurfDropdown" class="form-label">Offene Entw√ºrfe <span class="required">*</span></label>
                <select id="entwurfDropdown" class="form-select" onchange="loadEntwurf()">
                    <option value="">-- Bitte w√§hlen --</option>
                </select>
                <small style="color: var(--color-text-tertiary); display: block; margin-top: var(--space-2);">
                    üí° W√§hlen Sie einen Entwurf, um ihn zu vervollst√§ndigen und ein Angebot zu erstellen
                </small>
            </div>

            <!-- Empty State (shown when no drafts) -->
            <div id="emptyState" class="empty-state" style="display: none;">
                <i data-feather="inbox"></i>
                <h3>Keine offenen Entw√ºrfe</h3>
                <p>Es gibt aktuell keine Entw√ºrfe, die bearbeitet werden m√ºssen.</p>
            </div>
        </div>

        <!-- Form Container (Hidden until draft selected) -->
        <div class="form-container" id="formContainer">
            <form id="entwurfForm">
                <!-- KUNDENDATEN -->
                <div class="section-title">
                    <i data-feather="user"></i>
                    Kundendaten
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="kennzeichen" class="form-label">Kennzeichen <span class="required">*</span></label>
                        <input type="text" id="kennzeichen" class="form-input" placeholder="z.B. MOS-CG 123" required readonly style="background: var(--color-bg-secondary);">
                    </div>

                    <div class="form-group">
                        <label for="kundenname" class="form-label">Kundenname <span class="required">*</span></label>
                        <input type="text" id="kundenname" class="form-input" placeholder="z.B. Max Mustermann" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="kundenEmail" class="form-label">Kunden-Email <span class="required">*</span></label>
                        <input type="email" id="kundenEmail" class="form-input" placeholder="z.B. kunde@example.com" required>
                        <small style="color: var(--color-text-tertiary);">
                            üìß Angebot wird an diese Email versendet
                        </small>
                    </div>

                    <div class="form-group">
                        <label for="telefon" class="form-label">Telefonnummer</label>
                        <input type="tel" id="telefon" class="form-input" placeholder="z.B. +49 6261 123456">
                    </div>
                </div>

                <!-- FAHRZEUGDATEN -->
                <div class="section-title">
                    <i data-feather="truck"></i>
                    Fahrzeugdaten
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="marke" class="form-label">Marke <span class="required">*</span></label>
                        <input type="text" id="marke" class="form-input" placeholder="z.B. VW, BMW, Mercedes" required>
                    </div>

                    <div class="form-group">
                        <label for="modell" class="form-label">Modell <span class="required">*</span></label>
                        <input type="text" id="modell" class="form-input" placeholder="z.B. Golf, 3er, C-Klasse" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="baujahrVon" class="form-label">Baujahr</label>
                        <input type="text" id="baujahrVon" class="form-input" placeholder="z.B. 2018">
                    </div>

                    <div class="form-group">
                        <label for="kmstand" class="form-label">KM-Stand</label>
                        <input type="text" id="kmstand" class="form-input" placeholder="z.B. 45.000">
                    </div>
                </div>

                <div class="form-group">
                    <label for="vin" class="form-label">Fahrgestellnummer (VIN)</label>
                    <input type="text" id="vin" class="form-input" placeholder="z.B. WVWZZZ1KZBW123456">
                </div>

                <!-- ERSATZFAHRZEUG -->
                <div class="section-title">
                    <i data-feather="refresh-cw"></i>
                    Ersatzfahrzeug
                </div>

                <div class="form-group">
                    <label class="checkbox-label" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="ersatzfahrzeugGewuenscht" name="ersatzfahrzeugGewuenscht" style="width: 18px; height: 18px;">
                        <span>Kunde ben√∂tigt Ersatzfahrzeug</span>
                    </label>
                </div>

                <div class="form-group" id="ersatzfahrzeugZuweisungGroup" style="display: none;">
                    <label for="zugewiesenesErsatzfahrzeug" class="form-label">Ersatzfahrzeug zuweisen</label>
                    <select id="zugewiesenesErsatzfahrzeug" class="form-input" style="cursor: pointer;">
                        <option value="">-- Kein Fahrzeug zugewiesen --</option>
                        <!-- Dynamisch gef√ºllt aus leihfahrzeuge Collection -->
                    </select>
                </div>

                <!-- SERVICE-DETAILS -->
                <div class="section-title">
                    <i data-feather="tool"></i>
                    Service-Details
                </div>

                <div class="form-group">
                    <label class="form-label">Service-Typ <span class="required">*</span></label>
                    <div id="serviceTypDisplay" class="form-input" style="background: var(--color-bg-secondary); cursor: not-allowed; padding: 10px; border-radius: 8px; border: 1px solid var(--color-border);">
                        <!-- Will be filled by JavaScript (supports multi-service display) -->
                    </div>
                    <small style="color: var(--color-text-tertiary); margin-top: 4px; display: block;">
                        ‚ö†Ô∏è Service-Typ kann hier nicht ge√§ndert werden (vom Meister beim Entwurf festgelegt)
                    </small>
                </div>

                <!-- ========================================== -->
                <!-- SERVICE-DETAIL-FELDER (FIX: Nov 17, 2025)  -->
                <!-- Pattern 34: Service-Details Display        -->
                <!-- ========================================== -->

                <!-- Reifen-Service Felder -->
                <div id="reifen-felder" class="service-felder" style="display:none;">
                    <div class="section-title" style="margin-top: var(--space-4);">
                        <i data-feather="circle"></i>
                        Reifen-Service Details
                    </div>

                    <div class="form-group">
                        <label for="reifengroesse" class="form-label">Reifengr√∂√üe</label>
                        <input type="text" id="reifengroesse" class="form-input" placeholder="z.B. 205/55 R16 91V">
                        <small style="color: var(--color-text-tertiary);">Format: Breite/H√∂he Durchmesser Lastindex</small>
                    </div>

                    <div class="form-group">
                        <label for="reifentyp" class="form-label">Reifen-Typ</label>
                        <select id="reifentyp" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="sommer">Sommerreifen</option>
                            <option value="winter">Winterreifen</option>
                            <option value="ganzjahr">Ganzjahresreifen</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="reifenanzahl" class="form-label">Anzahl Reifen</label>
                        <input type="number" id="reifenanzahl" class="form-input" min="1" max="4" value="4">
                    </div>
                </div>

                <!-- Mechanik-Service Felder -->
                <div id="mechanik-felder" class="service-felder" style="display:none;">
                    <div class="section-title" style="margin-top: var(--space-4);">
                        <i data-feather="circle"></i>
                        Mechanik-Service Details
                    </div>

                    <div class="form-group">
                        <label for="mechanik-problem" class="form-label">Problembeschreibung</label>
                        <textarea id="mechanik-problem" class="form-input" rows="4" placeholder="z.B. Motor ruckelt, Bremsen quietschen, Lenkung schwerg√§ngig, Warnleuchte leuchtet..."></textarea>
                        <small style="color: var(--color-text-tertiary);">Bitte so detailliert wie m√∂glich beschreiben</small>
                    </div>

                    <div class="form-group">
                        <label for="mechanik-symptome" class="form-label">Symptome / Wann tritt das Problem auf?</label>
                        <input type="text" id="mechanik-symptome" class="form-input" placeholder="z.B. nur beim Kaltstart, bei hoher Geschwindigkeit, beim Bremsen">
                    </div>
                </div>

                <!-- Lackierung Felder -->
                <div id="lackier-felder" class="service-felder" style="display:none;">
                    <div class="section-title" style="margin-top: var(--space-4);">
                        <i data-feather="circle"></i>
                        Lackierung Details
                    </div>

                    <div class="form-group">
                        <label for="farbname" class="form-label">Farbname</label>
                        <input type="text" id="farbname" class="form-input" placeholder="z.B. Tiefschwarz, Brillantschwarz">
                    </div>

                    <div class="form-group">
                        <label for="farbvariante" class="form-label">Farbvariante</label>
                        <input type="text" id="farbvariante" class="form-input" placeholder="z.B. Metallic, Perleffekt, Uni">
                    </div>

                    <div class="form-group">
                        <label for="farbnummer" class="form-label">Farbnummer</label>
                        <input type="text" id="farbnummer" class="form-input" placeholder="z.B. L041, A2">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Lackart</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="lackart" value="basislack">
                                <span>Basislack</span>
                            </label>
                            <label>
                                <input type="radio" name="lackart" value="volllack">
                                <span>Volllack</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Glas-Reparatur Felder -->
                <div id="glas-felder" class="service-felder" style="display:none;">
                    <div class="section-title" style="margin-top: var(--space-4);">
                        <i data-feather="circle"></i>
                        Glas-Reparatur Details
                    </div>

                    <div class="form-group">
                        <label for="scheibentyp" class="form-label">Scheiben-Typ</label>
                        <select id="scheibentyp" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="frontscheibe">Frontscheibe</option>
                            <option value="seitenscheibe-vorne-links">Seitenscheibe vorne links</option>
                            <option value="seitenscheibe-vorne-rechts">Seitenscheibe vorne rechts</option>
                            <option value="seitenscheibe-hinten-links">Seitenscheibe hinten links</option>
                            <option value="seitenscheibe-hinten-rechts">Seitenscheibe hinten rechts</option>
                            <option value="heckscheibe">Heckscheibe</option>
                            <option value="schiebedach">Schiebedach</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="schadensgroesse" class="form-label">Schadens-Gr√∂√üe</label>
                        <select id="schadensgroesse" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="steinschlag">Steinschlag (< 2cm) - Reparatur m√∂glich</option>
                            <option value="riss-klein">Kleiner Riss (2-5cm) - Reparatur m√∂glich</option>
                            <option value="riss-mittel">Mittlerer Riss (5-10cm) - Austausch empfohlen</option>
                            <option value="riss-gross">Gro√üer Riss/Bruch (> 10cm) - Austausch n√∂tig</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="glasposition" class="form-label">Position des Schadens</label>
                        <input type="text" id="glasposition" class="form-input" placeholder="z.B. Fahrerseite Mitte, Beifahrerseite oben links">
                    </div>
                </div>

                <!-- Klima-Service Felder -->
                <div id="klima-felder" class="service-felder" style="display:none;">
                    <div class="section-title" style="margin-top: var(--space-4);">
                        <i data-feather="circle"></i>
                        Klima-Service Details
                    </div>

                    <div class="form-group">
                        <label for="klimaservice" class="form-label">Service-Art</label>
                        <select id="klimaservice" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="wartung">Wartung & Desinfektion</option>
                            <option value="fuellen">K√§ltemittel auff√ºllen</option>
                            <option value="reparatur">Reparatur (Leckage)</option>
                            <option value="komplett">Kompletter Service-Check</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="kaeltemittel" class="form-label">K√§ltemittel-Typ</label>
                        <select id="kaeltemittel" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="r134a">R134a (Fahrzeuge √§lter 2017)</option>
                            <option value="r1234yf">R1234yf (Fahrzeuge ab 2017)</option>
                            <option value="unbekannt">Unbekannt / Nicht sicher</option>
                        </select>
                        <small style="color: var(--color-text-tertiary);">Ab Erstzulassung 2017 meist R1234yf</small>
                    </div>

                    <div class="form-group">
                        <label for="klimaproblem" class="form-label">Beschreibung des Problems</label>
                        <textarea id="klimaproblem" class="form-input" rows="3" placeholder="z.B. Klimaanlage k√ºhlt nicht mehr, unangenehmer Geruch, Ger√§usche beim Einschalten"></textarea>
                    </div>
                </div>

                <!-- Dellen-Dr√ºckung Felder -->
                <div id="dellen-felder" class="service-felder" style="display:none;">
                    <div class="section-title" style="margin-top: var(--space-4);">
                        <i data-feather="circle"></i>
                        Dellen-Dr√ºckung Details
                    </div>

                    <div class="form-group">
                        <label for="dellenanzahl" class="form-label">Anzahl Dellen</label>
                        <input type="number" id="dellenanzahl" class="form-input" min="1" max="20" value="1">
                    </div>

                    <div class="form-group">
                        <label for="dellengroesse" class="form-label">Gr√∂√üte Delle</label>
                        <select id="dellengroesse" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="klein">Klein (< 5cm Durchmesser)</option>
                            <option value="mittel">Mittel (5-10cm Durchmesser)</option>
                            <option value="gross">Gro√ü (> 10cm Durchmesser)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="lackschaden" class="form-label">Lackschaden vorhanden?</label>
                        <select id="lackschaden" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="nein">Nein (nur Delle)</option>
                            <option value="ja">Ja (Delle + Lackschaden)</option>
                        </select>
                        <small style="color: var(--color-text-tertiary);">Bei Lackschaden ist zus√§tzliche Lackierung n√∂tig</small>
                    </div>

                    <div class="form-group">
                        <label for="dellenpositionen" class="form-label">Position(en) der Dellen</label>
                        <textarea id="dellenpositionen" class="form-input" rows="3" placeholder="z.B. Fahrert√ºr Mitte, Kotfl√ºgel rechts, Motorhaube links vorne"></textarea>
                    </div>
                </div>

                <!-- Versicherung-Service Felder -->
                <div id="versicherung-felder" class="service-felder" style="display:none;">
                    <div class="section-title" style="margin-top: var(--space-4);">
                        <i data-feather="circle"></i>
                        Versicherungsschaden Details
                    </div>

                    <div class="form-group">
                        <label for="versicherung-schadensnummer" class="form-label">Schadennummer</label>
                        <input type="text" id="versicherung-schadensnummer" class="form-input" placeholder="z.B. SCH-2024-123456">
                        <small style="color: var(--color-text-tertiary);">Von der Versicherung erhalten</small>
                    </div>

                    <div class="form-group">
                        <label for="versicherung-name" class="form-label">Versicherung</label>
                        <input type="text" id="versicherung-name" class="form-input" placeholder="z.B. Allianz, HUK, Ergo">
                    </div>

                    <div class="form-group">
                        <label for="versicherung-schadendatum" class="form-label">Schadendatum</label>
                        <input type="date" id="versicherung-schadendatum" class="form-input">
                    </div>

                    <div class="form-group">
                        <label for="versicherung-hergang" class="form-label">Unfallhergang / Schadenursache</label>
                        <textarea id="versicherung-hergang" class="form-input" rows="3" placeholder="z.B. Auffahrunfall, Parkrempler, Wildschaden, Hagel..."></textarea>
                    </div>
                </div>

                <!-- Pflege-Service Felder -->
                <div id="pflege-felder" class="service-felder" style="display:none;">
                    <div class="section-title" style="margin-top: var(--space-4);">
                        <i data-feather="circle"></i>
                        Fahrzeugpflege Details
                    </div>

                    <div class="form-group">
                        <label for="pflege-paket" class="form-label">Pflege-Paket</label>
                        <select id="pflege-paket" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="basis">Basis (Au√üenw√§sche + Staubsaugen)</option>
                            <option value="premium">Premium (Basis + Innenraumreinigung + Politur)</option>
                            <option value="deluxe">Deluxe (Premium + Motorw√§sche + Unterbodenw√§sche + Versiegelung)</option>
                            <option value="aufbereitung">Komplett-Aufbereitung (Deluxe + Polsterreinigung + Lederpflege)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="pflege-zusatz" class="form-label">Zusatzleistungen</label>
                        <textarea id="pflege-zusatz" class="form-input" rows="2" placeholder="z.B. Polsterreinigung, Lederpflege, Geruchsneutralisierung, Scheinwerfer-Aufbereitung"></textarea>
                    </div>
                </div>

                <!-- T√úV-Service Felder -->
                <div id="tuev-felder" class="service-felder" style="display:none;">
                    <div class="section-title" style="margin-top: var(--space-4);">
                        <i data-feather="circle"></i>
                        T√úV/AU Details
                    </div>

                    <div class="form-group">
                        <label for="tuev-pruefart" class="form-label">Pr√ºfart</label>
                        <select id="tuev-pruefart" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="hu">HU (Hauptuntersuchung)</option>
                            <option value="au">AU (Abgasuntersuchung)</option>
                            <option value="hu-au">HU + AU (Kombi)</option>
                            <option value="nachpruefung">Nachpr√ºfung</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="tuev-faelligkeit" class="form-label">F√§lligkeit T√úV</label>
                        <input type="month" id="tuev-faelligkeit" class="form-input">
                        <small style="color: var(--color-text-tertiary);">Steht im Fahrzeugschein und auf T√úV-Plakette</small>
                    </div>

                    <div class="form-group">
                        <label for="tuev-maengel" class="form-label">Bekannte M√§ngel (optional)</label>
                        <textarea id="tuev-maengel" class="form-input" rows="2" placeholder="z.B. Beleuchtung defekt, Reifen abgefahren, Rost am Schweller"></textarea>
                    </div>
                </div>

                <!-- Folierung Felder -->
                <div id="folierung-felder" class="service-felder" style="display:none;">
                    <div class="section-title" style="margin-top: var(--space-4);">
                        <i data-feather="circle"></i>
                        Auto Folierung Details
                    </div>

                    <div class="form-group">
                        <label for="folierungArt" class="form-label">Art der Folierung</label>
                        <select id="folierungArt" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="vollfolierung">üé® Vollfolierung (gesamtes Fahrzeug)</option>
                            <option value="teilfolierung">‚úÇÔ∏è Teilfolierung (bestimmte Teile)</option>
                            <option value="akzente">‚≠ê Akzente (Streifen, Logos)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="folierungMaterial" class="form-label">Materialqualit√§t</label>
                        <select id="folierungMaterial" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="standard">üì¶ Standard (3-5 Jahre)</option>
                            <option value="premium">üíé Premium (5-7 Jahre)</option>
                            <option value="spezial">üåü Spezialfolie (Chrome, Carbon, Matt)</option>
                        </select>
                    </div>

                    <div class="form-group" id="folierungSpezialTypContainer" style="display:none;">
                        <label for="folierungSpezialTyp" class="form-label">Spezialfolie Typ</label>
                        <input type="text" id="folierungSpezialTyp" class="form-input" placeholder="z.B. Chrome, Carbon, Matt Pearl">
                        <small style="color: var(--color-text-tertiary);">Nur bei Spezialfolien - genaue Bezeichnung</small>
                    </div>

                    <div class="form-group">
                        <label for="folierungFarbe" class="form-label">Farbauswahl</label>
                        <input type="text" id="folierungFarbe" class="form-input" placeholder="z.B. Schwarz Matt, Blau Metallic, Rot Hochglanz">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Folierung Bereiche</label>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-2);">
                            <label style="display: flex; align-items: center; gap: var(--space-2);">
                                <input type="checkbox" name="folierungBereiche" value="motorhaube">
                                <span>Motorhaube</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: var(--space-2);">
                                <input type="checkbox" name="folierungBereiche" value="dach">
                                <span>Dach</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: var(--space-2);">
                                <input type="checkbox" name="folierungBereiche" value="kofferraum">
                                <span>Kofferraum</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: var(--space-2);">
                                <input type="checkbox" name="folierungBereiche" value="tueren">
                                <span>T√ºren</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: var(--space-2);">
                                <input type="checkbox" name="folierungBereiche" value="kotfluegel">
                                <span>Kotfl√ºgel</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: var(--space-2);">
                                <input type="checkbox" name="folierungBereiche" value="spiegel">
                                <span>Spiegel</span>
                            </label>
                        </div>
                        <small style="color: var(--color-text-tertiary);">Welche Bereiche sollen foliert werden?</small>
                    </div>

                    <div class="form-group">
                        <label for="folierungDesign" class="form-label">Design Beschreibung</label>
                        <textarea id="folierungDesign" class="form-input" rows="3" placeholder="Beschreiben Sie das gew√ºnschte Design (z.B. Racing-Streifen, Farbverlauf, Muster...)"></textarea>
                        <small style="color: var(--color-text-tertiary);">Details zum gew√ºnschten Look</small>
                    </div>

                    <div class="form-group">
                        <label for="folierungInfo" class="form-label">Zus√§tzliche Informationen</label>
                        <textarea id="folierungInfo" class="form-input" rows="2" placeholder="Besondere Anforderungen, Zeitrahmen..."></textarea>
                    </div>
                </div>

                <!-- Steinschutz Felder -->
                <div id="steinschutz-felder" class="service-felder" style="display:none;">
                    <div class="section-title" style="margin-top: var(--space-4);">
                        <i data-feather="circle"></i>
                        Steinschutzfolie Details
                    </div>

                    <div class="form-group">
                        <label for="steinschutzUmfang" class="form-label">Schutzumfang</label>
                        <select id="steinschutzUmfang" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="premium">üõ°Ô∏è Premium-Paket (Komplettschutz)</option>
                            <option value="standard">üì¶ Standard-Paket (Front, Motorhaube, Spiegel)</option>
                            <option value="minimal">‚ö° Minimal-Paket (nur Front)</option>
                            <option value="individuell">üéØ Individuell (Bereiche ausw√§hlen)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="steinschutzMaterial" class="form-label">Materialqualit√§t</label>
                        <select id="steinschutzMaterial" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="standard">üì¶ Standard PPF (5 Jahre)</option>
                            <option value="premium">üíé Premium PPF (7 Jahre)</option>
                            <option value="self-healing">üîÑ Self-Healing (10 Jahre)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="steinschutzBereiche" class="form-label">Schutz-Bereiche</label>
                        <textarea id="steinschutzBereiche" class="form-input" rows="2" placeholder="z.B. Frontsto√üstange, Motorhaube, Kotfl√ºgel, Schweller, T√ºrkanten, Ladekante..."></textarea>
                        <small style="color: var(--color-text-tertiary);">Welche Bereiche sollen mit Steinschutzfolie versehen werden?</small>
                    </div>

                    <div class="form-group">
                        <label for="steinschutzInfo" class="form-label">Zus√§tzliche Informationen</label>
                        <textarea id="steinschutzInfo" class="form-input" rows="2" placeholder="Besondere Anforderungen, vorhandene Lacksch√§den..."></textarea>
                    </div>
                </div>

                <!-- Werbebeklebung Felder -->
                <div id="werbebeklebung-felder" class="service-felder" style="display:none;">
                    <div class="section-title" style="margin-top: var(--space-4);">
                        <i data-feather="circle"></i>
                        Fahrzeugbeschriftung Details
                    </div>

                    <div class="form-group">
                        <label for="werbebeklebungUmfang" class="form-label">Umfang der Beklebung</label>
                        <select id="werbebeklebungUmfang" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="vollbeklebung">üöö Vollbeklebung (alle Seiten)</option>
                            <option value="teilbeklebung">‚úÇÔ∏è Teilbeklebung (bestimmte Bereiche)</option>
                            <option value="logo-only">üè∑Ô∏è Nur Logo</option>
                            <option value="schriftzug">‚úçÔ∏è Schriftzug</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="werbebeklebungKomplexitaet" class="form-label">Design-Komplexit√§t</label>
                        <select id="werbebeklebungKomplexitaet" class="form-select">
                            <option value="">-- Bitte w√§hlen --</option>
                            <option value="einfach">üìù Einfach (Text + Logo, 1-2 Farben)</option>
                            <option value="mittel">üé® Mittel (Logo + Text + Grafiken, 3-5 Farben)</option>
                            <option value="komplex">üåà Komplex (Vollfl√§chiges Design, 6+ Farben)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="werbebeklebungFarbanzahl" class="form-label">Anzahl Farben</label>
                        <input type="number" id="werbebeklebungFarbanzahl" class="form-input" min="1" max="20" placeholder="z.B. 3">
                        <small style="color: var(--color-text-tertiary);">Wie viele verschiedene Farben werden im Design verwendet?</small>
                    </div>

                    <div class="form-group">
                        <label for="werbebeklebungText" class="form-label">Textelemente</label>
                        <textarea id="werbebeklebungText" class="form-input" rows="3" placeholder="Firmenname, Slogan, Kontaktdaten (Telefon, Website, E-Mail)..."></textarea>
                        <small style="color: var(--color-text-tertiary);">Alle Texte, die auf dem Fahrzeug erscheinen sollen</small>
                    </div>

                    <div class="form-group">
                        <label for="werbebeklebungInfo" class="form-label">Zus√§tzliche Informationen</label>
                        <textarea id="werbebeklebungInfo" class="form-input" rows="2" placeholder="Besondere W√ºnsche, Zeitrahmen, Referenzbilder..."></textarea>
                    </div>
                </div>

                <!-- ========================================== -->
                <!-- ENDE SERVICE-DETAIL-FELDER                 -->
                <!-- ========================================== -->

                <div class="form-group">
                    <label for="notizen" class="form-label">Notizen / Beschreibung <span class="required">*</span></label>
                    <textarea id="notizen" class="form-textarea" rows="4" placeholder="Detaillierte Beschreibung des Auftrags..." required></textarea>
                    <small style="color: var(--color-text-tertiary);">
                        üí° Diese Beschreibung wird im Angebot an den Kunden gesendet
                    </small>
                </div>

                <!-- DAT PDF UPLOAD -->
                <div class="form-group" style="background: var(--color-bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <label class="form-label">
                        üìÑ DAT-Kalkulation hochladen (optional)
                        <span style="color: var(--color-text-tertiary); font-size: 12px; font-weight: normal; display: block; margin-top: 4px;">
                            Fahrzeugdaten und Kalkulation werden automatisch ausgef√ºllt
                        </span>
                    </label>
                    <div class="pdf-upload-container" style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                        <button type="button" class="btn btn-secondary" style="font-size: 14px;"
                                onclick="document.getElementById('datPdfInput').click()">
                            üìÑ PDF ausw√§hlen
                        </button>
                        <input type="file" id="datPdfInput" accept="application/pdf" style="display: none;">
                        <span id="pdfFileName" class="pdf-filename" style="color: var(--color-success); font-size: 14px;"></span>
                        <button type="button" id="pdfRemoveBtn" class="btn-icon-small"
                                style="display: none; background: transparent; border: none; cursor: pointer; font-size: 20px;"
                                onclick="removePdf()">‚ùå</button>
                    </div>
                </div>

                <!-- KALKULATIONS-TABELLEN -->
                <div class="section-title">
                    <i data-feather="edit-3"></i>
                    Kalkulation (optional)
                </div>

                <!-- ERSATZTEILE TABELLE (Permanent, Editierbar) -->
                <div id="ersatzteileSection" style="margin-top: 20px; padding: 15px; background: rgba(79, 172, 254, 0.1); border-radius: 8px; border-left: 4px solid var(--color-primary);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h4 style="color: var(--color-primary); font-size: 16px; margin: 0; display: flex; align-items: center; gap: 8px;">
                            <svg data-feather="package" style="width: 20px; height: 20px;"></svg>
                            <span>Ersatzteile (<span id="ersatzteileCount">0</span>)</span>
                        </h4>
                        <button type="button" id="addErsatzteilBtn" onclick="addErsatzteilRow()" style="padding: 6px 12px; background: var(--color-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                            <svg data-feather="plus" style="width: 14px; height: 14px;"></svg>
                            Zeile hinzuf√ºgen
                        </button>
                    </div>
                    <div style="overflow-x: auto;">
                        <table id="ersatzteileTable" style="width: 100%; border-collapse: collapse; font-size: 13px;">
                            <thead>
                                <tr style="background: rgba(0,0,0,0.1); text-align: left;">
                                    <th style="padding: 8px; border-bottom: 2px solid var(--color-primary); width: 120px;">ETN</th>
                                    <th style="padding: 8px; border-bottom: 2px solid var(--color-primary);">Benennung</th>
                                    <th style="padding: 8px; border-bottom: 2px solid var(--color-primary); text-align: center; width: 80px;">Anzahl</th>
                                    <th style="padding: 8px; border-bottom: 2px solid var(--color-primary); text-align: right; width: 100px;">Einzelpreis</th>
                                    <th style="padding: 8px; border-bottom: 2px solid var(--color-primary); text-align: right; width: 100px;">Gesamtpreis</th>
                                    <th style="padding: 8px; border-bottom: 2px solid var(--color-primary); text-align: center; width: 60px;">Aktion</th>
                                </tr>
                            </thead>
                            <tbody id="ersatzteileTableBody">
                                <!-- Dynamisch gef√ºllt - Zeilen werden durch JavaScript hinzugef√ºgt -->
                            </tbody>
                            <tfoot style="background: rgba(79, 172, 254, 0.1); font-weight: 600;">
                                <tr>
                                    <td colspan="4" style="padding: 8px; text-align: right;">SUMME:</td>
                                    <td style="padding: 8px; text-align: right; color: var(--color-primary);" id="ersatzteileSumme">0.00 ‚Ç¨</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <p style="font-size: 11px; color: var(--color-text-secondary); margin-top: 10px; font-style: italic;">
                        üí° Tipp: Manuell Zeilen hinzuf√ºgen mit dem "+ Zeile hinzuf√ºgen" Button.
                    </p>
                </div>

                <!-- ARBEITSLOHN TABELLE (Permanent, Editierbar) -->
                <div id="arbeitslohnSection" style="margin-top: 20px; padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 8px; border-left: 4px solid #4caf50;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h4 style="color: #4caf50; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                            <svg data-feather="clock" style="width: 20px; height: 20px;"></svg>
                            Arbeitslohn (<span id="arbeitslohnCount">0</span>)
                        </h4>
                        <button type="button" id="addArbeitslohnBtn" onclick="addArbeitslohnRow()" style="display: flex; align-items: center; gap: 6px; padding: 8px 14px; background: #4caf50; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s;">
                            <svg data-feather="plus" style="width: 16px; height: 16px;"></svg>
                            Zeile hinzuf√ºgen
                        </button>
                    </div>
                    <div style="overflow-x: auto;">
                        <table id="arbeitslohnTable" style="width: 100%; border-collapse: collapse; font-size: 13px; background: white; border-radius: 4px; overflow: hidden;">
                            <thead>
                                <tr style="background: rgba(76, 175, 80, 0.1); text-align: left;">
                                    <th style="padding: 8px; border-bottom: 2px solid #4caf50;">Position</th>
                                    <th style="padding: 8px; border-bottom: 2px solid #4caf50; text-align: center;">Art</th>
                                    <th style="padding: 8px; border-bottom: 2px solid #4caf50; text-align: right;">Stunden</th>
                                    <th style="padding: 8px; border-bottom: 2px solid #4caf50; text-align: right;">Stundensatz</th>
                                    <th style="padding: 8px; border-bottom: 2px solid #4caf50; text-align: right;">Gesamtpreis</th>
                                    <th style="padding: 8px; border-bottom: 2px solid #4caf50; text-align: center; width: 60px;">Aktion</th>
                                </tr>
                            </thead>
                            <tbody id="arbeitslohnTableBody">
                                <!-- Dynamisch gef√ºllt -->
                            </tbody>
                            <tfoot style="background: rgba(76, 175, 80, 0.1); font-weight: 600;">
                                <tr>
                                    <td colspan="4" style="padding: 8px; text-align: right;">SUMME:</td>
                                    <td style="padding: 8px; text-align: right; color: #4caf50;" id="arbeitslohnTotal">0.00 ‚Ç¨</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- LACKIERUNG TABELLE (Permanent, Editierbar) -->
                <div id="lackierungSection" style="margin-top: 20px; padding: 15px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; border-left: 4px solid #9c27b0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h4 style="color: #9c27b0; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                            <svg data-feather="droplet" style="width: 20px; height: 20px;"></svg>
                            Lackierung (<span id="lackierungCount">0</span>)
                        </h4>
                        <button type="button" id="addLackierungBtn" onclick="addLackierungRow()" style="display: flex; align-items: center; gap: 6px; padding: 8px 14px; background: #9c27b0; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s;">
                            <svg data-feather="plus" style="width: 16px; height: 16px;"></svg>
                            Zeile hinzuf√ºgen
                        </button>
                    </div>
                    <table id="lackierungTable" style="width: 100%; border-collapse: collapse; font-size: 13px; background: white; border-radius: 4px; overflow: hidden;">
                        <thead style="background: rgba(156, 39, 176, 0.1);">
                            <tr>
                                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #9c27b0;">Position</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #9c27b0;">Bereich</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #9c27b0;">Stunden</th>
                                <th style="padding: 10px; text-align: right; border-bottom: 2px solid #9c27b0;">Stundensatz</th>
                                <th style="padding: 10px; text-align: right; border-bottom: 2px solid #9c27b0;">Gesamtpreis</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #9c27b0; width: 60px;">Aktion</th>
                            </tr>
                        </thead>
                        <tbody id="lackierungTableBody"></tbody>
                        <tfoot style="background: rgba(156, 39, 176, 0.15); font-weight: bold;">
                            <tr>
                                <td colspan="4" style="padding: 10px; text-align: right; border-top: 2px solid #9c27b0;">SUMME:</td>
                                <td id="lackierungTotal" style="padding: 10px; text-align: right; color: #9c27b0; font-size: 1.1em; border-top: 2px solid #9c27b0;">0.00 ‚Ç¨</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- MATERIALIEN TABELLE (Permanent, Editierbar) -->
                <div id="materialienSection" style="margin-top: 20px; padding: 15px; background: rgba(255, 152, 0, 0.1); border-radius: 8px; border-left: 4px solid #ff9800;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h4 style="color: #ff9800; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                            <svg data-feather="package" style="width: 20px; height: 20px;"></svg>
                            Materialien (<span id="materialienCount">0</span>)
                        </h4>
                        <button type="button" id="addMaterialienBtn" onclick="addMaterialienRow()" style="display: flex; align-items: center; gap: 6px; padding: 8px 14px; background: #ff9800; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s;">
                            <svg data-feather="plus" style="width: 16px; height: 16px;"></svg>
                            Material hinzuf√ºgen
                        </button>
                    </div>
                    <table id="materialienTable" style="width: 100%; border-collapse: collapse; font-size: 13px; background: white; border-radius: 4px; overflow: hidden;">
                        <thead style="background: rgba(255, 152, 0, 0.1);">
                            <tr>
                                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ff9800;">Material-Typ</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #ff9800;">Menge</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ff9800;">Einheit</th>
                                <th style="padding: 10px; text-align: right; border-bottom: 2px solid #ff9800;">Einheitspreis (‚Ç¨)</th>
                                <th style="padding: 10px; text-align: right; border-bottom: 2px solid #ff9800;">Gesamtpreis</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #ff9800; width: 60px;">Aktion</th>
                            </tr>
                        </thead>
                        <tbody id="materialienTableBody"></tbody>
                        <tfoot style="background: rgba(255, 152, 0, 0.15); font-weight: bold;">
                            <tr>
                                <td colspan="4" style="padding: 10px; text-align: right; border-top: 2px solid #ff9800;">SUMME:</td>
                                <td id="materialienTotal" style="padding: 10px; text-align: right; color: #ff9800; font-size: 1.1em; border-top: 2px solid #ff9800;">0.00 ‚Ç¨</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- PREISKALKULATION -->
                <div class="section-title">
                    <i data-feather="dollar-sign"></i>
                    Preiskalkulation
                </div>

                <div class="form-group">
                    <label for="vereinbarterPreis" class="form-label">Vereinbarter Preis (‚Ç¨) <span class="required">*</span></label>
                    <input type="number" id="vereinbarterPreis" class="form-input" placeholder="z.B. 450" step="0.01" min="0" required>
                    <small style="color: var(--color-text-tertiary);">
                        üí∞ Dieser Preis wird im Angebot genannt (inkl. MwSt.)
                    </small>
                </div>

                <div class="form-group">
                    <label for="geplantesAbnahmeDatum" class="form-label">Voraussichtliches Fertigstellungsdatum <span class="required">*</span></label>
                    <input type="date" id="geplantesAbnahmeDatum" class="form-input" required>
                    <small style="color: var(--color-text-tertiary);">
                        üìÖ Wann wird das Fahrzeug voraussichtlich fertig sein?
                    </small>
                </div>

                <!-- FOTOS (OPTIONAL) -->
                <div class="section-title">
                    <i data-feather="camera"></i>
                    Fotos (optional)
                </div>

                <div class="photo-section">
                    <label class="form-label">Schadensfotos</label>
                    <div class="photo-grid" id="photoGrid">
                        <div class="photo-item empty" onclick="document.getElementById('photoInput').click()">
                            <i data-feather="camera"></i>
                            <span>Foto hinzuf√ºgen</span>
                        </div>
                    </div>
                    <input type="file" id="photoInput" accept="image/*" capture="environment" multiple style="display: none;">
                    <small style="color: var(--color-text-tertiary); display: block; margin-top: var(--space-2);">
                        üí° Tipp: Bis zu 10 Fotos, max. 5 MB pro Foto
                    </small>
                </div>

                <!-- UNTERSCHRIFT (OPTIONAL) -->
                <div class="section-title">
                    <i data-feather="edit-3"></i>
                    Unterschrift (optional)
                </div>

                <div class="signature-section">
                    <label class="form-label">Unterschrift Kunde</label>
                    <canvas id="signatureCanvas" width="800" height="400"></canvas>
                    <div class="signature-buttons">
                        <button type="button" class="btn btn-secondary btn-sm" onclick="clearSignature()">
                            <i data-feather="x"></i>
                            L√∂schen
                        </button>
                    </div>
                </div>

                <!-- ACTION BUTTONS -->
                <div class="action-buttons">
                    <button type="button" class="btn btn-secondary btn-lg" onclick="saveEntwurf()">
                        <i data-feather="save"></i>
                        <span id="saveBtn">Entwurf aktualisieren</span>
                    </button>
                    <button type="button" class="btn btn-primary btn-lg" onclick="erstelleAngebot()">
                        <i data-feather="send"></i>
                        <span id="sendBtn">Angebot erstellen & versenden</span>
                    </button>
                    <!-- ‚úÖ BUG #4 FIX: PDF Retry Button (shown only when PDF generation failed) -->
                    <button
                        type="button"
                        id="pdfRetryBtn"
                        class="btn btn-warning btn-lg"
                        style="display: none; margin-top: 10px;"
                        onclick="retryPDFGeneration()">
                        <i data-feather="refresh-cw"></i>
                        <span id="retryBtnText">PDF erneut generieren</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase Konfiguration -->
    <script src="firebase-config.js?v=a4192c4"></script>
    <script src="js/auth-manager.js"></script>

    <script>
        // Initialize Feather Icons
        feather.replace();

        // Global State
        let firebaseInitialized = false;
        let offeneEntwuerfe = [];
        let currentEntwurf = null;
        let currentEntwurfId = null;

        // Kalkulations-Tabellen Data
        let ersatzteileData = [];
        let arbeitslohnData = [];
        let lackierungData = [];
        let materialienData = [];

        // PDF Upload Data
        let pdfData = null;

        // Photo Upload Data
        let photos = [];

        // Signature Canvas Data
        let signatureData = null;

        // ============================================
        // HELPER: BASE64 TO BLOB (FIX: Nov 17, 2025 - BUG #2)
        // ============================================

        /**
         * Convert Base64 string to Blob for file download
         * @param {string} base64 - Base64 encoded string
         * @param {string} mimeType - MIME type (e.g., 'application/pdf')
         * @returns {Blob}
         */
        function base64ToBlob(base64, mimeType) {
            const byteCharacters = atob(base64);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            return new Blob([byteArray], { type: mimeType });
        }

        // ============================================
        // PDF.js WORKER CONFIGURATION
        // ============================================

        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc =
                'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
            console.log('‚úÖ PDF.js Worker configured');
        }

        // ============================================
        // FIREBASE INITIALIZATION
        // ============================================

        window.addEventListener('load', async () => {
            try {
                console.log('üî• === ENTW√úRFE-BEARBEITEN.HTML INIT ===');

                // ‚úÖ FIX: Wait for Firebase initialization (Promise-based)
                if (window.firebaseInitialized) {
                    console.log('‚è≥ Warte auf Firebase Initialisierung...');
                    await window.firebaseInitialized;
                } else if (!window.db) {
                    // Fallback: Poll for window.db
                    await new Promise((resolve) => {
                        const interval = setInterval(() => {
                            if (window.db) {
                                clearInterval(interval);
                                resolve();
                            }
                        }, 100);
                    });
                }
                console.log('‚úÖ Firebase initialisiert');

                // ‚úÖ FIX: Wait for Auth Manager to set werkstattId
                if (!window.werkstattId) {
                    console.log('‚è≥ Warte auf Auth Manager (werkstattId)...');
                    await new Promise((resolve, reject) => {
                        const timeout = setTimeout(() => {
                            console.warn('‚ö†Ô∏è Auth timeout - pr√ºfe ob User eingeloggt ist');
                            reject(new Error('Auth timeout - bitte einloggen'));
                        }, 10000);
                        const interval = setInterval(() => {
                            if (window.werkstattId) {
                                clearInterval(interval);
                                clearTimeout(timeout);
                                resolve();
                            }
                        }, 100);
                    });
                }

                firebaseInitialized = true;
                console.log('‚úÖ Firebase + Auth Manager initialisiert, werkstattId:', window.werkstattId);

                // üõ°Ô∏è SECURITY: Page-Level Access Control (Pattern 6 - Defense in Depth)
                // Partner-Accounts d√ºrfen NICHT auf Werkstatt-Seiten zugreifen
                // ‚úÖ FIX: Jetzt funktioniert dieser Check, da window.currentUser gesetzt ist
                if (window.currentUser?.role === 'partner') {
                    console.warn('üö´ Partner-Zugriff blockiert! Redirect zu Partner-Portal...');
                    showToast('‚ö†Ô∏è Zugriff verweigert. Sie werden zum Partner-Portal weitergeleitet...', 'error', 3000);
                    setTimeout(() => {
                        safeNavigate('./partner-app/meine-anfragen.html');
                    }, 2000);
                    return; // Stop further execution
                }

                // Load drafts
                await loadOffeneEntwuerfe();

                // üöó Ersatzfahrzeug Toggle initialisieren (FIX: Nov 27, 2025)
                initErsatzfahrzeugToggle();

            } catch (error) {
                console.error('‚ùå Fehler bei Initialisierung:', error);
                showToast('‚ùå Fehler beim Laden der Entw√ºrfe', 'error', 6000);
            }
        });

        // ============================================
        // LOAD OFFENE ENTW√úRFE
        // ============================================

        async function loadOffeneEntwuerfe() {
            try {
                console.log('üì• === LADE OFFENE ENTW√úRFE ===');

                if (!window.db) {
                    throw new Error('Firebase nicht initialisiert');
                }

                // ‚úÖ SECURITY FIX: No 'mosbach' fallback - werkstattId must be validated at login
                if (!window.werkstattId) {
                    throw new Error('werkstattId nicht gesetzt');
                }
                const werkstattId = window.werkstattId;
                const collectionName = `partnerAnfragen_${werkstattId}`;

                console.log(`üîç Query: ${collectionName} WHERE isEntwurf==true AND entwurfStatus=='offen'`);

                const snapshot = await window.db
                    .collection(collectionName)
                    .where('isEntwurf', '==', true)
                    .where('entwurfStatus', '==', 'offen')
                    .orderBy('timestamp', 'desc')
                    .get();

                offeneEntwuerfe = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                console.log(`‚úÖ ${offeneEntwuerfe.length} offene Entw√ºrfe geladen`);

                // Populate dropdown
                const dropdown = document.getElementById('entwurfDropdown');
                const emptyState = document.getElementById('emptyState');

                dropdown.innerHTML = '<option value="">-- Bitte w√§hlen --</option>';

                if (offeneEntwuerfe.length === 0) {
                    emptyState.style.display = 'block';
                    dropdown.disabled = true;
                } else {
                    emptyState.style.display = 'none';
                    dropdown.disabled = false;

                    offeneEntwuerfe.forEach(entwurf => {
                        const option = document.createElement('option');
                        option.value = entwurf.id;
                        option.textContent = `${entwurf.kennzeichen} - ${entwurf.kundenname} (${entwurf.datum || 'Kein Datum'})`;
                        dropdown.appendChild(option);
                    });
                }

                feather.replace(); // Re-render icons

            } catch (error) {
                console.error('‚ùå Fehler beim Laden der Entw√ºrfe:', error);
                showToast(`‚ùå Fehler: ${error.message}`, 'error', 6000);
            }
        }

        // ============================================
        // KALKULATIONS-TABELLEN FUNKTIONEN
        // ============================================

        // ========================================
        // ERSATZTEILE TABLE
        // ========================================

        function addErsatzteilRow(data = {}) {
            const tableBody = document.getElementById('ersatzteileTableBody');
            const rowIndex = ersatzteileData.length;

            // Daten mit Defaults
            const teil = {
                etn: data.etn || '',
                benennung: data.benennung || '',
                anzahl: data.anzahl || 1,
                einzelpreis: data.einzelpreis || 0,
                gesamtpreis: data.gesamtpreis || (data.anzahl || 1) * (data.einzelpreis || 0)
            };

            // In globales Array speichern
            ersatzteileData.push(teil);

            // Neue Zeile erstellen
            const row = document.createElement('tr');
            row.dataset.index = rowIndex;
            row.style.borderBottom = '1px solid rgba(0,0,0,0.1)';
            row.style.background = rowIndex % 2 === 0 ? 'rgba(255,255,255,0.5)' : 'transparent';

            row.innerHTML = `
                <td style="padding: 4px;">
                    <input type="text" value="${teil.etn}" onchange="updateErsatzteil(${rowIndex}, 'etn', this.value)"
                           style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 12px;">
                </td>
                <td style="padding: 4px;">
                    <input type="text" value="${teil.benennung}" onchange="updateErsatzteil(${rowIndex}, 'benennung', this.value)"
                           style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                </td>
                <td style="padding: 4px;">
                    <input type="number" value="${teil.anzahl}" onchange="updateErsatzteil(${rowIndex}, 'anzahl', this.value)" min="1" step="1"
                           style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px; text-align: center; font-size: 12px;">
                </td>
                <td style="padding: 4px;">
                    <input type="number" value="${teil.einzelpreis.toFixed(2)}" onchange="updateErsatzteil(${rowIndex}, 'einzelpreis', this.value)" min="0" step="0.01"
                           style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px; text-align: right; font-family: 'Courier New', monospace; font-size: 12px;">
                </td>
                <td style="padding: 4px;">
                    <input type="number" value="${teil.gesamtpreis.toFixed(2)}" readonly
                           style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px; text-align: right; background: #f5f5f5; font-weight: 600; color: var(--color-success); font-family: 'Courier New', monospace; font-size: 12px;">
                </td>
                <td style="padding: 4px; text-align: center;">
                    <button type="button" onclick="deleteErsatzteilRow(${rowIndex})"
                            style="padding: 4px 8px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">
                        üóëÔ∏è
                    </button>
                </td>
            `;

            tableBody.appendChild(row);
            updateErsatzteileSumme();
            if (typeof feather !== 'undefined') feather.replace();
        }

        function updateErsatzteil(index, field, value) {
            if (!ersatzteileData[index]) return;

            if (field === 'anzahl' || field === 'einzelpreis') {
                ersatzteileData[index][field] = parseFloat(value) || 0;
                ersatzteileData[index].gesamtpreis = ersatzteileData[index].anzahl * ersatzteileData[index].einzelpreis;

                const row = document.querySelector(`tr[data-index="${index}"]`);
                if (row) {
                    const gesamtpreisInput = row.querySelectorAll('input')[4];
                    gesamtpreisInput.value = ersatzteileData[index].gesamtpreis.toFixed(2);
                }
            } else {
                ersatzteileData[index][field] = value;
            }

            updateErsatzteileSumme();
            updateKostenaufschluesselung();
        }

        function deleteErsatzteilRow(index) {
            if (!confirm('Diese Zeile wirklich l√∂schen?')) return;
            ersatzteileData.splice(index, 1);
            reRenderErsatzteileTable();
            updateErsatzteileSumme();
            updateKostenaufschluesselung();
        }

        function reRenderErsatzteileTable() {
            const tableBody = document.getElementById('ersatzteileTableBody');
            tableBody.innerHTML = '';
            const tempData = [...ersatzteileData];
            ersatzteileData = [];
            tempData.forEach(teil => addErsatzteilRow(teil));
        }

        function updateErsatzteileSumme() {
            const summe = ersatzteileData.reduce((sum, teil) => sum + (teil.gesamtpreis || 0), 0);
            document.getElementById('ersatzteileSumme').textContent = summe.toFixed(2) + ' ‚Ç¨';
            document.getElementById('ersatzteileCount').textContent = ersatzteileData.length;
        }

        // ========================================
        // ARBEITSLOHN TABLE
        // ========================================

        function addArbeitslohnRow(data = {}) {
            const rowIndex = arbeitslohnData.length;
            const item = {
                position: data.position || '',
                art: data.art || '',
                stunden: data.stunden || 0,
                stundensatz: data.stundensatz || 0,
                gesamtpreis: data.gesamtpreis || (data.stunden || 0) * (data.stundensatz || 0)
            };
            arbeitslohnData.push(item);

            const tableBody = document.getElementById('arbeitslohnTableBody');
            const row = document.createElement('tr');
            row.dataset.index = rowIndex;
            row.style.borderBottom = '1px solid rgba(0,0,0,0.1)';
            row.style.background = rowIndex % 2 === 0 ? 'rgba(255,255,255,0.5)' : 'transparent';

            row.innerHTML = `
                <td style="padding: 8px;">
                    <input type="text" value="${item.position}" onchange="updateArbeitslohn(${rowIndex}, 'position', this.value)" style="width: 100%; border: 1px solid #ddd; border-radius: 4px; padding: 4px;">
                </td>
                <td style="padding: 8px; text-align: center;">
                    <input type="text" value="${item.art}" onchange="updateArbeitslohn(${rowIndex}, 'art', this.value)" style="width: 100%; border: 1px solid #ddd; border-radius: 4px; padding: 4px; text-align: center;">
                </td>
                <td style="padding: 8px; text-align: center;">
                    <input type="number" value="${item.stunden.toFixed(2)}" onchange="updateArbeitslohn(${rowIndex}, 'stunden', this.value)" step="0.1" min="0" style="width: 80px; border: 1px solid #ddd; border-radius: 4px; padding: 4px; text-align: center; font-family: 'Courier New', monospace;">
                </td>
                <td style="padding: 8px; text-align: right;">
                    <input type="number" value="${item.stundensatz.toFixed(2)}" onchange="updateArbeitslohn(${rowIndex}, 'stundensatz', this.value)" step="0.01" min="0" style="width: 100px; border: 1px solid #ddd; border-radius: 4px; padding: 4px; text-align: right; font-family: 'Courier New', monospace;">
                </td>
                <td style="padding: 8px; text-align: right;">
                    <input type="number" value="${item.gesamtpreis.toFixed(2)}" readonly style="width: 100px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; padding: 4px; text-align: right; font-weight: 600; color: #4caf50; font-family: 'Courier New', monospace;">
                </td>
                <td style="padding: 8px; text-align: center;">
                    <button type="button" onclick="deleteArbeitslohnRow(${rowIndex})" style="background: #f44336; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 14px;">üóëÔ∏è</button>
                </td>
            `;

            tableBody.appendChild(row);
            updateArbeitslohnSumme();
            if (typeof feather !== 'undefined') feather.replace();
        }

        function updateArbeitslohn(index, field, value) {
            if (!arbeitslohnData[index]) return;

            if (field === 'stunden' || field === 'stundensatz') {
                arbeitslohnData[index][field] = parseFloat(value) || 0;
                arbeitslohnData[index].gesamtpreis = arbeitslohnData[index].stunden * arbeitslohnData[index].stundensatz;

                const row = document.querySelector(`#arbeitslohnTableBody tr[data-index="${index}"]`);
                const gesamtpreisInput = row?.querySelectorAll('input')[4];
                if (gesamtpreisInput) {
                    gesamtpreisInput.value = arbeitslohnData[index].gesamtpreis.toFixed(2);
                }
            } else {
                arbeitslohnData[index][field] = value;
            }

            updateArbeitslohnSumme();
            updateKostenaufschluesselung();
        }

        function deleteArbeitslohnRow(index) {
            if (!confirm('Diese Zeile wirklich l√∂schen?')) return;
            arbeitslohnData.splice(index, 1);
            reRenderArbeitslohnTable();
        }

        function reRenderArbeitslohnTable() {
            const tableBody = document.getElementById('arbeitslohnTableBody');
            tableBody.innerHTML = '';
            const tempData = [...arbeitslohnData];
            arbeitslohnData = [];
            tempData.forEach(item => addArbeitslohnRow(item));
        }

        function updateArbeitslohnSumme() {
            const summe = arbeitslohnData.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0);
            document.getElementById('arbeitslohnTotal').textContent = summe.toFixed(2) + ' ‚Ç¨';
            document.getElementById('arbeitslohnCount').textContent = arbeitslohnData.length;
        }

        // ========================================
        // LACKIERUNG TABLE
        // ========================================

        function addLackierungRow(data = {}) {
            const rowIndex = lackierungData.length;
            const item = {
                position: data.position || 'Lackierung',
                bereich: data.bereich || '',
                stunden: data.stunden || 0,
                stundensatz: data.stundensatz || 0,
                gesamtpreis: data.gesamtpreis || (data.stunden || 0) * (data.stundensatz || 0)
            };
            lackierungData.push(item);

            const tableBody = document.getElementById('lackierungTableBody');
            const row = document.createElement('tr');
            row.dataset.index = rowIndex;
            row.style.borderBottom = '1px solid rgba(0,0,0,0.1)';
            row.style.background = rowIndex % 2 === 0 ? 'rgba(255,255,255,0.5)' : 'transparent';

            row.innerHTML = `
                <td style="padding: 10px;">
                    <input type="text" value="${item.position}" onchange="updateLackierung(${rowIndex}, 'position', this.value)" style="width: 100%; border: 1px solid #ddd; border-radius: 4px; padding: 4px;">
                </td>
                <td style="padding: 10px;">
                    <input type="text" value="${item.bereich}" onchange="updateLackierung(${rowIndex}, 'bereich', this.value)" style="width: 100%; border: 1px solid #ddd; border-radius: 4px; padding: 4px; color: #9c27b0; font-weight: 600;">
                </td>
                <td style="padding: 10px; text-align: center;">
                    <input type="number" value="${item.stunden.toFixed(2)}" onchange="updateLackierung(${rowIndex}, 'stunden', this.value)" step="0.1" min="0" style="width: 80px; border: 1px solid #ddd; border-radius: 4px; padding: 4px; text-align: center; font-family: 'Courier New', monospace;">
                </td>
                <td style="padding: 10px; text-align: right;">
                    <input type="number" value="${item.stundensatz.toFixed(2)}" onchange="updateLackierung(${rowIndex}, 'stundensatz', this.value)" step="0.01" min="0" style="width: 100px; border: 1px solid #ddd; border-radius: 4px; padding: 4px; text-align: right; font-family: 'Courier New', monospace;">
                </td>
                <td style="padding: 10px; text-align: right;">
                    <input type="number" value="${item.gesamtpreis.toFixed(2)}" readonly style="width: 100px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; padding: 4px; text-align: right; font-weight: 600; color: #9c27b0; font-family: 'Courier New', monospace;">
                </td>
                <td style="padding: 10px; text-align: center;">
                    <button type="button" onclick="deleteLackierungRow(${rowIndex})" style="background: #f44336; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 14px;">üóëÔ∏è</button>
                </td>
            `;

            tableBody.appendChild(row);
            updateLackierungSumme();
            if (typeof feather !== 'undefined') feather.replace();
        }

        function updateLackierung(index, field, value) {
            if (!lackierungData[index]) return;

            if (field === 'stunden' || field === 'stundensatz') {
                lackierungData[index][field] = parseFloat(value) || 0;
                lackierungData[index].gesamtpreis = lackierungData[index].stunden * lackierungData[index].stundensatz;

                const row = document.querySelector(`#lackierungTableBody tr[data-index="${index}"]`);
                const gesamtpreisInput = row?.querySelectorAll('input')[4];
                if (gesamtpreisInput) {
                    gesamtpreisInput.value = lackierungData[index].gesamtpreis.toFixed(2);
                }
            } else {
                lackierungData[index][field] = value;
            }

            updateLackierungSumme();
            updateKostenaufschluesselung();
        }

        function deleteLackierungRow(index) {
            if (!confirm('Diese Zeile wirklich l√∂schen?')) return;
            lackierungData.splice(index, 1);
            reRenderLackierungTable();
        }

        function reRenderLackierungTable() {
            const tableBody = document.getElementById('lackierungTableBody');
            tableBody.innerHTML = '';
            const tempData = [...lackierungData];
            lackierungData = [];
            tempData.forEach(item => addLackierungRow(item));
        }

        function updateLackierungSumme() {
            const summe = lackierungData.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0);
            document.getElementById('lackierungTotal').textContent = summe.toFixed(2) + ' ‚Ç¨';
            document.getElementById('lackierungCount').textContent = lackierungData.length;
        }

        // ========================================
        // MATERIALIEN TABLE
        // ========================================

        function addMaterialienRow(data = {}) {
            const rowIndex = materialienData.length;
            const item = {
                materialTyp: data.materialTyp || '',
                menge: data.menge || 0,
                einheit: data.einheit || 'm¬≤',
                einheitspreis: data.einheitspreis || 0,
                gesamtpreis: data.gesamtpreis || (data.menge || 0) * (data.einheitspreis || 0)
            };
            materialienData.push(item);

            const tableBody = document.getElementById('materialienTableBody');
            const row = document.createElement('tr');
            row.dataset.index = rowIndex;
            row.style.borderBottom = '1px solid rgba(0,0,0,0.1)';
            row.style.background = rowIndex % 2 === 0 ? 'rgba(255,255,255,0.5)' : 'transparent';

            row.innerHTML = `
                <td style="padding: 10px;">
                    <input type="text" value="${item.materialTyp}" onchange="updateMaterialien(${rowIndex}, 'materialTyp', this.value)" placeholder="z.B. 3M Folie matt schwarz" style="width: 100%; border: 1px solid #ddd; border-radius: 4px; padding: 4px;">
                </td>
                <td style="padding: 10px; text-align: center;">
                    <input type="number" value="${item.menge.toFixed(2)}" onchange="updateMaterialien(${rowIndex}, 'menge', this.value)" step="0.01" min="0" style="width: 80px; border: 1px solid #ddd; border-radius: 4px; padding: 4px; text-align: center; font-family: 'Courier New', monospace;">
                </td>
                <td style="padding: 10px;">
                    <select onchange="updateMaterialien(${rowIndex}, 'einheit', this.value)" style="width: 100%; border: 1px solid #ddd; border-radius: 4px; padding: 4px;">
                        <option value="m¬≤" ${item.einheit === 'm¬≤' ? 'selected' : ''}>m¬≤</option>
                        <option value="St√ºck" ${item.einheit === 'St√ºck' ? 'selected' : ''}>St√ºck</option>
                        <option value="Liter" ${item.einheit === 'Liter' ? 'selected' : ''}>Liter</option>
                        <option value="kg" ${item.einheit === 'kg' ? 'selected' : ''}>kg</option>
                        <option value="Meter" ${item.einheit === 'Meter' ? 'selected' : ''}>Meter</option>
                        <option value="Set" ${item.einheit === 'Set' ? 'selected' : ''}>Set</option>
                    </select>
                </td>
                <td style="padding: 10px; text-align: right;">
                    <input type="number" value="${item.einheitspreis.toFixed(2)}" onchange="updateMaterialien(${rowIndex}, 'einheitspreis', this.value)" step="0.01" min="0" style="width: 100px; border: 1px solid #ddd; border-radius: 4px; padding: 4px; text-align: right; font-family: 'Courier New', monospace;">
                </td>
                <td style="padding: 10px; text-align: right;">
                    <input type="number" value="${item.gesamtpreis.toFixed(2)}" readonly style="width: 100px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; padding: 4px; text-align: right; font-weight: 600; color: #ff9800; font-family: 'Courier New', monospace;">
                </td>
                <td style="padding: 10px; text-align: center;">
                    <button type="button" onclick="deleteMaterialienRow(${rowIndex})" style="background: #f44336; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 14px;">üóëÔ∏è</button>
                </td>
            `;

            tableBody.appendChild(row);
            updateMaterialienSumme();
            if (typeof feather !== 'undefined') feather.replace();
        }

        function updateMaterialien(index, field, value) {
            if (!materialienData[index]) return;

            if (field === 'menge' || field === 'einheitspreis') {
                materialienData[index][field] = parseFloat(value) || 0;
                materialienData[index].gesamtpreis = materialienData[index].menge * materialienData[index].einheitspreis;

                const row = document.querySelector(`#materialienTableBody tr[data-index="${index}"]`);
                const gesamtpreisInput = row?.querySelectorAll('input[type="number"]')[2];
                if (gesamtpreisInput) {
                    gesamtpreisInput.value = materialienData[index].gesamtpreis.toFixed(2);
                }
            } else {
                materialienData[index][field] = value;
            }

            updateMaterialienSumme();
            updateKostenaufschluesselung();
        }

        function deleteMaterialienRow(index) {
            if (!confirm('Diese Zeile wirklich l√∂schen?')) return;
            materialienData.splice(index, 1);
            reRenderMaterialienTable();
        }

        function reRenderMaterialienTable() {
            const tableBody = document.getElementById('materialienTableBody');
            tableBody.innerHTML = '';
            const tempData = [...materialienData];
            materialienData = [];
            tempData.forEach(item => addMaterialienRow(item));
        }

        function updateMaterialienSumme() {
            const summe = materialienData.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0);
            document.getElementById('materialienTotal').textContent = summe.toFixed(2) + ' ‚Ç¨';
            document.getElementById('materialienCount').textContent = materialienData.length;
        }

        // ========================================
        // AUTO-CALCULATION
        // ========================================

        function clearAllTables() {
            // Clear all data arrays
            ersatzteileData = [];
            arbeitslohnData = [];
            lackierungData = [];
            materialienData = [];

            // Clear all table bodies
            document.getElementById('ersatzteileTableBody').innerHTML = '';
            document.getElementById('arbeitslohnTableBody').innerHTML = '';
            document.getElementById('lackierungTableBody').innerHTML = '';
            document.getElementById('materialienTableBody').innerHTML = '';

            // Reset all sums
            document.getElementById('ersatzteileSumme').textContent = '0.00 ‚Ç¨';
            document.getElementById('ersatzteileCount').textContent = '0';
            document.getElementById('arbeitslohnTotal').textContent = '0.00 ‚Ç¨';
            document.getElementById('arbeitslohnCount').textContent = '0';
            document.getElementById('lackierungTotal').textContent = '0.00 ‚Ç¨';
            document.getElementById('lackierungCount').textContent = '0';
            document.getElementById('materialienTotal').textContent = '0.00 ‚Ç¨';
            document.getElementById('materialienCount').textContent = '0';

            console.log('üóëÔ∏è Alle Tabellen geleert');
        }

        function updateKostenaufschluesselung() {
            const ersatzteileSumme = ersatzteileData.reduce((sum, t) => sum + (t.gesamtpreis || 0), 0);
            const arbeitslohnSumme = arbeitslohnData.reduce((sum, t) => sum + (t.gesamtpreis || 0), 0);
            const lackierungSumme = lackierungData.reduce((sum, t) => sum + (t.gesamtpreis || 0), 0);
            const materialienSumme = materialienData.reduce((sum, t) => sum + (t.gesamtpreis || 0), 0);

            // Netto-Summe
            const nettoSumme = ersatzteileSumme + arbeitslohnSumme + lackierungSumme + materialienSumme;

            // MwSt berechnen (Standard: 19%)
            const mwstSatz = 19;
            const mwstBetrag = nettoSumme * (mwstSatz / 100);

            // Brutto-Summe
            const bruttoSumme = nettoSumme + mwstBetrag;

            // Vereinbarter Preis auto-update (wenn Kalkulation verwendet wird)
            const vereinbarterPreis = document.getElementById('vereinbarterPreis');
            if (vereinbarterPreis && bruttoSumme > 0) {
                vereinbarterPreis.value = bruttoSumme.toFixed(2);
                console.log(`‚úÖ Vereinbarter Preis auto-updated: ${bruttoSumme.toFixed(2)} ‚Ç¨`);
            }
        }

        // ============================================
        // LOAD ENTWURF (Fill Form)
        // ============================================

        async function loadEntwurf() {
            try {
                const dropdown = document.getElementById('entwurfDropdown');
                const selectedId = dropdown.value;

                if (!selectedId) {
                    document.getElementById('formContainer').classList.remove('visible');
                    currentEntwurf = null;
                    currentEntwurfId = null;

                    // Clear tables
                    clearAllTables();

                    // üñºÔ∏è Clear photos and signature (Phase 3)
                    photos = [];
                    updatePhotoGrid();
                    clearSignature();

                    return;
                }

                // Find entwurf
                currentEntwurf = offeneEntwuerfe.find(e => String(e.id) === String(selectedId));
                currentEntwurfId = selectedId;

                if (!currentEntwurf) {
                    throw new Error('Entwurf nicht gefunden');
                }

                console.log('üìù Lade Entwurf:', currentEntwurf);

                // Fill form
                document.getElementById('kennzeichen').value = currentEntwurf.kennzeichen || '';
                document.getElementById('kundenname').value = currentEntwurf.kundenname || '';
                document.getElementById('kundenEmail').value = currentEntwurf.kundenEmail || '';
                document.getElementById('telefon').value = currentEntwurf.telefon || '';
                document.getElementById('marke').value = currentEntwurf.marke || '';
                document.getElementById('modell').value = currentEntwurf.modell || '';
                document.getElementById('baujahrVon').value = currentEntwurf.baujahrVon || '';
                document.getElementById('kmstand').value = currentEntwurf.kmstand || '';
                document.getElementById('vin').value = currentEntwurf.vin || '';

                // ‚úÖ Populate READ-ONLY serviceTyp Display (Pattern 21 - Multi-Service Support)
                const serviceLabels = {
                    'lackier': 'üé® Lackierung',
                    'lackierung': 'üé® Lackierung',  // Fallback for old format
                    'reifen': 'üîß Reifen-Service',
                    'mechanik': '‚öôÔ∏è Mechanik',
                    'pflege': '‚ú® Pflege & Aufbereitung',
                    'tuev': 'üìã T√úV & Pr√ºfung',
                    'versicherung': 'üõ°Ô∏è Versicherungsschaden',
                    'glas': 'üîç Glas-Reparatur',
                    'klima': '‚ùÑÔ∏è Klima-Service',
                    'dellen': 'üî® Dellen-Dr√ºckung',
                    'folierung': 'üåà Auto Folierung',
                    'steinschutz': 'üõ°Ô∏è Steinschutzfolie',
                    'werbebeklebung': 'üì¢ Fahrzeugbeschriftung',
                    'smart_repair': 'üîß Smart Repair'
                };

                let displayText = '';
                const serviceTyp = currentEntwurf.serviceTyp;

                if (Array.isArray(serviceTyp)) {
                    // Multi-Service: Join with comma
                    displayText = serviceTyp.map(s => serviceLabels[s] || s).join(', ');
                } else if (serviceTyp) {
                    // Single-Service
                    displayText = serviceLabels[serviceTyp] || serviceTyp;
                } else {
                    displayText = 'üé® Lackierung';  // Fallback
                }

                document.getElementById('serviceTypDisplay').textContent = displayText;
                document.getElementById('notizen').value = currentEntwurf.notizen || '';
                document.getElementById('vereinbarterPreis').value = currentEntwurf.vereinbarterPreis || '';
                document.getElementById('geplantesAbnahmeDatum').value = currentEntwurf.geplantesAbnahmeDatum || '';

                // Load Kalkulations-Tabellen if available
                clearAllTables();
                // ‚úÖ VALIDATE kalkulationData type (FIX: Nov 17, 2025 - BUG #5)
                if (currentEntwurf.kalkulationData && typeof currentEntwurf.kalkulationData === 'object') {
                    console.log('üìä Lade Kalkulations-Daten:', currentEntwurf.kalkulationData);

                    if (Array.isArray(currentEntwurf.kalkulationData.ersatzteile)) {
                        currentEntwurf.kalkulationData.ersatzteile.forEach(item => addErsatzteilRow(item));
                    }
                    if (Array.isArray(currentEntwurf.kalkulationData.arbeitslohn)) {
                        currentEntwurf.kalkulationData.arbeitslohn.forEach(item => addArbeitslohnRow(item));
                    }
                    if (Array.isArray(currentEntwurf.kalkulationData.lackierung)) {
                        currentEntwurf.kalkulationData.lackierung.forEach(item => addLackierungRow(item));
                    }
                    if (Array.isArray(currentEntwurf.kalkulationData.materialien)) {
                        currentEntwurf.kalkulationData.materialien.forEach(item => addMaterialienRow(item));
                    }

                    console.log('‚úÖ Kalkulations-Daten geladen');
                }

                // üîß Load Service-Details (Pattern 34 - FIX: Nov 17, 2025)
                if (currentEntwurf.serviceDetails && typeof currentEntwurf.serviceDetails === 'object') {
                    console.log('üìã Lade Service-Details:', currentEntwurf.serviceDetails);

                    const details = currentEntwurf.serviceDetails;

                    // Reifen-Details
                    if (details.reifengroesse) document.getElementById('reifengroesse').value = details.reifengroesse;
                    if (details.reifentyp) document.getElementById('reifentyp').value = details.reifentyp;
                    if (details.reifenanzahl) document.getElementById('reifenanzahl').value = details.reifenanzahl;

                    // Mechanik-Details
                    if (details.mechanikProblem) document.getElementById('mechanik-problem').value = details.mechanikProblem;
                    if (details.mechanikSymptome) document.getElementById('mechanik-symptome').value = details.mechanikSymptome;

                    // Lackierung-Details
                    if (details.farbname) document.getElementById('farbname').value = details.farbname;
                    if (details.farbvariante) document.getElementById('farbvariante').value = details.farbvariante;
                    if (details.farbnummer) document.getElementById('farbnummer').value = details.farbnummer;
                    if (details.lackart) {
                        const radioButton = document.querySelector(`input[name="lackart"][value="${details.lackart}"]`);
                        if (radioButton) radioButton.checked = true;
                    }

                    // Glas-Details
                    if (details.scheibentyp) document.getElementById('scheibentyp').value = details.scheibentyp;
                    if (details.schadensgroesse) document.getElementById('schadensgroesse').value = details.schadensgroesse;
                    if (details.glasposition) document.getElementById('glasposition').value = details.glasposition;

                    // Klima-Details
                    if (details.klimaservice) document.getElementById('klimaservice').value = details.klimaservice;
                    if (details.kaeltemittel) document.getElementById('kaeltemittel').value = details.kaeltemittel;
                    if (details.klimaproblem) document.getElementById('klimaproblem').value = details.klimaproblem;

                    // Dellen-Details
                    if (details.dellenanzahl) document.getElementById('dellenanzahl').value = details.dellenanzahl;
                    if (details.dellengroesse) document.getElementById('dellengroesse').value = details.dellengroesse;
                    if (details.lackschaden) document.getElementById('lackschaden').value = details.lackschaden;
                    if (details.dellenpositionen) document.getElementById('dellenpositionen').value = details.dellenpositionen;

                    // Versicherung-Details
                    if (details.schadensnummer) document.getElementById('versicherung-schadensnummer').value = details.schadensnummer;
                    if (details.versicherung) document.getElementById('versicherung-name').value = details.versicherung;
                    if (details.schadendatum) document.getElementById('versicherung-schadendatum').value = details.schadendatum;
                    if (details.unfallhergang) document.getElementById('versicherung-hergang').value = details.unfallhergang;

                    // Pflege-Details
                    if (details.paket) document.getElementById('pflege-paket').value = details.paket;
                    if (details.zusatzleistungen) document.getElementById('pflege-zusatz').value = details.zusatzleistungen;

                    // T√úV-Details
                    if (details.pruefart) document.getElementById('tuev-pruefart').value = details.pruefart;
                    if (details.faelligkeit) document.getElementById('tuev-faelligkeit').value = details.faelligkeit;
                    if (details.bekannteMaengel) document.getElementById('tuev-maengel').value = details.bekannteMaengel;

                    // Folierung-Details
                    if (details.folierungArt) document.getElementById('folierungArt').value = details.folierungArt;
                    if (details.folierungMaterial) document.getElementById('folierungMaterial').value = details.folierungMaterial;
                    if (details.folierungSpezialTyp) document.getElementById('folierungSpezialTyp').value = details.folierungSpezialTyp;  // FIX: Nov 17, 2025 - Missing Field
                    if (details.folierungFarbe) document.getElementById('folierungFarbe').value = details.folierungFarbe;
                    if (details.folierungBereiche && Array.isArray(details.folierungBereiche)) {  // FIX: Nov 17, 2025 - Missing Field
                        details.folierungBereiche.forEach(bereich => {
                            const checkbox = document.querySelector(`input[name="folierungBereiche"][value="${bereich}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                    if (details.folierungDesign) document.getElementById('folierungDesign').value = details.folierungDesign;  // FIX: Nov 17, 2025 - Missing Field
                    if (details.folierungInfo) document.getElementById('folierungInfo').value = details.folierungInfo;

                    // Steinschutz-Details
                    if (details.steinschutzUmfang) document.getElementById('steinschutzUmfang').value = details.steinschutzUmfang;
                    if (details.steinschutzMaterial) document.getElementById('steinschutzMaterial').value = details.steinschutzMaterial;
                    if (details.steinschutzBereiche) document.getElementById('steinschutzBereiche').value = details.steinschutzBereiche;  // FIX: Nov 17, 2025 - Missing Field
                    if (details.steinschutzInfo) document.getElementById('steinschutzInfo').value = details.steinschutzInfo;

                    // Werbebeklebung-Details
                    if (details.werbebeklebungUmfang) document.getElementById('werbebeklebungUmfang').value = details.werbebeklebungUmfang;
                    if (details.werbebeklebungKomplexitaet) document.getElementById('werbebeklebungKomplexitaet').value = details.werbebeklebungKomplexitaet;
                    if (details.werbebeklebungText) document.getElementById('werbebeklebungText').value = details.werbebeklebungText;
                    if (details.werbebeklebungFarbanzahl) document.getElementById('werbebeklebungFarbanzahl').value = details.werbebeklebungFarbanzahl;  // FIX: Nov 17, 2025 - Missing Field
                    if (details.werbebeklebungInfo) document.getElementById('werbebeklebungInfo').value = details.werbebeklebungInfo;

                    console.log('‚úÖ Service-Details geladen');
                }

                // üÜï MULTI-SERVICE: Load Additional Services Details (Pattern 34 - FIX: Nov 17, 2025)
                if (currentEntwurf.additionalServices && Array.isArray(currentEntwurf.additionalServices)) {
                    console.log(`üÜï Lade ${currentEntwurf.additionalServices.length} zus√§tzliche Services:`, currentEntwurf.additionalServices);

                    currentEntwurf.additionalServices.forEach(additionalService => {
                        if (additionalService.serviceDetails && typeof additionalService.serviceDetails === 'object') {
                            const details = additionalService.serviceDetails;

                            console.log(`   üìã Lade Details f√ºr: ${additionalService.serviceTyp}`, details);

                            // Reifen-Details
                            if (details.reifengroesse) document.getElementById('reifengroesse').value = details.reifengroesse;
                            if (details.reifentyp) document.getElementById('reifentyp').value = details.reifentyp;
                            if (details.reifenanzahl) document.getElementById('reifenanzahl').value = details.reifenanzahl;

                            // Mechanik-Details (Backwards Compatibility: problem vs mechanikProblem)
                            if (details.mechanikProblem || details.problem) {
                                document.getElementById('mechanik-problem').value = details.mechanikProblem || details.problem;
                            }
                            if (details.mechanikSymptome || details.symptome) {
                                document.getElementById('mechanik-symptome').value = details.mechanikSymptome || details.symptome;
                            }

                            // Lackierung-Details
                            if (details.farbname) document.getElementById('farbname').value = details.farbname;
                            if (details.farbvariante) document.getElementById('farbvariante').value = details.farbvariante;
                            if (details.farbnummer) document.getElementById('farbnummer').value = details.farbnummer;
                            if (details.lackart) {
                                const radioButton = document.querySelector(`input[name="lackart"][value="${details.lackart}"]`);
                                if (radioButton) radioButton.checked = true;
                            }

                            // Glas-Details
                            if (details.scheibentyp) document.getElementById('scheibentyp').value = details.scheibentyp;
                            if (details.schadensgroesse) document.getElementById('schadensgroesse').value = details.schadensgroesse;
                            if (details.glasposition) document.getElementById('glasposition').value = details.glasposition;

                            // Klima-Details
                            if (details.klimaservice) document.getElementById('klimaservice').value = details.klimaservice;
                            if (details.kaeltemittel) document.getElementById('kaeltemittel').value = details.kaeltemittel;
                            if (details.klimaproblem) document.getElementById('klimaproblem').value = details.klimaproblem;

                            // Dellen-Details
                            if (details.dellenanzahl) document.getElementById('dellenanzahl').value = details.dellenanzahl;
                            if (details.dellengroesse) document.getElementById('dellengroesse').value = details.dellengroesse;
                            if (details.lackschaden) document.getElementById('lackschaden').value = details.lackschaden;
                            if (details.dellenpositionen) document.getElementById('dellenpositionen').value = details.dellenpositionen;

                            // Versicherung-Details
                            if (details.schadensnummer) document.getElementById('versicherung-schadensnummer').value = details.schadensnummer;
                            if (details.versicherung) document.getElementById('versicherung-name').value = details.versicherung;
                            if (details.schadendatum) document.getElementById('versicherung-schadendatum').value = details.schadendatum;
                            if (details.unfallhergang) document.getElementById('versicherung-hergang').value = details.unfallhergang;

                            // Pflege-Details
                            if (details.paket) document.getElementById('pflege-paket').value = details.paket;
                            if (details.zusatzleistungen) document.getElementById('pflege-zusatz').value = details.zusatzleistungen;

                            // T√úV-Details
                            if (details.pruefart) document.getElementById('tuev-pruefart').value = details.pruefart;
                            if (details.faelligkeit) document.getElementById('tuev-faelligkeit').value = details.faelligkeit;
                            if (details.bekannteMaengel) document.getElementById('tuev-maengel').value = details.bekannteMaengel;

                            // Folierung-Details
                            if (details.folierungArt) document.getElementById('folierungArt').value = details.folierungArt;
                            if (details.folierungMaterial) document.getElementById('folierungMaterial').value = details.folierungMaterial;
                            if (details.folierungSpezialTyp) document.getElementById('folierungSpezialTyp').value = details.folierungSpezialTyp;
                            if (details.folierungFarbe) document.getElementById('folierungFarbe').value = details.folierungFarbe;
                            if (details.folierungBereiche && Array.isArray(details.folierungBereiche)) {
                                details.folierungBereiche.forEach(bereich => {
                                    const checkbox = document.querySelector(`input[name="folierungBereiche"][value="${bereich}"]`);
                                    if (checkbox) checkbox.checked = true;
                                });
                            }
                            if (details.folierungDesign) document.getElementById('folierungDesign').value = details.folierungDesign;
                            if (details.folierungInfo) document.getElementById('folierungInfo').value = details.folierungInfo;

                            // Steinschutz-Details
                            if (details.steinschutzUmfang) document.getElementById('steinschutzUmfang').value = details.steinschutzUmfang;
                            if (details.steinschutzMaterial) document.getElementById('steinschutzMaterial').value = details.steinschutzMaterial;
                            if (details.steinschutzBereiche) document.getElementById('steinschutzBereiche').value = details.steinschutzBereiche;
                            if (details.steinschutzInfo) document.getElementById('steinschutzInfo').value = details.steinschutzInfo;

                            // Werbebeklebung-Details
                            if (details.werbebeklebungUmfang) document.getElementById('werbebeklebungUmfang').value = details.werbebeklebungUmfang;
                            if (details.werbebeklebungKomplexitaet) document.getElementById('werbebeklebungKomplexitaet').value = details.werbebeklebungKomplexitaet;
                            if (details.werbebeklebungText) document.getElementById('werbebeklebungText').value = details.werbebeklebungText;
                            if (details.werbebeklebungFarbanzahl) document.getElementById('werbebeklebungFarbanzahl').value = details.werbebeklebungFarbanzahl;
                            if (details.werbebeklebungInfo) document.getElementById('werbebeklebungInfo').value = details.werbebeklebungInfo;
                        }
                    });

                    console.log('‚úÖ Additional Services Details geladen');
                }

                // üñºÔ∏è Load Fotos (Phase 3)
                photos = [];
                if (currentEntwurf.photoUrls && Array.isArray(currentEntwurf.photoUrls)) {
                    photos = currentEntwurf.photoUrls;
                    updatePhotoGrid();
                    console.log(`üì∏ ${photos.length} Fotos geladen (photoUrls)`);
                }

                // üñäÔ∏è Load Unterschrift (Phase 3) - ‚úÖ FIX: Nov 17, 2025 - BUG #1
                signatureData = null;
                if (currentEntwurf.signature) {
                    signatureData = currentEntwurf.signature;

                    // Redraw signature on canvas
                    const canvas = document.getElementById('signatureCanvas');
                    const ctx = canvas.getContext('2d');
                    const img = new Image();
                    img.onload = function() {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);  // Clear canvas (including any placeholder)
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);  // Draw signature
                        hasDrawn = true;
                        console.log('‚úÖ Unterschrift angezeigt auf Canvas (hasDrawn=true)');
                    };
                    img.onerror = function() {
                        console.error('‚ùå Fehler beim Laden der Unterschrift-Bilddaten');
                        drawPlaceholder();  // Fallback: Show placeholder if image load fails
                    };
                    img.src = signatureData;
                    console.log('‚úçÔ∏è Unterschrift wird geladen...');
                } else {
                    // ‚úÖ FIX: No signature exists ‚Üí show placeholder explicitly
                    console.log('‚ÑπÔ∏è Keine Unterschrift vorhanden ‚Üí Placeholder anzeigen');
                    const canvas = document.getElementById('signatureCanvas');
                    if (canvas && typeof drawPlaceholder === 'function') {
                        drawPlaceholder();
                    }
                }

                // ‚úÖ BUG #4 FIX: Check for PDF generation errors
                if (currentEntwurf.pdfGenerationFailed) {
                    const errorMsg = currentEntwurf.pdfGenerationError || 'Unbekannter Fehler';
                    showToast(
                        `‚ö†Ô∏è PDF-Generierung fehlgeschlagen:\n\n${errorMsg}\n\nüí° Bitte versuchen Sie es erneut.`,
                        'error',
                        10000
                    );

                    // Show retry button
                    const retryBtn = document.getElementById('pdfRetryBtn');
                    if (retryBtn) {
                        retryBtn.style.display = 'inline-block';
                    }
                }

                // ‚úÖ BUG #4 FIX: Check for email skip warning
                if (currentEntwurf.pdfEmailSkipped) {
                    const skipReason = currentEntwurf.pdfEmailSkippedReason || 'SendGrid deaktiviert';
                    showToast(
                        `‚ÑπÔ∏è Admin-Email wurde √ºbersprungen:\n\n${skipReason}\n\n‚ö†Ô∏è PDF wurde erstellt, aber NICHT per Email versendet.`,
                        'warning',
                        8000
                    );
                }

                // üöó Ersatzfahrzeug laden (FIX: Nov 27, 2025)
                const ersatzfahrzeugCheckbox = document.getElementById('ersatzfahrzeugGewuenscht');
                const ersatzfahrzeugZuweisungGroup = document.getElementById('ersatzfahrzeugZuweisungGroup');
                const zugewiesenesErsatzfahrzeugSelect = document.getElementById('zugewiesenesErsatzfahrzeug');

                // Checkbox-Status setzen
                if (currentEntwurf.serviceDetails?.ersatzfahrzeugGewuenscht || currentEntwurf.ersatzfahrzeugGewuenscht) {
                    ersatzfahrzeugCheckbox.checked = true;
                    ersatzfahrzeugZuweisungGroup.style.display = 'block';

                    // Verf√ºgbare Leihfahrzeuge laden
                    await loadVerfuegbareLeihfahrzeuge();

                    // Zugewiesenes Fahrzeug ausw√§hlen (falls vorhanden)
                    if (currentEntwurf.zugewiesenesErsatzfahrzeug) {
                        zugewiesenesErsatzfahrzeugSelect.value = currentEntwurf.zugewiesenesErsatzfahrzeug;
                    }
                } else {
                    ersatzfahrzeugCheckbox.checked = false;
                    ersatzfahrzeugZuweisungGroup.style.display = 'none';
                }

                console.log('üöó Ersatzfahrzeug-Status geladen:', ersatzfahrzeugCheckbox.checked);

                // Show form
                document.getElementById('formContainer').classList.add('visible');
                feather.replace();

                // üîÑ Toggle Service-Felder visibility (Pattern 34 - FIX: Nov 17, 2025)
                if (typeof toggleServiceFelder === 'function') {
                    toggleServiceFelder();
                }

                console.log('‚úÖ Entwurf geladen und Formular ausgef√ºllt');

            } catch (error) {
                console.error('‚ùå Fehler beim Laden des Entwurfs:', error);
                showToast(`‚ùå Fehler: ${error.message}`, 'error', 6000);
            }
        }

        // ============================================
        // ERSATZFAHRZEUG FUNKTIONEN (FIX: Nov 27, 2025)
        // ============================================

        /**
         * L√§dt verf√ºgbare Leihfahrzeuge aus der Datenbank
         */
        async function loadVerfuegbareLeihfahrzeuge() {
            try {
                const select = document.getElementById('zugewiesenesErsatzfahrzeug');
                if (!select) return;

                // Reset dropdown (behalte erste Option)
                select.innerHTML = '<option value="">-- Kein Fahrzeug zugewiesen --</option>';

                const werkstattId = window.werkstattId;
                if (!werkstattId) {
                    console.warn('‚ö†Ô∏è werkstattId nicht gesetzt, kann Leihfahrzeuge nicht laden');
                    return;
                }

                // Lade verf√ºgbare Leihfahrzeuge
                const collectionName = `leihfahrzeuge_${werkstattId}`;
                const snapshot = await window.db.collection(collectionName)
                    .where('status', '==', 'verfuegbar')
                    .get();

                if (snapshot.empty) {
                    // Auch ohne Filter versuchen (alle Fahrzeuge)
                    const allSnapshot = await window.db.collection(collectionName).get();
                    if (allSnapshot.empty) {
                        console.log('‚ÑπÔ∏è Keine Leihfahrzeuge in der Datenbank');
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = '-- Keine Leihfahrzeuge verf√ºgbar --';
                        option.disabled = true;
                        select.appendChild(option);
                        return;
                    }

                    // Zeige alle Fahrzeuge mit Status
                    allSnapshot.forEach(doc => {
                        const data = doc.data();
                        const option = document.createElement('option');
                        option.value = doc.id;
                        const statusText = data.status === 'verfuegbar' ? '' : ` (${data.status || 'unbekannt'})`;
                        option.textContent = `${data.marke || 'Unbekannt'} ${data.modell || ''} (${data.kennzeichen || 'N/A'})${statusText}`;
                        if (data.status !== 'verfuegbar') {
                            option.disabled = true;
                        }
                        select.appendChild(option);
                    });
                    console.log(`üöó ${allSnapshot.size} Leihfahrzeuge geladen (inkl. nicht verf√ºgbare)`);
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = `${data.marke || 'Unbekannt'} ${data.modell || ''} (${data.kennzeichen || 'N/A'})`;
                    select.appendChild(option);
                });

                console.log(`üöó ${snapshot.size} verf√ºgbare Leihfahrzeuge geladen`);

            } catch (error) {
                console.error('‚ùå Fehler beim Laden der Leihfahrzeuge:', error);
            }
        }

        /**
         * Initialisiert Ersatzfahrzeug-Checkbox Event-Listener
         */
        function initErsatzfahrzeugToggle() {
            const checkbox = document.getElementById('ersatzfahrzeugGewuenscht');
            const zuweisungGroup = document.getElementById('ersatzfahrzeugZuweisungGroup');

            if (checkbox && zuweisungGroup) {
                checkbox.addEventListener('change', async function() {
                    if (this.checked) {
                        zuweisungGroup.style.display = 'block';
                        await loadVerfuegbareLeihfahrzeuge();
                    } else {
                        zuweisungGroup.style.display = 'none';
                        // Reset dropdown selection
                        const select = document.getElementById('zugewiesenesErsatzfahrzeug');
                        if (select) select.value = '';
                    }
                });
                console.log('‚úÖ Ersatzfahrzeug Toggle initialisiert');
            }
        }

        // ============================================
        // TOGGLE SERVICE-FELDER (Pattern 34 - FIX: Nov 17, 2025)
        // ============================================

        function toggleServiceFelder() {
            try {
                // Hide all service-felder first
                document.querySelectorAll('.service-felder').forEach(el => el.style.display = 'none');

                if (!currentEntwurf) {
                    console.log('‚ÑπÔ∏è toggleServiceFelder: currentEntwurf ist null');
                    return;
                }

                console.log('üîÑ toggleServiceFelder() - serviceTyp:', currentEntwurf.serviceTyp);

                // Single-Service oder Multi-Service?
                if (Array.isArray(currentEntwurf.serviceTyp)) {
                    // Multi-Service: Zeige alle Service-Felder
                    currentEntwurf.serviceTyp.forEach(serviceTyp => {
                        const felderDiv = document.getElementById(`${serviceTyp}-felder`);
                        if (felderDiv) {
                            felderDiv.style.display = 'block';
                            console.log(`   ‚úÖ ${serviceTyp}-felder angezeigt`);
                        } else {
                            console.warn(`   ‚ö†Ô∏è ${serviceTyp}-felder nicht gefunden`);
                        }
                    });
                    console.log(`‚ú® Multi-Service: ${currentEntwurf.serviceTyp.length} Service-Feldgruppen angezeigt`);
                } else if (currentEntwurf.serviceTyp) {
                    // Single-Service: Zeige nur einen Service
                    const serviceTyp = currentEntwurf.serviceTyp;
                    const felderDiv = document.getElementById(`${serviceTyp}-felder`);
                    if (felderDiv) {
                        felderDiv.style.display = 'block';
                        console.log(`   ‚úÖ ${serviceTyp}-felder angezeigt`);
                    } else {
                        console.warn(`   ‚ö†Ô∏è ${serviceTyp}-felder nicht gefunden f√ºr Service: ${serviceTyp}`);
                    }
                    console.log(`‚ú® Single-Service: ${serviceTyp}-felder angezeigt`);
                }

            } catch (error) {
                console.error('‚ùå toggleServiceFelder Error:', error);
            }
        }

        // ============================================
        // GATHER SERVICE-DETAILS (Pattern 34 - FIX: Nov 17, 2025)
        // ============================================

        function gatherServiceDetails() {
            const details = {};

            // üÜï BUGFIX 2025-11-18: Conditional assignment to prevent undefined values in Firestore

            // Reifen
            const reifengroesse = document.getElementById('reifengroesse')?.value;
            const reifentyp = document.getElementById('reifentyp')?.value;
            const reifenanzahl = document.getElementById('reifenanzahl')?.value;
            if (reifengroesse || reifentyp || reifenanzahl) {
                if (reifengroesse) details.reifengroesse = reifengroesse;
                if (reifentyp) details.reifentyp = reifentyp;
                if (reifenanzahl) details.reifenanzahl = reifenanzahl;
            }

            // Mechanik
            const mechanikProblem = document.getElementById('mechanik-problem')?.value;
            const mechanikSymptome = document.getElementById('mechanik-symptome')?.value;
            if (mechanikProblem || mechanikSymptome) {
                if (mechanikProblem) details.mechanikProblem = mechanikProblem;
                if (mechanikSymptome) details.mechanikSymptome = mechanikSymptome;
            }

            // Lackierung
            const farbname = document.getElementById('farbname')?.value;
            const farbvariante = document.getElementById('farbvariante')?.value;
            const farbnummer = document.getElementById('farbnummer')?.value;
            const lackart = document.querySelector('input[name="lackart"]:checked')?.value;
            if (farbname || farbvariante || farbnummer || lackart) {
                if (farbname) details.farbname = farbname;
                if (farbvariante) details.farbvariante = farbvariante;
                if (farbnummer) details.farbnummer = farbnummer;
                if (lackart) details.lackart = lackart;
            }

            // Glas
            const scheibentyp = document.getElementById('scheibentyp')?.value;
            const schadensgroesse = document.getElementById('schadensgroesse')?.value;
            const glasposition = document.getElementById('glasposition')?.value;
            if (scheibentyp || schadensgroesse || glasposition) {
                if (scheibentyp) details.scheibentyp = scheibentyp;
                if (schadensgroesse) details.schadensgroesse = schadensgroesse;
                if (glasposition) details.glasposition = glasposition;
            }

            // Klima
            const klimaservice = document.getElementById('klimaservice')?.value;
            const kaeltemittel = document.getElementById('kaeltemittel')?.value;
            const klimaproblem = document.getElementById('klimaproblem')?.value;
            if (klimaservice || kaeltemittel || klimaproblem) {
                if (klimaservice) details.klimaservice = klimaservice;
                if (kaeltemittel) details.kaeltemittel = kaeltemittel;
                if (klimaproblem) details.klimaproblem = klimaproblem;
            }

            // Dellen
            const dellenanzahl = document.getElementById('dellenanzahl')?.value;
            const dellengroesse = document.getElementById('dellengroesse')?.value;
            const lackschaden = document.getElementById('lackschaden')?.value;
            const dellenpositionen = document.getElementById('dellenpositionen')?.value;
            if (dellenanzahl || dellengroesse || lackschaden || dellenpositionen) {
                if (dellenanzahl) details.dellenanzahl = dellenanzahl;
                if (dellengroesse) details.dellengroesse = dellengroesse;
                if (lackschaden) details.lackschaden = lackschaden;
                if (dellenpositionen) details.dellenpositionen = dellenpositionen;
            }

            // Versicherung
            const schadensnummer = document.getElementById('versicherung-schadensnummer')?.value;
            const versicherung = document.getElementById('versicherung-name')?.value;
            const schadendatum = document.getElementById('versicherung-schadendatum')?.value;
            const unfallhergang = document.getElementById('versicherung-hergang')?.value;
            if (schadensnummer || versicherung || schadendatum || unfallhergang) {
                if (schadensnummer) details.schadensnummer = schadensnummer;
                if (versicherung) details.versicherung = versicherung;
                if (schadendatum) details.schadendatum = schadendatum;
                if (unfallhergang) details.unfallhergang = unfallhergang;
            }

            // Pflege
            const paket = document.getElementById('pflege-paket')?.value;
            const zusatzleistungen = document.getElementById('pflege-zusatz')?.value;
            if (paket || zusatzleistungen) {
                if (paket) details.paket = paket;
                if (zusatzleistungen) details.zusatzleistungen = zusatzleistungen;
            }

            // T√úV
            const pruefart = document.getElementById('tuev-pruefart')?.value;
            const faelligkeit = document.getElementById('tuev-faelligkeit')?.value;
            const bekannteMaengel = document.getElementById('tuev-maengel')?.value;
            if (pruefart || faelligkeit || bekannteMaengel) {
                if (pruefart) details.pruefart = pruefart;
                if (faelligkeit) details.faelligkeit = faelligkeit;
                if (bekannteMaengel) details.bekannteMaengel = bekannteMaengel;
            }

            // Folierung
            const folierungArt = document.getElementById('folierungArt')?.value;
            const folierungMaterial = document.getElementById('folierungMaterial')?.value;
            const folierungFarbe = document.getElementById('folierungFarbe')?.value;
            const folierungInfo = document.getElementById('folierungInfo')?.value;
            if (folierungArt || folierungMaterial || folierungFarbe || folierungInfo) {
                if (folierungArt) details.folierungArt = folierungArt;
                if (folierungMaterial) details.folierungMaterial = folierungMaterial;
                if (folierungFarbe) details.folierungFarbe = folierungFarbe;
                if (folierungInfo) details.folierungInfo = folierungInfo;
            }

            // Steinschutz
            const steinschutzUmfang = document.getElementById('steinschutzUmfang')?.value;
            const steinschutzMaterial = document.getElementById('steinschutzMaterial')?.value;
            const steinschutzInfo = document.getElementById('steinschutzInfo')?.value;
            if (steinschutzUmfang || steinschutzMaterial || steinschutzInfo) {
                if (steinschutzUmfang) details.steinschutzUmfang = steinschutzUmfang;
                if (steinschutzMaterial) details.steinschutzMaterial = steinschutzMaterial;
                if (steinschutzInfo) details.steinschutzInfo = steinschutzInfo;
            }

            // Werbebeklebung
            const werbebeklebungUmfang = document.getElementById('werbebeklebungUmfang')?.value;
            const werbebeklebungKomplexitaet = document.getElementById('werbebeklebungKomplexitaet')?.value;
            const werbebeklebungText = document.getElementById('werbebeklebungText')?.value;
            const werbebeklebungInfo = document.getElementById('werbebeklebungInfo')?.value;
            if (werbebeklebungUmfang || werbebeklebungKomplexitaet || werbebeklebungText || werbebeklebungInfo) {
                if (werbebeklebungUmfang) details.werbebeklebungUmfang = werbebeklebungUmfang;
                if (werbebeklebungKomplexitaet) details.werbebeklebungKomplexitaet = werbebeklebungKomplexitaet;
                if (werbebeklebungText) details.werbebeklebungText = werbebeklebungText;
                if (werbebeklebungInfo) details.werbebeklebungInfo = werbebeklebungInfo;
            }

            console.log('üìã Service-Details gesammelt:', details);
            return Object.keys(details).length > 0 ? details : null;
        }

        // ============================================
        // SAVE ENTWURF (Update intermediate state)
        // ============================================

        async function saveEntwurf() {
            try {
                console.log('üíæ === ENTWURF AKTUALISIEREN ===');

                if (!currentEntwurfId) {
                    throw new Error('Kein Entwurf ausgew√§hlt');
                }

                // Show loading
                const saveBtn = document.getElementById('saveBtn');
                const originalText = saveBtn.textContent;
                saveBtn.innerHTML = '<span class="loading"></span> Speichert...';

                // üîß BUG #9 FIX (2025-11-20): Email-Format-Validierung
                const kundenEmail = document.getElementById('kundenEmail').value.trim();
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!kundenEmail || !emailRegex.test(kundenEmail)) {
                    saveBtn.innerHTML = originalText;
                    toast.error('‚ùå Ung√ºltige Email-Adresse. Bitte geben Sie eine g√ºltige Email ein.');
                    return;
                }

                // Gather data
                const updatedData = {
                    kundenname: document.getElementById('kundenname').value.trim(),
                    kundenEmail: document.getElementById('kundenEmail').value.trim().toLowerCase(),
                    telefon: document.getElementById('telefon').value.trim(),
                    marke: document.getElementById('marke').value.trim(),
                    modell: document.getElementById('modell').value.trim(),
                    baujahrVon: document.getElementById('baujahrVon').value.trim(),
                    kmstand: document.getElementById('kmstand').value.trim(),
                    vin: document.getElementById('vin').value.trim(),
                    // ‚úÖ serviceTyp is READ-ONLY (Pattern 21 - NEVER overwrite!) - set by Meister, cannot be changed here
                    notizen: document.getElementById('notizen').value.trim(),
                    vereinbarterPreis: parseFloat(document.getElementById('vereinbarterPreis').value) || 0,  // FIX: Nov 17, 2025 - BUG #2 (type consistency)
                    geplantesAbnahmeDatum: document.getElementById('geplantesAbnahmeDatum').value,
                    updatedAt: new Date().toISOString(),

                    // üöó Ersatzfahrzeug (FIX: Nov 27, 2025)
                    ersatzfahrzeugGewuenscht: document.getElementById('ersatzfahrzeugGewuenscht')?.checked || false,
                    zugewiesenesErsatzfahrzeug: document.getElementById('zugewiesenesErsatzfahrzeug')?.value || null,

                    // Kalkulations-Tabellen Daten
                    kalkulationData: {
                        ersatzteile: ersatzteileData,
                        arbeitslohn: arbeitslohnData,
                        lackierung: lackierungData,
                        materialien: materialienData
                    },

                    // üîß Service-Details (Pattern 34 - FIX: Nov 17, 2025)
                    serviceDetails: gatherServiceDetails(),

                    // üñºÔ∏è Fotos & Unterschrift (Phase 3)
                    photoUrls: photos,  // ‚úÖ FIX Bug #7 (2025-11-23): Standardized field name (was: fotos)
                    signature: signatureData
                };

                // Update Firestore
                const werkstattId = window.werkstattId; // ‚úÖ SECURITY FIX: No 'mosbach' fallback
                const collectionName = `partnerAnfragen_${werkstattId}`;

                await window.db.collection(collectionName)
                    .doc(currentEntwurfId)
                    .update(updatedData);

                console.log('‚úÖ Entwurf aktualisiert');

                // üöó PHASE 2: Status-Sync + Kalender-Event bei Leihfahrzeug-Zuweisung
                const zugewiesenesErsatzfahrzeug = document.getElementById('zugewiesenesErsatzfahrzeug')?.value;
                if (zugewiesenesErsatzfahrzeug) {
                    try {
                        // 1. Leihfahrzeug-Dokument laden f√ºr Kennzeichen
                        const leihfahrzeugDoc = await window.db.collection(`leihfahrzeuge_${werkstattId}`).doc(zugewiesenesErsatzfahrzeug).get();
                        const leihfahrzeugData = leihfahrzeugDoc.exists ? leihfahrzeugDoc.data() : {};
                        const leihfahrzeugKennzeichen = leihfahrzeugData.kennzeichen || 'Leihfahrzeug';

                        // 2. Leihfahrzeug-Status auf "vergeben" setzen
                        await window.db.collection(`leihfahrzeuge_${werkstattId}`).doc(zugewiesenesErsatzfahrzeug).update({
                            status: 'vergeben',
                            aktuelleZuweisung: {
                                kundenName: document.getElementById('kundenname').value.trim(),
                                fahrzeugKennzeichen: document.getElementById('kennzeichen')?.value || '',
                                entwurfId: currentEntwurfId,
                                von: new Date().toISOString(),
                                bis: document.getElementById('geplantesAbnahmeDatum').value || null
                            }
                        });
                        console.log('üöó Leihfahrzeug-Status auf "vergeben" gesetzt');

                        // 3. Kalender-Event erstellen
                        const kalenderEvent = {
                            typ: 'leihfahrzeug',
                            titel: `üöó ${leihfahrzeugKennzeichen} ‚Üí ${document.getElementById('kundenname').value.trim()}`,
                            start: new Date().toISOString(),
                            ende: document.getElementById('geplantesAbnahmeDatum').value || null,
                            fahrzeugId: zugewiesenesErsatzfahrzeug,
                            leihfahrzeugKennzeichen: leihfahrzeugKennzeichen,
                            entwurfId: currentEntwurfId,
                            kundenKennzeichen: document.getElementById('kennzeichen')?.value || '',
                            status: 'aktiv',
                            werkstattId: werkstattId,
                            createdAt: new Date().toISOString()
                        };
                        await window.db.collection(`kalenderEvents_${werkstattId}`).add(kalenderEvent);
                        console.log('üìÖ Kalender-Event f√ºr Leihfahrzeug erstellt');

                    } catch (leihfahrzeugError) {
                        console.error('‚ö†Ô∏è Leihfahrzeug-Sync Fehler (Entwurf wurde trotzdem gespeichert):', leihfahrzeugError);
                    }
                }

                // Reset button
                saveBtn.innerHTML = '<i data-feather="check"></i> Gespeichert!';
                feather.replace();
                setTimeout(() => {
                    saveBtn.textContent = originalText;
                    feather.replace();
                }, 2000);

                showToast('‚úÖ Entwurf aktualisiert', 'success', 3000);

            } catch (error) {
                console.error('‚ùå Fehler beim Speichern:', error);
                showToast(`‚ùå Fehler: ${error.message}`, 'error', 6000);
                document.getElementById('saveBtn').textContent = 'Entwurf aktualisieren';
                feather.replace();
            }
        }

        // ============================================
        // ZENTRALE DATENBANKEN - KALKULATIONS-DATA
        // ============================================

        /**
         * Speichert Ersatzteile in zentrale Ersatzteile-DB (ersatzteile_{werkstattId})
         * Erm√∂glicht sp√§tere Statistiken, API-Integrationen und Ersatzteil-Suche
         * @param {Array} ersatzteile - Array von Ersatzteilen (ersatzteileData)
         * @param {string} fahrzeugId - ID des Fahrzeugs
         * @param {string} kennzeichen - Kennzeichen des Fahrzeugs
         * @param {string} kundenname - Name des Kunden
         * @returns {Promise<number>} Anzahl der gespeicherten Ersatzteile
         */
        async function saveErsatzteileToCentralDB(ersatzteile, fahrzeugId, kennzeichen, kundenname) {
            if (!ersatzteile || ersatzteile.length === 0) {
                console.log('‚ÑπÔ∏è Keine Ersatzteile zum Speichern');
                return 0;
            }

            if (!window.db) {
                console.error('‚ùå Firebase nicht initialisiert');
                return 0;
            }

            console.log(`üóÑÔ∏è Speichere ${ersatzteile.length} Ersatzteile in zentrale DB (ersatzteile_${window.werkstattId})...`);

            // üîß BUG #8 FIX #7 (2025-11-20): Use firebase.auth() instead of broken window.currentUser
            const currentUser = firebase.auth().currentUser;
            const userName = currentUser?.displayName || currentUser?.email || localStorage.getItem('userName') || 'B√ºro';
            const userId = currentUser?.uid || null;
            const userEmail = currentUser?.email || null;

            const werkstattId = window.werkstattId; // ‚úÖ SECURITY FIX: No 'mosbach' fallback
            const batch = window.db.batch();
            let successCount = 0;

            for (const teil of ersatzteile) {
                try {
                    const ersatzteilId = 'et_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

                    // Zentrale Ersatzteil-Daten
                    const ersatzteilData = {
                        id: ersatzteilId,
                        etn: teil.etn || '',
                        benennung: teil.benennung || '',
                        einzelpreis: teil.einzelpreis || 0,
                        // Referenz-Daten
                        fahrzeugId: fahrzeugId,
                        kennzeichen: kennzeichen,
                        kundenname: kundenname,
                        // Meta-Daten
                        werkstattId: werkstattId,
                        createdAt: new Date().toISOString(),
                        createdBy: userName,
                        createdByUserId: userId,  // üÜï FIX: User-ID f√ºr eindeutige Zuordnung
                        createdByEmail: userEmail,  // üÜï FIX: Email f√ºr Compliance
                        // Optional: Anzahl aus diesem spezifischen Auftrag
                        anzahlInAuftrag: teil.anzahl || 1,
                        gesamtpreisInAuftrag: teil.gesamtpreis || 0
                    };

                    // In Batch hinzuf√ºgen
                    const docRef = window.getCollection('ersatzteile').doc(ersatzteilId);
                    batch.set(docRef, ersatzteilData);

                    successCount++;
                } catch (error) {
                    console.error('‚ùå Fehler beim Speichern von Ersatzteil:', teil, error);
                }
            }

            // Batch commit
            try {
                await batch.commit();
                console.log(`‚úÖ ${successCount} Ersatzteile erfolgreich in zentraler DB gespeichert`);
                return successCount;
            } catch (error) {
                console.error('‚ùå Batch-Commit fehlgeschlagen:', error);
                throw error;
            }
        }

        /**
         * Speichert Arbeitslohn in zentrale Arbeitslohn-DB (arbeitslohn_{werkstattId})
         * Erm√∂glicht sp√§tere Durchschnittspreise und Standard-T√§tigkeiten
         * @param {Array} arbeitslohn - Array von Arbeitslohn-Positionen
         * @param {string} fahrzeugId - ID des Fahrzeugs
         * @param {string} kennzeichen - Kennzeichen des Fahrzeugs
         * @param {string} kundenname - Name des Kunden
         * @returns {Promise<number>} Anzahl der gespeicherten Positionen
         */
        async function saveArbeitslohnToCentralDB(arbeitslohn, fahrzeugId, kennzeichen, kundenname) {
            if (!arbeitslohn || arbeitslohn.length === 0) {
                console.log('‚ÑπÔ∏è Kein Arbeitslohn zum Speichern');
                return 0;
            }

            console.log(`üóÑÔ∏è Speichere ${arbeitslohn.length} Arbeitslohn-Positionen in zentrale DB...`);

            const userName = window.currentUser?.name || localStorage.getItem('userName') || 'B√ºro';
            const werkstattId = window.werkstattId; // ‚úÖ SECURITY FIX: No 'mosbach' fallback
            const batch = window.db.batch();
            let successCount = 0;

            for (const position of arbeitslohn) {
                try {
                    const positionId = 'al_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

                    const positionData = {
                        id: positionId,
                        taetigkeit: position.taetigkeit || '',
                        stundensatz: position.stundensatz || 0,
                        stunden: position.stunden || 0,
                        gesamtpreis: position.gesamtpreis || 0,
                        // Referenz-Daten
                        fahrzeugId: fahrzeugId,
                        kennzeichen: kennzeichen,
                        kundenname: kundenname,
                        // Meta-Daten
                        werkstattId: werkstattId,
                        createdAt: new Date().toISOString(),
                        createdBy: userName
                    };

                    const docRef = window.getCollection('arbeitslohn').doc(positionId);
                    batch.set(docRef, positionData);
                    successCount++;
                } catch (error) {
                    console.error('‚ùå Fehler beim Speichern von Arbeitslohn:', position, error);
                }
            }

            try {
                await batch.commit();
                console.log(`‚úÖ ${successCount} Arbeitslohn-Positionen gespeichert`);
                return successCount;
            } catch (error) {
                console.error('‚ùå Batch-Commit fehlgeschlagen:', error);
                throw error;
            }
        }

        /**
         * Speichert Lackierung in zentrale Lackierung-DB (lackierung_{werkstattId})
         * Erm√∂glicht sp√§tere Preisstatistiken und m¬≤-Berechnungen
         * @param {Array} lackierung - Array von Lackierungs-Positionen
         * @param {string} fahrzeugId - ID des Fahrzeugs
         * @param {string} kennzeichen - Kennzeichen des Fahrzeugs
         * @param {string} kundenname - Name des Kunden
         * @returns {Promise<number>} Anzahl der gespeicherten Positionen
         */
        async function saveLackierungToCentralDB(lackierung, fahrzeugId, kennzeichen, kundenname) {
            if (!lackierung || lackierung.length === 0) {
                console.log('‚ÑπÔ∏è Keine Lackierung zum Speichern');
                return 0;
            }

            console.log(`üóÑÔ∏è Speichere ${lackierung.length} Lackierungs-Positionen in zentrale DB...`);

            const userName = window.currentUser?.name || localStorage.getItem('userName') || 'B√ºro';
            const werkstattId = window.werkstattId; // ‚úÖ SECURITY FIX: No 'mosbach' fallback
            const batch = window.db.batch();
            let successCount = 0;

            for (const position of lackierung) {
                try {
                    const positionId = 'lack_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

                    const positionData = {
                        id: positionId,
                        teil: position.teil || '',
                        m2: position.m2 || 0,
                        preis_pro_m2: position.preis_pro_m2 || 0,
                        gesamtpreis: position.gesamtpreis || 0,
                        // Referenz-Daten
                        fahrzeugId: fahrzeugId,
                        kennzeichen: kennzeichen,
                        kundenname: kundenname,
                        // Meta-Daten
                        werkstattId: werkstattId,
                        createdAt: new Date().toISOString(),
                        createdBy: userName
                    };

                    const docRef = window.getCollection('lackierung').doc(positionId);
                    batch.set(docRef, positionData);
                    successCount++;
                } catch (error) {
                    console.error('‚ùå Fehler beim Speichern von Lackierung:', position, error);
                }
            }

            try {
                await batch.commit();
                console.log(`‚úÖ ${successCount} Lackierungs-Positionen gespeichert`);
                return successCount;
            } catch (error) {
                console.error('‚ùå Batch-Commit fehlgeschlagen:', error);
                throw error;
            }
        }

        /**
         * Speichert Materialien in zentrale Materialien-DB (materialien_{werkstattId})
         * Erm√∂glicht sp√§tere Material-Statistiken und Bestandsverwaltung
         * @param {Array} materialien - Array von Material-Positionen
         * @param {string} fahrzeugId - ID des Fahrzeugs
         * @param {string} kennzeichen - Kennzeichen des Fahrzeugs
         * @param {string} kundenname - Name des Kunden
         * @returns {Promise<number>} Anzahl der gespeicherten Positionen
         */
        async function saveMaterialienToCentralDB(materialien, fahrzeugId, kennzeichen, kundenname) {
            if (!materialien || materialien.length === 0) {
                console.log('‚ÑπÔ∏è Keine Materialien zum Speichern');
                return 0;
            }

            console.log(`üóÑÔ∏è Speichere ${materialien.length} Material-Positionen in zentrale DB...`);

            const userName = window.currentUser?.name || localStorage.getItem('userName') || 'B√ºro';
            const werkstattId = window.werkstattId; // ‚úÖ SECURITY FIX: No 'mosbach' fallback
            const batch = window.db.batch();
            let successCount = 0;

            for (const material of materialien) {
                try {
                    const materialId = 'mat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

                    const materialData = {
                        id: materialId,
                        material: material.material || '',
                        einheit: material.einheit || '',
                        menge: material.menge || 0,
                        einzelpreis: material.einzelpreis || 0,
                        gesamtpreis: material.gesamtpreis || 0,
                        // Referenz-Daten
                        fahrzeugId: fahrzeugId,
                        kennzeichen: kennzeichen,
                        kundenname: kundenname,
                        // Meta-Daten
                        werkstattId: werkstattId,
                        createdAt: new Date().toISOString(),
                        createdBy: userName
                    };

                    const docRef = window.getCollection('materialien').doc(materialId);
                    batch.set(docRef, materialData);
                    successCount++;
                } catch (error) {
                    console.error('‚ùå Fehler beim Speichern von Material:', material, error);
                }
            }

            try {
                await batch.commit();
                console.log(`‚úÖ ${successCount} Material-Positionen gespeichert`);
                return successCount;
            } catch (error) {
                console.error('‚ùå Batch-Commit fehlgeschlagen:', error);
                throw error;
            }
        }

        // ============================================
        // ERSTELLE ANGEBOT & VERSENDE
        // ============================================

        async function erstelleAngebot() {
            try {
                console.log('üì§ === ANGEBOT ERSTELLEN & VERSENDEN ===');

                if (!currentEntwurfId) {
                    throw new Error('Kein Entwurf ausgew√§hlt');
                }

                // Validation
                const requiredFields = {
                    'Kundenname': document.getElementById('kundenname').value.trim(),
                    'Kunden-Email': document.getElementById('kundenEmail').value.trim(),
                    'Marke': document.getElementById('marke').value.trim(),
                    'Modell': document.getElementById('modell').value.trim(),
                    'Notizen': document.getElementById('notizen').value.trim(),
                    'Preis': document.getElementById('vereinbarterPreis').value.trim(),
                    'Fertigstellungsdatum': document.getElementById('geplantesAbnahmeDatum').value.trim(),
                };

                for (const [field, value] of Object.entries(requiredFields)) {
                    if (!value) {
                        showToast(`‚ö†Ô∏è Bitte f√ºllen Sie das Feld "${field}" aus!`, 'error', 5000);
                        return;
                    }
                }

                // Email format validation
                const email = document.getElementById('kundenEmail').value.trim().toLowerCase();
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    showToast('‚ö†Ô∏è Ung√ºltige Email-Adresse!', 'error', 5000);
                    return;
                }

                // Show loading
                const sendBtn = document.getElementById('sendBtn');
                const originalText = sendBtn.textContent;
                sendBtn.innerHTML = '<span class="loading"></span> Wird versendet...';

                // Step 1: Ensure Partner Account exists
                console.log('üîê Step 1: Partner Account sicherstellen...');
                const ensurePartnerAccount = window.functions.httpsCallable('ensurePartnerAccount');
                const accountResult = await ensurePartnerAccount({
                    email: email,
                    name: document.getElementById('kundenname').value.trim() || 'Kunde',  // ‚úÖ FIX: Fallback for empty name (Bug #22 Regression)
                    werkstattId: window.werkstattId
                });

                console.log('‚úÖ Partner Account:', accountResult.data);

                // üÜî Extract partnerId (FIX: Nov 17, 2025 - Pipeline Data Mapping)
                const partnerId = accountResult.data.partnerId;

                // ‚úÖ VALIDATE partnerId exists (FIX: Nov 17, 2025 - BUG #3)
                if (!partnerId) {
                    console.error('‚ùå ensurePartnerAccount returned:', accountResult.data);
                    throw new Error('Partner-ID konnte nicht erstellt werden. Bitte erneut versuchen.');
                }

                console.log('üìå Partner ID:', partnerId);

                // Step 2: Create Auto-Login Token
                console.log('üîë Step 2: Auto-Login Token erstellen...');
                const createToken = window.functions.httpsCallable('createPartnerAutoLoginToken');
                const tokenResult = await createToken({
                    email: email,
                });

                const autoLoginToken = tokenResult.data.token;
                console.log('‚úÖ Auto-Login Token erstellt');

                // Step 3: Generate QR Code URL
                const baseUrl = window.location.origin + window.location.pathname.replace(/[^/]+$/, '');
                const qrCodeUrl = `${baseUrl}partner-app/auto-login.html?token=${autoLoginToken}`;
                console.log('üîó QR-Code URL:', qrCodeUrl);

                // üîÑ BUGFIX: Email-First Pattern (prevents inconsistent state)
                // OLD: Update Firestore ‚Üí Send Email (if email fails ‚Üí status inconsistent!)
                // NEW: Send Email ‚Üí Update Firestore (only if email succeeds)

                // Step 4: Send Email FIRST (before status change)
                console.log('üìß Step 4: Email versenden (BEFORE status update)...');
                const sendEmail = window.functions.httpsCallable('sendEntwurfEmail');
                const emailResult = await sendEmail({
                    kundenEmail: email,
                    kundenname: document.getElementById('kundenname').value.trim(),
                    kennzeichen: document.getElementById('kennzeichen').value.trim(),
                    qrCodeUrl: qrCodeUrl,
                    fahrzeugId: currentEntwurfId,
                });

                // ‚úÖ PATTERN 31: Check for Demo Mode (SendGrid API Key invalid/missing)
                if (emailResult.data.demoMode) {
                    console.warn('‚ö†Ô∏è [DEMO MODE] Email nicht versendet:', emailResult.data.message);
                    showToast('‚ö†Ô∏è Demo-Modus: Email-Versand √ºbersprungen.\n\nAngebot wird trotzdem erstellt, aber Email wird NICHT versendet.\n\nüí° Tipp: SendGrid API Key in Firebase Secret Manager aktualisieren.', 'warning', 8000);
                } else {
                    console.log('‚úÖ Email versendet');
                }

                // Step 5: Update Entwurf Status ONLY AFTER successful email
                console.log('üìù Step 5: Entwurf-Status aktualisieren (nach erfolgreicher Email)...');
                const werkstattId = window.werkstattId; // ‚úÖ SECURITY FIX: No 'mosbach' fallback
                const collectionName = `partnerAnfragen_${werkstattId}`;

                const angebotDetails = {
                    preis: parseFloat(document.getElementById('vereinbarterPreis').value),
                    serviceBeschreibung: document.getElementById('notizen').value.trim(),
                    fertigstellungsdatum: document.getElementById('geplantesAbnahmeDatum').value,
                    erstelltAm: new Date().toISOString(),
                    erstelltVon: window.currentUser?.name || 'B√ºro',
                };

                await window.db.collection(collectionName).doc(currentEntwurfId).update({
                    // Update all fields
                    kundenname: document.getElementById('kundenname').value.trim(),
                    kennzeichen: document.getElementById('kennzeichen').value.trim(),  // FIX: Nov 17, 2025 - BUG #4
                    kundenEmail: email,
                    telefon: document.getElementById('telefon').value.trim(),
                    marke: document.getElementById('marke').value.trim(),
                    modell: document.getElementById('modell').value.trim(),
                    baujahrVon: document.getElementById('baujahrVon').value.trim(),
                    kmstand: document.getElementById('kmstand').value.trim(),
                    vin: document.getElementById('vin').value.trim(),
                    // ‚úÖ serviceTyp is READ-ONLY (Pattern 21) - NEVER overwrite (already set by Meister)
                    notizen: document.getElementById('notizen').value.trim(),
                    vereinbarterPreis: parseFloat(document.getElementById('vereinbarterPreis').value),
                    geplantesAbnahmeDatum: document.getElementById('geplantesAbnahmeDatum').value,

                    // üÜî Partner ID Mapping (FIX: Nov 17, 2025 - enables partner to see offers!)
                    partnerId: partnerId,

                    // Change entwurf status (ONLY after successful email!)
                    entwurfStatus: 'angebot_erstellt',
                    status: 'kva_gesendet',

                    // Save offer details
                    angebotDetails: angebotDetails,

                    // Kalkulations-Tabellen Daten
                    kalkulationData: {
                        ersatzteile: ersatzteileData,
                        arbeitslohn: arbeitslohnData,
                        lackierung: lackierungData,
                        materialien: materialienData
                    },

                    // üîß Service-Details (Pattern 34 - FIX: Nov 17, 2025)
                    serviceDetails: gatherServiceDetails(),

                    // üñºÔ∏è Fotos & Unterschrift (Phase 3)
                    photoUrls: photos,  // ‚úÖ FIX: Korrekter Feldname (preserviert Original)
                    signature: signatureData,

                    // Metadata
                    angebotErstelltAm: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),

                    // üîß BUG #8 FIX #5 (2025-11-20): Add lastModifiedBy audit trail
                    lastModifiedBy: firebase.auth().currentUser?.displayName || firebase.auth().currentUser?.email || 'B√ºro',
                    lastModifiedByUserId: firebase.auth().currentUser?.uid || null,
                    lastModifiedByEmail: firebase.auth().currentUser?.email || null,
                    lastModified: firebase.firestore.FieldValue.serverTimestamp()
                });

                console.log('‚úÖ Entwurf-Status aktualisiert (Email + Status update komplett)');

                // üóÑÔ∏è Step 5b: Speichere Kalkulations-Daten in zentrale Datenbanken (f√ºr Automatisierung & Preisvorschl√§ge)
                console.log('üóÑÔ∏è Step 5b: Speichere Kalkulations-Daten in zentrale DBs...');
                try {
                    const kennzeichen = document.getElementById('kennzeichen').value.trim();
                    const kundenname = document.getElementById('kundenname').value.trim();

                    // ‚úÖ Phase 1: Ersatzteile speichern
                    if (ersatzteileData && ersatzteileData.length > 0) {
                        await saveErsatzteileToCentralDB(ersatzteileData, currentEntwurfId, kennzeichen, kundenname);
                    }

                    // ‚úÖ Phase 2: Arbeitslohn speichern
                    if (arbeitslohnData && arbeitslohnData.length > 0) {
                        await saveArbeitslohnToCentralDB(arbeitslohnData, currentEntwurfId, kennzeichen, kundenname);
                    }

                    // ‚úÖ Phase 3: Lackierung speichern
                    if (lackierungData && lackierungData.length > 0) {
                        await saveLackierungToCentralDB(lackierungData, currentEntwurfId, kennzeichen, kundenname);
                    }

                    // ‚úÖ Phase 4: Materialien speichern
                    if (materialienData && materialienData.length > 0) {
                        await saveMaterialienToCentralDB(materialienData, currentEntwurfId, kennzeichen, kundenname);
                    }

                    console.log('‚úÖ Alle Kalkulations-Daten in zentrale DBs gespeichert');
                } catch (error) {
                    console.error('‚ö†Ô∏è Fehler beim Speichern in zentrale DBs (nicht-kritisch):', error);
                    // Non-blocking error - continue with PDF generation
                }

                // Step 6: Generate PDF f√ºr Admin
                console.log('üìÑ Step 6: Generiere Kalkulation-PDF f√ºr Admin...');
                showToast('üìÑ Erstelle Kalkulation-PDF...', 'info', 3000);

                const generatePDF = window.functions.httpsCallable('generateAngebotPDF');
                const pdfResult = await generatePDF({
                    entwurfId: currentEntwurfId,
                    werkstattId: werkstattId
                });

                console.log('‚úÖ PDF generiert:', pdfResult.data.filename);

                // ‚úÖ FIX: Nov 17, 2025 - BUG #2 - Download PDF for B√ºro-Mitarbeiter
                console.log('üíæ Step 6b: Lade PDF herunter f√ºr B√ºro-Mitarbeiter...');
                try {
                    const pdfBlob = base64ToBlob(pdfResult.data.pdfBase64, 'application/pdf');
                    const downloadUrl = URL.createObjectURL(pdfBlob);
                    const downloadLink = document.createElement('a');
                    downloadLink.href = downloadUrl;
                    downloadLink.download = pdfResult.data.filename;
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                    URL.revokeObjectURL(downloadUrl);
                    console.log('‚úÖ PDF heruntergeladen:', pdfResult.data.filename);
                } catch (downloadError) {
                    console.error('‚ö†Ô∏è PDF-Download fehlgeschlagen (aber Email wird trotzdem gesendet):', downloadError);
                    // Continue with email sending even if download fails
                }

                // Step 7: Send PDF to Admin
                console.log('üìß Step 7: Sende Kalkulation-PDF an Admin...');
                showToast('üìß Sende Email an Admin...', 'info', 3000);

                const sendAdminEmail = window.functions.httpsCallable('sendAngebotPDFToAdmin');
                const adminEmailResult = await sendAdminEmail({
                    pdfBase64: pdfResult.data.pdfBase64,
                    filename: pdfResult.data.filename,
                    entwurfId: currentEntwurfId,
                    werkstattId: werkstattId,
                    kennzeichen: document.getElementById('kennzeichen').value.trim(),
                    kundenname: document.getElementById('kundenname').value.trim(),
                    vereinbarterPreis: document.getElementById('vereinbarterPreis').value
                });

                // ‚úÖ BUG #4 FIX: Check for email skip
                if (adminEmailResult.data && adminEmailResult.data.emailSkipped) {
                    console.warn('‚ö†Ô∏è Admin-Email wurde √ºbersprungen (erwartet):', adminEmailResult.data.message);
                    showToast(
                        '‚ÑπÔ∏è PDF erstellt, aber Admin-Email √ºbersprungen (SendGrid deaktiviert).\n\nüí° Tipp: Laden Sie das PDF manuell herunter.',
                        'info',
                        6000
                    );
                } else {
                    console.log('‚úÖ Admin-Email versendet');
                }

                // Step 8: Success!
                sendBtn.innerHTML = '<i data-feather="check"></i> Versendet!';
                feather.replace();

                // Show success message
                const successMsg = document.getElementById('successMessage');
                successMsg.classList.add('show');

                showToast('‚úÖ Angebot erfolgreich versendet!', 'success', 4000);

                // Redirect after 2 seconds
                setTimeout(() => {
                    safeNavigate('liste.html');
                }, 2000);

            } catch (error) {
                console.error('‚ùå Fehler beim Versenden des Angebots:', error);

                // ‚úÖ IMPROVED: Context-specific error messages (FIX: Nov 17, 2025 - BUG #6)
                let errorMsg = '‚ùå Fehler beim Versenden des Angebots.\n\n';

                if (error.message.includes('Partner-Account') || error.message.includes('ensurePartnerAccount') || error.message.includes('Partner-ID')) {
                    errorMsg += 'üë§ Partner-Account konnte nicht erstellt werden.\n\n';
                    errorMsg += `Details: ${error.message}\n\n`;
                    errorMsg += 'üí° Tipp: Pr√ºfen Sie die Kunden-Email und versuchen Sie es erneut.';
                } else if (error.message.includes('Email') || error.message.includes('sendEntwurfEmail')) {
                    errorMsg += 'üìß Email konnte nicht versendet werden.\n\n';

                    // ‚úÖ PATTERN 31: Check if it's a SendGrid API Key issue
                    if (error.message.toLowerCase().includes('unauthorized') ||
                        error.message.toLowerCase().includes('api key') ||
                        error.message.toLowerCase().includes('sendgrid')) {
                        errorMsg += 'üîê SendGrid API Key Problem:\n';
                        errorMsg += '‚Ä¢ API Key ist ung√ºltig oder abgelaufen\n';
                        errorMsg += '‚Ä¢ API Key wurde nicht konfiguriert\n\n';
                        errorMsg += 'üí° L√∂sung:\n';
                        errorMsg += '1. Neuen SendGrid API Key erstellen (https://app.sendgrid.com)\n';
                        errorMsg += '2. In Firebase Secret Manager aktualisieren:\n';
                        errorMsg += '   firebase functions:secrets:set SENDGRID_API_KEY\n\n';
                        errorMsg += '‚ö†Ô∏è ACHTUNG: Workflow l√§uft jetzt im Demo-Modus!\n';
                        errorMsg += '   ‚Üí Angebot wird erstellt (OHNE Email-Versand)\n';
                        errorMsg += '   ‚Üí Kunde erh√§lt KEINE Email!';
                    } else {
                        errorMsg += 'M√∂gliche Gr√ºnde:\n';
                        errorMsg += '‚Ä¢ Ung√ºltige Email-Adresse\n';
                        errorMsg += '‚Ä¢ SendGrid-Fehler (Trial abgelaufen)\n';
                        errorMsg += '‚Ä¢ Netzwerkproblem\n\n';
                        errorMsg += 'üí° Tipp: Pr√ºfen Sie die Email-Adresse und versuchen Sie es erneut.\n';
                        errorMsg += '‚ö†Ô∏è Der Entwurf bleibt als "offen" gespeichert.';
                    }
                } else if (error.message.includes('Token') || error.message.includes('createPartnerAutoLoginToken')) {
                    errorMsg += 'üîë Auto-Login Token konnte nicht erstellt werden.\n\n';
                    errorMsg += `Details: ${error.message}\n\n`;
                    errorMsg += 'üí° Tipp: Versuchen Sie es erneut oder kontaktieren Sie den Support.';
                } else if (error.message.includes('PDF') || error.message.includes('generateAngebotPDF')) {
                    errorMsg += 'üìÑ PDF konnte nicht generiert werden.\n\n';
                    errorMsg += `Details: ${error.message}\n\n`;
                    errorMsg += 'üí° Tipp: Pr√ºfen Sie die Kalkulations-Daten und versuchen Sie es erneut.';
                } else if (error.message.includes('network') || error.message.includes('Network') || error.message.includes('fetch')) {
                    errorMsg += 'üåê Netzwerkfehler aufgetreten.\n\n';
                    errorMsg += 'M√∂gliche Gr√ºnde:\n';
                    errorMsg += '‚Ä¢ Keine Internetverbindung\n';
                    errorMsg += '‚Ä¢ Firebase-Server nicht erreichbar\n';
                    errorMsg += '‚Ä¢ Timeout\n\n';
                    errorMsg += 'üí° Tipp: Pr√ºfen Sie Ihre Internetverbindung und versuchen Sie es erneut.';
                } else {
                    errorMsg += `Details: ${error.message}\n\n`;
                    errorMsg += 'üí° Tipp: Bitte versuchen Sie es erneut oder kontaktieren Sie den Support.';
                }

                showToast(errorMsg, 'error', 10000);
                document.getElementById('sendBtn').textContent = 'Angebot erstellen & versenden';
                feather.replace();
            }
        }

        // ============================================
        // BUG #4 FIX: PDF RETRY FUNCTION
        // ============================================

        /**
         * Retry PDF Generation after previous failure
         * Clears error flags and retries generateAngebotPDF Cloud Function
         */
        async function retryPDFGeneration() {
            try {
                console.log('üîÑ === PDF RETRY STARTED ===');

                const retryBtn = document.getElementById('pdfRetryBtn');
                const retryBtnText = document.getElementById('retryBtnText');

                // Disable button and show loading state
                retryBtn.disabled = true;
                retryBtnText.textContent = 'Wird generiert...';
                feather.replace();

                const werkstattId = window.werkstattId; // ‚úÖ SECURITY FIX: No 'mosbach' fallback
                const collectionName = `partnerAnfragen_${werkstattId}`;

                if (!currentEntwurfId) {
                    throw new Error('Kein Entwurf ausgew√§hlt');
                }

                // Step 1: Clear previous error flags in Firestore
                console.log('üßπ Clearing error flags...');
                await window.db.collection(collectionName).doc(currentEntwurfId).update({
                    pdfGenerationFailed: firebase.firestore.FieldValue.delete(),
                    pdfGenerationError: firebase.firestore.FieldValue.delete(),
                    pdfGenerationFailedAt: firebase.firestore.FieldValue.delete()
                });

                // Step 2: Retry PDF generation
                console.log('üìÑ Retrying PDF generation...');
                const generatePDF = window.functions.httpsCallable('generateAngebotPDF');
                const pdfResult = await generatePDF({
                    entwurfId: currentEntwurfId,
                    werkstattId: werkstattId
                });

                console.log('‚úÖ PDF retry successful:', pdfResult.data.filename);
                showToast('‚úÖ PDF erfolgreich generiert!', 'success', 3000);

                // Hide retry button
                retryBtn.style.display = 'none';

                // Reset button state
                retryBtn.disabled = false;
                retryBtnText.textContent = 'PDF erneut generieren';
                feather.replace();

            } catch (error) {
                console.error('‚ùå PDF retry failed:', error);

                let errorMsg = '‚ùå PDF-Generierung fehlgeschlagen:\n\n';

                if (error.message.includes('PDF') || error.message.includes('generateAngebotPDF')) {
                    errorMsg += `${error.message}\n\n`;
                    errorMsg += 'üí° Tipp: Pr√ºfen Sie die Kalkulations-Daten und versuchen Sie es erneut.';
                } else {
                    errorMsg += `${error.message}`;
                }

                showToast(errorMsg, 'error', 10000);

                // Re-enable button
                const retryBtn = document.getElementById('pdfRetryBtn');
                const retryBtnText = document.getElementById('retryBtnText');
                retryBtn.disabled = false;
                retryBtnText.textContent = 'PDF erneut generieren';
                feather.replace();
            }
        }

        // ============================================
        // PDF UPLOAD & PARSING
        // ============================================

        // PDF Upload Event Handler
        const datPdfInput = document.getElementById('datPdfInput');
        if (datPdfInput) {
            datPdfInput.addEventListener('change', handlePdfUpload);
        }

        async function handlePdfUpload(event) {
            const file = event.target.files[0];
            if (!file || file.type !== 'application/pdf') {
                showToast('‚ùå Bitte w√§hlen Sie eine PDF-Datei', 'error');
                return;
            }

            // UI Feedback
            document.getElementById('pdfFileName').textContent = file.name;
            document.getElementById('pdfRemoveBtn').style.display = 'inline-block';

            try {
                let pdfExtraction;

                try {
                    // PRIMARY: OpenAI GPT-4 Vision
                    console.log('ü§ñ [PRIMARY] Trying OpenAI GPT-4 Vision...');
                    showToast('‚è≥ PDF wird analysiert mit AI...', 'info', 3000);
                    pdfExtraction = await parseWithOpenAI(file);
                    console.log('‚úÖ [PRIMARY] OpenAI parsing successful');
                } catch (openaiError) {
                    // FALLBACK: Regex-based parsing
                    console.warn('‚ö†Ô∏è [FALLBACK] OpenAI failed, using regex:', openaiError);
                    showToast('‚ö†Ô∏è AI-Parsing fehlgeschlagen, verwende Regex-Fallback...', 'warning', 3000);
                    pdfExtraction = await parseDatPdf(file);
                    pdfExtraction.source = 'pdf-regex';
                    console.log('‚úÖ [FALLBACK] Regex parsing completed');
                }

                // Store PDF data
                pdfData = pdfExtraction;

                // Fill form and tables
                fillFormFromPdf(pdfData);

                // Populate tables
                if (pdfData.ersatzteile) {
                    pdfData.ersatzteile.forEach(item => addErsatzteilRow(item));
                }
                if (pdfData.arbeitslohn) {
                    pdfData.arbeitslohn.forEach(item => addArbeitslohnRow(item));
                }
                if (pdfData.lackierung) {
                    pdfData.lackierung.forEach(item => addLackierungRow(item));
                }
                if (pdfData.materialien) {
                    pdfData.materialien.forEach(item => addMaterialienRow(item));
                }

                // üîß FIX: Update Gesamtsumme nach PDF-Import
                updateKostenaufschluesselung();

                showToast('‚úÖ Fahrzeugdaten aus PDF √ºbernommen!', 'success');

            } catch (error) {
                console.error('‚ùå PDF-Parsing Fehler:', error);
                showToast('Fehler beim Lesen der PDF. Bitte Daten manuell eingeben.', 'error');
                removePdf();
            }
        }

        async function parseWithOpenAI(pdfFile) {
            console.log('ü§ñ [OPENAI] Starte PDF-Parsing mit OpenAI GPT-4 Vision...');

            // Convert PDF to PNG images
            const pngImagesArray = await convertPdfToImage(pdfFile);

            // Call Cloud Function
            console.log('‚òÅÔ∏è [OPENAI] Calling Cloud Function parseDATPDF...');
            const parseDATPDF = window.functions.httpsCallable('parseDATPDF');
            const result = await parseDATPDF({ imagesBase64: pngImagesArray });

            if (!result.data.success) {
                throw new Error('OpenAI Parsing fehlgeschlagen');
            }

            const extractedData = result.data.data;
            extractedData.source = 'openai';

            console.log('‚úÖ [OPENAI] Parsing erfolgreich:', extractedData);
            return extractedData;
        }

        async function convertPdfToImage(pdfFile) {
            console.log('üñºÔ∏è [PDF‚ÜíPNG] Converting PDF to PNG images...');

            const arrayBuffer = await pdfFile.arrayBuffer();
            const uint8Array = new Uint8Array(arrayBuffer);

            const loadingTask = pdfjsLib.getDocument({ data: uint8Array });
            const pdf = await loadingTask.promise;

            console.log(`üìÑ [PDF‚ÜíPNG] PDF loaded: ${pdf.numPages} page(s)`);

            const pngImages = [];

            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                const page = await pdf.getPage(pageNum);
                const scale = 2.0;
                const viewport = page.getViewport({ scale });

                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = viewport.width;
                canvas.height = viewport.height;

                await page.render({ canvasContext: context, viewport: viewport }).promise;

                const pngDataUrl = canvas.toDataURL('image/png', 1.0);
                const pngBase64 = pngDataUrl.split(',')[1];

                pngImages.push(pngBase64);
            }

            console.log(`‚úÖ [PDF‚ÜíPNG] All ${pdf.numPages} pages converted`);
            return pngImages;
        }

        async function parseDatPdf(file) {
            console.log('üìÑ [REGEX] Parsing PDF with regex fallback...');

            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

            let extractedData = {
                fahrzeugdaten: {},
                ersatzteile: [],
                arbeitslohn: [],
                lackierung: [],
                materialien: []
            };

            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                const page = await pdf.getPage(pageNum);
                const textContent = await page.getTextContent();
                const text = textContent.items.map(item => item.str).join(' ');

                // Extract Fahrzeugdaten
                const hsnMatch = text.match(/HSN[\s:]+(\d+)/);
                const tsnMatch = text.match(/TSN[\s:]+([A-Z0-9]+)/);
                const vinMatch = text.match(/FIN[\s:]+([\dA-Z]{17})/);

                if (hsnMatch) extractedData.fahrzeugdaten.hsn = hsnMatch[1];
                if (tsnMatch) extractedData.fahrzeugdaten.tsn = tsnMatch[1];
                if (vinMatch) extractedData.fahrzeugdaten.vin = vinMatch[1];

                // Extract Ersatzteile (simplified regex)
                const ersatzteilRegex = /(\d{10})\s+([A-Z√Ñ√ñ√úa-z√§√∂√º√ü\s]+?)\s+(\d+)\s+([\d\.,]+)\s+([\d\.,]+)/g;
                let match;
                while ((match = ersatzteilRegex.exec(text)) !== null) {
                    extractedData.ersatzteile.push({
                        etn: match[1].trim(),
                        benennung: match[2].trim(),
                        anzahl: parseInt(match[3]),
                        einzelpreis: parseFloat(match[4].replace(',', '.')),
                        gesamtpreis: parseFloat(match[5].replace(',', '.'))
                    });
                }
            }

            console.log(`‚úÖ [REGEX] Extracted: ${extractedData.ersatzteile.length} Ersatzteile`);
            return extractedData;
        }

        function fillFormFromPdf(data) {
            console.log('üìù F√ºlle Formular mit PDF-Daten...');

            if (data.fahrzeugdaten) {
                if (data.fahrzeugdaten.vin) {
                    const vinInput = document.getElementById('vin');
                    if (vinInput) vinInput.value = data.fahrzeugdaten.vin;
                }
                if (data.fahrzeugdaten.marke) {
                    const markeInput = document.getElementById('marke');
                    if (markeInput) markeInput.value = data.fahrzeugdaten.marke;
                }
                if (data.fahrzeugdaten.modell) {
                    const modellInput = document.getElementById('modell');
                    if (modellInput) modellInput.value = data.fahrzeugdaten.modell;
                }
            }

            console.log('‚úÖ Formular ausgef√ºllt');
        }

        function removePdf() {
            // Clear PDF input
            const datPdfInput = document.getElementById('datPdfInput');
            if (datPdfInput) datPdfInput.value = '';

            // Hide remove button
            document.getElementById('pdfRemoveBtn').style.display = 'none';

            // Clear filename
            document.getElementById('pdfFileName').textContent = '';

            // Clear stored data
            pdfData = null;

            console.log('üóëÔ∏è PDF removed');
            showToast('PDF entfernt', 'info', 2000);
        }

        // ============================================
        // FOTO-UPLOAD
        // ============================================

        const photoInput = document.getElementById('photoInput');
        const photoGrid = document.getElementById('photoGrid');

        if (photoInput) {
            photoInput.addEventListener('change', handlePhotoUpload);
        }

        async function handlePhotoUpload(e) {
            const files = Array.from(e.target.files);

            // Validate file sizes
            for (const file of files) {
                if (file.size > 5 * 1024 * 1024) {
                    showToast(`Foto "${file.name}" ist zu gro√ü (${(file.size / 1024 / 1024).toFixed(1)} MB)! Max. 5 MB pro Foto.`, 'error', 5000);
                    e.target.value = '';
                    return;
                }
            }

            // Check total photo limit
            if (photos.length + files.length > 10) {
                showToast('Maximal 10 Fotos erlaubt!', 'error', 3000);
                e.target.value = '';
                return;
            }

            // ‚úÖ NEW: Upload files to Firebase Storage instead of Base64
            const werkstattId = window.werkstattId; // ‚úÖ SECURITY FIX: No 'mosbach' fallback
            const entwurfId = currentEntwurfId || `temp_${Date.now()}`;

            showToast('üì§ Fotos werden hochgeladen...', 'info', 2000);

            for (const file of files) {
                try {
                    // Create unique filename
                    const timestamp = Date.now();
                    const sanitizedFilename = file.name.replace(/[^a-zA-Z0-9._-]/g, '_');
                    const storagePath = `entwuerfe/${werkstattId}/${entwurfId}/photo_${timestamp}_${sanitizedFilename}`;

                    // Upload to Firebase Storage
                    const storage = firebase.storage();
                    const storageRef = storage.ref(storagePath);
                    const uploadTask = await storageRef.put(file);

                    // Get download URL
                    const downloadURL = await uploadTask.ref.getDownloadURL();

                    // Store URL instead of Base64
                    photos.push(downloadURL);
                    console.log(`‚úÖ Foto hochgeladen: ${storagePath}`);

                } catch (error) {
                    console.error('‚ùå Fehler beim Foto-Upload:', error);
                    showToast(`Fehler beim Upload von "${file.name}": ${error.message}`, 'error', 5000);
                }
            }

            updatePhotoGrid();
            showToast(`‚úÖ ${files.length} Foto(s) hochgeladen!`, 'success', 3000);
            e.target.value = '';
        }

        function updatePhotoGrid() {
            photoGrid.innerHTML = '';

            // Display existing photos
            photos.forEach((photo, index) => {
                const div = document.createElement('div');
                div.className = 'photo-item';
                div.innerHTML = `
                    <img src="${photo}" alt="Foto ${index + 1}">
                    <button class="remove-photo" onclick="removePhoto(${index})">√ó</button>
                `;
                photoGrid.appendChild(div);
            });

            // Add "Add Photo" button (if < 10 photos)
            if (photos.length < 10) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'photo-item empty';
                emptyDiv.onclick = () => photoInput.click();
                emptyDiv.innerHTML = `
                    <i data-feather="camera"></i>
                    <span>Foto hinzuf√ºgen</span>
                `;
                photoGrid.appendChild(emptyDiv);
            }

            feather.replace();
            console.log(`üì∏ ${photos.length} Fotos geladen`);
        }

        async function removePhoto(index) {
            const photoUrl = photos[index];

            // If it's a Storage URL (not Base64), delete from Storage
            if (photoUrl && photoUrl.startsWith('https://firebasestorage.googleapis.com')) {
                try {
                    const storage = firebase.storage();
                    const photoRef = storage.refFromURL(photoUrl);
                    await photoRef.delete();
                    console.log(`‚úÖ Foto aus Storage gel√∂scht: ${photoRef.fullPath}`);
                } catch (error) {
                    // Ignore errors (file might already be deleted or not exist)
                    console.warn('‚ö†Ô∏è Konnte Foto nicht aus Storage l√∂schen:', error.message);
                }
            }

            photos.splice(index, 1);
            updatePhotoGrid();
            showToast('Foto entfernt', 'info', 2000);
        }

        // ============================================
        // UNTERSCHRIFT-CANVAS
        // ============================================

        const canvas = document.getElementById('signatureCanvas');
        const ctx = canvas ? canvas.getContext('2d') : null;
        let isDrawing = false;
        let hasDrawn = false;

        function getCanvasStrokeColor() {
            const textColor = getComputedStyle(document.documentElement)
                .getPropertyValue('--color-text-primary').trim();
            return textColor || '#000000';
        }

        function initCanvas() {
            if (!canvas || !ctx) return;

            // üÜï BUGFIX 2025-11-18: Set explicit dimensions BEFORE scaling
            // Prevents coordinate mismatch when getBoundingClientRect returns wrong values
            canvas.width = 800;
            canvas.height = 400;

            // Scale for high-DPI displays and mobile responsiveness
            const rect = canvas.getBoundingClientRect();
            if (rect.width < 800) {
                // Mobile: Scale proportionally
                canvas.width = Math.round(rect.width * 2);
                canvas.height = Math.round((rect.width * 2) * (400/800));
            } else {
                // Desktop: Use full resolution
                canvas.width = rect.width * 2;
                canvas.height = rect.height * 2;
            }
            ctx.scale(2, 2);

            ctx.strokeStyle = getCanvasStrokeColor();
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            if (!hasDrawn) {
                drawPlaceholder();
            }
        }

        function drawPlaceholder() {
            if (!ctx) return;

            ctx.save();
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.fillStyle = getCanvasStrokeColor();
            ctx.globalAlpha = 0.3;
            ctx.font = '20px Inter';
            ctx.textAlign = 'center';
            ctx.fillText('‚úçÔ∏è Hier unterschreiben', canvas.width / 2, canvas.height / 2);
            ctx.restore();
        }

        function getCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;

            if (e.touches && e.touches.length > 0) {
                return {
                    x: (e.touches[0].clientX - rect.left) * scaleX / 2,
                    y: (e.touches[0].clientY - rect.top) * scaleY / 2
                };
            } else {
                return {
                    x: (e.clientX - rect.left) * scaleX / 2,
                    y: (e.clientY - rect.top) * scaleY / 2
                };
            }
        }

        function startDrawing(e) {
            e.preventDefault();
            isDrawing = true;

            if (!hasDrawn) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                hasDrawn = true;
            }

            const coords = getCoordinates(e);
            ctx.beginPath();
            ctx.moveTo(coords.x, coords.y);
        }

        function draw(e) {
            if (!isDrawing) return;
            e.preventDefault();

            const coords = getCoordinates(e);
            ctx.lineTo(coords.x, coords.y);
            ctx.stroke();
        }

        function stopDrawing(e) {
            if (!isDrawing) return;
            e.preventDefault();
            isDrawing = false;
            ctx.closePath();

            // Save signature as Base64
            if (hasDrawn) {
                signatureData = canvas.toDataURL('image/png');
            }
        }

        function clearSignature() {
            if (!ctx) return;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            hasDrawn = false;
            signatureData = null;
            drawPlaceholder();
            showToast('Unterschrift gel√∂scht', 'info', 2000);
        }

        // Canvas Event Listeners
        if (canvas) {
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseleave', stopDrawing);

            canvas.addEventListener('touchstart', startDrawing);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stopDrawing);
            canvas.addEventListener('touchcancel', stopDrawing);

            // Initialize canvas on load
            window.addEventListener('resize', initCanvas);
            setTimeout(initCanvas, 100); // Delay to ensure canvas is rendered
        }

        // ============================================
        // HELPER FUNCTIONS
        // ============================================

        function showToast(message, type = 'info', duration = 3000) {
            // Check if toast container exists
            let toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                toastContainer.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px;';
                document.body.appendChild(toastContainer);
            }

            // Create toast
            const toast = document.createElement('div');
            toast.style.cssText = `
                background: ${type === 'success' ? 'var(--color-success)' : type === 'error' ? 'var(--color-error)' : 'var(--color-primary)'};
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                font-weight: 500;
                max-width: 400px;
                animation: slideInRight 0.3s ease-out;
            `;
            toast.textContent = message;

            toastContainer.appendChild(toast);

            // Auto-remove
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // Add animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from {
                    opacity: 0;
                    transform: translateX(100px);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }
            @keyframes slideOutRight {
                from {
                    opacity: 1;
                    transform: translateX(0);
                }
                to {
                    opacity: 0;
                    transform: translateX(100px);
                }
            }
        `;
        document.head.appendChild(style);
    </script>

    <!-- üåì THEME TOGGLE SCRIPT -->
    <script>
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            if (typeof feather !== 'undefined') feather.replace();
        }
    </script>
</body>
</html>
