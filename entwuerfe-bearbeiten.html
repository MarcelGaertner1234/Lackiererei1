<!DOCTYPE html>
<!-- CACHE BUSTER: v2025-11-17-storage-migration -->
<html lang="de">
<head>
    <!-- ğŸŒ“ FOUC Prevention: Load Theme BEFORE CSS to prevent flash -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>

    <script>
        /// <reference path="js/types.js" />
        // window.werkstattId is set automatically after successful login
        // This ensures proper multi-tenant data isolation
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EntwÃ¼rfe Bearbeiten | Auto-Lackierzentrum Mosbach</title>

    <!-- Aggressive No-Cache Headers -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- Design System -->
    <link rel="stylesheet" href="design-system.css?v=af6b90f">
    <link rel="stylesheet" href="components.css?v=af6b90f">
    <link rel="stylesheet" href="animations.css?v=af6b90f">
    <link rel="stylesheet" href="mobile-first.css?v=af6b90f">

    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Feather Icons -->
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>

    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- PDF.js for PDF Parsing -->
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>

    <!-- QRious - Browser-optimized QR Code Generator -->
    <script src="./libs/qrious.min.js"></script>

    <!-- Firebase SDK (Compat Mode) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

    <!-- Listener Registry - Memory Leak Prevention (defines safeNavigate) -->
    <script src="listener-registry.js"></script>

    <style>
        body {
            background: var(--color-background);
            min-height: 100vh;
            padding: var(--space-6) var(--space-4) 100px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        /* Page Header */
        .page-header {
            text-align: center;
            margin-bottom: var(--space-8);
            padding: var(--space-8) var(--space-6);
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
        }

        .page-header h1 {
            font-size: clamp(24px, 5vw, 36px);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin-bottom: var(--space-2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-3);
        }

        .page-header p {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
        }

        /* Draft Selector */
        .draft-selector {
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            padding: var(--space-8);
            margin-bottom: var(--space-6);
        }

        .draft-selector h2 {
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin-bottom: var(--space-4);
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        /* Form Container */
        .form-container {
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            padding: var(--space-8);
            display: none; /* Hidden until draft selected */
        }

        .form-container.visible {
            display: block;
        }

        /* Section Title */
        .section-title {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin: var(--space-8) 0 var(--space-6) 0;
            padding-bottom: var(--space-3);
            border-bottom: 1px solid var(--color-border);
        }

        .section-title:first-child {
            margin-top: 0;
        }

        .section-title i {
            width: 24px;
            height: 24px;
            color: var(--color-primary);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: var(--space-12) var(--space-4);
            color: var(--color-text-secondary);
        }

        .empty-state i {
            width: 64px;
            height: 64px;
            margin-bottom: var(--space-4);
            opacity: 0.3;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: var(--space-4);
            margin-top: var(--space-8);
            flex-wrap: wrap;
        }

        .action-buttons .btn {
            flex: 1;
            min-width: 200px;
        }

        /* Loading Indicator */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Success Message */
        .success-message {
            display: none;
            background: var(--color-success);
            color: white;
            padding: var(--space-4) var(--space-6);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-6);
            text-align: center;
            font-weight: var(--font-weight-medium);
            box-shadow: var(--shadow-md);
        }

        .success-message.show {
            display: block;
            animation: slideInDown 0.3s ease-out;
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Required Asterisk */
        .required {
            color: var(--color-error);
        }

        /* Photo Grid */
        .photo-section {
            margin: var(--space-6) 0;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: var(--space-4);
            margin-top: var(--space-4);
        }

        .photo-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: var(--radius-lg);
            overflow: hidden;
            background: var(--color-bg-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .photo-item:hover {
            transform: scale(1.02);
            box-shadow: var(--shadow-md);
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-item.empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px dashed var(--color-border);
            gap: var(--space-2);
        }

        .photo-item.empty i {
            width: 32px;
            height: 32px;
            opacity: 0.5;
        }

        .photo-item.empty span {
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
        }

        .remove-photo {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(244, 67, 54, 0.9);
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .photo-item:hover .remove-photo {
            opacity: 1;
        }

        /* ğŸŒ“ THEME TOGGLE */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid var(--color-border);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .theme-toggle:hover { transform: scale(1.05); background: rgba(255, 255, 255, 0.15); }
        .theme-toggle__icon { width: 20px; height: 20px; color: var(--color-text-primary); }
        .theme-toggle__icon--light { display: none; }
        [data-theme="light"] .theme-toggle__icon--light { display: block; }
        [data-theme="light"] .theme-toggle__icon--dark { display: none; }
        [data-theme="light"] .theme-toggle { background: rgba(255,255,255,0.8); border-color: rgba(0,0,0,0.1); }
        /* ğŸ”™ ZURÃœCK-BUTTON (Fixed Position) */
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--color-border, rgba(255,255,255,0.1));
            border-radius: 8px;
            color: var(--color-text-primary, #e0e0e0);
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .back-button:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(-2px);
        }
        [data-theme="light"] .back-button {
            background: rgba(255, 255, 255, 0.8);
            border-color: rgba(0, 0, 0, 0.1);
            color: #1a1a2e;
        }
        @media (max-width: 768px) {
            .back-button { top: 10px; left: 10px; padding: 8px; }
            .back-button span { display: none; }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ¯ COLLAPSIBLE SECTIONS (Phase 1 UX Verbesserung - Dec 2025)
           Basierend auf annahme.html Pattern fÃ¼r konsistente UX
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        .collapsible-section {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            margin-bottom: var(--space-4);
            overflow: hidden;
            transition: all 0.3s ease-out;
        }

        .collapsible-section:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-4) var(--space-5);
            background: var(--color-bg-secondary);
            cursor: pointer;
            transition: background 0.2s ease;
            user-select: none;
        }

        .collapsible-header:hover {
            background: var(--color-bg-tertiary, rgba(255,255,255,0.05));
        }

        .collapsible-header-left {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .collapsible-header-title {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
        }

        /* Farbiger Akzent-Punkt vor dem Titel */
        .collapsible-header-title::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--section-accent, var(--color-primary));
            flex-shrink: 0;
        }

        .collapsible-header-title i {
            width: 20px;
            height: 20px;
            color: var(--section-accent, var(--color-primary));
        }

        .collapsible-header-hint {
            font-size: var(--font-size-xs);
            color: var(--color-text-tertiary);
            padding: 2px 8px;
            background: rgba(255,255,255,0.1);
            border-radius: var(--radius-full);
        }

        .collapsible-header-right {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .collapsible-header-chevron {
            width: 20px;
            height: 20px;
            color: var(--color-text-secondary);
            transition: transform 0.3s ease;
        }

        /* Rotation wenn geÃ¶ffnet */
        .collapsible-section.is-open .collapsible-header-chevron {
            transform: rotate(180deg);
        }

        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
        }

        .collapsible-section.is-open .collapsible-content {
            max-height: 15000px; /* ErhÃ¶ht fÃ¼r groÃŸe Sections wie Service & Abholung */
        }

        .collapsible-content-inner {
            padding: var(--space-6);
            border-top: 1px solid var(--color-border);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ¨ SEKTION-SPEZIFISCHE AKZENTFARBEN
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        /* Kundendaten - Blau */
        #kunden-collapsible {
            --section-accent: #2196F3;
        }

        /* Fahrzeugdaten - Cyan */
        #fahrzeug-collapsible {
            --section-accent: #00BCD4;
        }

        /* Service & Abholung - GrÃ¼n */
        #service-collapsible {
            --section-accent: #4CAF50;
        }

        /* Kalkulation - Orange */
        #kalkulation-collapsible {
            --section-accent: #FF9800;
        }

        /* Preiskalkulation - Rot/Pink */
        #preis-collapsible {
            --section-accent: #E91E63;
        }

        /* Fotos & Abschluss - Lila */
        #fotos-collapsible {
            --section-accent: #9C27B0;
        }

        /* Light Mode Anpassungen */
        [data-theme="light"] .collapsible-section {
            background: #ffffff;
            border-color: rgba(0,0,0,0.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        [data-theme="light"] .collapsible-header {
            background: rgba(0,0,0,0.02);
        }

        [data-theme="light"] .collapsible-header:hover {
            background: rgba(0,0,0,0.04);
        }

        [data-theme="light"] .collapsible-header-hint {
            background: rgba(0,0,0,0.05);
            color: var(--color-text-secondary);
        }

        [data-theme="light"] .collapsible-content-inner {
            border-top-color: rgba(0,0,0,0.08);
        }

        /* Mobile Anpassungen fÃ¼r Collapsible */
        @media (max-width: 768px) {
            .collapsible-header {
                padding: var(--space-3) var(--space-4);
            }

            .collapsible-header-title {
                font-size: var(--font-size-base);
            }

            .collapsible-content-inner {
                padding: var(--space-4);
            }

            .collapsible-header-hint {
                display: none; /* Verstecke Hints auf Mobile fÃ¼r mehr Platz */
            }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ¯ SUB-SECTIONS (Nested Collapsibles innerhalb Service & Abholung)
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        .sub-section {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-3);
            overflow: hidden;
        }

        .sub-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3) var(--space-4);
            background: rgba(var(--section-accent-rgb, 76, 175, 80), 0.1);
            cursor: pointer;
            transition: background 0.2s ease;
            user-select: none;
            border-left: 3px solid var(--sub-section-color, var(--color-primary));
        }

        .sub-section-header:hover {
            background: rgba(var(--section-accent-rgb, 76, 175, 80), 0.15);
        }

        .sub-section-header-left {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .sub-section-header-title {
            font-size: var(--font-size-sm);
            font-weight: 600;
            color: var(--sub-section-color, var(--color-text-primary));
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .sub-section-header-title svg {
            width: 16px;
            height: 16px;
        }

        .sub-section-header-chevron {
            width: 16px;
            height: 16px;
            color: var(--color-text-secondary);
            transition: transform 0.3s ease;
        }

        .sub-section.is-open .sub-section-header-chevron {
            transform: rotate(180deg);
        }

        .sub-section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .sub-section.is-open .sub-section-content {
            max-height: 2000px;
        }

        .sub-section-content-inner {
            padding: var(--space-4);
            border-top: 1px solid var(--color-border);
        }

        /* Sub-Section Farben */
        .sub-section-ersatzfahrzeug { --sub-section-color: #FF9800; }
        .sub-section-reifen { --sub-section-color: #2196F3; }
        .sub-section-mechanik { --sub-section-color: #607D8B; }
        .sub-section-lackier { --sub-section-color: #E91E63; }
        .sub-section-glas { --sub-section-color: #00BCD4; }
        .sub-section-klima { --sub-section-color: #03A9F4; }
        .sub-section-dellen { --sub-section-color: #795548; }
        .sub-section-versicherung { --sub-section-color: #9C27B0; }
        .sub-section-pflege { --sub-section-color: #8BC34A; }
        .sub-section-tuev { --sub-section-color: #FF5722; }
        .sub-section-folierung { --sub-section-color: #673AB7; }
        .sub-section-steinschutz { --sub-section-color: #009688; }
        .sub-section-werbebeklebung { --sub-section-color: #F44336; }

        /* Light Mode fÃ¼r Sub-Sections */
        [data-theme="light"] .sub-section {
            background: #fafafa;
            border-color: rgba(0,0,0,0.1);
        }

        [data-theme="light"] .sub-section-header {
            background: rgba(0,0,0,0.03);
        }

        [data-theme="light"] .sub-section-header:hover {
            background: rgba(0,0,0,0.05);
        }

        /* Mobile fÃ¼r Sub-Sections */
        @media (max-width: 768px) {
            .sub-section-header {
                padding: var(--space-2) var(--space-3);
            }
            .sub-section-content-inner {
                padding: var(--space-3);
            }
        }

        /* ï¿½ï¿½ MOBILE RESPONSIVE - Additional Rules */
        @media (max-width: 768px) {
            .container, .form-container, .main-content, main {
                padding: 15px;
                margin: 10px;
            }
            h1, .page-title {
                font-size: 1.5rem;
            }
            .btn, button {
                padding: 12px 20px;
                font-size: 14px;
            }
            .theme-toggle {
                top: 10px;
                right: 10px;
                width: 40px;
                height: 40px;
            }
        }

        @media (max-width: 480px) {
            body {
                font-size: 14px;
            }
            .container, .form-container, .main-content, main {
                padding: 10px;
                margin: 5px;
            }
            h1, .page-title {
                font-size: 1.3rem;
            }
            input, select, textarea {
                font-size: 16px; /* Prevents iOS zoom on focus */
            }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ“‹ AUFTRAGSINFORMATIONEN-ÃœBERSICHT (Order Summary)
           Kompakte Zusammenfassung aller Entwurf-Daten oben auf der Seite
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        .order-summary {
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-xl);
            margin-bottom: var(--space-6);
            overflow: hidden;
            display: none; /* Hidden until draft selected */
        }

        .order-summary.visible {
            display: block;
        }

        .order-summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-4) var(--space-5);
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.1), rgba(76, 175, 80, 0.1));
            border-bottom: 1px solid var(--color-border);
        }

        .order-summary-title {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .order-summary-title i {
            width: 24px;
            height: 24px;
            color: #2196F3;
        }

        /* Grid fÃ¼r Info-Boxen */
        .order-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-4);
            padding: var(--space-5);
        }

        /* Einzelne Info-Box */
        .info-box {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            border-left: 4px solid var(--info-box-color, var(--color-primary));
        }

        .info-box-header {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin-bottom: var(--space-3);
            padding-bottom: var(--space-2);
            border-bottom: 1px solid var(--color-border);
        }

        .info-box-header span {
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            color: var(--info-box-color, var(--color-text-primary));
        }

        .info-box-content {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: var(--space-2);
        }

        .info-label {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            flex-shrink: 0;
        }

        .info-value {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-medium);
            color: var(--color-text-primary);
            text-align: right;
            word-break: break-word;
        }

        .info-value.highlight {
            color: var(--color-primary);
        }

        .info-value.success {
            color: var(--color-success);
        }

        .info-value.warning {
            color: var(--color-warning);
        }

        /* Info-Box Farben */
        .info-box-fahrzeug { --info-box-color: #00BCD4; }
        .info-box-kunde { --info-box-color: #2196F3; }
        .info-box-service { --info-box-color: #4CAF50; }
        .info-box-termine { --info-box-color: #FF9800; }
        .info-box-beschreibung { --info-box-color: #9C27B0; }

        /* Service-Details Section */
        .service-details-summary {
            padding: 0 var(--space-5) var(--space-5);
        }

        .service-details-header {
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin-bottom: var(--space-3);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .service-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: var(--space-3);
        }

        .service-detail-card {
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            border-left: 3px solid var(--service-color, var(--color-primary));
        }

        .service-detail-card-header {
            font-size: var(--font-size-sm);
            font-weight: 600;
            color: var(--service-color, var(--color-text-primary));
            margin-bottom: var(--space-2);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .service-detail-card-content {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
        }

        .service-detail-card-content .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
        }

        .service-detail-card-content .detail-label {
            color: var(--color-text-tertiary);
        }

        .service-detail-card-content .detail-value {
            font-weight: 500;
            color: var(--color-text-primary);
        }

        /* Service-Farben */
        .service-card-lackier { --service-color: #E91E63; }
        .service-card-reifen { --service-color: #2196F3; }
        .service-card-mechanik { --service-color: #607D8B; }
        .service-card-pflege { --service-color: #8BC34A; }
        .service-card-tuev { --service-color: #FF5722; }
        .service-card-versicherung { --service-color: #9C27B0; }
        .service-card-glas { --service-color: #00BCD4; }
        .service-card-klima { --service-color: #03A9F4; }
        .service-card-dellen { --service-color: #795548; }
        .service-card-folierung { --service-color: #673AB7; }
        .service-card-steinschutz { --service-color: #009688; }
        .service-card-werbebeklebung { --service-color: #F44336; }

        /* Beschreibungs-Box (volle Breite) */
        .info-box-full {
            grid-column: 1 / -1;
        }

        .info-box-full .info-value {
            text-align: left;
            white-space: pre-wrap;
        }

        /* Light Mode */
        [data-theme="light"] .order-summary {
            background: #ffffff;
            border-color: rgba(0,0,0,0.1);
        }

        [data-theme="light"] .order-summary-header {
            background: linear-gradient(135deg, rgba(33, 150, 243, 0.08), rgba(76, 175, 80, 0.08));
        }

        [data-theme="light"] .info-box {
            background: rgba(0,0,0,0.02);
            border-color: rgba(0,0,0,0.08);
        }

        [data-theme="light"] .service-detail-card {
            background: rgba(0,0,0,0.02);
            border-color: rgba(0,0,0,0.08);
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .order-summary-grid {
                grid-template-columns: 1fr;
                padding: var(--space-4);
            }

            .service-details-grid {
                grid-template-columns: 1fr;
            }

            .info-box {
                padding: var(--space-3);
            }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ“Š KAPAZITÃ„TSVORSCHAU - Wochenansicht bei Datumsauswahl
           Zeigt WerkstattkapazitÃ¤t fÃ¼r die Woche um das gewÃ¤hlte Datum
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        .kapazitaet-preview {
            margin-top: 12px;
            padding: 16px;
            background: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            display: none;
        }

        .kapazitaet-preview.visible {
            display: block;
            animation: slideInDown 0.3s ease-out;
        }

        .kapazitaet-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
        }

        .kapazitaet-header strong {
            color: var(--color-text-primary);
        }

        .kapazitaet-week {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
        }

        /* ğŸ”§ FIX: Container fÃ¼r Multi-Service Tabellen-Layout */
        #kapazitaetWeekGrid {
            display: flex;
            flex-direction: column;
        }

        /* Multi-Service Tabellen-Layout */
        .kapazitaet-header-row {
            display: grid;
            grid-template-columns: 90px repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--color-border);
        }

        .kapazitaet-header-cell {
            text-align: center;
            font-size: 10px;
            color: var(--color-text-secondary);
        }

        .kapazitaet-header-cell .day-name {
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kapazitaet-header-cell .day-date {
            font-size: 9px;
            opacity: 0.7;
        }

        .kapazitaet-header-cell.selected {
            color: var(--color-primary);
        }

        .kapazitaet-header-cell.selected .day-name {
            font-weight: 700;
        }

        .kapazitaet-service-row {
            display: grid;
            grid-template-columns: 90px repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 6px;
            align-items: center;
        }

        .kapazitaet-service-row:last-child {
            margin-bottom: 0;
        }

        .service-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--color-text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .kapazitaet-week-row {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .kapazitaet-day {
            text-align: center;
            padding: 8px 4px;
            border-radius: var(--radius-md);
            font-size: 11px;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }

        .kapazitaet-day.selected {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
        }

        /* ğŸ“… Service-Vorplanung: Geplante Tage */
        .kapazitaet-day.planned {
            background: var(--color-primary) !important;
            color: white !important;
            font-weight: 700;
            border-color: var(--color-primary);
        }

        .kapazitaet-day:hover {
            cursor: pointer;
            transform: scale(1.08);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 1;
        }

        .kapazitaet-day:active {
            transform: scale(0.95);
        }

        .kapazitaet-day .day-name {
            font-weight: 600;
            color: var(--color-text-secondary);
            margin-bottom: 2px;
        }

        .kapazitaet-day .day-date {
            font-size: 12px;
            font-weight: 500;
            color: var(--color-text-primary);
            margin-bottom: 4px;
        }

        .kapazitaet-day .day-usage {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 4px;
            border-radius: 4px;
            background: rgba(255,255,255,0.1);
        }

        /* KapazitÃ¤ts-Status-Farben */
        .kapazitaet-day.status-green {
            background: rgba(34, 197, 94, 0.15);
        }
        .kapazitaet-day.status-green .day-usage {
            color: #22c55e;
        }

        .kapazitaet-day.status-yellow {
            background: rgba(234, 179, 8, 0.2);
        }
        .kapazitaet-day.status-yellow .day-usage {
            color: #eab308;
        }

        .kapazitaet-day.status-red {
            background: rgba(239, 68, 68, 0.2);
        }
        .kapazitaet-day.status-red .day-usage {
            color: #ef4444;
        }

        /* Light Mode fÃ¼r KapazitÃ¤tsvorschau */
        [data-theme="light"] .kapazitaet-preview {
            background: #f8fafc;
            border-color: rgba(0,0,0,0.1);
        }

        [data-theme="light"] .kapazitaet-day.status-green {
            background: rgba(34, 197, 94, 0.1);
        }

        [data-theme="light"] .kapazitaet-day.status-yellow {
            background: rgba(234, 179, 8, 0.15);
        }

        [data-theme="light"] .kapazitaet-day.status-red {
            background: rgba(239, 68, 68, 0.15);
        }

        /* Mobile Responsive fÃ¼r KapazitÃ¤tsvorschau */
        @media (max-width: 768px) {
            .kapazitaet-week {
                gap: 4px;
            }
            .kapazitaet-day {
                padding: 6px 2px;
                font-size: 10px;
            }
            .kapazitaet-day .day-date {
                font-size: 11px;
            }
            .kapazitaet-day .day-usage {
                font-size: 9px;
            }
        }

        @media (max-width: 480px) {
            .kapazitaet-week {
                grid-template-columns: repeat(7, 1fr);
                gap: 2px;
            }
            .kapazitaet-day {
                padding: 4px 1px;
            }
            .kapazitaet-day .day-name {
                font-size: 9px;
            }
        }
    </style>
</head>
<body>
    <!-- ğŸ”™ ZURÃœCK-BUTTON -->
    <button class="back-button" onclick="history.back()" title="ZurÃ¼ck">
        <i data-feather="arrow-left"></i>
        <span>ZurÃ¼ck</span>
    </button>
    <!-- ğŸŒ“ THEME TOGGLE -->
    <button id="themeToggle" class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle Theme">
        <i data-feather="sun" class="theme-toggle__icon theme-toggle__icon--light"></i>
        <i data-feather="moon" class="theme-toggle__icon theme-toggle__icon--dark"></i>
    </button>

    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1>
                <i data-feather="edit"></i>
                EntwÃ¼rfe Bearbeiten
            </h1>
            <p>VervollstÃ¤ndigen Sie offene EntwÃ¼rfe und erstellen Sie Angebote</p>
        </div>

        <!-- Success Message -->
        <div class="success-message" id="successMessage">
            âœ… Angebot erfolgreich versendet!
        </div>

        <!-- Draft Selector -->
        <div class="draft-selector">
            <h2>
                <i data-feather="file-text"></i>
                Entwurf auswÃ¤hlen
            </h2>

            <div class="form-group">
                <label for="entwurfDropdown" class="form-label">Offene EntwÃ¼rfe <span class="required">*</span></label>
                <select id="entwurfDropdown" class="form-select" onchange="loadEntwurf()">
                    <option value="">-- Bitte wÃ¤hlen --</option>
                </select>
                <small style="color: var(--color-text-tertiary); display: block; margin-top: var(--space-2);">
                    ğŸ’¡ WÃ¤hlen Sie einen Entwurf, um ihn zu vervollstÃ¤ndigen und ein Angebot zu erstellen
                </small>
            </div>

            <!-- Empty State (shown when no drafts) -->
            <div id="emptyState" class="empty-state" style="display: none;">
                <i data-feather="inbox"></i>
                <h3>Keine offenen EntwÃ¼rfe</h3>
                <p>Es gibt aktuell keine EntwÃ¼rfe, die bearbeitet werden mÃ¼ssen.</p>
            </div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             âš ï¸ ABGELAUFENE LEIHFAHRZEUG-ANFRAGEN
             Angebote mit Leihfahrzeug, die >48h nicht angenommen wurden
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div id="abgelaufeneSection" class="draft-selector" style="margin-top: 30px; border-left: 4px solid #f59e0b; display: none;">
            <h2 style="color: #b45309;">
                <i data-feather="alert-triangle"></i>
                Abgelaufene Leihfahrzeug-Reservierungen
            </h2>
            <p style="color: var(--color-text-secondary); margin-bottom: 20px;">
                Diese Angebote mit Leihfahrzeug wurden nicht innerhalb von 48h angenommen.
                Das Leihfahrzeug wurde automatisch freigegeben.
            </p>
            <div id="abgelaufeneList"></div>
        </div>

        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             ğŸ“‹ AUFTRAGSINFORMATIONEN-ÃœBERSICHT (Order Summary)
             Kompakte Zusammenfassung aller Entwurf-Daten oben auf der Seite
             â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
        <div class="order-summary" id="orderSummary">
            <div class="order-summary-header">
                <span class="order-summary-title">
                    <i data-feather="clipboard"></i>
                    Auftragsinformationen
                </span>
            </div>

            <!-- Info-Boxen Grid -->
            <div class="order-summary-grid">
                <!-- ğŸš— Fahrzeug -->
                <div class="info-box info-box-fahrzeug">
                    <div class="info-box-header">
                        <span>ğŸš— Fahrzeug</span>
                    </div>
                    <div class="info-box-content">
                        <div class="info-row">
                            <span class="info-label">Kennzeichen:</span>
                            <span class="info-value" id="summary-kennzeichen">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Fahrzeug:</span>
                            <span class="info-value" id="summary-fahrzeug">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Farbe:</span>
                            <span class="info-value" id="summary-farbe">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">KM-Stand:</span>
                            <span class="info-value" id="summary-kmstand">-</span>
                        </div>
                    </div>
                </div>

                <!-- ğŸ‘¤ Kunde -->
                <div class="info-box info-box-kunde">
                    <div class="info-box-header">
                        <span>ğŸ‘¤ Kunde</span>
                    </div>
                    <div class="info-box-content">
                        <div class="info-row">
                            <span class="info-label">Name:</span>
                            <span class="info-value" id="summary-kundenname">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Telefon:</span>
                            <span class="info-value" id="summary-telefon">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Email:</span>
                            <span class="info-value" id="summary-email">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Datum:</span>
                            <span class="info-value" id="summary-datum">-</span>
                        </div>
                    </div>
                </div>

                <!-- ğŸ”§ Service -->
                <div class="info-box info-box-service">
                    <div class="info-box-header">
                        <span>ğŸ”§ Service</span>
                    </div>
                    <div class="info-box-content">
                        <div class="info-row">
                            <span class="info-label">Service-Art:</span>
                            <span class="info-value" id="summary-services">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Anzahl:</span>
                            <span class="info-value highlight" id="summary-service-count">-</span>
                        </div>
                    </div>
                </div>

                <!-- ğŸ“… Termine -->
                <div class="info-box info-box-termine">
                    <div class="info-box-header">
                        <span>ğŸ“… Termine</span>
                    </div>
                    <div class="info-box-content">
                        <div class="info-row">
                            <span class="info-label">Anlieferung:</span>
                            <span class="info-value" id="summary-anlieferung">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Abholung:</span>
                            <span class="info-value" id="summary-abholung">-</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Ersatzfahrzeug:</span>
                            <span class="info-value" id="summary-ersatzfahrzeug">-</span>
                        </div>
                    </div>
                </div>

                <!-- ğŸ“ Schadensbeschreibung (volle Breite) -->
                <div class="info-box info-box-beschreibung info-box-full">
                    <div class="info-box-header">
                        <span>ğŸ“ Schadensbeschreibung</span>
                    </div>
                    <div class="info-box-content">
                        <span class="info-value" id="summary-beschreibung">-</span>
                    </div>
                </div>
            </div>

            <!-- ğŸ“¦ Service-Details -->
            <div class="service-details-summary" id="serviceDetailsSummary">
                <div class="service-details-header">
                    ğŸ“¦ Service-Details
                </div>
                <div class="service-details-grid" id="serviceDetailsGrid">
                    <!-- Wird dynamisch befÃ¼llt -->
                </div>
            </div>
        </div>

        <!-- Form Container (Hidden until draft selected) -->
        <div class="form-container" id="formContainer">
            <form id="entwurfForm">

                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                     ğŸ“‹ SEKTION 1: KUNDENDATEN (Blau)
                     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <div class="collapsible-section is-open" id="kunden-collapsible">
                    <div class="collapsible-header" onclick="toggleCollapsible('kunden-collapsible')">
                        <div class="collapsible-header-left">
                            <span class="collapsible-header-title">
                                <i data-feather="user"></i>
                                Kundendaten
                            </span>
                            <span class="collapsible-header-hint">Pflichtfelder</span>
                        </div>
                        <div class="collapsible-header-right">
                            <i data-feather="chevron-down" class="collapsible-header-chevron"></i>
                        </div>
                    </div>
                    <div class="collapsible-content">
                        <div class="collapsible-content-inner">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="kennzeichen" class="form-label">Kennzeichen <span class="required">*</span></label>
                                    <input type="text" id="kennzeichen" class="form-input" placeholder="z.B. MOS-CG 123" required readonly style="background: var(--color-bg-secondary);">
                                </div>

                                <div class="form-group">
                                    <label for="kundenname" class="form-label">Kundenname <span class="required">*</span></label>
                                    <input type="text" id="kundenname" class="form-input" placeholder="z.B. Max Mustermann" required>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="kundenEmail" class="form-label">Kunden-Email <span class="required">*</span></label>
                                    <input type="email" id="kundenEmail" class="form-input" placeholder="z.B. kunde@example.com" required>
                                    <small style="color: var(--color-text-tertiary);">
                                        ğŸ“§ Angebot wird an diese Email versendet
                                    </small>
                                </div>

                                <div class="form-group">
                                    <label for="telefon" class="form-label">Telefonnummer</label>
                                    <input type="tel" id="telefon" class="form-input" placeholder="z.B. +49 6261 123456">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                     ğŸš— SEKTION 2: FAHRZEUGDATEN (Cyan)
                     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <div class="collapsible-section is-open" id="fahrzeug-collapsible">
                    <div class="collapsible-header" onclick="toggleCollapsible('fahrzeug-collapsible')">
                        <div class="collapsible-header-left">
                            <span class="collapsible-header-title">
                                <i data-feather="truck"></i>
                                Fahrzeugdaten
                            </span>
                            <span class="collapsible-header-hint">Pflichtfelder</span>
                        </div>
                        <div class="collapsible-header-right">
                            <i data-feather="chevron-down" class="collapsible-header-chevron"></i>
                        </div>
                    </div>
                    <div class="collapsible-content">
                        <div class="collapsible-content-inner">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="marke" class="form-label">Marke <span class="required">*</span></label>
                                    <input type="text" id="marke" class="form-input" placeholder="z.B. VW, BMW, Mercedes" required>
                                </div>

                                <div class="form-group">
                                    <label for="modell" class="form-label">Modell <span class="required">*</span></label>
                                    <input type="text" id="modell" class="form-input" placeholder="z.B. Golf, 3er, C-Klasse" required>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="baujahrVon" class="form-label">Baujahr</label>
                                    <input type="text" id="baujahrVon" class="form-input" placeholder="z.B. 2018">
                                </div>

                                <div class="form-group">
                                    <label for="kmstand" class="form-label">KM-Stand</label>
                                    <input type="text" id="kmstand" class="form-input" placeholder="z.B. 45.000">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="vin" class="form-label">Fahrgestellnummer (VIN)</label>
                                <input type="text" id="vin" class="form-input" placeholder="z.B. WVWZZZ1KZBW123456">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                     ğŸ”„ SEKTION 3: SERVICE & ABHOLUNG (GrÃ¼n) - COLLAPSIBLE
                     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <div class="collapsible-section is-open" id="service-collapsible">
                    <div class="collapsible-header" onclick="toggleCollapsible('service-collapsible')">
                        <div class="collapsible-header-left">
                            <span class="collapsible-header-title">
                                <i data-feather="tool"></i>
                                Service & Abholung
                            </span>
                            <span class="collapsible-header-hint">Service-Details, Ersatzfahrzeug, Abholung</span>
                        </div>
                        <div class="collapsible-header-right">
                            <i data-feather="chevron-down" class="collapsible-header-chevron"></i>
                        </div>
                    </div>
                    <div class="collapsible-content">
                        <div class="collapsible-content-inner">

                <!-- ERSATZFAHRZEUG -->
                <div class="section-title">
                    <i data-feather="refresh-cw"></i>
                    Ersatzfahrzeug
                </div>

                <div class="form-group">
                    <label class="checkbox-label" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="ersatzfahrzeugGewuenscht" name="ersatzfahrzeugGewuenscht" style="width: 18px; height: 18px;">
                        <span>Kunde benÃ¶tigt Ersatzfahrzeug</span>
                    </label>
                </div>

                <div class="form-group" id="ersatzfahrzeugZuweisungGroup" style="display: none;">
                    <label for="zugewiesenesErsatzfahrzeug" class="form-label">Ersatzfahrzeug zuweisen</label>
                    <select id="zugewiesenesErsatzfahrzeug" class="form-input" style="cursor: pointer;">
                        <option value="">-- Kein Fahrzeug zugewiesen --</option>
                        <!-- Dynamisch gefÃ¼llt aus leihfahrzeuge Collection -->
                    </select>
                </div>

                <!-- ğŸš— FAHRZEUG-ABHOLUNG (FIX: 2025-11-27) -->
                <div class="section-title">
                    <i data-feather="truck"></i>
                    Fahrzeug-Abholung
                </div>

                <div class="form-group">
                    <label class="form-label">Fahrzeug abholen?</label>
                    <div class="radio-group" style="display: flex; flex-direction: column; gap: 8px;">
                        <label class="radio-label" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="radio" name="fahrzeugAbholen" id="fahrzeugAbholenNein" value="false" checked style="width: 18px; height: 18px;">
                            <span>Nein, Kunde bringt Fahrzeug selbst</span>
                        </label>
                        <label class="radio-label" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="radio" name="fahrzeugAbholen" id="fahrzeugAbholenJa" value="true" style="width: 18px; height: 18px;">
                            <span>Ja, Fahrzeug abholen</span>
                        </label>
                    </div>
                </div>

                <div id="abholungDetails" style="display: none;">
                    <div class="form-group">
                        <label for="abholadresse" class="form-label">Abholadresse</label>
                        <textarea id="abholadresse" class="form-textarea" rows="2" placeholder="StraÃŸe, Hausnummer, PLZ, Ort"></textarea>
                    </div>

                    <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <div class="form-group">
                            <label for="abholdatum" class="form-label">GewÃ¼nschtes Abholdatum</label>
                            <input type="date" id="abholdatum" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="abholzeit" class="form-label">GewÃ¼nschte Abholzeit</label>
                            <input type="time" id="abholzeit" class="form-input">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="abholnotiz" class="form-label">Notiz zur Abholung (optional)</label>
                        <textarea id="abholnotiz" class="form-textarea" rows="2" placeholder="z.B. Zufahrt, Besonderheiten, Ansprechpartner"></textarea>
                    </div>
                </div>

                <!-- SERVICE-DETAILS -->
                <div class="section-title">
                    <i data-feather="tool"></i>
                    Service-Details
                </div>

                <div class="form-group">
                    <label class="form-label">Service-Typ <span class="required">*</span></label>
                    <div id="serviceTypDisplay" class="form-input" style="background: var(--color-bg-secondary); cursor: not-allowed; padding: 10px; border-radius: 8px; border: 1px solid var(--color-border);">
                        <!-- Will be filled by JavaScript (supports multi-service display) -->
                    </div>
                    <small style="color: var(--color-text-tertiary); margin-top: 4px; display: block;">
                        âš ï¸ Service-Typ kann hier nicht geÃ¤ndert werden (vom Meister beim Entwurf festgelegt)
                    </small>
                </div>

                <!-- ========================================== -->
                <!-- SERVICE-DETAIL-FELDER (FIX: Nov 17, 2025)  -->
                <!-- Pattern 34: Service-Details Display        -->
                <!-- ========================================== -->

                <!-- Reifen-Service Felder -->
                <div id="reifen-felder" class="service-felder sub-section sub-section-reifen is-open" style="display:none;">
                    <div class="sub-section-header" onclick="toggleSubSection('reifen-felder')">
                        <div class="sub-section-header-left">
                            <span class="sub-section-header-title">
                                <i data-feather="circle"></i>
                                ğŸ”µ Reifen-Service Details
                            </span>
                        </div>
                        <i data-feather="chevron-down" class="sub-section-header-chevron"></i>
                    </div>
                    <div class="sub-section-content">
                        <div class="sub-section-content-inner">
                            <div class="form-group">
                                <label for="reifengroesse" class="form-label">ReifengrÃ¶ÃŸe</label>
                                <input type="text" id="reifengroesse" class="form-input" placeholder="z.B. 205/55 R16 91V">
                                <small style="color: var(--color-text-tertiary);">Format: Breite/HÃ¶he Durchmesser Lastindex</small>
                            </div>

                            <div class="form-group">
                                <label for="reifentyp" class="form-label">Reifen-Typ</label>
                                <select id="reifentyp" class="form-select">
                                    <option value="">-- Bitte wÃ¤hlen --</option>
                                    <option value="sommer">Sommerreifen</option>
                                    <option value="winter">Winterreifen</option>
                                    <option value="ganzjahr">Ganzjahresreifen</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="reifenanzahl" class="form-label">Anzahl Reifen</label>
                                <input type="number" id="reifenanzahl" class="form-input" min="1" max="4" value="4">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mechanik-Service Felder -->
                <div id="mechanik-felder" class="service-felder sub-section sub-section-mechanik is-open" style="display:none;">
                    <div class="sub-section-header" onclick="toggleSubSection('mechanik-felder')">
                        <div class="sub-section-header-left">
                            <span class="sub-section-header-title">
                                <i data-feather="settings"></i>
                                âš™ï¸ Mechanik-Service Details
                            </span>
                        </div>
                        <i data-feather="chevron-down" class="sub-section-header-chevron"></i>
                    </div>
                    <div class="sub-section-content">
                        <div class="sub-section-content-inner">
                            <div class="form-group">
                                <label for="mechanik-problem" class="form-label">Problembeschreibung</label>
                                <textarea id="mechanik-problem" class="form-input" rows="4" placeholder="z.B. Motor ruckelt, Bremsen quietschen, Lenkung schwergÃ¤ngig, Warnleuchte leuchtet..."></textarea>
                                <small style="color: var(--color-text-tertiary);">Bitte so detailliert wie mÃ¶glich beschreiben</small>
                            </div>

                            <div class="form-group">
                                <label for="mechanik-symptome" class="form-label">Symptome / Wann tritt das Problem auf?</label>
                                <input type="text" id="mechanik-symptome" class="form-input" placeholder="z.B. nur beim Kaltstart, bei hoher Geschwindigkeit, beim Bremsen">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lackierung Felder -->
                <div id="lackier-felder" class="service-felder sub-section sub-section-lackier is-open" style="display:none;">
                    <div class="sub-section-header" onclick="toggleSubSection('lackier-felder')">
                        <div class="sub-section-header-left">
                            <span class="sub-section-header-title">
                                <i data-feather="droplet"></i>
                                ğŸ¨ Lackierung Details
                            </span>
                        </div>
                        <i data-feather="chevron-down" class="sub-section-header-chevron"></i>
                    </div>
                    <div class="sub-section-content">
                        <div class="sub-section-content-inner">
                            <div class="form-group">
                                <label for="farbname" class="form-label">Farbname</label>
                                <input type="text" id="farbname" class="form-input" placeholder="z.B. Tiefschwarz, Brillantschwarz">
                            </div>

                            <div class="form-group">
                                <label for="farbvariante" class="form-label">Farbvariante</label>
                                <input type="text" id="farbvariante" class="form-input" placeholder="z.B. Metallic, Perleffekt, Uni">
                            </div>

                            <div class="form-group">
                                <label for="farbnummer" class="form-label">Farbnummer</label>
                                <input type="text" id="farbnummer" class="form-input" placeholder="z.B. L041, A2">
                            </div>

                        </div>
                    </div>
                </div>

                <!-- Glas-Reparatur Felder -->
                <div id="glas-felder" class="service-felder sub-section sub-section-glas is-open" style="display:none;">
                    <div class="sub-section-header" onclick="toggleSubSection('glas-felder')">
                        <div class="sub-section-header-left">
                            <span class="sub-section-header-title">
                                <i data-feather="square"></i>
                                ğŸªŸ Glas-Reparatur Details
                            </span>
                        </div>
                        <i data-feather="chevron-down" class="sub-section-header-chevron"></i>
                    </div>
                    <div class="sub-section-content">
                        <div class="sub-section-content-inner">
                            <div class="form-group">
                                <label for="scheibentyp" class="form-label">Scheiben-Typ</label>
                                <select id="scheibentyp" class="form-select">
                                    <option value="">-- Bitte wÃ¤hlen --</option>
                                    <option value="frontscheibe">Frontscheibe</option>
                                    <option value="seitenscheibe-vorne-links">Seitenscheibe vorne links</option>
                                    <option value="seitenscheibe-vorne-rechts">Seitenscheibe vorne rechts</option>
                                    <option value="seitenscheibe-hinten-links">Seitenscheibe hinten links</option>
                                    <option value="seitenscheibe-hinten-rechts">Seitenscheibe hinten rechts</option>
                                    <option value="heckscheibe">Heckscheibe</option>
                                    <option value="schiebedach">Schiebedach</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="schadensgroesse" class="form-label">Schadens-GrÃ¶ÃŸe</label>
                                <select id="schadensgroesse" class="form-select">
                                    <option value="">-- Bitte wÃ¤hlen --</option>
                                    <option value="steinschlag">Steinschlag (< 2cm) - Reparatur mÃ¶glich</option>
                                    <option value="riss-klein">Kleiner Riss (2-5cm) - Reparatur mÃ¶glich</option>
                                    <option value="riss-mittel">Mittlerer Riss (5-10cm) - Austausch empfohlen</option>
                                    <option value="riss-gross">GroÃŸer Riss/Bruch (> 10cm) - Austausch nÃ¶tig</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="glasposition" class="form-label">Position des Schadens</label>
                                <input type="text" id="glasposition" class="form-input" placeholder="z.B. Fahrerseite Mitte, Beifahrerseite oben links">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Klima-Service Felder -->
                <div id="klima-felder" class="service-felder sub-section sub-section-klima is-open" style="display:none;">
                    <div class="sub-section-header" onclick="toggleSubSection('klima-felder')">
                        <div class="sub-section-header-left">
                            <span class="sub-section-header-title">
                                <i data-feather="wind"></i>
                                â„ï¸ Klima-Service Details
                            </span>
                        </div>
                        <i data-feather="chevron-down" class="sub-section-header-chevron"></i>
                    </div>
                    <div class="sub-section-content">
                        <div class="sub-section-content-inner">
                            <div class="form-group">
                                <label for="klimaservice" class="form-label">Service-Art</label>
                                <select id="klimaservice" class="form-select">
                                    <option value="">-- Bitte wÃ¤hlen --</option>
                                    <option value="wartung">Wartung & Desinfektion</option>
                                    <option value="fuellen">KÃ¤ltemittel auffÃ¼llen</option>
                                    <option value="reparatur">Reparatur (Leckage)</option>
                                    <option value="komplett">Kompletter Service-Check</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="kaeltemittel" class="form-label">KÃ¤ltemittel-Typ</label>
                                <select id="kaeltemittel" class="form-select">
                                    <option value="">-- Bitte wÃ¤hlen --</option>
                                    <option value="r134a">R134a (Fahrzeuge Ã¤lter 2017)</option>
                                    <option value="r1234yf">R1234yf (Fahrzeuge ab 2017)</option>
                                    <option value="unbekannt">Unbekannt / Nicht sicher</option>
                                </select>
                                <small style="color: var(--color-text-tertiary);">Ab Erstzulassung 2017 meist R1234yf</small>
                            </div>

                            <div class="form-group">
                                <label for="klimaproblem" class="form-label">Beschreibung des Problems</label>
                                <textarea id="klimaproblem" class="form-input" rows="3" placeholder="z.B. Klimaanlage kÃ¼hlt nicht mehr, unangenehmer Geruch, GerÃ¤usche beim Einschalten"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dellen-DrÃ¼ckung Felder -->
                <div id="dellen-felder" class="service-felder sub-section sub-section-dellen is-open" style="display:none;">
                    <div class="sub-section-header" onclick="toggleSubSection('dellen-felder')">
                        <div class="sub-section-header-left">
                            <span class="sub-section-header-title">
                                <i data-feather="target"></i>
                                ğŸ”¨ Dellen-DrÃ¼ckung Details
                            </span>
                        </div>
                        <i data-feather="chevron-down" class="sub-section-header-chevron"></i>
                    </div>
                    <div class="sub-section-content">
                        <div class="sub-section-content-inner">
                            <div class="form-group">
                                <label for="dellenanzahl" class="form-label">Anzahl Dellen</label>
                                <input type="number" id="dellenanzahl" class="form-input" min="1" max="20" value="1">
                            </div>

                            <div class="form-group">
                                <label for="dellengroesse" class="form-label">GrÃ¶ÃŸte Delle</label>
                                <select id="dellengroesse" class="form-select">
                                    <option value="">-- Bitte wÃ¤hlen --</option>
                                    <option value="klein">Klein (< 5cm Durchmesser)</option>
                                    <option value="mittel">Mittel (5-10cm Durchmesser)</option>
                                    <option value="gross">GroÃŸ (> 10cm Durchmesser)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="lackschaden" class="form-label">Lackschaden vorhanden?</label>
                                <select id="lackschaden" class="form-select">
                                    <option value="">-- Bitte wÃ¤hlen --</option>
                                    <option value="nein">Nein (nur Delle)</option>
                                    <option value="ja">Ja (Delle + Lackschaden)</option>
                                </select>
                                <small style="color: var(--color-text-tertiary);">Bei Lackschaden ist zusÃ¤tzliche Lackierung nÃ¶tig</small>
                            </div>

                            <div class="form-group">
                                <label for="dellenpositionen" class="form-label">Position(en) der Dellen</label>
                                <textarea id="dellenpositionen" class="form-input" rows="3" placeholder="z.B. FahrertÃ¼r Mitte, KotflÃ¼gel rechts, Motorhaube links vorne"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Versicherung-Service Felder -->
                <div id="versicherung-felder" class="service-felder sub-section sub-section-versicherung is-open" style="display:none;">
                    <div class="sub-section-header" onclick="toggleSubSection('versicherung-felder')">
                        <div class="sub-section-header-left">
                            <span class="sub-section-header-title">
                                <i data-feather="shield"></i>
                                ğŸ“‹ Versicherungsschaden Details
                            </span>
                        </div>
                        <i data-feather="chevron-down" class="sub-section-header-chevron"></i>
                    </div>
                    <div class="sub-section-content">
                        <div class="sub-section-content-inner">
                            <div class="form-group">
                        <label for="versicherung-schadensnummer" class="form-label">Schadennummer</label>
                        <input type="text" id="versicherung-schadensnummer" class="form-input" placeholder="z.B. SCH-2024-123456">
                        <small style="color: var(--color-text-tertiary);">Von der Versicherung erhalten</small>
                    </div>

                    <div class="form-group">
                        <label for="versicherung-name" class="form-label">Versicherung</label>
                        <input type="text" id="versicherung-name" class="form-input" placeholder="z.B. Allianz, HUK, Ergo">
                    </div>

                    <div class="form-group">
                        <label for="versicherung-schadendatum" class="form-label">Schadendatum</label>
                        <input type="date" id="versicherung-schadendatum" class="form-input">
                    </div>

                            <div class="form-group">
                                <label for="versicherung-hergang" class="form-label">Unfallhergang / Schadenursache</label>
                                <textarea id="versicherung-hergang" class="form-input" rows="3" placeholder="z.B. Auffahrunfall, Parkrempler, Wildschaden, Hagel..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pflege-Service Felder -->
                <div id="pflege-felder" class="service-felder sub-section sub-section-pflege is-open" style="display:none;">
                    <div class="sub-section-header" onclick="toggleSubSection('pflege-felder')">
                        <div class="sub-section-header-left">
                            <span class="sub-section-header-title">
                                <i data-feather="star"></i>
                                âœ¨ Fahrzeugpflege Details
                            </span>
                        </div>
                        <i data-feather="chevron-down" class="sub-section-header-chevron"></i>
                    </div>
                    <div class="sub-section-content">
                        <div class="sub-section-content-inner">
                            <div class="form-group">
                                <label for="pflege-paket" class="form-label">Pflege-Paket</label>
                                <select id="pflege-paket" class="form-select">
                                    <option value="">-- Bitte wÃ¤hlen --</option>
                                    <option value="basis">Basis (AuÃŸenwÃ¤sche + Staubsaugen)</option>
                                    <option value="premium">Premium (Basis + Innenraumreinigung + Politur)</option>
                                    <option value="deluxe">Deluxe (Premium + MotorwÃ¤sche + UnterbodenwÃ¤sche + Versiegelung)</option>
                                    <option value="aufbereitung">Komplett-Aufbereitung (Deluxe + Polsterreinigung + Lederpflege)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="pflege-zusatz" class="form-label">Zusatzleistungen</label>
                                <textarea id="pflege-zusatz" class="form-input" rows="2" placeholder="z.B. Polsterreinigung, Lederpflege, Geruchsneutralisierung, Scheinwerfer-Aufbereitung"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TÃœV-Service Felder -->
                <div id="tuev-felder" class="service-felder sub-section sub-section-tuev is-open" style="display:none;">
                    <div class="sub-section-header" onclick="toggleSubSection('tuev-felder')">
                        <div class="sub-section-header-left">
                            <span class="sub-section-header-title">
                                <i data-feather="check-circle"></i>
                                ğŸ“ TÃœV/AU Details
                            </span>
                        </div>
                        <i data-feather="chevron-down" class="sub-section-header-chevron"></i>
                    </div>
                    <div class="sub-section-content">
                        <div class="sub-section-content-inner">
                            <div class="form-group">
                                <label for="tuev-pruefart" class="form-label">PrÃ¼fart</label>
                                <select id="tuev-pruefart" class="form-select">
                                    <option value="">-- Bitte wÃ¤hlen --</option>
                                    <option value="hu">HU (Hauptuntersuchung)</option>
                                    <option value="au">AU (Abgasuntersuchung)</option>
                                    <option value="hu-au">HU + AU (Kombi)</option>
                                    <option value="nachpruefung">NachprÃ¼fung</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="tuev-faelligkeit" class="form-label">FÃ¤lligkeit TÃœV</label>
                                <input type="month" id="tuev-faelligkeit" class="form-input">
                                <small style="color: var(--color-text-tertiary);">Steht im Fahrzeugschein und auf TÃœV-Plakette</small>
                            </div>

                            <div class="form-group">
                                <label for="tuev-maengel" class="form-label">Bekannte MÃ¤ngel (optional)</label>
                                <textarea id="tuev-maengel" class="form-input" rows="2" placeholder="z.B. Beleuchtung defekt, Reifen abgefahren, Rost am Schweller"></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Folierung Felder -->
                <div id="folierung-felder" class="service-felder sub-section sub-section-folierung is-open" style="display:none;">
                    <div class="sub-section-header" onclick="toggleSubSection('folierung-felder')">
                        <div class="sub-section-header-left">
                            <span class="sub-section-header-title">
                                <i data-feather="layers"></i>
                                ğŸ­ Auto Folierung Details
                            </span>
                        </div>
                        <i data-feather="chevron-down" class="sub-section-header-chevron"></i>
                    </div>
                    <div class="sub-section-content">
                        <div class="sub-section-content-inner">
                            <div class="form-group">
                                <label for="folierungArt" class="form-label">Art der Folierung</label>
                                <select id="folierungArt" class="form-select">
                                    <option value="">-- Bitte wÃ¤hlen --</option>
                                    <option value="vollfolierung">ğŸ¨ Vollfolierung (gesamtes Fahrzeug)</option>
                                    <option value="teilfolierung">âœ‚ï¸ Teilfolierung (bestimmte Teile)</option>
                                    <option value="akzente">â­ Akzente (Streifen, Logos)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="folierungMaterial" class="form-label">MaterialqualitÃ¤t</label>
                                <select id="folierungMaterial" class="form-select">
                                    <option value="">-- Bitte wÃ¤hlen --</option>
                                    <option value="standard">ğŸ“¦ Standard (3-5 Jahre)</option>
                                    <option value="premium">ğŸ’ Premium (5-7 Jahre)</option>
                                    <option value="spezial">ğŸŒŸ Spezialfolie (Chrome, Carbon, Matt)</option>
                                </select>
                            </div>

                            <div class="form-group" id="folierungSpezialTypContainer" style="display:none;">
                                <label for="folierungSpezialTyp" class="form-label">Spezialfolie Typ</label>
                                <input type="text" id="folierungSpezialTyp" class="form-input" placeholder="z.B. Chrome, Carbon, Matt Pearl">
                                <small style="color: var(--color-text-tertiary);">Nur bei Spezialfolien - genaue Bezeichnung</small>
                            </div>

                            <div class="form-group">
                                <label for="folierungFarbe" class="form-label">Farbauswahl</label>
                                <input type="text" id="folierungFarbe" class="form-input" placeholder="z.B. Schwarz Matt, Blau Metallic, Rot Hochglanz">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Folierung Bereiche</label>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-2);">
                                    <label style="display: flex; align-items: center; gap: var(--space-2);">
                                        <input type="checkbox" name="folierungBereiche" value="motorhaube">
                                        <span>Motorhaube</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: var(--space-2);">
                                        <input type="checkbox" name="folierungBereiche" value="dach">
                                        <span>Dach</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: var(--space-2);">
                                        <input type="checkbox" name="folierungBereiche" value="kofferraum">
                                        <span>Kofferraum</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: var(--space-2);">
                                        <input type="checkbox" name="folierungBereiche" value="tueren">
                                        <span>TÃ¼ren</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: var(--space-2);">
                                        <input type="checkbox" name="folierungBereiche" value="kotfluegel">
                                        <span>KotflÃ¼gel</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: var(--space-2);">
                                        <input type="checkbox" name="folierungBereiche" value="spiegel">
                                        <span>Spiegel</span>
                                    </label>
                                </div>
                                <small style="color: var(--color-text-tertiary);">Welche Bereiche sollen foliert werden?</small>
                            </div>

                            <div class="form-group">
                                <label for="folierungDesign" class="form-label">Design Beschreibung</label>
                                <textarea id="folierungDesign" class="form-input" rows="3" placeholder="Beschreiben Sie das gewÃ¼nschte Design (z.B. Racing-Streifen, Farbverlauf, Muster...)"></textarea>
                                <small style="color: var(--color-text-tertiary);">Details zum gewÃ¼nschten Look</small>
                            </div>

                            <div class="form-group">
                                <label for="folierungInfo" class="form-label">ZusÃ¤tzliche Informationen</label>
                                <textarea id="folierungInfo" class="form-input" rows="2" placeholder="Besondere Anforderungen, Zeitrahmen..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Steinschutz Felder -->
                <div id="steinschutz-felder" class="service-felder sub-section sub-section-steinschutz is-open" style="display:none;">
                    <div class="sub-section-header" onclick="toggleSubSection('steinschutz-felder')">
                        <div class="sub-section-header-left">
                            <span class="sub-section-header-title">
                                <i data-feather="shield"></i>
                                ğŸ›¡ï¸ Steinschutzfolie Details
                            </span>
                        </div>
                        <i data-feather="chevron-down" class="sub-section-header-chevron"></i>
                    </div>
                    <div class="sub-section-content">
                        <div class="sub-section-content-inner">
                            <div class="form-group">
                                <label for="steinschutzUmfang" class="form-label">Schutzumfang</label>
                                <select id="steinschutzUmfang" class="form-select">
                                    <option value="">-- Bitte wÃ¤hlen --</option>
                                    <option value="premium">ğŸ›¡ï¸ Premium-Paket (Komplettschutz)</option>
                                    <option value="standard">ğŸ“¦ Standard-Paket (Front, Motorhaube, Spiegel)</option>
                                    <option value="minimal">âš¡ Minimal-Paket (nur Front)</option>
                                    <option value="individuell">ğŸ¯ Individuell (Bereiche auswÃ¤hlen)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="steinschutzMaterial" class="form-label">MaterialqualitÃ¤t</label>
                                <select id="steinschutzMaterial" class="form-select">
                                    <option value="">-- Bitte wÃ¤hlen --</option>
                                    <option value="standard">ğŸ“¦ Standard PPF (5 Jahre)</option>
                                    <option value="premium">ğŸ’ Premium PPF (7 Jahre)</option>
                                    <option value="self-healing">ğŸ”„ Self-Healing (10 Jahre)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="steinschutzBereiche" class="form-label">Schutz-Bereiche</label>
                                <textarea id="steinschutzBereiche" class="form-input" rows="2" placeholder="z.B. FrontstoÃŸstange, Motorhaube, KotflÃ¼gel, Schweller, TÃ¼rkanten, Ladekante..."></textarea>
                                <small style="color: var(--color-text-tertiary);">Welche Bereiche sollen mit Steinschutzfolie versehen werden?</small>
                            </div>

                            <div class="form-group">
                                <label for="steinschutzInfo" class="form-label">ZusÃ¤tzliche Informationen</label>
                                <textarea id="steinschutzInfo" class="form-input" rows="2" placeholder="Besondere Anforderungen, vorhandene LackschÃ¤den..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Werbebeklebung Felder -->
                <div id="werbebeklebung-felder" class="service-felder sub-section sub-section-werbebeklebung is-open" style="display:none;">
                    <div class="sub-section-header" onclick="toggleSubSection('werbebeklebung-felder')">
                        <div class="sub-section-header-left">
                            <span class="sub-section-header-title">
                                <i data-feather="tag"></i>
                                ğŸ“¢ Fahrzeugbeschriftung Details
                            </span>
                        </div>
                        <i data-feather="chevron-down" class="sub-section-header-chevron"></i>
                    </div>
                    <div class="sub-section-content">
                        <div class="sub-section-content-inner">
                            <div class="form-group">
                                <label for="werbebeklebungUmfang" class="form-label">Umfang der Beklebung</label>
                                <select id="werbebeklebungUmfang" class="form-select">
                                    <option value="">-- Bitte wÃ¤hlen --</option>
                                    <option value="vollbeklebung">ğŸšš Vollbeklebung (alle Seiten)</option>
                                    <option value="teilbeklebung">âœ‚ï¸ Teilbeklebung (bestimmte Bereiche)</option>
                                    <option value="logo-only">ğŸ·ï¸ Nur Logo</option>
                                    <option value="schriftzug">âœï¸ Schriftzug</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="werbebeklebungKomplexitaet" class="form-label">Design-KomplexitÃ¤t</label>
                                <select id="werbebeklebungKomplexitaet" class="form-select">
                                    <option value="">-- Bitte wÃ¤hlen --</option>
                                    <option value="einfach">ğŸ“ Einfach (Text + Logo, 1-2 Farben)</option>
                                    <option value="mittel">ğŸ¨ Mittel (Logo + Text + Grafiken, 3-5 Farben)</option>
                                    <option value="komplex">ğŸŒˆ Komplex (VollflÃ¤chiges Design, 6+ Farben)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="werbebeklebungFarbanzahl" class="form-label">Anzahl Farben</label>
                                <input type="number" id="werbebeklebungFarbanzahl" class="form-input" min="1" max="20" placeholder="z.B. 3">
                                <small style="color: var(--color-text-tertiary);">Wie viele verschiedene Farben werden im Design verwendet?</small>
                            </div>

                            <div class="form-group">
                                <label for="werbebeklebungText" class="form-label">Textelemente</label>
                                <textarea id="werbebeklebungText" class="form-input" rows="3" placeholder="Firmenname, Slogan, Kontaktdaten (Telefon, Website, E-Mail)..."></textarea>
                                <small style="color: var(--color-text-tertiary);">Alle Texte, die auf dem Fahrzeug erscheinen sollen</small>
                            </div>

                            <div class="form-group">
                                <label for="werbebeklebungInfo" class="form-label">ZusÃ¤tzliche Informationen</label>
                                <textarea id="werbebeklebungInfo" class="form-input" rows="2" placeholder="Besondere WÃ¼nsche, Zeitrahmen, Referenzbilder..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ========================================== -->
                <!-- ENDE SERVICE-DETAIL-FELDER                 -->
                <!-- ========================================== -->

                <div class="form-group">
                    <label for="notizen" class="form-label">Notizen / Beschreibung <span class="required">*</span></label>
                    <textarea id="notizen" class="form-textarea" rows="4" placeholder="Detaillierte Beschreibung des Auftrags..." required></textarea>
                    <small style="color: var(--color-text-tertiary);">
                        ğŸ’¡ Diese Beschreibung wird im Angebot an den Kunden gesendet
                    </small>
                </div>

                <!-- DAT PDF UPLOAD -->
                <div class="form-group" style="background: var(--color-bg-secondary); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <label class="form-label">
                        ğŸ“„ DAT-Kalkulation hochladen (optional)
                        <span style="color: var(--color-text-tertiary); font-size: 12px; font-weight: normal; display: block; margin-top: 4px;">
                            Fahrzeugdaten und Kalkulation werden automatisch ausgefÃ¼llt
                        </span>
                    </label>
                    <div class="pdf-upload-container" style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
                        <button type="button" class="btn btn-secondary" style="font-size: 14px;"
                                onclick="document.getElementById('datPdfInput').click()">
                            ğŸ“„ PDF auswÃ¤hlen
                        </button>
                        <input type="file" id="datPdfInput" accept="application/pdf" style="display: none;">
                        <span id="pdfFileName" class="pdf-filename" style="color: var(--color-success); font-size: 14px;"></span>
                        <button type="button" id="pdfRemoveBtn" class="btn-icon-small"
                                style="display: none; background: transparent; border: none; cursor: pointer; font-size: 20px;"
                                onclick="removePdf()">âŒ</button>
                    </div>
                </div>

                        </div>
                    </div>
                </div>

                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                     ğŸ“Š SEKTION 4: KALKULATION (Orange) - COLLAPSIBLE
                     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <div class="collapsible-section is-open" id="kalkulation-collapsible">
                    <div class="collapsible-header" onclick="toggleCollapsible('kalkulation-collapsible')">
                        <div class="collapsible-header-left">
                            <span class="collapsible-header-title">
                                <i data-feather="edit-3"></i>
                                Kalkulation
                            </span>
                            <span class="collapsible-header-hint">Ersatzteile, Arbeitslohn, Lackierung, Material (optional)</span>
                        </div>
                        <div class="collapsible-header-right">
                            <i data-feather="chevron-down" class="collapsible-header-chevron"></i>
                        </div>
                    </div>
                    <div class="collapsible-content">
                        <div class="collapsible-content-inner">

                <!-- ERSATZTEILE TABELLE (Permanent, Editierbar) -->
                <div id="ersatzteileSection" style="margin-top: 20px; padding: 15px; background: rgba(79, 172, 254, 0.1); border-radius: 8px; border-left: 4px solid var(--color-primary);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h4 style="color: var(--color-primary); font-size: 16px; margin: 0; display: flex; align-items: center; gap: 8px;">
                            <svg data-feather="package" style="width: 20px; height: 20px;"></svg>
                            <span>Ersatzteile (<span id="ersatzteileCount">0</span>)</span>
                        </h4>
                        <button type="button" id="addErsatzteilBtn" onclick="addErsatzteilRow()" style="padding: 6px 12px; background: var(--color-primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                            <svg data-feather="plus" style="width: 14px; height: 14px;"></svg>
                            Zeile hinzufÃ¼gen
                        </button>
                    </div>
                    <div style="overflow-x: auto;">
                        <table id="ersatzteileTable" style="width: 100%; border-collapse: collapse; font-size: 13px;">
                            <thead>
                                <tr style="background: rgba(0,0,0,0.1); text-align: left;">
                                    <th style="padding: 8px; border-bottom: 2px solid var(--color-primary); width: 100px;">ETN</th>
                                    <th style="padding: 8px; border-bottom: 2px solid var(--color-primary);">Benennung</th>
                                    <th style="padding: 8px; border-bottom: 2px solid var(--color-primary); text-align: center; width: 60px;">Anzahl</th>
                                    <th style="padding: 8px; border-bottom: 2px solid var(--color-primary); text-align: right; width: 90px;">Einzelpreis</th>
                                    <th style="padding: 8px; border-bottom: 2px solid var(--color-primary); text-align: right; width: 100px; background: rgba(76, 175, 80, 0.15);" title="Original-Teile Preis">Original</th>
                                    <th style="padding: 8px; border-bottom: 2px solid var(--color-primary); text-align: right; width: 100px; background: rgba(255, 152, 0, 0.15);" title="Aftermarket-Teile Preis">Aftermarket</th>
                                    <th style="padding: 8px; border-bottom: 2px solid var(--color-primary); text-align: center; width: 40px;" title="Link zum Shop">ğŸ”—</th>
                                    <th style="padding: 8px; border-bottom: 2px solid var(--color-primary); text-align: center; width: 50px;">Aktion</th>
                                </tr>
                            </thead>
                            <tbody id="ersatzteileTableBody">
                                <!-- Dynamisch gefÃ¼llt - Zeilen werden durch JavaScript hinzugefÃ¼gt -->
                            </tbody>
                            <tfoot style="background: rgba(79, 172, 254, 0.1); font-weight: 600;">
                                <tr>
                                    <td colspan="4" style="padding: 8px; text-align: right;">SUMME:</td>
                                    <td style="padding: 8px; text-align: right; color: #4caf50; background: rgba(76, 175, 80, 0.1);" id="ersatzteileOriginalSumme">0.00 â‚¬</td>
                                    <td style="padding: 8px; text-align: right; color: #ff9800; background: rgba(255, 152, 0, 0.1);" id="ersatzteileAftermarketSumme">0.00 â‚¬</td>
                                    <td></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <p style="font-size: 11px; color: var(--color-text-secondary); margin-top: 10px; font-style: italic;">
                        ğŸ’¡ Tipp: Manuell Zeilen hinzufÃ¼gen mit dem "+ Zeile hinzufÃ¼gen" Button.
                    </p>
                </div>

                <!-- ARBEITSLOHN TABELLE (Permanent, Editierbar) -->
                <div id="arbeitslohnSection" style="margin-top: 20px; padding: 15px; background: rgba(76, 175, 80, 0.1); border-radius: 8px; border-left: 4px solid #4caf50;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h4 style="color: #4caf50; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                            <svg data-feather="clock" style="width: 20px; height: 20px;"></svg>
                            Arbeitslohn (<span id="arbeitslohnCount">0</span>)
                        </h4>
                        <button type="button" id="addArbeitslohnBtn" onclick="addArbeitslohnRow()" style="display: flex; align-items: center; gap: 6px; padding: 8px 14px; background: #4caf50; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s;">
                            <svg data-feather="plus" style="width: 16px; height: 16px;"></svg>
                            Zeile hinzufÃ¼gen
                        </button>
                    </div>
                    <div style="overflow-x: auto;">
                        <table id="arbeitslohnTable" style="width: 100%; border-collapse: collapse; font-size: 13px; background: white; border-radius: 4px; overflow: hidden;">
                            <thead>
                                <tr style="background: rgba(76, 175, 80, 0.1); text-align: left;">
                                    <th style="padding: 8px; border-bottom: 2px solid #4caf50;">Position</th>
                                    <th style="padding: 8px; border-bottom: 2px solid #4caf50; text-align: center;">Art</th>
                                    <th style="padding: 8px; border-bottom: 2px solid #4caf50; text-align: right;">Stunden</th>
                                    <th style="padding: 8px; border-bottom: 2px solid #4caf50; text-align: right;">Stundensatz</th>
                                    <th style="padding: 8px; border-bottom: 2px solid #4caf50; text-align: right;">Gesamtpreis</th>
                                    <th style="padding: 8px; border-bottom: 2px solid #4caf50; text-align: center; width: 60px;">Aktion</th>
                                </tr>
                            </thead>
                            <tbody id="arbeitslohnTableBody">
                                <!-- Dynamisch gefÃ¼llt -->
                            </tbody>
                            <tfoot style="background: rgba(76, 175, 80, 0.1); font-weight: 600;">
                                <tr>
                                    <td colspan="4" style="padding: 8px; text-align: right;">SUMME:</td>
                                    <td style="padding: 8px; text-align: right; color: #4caf50;" id="arbeitslohnTotal">0.00 â‚¬</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- LACKIERUNG TABELLE (Permanent, Editierbar) -->
                <div id="lackierungSection" style="margin-top: 20px; padding: 15px; background: rgba(156, 39, 176, 0.1); border-radius: 8px; border-left: 4px solid #9c27b0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h4 style="color: #9c27b0; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                            <svg data-feather="droplet" style="width: 20px; height: 20px;"></svg>
                            Lackierung (<span id="lackierungCount">0</span>)
                        </h4>
                        <button type="button" id="addLackierungBtn" onclick="addLackierungRow()" style="display: flex; align-items: center; gap: 6px; padding: 8px 14px; background: #9c27b0; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s;">
                            <svg data-feather="plus" style="width: 16px; height: 16px;"></svg>
                            Zeile hinzufÃ¼gen
                        </button>
                    </div>
                    <table id="lackierungTable" style="width: 100%; border-collapse: collapse; font-size: 13px; background: white; border-radius: 4px; overflow: hidden;">
                        <thead style="background: rgba(156, 39, 176, 0.1);">
                            <tr>
                                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #9c27b0;">Position</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #9c27b0;">Bereich</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #9c27b0;">Stunden</th>
                                <th style="padding: 10px; text-align: right; border-bottom: 2px solid #9c27b0;">Stundensatz</th>
                                <th style="padding: 10px; text-align: right; border-bottom: 2px solid #9c27b0;">Gesamtpreis</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #9c27b0; width: 60px;">Aktion</th>
                            </tr>
                        </thead>
                        <tbody id="lackierungTableBody"></tbody>
                        <tfoot style="background: rgba(156, 39, 176, 0.15); font-weight: bold;">
                            <tr>
                                <td colspan="4" style="padding: 10px; text-align: right; border-top: 2px solid #9c27b0;">SUMME:</td>
                                <td id="lackierungTotal" style="padding: 10px; text-align: right; color: #9c27b0; font-size: 1.1em; border-top: 2px solid #9c27b0;">0.00 â‚¬</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- MATERIALIEN TABELLE (Permanent, Editierbar) -->
                <div id="materialienSection" style="margin-top: 20px; padding: 15px; background: rgba(255, 152, 0, 0.1); border-radius: 8px; border-left: 4px solid #ff9800;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h4 style="color: #ff9800; font-size: 16px; display: flex; align-items: center; gap: 8px;">
                            <svg data-feather="package" style="width: 20px; height: 20px;"></svg>
                            Materialien (<span id="materialienCount">0</span>)
                        </h4>
                        <button type="button" id="addMaterialienBtn" onclick="addMaterialienRow()" style="display: flex; align-items: center; gap: 6px; padding: 8px 14px; background: #ff9800; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s;">
                            <svg data-feather="plus" style="width: 16px; height: 16px;"></svg>
                            Material hinzufÃ¼gen
                        </button>
                    </div>
                    <table id="materialienTable" style="width: 100%; border-collapse: collapse; font-size: 13px; background: white; border-radius: 4px; overflow: hidden;">
                        <thead style="background: rgba(255, 152, 0, 0.1);">
                            <tr>
                                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ff9800;">Material-Typ</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #ff9800;">Menge</th>
                                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #ff9800;">Einheit</th>
                                <th style="padding: 10px; text-align: right; border-bottom: 2px solid #ff9800;">Einheitspreis (â‚¬)</th>
                                <th style="padding: 10px; text-align: right; border-bottom: 2px solid #ff9800;">Gesamtpreis</th>
                                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #ff9800; width: 60px;">Aktion</th>
                            </tr>
                        </thead>
                        <tbody id="materialienTableBody"></tbody>
                        <tfoot style="background: rgba(255, 152, 0, 0.15); font-weight: bold;">
                            <tr>
                                <td colspan="4" style="padding: 10px; text-align: right; border-top: 2px solid #ff9800;">SUMME:</td>
                                <td id="materialienTotal" style="padding: 10px; text-align: right; color: #ff9800; font-size: 1.1em; border-top: 2px solid #ff9800;">0.00 â‚¬</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <!-- ===== ERSATZFAHRZEUG-KOSTEN ===== -->
                <div class="kalkulation-section" id="ersatzfahrzeugKostenSection" style="display: none; margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%); border-radius: 12px; border: 2px solid #ffc107;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin: 0; color: #f57c00; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.2em;">ğŸš—</span> Ersatzfahrzeug-Kosten
                        </h4>
                    </div>
                    <table id="ersatzfahrzeugKostenTable" style="width: 100%; border-collapse: collapse; font-size: 13px; background: white; border-radius: 4px; overflow: hidden;">
                        <thead>
                            <tr style="background: linear-gradient(to bottom, #fff8e1, #ffecb3);">
                                <th style="padding: 10px; text-align: left; color: #e65100; border-bottom: 2px solid #ffc107;">Fahrzeug</th>
                                <th style="padding: 10px; text-align: right; color: #e65100; border-bottom: 2px solid #ffc107;">Tagesmiete (â‚¬)</th>
                                <th style="padding: 10px; text-align: center; color: #e65100; border-bottom: 2px solid #ffc107;" title="Berechnung: Abholdatum â†’ Fertigstellungsdatum">Tage ğŸ“…</th>
                                <th style="padding: 10px; text-align: right; color: #e65100; border-bottom: 2px solid #ffc107;">Gesamt (â‚¬)</th>
                            </tr>
                        </thead>
                        <tbody id="ersatzfahrzeugKostenBody">
                            <!-- ğŸ”§ FIX (2025-11-27): Editierbare Inputs statt read-only -->
                            <tr>
                                <td id="ersatzfahrzeugName" style="padding: 10px; border-bottom: 1px solid #ffe082;">-</td>
                                <td style="padding: 10px; text-align: right; border-bottom: 1px solid #ffe082;">
                                    <input type="number" id="ersatzfahrzeugTagesmieteInput"
                                           step="0.01" min="0"
                                           onchange="recalcErsatzfahrzeug()"
                                           oninput="recalcErsatzfahrzeug()"
                                           style="width: 80px; text-align: right; padding: 5px; border: 1px solid #ffc107; border-radius: 4px; font-family: 'Courier New', monospace;">
                                </td>
                                <td style="padding: 10px; text-align: center; border-bottom: 1px solid #ffe082;">
                                    <input type="number" id="ersatzfahrzeugTageInput"
                                           min="1" step="1"
                                           onchange="recalcErsatzfahrzeug()"
                                           oninput="recalcErsatzfahrzeug()"
                                           style="width: 60px; text-align: center; padding: 5px; border: 1px solid #ffc107; border-radius: 4px; font-weight: bold;">
                                </td>
                                <td id="ersatzfahrzeugGesamtCalc" style="padding: 10px; text-align: right; border-bottom: 1px solid #ffe082; font-family: 'Courier New', monospace; font-weight: bold;">0,00 â‚¬</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" style="padding: 10px; text-align: right; border-top: 2px solid #ffc107; font-weight: bold;">SUMME:</td>
                                <td id="ersatzfahrzeugSumme" style="padding: 10px; text-align: right; color: #f57c00; font-size: 1.1em; border-top: 2px solid #ffc107; font-weight: bold;">0,00 â‚¬</td>
                            </tr>
                        </tfoot>
                    </table>
                    <small style="color: #795548; display: block; margin-top: 10px;">
                        ğŸ’¡ Tagesmiete Ã— Anzahl Tage (ab heute bis Abholdatum/Fertigstellung)
                    </small>
                </div>

                        </div>
                    </div>
                </div>

                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                     ğŸ’° SEKTION 5: PREISKALKULATION (Pink) - COLLAPSIBLE
                     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <div class="collapsible-section is-open" id="preis-collapsible">
                    <div class="collapsible-header" onclick="toggleCollapsible('preis-collapsible')">
                        <div class="collapsible-header-left">
                            <span class="collapsible-header-title">
                                <i data-feather="dollar-sign"></i>
                                Preiskalkulation
                            </span>
                            <span class="collapsible-header-hint">Varianten, Preis, Fertigstellungsdatum</span>
                        </div>
                        <div class="collapsible-header-right">
                            <i data-feather="chevron-down" class="collapsible-header-chevron"></i>
                        </div>
                    </div>
                    <div class="collapsible-content">
                        <div class="collapsible-content-inner">

                <!-- ğŸ†• 2-VARIANTEN-AUSWAHL (Nov 30, 2025) -->
                <!-- Kunde sieht beide Preise und wÃ¤hlt bei Annahme -->
                <div id="variantenSection" style="display: none; margin-bottom: var(--space-4);">
                    <label class="form-label">Preis-Varianten aus Kalkulation</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-3); margin-top: var(--space-2);">
                        <!-- Original-Variante -->
                        <div id="varianteOriginalCard" class="variante-card" style="
                            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
                            border: 2px solid #0ea5e9;
                            border-radius: var(--radius-card);
                            padding: var(--space-4);
                            text-align: center;
                        ">
                            <div style="font-size: 24px; margin-bottom: var(--space-2);">â­</div>
                            <div style="font-weight: 600; color: #0369a1; margin-bottom: var(--space-1);">Original</div>
                            <div style="font-size: 24px; font-weight: 700; color: #0c4a6e;" id="preisOriginalDisplay">-</div>
                            <div style="font-size: 12px; color: #64748b; margin-top: var(--space-1);">inkl. MwSt.</div>
                        </div>
                        <!-- Aftermarket-Variante -->
                        <div id="varianteAftermarketCard" class="variante-card" style="
                            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
                            border: 2px solid #22c55e;
                            border-radius: var(--radius-card);
                            padding: var(--space-4);
                            text-align: center;
                        ">
                            <div style="font-size: 24px; margin-bottom: var(--space-2);">ğŸ’°</div>
                            <div style="font-weight: 600; color: #15803d; margin-bottom: var(--space-1);">Aftermarket</div>
                            <div style="font-size: 24px; font-weight: 700; color: #14532d;" id="preisAftermarketDisplay">-</div>
                            <div style="font-size: 12px; color: #64748b; margin-top: var(--space-1);">inkl. MwSt.</div>
                        </div>
                    </div>
                    <small style="color: var(--color-text-tertiary); display: block; margin-top: var(--space-2);">
                        ğŸ’¡ Der Kunde sieht beide Varianten und kann bei der Annahme wÃ¤hlen.
                    </small>
                    <!-- Hidden inputs fÃ¼r beide Preise -->
                    <input type="hidden" id="summeBruttoOriginal" value="">
                    <input type="hidden" id="summeBruttoAftermarket" value="">
                </div>

                <!-- Manueller Preis (Fallback wenn keine Kalkulation) -->
                <div class="form-group" id="manuellerPreisSection">
                    <label for="vereinbarterPreis" class="form-label">Vereinbarter Preis (â‚¬) <span class="required">*</span></label>
                    <input type="number" id="vereinbarterPreis" class="form-input" placeholder="z.B. 450" step="0.01" min="0" required>
                    <small style="color: var(--color-text-tertiary);">
                        ğŸ’° Dieser Preis wird im Angebot genannt (inkl. MwSt.)
                    </small>
                </div>

                <div class="form-group">
                    <label for="geplantesAbnahmeDatum" class="form-label">Voraussichtliches Fertigstellungsdatum <span class="required">*</span></label>
                    <input type="date" id="geplantesAbnahmeDatum" class="form-input" required>
                    <small style="color: var(--color-text-tertiary);">
                        ğŸ“… Wann wird das Fahrzeug voraussichtlich fertig sein?
                    </small>

                    <!-- ğŸ“Š KapazitÃ¤tsvorschau - Wochenansicht (Dec 2025) -->
                    <div id="kapazitaetPreview" class="kapazitaet-preview">
                        <div class="kapazitaet-header">
                            <span>ğŸ“Š</span>
                            <span>KapazitÃ¤t fÃ¼r Woche <strong id="kapazitaetWocheLabel"></strong>:</span>
                        </div>
                        <div id="kapazitaetWeekGrid">
                            <!-- 7 Tage werden dynamisch generiert -->
                        </div>
                    </div>
                </div>

                        </div>
                    </div>
                </div>

                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                     ğŸ“· SEKTION 6: FOTOS & ABSCHLUSS (Violett) - COLLAPSIBLE
                     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <div class="collapsible-section is-open" id="fotos-collapsible">
                    <div class="collapsible-header" onclick="toggleCollapsible('fotos-collapsible')">
                        <div class="collapsible-header-left">
                            <span class="collapsible-header-title">
                                <i data-feather="camera"></i>
                                Fotos & Abschluss
                            </span>
                            <span class="collapsible-header-hint">Schadensfotos, Design-Galerie, Aktionen</span>
                        </div>
                        <div class="collapsible-header-right">
                            <i data-feather="chevron-down" class="collapsible-header-chevron"></i>
                        </div>
                    </div>
                    <div class="collapsible-content">
                        <div class="collapsible-content-inner">

                <div class="photo-section">
                    <label class="form-label">Schadensfotos</label>
                    <div class="photo-grid" id="photoGrid">
                        <div class="photo-item empty" onclick="document.getElementById('photoInput').click()">
                            <i data-feather="camera"></i>
                            <span>Foto hinzufÃ¼gen</span>
                        </div>
                    </div>
                    <input type="file" id="photoInput" accept="image/*" capture="environment" multiple style="display: none;">
                    <small style="color: var(--color-text-tertiary); display: block; margin-top: var(--space-2);">
                        ğŸ’¡ Tipp: Bis zu 10 Fotos, max. 5 MB pro Foto
                    </small>
                </div>

                <!-- ğŸ†• DESIGN-GALERIE (fÃ¼r Folierung/Werbebeklebung aus kalkulation.html) -->
                <div id="designGallerySection" style="display: none; margin-top: var(--space-6);">
                    <div class="section-title">
                        <i data-feather="image"></i>
                        Hochgeladene Designs (aus Kalkulation)
                    </div>
                    <div class="photo-section">
                        <div class="photo-grid" id="designGallery">
                            <!-- Dynamisch befÃ¼llt -->
                        </div>
                        <small style="color: var(--color-text-tertiary); display: block; margin-top: var(--space-2);">
                            ğŸ¨ Diese Designs wurden vom Meister in der Kalkulation hochgeladen
                        </small>
                    </div>
                </div>

                <!-- ACTION BUTTONS -->
                <div class="action-buttons">
                    <button type="button" class="btn btn-secondary btn-lg" onclick="saveEntwurf()">
                        <i data-feather="save"></i>
                        <span id="saveBtn">Entwurf aktualisieren</span>
                    </button>
                    <button type="button" class="btn btn-primary btn-lg" onclick="erstelleAngebot()">
                        <i data-feather="send"></i>
                        <span id="sendBtn">Angebot erstellen & versenden</span>
                    </button>
                    <!-- âœ… BUG #4 FIX: PDF Retry Button (shown only when PDF generation failed) -->
                    <button
                        type="button"
                        id="pdfRetryBtn"
                        class="btn btn-warning btn-lg"
                        style="display: none; margin-top: 10px;"
                        onclick="retryPDFGeneration()">
                        <i data-feather="refresh-cw"></i>
                        <span id="retryBtnText">PDF erneut generieren</span>
                    </button>
                </div>

                        </div>
                    </div>
                </div>

            </form>
        </div>
    </div>

    <!-- Firebase Konfiguration -->
    <script src="firebase-config.js?v=a4192c4"></script>
    <script src="js/auth-manager.js"></script>

    <script>
        // Initialize Feather Icons
        feather.replace();

        // ============================================
        // COLLAPSIBLE SECTIONS (UX Enhancement Dec 2025)
        // ============================================

        /**
         * Toggle eine Collapsible Section auf/zu
         * @param {string} sectionId - Die ID der Section (z.B. 'kunden-collapsible')
         */
        function toggleCollapsible(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) {
                console.warn(`[toggleCollapsible] Section nicht gefunden: ${sectionId}`);
                return;
            }

            section.classList.toggle('is-open');

            // Re-render Feather Icons nach Toggle (fÃ¼r Chevron Animation)
            setTimeout(() => {
                feather.replace();
            }, 50);

            console.log(`ğŸ”½ Section "${sectionId}" ist jetzt ${section.classList.contains('is-open') ? 'offen' : 'geschlossen'}`);
        }

        /**
         * Toggle eine Sub-Section (Nested Collapsible innerhalb Service & Abholung)
         * @param {string} sectionId - Die ID der Sub-Section (z.B. 'reifen-felder')
         */
        function toggleSubSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) {
                console.warn(`[toggleSubSection] Sub-Section nicht gefunden: ${sectionId}`);
                return;
            }

            section.classList.toggle('is-open');

            // Re-render Feather Icons nach Toggle (fÃ¼r Chevron Animation)
            setTimeout(() => {
                feather.replace();
            }, 50);

            console.log(`ğŸ“‚ Sub-Section "${sectionId}" ist jetzt ${section.classList.contains('is-open') ? 'offen' : 'geschlossen'}`);
        }

        // ============================================
        // ğŸ“‹ AUFTRAGSINFORMATIONEN-ÃœBERSICHT (Order Summary)
        // ============================================

        /**
         * Update Order Summary with current entwurf data
         * Called when a draft is selected
         */
        function updateOrderSummary(entwurf) {
            if (!entwurf) {
                document.getElementById('orderSummary').classList.remove('visible');
                return;
            }

            // Service Labels Map
            const serviceLabels = {
                'lackier': 'Lackierung',
                'lackierung': 'Lackierung',
                'reifen': 'Reifen-Service',
                'mechanik': 'Mechanik',
                'pflege': 'Fahrzeugpflege',
                'tuev': 'TÃœV/AU',
                'versicherung': 'Versicherungsschaden',
                'glas': 'Glasreparatur',
                'klima': 'Klimaservice',
                'dellen': 'DellendrÃ¼cken (PDR)',
                'folierung': 'Folierung',
                'steinschutz': 'Steinschutzfolie',
                'werbebeklebung': 'Werbebeklebung'
            };

            // Service Emojis Map
            const serviceEmojis = {
                'lackier': 'ğŸ¨', 'lackierung': 'ğŸ¨',
                'reifen': 'ğŸ›', 'mechanik': 'ğŸ”§',
                'pflege': 'âœ¨', 'tuev': 'ğŸ“',
                'versicherung': 'ğŸ“‹', 'glas': 'ğŸªŸ',
                'klima': 'â„ï¸', 'dellen': 'ğŸ”¨',
                'folierung': 'ğŸ­', 'steinschutz': 'ğŸ›¡ï¸',
                'werbebeklebung': 'ğŸ“¢'
            };

            // ğŸš— Fahrzeug
            document.getElementById('summary-kennzeichen').textContent = entwurf.kennzeichen || '-';
            const fahrzeugText = [entwurf.marke, entwurf.modell].filter(Boolean).join(' ') || '-';
            document.getElementById('summary-fahrzeug').textContent = fahrzeugText;
            // Farbe kann in mehreren Feldern gespeichert sein
            document.getElementById('summary-farbe').textContent =
                entwurf.farbe || entwurf.farbname || entwurf.serviceDetails?.farbname || '-';
            document.getElementById('summary-kmstand').textContent = entwurf.kmstand ? `${Number(entwurf.kmstand).toLocaleString('de-DE')} km` : '-';

            // ğŸ‘¤ Kunde
            document.getElementById('summary-kundenname').textContent = entwurf.kundenname || '-';
            document.getElementById('summary-telefon').textContent = entwurf.telefon || '-';
            document.getElementById('summary-email').textContent = entwurf.kundenEmail || '-';
            const datum = entwurf.createdAt?.toDate?.() || (entwurf.createdAt ? new Date(entwurf.createdAt) : new Date());
            document.getElementById('summary-datum').textContent = datum.toLocaleDateString('de-DE');

            // ğŸ”§ Services
            let services = [];
            if (Array.isArray(entwurf.serviceTyp)) {
                services = entwurf.serviceTyp;
            } else if (entwurf.serviceTyp) {
                services = [entwurf.serviceTyp];
            }
            // Add additional services
            if (Array.isArray(entwurf.additionalServices)) {
                entwurf.additionalServices.forEach(s => {
                    const sType = typeof s === 'string' ? s : s.serviceTyp;
                    if (sType && !services.includes(sType)) {
                        services.push(sType);
                    }
                });
            }

            const serviceNames = services.map(s => serviceLabels[s] || s);
            document.getElementById('summary-services').textContent = serviceNames.join(', ') || '-';
            document.getElementById('summary-service-count').textContent = services.length > 0 ? `${services.length} Service${services.length > 1 ? 's' : ''}` : '-';

            // ğŸ“… Termine
            const formatDate = (dateStr) => {
                if (!dateStr) return '-';
                try {
                    const d = new Date(dateStr);
                    return d.toLocaleDateString('de-DE');
                } catch {
                    return dateStr;
                }
            };
            // ğŸ”§ FIX: Feldnamen-Konsistenz prÃ¼fen
            // - abholdatum = Wann wird das Fahrzeug beim Kunden abgeholt (Anlieferung zur Werkstatt)
            // - geplantesAbnahmeDatum = Wann ist das Fahrzeug fertig (Abholung durch Kunden)
            // - anliefertermin, abholtermin = alternative Feldnamen
            document.getElementById('summary-anlieferung').textContent = formatDate(
                entwurf.anliefertermin || entwurf.abholdatum || entwurf.anlieferdatum
            );
            document.getElementById('summary-abholung').textContent = formatDate(
                entwurf.geplantesAbnahmeDatum || entwurf.abholtermin || entwurf.fertigstellungsdatum
            );

            // ğŸ”§ FIX: ersatzfahrzeugGewuenscht kann an verschiedenen Stellen gespeichert sein
            // PrÃ¼fe auch serviceDetailsPerService fÃ¼r jeden Service-Typ
            let ersatzfahrzeugValue = entwurf.ersatzfahrzeugGewuenscht ||
                                      entwurf.ersatzfahrzeug ||
                                      entwurf.serviceDetails?.ersatzfahrzeugGewuenscht ||
                                      entwurf.kalkulation?.ersatzfahrzeug;

            // Falls nicht gefunden, suche in serviceDetailsPerService
            if (!ersatzfahrzeugValue && entwurf.serviceDetailsPerService) {
                for (const serviceTyp of Object.keys(entwurf.serviceDetailsPerService)) {
                    const serviceDetails = entwurf.serviceDetailsPerService[serviceTyp];
                    if (serviceDetails?.ersatzfahrzeugGewuenscht) {
                        ersatzfahrzeugValue = serviceDetails.ersatzfahrzeugGewuenscht;
                        break;
                    }
                }
            }

            // Normalisiere den Wert (kann true, 'true', 'ja', 'Ja' sein)
            const ersatzfahrzeug = ersatzfahrzeugValue === true ||
                                   ersatzfahrzeugValue === 'true' ||
                                   ersatzfahrzeugValue === 'ja' ||
                                   ersatzfahrzeugValue === 'Ja';
            const ersatzfahrzeugEl = document.getElementById('summary-ersatzfahrzeug');
            ersatzfahrzeugEl.textContent = ersatzfahrzeug ? 'âœ… Ja, gewÃ¼nscht' : 'âŒ Nein';
            ersatzfahrzeugEl.className = 'info-value ' + (ersatzfahrzeug ? 'success' : '');

            // ğŸ“ Beschreibung
            document.getElementById('summary-beschreibung').textContent = entwurf.notizen || entwurf.schadenBeschreibung || entwurf.beschreibung || '-';

            // ğŸ“¦ Service-Details Grid
            const serviceDetailsGrid = document.getElementById('serviceDetailsGrid');
            serviceDetailsGrid.innerHTML = '';

            // Generate service detail cards
            services.forEach(serviceTyp => {
                const details = getServiceDetailsForSummary(entwurf, serviceTyp);
                if (details && details.length > 0) {
                    const card = document.createElement('div');
                    card.className = `service-detail-card service-card-${serviceTyp}`;
                    card.innerHTML = `
                        <div class="service-detail-card-header">
                            ${serviceEmojis[serviceTyp] || 'ğŸ”§'} ${serviceLabels[serviceTyp] || serviceTyp}
                        </div>
                        <div class="service-detail-card-content">
                            ${details.map(d => `
                                <div class="detail-item">
                                    <span class="detail-label">${d.label}</span>
                                    <span class="detail-value">${d.value}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    serviceDetailsGrid.appendChild(card);
                }
            });

            // Show/hide service details section
            document.getElementById('serviceDetailsSummary').style.display = serviceDetailsGrid.children.length > 0 ? 'block' : 'none';

            // Show the summary
            document.getElementById('orderSummary').classList.add('visible');
            feather.replace();
            console.log('ğŸ“‹ Auftragsinformationen-Ãœbersicht aktualisiert');
        }

        /**
         * Get service-specific details for summary display
         */
        function getServiceDetailsForSummary(entwurf, serviceTyp) {
            const details = [];
            const sd = entwurf.serviceDetails || {};

            // Check additionalServices for this serviceTyp
            let additionalServiceDetails = null;
            if (Array.isArray(entwurf.additionalServices)) {
                const found = entwurf.additionalServices.find(s =>
                    (typeof s === 'string' ? s : s.serviceTyp) === serviceTyp
                );
                if (found && found.serviceDetails) {
                    additionalServiceDetails = found.serviceDetails;
                }
            }

            // Merge details (additionalServiceDetails takes precedence)
            const mergedDetails = { ...sd, ...additionalServiceDetails };

            switch (serviceTyp) {
                case 'lackier':
                case 'lackierung':
                    if (mergedDetails.farbname) details.push({ label: 'Farbname', value: mergedDetails.farbname });
                    if (mergedDetails.farbnummer) details.push({ label: 'Farbnummer', value: mergedDetails.farbnummer });
                    // Ersatzfahrzeug ist in serviceDetails gespeichert
                    if (mergedDetails.ersatzfahrzeugGewuenscht === true || mergedDetails.ersatzfahrzeugGewuenscht === 'true') {
                        details.push({ label: 'Ersatzfahrzeug', value: 'âœ… Ja, gewÃ¼nscht' });
                    }
                    break;

                case 'reifen':
                    if (mergedDetails.reifengroesse) details.push({ label: 'ReifengrÃ¶ÃŸe', value: mergedDetails.reifengroesse });
                    if (mergedDetails.reifenanzahl) details.push({ label: 'Anzahl Reifen', value: mergedDetails.reifenanzahl });
                    if (mergedDetails.reifentyp) details.push({ label: 'Reifen-Typ', value: mergedDetails.reifentyp });
                    break;

                case 'mechanik':
                    if (mergedDetails.mechanikSymptome || mergedDetails.symptome) details.push({ label: 'Symptome / Beschreibung', value: mergedDetails.mechanikSymptome || mergedDetails.symptome });
                    if (mergedDetails.mechanikProblem || mergedDetails.problem) details.push({ label: 'Problem / Auftrag', value: mergedDetails.mechanikProblem || mergedDetails.problem });
                    break;

                case 'pflege':
                    if (mergedDetails.zusatzleistungen) details.push({ label: 'Zusatzleistungen', value: mergedDetails.zusatzleistungen });
                    if (mergedDetails.paket) details.push({ label: 'Pflege-Paket', value: mergedDetails.paket });
                    break;

                case 'tuev':
                    if (mergedDetails.pruefart) details.push({ label: 'PrÃ¼fart', value: mergedDetails.pruefart });
                    if (mergedDetails.bekannteMaengel) details.push({ label: 'Bekannte MÃ¤ngel', value: mergedDetails.bekannteMaengel });
                    if (mergedDetails.faelligkeit) details.push({ label: 'Letztes HU-Datum / FÃ¤lligkeit', value: mergedDetails.faelligkeit });
                    break;

                case 'versicherung':
                    if (mergedDetails.versicherung) details.push({ label: 'Versicherung', value: mergedDetails.versicherung });
                    if (mergedDetails.schadensnummer) details.push({ label: 'Schadensnummer', value: mergedDetails.schadensnummer });
                    if (mergedDetails.schadendatum) details.push({ label: 'Schadendatum', value: mergedDetails.schadendatum });
                    if (mergedDetails.unfallhergang) details.push({ label: 'Unfallhergang / Beschreibung', value: mergedDetails.unfallhergang });
                    break;

                case 'glas':
                    if (mergedDetails.schadensgroesse) details.push({ label: 'SchadensgrÃ¶ÃŸe', value: mergedDetails.schadensgroesse });
                    if (mergedDetails.glasposition) details.push({ label: 'Position', value: mergedDetails.glasposition });
                    if (mergedDetails.scheibentyp) details.push({ label: 'Scheibentyp', value: mergedDetails.scheibentyp });
                    break;

                case 'klima':
                    if (mergedDetails.klimaservice) details.push({ label: 'GewÃ¼nschter Service', value: mergedDetails.klimaservice });
                    if (mergedDetails.klimaproblem) details.push({ label: 'Problembeschreibung', value: mergedDetails.klimaproblem });
                    if (mergedDetails.kaeltemittel) details.push({ label: 'KÃ¤ltemittel-Typ', value: mergedDetails.kaeltemittel?.toUpperCase() });
                    break;

                case 'dellen':
                    if (mergedDetails.dellenpositionen) details.push({ label: 'Positionen / Beschreibung', value: mergedDetails.dellenpositionen });
                    if (mergedDetails.dellenanzahl) details.push({ label: 'Anzahl Dellen', value: mergedDetails.dellenanzahl });
                    if (mergedDetails.dellengroesse) details.push({ label: 'Durchschnittliche GrÃ¶ÃŸe', value: mergedDetails.dellengroesse });
                    if (mergedDetails.lackschaden) details.push({ label: 'Lackschaden vorhanden?', value: mergedDetails.lackschaden });
                    break;

                case 'folierung':
                    if (mergedDetails.folierungInfo) details.push({ label: 'ZusÃ¤tzliche Informationen', value: mergedDetails.folierungInfo });
                    if (mergedDetails.folierungArt) details.push({ label: 'Folierungs-Art', value: mergedDetails.folierungArt });
                    if (mergedDetails.folierungMaterial) details.push({ label: 'Folien-Typ / Material', value: mergedDetails.folierungMaterial });
                    if (mergedDetails.folierungFarbe) details.push({ label: 'Wunschfarbe', value: mergedDetails.folierungFarbe });
                    if (mergedDetails.folierungDesign) details.push({ label: 'Design-Beschreibung', value: mergedDetails.folierungDesign });
                    break;

                case 'steinschutz':
                    if (mergedDetails.steinschutzBereiche) details.push({ label: 'Bereiche (Details)', value: mergedDetails.steinschutzBereiche });
                    if (mergedDetails.steinschutzUmfang) details.push({ label: 'Umfang', value: mergedDetails.steinschutzUmfang });
                    if (mergedDetails.steinschutzInfo) details.push({ label: 'ZusÃ¤tzliche Informationen', value: mergedDetails.steinschutzInfo });
                    if (mergedDetails.steinschutzMaterial) details.push({ label: 'Schutzfolien-Typ / Material', value: mergedDetails.steinschutzMaterial });
                    break;

                case 'werbebeklebung':
                    if (mergedDetails.werbebeklebungInfo) details.push({ label: 'ZusÃ¤tzliche Informationen', value: mergedDetails.werbebeklebungInfo });
                    if (mergedDetails.werbebeklebungText) details.push({ label: 'Beschriftungstext', value: mergedDetails.werbebeklebungText });
                    if (mergedDetails.werbebeklebungUmfang) details.push({ label: 'Umfang', value: mergedDetails.werbebeklebungUmfang });
                    if (mergedDetails.werbebeklebungKomplexitaet) details.push({ label: 'Design-KomplexitÃ¤t', value: mergedDetails.werbebeklebungKomplexitaet });
                    if (mergedDetails.werbebeklebungFarbanzahl) details.push({ label: 'Anzahl Farben im Design', value: mergedDetails.werbebeklebungFarbanzahl });
                    break;
            }

            return details;
        }

        /**
         * Alle Sections auf einmal Ã¶ffnen/schlieÃŸen
         * @param {boolean} open - true = Ã¶ffnen, false = schlieÃŸen
         */
        function toggleAllSections(open) {
            const sections = document.querySelectorAll('.collapsible-section');
            sections.forEach(section => {
                if (open) {
                    section.classList.add('is-open');
                } else {
                    section.classList.remove('is-open');
                }
            });
            feather.replace();
            console.log(`ğŸ”½ Alle Sections ${open ? 'geÃ¶ffnet' : 'geschlossen'}`);
        }

        // Global State
        let firebaseInitialized = false;
        let offeneEntwuerfe = [];
        let currentEntwurf = null;
        let currentEntwurfId = null;

        // Kalkulations-Tabellen Data
        let ersatzteileData = [];
        let arbeitslohnData = [];
        let lackierungData = [];
        let materialienData = [];

        // PDF Upload Data
        let pdfData = null;

        // Photo Upload Data
        let photos = [];

        // ============================================
        // HELPER: BASE64 TO BLOB (FIX: Nov 17, 2025 - BUG #2)
        // ============================================

        /**
         * Convert Base64 string to Blob for file download
         * @param {string} base64 - Base64 encoded string
         * @param {string} mimeType - MIME type (e.g., 'application/pdf')
         * @returns {Blob}
         */
        function base64ToBlob(base64, mimeType) {
            const byteCharacters = atob(base64);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            return new Blob([byteArray], { type: mimeType });
        }

        // ============================================
        // PDF.js WORKER CONFIGURATION
        // ============================================

        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc =
                'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
            console.log('âœ… PDF.js Worker configured');
        }

        // ============================================
        // FIREBASE INITIALIZATION
        // ============================================

        window.addEventListener('load', async () => {
            try {
                console.log('ğŸ”¥ === ENTWÃœRFE-BEARBEITEN.HTML INIT ===');

                // âœ… FIX: Wait for Firebase initialization (Promise-based)
                if (window.firebaseInitialized) {
                    console.log('â³ Warte auf Firebase Initialisierung...');
                    await window.firebaseInitialized;
                } else if (!window.db) {
                    // Fallback: Poll for window.db
                    await new Promise((resolve) => {
                        const interval = setInterval(() => {
                            if (window.db) {
                                clearInterval(interval);
                                resolve();
                            }
                        }, 100);
                    });
                }
                console.log('âœ… Firebase initialisiert');

                // âœ… FIX: Wait for Auth Manager to set werkstattId
                if (!window.werkstattId) {
                    console.log('â³ Warte auf Auth Manager (werkstattId)...');
                    await new Promise((resolve, reject) => {
                        const timeout = setTimeout(() => {
                            console.warn('âš ï¸ Auth timeout - prÃ¼fe ob User eingeloggt ist');
                            reject(new Error('Auth timeout - bitte einloggen'));
                        }, 10000);
                        const interval = setInterval(() => {
                            if (window.werkstattId) {
                                clearInterval(interval);
                                clearTimeout(timeout);
                                resolve();
                            }
                        }, 100);
                    });
                }

                firebaseInitialized = true;
                console.log('âœ… Firebase + Auth Manager initialisiert, werkstattId:', window.werkstattId);

                // ğŸ›¡ï¸ SECURITY: Page-Level Access Control (Pattern 6 - Defense in Depth)
                // Partner-Accounts dÃ¼rfen NICHT auf Werkstatt-Seiten zugreifen
                // âœ… FIX: Jetzt funktioniert dieser Check, da window.currentUser gesetzt ist
                if (window.currentUser?.role === 'partner') {
                    console.warn('ğŸš« Partner-Zugriff blockiert! Redirect zu Partner-Portal...');
                    showToast('âš ï¸ Zugriff verweigert. Sie werden zum Partner-Portal weitergeleitet...', 'error', 3000);
                    setTimeout(() => {
                        safeNavigate('./partner-app/meine-anfragen.html');
                    }, 2000);
                    return; // Stop further execution
                }

                // Load drafts
                await loadOffeneEntwuerfe();

                // âš ï¸ Load expired Leihfahrzeug requests (Dec 8, 2025)
                await loadAbgelaufeneAnfragen();

                // ğŸ”§ FIX Nov 29, 2025: URL-Parameter ?id= verarbeiten (von kalkulation.html)
                const urlParams = new URLSearchParams(window.location.search);
                const entwurfIdFromUrl = urlParams.get('id');
                if (entwurfIdFromUrl) {
                    console.log('ğŸ“Œ URL-Parameter gefunden, lade Entwurf direkt:', entwurfIdFromUrl);
                    // Entwurf direkt laden (auch wenn Status != 'offen')
                    await loadEntwurfById(entwurfIdFromUrl);
                }

                // ğŸš— Ersatzfahrzeug Toggle initialisieren (FIX: Nov 27, 2025)
                initErsatzfahrzeugToggle();

                // ğŸš— Abholung Toggle initialisieren (FIX: Nov 27, 2025)
                initAbholungToggle();

            } catch (error) {
                console.error('âŒ Fehler bei Initialisierung:', error);
                showToast('âŒ Fehler beim Laden der EntwÃ¼rfe', 'error', 6000);
            }
        });

        // ============================================
        // LOAD OFFENE ENTWÃœRFE
        // ============================================

        async function loadOffeneEntwuerfe() {
            try {
                console.log('ğŸ“¥ === LADE OFFENE ENTWÃœRFE ===');

                if (!window.db) {
                    throw new Error('Firebase nicht initialisiert');
                }

                // âœ… SECURITY FIX: No 'mosbach' fallback - werkstattId must be validated at login
                if (!window.werkstattId) {
                    throw new Error('werkstattId nicht gesetzt');
                }
                const werkstattId = window.werkstattId;
                const collectionName = `partnerAnfragen_${werkstattId}`;

                // ğŸ”§ FIX Dec 8, 2025 (v2): BEIDE Status laden fÃ¼r RÃ¼ckwÃ¤rtskompatibilitÃ¤t
                // 'offen' = alte EntwÃ¼rfe (vor Pipeline-Ã„nderung)
                // 'kalkulation_erstellt' = neue EntwÃ¼rfe (nach KVA in kalkulation.html)
                const validStatus = ['offen', 'kalkulation_erstellt'];
                console.log(`ğŸ” Query: ${collectionName} WHERE isEntwurf==true AND entwurfStatus IN [${validStatus.join(', ')}]`);

                // ğŸ”§ FIX Dec 8, 2025: orderBy entfernt (braucht Composite Index), stattdessen JS-Sortierung
                const snapshot = await window.db
                    .collection(collectionName)
                    .where('isEntwurf', '==', true)
                    .where('entwurfStatus', 'in', validStatus)
                    .get();

                offeneEntwuerfe = snapshot.docs.map(doc => ({
                    id: doc.id,
                    source: 'partnerAnfragen',  // Quelle markieren
                    ...doc.data()
                }));

                // ğŸ”§ FIX Dec 8, 2025 (v2): Firestore Timestamp â†’ ISO String Conversion
                const toSortableDate = (val) => {
                    if (!val) return '';
                    if (typeof val === 'string') return val;
                    if (val.toDate) return val.toDate().toISOString(); // Firestore Timestamp
                    if (val instanceof Date) return val.toISOString();
                    return String(val);
                };

                // ğŸ”§ FIX Dec 8, 2025: JavaScript-Sortierung statt Firestore orderBy (vermeidet Index-Fehler)
                offeneEntwuerfe.sort((a, b) => {
                    const dateA = toSortableDate(a.timestamp);
                    const dateB = toSortableDate(b.timestamp);
                    return dateB.localeCompare(dateA); // desc (neueste zuerst)
                });

                // ğŸ†• Pipeline-Optimierung (2025-12-08): Auch Fahrzeuge mit 'kalkulation_erstellt' laden
                // Diese kommen direkt aus annahme.html â†’ kalkulation.html
                // ğŸ”§ FIX Dec 8, 2025: orderBy entfernt (braucht Composite Index), stattdessen JS-Sortierung
                try {
                    const fahrzeugeSnapshot = await window.getCollection('fahrzeuge')
                        .where('status', '==', 'kalkulation_erstellt')
                        .get();

                    const fahrzeugeEntwuerfe = fahrzeugeSnapshot.docs.map(doc => ({
                        id: doc.id,
                        source: 'fahrzeuge',  // Quelle markieren
                        // Map fahrzeuge fields to entwurf format
                        kennzeichen: doc.data().kennzeichen,
                        kundenname: doc.data().kundenname,
                        kundenEmail: doc.data().kundenEmail,
                        datum: doc.data().annahmeDatum,
                        serviceTyp: doc.data().serviceTyp,
                        fahrzeugId: doc.id,
                        kalkulationData: doc.data().kalkulationData,
                        ...doc.data()
                    }));

                    // ğŸ”§ FIX Dec 8, 2025 (v2): JavaScript-Sortierung mit Timestamp-Conversion
                    fahrzeugeEntwuerfe.sort((a, b) => {
                        const dateA = toSortableDate(a.annahmeDatum || a.datum);
                        const dateB = toSortableDate(b.annahmeDatum || b.datum);
                        return dateB.localeCompare(dateA); // desc (neueste zuerst)
                    });

                    offeneEntwuerfe = [...offeneEntwuerfe, ...fahrzeugeEntwuerfe];
                    console.log(`âœ… ${fahrzeugeEntwuerfe.length} Fahrzeuge mit status='kalkulation_erstellt' hinzugefÃ¼gt`);
                } catch (fahrzeugeError) {
                    console.warn('âš ï¸ Fahrzeuge-Query fehlgeschlagen:', fahrzeugeError);
                }

                console.log(`âœ… ${offeneEntwuerfe.length} offene EntwÃ¼rfe geladen (inkl. Fahrzeuge mit Kalkulation)`);

                // Populate dropdown
                const dropdown = document.getElementById('entwurfDropdown');
                const emptyState = document.getElementById('emptyState');

                dropdown.innerHTML = '<option value="">-- Bitte wÃ¤hlen --</option>';

                if (offeneEntwuerfe.length === 0) {
                    emptyState.style.display = 'block';
                    dropdown.disabled = true;
                } else {
                    emptyState.style.display = 'none';
                    dropdown.disabled = false;

                    offeneEntwuerfe.forEach(entwurf => {
                        const option = document.createElement('option');
                        option.value = entwurf.id;
                        option.textContent = `${entwurf.kennzeichen} - ${entwurf.kundenname} (${entwurf.datum || 'Kein Datum'})`;
                        dropdown.appendChild(option);
                    });
                }

                feather.replace(); // Re-render icons

            } catch (error) {
                console.error('âŒ Fehler beim Laden der EntwÃ¼rfe:', error);
                showToast(`âŒ Fehler: ${error.message}`, 'error', 6000);
            }
        }

        // ============================================
        // KALKULATIONS-TABELLEN FUNKTIONEN
        // ============================================

        // ========================================
        // ERSATZTEILE TABLE
        // ========================================

        function addErsatzteilRow(data = {}) {
            const tableBody = document.getElementById('ersatzteileTableBody');
            const rowIndex = ersatzteileData.length;

            // Daten mit Defaults
            // ğŸ†• FIX Nov 30, 2025: preisOriginal + preisAftermarket fÃ¼r Varianten-Berechnung
            const menge = parseFloat(data.anzahl) || parseFloat(data.menge) || 1;
            const einzelpreis = parseFloat(data.einzelpreis) || parseFloat(data.preis) || 0;
            const gesamtpreis = parseFloat(data.gesamtpreis) || (menge * einzelpreis);

            // ğŸ”§ FIX Dec 3, 2025 v2: Korrekte Varianten-Logik fÃ¼r Ersatzteile
            // Jedes Teil ist ENTWEDER Original ODER Aftermarket, NICHT beide!
            // - hasOriginal = true, hasAftermarket = false â†’ Original-Teil (preisAftermarket = 0)
            // - hasOriginal = false, hasAftermarket = true â†’ Aftermarket-Teil (preisOriginal = 0)
            // - hasOriginal = true, hasAftermarket = true â†’ Beide Preise (Mischfall, selten)
            // - keins vorhanden â†’ Legacy-Daten (beide = gesamtpreis fÃ¼r AbwÃ¤rtskompatibilitÃ¤t)
            const hasOriginal = data.preisOriginal !== undefined && data.preisOriginal !== null && data.preisOriginal !== '';
            const hasAftermarket = data.preisAftermarket !== undefined && data.preisAftermarket !== null && data.preisAftermarket !== '';

            // Bestimme Preise basierend auf vorhandenen Daten
            let preisOriginal, preisAftermarket;

            if (hasOriginal || hasAftermarket) {
                // Varianten-Daten vorhanden â†’ Werte direkt Ã¼bernehmen (0 ist gÃ¼ltig!)
                preisOriginal = hasOriginal ? parseFloat(data.preisOriginal) : 0;
                preisAftermarket = hasAftermarket ? parseFloat(data.preisAftermarket) : 0;
            } else {
                // Legacy-Daten ohne Varianten â†’ beide Preise = gesamtpreis
                preisOriginal = gesamtpreis;
                preisAftermarket = gesamtpreis;
            }

            // ğŸ”§ FIX Dec 4, 2025: bestellLink/url aus KVA Ã¼bernehmen
            const bestellLink = data.bestellLink || data.url || data.link || '';

            const teil = {
                etn: data.etn || data.teilenummer || '',
                benennung: data.benennung || data.name || '',
                anzahl: menge,
                einzelpreis: einzelpreis,
                gesamtpreis: gesamtpreis,
                preisOriginal: preisOriginal,
                preisAftermarket: preisAftermarket,
                bestellLink: bestellLink
            };

            // In globales Array speichern
            ersatzteileData.push(teil);

            // Neue Zeile erstellen
            const row = document.createElement('tr');
            row.dataset.index = rowIndex;
            row.style.borderBottom = '1px solid rgba(0,0,0,0.1)';
            row.style.background = rowIndex % 2 === 0 ? 'rgba(255,255,255,0.5)' : 'transparent';

            row.innerHTML = `
                <td style="padding: 4px;">
                    <input type="text" value="${teil.etn}" onchange="updateErsatzteil(${rowIndex}, 'etn', this.value)"
                           style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 11px;">
                </td>
                <td style="padding: 4px;">
                    <input type="text" value="${teil.benennung}" onchange="updateErsatzteil(${rowIndex}, 'benennung', this.value)"
                           style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 11px;">
                </td>
                <td style="padding: 4px;">
                    <input type="number" value="${teil.anzahl}" onchange="updateErsatzteil(${rowIndex}, 'anzahl', this.value)" min="1" step="1"
                           style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px; text-align: center; font-size: 11px;">
                </td>
                <td style="padding: 4px;">
                    <input type="number" value="${teil.einzelpreis.toFixed(2)}" onchange="updateErsatzteil(${rowIndex}, 'einzelpreis', this.value)" min="0" step="0.01"
                           style="width: 100%; padding: 4px; border: 1px solid #ddd; border-radius: 4px; text-align: right; font-family: 'Courier New', monospace; font-size: 11px;">
                </td>
                <td style="padding: 4px; background: rgba(76, 175, 80, 0.08);">
                    <input type="number" value="${teil.preisOriginal.toFixed(2)}" onchange="updateErsatzteil(${rowIndex}, 'preisOriginal', this.value)" min="0" step="0.01"
                           style="width: 100%; padding: 4px; border: 1px solid #4caf50; border-radius: 4px; text-align: right; font-weight: 600; color: #4caf50; font-family: 'Courier New', monospace; font-size: 11px;"
                           title="Original-Teil Preis">
                </td>
                <td style="padding: 4px; background: rgba(255, 152, 0, 0.08);">
                    <input type="number" value="${teil.preisAftermarket.toFixed(2)}" onchange="updateErsatzteil(${rowIndex}, 'preisAftermarket', this.value)" min="0" step="0.01"
                           style="width: 100%; padding: 4px; border: 1px solid #ff9800; border-radius: 4px; text-align: right; font-weight: 600; color: #ff9800; font-family: 'Courier New', monospace; font-size: 11px;"
                           title="Aftermarket-Teil Preis">
                </td>
                <td style="padding: 4px; text-align: center;">
                    ${teil.bestellLink ? `<a href="${teil.bestellLink}" target="_blank" title="${teil.bestellLink}" style="color: #2196f3; font-size: 14px;">ğŸ”—</a>` : '<span style="color: #ccc;">-</span>'}
                </td>
                <td style="padding: 4px; text-align: center;">
                    <button type="button" onclick="deleteErsatzteilRow(${rowIndex})"
                            style="padding: 4px 6px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 10px;">
                        ğŸ—‘ï¸
                    </button>
                </td>
            `;

            tableBody.appendChild(row);
            updateErsatzteileSumme();
            if (typeof feather !== 'undefined') feather.replace();
        }

        function updateErsatzteil(index, field, value) {
            if (!ersatzteileData[index]) return;

            const row = document.querySelector(`tr[data-index="${index}"]`);

            if (field === 'anzahl' || field === 'einzelpreis') {
                // Anzahl oder Einzelpreis geÃ¤ndert â†’ beide Varianten proportional aktualisieren
                ersatzteileData[index][field] = parseFloat(value) || 0;
                const menge = ersatzteileData[index].anzahl;
                const einzelpreis = ersatzteileData[index].einzelpreis;

                // Altes VerhÃ¤ltnis zwischen Original und Aftermarket beibehalten
                const oldOriginal = ersatzteileData[index].preisOriginal || 1;
                const oldAftermarket = ersatzteileData[index].preisAftermarket || oldOriginal;
                const ratio = oldAftermarket / Math.max(oldOriginal, 0.01);

                // Neue Preise berechnen
                const newOriginal = menge * einzelpreis;
                const newAftermarket = newOriginal * ratio;

                ersatzteileData[index].gesamtpreis = newOriginal;
                ersatzteileData[index].preisOriginal = newOriginal;
                ersatzteileData[index].preisAftermarket = newAftermarket;

                console.log(`ğŸ“ Ersatzteil [${index}] Anzahl/Einzelpreis: Original=${newOriginal.toFixed(2)}â‚¬, Aftermarket=${newAftermarket.toFixed(2)}â‚¬`);

                // UI aktualisieren
                if (row) {
                    const inputs = row.querySelectorAll('input');
                    inputs[4].value = newOriginal.toFixed(2);      // Original-Spalte
                    inputs[5].value = newAftermarket.toFixed(2);   // Aftermarket-Spalte
                }
            } else if (field === 'preisOriginal') {
                // Original-Preis direkt geÃ¤ndert
                ersatzteileData[index].preisOriginal = parseFloat(value) || 0;
                ersatzteileData[index].gesamtpreis = ersatzteileData[index].preisOriginal;
                console.log(`ğŸ“ Ersatzteil [${index}] Original direkt: ${ersatzteileData[index].preisOriginal.toFixed(2)}â‚¬`);
            } else if (field === 'preisAftermarket') {
                // Aftermarket-Preis direkt geÃ¤ndert
                ersatzteileData[index].preisAftermarket = parseFloat(value) || 0;
                console.log(`ğŸ“ Ersatzteil [${index}] Aftermarket direkt: ${ersatzteileData[index].preisAftermarket.toFixed(2)}â‚¬`);
            } else {
                ersatzteileData[index][field] = value;
            }

            updateErsatzteileSumme();
            updateKostenaufschluesselung();
        }

        function deleteErsatzteilRow(index) {
            if (!confirm('Diese Zeile wirklich lÃ¶schen?')) return;
            ersatzteileData.splice(index, 1);
            reRenderErsatzteileTable();
            updateErsatzteileSumme();
            updateKostenaufschluesselung();
        }

        function reRenderErsatzteileTable() {
            const tableBody = document.getElementById('ersatzteileTableBody');
            tableBody.innerHTML = '';
            const tempData = [...ersatzteileData];
            ersatzteileData = [];
            tempData.forEach(teil => addErsatzteilRow(teil));
        }

        function updateErsatzteileSumme() {
            // ğŸ”§ FIX Dec 3, 2025: Direkte Summen ohne Fallback-Kette
            // preisOriginal und preisAftermarket sind bereits korrekt gesetzt (0 wenn nicht zutreffend)
            const summeOriginal = ersatzteileData.reduce((sum, teil) => sum + (parseFloat(teil.preisOriginal) || 0), 0);
            const summeAftermarket = ersatzteileData.reduce((sum, teil) => sum + (parseFloat(teil.preisAftermarket) || 0), 0);

            document.getElementById('ersatzteileOriginalSumme').textContent = summeOriginal.toFixed(2) + ' â‚¬';
            document.getElementById('ersatzteileAftermarketSumme').textContent = summeAftermarket.toFixed(2) + ' â‚¬';
            document.getElementById('ersatzteileCount').textContent = ersatzteileData.length;

            console.log(`ğŸ“¦ Ersatzteile-Summen aktualisiert: Original=${summeOriginal.toFixed(2)}â‚¬, Aftermarket=${summeAftermarket.toFixed(2)}â‚¬`);
        }

        // ========================================
        // ARBEITSLOHN TABLE
        // ========================================

        function addArbeitslohnRow(data = {}) {
            const rowIndex = arbeitslohnData.length;
            const item = {
                position: data.position || '',
                art: data.art || '',
                stunden: data.stunden || 0,
                stundensatz: data.stundensatz || 0,
                gesamtpreis: data.gesamtpreis || (data.stunden || 0) * (data.stundensatz || 0)
            };
            arbeitslohnData.push(item);

            const tableBody = document.getElementById('arbeitslohnTableBody');
            const row = document.createElement('tr');
            row.dataset.index = rowIndex;
            row.style.borderBottom = '1px solid rgba(0,0,0,0.1)';
            row.style.background = rowIndex % 2 === 0 ? 'rgba(255,255,255,0.5)' : 'transparent';

            row.innerHTML = `
                <td style="padding: 8px;">
                    <input type="text" value="${item.position}" onchange="updateArbeitslohn(${rowIndex}, 'position', this.value)" style="width: 100%; border: 1px solid #ddd; border-radius: 4px; padding: 4px;">
                </td>
                <td style="padding: 8px; text-align: center;">
                    <input type="text" value="${item.art}" onchange="updateArbeitslohn(${rowIndex}, 'art', this.value)" style="width: 100%; border: 1px solid #ddd; border-radius: 4px; padding: 4px; text-align: center;">
                </td>
                <td style="padding: 8px; text-align: center;">
                    <input type="number" value="${item.stunden.toFixed(2)}" onchange="updateArbeitslohn(${rowIndex}, 'stunden', this.value)" step="0.1" min="0" style="width: 80px; border: 1px solid #ddd; border-radius: 4px; padding: 4px; text-align: center; font-family: 'Courier New', monospace;">
                </td>
                <td style="padding: 8px; text-align: right;">
                    <input type="number" value="${item.stundensatz.toFixed(2)}" onchange="updateArbeitslohn(${rowIndex}, 'stundensatz', this.value)" step="0.01" min="0" style="width: 100px; border: 1px solid #ddd; border-radius: 4px; padding: 4px; text-align: right; font-family: 'Courier New', monospace;">
                </td>
                <td style="padding: 8px; text-align: right;">
                    <input type="number" value="${item.gesamtpreis.toFixed(2)}" readonly style="width: 100px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; padding: 4px; text-align: right; font-weight: 600; color: #4caf50; font-family: 'Courier New', monospace;">
                </td>
                <td style="padding: 8px; text-align: center;">
                    <button type="button" onclick="deleteArbeitslohnRow(${rowIndex})" style="background: #f44336; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 14px;">ğŸ—‘ï¸</button>
                </td>
            `;

            tableBody.appendChild(row);
            updateArbeitslohnSumme();
            if (typeof feather !== 'undefined') feather.replace();
        }

        function updateArbeitslohn(index, field, value) {
            if (!arbeitslohnData[index]) return;

            if (field === 'stunden' || field === 'stundensatz') {
                arbeitslohnData[index][field] = parseFloat(value) || 0;
                arbeitslohnData[index].gesamtpreis = arbeitslohnData[index].stunden * arbeitslohnData[index].stundensatz;

                const row = document.querySelector(`#arbeitslohnTableBody tr[data-index="${index}"]`);
                const gesamtpreisInput = row?.querySelectorAll('input')[4];
                if (gesamtpreisInput) {
                    gesamtpreisInput.value = arbeitslohnData[index].gesamtpreis.toFixed(2);
                }
            } else {
                arbeitslohnData[index][field] = value;
            }

            updateArbeitslohnSumme();
            updateKostenaufschluesselung();
        }

        function deleteArbeitslohnRow(index) {
            if (!confirm('Diese Zeile wirklich lÃ¶schen?')) return;
            arbeitslohnData.splice(index, 1);
            reRenderArbeitslohnTable();
        }

        function reRenderArbeitslohnTable() {
            const tableBody = document.getElementById('arbeitslohnTableBody');
            tableBody.innerHTML = '';
            const tempData = [...arbeitslohnData];
            arbeitslohnData = [];
            tempData.forEach(item => addArbeitslohnRow(item));
        }

        function updateArbeitslohnSumme() {
            const summe = arbeitslohnData.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0);
            document.getElementById('arbeitslohnTotal').textContent = summe.toFixed(2) + ' â‚¬';
            document.getElementById('arbeitslohnCount').textContent = arbeitslohnData.length;
        }

        // ========================================
        // LACKIERUNG TABLE
        // ========================================

        function addLackierungRow(data = {}) {
            const rowIndex = lackierungData.length;
            const item = {
                position: data.position || 'Lackierung',
                bereich: data.bereich || '',
                stunden: data.stunden || 0,
                stundensatz: data.stundensatz || 0,
                gesamtpreis: data.gesamtpreis || (data.stunden || 0) * (data.stundensatz || 0)
            };
            lackierungData.push(item);

            const tableBody = document.getElementById('lackierungTableBody');
            const row = document.createElement('tr');
            row.dataset.index = rowIndex;
            row.style.borderBottom = '1px solid rgba(0,0,0,0.1)';
            row.style.background = rowIndex % 2 === 0 ? 'rgba(255,255,255,0.5)' : 'transparent';

            row.innerHTML = `
                <td style="padding: 10px;">
                    <input type="text" value="${item.position}" onchange="updateLackierung(${rowIndex}, 'position', this.value)" style="width: 100%; border: 1px solid #ddd; border-radius: 4px; padding: 4px;">
                </td>
                <td style="padding: 10px;">
                    <input type="text" value="${item.bereich}" onchange="updateLackierung(${rowIndex}, 'bereich', this.value)" style="width: 100%; border: 1px solid #ddd; border-radius: 4px; padding: 4px; color: #9c27b0; font-weight: 600;">
                </td>
                <td style="padding: 10px; text-align: center;">
                    <input type="number" value="${item.stunden.toFixed(2)}" onchange="updateLackierung(${rowIndex}, 'stunden', this.value)" step="0.1" min="0" style="width: 80px; border: 1px solid #ddd; border-radius: 4px; padding: 4px; text-align: center; font-family: 'Courier New', monospace;">
                </td>
                <td style="padding: 10px; text-align: right;">
                    <input type="number" value="${item.stundensatz.toFixed(2)}" onchange="updateLackierung(${rowIndex}, 'stundensatz', this.value)" step="0.01" min="0" style="width: 100px; border: 1px solid #ddd; border-radius: 4px; padding: 4px; text-align: right; font-family: 'Courier New', monospace;">
                </td>
                <td style="padding: 10px; text-align: right;">
                    <input type="number" value="${item.gesamtpreis.toFixed(2)}" readonly style="width: 100px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; padding: 4px; text-align: right; font-weight: 600; color: #9c27b0; font-family: 'Courier New', monospace;">
                </td>
                <td style="padding: 10px; text-align: center;">
                    <button type="button" onclick="deleteLackierungRow(${rowIndex})" style="background: #f44336; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 14px;">ğŸ—‘ï¸</button>
                </td>
            `;

            tableBody.appendChild(row);
            updateLackierungSumme();
            if (typeof feather !== 'undefined') feather.replace();
        }

        function updateLackierung(index, field, value) {
            if (!lackierungData[index]) return;

            if (field === 'stunden' || field === 'stundensatz') {
                lackierungData[index][field] = parseFloat(value) || 0;
                lackierungData[index].gesamtpreis = lackierungData[index].stunden * lackierungData[index].stundensatz;

                const row = document.querySelector(`#lackierungTableBody tr[data-index="${index}"]`);
                const gesamtpreisInput = row?.querySelectorAll('input')[4];
                if (gesamtpreisInput) {
                    gesamtpreisInput.value = lackierungData[index].gesamtpreis.toFixed(2);
                }
            } else {
                lackierungData[index][field] = value;
            }

            updateLackierungSumme();
            updateKostenaufschluesselung();
        }

        function deleteLackierungRow(index) {
            if (!confirm('Diese Zeile wirklich lÃ¶schen?')) return;
            lackierungData.splice(index, 1);
            reRenderLackierungTable();
        }

        function reRenderLackierungTable() {
            const tableBody = document.getElementById('lackierungTableBody');
            tableBody.innerHTML = '';
            const tempData = [...lackierungData];
            lackierungData = [];
            tempData.forEach(item => addLackierungRow(item));
        }

        function updateLackierungSumme() {
            const summe = lackierungData.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0);
            document.getElementById('lackierungTotal').textContent = summe.toFixed(2) + ' â‚¬';
            document.getElementById('lackierungCount').textContent = lackierungData.length;
        }

        // ========================================
        // MATERIALIEN TABLE
        // ========================================

        function addMaterialienRow(data = {}) {
            const rowIndex = materialienData.length;
            const item = {
                materialTyp: data.materialTyp || '',
                menge: data.menge || 0,
                einheit: data.einheit || 'mÂ²',
                einheitspreis: data.einheitspreis || 0,
                gesamtpreis: data.gesamtpreis || (data.menge || 0) * (data.einheitspreis || 0)
            };
            materialienData.push(item);

            const tableBody = document.getElementById('materialienTableBody');
            const row = document.createElement('tr');
            row.dataset.index = rowIndex;
            row.style.borderBottom = '1px solid rgba(0,0,0,0.1)';
            row.style.background = rowIndex % 2 === 0 ? 'rgba(255,255,255,0.5)' : 'transparent';

            row.innerHTML = `
                <td style="padding: 10px;">
                    <input type="text" value="${item.materialTyp}" onchange="updateMaterialien(${rowIndex}, 'materialTyp', this.value)" placeholder="z.B. 3M Folie matt schwarz" style="width: 100%; border: 1px solid #ddd; border-radius: 4px; padding: 4px;">
                </td>
                <td style="padding: 10px; text-align: center;">
                    <input type="number" value="${item.menge.toFixed(2)}" onchange="updateMaterialien(${rowIndex}, 'menge', this.value)" step="0.01" min="0" style="width: 80px; border: 1px solid #ddd; border-radius: 4px; padding: 4px; text-align: center; font-family: 'Courier New', monospace;">
                </td>
                <td style="padding: 10px;">
                    <select onchange="updateMaterialien(${rowIndex}, 'einheit', this.value)" style="width: 100%; border: 1px solid #ddd; border-radius: 4px; padding: 4px;">
                        <option value="mÂ²" ${item.einheit === 'mÂ²' ? 'selected' : ''}>mÂ²</option>
                        <option value="StÃ¼ck" ${item.einheit === 'StÃ¼ck' ? 'selected' : ''}>StÃ¼ck</option>
                        <option value="Liter" ${item.einheit === 'Liter' ? 'selected' : ''}>Liter</option>
                        <option value="kg" ${item.einheit === 'kg' ? 'selected' : ''}>kg</option>
                        <option value="Meter" ${item.einheit === 'Meter' ? 'selected' : ''}>Meter</option>
                        <option value="Set" ${item.einheit === 'Set' ? 'selected' : ''}>Set</option>
                    </select>
                </td>
                <td style="padding: 10px; text-align: right;">
                    <input type="number" value="${item.einheitspreis.toFixed(2)}" onchange="updateMaterialien(${rowIndex}, 'einheitspreis', this.value)" step="0.01" min="0" style="width: 100px; border: 1px solid #ddd; border-radius: 4px; padding: 4px; text-align: right; font-family: 'Courier New', monospace;">
                </td>
                <td style="padding: 10px; text-align: right;">
                    <input type="number" value="${item.gesamtpreis.toFixed(2)}" readonly style="width: 100px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; padding: 4px; text-align: right; font-weight: 600; color: #ff9800; font-family: 'Courier New', monospace;">
                </td>
                <td style="padding: 10px; text-align: center;">
                    <button type="button" onclick="deleteMaterialienRow(${rowIndex})" style="background: #f44336; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 14px;">ğŸ—‘ï¸</button>
                </td>
            `;

            tableBody.appendChild(row);
            updateMaterialienSumme();
            if (typeof feather !== 'undefined') feather.replace();
        }

        function updateMaterialien(index, field, value) {
            if (!materialienData[index]) return;

            if (field === 'menge' || field === 'einheitspreis') {
                materialienData[index][field] = parseFloat(value) || 0;
                materialienData[index].gesamtpreis = materialienData[index].menge * materialienData[index].einheitspreis;

                const row = document.querySelector(`#materialienTableBody tr[data-index="${index}"]`);
                const gesamtpreisInput = row?.querySelectorAll('input[type="number"]')[2];
                if (gesamtpreisInput) {
                    gesamtpreisInput.value = materialienData[index].gesamtpreis.toFixed(2);
                }
            } else {
                materialienData[index][field] = value;
            }

            updateMaterialienSumme();
            updateKostenaufschluesselung();
        }

        function deleteMaterialienRow(index) {
            if (!confirm('Diese Zeile wirklich lÃ¶schen?')) return;
            materialienData.splice(index, 1);
            reRenderMaterialienTable();
        }

        function reRenderMaterialienTable() {
            const tableBody = document.getElementById('materialienTableBody');
            tableBody.innerHTML = '';
            const tempData = [...materialienData];
            materialienData = [];
            tempData.forEach(item => addMaterialienRow(item));
        }

        function updateMaterialienSumme() {
            const summe = materialienData.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0);
            document.getElementById('materialienTotal').textContent = summe.toFixed(2) + ' â‚¬';
            document.getElementById('materialienCount').textContent = materialienData.length;
        }

        // ========================================
        // AUTO-CALCULATION
        // ========================================

        function clearAllTables() {
            // Clear all data arrays
            ersatzteileData = [];
            arbeitslohnData = [];
            lackierungData = [];
            materialienData = [];

            // Clear all table bodies
            document.getElementById('ersatzteileTableBody').innerHTML = '';
            document.getElementById('arbeitslohnTableBody').innerHTML = '';
            document.getElementById('lackierungTableBody').innerHTML = '';
            document.getElementById('materialienTableBody').innerHTML = '';

            // Reset all sums
            document.getElementById('ersatzteileOriginalSumme').textContent = '0.00 â‚¬';
            document.getElementById('ersatzteileAftermarketSumme').textContent = '0.00 â‚¬';
            document.getElementById('ersatzteileCount').textContent = '0';
            document.getElementById('arbeitslohnTotal').textContent = '0.00 â‚¬';
            document.getElementById('arbeitslohnCount').textContent = '0';
            document.getElementById('lackierungTotal').textContent = '0.00 â‚¬';
            document.getElementById('lackierungCount').textContent = '0';
            document.getElementById('materialienTotal').textContent = '0.00 â‚¬';
            document.getElementById('materialienCount').textContent = '0';

            console.log('ğŸ—‘ï¸ Alle Tabellen geleert');
        }

        function updateKostenaufschluesselung() {
            // ğŸ”§ FIX Dec 3, 2025: Direkte Summen ohne Fallback-Kette
            // preisOriginal und preisAftermarket sind bereits korrekt gesetzt (0 wenn nicht zutreffend)

            // Ersatzteile-Summen SEPARAT berechnen (Original vs Aftermarket)
            const summeErsatzteileOriginal = ersatzteileData.reduce((sum, t) => sum + (parseFloat(t.preisOriginal) || 0), 0);
            const summeErsatzteileAftermarket = ersatzteileData.reduce((sum, t) => sum + (parseFloat(t.preisAftermarket) || 0), 0);
            const ersatzteileSumme = summeErsatzteileOriginal; // FÃ¼r Anzeige (Original = Standardpreis)

            console.log(`ğŸ“¦ Ersatzteile-Summen: Original=${summeErsatzteileOriginal.toFixed(2)}â‚¬, Aftermarket=${summeErsatzteileAftermarket.toFixed(2)}â‚¬`);

            const arbeitslohnSumme = arbeitslohnData.reduce((sum, t) => sum + (t.gesamtpreis || 0), 0);
            const lackierungSumme = lackierungData.reduce((sum, t) => sum + (t.gesamtpreis || 0), 0);
            const materialienSumme = materialienData.reduce((sum, t) => sum + (t.gesamtpreis || 0), 0);

            // ğŸš— Ersatzfahrzeug-Kosten aus DOM auslesen (FIX: 2025-11-27)
            const ersatzfahrzeugSummeEl = document.getElementById('ersatzfahrzeugSumme');
            const ersatzfahrzeugSumme = ersatzfahrzeugSummeEl
                ? parseFloat(ersatzfahrzeugSummeEl.textContent.replace(/[^\d,.-]/g, '').replace(',', '.')) || 0
                : 0;

            // Basis-Summe (Arbeitslohn + Lackierung + Material + Ersatzfahrzeug)
            // Diese ist fÃ¼r BEIDE Varianten gleich (nur Ersatzteile unterscheiden sich)
            const basisSumme = arbeitslohnSumme + lackierungSumme + materialienSumme + ersatzfahrzeugSumme;

            // MwSt berechnen (Standard: 19%)
            const mwstSatz = 19;

            // ğŸ†• Berechne ZWEI Brutto-Summen (Original und Aftermarket)
            const nettoOriginal = basisSumme + summeErsatzteileOriginal;
            const nettoAftermarket = basisSumme + summeErsatzteileAftermarket;

            const mwstOriginal = nettoOriginal * (mwstSatz / 100);
            const mwstAftermarket = nettoAftermarket * (mwstSatz / 100);

            const bruttoOriginal = nettoOriginal + mwstOriginal;
            const bruttoAftermarket = nettoAftermarket + mwstAftermarket;

            console.log(`ğŸ’° Varianten-Preise berechnet: Original=${bruttoOriginal.toFixed(2)}â‚¬, Aftermarket=${bruttoAftermarket.toFixed(2)}â‚¬`);

            // Vereinbarter Preis = Original-Preis (Standard)
            const vereinbarterPreis = document.getElementById('vereinbarterPreis');
            if (vereinbarterPreis && bruttoOriginal > 0) {
                vereinbarterPreis.value = bruttoOriginal.toFixed(2);
                console.log(`âœ… Vereinbarter Preis auto-updated: ${bruttoOriginal.toFixed(2)} â‚¬`);
            }

            // Varianten-Preise aktualisieren (Original â‰  Aftermarket basierend auf Ersatzteile-Preisen!)
            updateVariantenPreise(bruttoOriginal, bruttoAftermarket);
        }

        /**
         * ğŸ†• FIX (Nov 30, 2025): WÃ¤hrungsformatierung fÃ¼r EUR
         */
        function formatCurrency(value) {
            return parseFloat(value).toFixed(2).replace('.', ',') + ' â‚¬';
        }

        /**
         * ğŸ†• FIX (Nov 30, 2025): Varianten-Preise live aktualisieren
         * Wird von updateKostenaufschluesselung() aufgerufen
         */
        function updateVariantenPreise(bruttoOriginal, bruttoAftermarket) {
            // Hidden fields aktualisieren (fÃ¼r Speichern)
            const hiddenOriginal = document.getElementById('summeBruttoOriginal');
            const hiddenAftermarket = document.getElementById('summeBruttoAftermarket');
            if (hiddenOriginal) hiddenOriginal.value = bruttoOriginal.toFixed(2);
            if (hiddenAftermarket) hiddenAftermarket.value = bruttoAftermarket.toFixed(2);

            // UI-Elemente aktualisieren
            const preisOriginalDisplay = document.getElementById('preisOriginalDisplay');
            const preisAftermarketDisplay = document.getElementById('preisAftermarketDisplay');
            const variantenSection = document.getElementById('variantenSection');

            if (variantenSection && preisOriginalDisplay && preisAftermarketDisplay) {
                // Varianten-Section anzeigen wenn Preise vorhanden
                if (bruttoOriginal > 0) {
                    variantenSection.style.display = 'block';
                    preisOriginalDisplay.textContent = formatCurrency(bruttoOriginal);

                    // Ersparnis anzeigen wenn Aftermarket gÃ¼nstiger
                    if (bruttoAftermarket > 0 && bruttoAftermarket < bruttoOriginal) {
                        const savings = bruttoOriginal - bruttoAftermarket;
                        const savingsPercent = Math.round((savings / bruttoOriginal) * 100);
                        preisAftermarketDisplay.innerHTML = `
                            ${formatCurrency(bruttoAftermarket)}
                            <span style="display: block; font-size: 0.85em; color: var(--color-success); margin-top: 4px;">
                                ğŸ’¸ ${savingsPercent}% gÃ¼nstiger
                            </span>
                        `;
                    } else {
                        preisAftermarketDisplay.textContent = formatCurrency(bruttoAftermarket);
                    }

                    console.log(`ğŸ’° Varianten-Preise aktualisiert: Original=${bruttoOriginal.toFixed(2)}â‚¬, Aftermarket=${bruttoAftermarket.toFixed(2)}â‚¬`);
                }
            }
        }

        // ============================================
        // LOAD ENTWURF BY ID (Direct from Firestore)
        // ğŸ”§ FIX Nov 29, 2025: FÃ¼r URL-Parameter von kalkulation.html
        // ============================================

        async function loadEntwurfById(entwurfId) {
            try {
                console.log('ğŸ“¥ Lade Entwurf direkt aus Firestore:', entwurfId);

                const werkstattId = window.werkstattId;
                const collectionName = `partnerAnfragen_${werkstattId}`;

                const doc = await window.db.collection(collectionName).doc(entwurfId).get();

                if (!doc.exists) {
                    console.error('âŒ Entwurf nicht gefunden:', entwurfId);
                    showToast('âš ï¸ Entwurf nicht gefunden', 'error');
                    return;
                }

                const entwurfData = { id: doc.id, ...doc.data() };
                console.log('âœ… Entwurf geladen:', entwurfData);

                // Add to offeneEntwuerfe array if not already there
                if (!offeneEntwuerfe.find(e => e.id === entwurfId)) {
                    offeneEntwuerfe.push(entwurfData);

                    // Update dropdown
                    const dropdown = document.getElementById('entwurfDropdown');
                    const option = document.createElement('option');
                    option.value = entwurfId;
                    option.textContent = `${entwurfData.kennzeichen || 'Ohne Kennzeichen'} - ${entwurfData.kundenname || 'Unbekannt'} (aus Kalkulation)`;
                    dropdown.appendChild(option);
                }

                // Select in dropdown
                document.getElementById('entwurfDropdown').value = entwurfId;

                // Load the entwurf (reuse existing function logic)
                currentEntwurf = entwurfData;
                currentEntwurfId = entwurfId;

                // Trigger loadEntwurf to fill the form
                await loadEntwurf();

                showToast('âœ… Entwurf aus Kalkulation geladen', 'success');

            } catch (error) {
                console.error('âŒ Fehler beim Laden des Entwurfs:', error);
                showToast('âŒ Fehler beim Laden: ' + error.message, 'error');
            }
        }

        // ============================================
        // LOAD ENTWURF (Fill Form)
        // ============================================

        async function loadEntwurf() {
            try {
                const dropdown = document.getElementById('entwurfDropdown');
                const selectedId = dropdown.value;

                if (!selectedId) {
                    document.getElementById('formContainer').classList.remove('visible');
                    document.getElementById('orderSummary').classList.remove('visible');
                    currentEntwurf = null;
                    currentEntwurfId = null;

                    // Clear tables
                    clearAllTables();

                    // ğŸ–¼ï¸ Clear photos (Phase 3)
                    photos = [];
                    updatePhotoGrid();

                    return;
                }

                // ğŸ”§ FIX Nov 29, 2025: Wenn currentEntwurf bereits gesetzt ist (von loadEntwurfById), nutzen
                if (!currentEntwurf || String(currentEntwurf.id) !== String(selectedId)) {
                    // Find entwurf from loaded array
                    currentEntwurf = offeneEntwuerfe.find(e => String(e.id) === String(selectedId));
                    currentEntwurfId = selectedId;

                    if (!currentEntwurf) {
                        throw new Error('Entwurf nicht gefunden');
                    }
                }

                console.log('ğŸ“ Lade Entwurf:', currentEntwurf);

                // Fill form
                document.getElementById('kennzeichen').value = currentEntwurf.kennzeichen || '';
                document.getElementById('kundenname').value = currentEntwurf.kundenname || '';
                document.getElementById('kundenEmail').value = currentEntwurf.kundenEmail || '';
                document.getElementById('telefon').value = currentEntwurf.telefon || '';
                document.getElementById('marke').value = currentEntwurf.marke || '';
                document.getElementById('modell').value = currentEntwurf.modell || '';
                document.getElementById('baujahrVon').value = currentEntwurf.baujahrVon || '';
                document.getElementById('kmstand').value = currentEntwurf.kmstand || '';
                document.getElementById('vin').value = currentEntwurf.vin || '';

                // âœ… Populate READ-ONLY serviceTyp Display (Pattern 21 - Multi-Service Support)
                const serviceLabels = {
                    'lackier': 'ğŸ¨ Lackierung',
                    'lackierung': 'ğŸ¨ Lackierung',  // Fallback for old format
                    'reifen': 'ğŸ”§ Reifen-Service',
                    'mechanik': 'âš™ï¸ Mechanik',
                    'pflege': 'âœ¨ Pflege & Aufbereitung',
                    'tuev': 'ğŸ“‹ TÃœV & PrÃ¼fung',
                    'versicherung': 'ğŸ›¡ï¸ Versicherungsschaden',
                    'glas': 'ğŸ” Glas-Reparatur',
                    'klima': 'â„ï¸ Klima-Service',
                    'dellen': 'ğŸ”¨ Dellen-DrÃ¼ckung',
                    'folierung': 'ğŸŒˆ Auto Folierung',
                    'steinschutz': 'ğŸ›¡ï¸ Steinschutzfolie',
                    'werbebeklebung': 'ğŸ“¢ Fahrzeugbeschriftung',
                    'smart_repair': 'ğŸ”§ Smart Repair'
                };

                let displayText = '';
                const serviceTyp = currentEntwurf.serviceTyp;

                if (Array.isArray(serviceTyp)) {
                    // Multi-Service: Join with comma
                    displayText = serviceTyp.map(s => serviceLabels[s] || s).join(', ');
                } else if (serviceTyp) {
                    // Single-Service
                    displayText = serviceLabels[serviceTyp] || serviceTyp;
                } else {
                    displayText = 'ğŸ¨ Lackierung';  // Fallback
                }

                document.getElementById('serviceTypDisplay').textContent = displayText;
                document.getElementById('notizen').value = currentEntwurf.notizen || '';
                document.getElementById('vereinbarterPreis').value = currentEntwurf.vereinbarterPreis || '';
                document.getElementById('geplantesAbnahmeDatum').value = currentEntwurf.geplantesAbnahmeDatum || '';

                // ğŸš— Abholungs-Daten laden (FIX: 2025-11-27)
                const fahrzeugAbholen = currentEntwurf.fahrzeugAbholen === true || currentEntwurf.fahrzeugAbholen === 'true';
                if (fahrzeugAbholen) {
                    document.getElementById('fahrzeugAbholenJa').checked = true;
                    document.getElementById('abholungDetails').style.display = 'block';
                } else {
                    document.getElementById('fahrzeugAbholenNein').checked = true;
                    document.getElementById('abholungDetails').style.display = 'none';
                }
                document.getElementById('abholadresse').value = currentEntwurf.abholadresse || '';
                document.getElementById('abholdatum').value = currentEntwurf.abholdatum || '';
                document.getElementById('abholzeit').value = currentEntwurf.abholzeit || '';
                document.getElementById('abholnotiz').value = currentEntwurf.abholnotiz || '';
                console.log('ğŸš— Abholungs-Daten geladen:', { fahrzeugAbholen, abholdatum: currentEntwurf.abholdatum });

                // Load Kalkulations-Tabellen if available
                clearAllTables();
                // âœ… VALIDATE kalkulationData type (FIX: Nov 17, 2025 - BUG #5)
                if (currentEntwurf.kalkulationData && typeof currentEntwurf.kalkulationData === 'object') {
                    console.log('ğŸ“Š Lade Kalkulations-Daten:', currentEntwurf.kalkulationData);

                    if (Array.isArray(currentEntwurf.kalkulationData.ersatzteile)) {
                        currentEntwurf.kalkulationData.ersatzteile.forEach(item => addErsatzteilRow(item));
                    }
                    if (Array.isArray(currentEntwurf.kalkulationData.arbeitslohn)) {
                        currentEntwurf.kalkulationData.arbeitslohn.forEach(item => addArbeitslohnRow(item));
                    }
                    if (Array.isArray(currentEntwurf.kalkulationData.lackierung)) {
                        currentEntwurf.kalkulationData.lackierung.forEach(item => addLackierungRow(item));
                    }
                    if (Array.isArray(currentEntwurf.kalkulationData.materialien)) {
                        currentEntwurf.kalkulationData.materialien.forEach(item => addMaterialienRow(item));
                    }

                    console.log('âœ… Kalkulations-Daten geladen');
                }
                // ğŸ†• FIX Nov 29, 2025: Auch "kalkulation" Objekt von kalkulation.html unterstÃ¼tzen
                else if (currentEntwurf.kalkulation && typeof currentEntwurf.kalkulation === 'object') {
                    console.log('ğŸ“Š Lade Kalkulations-Daten (aus kalkulation.html Format):', currentEntwurf.kalkulation);
                    const kalk = currentEntwurf.kalkulation;

                    // Ersatzteile: nameâ†’benennung, teilenummerâ†’etn, mengeâ†’anzahl, preisâ†’einzelpreis
                    // ğŸ”§ FIX Dec 4, 2025: preisOriginal + preisAftermarket KORREKT Ã¼bernehmen
                    // Problem: || Operator behandelt 0 als falsy â†’ preisAftermarket=0 fiel auf preisOriginal zurÃ¼ck!
                    if (Array.isArray(kalk.ersatzteile)) {
                        kalk.ersatzteile.forEach(item => {
                            const menge = item.menge || item.anzahl || 1;
                            const einzelpreis = item.preis || item.einzelpreis || item.preisOriginal || item.preisAftermarket || 0;
                            const gesamtpreis = menge * einzelpreis;

                            // ğŸ”§ KRITISCH: Explizite PrÃ¼fung auf undefined/null, NICHT || Operator!
                            // preisOriginal=0 bedeutet "Aftermarket-Teil", NICHT "kein Wert"!
                            const hasPreisOriginal = item.preisOriginal !== undefined && item.preisOriginal !== null;
                            const hasPreisAftermarket = item.preisAftermarket !== undefined && item.preisAftermarket !== null;

                            let preisOriginal, preisAftermarket;
                            if (hasPreisOriginal || hasPreisAftermarket) {
                                // Varianten-Preise aus Kalkulation Ã¼bernehmen (0 ist ein gÃ¼ltiger Wert!)
                                preisOriginal = hasPreisOriginal ? parseFloat(item.preisOriginal) : 0;
                                preisAftermarket = hasPreisAftermarket ? parseFloat(item.preisAftermarket) : 0;
                            } else {
                                // Legacy-Daten ohne Varianten-Preise: beide auf Gesamtpreis setzen
                                preisOriginal = gesamtpreis;
                                preisAftermarket = gesamtpreis;
                            }

                            console.log(`ğŸ“¦ Ersatzteil "${item.name}": Original=${preisOriginal}, Aftermarket=${preisAftermarket}`);

                            addErsatzteilRow({
                                etn: item.teilenummer || item.etn || '',
                                benennung: item.name || item.benennung || '',
                                anzahl: menge,
                                einzelpreis: einzelpreis,
                                gesamtpreis: gesamtpreis,
                                preisOriginal: preisOriginal,
                                preisAftermarket: preisAftermarket,
                                // ğŸ”§ FIX Dec 4, 2025: bestellLink aus kalkulation.html Ã¼bernehmen
                                bestellLink: item.bestellLink || item.url || item.link || ''
                            });
                        });
                    }

                    // Arbeitslohn: positionen Array von kalkulation.html
                    // ğŸ”§ FIX Nov 29, 2025: Korrigiertes Mapping fÃ¼r kalkulation.html Felder
                    // kalkulation.html speichert: name, teil, arbeit, stunden, stundensatz, preis
                    if (Array.isArray(kalk.positionen)) {
                        kalk.positionen.forEach(item => {
                            addArbeitslohnRow({
                                position: item.name || item.bezeichnung || item.position || '',
                                art: item.arbeit || item.art || '',
                                stunden: item.stunden || item.menge || 1,
                                stundensatz: item.stundensatz || item.preis || 0,
                                gesamtpreis: (item.stunden || item.menge || 1) * (item.stundensatz || 0)
                            });
                        });
                    }

                    // Materialien
                    // ğŸ”§ FIX Nov 29, 2025: Korrigiertes Mapping fÃ¼r kalkulation.html Felder
                    // kalkulation.html speichert: name, menge, einheit, einzelpreis, preis (Gesamtpreis)
                    // WICHTIG: addMaterialienRow() erwartet 'materialTyp', nicht 'typ'!
                    if (Array.isArray(kalk.materialien)) {
                        kalk.materialien.forEach(item => {
                            addMaterialienRow({
                                materialTyp: item.name || item.typ || item.materialTyp || '',
                                menge: item.menge || 1,
                                einheit: item.einheit || 'Stk',
                                einheitspreis: item.einzelpreis || item.einkaufspreis || item.verkaufspreis || item.einheitspreis || 0,
                                gesamtpreis: item.preis || ((item.menge || 1) * (item.einzelpreis || item.verkaufspreis || item.einheitspreis || 0))
                            });
                        });
                    }

                    console.log('âœ… Kalkulations-Daten aus kalkulation.html Format geladen');
                }
                // ğŸ†• Auch "ersatzteile" Array direkt auf Root-Ebene prÃ¼fen
                else if (Array.isArray(currentEntwurf.ersatzteile) && currentEntwurf.ersatzteile.length > 0) {
                    console.log('ğŸ“Š Lade Ersatzteile von Root-Ebene:', currentEntwurf.ersatzteile);
                    currentEntwurf.ersatzteile.forEach(item => {
                        const menge = item.menge || item.anzahl || 1;
                        const einzelpreis = item.preis || item.einzelpreis || item.preisOriginal || 0;
                        addErsatzteilRow({
                            etn: item.teilenummer || item.etn || '',
                            benennung: item.name || item.benennung || '',
                            anzahl: menge,
                            einzelpreis: einzelpreis,
                            gesamtpreis: menge * einzelpreis,
                            // ğŸ†• FIX Nov 30, 2025: Varianten-Preise auch von Root-Ebene Ã¼bernehmen
                            preisOriginal: item.preisOriginal || (menge * einzelpreis),
                            preisAftermarket: item.preisAftermarket || item.preisOriginal || (menge * einzelpreis),
                            // ğŸ”§ FIX Dec 4, 2025: bestellLink auch von Root-Ebene Ã¼bernehmen
                            bestellLink: item.bestellLink || item.url || item.link || ''
                        });
                    });
                    console.log('âœ… Ersatzteile von Root geladen');
                }

                // ğŸ”§ Load Service-Details (Pattern 34 - FIX: Nov 17, 2025)
                if (currentEntwurf.serviceDetails && typeof currentEntwurf.serviceDetails === 'object') {
                    console.log('ğŸ“‹ Lade Service-Details:', currentEntwurf.serviceDetails);

                    const details = currentEntwurf.serviceDetails;

                    // Reifen-Details
                    if (details.reifengroesse) document.getElementById('reifengroesse').value = details.reifengroesse;
                    if (details.reifentyp) document.getElementById('reifentyp').value = details.reifentyp;
                    if (details.reifenanzahl) document.getElementById('reifenanzahl').value = details.reifenanzahl;

                    // Mechanik-Details
                    if (details.mechanikProblem) document.getElementById('mechanik-problem').value = details.mechanikProblem;
                    if (details.mechanikSymptome) document.getElementById('mechanik-symptome').value = details.mechanikSymptome;

                    // Lackierung-Details
                    if (details.farbname) document.getElementById('farbname').value = details.farbname;
                    if (details.farbvariante) document.getElementById('farbvariante').value = details.farbvariante;
                    if (details.farbnummer) document.getElementById('farbnummer').value = details.farbnummer;
                    if (details.lackart) {
                        const radioButton = document.querySelector(`input[name="lackart"][value="${details.lackart}"]`);
                        if (radioButton) radioButton.checked = true;
                    }

                    // Glas-Details
                    if (details.scheibentyp) document.getElementById('scheibentyp').value = details.scheibentyp;
                    if (details.schadensgroesse) document.getElementById('schadensgroesse').value = details.schadensgroesse;
                    if (details.glasposition) document.getElementById('glasposition').value = details.glasposition;

                    // Klima-Details
                    if (details.klimaservice) document.getElementById('klimaservice').value = details.klimaservice;
                    if (details.kaeltemittel) document.getElementById('kaeltemittel').value = details.kaeltemittel;
                    if (details.klimaproblem) document.getElementById('klimaproblem').value = details.klimaproblem;

                    // Dellen-Details
                    if (details.dellenanzahl) document.getElementById('dellenanzahl').value = details.dellenanzahl;
                    if (details.dellengroesse) document.getElementById('dellengroesse').value = details.dellengroesse;
                    if (details.lackschaden) document.getElementById('lackschaden').value = details.lackschaden;
                    if (details.dellenpositionen) document.getElementById('dellenpositionen').value = details.dellenpositionen;

                    // Versicherung-Details
                    if (details.schadensnummer) document.getElementById('versicherung-schadensnummer').value = details.schadensnummer;
                    if (details.versicherung) document.getElementById('versicherung-name').value = details.versicherung;
                    if (details.schadendatum) document.getElementById('versicherung-schadendatum').value = details.schadendatum;
                    if (details.unfallhergang) document.getElementById('versicherung-hergang').value = details.unfallhergang;

                    // Pflege-Details
                    if (details.paket) document.getElementById('pflege-paket').value = details.paket;
                    if (details.zusatzleistungen) document.getElementById('pflege-zusatz').value = details.zusatzleistungen;

                    // TÃœV-Details
                    if (details.pruefart) document.getElementById('tuev-pruefart').value = details.pruefart;
                    if (details.faelligkeit) document.getElementById('tuev-faelligkeit').value = details.faelligkeit;
                    if (details.bekannteMaengel) document.getElementById('tuev-maengel').value = details.bekannteMaengel;

                    // Folierung-Details
                    if (details.folierungArt) document.getElementById('folierungArt').value = details.folierungArt;
                    if (details.folierungMaterial) document.getElementById('folierungMaterial').value = details.folierungMaterial;
                    if (details.folierungSpezialTyp) document.getElementById('folierungSpezialTyp').value = details.folierungSpezialTyp;  // FIX: Nov 17, 2025 - Missing Field
                    if (details.folierungFarbe) document.getElementById('folierungFarbe').value = details.folierungFarbe;
                    if (details.folierungBereiche && Array.isArray(details.folierungBereiche)) {  // FIX: Nov 17, 2025 - Missing Field
                        details.folierungBereiche.forEach(bereich => {
                            const checkbox = document.querySelector(`input[name="folierungBereiche"][value="${bereich}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                    if (details.folierungDesign) document.getElementById('folierungDesign').value = details.folierungDesign;  // FIX: Nov 17, 2025 - Missing Field
                    if (details.folierungInfo) document.getElementById('folierungInfo').value = details.folierungInfo;

                    // Steinschutz-Details
                    if (details.steinschutzUmfang) document.getElementById('steinschutzUmfang').value = details.steinschutzUmfang;
                    if (details.steinschutzMaterial) document.getElementById('steinschutzMaterial').value = details.steinschutzMaterial;
                    if (details.steinschutzBereiche) document.getElementById('steinschutzBereiche').value = details.steinschutzBereiche;  // FIX: Nov 17, 2025 - Missing Field
                    if (details.steinschutzInfo) document.getElementById('steinschutzInfo').value = details.steinschutzInfo;

                    // Werbebeklebung-Details
                    if (details.werbebeklebungUmfang) document.getElementById('werbebeklebungUmfang').value = details.werbebeklebungUmfang;
                    if (details.werbebeklebungKomplexitaet) document.getElementById('werbebeklebungKomplexitaet').value = details.werbebeklebungKomplexitaet;
                    if (details.werbebeklebungText) document.getElementById('werbebeklebungText').value = details.werbebeklebungText;
                    if (details.werbebeklebungFarbanzahl) document.getElementById('werbebeklebungFarbanzahl').value = details.werbebeklebungFarbanzahl;  // FIX: Nov 17, 2025 - Missing Field
                    if (details.werbebeklebungInfo) document.getElementById('werbebeklebungInfo').value = details.werbebeklebungInfo;

                    console.log('âœ… Service-Details geladen');
                }

                // ğŸ†• MULTI-SERVICE: Load Additional Services Details (Pattern 34 - FIX: Nov 17, 2025)
                if (currentEntwurf.additionalServices && Array.isArray(currentEntwurf.additionalServices)) {
                    console.log(`ğŸ†• Lade ${currentEntwurf.additionalServices.length} zusÃ¤tzliche Services:`, currentEntwurf.additionalServices);

                    currentEntwurf.additionalServices.forEach(additionalService => {
                        if (additionalService.serviceDetails && typeof additionalService.serviceDetails === 'object') {
                            const details = additionalService.serviceDetails;

                            console.log(`   ğŸ“‹ Lade Details fÃ¼r: ${additionalService.serviceTyp}`, details);

                            // Reifen-Details
                            if (details.reifengroesse) document.getElementById('reifengroesse').value = details.reifengroesse;
                            if (details.reifentyp) document.getElementById('reifentyp').value = details.reifentyp;
                            if (details.reifenanzahl) document.getElementById('reifenanzahl').value = details.reifenanzahl;

                            // Mechanik-Details (Backwards Compatibility: problem vs mechanikProblem)
                            if (details.mechanikProblem || details.problem) {
                                document.getElementById('mechanik-problem').value = details.mechanikProblem || details.problem;
                            }
                            if (details.mechanikSymptome || details.symptome) {
                                document.getElementById('mechanik-symptome').value = details.mechanikSymptome || details.symptome;
                            }

                            // Lackierung-Details
                            if (details.farbname) document.getElementById('farbname').value = details.farbname;
                            if (details.farbvariante) document.getElementById('farbvariante').value = details.farbvariante;
                            if (details.farbnummer) document.getElementById('farbnummer').value = details.farbnummer;
                            if (details.lackart) {
                                const radioButton = document.querySelector(`input[name="lackart"][value="${details.lackart}"]`);
                                if (radioButton) radioButton.checked = true;
                            }

                            // Glas-Details
                            if (details.scheibentyp) document.getElementById('scheibentyp').value = details.scheibentyp;
                            if (details.schadensgroesse) document.getElementById('schadensgroesse').value = details.schadensgroesse;
                            if (details.glasposition) document.getElementById('glasposition').value = details.glasposition;

                            // Klima-Details
                            if (details.klimaservice) document.getElementById('klimaservice').value = details.klimaservice;
                            if (details.kaeltemittel) document.getElementById('kaeltemittel').value = details.kaeltemittel;
                            if (details.klimaproblem) document.getElementById('klimaproblem').value = details.klimaproblem;

                            // Dellen-Details
                            if (details.dellenanzahl) document.getElementById('dellenanzahl').value = details.dellenanzahl;
                            if (details.dellengroesse) document.getElementById('dellengroesse').value = details.dellengroesse;
                            if (details.lackschaden) document.getElementById('lackschaden').value = details.lackschaden;
                            if (details.dellenpositionen) document.getElementById('dellenpositionen').value = details.dellenpositionen;

                            // Versicherung-Details
                            if (details.schadensnummer) document.getElementById('versicherung-schadensnummer').value = details.schadensnummer;
                            if (details.versicherung) document.getElementById('versicherung-name').value = details.versicherung;
                            if (details.schadendatum) document.getElementById('versicherung-schadendatum').value = details.schadendatum;
                            if (details.unfallhergang) document.getElementById('versicherung-hergang').value = details.unfallhergang;

                            // Pflege-Details
                            if (details.paket) document.getElementById('pflege-paket').value = details.paket;
                            if (details.zusatzleistungen) document.getElementById('pflege-zusatz').value = details.zusatzleistungen;

                            // TÃœV-Details
                            if (details.pruefart) document.getElementById('tuev-pruefart').value = details.pruefart;
                            if (details.faelligkeit) document.getElementById('tuev-faelligkeit').value = details.faelligkeit;
                            if (details.bekannteMaengel) document.getElementById('tuev-maengel').value = details.bekannteMaengel;

                            // Folierung-Details
                            if (details.folierungArt) document.getElementById('folierungArt').value = details.folierungArt;
                            if (details.folierungMaterial) document.getElementById('folierungMaterial').value = details.folierungMaterial;
                            if (details.folierungSpezialTyp) document.getElementById('folierungSpezialTyp').value = details.folierungSpezialTyp;
                            if (details.folierungFarbe) document.getElementById('folierungFarbe').value = details.folierungFarbe;
                            if (details.folierungBereiche && Array.isArray(details.folierungBereiche)) {
                                details.folierungBereiche.forEach(bereich => {
                                    const checkbox = document.querySelector(`input[name="folierungBereiche"][value="${bereich}"]`);
                                    if (checkbox) checkbox.checked = true;
                                });
                            }
                            if (details.folierungDesign) document.getElementById('folierungDesign').value = details.folierungDesign;
                            if (details.folierungInfo) document.getElementById('folierungInfo').value = details.folierungInfo;

                            // Steinschutz-Details
                            if (details.steinschutzUmfang) document.getElementById('steinschutzUmfang').value = details.steinschutzUmfang;
                            if (details.steinschutzMaterial) document.getElementById('steinschutzMaterial').value = details.steinschutzMaterial;
                            if (details.steinschutzBereiche) document.getElementById('steinschutzBereiche').value = details.steinschutzBereiche;
                            if (details.steinschutzInfo) document.getElementById('steinschutzInfo').value = details.steinschutzInfo;

                            // Werbebeklebung-Details
                            if (details.werbebeklebungUmfang) document.getElementById('werbebeklebungUmfang').value = details.werbebeklebungUmfang;
                            if (details.werbebeklebungKomplexitaet) document.getElementById('werbebeklebungKomplexitaet').value = details.werbebeklebungKomplexitaet;
                            if (details.werbebeklebungText) document.getElementById('werbebeklebungText').value = details.werbebeklebungText;
                            if (details.werbebeklebungFarbanzahl) document.getElementById('werbebeklebungFarbanzahl').value = details.werbebeklebungFarbanzahl;
                            if (details.werbebeklebungInfo) document.getElementById('werbebeklebungInfo').value = details.werbebeklebungInfo;
                        }
                    });

                    console.log('âœ… Additional Services Details geladen');
                }

                // ğŸ”§ FIX (2025-11-30): serviceDetailsPerService aus Kalkulation laden (hat PRIORITÃ„T!)
                // Diese Daten wurden in kalkulation.html Step 2b eingegeben/geÃ¤ndert
                if (currentEntwurf.serviceDetailsPerService && typeof currentEntwurf.serviceDetailsPerService === 'object') {
                    console.log('ğŸ†• Lade serviceDetailsPerService aus Kalkulation:', currentEntwurf.serviceDetailsPerService);

                    // Hilfsfunktion um Wert in Feld zu setzen (mit null-check)
                    const setFieldValue = (elementId, value) => {
                        if (value !== undefined && value !== null && value !== '') {
                            const element = document.getElementById(elementId);
                            if (element) {
                                element.value = value;
                                console.log(`   âœ… Kalkulations-Feld "${elementId}" = "${value}"`);
                            }
                        }
                    };

                    // Durch alle Services iterieren
                    Object.entries(currentEntwurf.serviceDetailsPerService).forEach(([serviceTyp, details]) => {
                        if (!details || typeof details !== 'object') return;

                        console.log(`   ğŸ“‹ Lade Kalkulations-Details fÃ¼r: ${serviceTyp}`, details);

                        // Feldnamen aus kalkulation.html SERVICE_CONFIG
                        // Diese Felder kÃ¶nnen je nach Service unterschiedlich sein

                        // Reifen-Details
                        setFieldValue('reifengroesse', details.reifengroesse);
                        setFieldValue('reifentyp', details.reifentyp);
                        setFieldValue('reifenanzahl', details.reifenanzahl);

                        // Mechanik-Details
                        setFieldValue('mechanik-problem', details.mechanikProblem || details.problem);
                        setFieldValue('mechanik-symptome', details.mechanikSymptome || details.symptome);

                        // Lackierung-Details
                        setFieldValue('farbname', details.farbname);
                        setFieldValue('farbvariante', details.farbvariante);
                        setFieldValue('farbnummer', details.farbnummer);
                        if (details.lackart) {
                            const radioButton = document.querySelector(`input[name="lackart"][value="${details.lackart}"]`);
                            if (radioButton) radioButton.checked = true;
                        }

                        // Glas-Details
                        setFieldValue('scheibentyp', details.scheibentyp);
                        setFieldValue('schadensgroesse', details.schadensgroesse);
                        setFieldValue('glasposition', details.glasposition);

                        // Klima-Details
                        setFieldValue('klimaservice', details.klimaservice);
                        setFieldValue('kaeltemittel', details.kaeltemittel);
                        setFieldValue('klimaproblem', details.klimaproblem);

                        // Dellen-Details
                        setFieldValue('dellenanzahl', details.dellenanzahl);
                        setFieldValue('dellengroesse', details.dellengroesse);
                        setFieldValue('lackschaden', details.lackschaden);
                        setFieldValue('dellenpositionen', details.dellenpositionen);

                        // Versicherung-Details
                        setFieldValue('versicherung-schadensnummer', details.schadensnummer);
                        setFieldValue('versicherung-name', details.versicherung);
                        setFieldValue('versicherung-schadendatum', details.schadendatum);
                        setFieldValue('versicherung-hergang', details.unfallhergang);

                        // Pflege-Details
                        setFieldValue('pflege-paket', details.paket);
                        setFieldValue('pflege-zusatz', details.zusatzleistungen);

                        // TÃœV-Details
                        setFieldValue('tuev-pruefart', details.pruefart);
                        setFieldValue('tuev-faelligkeit', details.faelligkeit);
                        setFieldValue('tuev-maengel', details.bekannteMaengel);

                        // Folierung-Details
                        setFieldValue('folierungArt', details.folierungArt);
                        setFieldValue('folierungMaterial', details.folierungMaterial);
                        setFieldValue('folierungSpezialTyp', details.folierungSpezialTyp);
                        setFieldValue('folierungFarbe', details.folierungFarbe);
                        if (details.folierungBereiche && Array.isArray(details.folierungBereiche)) {
                            details.folierungBereiche.forEach(bereich => {
                                const checkbox = document.querySelector(`input[name="folierungBereiche"][value="${bereich}"]`);
                                if (checkbox) checkbox.checked = true;
                            });
                        }
                        setFieldValue('folierungDesign', details.folierungDesign);
                        setFieldValue('folierungInfo', details.folierungInfo);

                        // Steinschutz-Details
                        setFieldValue('steinschutzUmfang', details.steinschutzUmfang);
                        setFieldValue('steinschutzMaterial', details.steinschutzMaterial);
                        setFieldValue('steinschutzBereiche', details.steinschutzBereiche);
                        setFieldValue('steinschutzInfo', details.steinschutzInfo);

                        // Werbebeklebung-Details
                        setFieldValue('werbebeklebungUmfang', details.werbebeklebungUmfang);
                        setFieldValue('werbebeklebungKomplexitaet', details.werbebeklebungKomplexitaet);
                        setFieldValue('werbebeklebungText', details.werbebeklebungText);
                        setFieldValue('werbebeklebungFarbanzahl', details.werbebeklebungFarbanzahl);
                        setFieldValue('werbebeklebungInfo', details.werbebeklebungInfo);
                    });

                    console.log('âœ… serviceDetailsPerService aus Kalkulation geladen (PrioritÃ¤t Ã¼ber additionalServices)');
                }

                // ğŸ”§ FIX Dec 4, 2025: KRITISCH! updateKostenaufschluesselung() aufrufen NACHDEM
                // alle Ersatzteile in ersatzteileData geladen wurden!
                // Dies berechnet die Varianten-Preise LIVE aus den geladenen Daten statt
                // aus den gespeicherten (mÃ¶glicherweise veralteten) Werten.
                if (ersatzteileData.length > 0) {
                    console.log('ğŸ“Š Ersatzteile geladen, berechne Varianten-Preise neu aus ersatzteileData...');
                    updateKostenaufschluesselung();

                    // Nach updateKostenaufschluesselung() sind die Hidden-Inputs aktualisiert
                    // Jetzt kÃ¶nnen wir diese Werte fÃ¼r die Anzeige verwenden
                    const summeBruttoOriginal = parseFloat(document.getElementById('summeBruttoOriginal')?.value) || 0;
                    const summeBruttoAftermarket = parseFloat(document.getElementById('summeBruttoAftermarket')?.value) || 0;

                    console.log('ğŸ’° Varianten-Preise NEU BERECHNET:', { summeBruttoOriginal, summeBruttoAftermarket });

                    // Varianten-Anzeige wurde bereits von updateKostenaufschluesselung() aktualisiert
                    // Daher Ã¼berspringen wir den Rest dieses Blocks
                } else {
                    // Keine Ersatzteile geladen - Fallback auf gespeicherte Werte
                    // ğŸ†• FIX Nov 30, 2025: 2-Varianten-Preise laden (Original + Aftermarket)
                    // PrioritÃ¤t: 1. kalkulation.summeBruttoOriginal/Aftermarket, 2. kalkulationData
                    const kalkData = currentEntwurf.kalkulation || currentEntwurf.kalkulationData || {};
                    const summeBruttoOriginal = parseFloat(kalkData.summeBruttoOriginal) || 0;
                    const summeBruttoAftermarket = parseFloat(kalkData.summeBruttoAftermarket) || 0;

                    console.log('ğŸ’° Varianten-Preise aus gespeicherter Kalkulation (keine Ersatzteile):', { summeBruttoOriginal, summeBruttoAftermarket });

                    // Hidden Inputs setzen (nur wenn keine Ersatzteile geladen wurden)
                    document.getElementById('summeBruttoOriginal').value = summeBruttoOriginal || '';
                    document.getElementById('summeBruttoAftermarket').value = summeBruttoAftermarket || '';

                    // Varianten-Anzeige aktualisieren
                    const variantenSection = document.getElementById('variantenSection');
                    const manuellerPreisSection = document.getElementById('manuellerPreisSection');
                    const preisOriginalDisplay = document.getElementById('preisOriginalDisplay');
                    const preisAftermarketDisplay = document.getElementById('preisAftermarketDisplay');

                    if (summeBruttoOriginal > 0 || summeBruttoAftermarket > 0) {
                        // Kalkulation vorhanden - Varianten anzeigen
                        variantenSection.style.display = 'block';
                        manuellerPreisSection.style.display = 'none';

                        // Formatierte Preise anzeigen
                        const formatCurrency = (value) => {
                            return new Intl.NumberFormat('de-DE', {
                                style: 'currency',
                                currency: 'EUR'
                            }).format(value);
                        };

                        preisOriginalDisplay.textContent = formatCurrency(summeBruttoOriginal);
                        preisAftermarketDisplay.textContent = formatCurrency(summeBruttoAftermarket);

                        // Wenn Aftermarket gÃ¼nstiger, hervorheben
                        if (summeBruttoAftermarket > 0 && summeBruttoAftermarket < summeBruttoOriginal) {
                            const savings = summeBruttoOriginal - summeBruttoAftermarket;
                            const savingsPercent = Math.round((savings / summeBruttoOriginal) * 100);
                            preisAftermarketDisplay.innerHTML = `
                                ${formatCurrency(summeBruttoAftermarket)}
                                <div style="font-size: 12px; color: #16a34a; margin-top: 4px;">
                                    ğŸ’¸ ${savingsPercent}% gÃ¼nstiger
                                </div>
                            `;
                        }

                        console.log('âœ… Varianten-Preise angezeigt (aus gespeicherter Kalkulation)');
                    } else {
                        // Keine Kalkulation - manuellen Preis anzeigen
                        variantenSection.style.display = 'none';
                        manuellerPreisSection.style.display = 'block';
                        console.log('â„¹ï¸ Keine Kalkulation vorhanden - manueller Preis');
                    }
                } // Ende else (keine Ersatzteile)

                // ğŸ–¼ï¸ Load Fotos (Phase 3)
                // ğŸ”§ DEBUG Dec 3, 2025: Log alle Foto-Felder im Entwurf
                console.log('ğŸ” DEBUG Foto-Felder im Entwurf:', {
                    photoUrls: currentEntwurf.photoUrls,
                    photoUrlsLength: currentEntwurf.photoUrls?.length,
                    photos: currentEntwurf.photos,
                    fotos: currentEntwurf.fotos,
                    designUrls: currentEntwurf.designUrls,
                    designUrlsKeys: currentEntwurf.designUrls ? Object.keys(currentEntwurf.designUrls) : [],
                    designUrlsContent: currentEntwurf.designUrls ? JSON.stringify(currentEntwurf.designUrls) : 'null'
                });

                photos = [];
                // ğŸ”§ FIX Dec 3, 2025: Alle mÃ¶glichen Foto-Feldnamen prÃ¼fen
                const photoSource = currentEntwurf.photoUrls || currentEntwurf.photos || currentEntwurf.fotos || [];
                if (Array.isArray(photoSource) && photoSource.length > 0) {
                    photos = photoSource;
                    updatePhotoGrid();
                    console.log(`ğŸ“¸ ${photos.length} Fotos geladen`);
                } else {
                    console.log('âš ï¸ Keine Fotos im Entwurf gefunden');
                }

                // ğŸ†• Load Design-Galerie (fÃ¼r Folierung/Werbebeklebung aus kalkulation.html)
                if (currentEntwurf.designUrls && Object.keys(currentEntwurf.designUrls).length > 0) {
                    renderDesignGallery(currentEntwurf.designUrls);
                    console.log('ğŸ¨ Design-Galerie geladen:', currentEntwurf.designUrls);
                } else {
                    console.log('â„¹ï¸ Keine Design-URLs im Entwurf');
                }

                // âœ… BUG #4 FIX: Check for PDF generation errors
                if (currentEntwurf.pdfGenerationFailed) {
                    const errorMsg = currentEntwurf.pdfGenerationError || 'Unbekannter Fehler';
                    showToast(
                        `âš ï¸ PDF-Generierung fehlgeschlagen:\n\n${errorMsg}\n\nğŸ’¡ Bitte versuchen Sie es erneut.`,
                        'error',
                        10000
                    );

                    // Show retry button
                    const retryBtn = document.getElementById('pdfRetryBtn');
                    if (retryBtn) {
                        retryBtn.style.display = 'inline-block';
                    }
                }

                // âœ… BUG #4 FIX: Check for email skip warning
                if (currentEntwurf.pdfEmailSkipped) {
                    const skipReason = currentEntwurf.pdfEmailSkippedReason || 'SendGrid deaktiviert';
                    showToast(
                        `â„¹ï¸ Admin-Email wurde Ã¼bersprungen:\n\n${skipReason}\n\nâš ï¸ PDF wurde erstellt, aber NICHT per Email versendet.`,
                        'warning',
                        8000
                    );
                }

                // ğŸš— Ersatzfahrzeug laden (FIX: Nov 27, 2025)
                const ersatzfahrzeugCheckbox = document.getElementById('ersatzfahrzeugGewuenscht');
                const ersatzfahrzeugZuweisungGroup = document.getElementById('ersatzfahrzeugZuweisungGroup');
                // ğŸ”§ ENTFERNT (2025-11-27): ersatzfahrzeugAdresse war redundant mit abholadresse
                const zugewiesenesErsatzfahrzeugSelect = document.getElementById('zugewiesenesErsatzfahrzeug');

                // ğŸ”§ FIX Dec 1, 2025: VollstÃ¤ndige Fallback-Chain fÃ¼r ersatzfahrzeugGewuenscht
                // Quelle 1: serviceDetails (Boolean von annahme.html)
                // Quelle 2: Root-Level (Boolean)
                // Quelle 3: serviceDetailsPerService['lackier'] (String 'ja'/'nein' von kalkulation.html)
                // Quelle 4: kalkulation.ersatzfahrzeug (falls vorhanden = gewÃ¼nscht)
                const ersatzfahrzeugGewuenscht =
                    currentEntwurf.serviceDetails?.ersatzfahrzeugGewuenscht === true ||
                    currentEntwurf.ersatzfahrzeugGewuenscht === true ||
                    currentEntwurf.serviceDetailsPerService?.lackier?.ersatzfahrzeugGewuenscht === 'ja' ||
                    currentEntwurf.serviceDetailsPerService?.lackierung?.ersatzfahrzeugGewuenscht === 'ja' ||
                    (currentEntwurf.kalkulation?.ersatzfahrzeug && currentEntwurf.kalkulation?.ersatzfahrzeug?.gesamt > 0);

                console.log('ğŸš— Ersatzfahrzeug-Check:', {
                    'serviceDetails.ersatzfahrzeugGewuenscht': currentEntwurf.serviceDetails?.ersatzfahrzeugGewuenscht,
                    'root.ersatzfahrzeugGewuenscht': currentEntwurf.ersatzfahrzeugGewuenscht,
                    'serviceDetailsPerService.lackier': currentEntwurf.serviceDetailsPerService?.lackier?.ersatzfahrzeugGewuenscht,
                    'kalkulation.ersatzfahrzeug': currentEntwurf.kalkulation?.ersatzfahrzeug,
                    'RESULT': ersatzfahrzeugGewuenscht
                });

                // Checkbox-Status setzen
                if (ersatzfahrzeugGewuenscht) {
                    ersatzfahrzeugCheckbox.checked = true;
                    ersatzfahrzeugZuweisungGroup.style.display = 'block';

                    // VerfÃ¼gbare Leihfahrzeuge laden
                    await loadVerfuegbareLeihfahrzeuge();

                    // ğŸ”§ FIX Dec 4, 2025: Ersatzfahrzeug aus KVA Ã¼bernehmen (PrioritÃ¤t!)
                    // PrÃ¼fe ob in der Kalkulation bereits ein Ersatzfahrzeug ausgewÃ¤hlt wurde
                    const kvaErsatzfahrzeug = currentEntwurf.kalkulation?.ersatzfahrzeug;
                    const zugewiesenesId = currentEntwurf.zugewiesenesErsatzfahrzeug || kvaErsatzfahrzeug?.fahrzeugId;

                    if (zugewiesenesId) {
                        zugewiesenesErsatzfahrzeugSelect.value = zugewiesenesId;
                        console.log('ğŸš— Ersatzfahrzeug aus KVA Ã¼bernommen:', zugewiesenesId);

                        // Falls KVA-Daten vorhanden, auch Tagesmiete und Tage vorbefÃ¼llen
                        if (kvaErsatzfahrzeug) {
                            console.log('ğŸš— KVA Ersatzfahrzeug-Daten:', kvaErsatzfahrzeug);
                        }
                    }
                } else {
                    ersatzfahrzeugCheckbox.checked = false;
                    ersatzfahrzeugZuweisungGroup.style.display = 'none';
                }

                console.log('ğŸš— Ersatzfahrzeug-Status geladen:', ersatzfahrzeugCheckbox.checked);

                // ğŸš— Ersatzfahrzeug-Kosten berechnen (wenn Fahrzeug zugewiesen)
                // ğŸ”§ FIX Dec 4, 2025: Auch KVA fahrzeugId prÃ¼fen
                const kvaFahrzeugId = currentEntwurf.kalkulation?.ersatzfahrzeug?.fahrzeugId;
                const hasZugewiesenesErsatzfahrzeug = currentEntwurf.zugewiesenesErsatzfahrzeug || kvaFahrzeugId;

                if (ersatzfahrzeugCheckbox.checked && hasZugewiesenesErsatzfahrzeug) {
                    await berechneErsatzfahrzeugKosten();
                }

                // Show form
                document.getElementById('formContainer').classList.add('visible');
                feather.replace();

                // ğŸ“‹ Update Auftragsinformationen-Ãœbersicht
                updateOrderSummary(currentEntwurf);

                // ğŸ”„ Toggle Service-Felder visibility (Pattern 34 - FIX: Nov 17, 2025)
                if (typeof toggleServiceFelder === 'function') {
                    toggleServiceFelder();
                }

                console.log('âœ… Entwurf geladen und Formular ausgefÃ¼llt');

                // ğŸ“Š KapazitÃ¤tsvorschau initial aktualisieren (Dec 2025)
                if (currentEntwurf.geplantesAbnahmeDatum) {
                    await updateKapazitaetPreview();
                }

            } catch (error) {
                console.error('âŒ Fehler beim Laden des Entwurfs:', error);
                showToast(`âŒ Fehler: ${error.message}`, 'error', 6000);
            }
        }

        // ============================================
        // ERSATZFAHRZEUG FUNKTIONEN (FIX: Nov 27, 2025)
        // ============================================

        /**
         * LÃ¤dt verfÃ¼gbare Leihfahrzeuge aus der Datenbank
         */
        async function loadVerfuegbareLeihfahrzeuge() {
            try {
                const select = document.getElementById('zugewiesenesErsatzfahrzeug');
                if (!select) return;

                // Reset dropdown (behalte erste Option)
                select.innerHTML = '<option value="">-- Kein Fahrzeug zugewiesen --</option>';

                const werkstattId = window.werkstattId;
                if (!werkstattId) {
                    console.warn('âš ï¸ werkstattId nicht gesetzt, kann Leihfahrzeuge nicht laden');
                    return;
                }

                // Lade verfÃ¼gbare Leihfahrzeuge
                const collectionName = `leihfahrzeuge_${werkstattId}`;
                const snapshot = await window.db.collection(collectionName)
                    .where('status', '==', 'verfuegbar')
                    .get();

                if (snapshot.empty) {
                    // Auch ohne Filter versuchen (alle Fahrzeuge)
                    const allSnapshot = await window.db.collection(collectionName).get();
                    if (allSnapshot.empty) {
                        console.log('â„¹ï¸ Keine Leihfahrzeuge in der Datenbank');
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = '-- Keine Leihfahrzeuge verfÃ¼gbar --';
                        option.disabled = true;
                        select.appendChild(option);
                        return;
                    }

                    // Zeige alle Fahrzeuge mit Status
                    allSnapshot.forEach(doc => {
                        const data = doc.data();
                        const option = document.createElement('option');
                        option.value = doc.id;
                        option.dataset.werkstatt = window.werkstattName || '';  // ğŸ†• FIX (Nov 27): Werkstatt-Name speichern
                        const statusText = data.status === 'verfuegbar' ? '' : ` (${data.status || 'unbekannt'})`;
                        option.textContent = `${data.marke || 'Unbekannt'} ${data.modell || ''} (${data.kennzeichen || 'N/A'})${statusText}`;
                        if (data.status !== 'verfuegbar') {
                            option.disabled = true;
                        }
                        select.appendChild(option);
                    });
                    console.log(`ğŸš— ${allSnapshot.size} Leihfahrzeuge geladen (inkl. nicht verfÃ¼gbare)`);
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.dataset.werkstatt = window.werkstattName || '';  // ğŸ†• FIX (Nov 27): Werkstatt-Name speichern
                    option.textContent = `${data.marke || 'Unbekannt'} ${data.modell || ''} (${data.kennzeichen || 'N/A'})`;
                    select.appendChild(option);
                });

                console.log(`ğŸš— ${snapshot.size} verfÃ¼gbare Leihfahrzeuge geladen`);

            } catch (error) {
                console.error('âŒ Fehler beim Laden der Leihfahrzeuge:', error);
            }
        }

        /**
         * ğŸš— Initialisiert Abholung Radio-Button Event-Listener (FIX: 2025-11-27)
         */
        function initAbholungToggle() {
            const radioButtons = document.querySelectorAll('input[name="fahrzeugAbholen"]');
            const details = document.getElementById('abholungDetails');

            if (radioButtons.length > 0 && details) {
                radioButtons.forEach(radio => {
                    radio.addEventListener('change', function() {
                        if (this.value === 'true') {
                            details.style.display = 'block';
                        } else {
                            details.style.display = 'none';
                        }
                    });
                });
                console.log('âœ… Abholung Toggle initialisiert');
            }
        }

        /**
         * Initialisiert Ersatzfahrzeug-Checkbox Event-Listener
         */
        function initErsatzfahrzeugToggle() {
            const checkbox = document.getElementById('ersatzfahrzeugGewuenscht');
            const zuweisungGroup = document.getElementById('ersatzfahrzeugZuweisungGroup');
            // ğŸ”§ ENTFERNT (2025-11-27): adresseGroup war redundant mit abholadresse

            if (checkbox && zuweisungGroup) {
                checkbox.addEventListener('change', async function() {
                    if (this.checked) {
                        zuweisungGroup.style.display = 'block';
                        await loadVerfuegbareLeihfahrzeuge();
                        await berechneErsatzfahrzeugKosten();
                    } else {
                        zuweisungGroup.style.display = 'none';
                        // Reset dropdown selection
                        const select = document.getElementById('zugewiesenesErsatzfahrzeug');
                        if (select) select.value = '';
                        // Kosten-Sektion verstecken
                        await berechneErsatzfahrzeugKosten();
                    }
                });

                // Event-Listener fÃ¼r Fahrzeug-Dropdown (Neuberechnung bei Auswahl)
                const fahrzeugSelect = document.getElementById('zugewiesenesErsatzfahrzeug');
                if (fahrzeugSelect) {
                    fahrzeugSelect.addEventListener('change', async function() {
                        await berechneErsatzfahrzeugKosten();
                    });
                }

                // Event-Listener fÃ¼r Fertigstellungsdatum (Neuberechnung bei Ã„nderung)
                const abnahmeDatum = document.getElementById('geplantesAbnahmeDatum');
                if (abnahmeDatum) {
                    abnahmeDatum.addEventListener('change', async function() {
                        console.log('ğŸ“… Fertigstellungsdatum geÃ¤ndert â†’ Ersatzfahrzeug-Kosten neu berechnen');
                        await berechneErsatzfahrzeugKosten();
                        // ğŸ“Š KapazitÃ¤tsvorschau aktualisieren (Dec 2025)
                        await updateKapazitaetPreview();
                    });
                }

                // ğŸ”§ FIX Dec 4, 2025: Event-Listener fÃ¼r Abholdatum (START der Ersatzfahrzeug-Nutzung)
                const abholdatum = document.getElementById('abholdatum');
                if (abholdatum) {
                    abholdatum.addEventListener('change', async function() {
                        console.log('ğŸ“… Abholdatum geÃ¤ndert â†’ Ersatzfahrzeug-Kosten neu berechnen');
                        await berechneErsatzfahrzeugKosten();
                    });
                }

                console.log('âœ… Ersatzfahrzeug Toggle initialisiert (mit Abholdatum + Fertigstellung)');
            }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ğŸ“Š KAPAZITÃ„TSVORSCHAU - Funktionen (Dec 2025)
           Zeigt WerkstattkapazitÃ¤t fÃ¼r die Woche um das gewÃ¤hlte Datum
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

        // Cache fÃ¼r KapazitÃ¤ts-Einstellungen
        let kapazitaetSettings = null;

        /**
         * LÃ¤dt KapazitÃ¤ts-Einstellungen aus Firestore
         */
        async function loadKapazitaetSettings() {
            if (kapazitaetSettings) return kapazitaetSettings;

            try {
                const werkstattId = window.werkstattId;
                if (!werkstattId) {
                    console.warn('âš ï¸ KapazitÃ¤t: Keine werkstattId');
                    return null;
                }

                const settingsRef = window.db.collection(`einstellungen_${werkstattId}`).doc('config');
                const doc = await settingsRef.get();

                if (doc.exists && doc.data().kapazitaet) {
                    kapazitaetSettings = doc.data().kapazitaet;
                    console.log('ğŸ“Š KapazitÃ¤ts-Einstellungen geladen:', kapazitaetSettings);
                } else {
                    // Default-Werte falls keine Einstellungen vorhanden
                    kapazitaetSettings = {
                        lackierung: 10,
                        mechanik: 5,
                        reifen: 8,
                        default: 10
                    };
                    console.log('ğŸ“Š KapazitÃ¤t: Nutze Default-Werte');
                }

                return kapazitaetSettings;
            } catch (error) {
                console.error('âŒ KapazitÃ¤t laden fehlgeschlagen:', error);
                return null;
            }
        }

        /**
         * LÃ¤dt Fahrzeuge fÃ¼r eine Woche (3 Tage vor und nach dem Datum)
         * @param {Date} centerDate - Das Zentrum der Woche
         * @returns {Promise<Array>} - Fahrzeuge mit queueDatum in der Woche
         */
        async function loadFahrzeugeForWeek(centerDate) {
            try {
                const werkstattId = window.werkstattId;
                if (!werkstattId) return [];

                // ğŸ”§ FIX: 6 Tage VOR bis ZUM Fertigstellungsdatum (nicht Â±3 Tage)
                const startOfWeek = new Date(centerDate);
                startOfWeek.setDate(startOfWeek.getDate() - 6); // 6 Tage vorher
                startOfWeek.setHours(0, 0, 0, 0);

                const endOfWeek = new Date(centerDate); // Endet am Fertigstellungsdatum
                endOfWeek.setHours(23, 59, 59, 999);

                const startStr = startOfWeek.toISOString().split('T')[0];
                const endStr = endOfWeek.toISOString().split('T')[0];

                console.log(`ğŸ“Š Lade Fahrzeuge fÃ¼r Woche: ${startStr} bis ${endStr}`);

                // Fahrzeuge mit queueDatum ODER geplantesAbnahmeDatum in der Woche laden
                const fahrzeugeRef = window.db.collection(`fahrzeuge_${werkstattId}`);

                // Alle Fahrzeuge laden und client-seitig filtern
                // (Firestore unterstÃ¼tzt keine OR-Queries Ã¼ber verschiedene Felder)
                const snapshot = await fahrzeugeRef.get();

                const fahrzeuge = [];
                snapshot.forEach(doc => {
                    const data = doc.data();

                    // Datum ermitteln (queueDatum hat PrioritÃ¤t, dann geplantesAbnahmeDatum)
                    let datumStr = data.queueDatum || data.geplantesAbnahmeDatum;

                    // Firebase Timestamp zu String konvertieren
                    if (datumStr?.toDate) {
                        datumStr = datumStr.toDate().toISOString().split('T')[0];
                    } else if (datumStr instanceof Date) {
                        datumStr = datumStr.toISOString().split('T')[0];
                    }

                    // PrÃ¼fen ob Datum in der Woche liegt
                    if (datumStr && datumStr >= startStr && datumStr <= endStr) {
                        fahrzeuge.push({
                            ...data,
                            id: doc.id,
                            datumStr: datumStr
                        });
                    }
                });

                console.log(`ğŸ“Š ${fahrzeuge.length} Fahrzeuge in der Woche gefunden`);
                return fahrzeuge;

            } catch (error) {
                console.error('âŒ Fahrzeuge fÃ¼r Woche laden fehlgeschlagen:', error);
                return [];
            }
        }

        /**
         * Berechnet KapazitÃ¤t fÃ¼r einen Tag
         * @param {Array} fahrzeuge - Alle Fahrzeuge der Woche
         * @param {Date} date - Der Tag
         * @param {string} serviceType - Service-Typ (z.B. 'lackierung')
         * @returns {{count: number, max: number, percent: number, status: string}}
         */
        function calculateDayCapacity(fahrzeuge, date, serviceType = 'lackierung') {
            const dateStr = date.toISOString().split('T')[0];

            // Fahrzeuge fÃ¼r diesen Tag zÃ¤hlen
            const count = fahrzeuge.filter(f => f.datumStr === dateStr).length;

            // Max-KapazitÃ¤t aus Einstellungen
            const max = kapazitaetSettings?.[serviceType] || kapazitaetSettings?.default || 10;

            // Prozent berechnen
            const percent = Math.round((count / max) * 100);

            // Status bestimmen
            let status = 'green';
            if (percent >= 100) {
                status = 'red';
            } else if (percent >= 80) {
                status = 'yellow';
            }

            return { count, max, percent, status };
        }

        /**
         * Aktualisiert die KapazitÃ¤tsvorschau basierend auf dem gewÃ¤hlten Datum
         */
        async function updateKapazitaetPreview() {
            const previewEl = document.getElementById('kapazitaetPreview');
            const weekGrid = document.getElementById('kapazitaetWeekGrid');
            const wocheLabel = document.getElementById('kapazitaetWocheLabel');

            if (!previewEl || !weekGrid) {
                console.warn('âš ï¸ KapazitÃ¤tsvorschau: UI-Elemente nicht gefunden');
                return;
            }

            // Datum aus Input holen
            const dateValue = document.getElementById('geplantesAbnahmeDatum')?.value;
            if (!dateValue) {
                previewEl.classList.remove('visible');
                return;
            }

            console.log('ğŸ“Š KapazitÃ¤tsvorschau aktualisieren fÃ¼r:', dateValue);

            try {
                // KapazitÃ¤ts-Einstellungen laden (falls noch nicht geladen)
                await loadKapazitaetSettings();

                const centerDate = new Date(dateValue); // = Fertigstellungsdatum

                // Fahrzeuge fÃ¼r die Woche laden
                const fahrzeuge = await loadFahrzeugeForWeek(centerDate);

                // ğŸ”§ FIX: Wochendaten - 6 Tage VOR bis ZUM Fertigstellungsdatum
                const startOfWeek = new Date(centerDate);
                startOfWeek.setDate(startOfWeek.getDate() - 6); // 6 Tage vorher

                const endOfWeek = new Date(centerDate); // Endet am Fertigstellungsdatum

                // Wochen-Label aktualisieren
                if (wocheLabel) {
                    const formatDate = (d) => `${d.getDate()}.${d.getMonth() + 1}.`;
                    wocheLabel.textContent = `${formatDate(startOfWeek)} - ${formatDate(endOfWeek)}${endOfWeek.getFullYear()}`;
                }

                // ğŸ”§ FIX: Alle Services aus serviceTyp ermitteln (kann Array sein!)
                let services = [];
                if (currentEntwurf?.serviceTyp) {
                    if (Array.isArray(currentEntwurf.serviceTyp)) {
                        services = currentEntwurf.serviceTyp;
                    } else {
                        services = [currentEntwurf.serviceTyp];
                    }
                }
                // Fallback: service-Feld oder Default
                if (services.length === 0) {
                    services = [currentEntwurf?.service?.toLowerCase() || 'lackier'];
                }
                // Normalisiere Service-Namen (lackierung -> lackier)
                services = services.map(s => window.normalizeServiceType ? window.normalizeServiceType(s) : s);

                // ğŸš— NEU: Abholservice hinzufÃ¼gen wenn gewÃ¼nscht
                const abholserviceGewuenscht = currentEntwurf?.abholserviceGewuenscht ||
                    document.getElementById('abholserviceGewuenschtJa')?.checked;
                if (abholserviceGewuenscht && !services.includes('abhol_fahrt')) {
                    services.unshift('abhol_fahrt'); // Am Anfang einfÃ¼gen
                }

                console.log('ğŸ“Š Services fÃ¼r KapazitÃ¤tsvorschau:', services);

                // servicePlan initialisieren falls nicht vorhanden
                if (!currentEntwurf.servicePlan) {
                    currentEntwurf.servicePlan = {};
                }

                // ğŸ”§ NEU: Tabellen-Layout mit Header-Zeile und Service-Zeilen
                let html = '';

                // 1. Header-Zeile mit Wochentagen (7 Tage: -6 bis 0)
                html += `<div class="kapazitaet-header-row">
                    <div class="kapazitaet-header-cell"></div>`; // Leere Zelle fÃ¼r Service-Label-Spalte

                for (let i = -6; i <= 0; i++) {
                    const day = new Date(centerDate);
                    day.setDate(day.getDate() + i);
                    const isSelected = i === 0; // Fertigstellungsdatum hervorheben
                    const dayName = day.toLocaleDateString('de-DE', { weekday: 'short' });
                    const dayDate = `${day.getDate()}.${day.getMonth() + 1}`;

                    html += `<div class="kapazitaet-header-cell ${isSelected ? 'selected' : ''}">
                        <div class="day-name">${dayName}</div>
                        <div class="day-date">${dayDate}</div>
                    </div>`;
                }
                html += `</div>`;

                // 2. Service-Zeilen (klickbar fÃ¼r Vorplanung!)
                for (const serviceType of services) {
                    const config = window.SERVICE_TYPE_CONFIG?.[serviceType] ||
                        (serviceType === 'abhol_fahrt' ? { icon: 'ğŸš—', displayName: 'Abholung' } : { icon: 'ğŸ”§', displayName: serviceType });

                    html += `<div class="kapazitaet-service-row">
                        <div class="service-label">${config.icon || 'ğŸ”§'} ${config.displayName || serviceType}</div>`;

                    for (let i = -6; i <= 0; i++) {
                        const day = new Date(centerDate);
                        day.setDate(day.getDate() + i);
                        const dateStr = day.toISOString().split('T')[0];

                        const capacity = calculateDayCapacity(fahrzeuge, day, serviceType);
                        const isSelected = i === 0;
                        const isPlanned = currentEntwurf.servicePlan[serviceType] === dateStr;

                        html += `<div class="kapazitaet-day status-${capacity.status} ${isSelected ? 'selected' : ''} ${isPlanned ? 'planned' : ''}"
                            data-service="${serviceType}"
                            data-date="${dateStr}"
                            onclick="selectServiceDay('${serviceType}', '${dateStr}')">
                            ${capacity.count}/${capacity.max}
                        </div>`;
                    }

                    html += `</div>`;
                }

                weekGrid.innerHTML = html;
                previewEl.classList.add('visible');

                console.log('âœ… KapazitÃ¤tsvorschau aktualisiert');

            } catch (error) {
                console.error('âŒ KapazitÃ¤tsvorschau Fehler:', error);
                previewEl.classList.remove('visible');
            }
        }

        /**
         * ğŸ“… Service-Vorplanung: Tag fÃ¼r einen Service auswÃ¤hlen
         * @param {string} serviceType - Service-Typ (z.B. 'lackier', 'abhol_fahrt')
         * @param {string} dateStr - Datum im ISO-Format (z.B. '2026-01-05')
         */
        function selectServiceDay(serviceType, dateStr) {
            // servicePlan initialisieren falls nicht vorhanden
            if (!currentEntwurf.servicePlan) {
                currentEntwurf.servicePlan = {};
            }

            // Toggle: Wenn schon ausgewÃ¤hlt, abwÃ¤hlen
            if (currentEntwurf.servicePlan[serviceType] === dateStr) {
                delete currentEntwurf.servicePlan[serviceType];
                console.log(`ğŸ“… Service-Plan: ${serviceType} abgewÃ¤hlt`);
            } else {
                currentEntwurf.servicePlan[serviceType] = dateStr;
                console.log(`ğŸ“… Service-Plan: ${serviceType} â†’ ${dateStr}`);
            }

            // UI aktualisieren
            updateKapazitaetPreview();

            // Zusammenfassung loggen
            console.log('ğŸ“… Aktueller Service-Plan:', currentEntwurf.servicePlan);
        }

        /**
         * Berechnet Ersatzfahrzeug-Kosten (Tagesmiete Ã— Tage)
         * @returns {Promise<{gesamt: number, fahrzeugId: string, kennzeichen: string, tagesmiete: number, tage: number}>}
         */
        async function berechneErsatzfahrzeugKosten() {
            const section = document.getElementById('ersatzfahrzeugKostenSection');
            const tbody = document.getElementById('ersatzfahrzeugKostenBody');
            const summeEl = document.getElementById('ersatzfahrzeugSumme');

            // Default: Versteckt
            if (!section || !tbody || !summeEl) {
                console.log('âš ï¸ Ersatzfahrzeug-Kosten UI-Elemente nicht gefunden');
                return { gesamt: 0, fahrzeugId: null, kennzeichen: '', tagesmiete: 0, tage: 0 };
            }

            const zugewiesenesErsatzfahrzeug = document.getElementById('zugewiesenesErsatzfahrzeug')?.value;
            const ersatzfahrzeugGewuenscht = document.getElementById('ersatzfahrzeugGewuenscht')?.checked;

            // Nicht gewÃ¼nscht oder nicht zugewiesen
            if (!ersatzfahrzeugGewuenscht || !zugewiesenesErsatzfahrzeug) {
                section.style.display = 'none';
                // ğŸ”§ FIX (2025-11-27): Reset Input-Felder statt innerHTML
                document.getElementById('ersatzfahrzeugName').textContent = '-';
                document.getElementById('ersatzfahrzeugTagesmieteInput').value = '';
                document.getElementById('ersatzfahrzeugTageInput').value = '';
                document.getElementById('ersatzfahrzeugGesamtCalc').textContent = '0,00 â‚¬';
                summeEl.textContent = '0,00 â‚¬';
                return { gesamt: 0, fahrzeugId: null, kennzeichen: '', tagesmiete: 0, tage: 0 };
            }

            try {
                // Leihfahrzeug-Daten aus Firestore laden
                const werkstattId = window.werkstattId;
                const leihfahrzeugDoc = await window.db
                    .collection(`leihfahrzeuge_${werkstattId}`)
                    .doc(zugewiesenesErsatzfahrzeug)
                    .get();

                if (!leihfahrzeugDoc.exists) {
                    console.warn('âš ï¸ Leihfahrzeug nicht gefunden:', zugewiesenesErsatzfahrzeug);
                    section.style.display = 'none';
                    return { gesamt: 0, fahrzeugId: zugewiesenesErsatzfahrzeug, kennzeichen: '', tagesmiete: 0, tage: 0 };
                }

                const leihfahrzeug = leihfahrzeugDoc.data();
                const tagesmiete = parseFloat(leihfahrzeug.tagesmiete) || 0;
                const kennzeichen = leihfahrzeug.kennzeichen || 'N/A';
                const fahrzeugName = `${leihfahrzeug.marke || ''} ${leihfahrzeug.modell || ''} (${kennzeichen})`.trim();

                // ğŸ”§ FIX (2025-12-04): Tage berechnen (Abholdatum bis Fertigstellung)
                // START = Abholdatum (wann Kundenfahrzeug ABGEHOLT wird + Ersatzfahrzeug HINGEBRACHT wird)
                // ENDE = Fertigstellungsdatum (wann Kundenfahrzeug FERTIG ist + Ersatzfahrzeug ZURÃœCK kommt)
                const abholdatumStr = document.getElementById('abholdatum')?.value ||
                                      currentEntwurf?.abholdatum || null;
                const fertigstellungStr = document.getElementById('geplantesAbnahmeDatum')?.value ||
                                          currentEntwurf?.geplantesAbnahmeDatum || null;

                let startDatum = new Date();
                startDatum.setHours(0, 0, 0, 0);
                let startQuelle = 'heute (Fallback)';

                let endeDatum = new Date(startDatum);
                let endeDatumQuelle = 'heute (Fallback)';

                // START = Abholdatum (wann Ersatzfahrzeug Ã¼bergeben wird)
                if (abholdatumStr) {
                    startDatum = new Date(abholdatumStr);
                    startDatum.setHours(0, 0, 0, 0);
                    startQuelle = 'Abholdatum';
                }

                // ENDE = Fertigstellungsdatum (wann Ersatzfahrzeug zurÃ¼ckkommt)
                if (fertigstellungStr) {
                    endeDatum = new Date(fertigstellungStr);
                    endeDatum.setHours(0, 0, 0, 0);
                    endeDatumQuelle = 'Fertigstellungsdatum';
                } else {
                    // Fallback: Wenn kein Fertigstellungsdatum, dann Ende = Start (mindestens 1 Tag)
                    endeDatum = new Date(startDatum);
                    endeDatumQuelle = 'Abholdatum (kein Fertigstellungsdatum)';
                }

                // Differenz berechnen (mindestens 1 Tag)
                const diffTime = endeDatum - startDatum;
                const tage = Math.max(1, Math.ceil(diffTime / (1000 * 60 * 60 * 24)));

                console.log(`ğŸ“… Ersatzfahrzeug-Tage: ${startQuelle} (${startDatum.toLocaleDateString('de-DE')}) â†’ ${endeDatumQuelle} (${endeDatum.toLocaleDateString('de-DE')}) = ${tage} Tage`);

                // Gesamt berechnen
                const gesamt = tagesmiete * tage;

                // ğŸ”§ FIX (2025-11-27): Input-Felder befÃ¼llen statt innerHTML
                document.getElementById('ersatzfahrzeugName').textContent = fahrzeugName;
                document.getElementById('ersatzfahrzeugTagesmieteInput').value = tagesmiete.toFixed(2);
                document.getElementById('ersatzfahrzeugTageInput').value = tage;
                document.getElementById('ersatzfahrzeugGesamtCalc').textContent = gesamt.toFixed(2).replace('.', ',') + ' â‚¬';

                summeEl.textContent = gesamt.toFixed(2).replace('.', ',') + ' â‚¬';
                section.style.display = 'block';

                console.log(`ğŸš— Ersatzfahrzeug-Kosten berechnet: ${fahrzeugName} Ã— ${tage} Tage = ${gesamt.toFixed(2)} â‚¬`);

                // ğŸ”§ FIX (2025-11-27): Vereinbarter Preis aktualisieren
                updateKostenaufschluesselung();

                return {
                    gesamt: gesamt,
                    fahrzeugId: zugewiesenesErsatzfahrzeug,
                    kennzeichen: kennzeichen,
                    tagesmiete: tagesmiete,
                    tage: tage
                };

            } catch (error) {
                console.error('âŒ Fehler bei Ersatzfahrzeug-Kosten Berechnung:', error);
                section.style.display = 'none';
                return { gesamt: 0, fahrzeugId: zugewiesenesErsatzfahrzeug, kennzeichen: '', tagesmiete: 0, tage: 0 };
            }
        }

        /**
         * ğŸ”§ FIX (2025-11-27): Manuelle Neuberechnung der Ersatzfahrzeug-Kosten
         * Wird aufgerufen wenn User Tagesmiete oder Tage manuell Ã¤ndert
         */
        function recalcErsatzfahrzeug() {
            const tagesmieteInput = document.getElementById('ersatzfahrzeugTagesmieteInput');
            const tageInput = document.getElementById('ersatzfahrzeugTageInput');
            const gesamtCalc = document.getElementById('ersatzfahrzeugGesamtCalc');
            const summeEl = document.getElementById('ersatzfahrzeugSumme');

            if (!tagesmieteInput || !tageInput || !gesamtCalc || !summeEl) {
                console.warn('âš ï¸ recalcErsatzfahrzeug: UI-Elemente nicht gefunden');
                return;
            }

            const tagesmiete = parseFloat(tagesmieteInput.value) || 0;
            const tage = parseInt(tageInput.value) || 0;
            const gesamt = tagesmiete * tage;

            // UI aktualisieren
            gesamtCalc.textContent = gesamt.toFixed(2).replace('.', ',') + ' â‚¬';
            summeEl.textContent = gesamt.toFixed(2).replace('.', ',') + ' â‚¬';

            console.log(`ğŸš— Ersatzfahrzeug-Kosten manuell berechnet: ${tagesmiete.toFixed(2)} â‚¬ Ã— ${tage} Tage = ${gesamt.toFixed(2)} â‚¬`);

            // ğŸ”§ FIX (2025-11-27): Vereinbarter Preis aktualisieren
            updateKostenaufschluesselung();
        }

        // ============================================
        // TOGGLE SERVICE-FELDER (Pattern 34 - FIX: Nov 17, 2025)
        // ============================================

        function toggleServiceFelder() {
            try {
                // Hide all service-felder first
                document.querySelectorAll('.service-felder').forEach(el => el.style.display = 'none');

                if (!currentEntwurf) {
                    console.log('â„¹ï¸ toggleServiceFelder: currentEntwurf ist null');
                    return;
                }

                console.log('ğŸ”„ toggleServiceFelder() - serviceTyp:', currentEntwurf.serviceTyp);

                // Single-Service oder Multi-Service?
                if (Array.isArray(currentEntwurf.serviceTyp)) {
                    // Multi-Service: Zeige alle Service-Felder
                    currentEntwurf.serviceTyp.forEach(serviceTyp => {
                        const felderDiv = document.getElementById(`${serviceTyp}-felder`);
                        if (felderDiv) {
                            felderDiv.style.display = 'block';
                            console.log(`   âœ… ${serviceTyp}-felder angezeigt`);
                        } else {
                            console.warn(`   âš ï¸ ${serviceTyp}-felder nicht gefunden`);
                        }
                    });
                    console.log(`âœ¨ Multi-Service: ${currentEntwurf.serviceTyp.length} Service-Feldgruppen angezeigt`);
                } else if (currentEntwurf.serviceTyp) {
                    // Single-Service: Zeige nur einen Service
                    const serviceTyp = currentEntwurf.serviceTyp;
                    const felderDiv = document.getElementById(`${serviceTyp}-felder`);
                    if (felderDiv) {
                        felderDiv.style.display = 'block';
                        console.log(`   âœ… ${serviceTyp}-felder angezeigt`);
                    } else {
                        console.warn(`   âš ï¸ ${serviceTyp}-felder nicht gefunden fÃ¼r Service: ${serviceTyp}`);
                    }
                    console.log(`âœ¨ Single-Service: ${serviceTyp}-felder angezeigt`);
                }

            } catch (error) {
                console.error('âŒ toggleServiceFelder Error:', error);
            }
        }

        // ============================================
        // GATHER SERVICE-DETAILS (Pattern 34 - FIX: Nov 17, 2025)
        // ============================================

        function gatherServiceDetails() {
            const details = {};

            // ğŸ†• BUGFIX 2025-11-18: Conditional assignment to prevent undefined values in Firestore

            // Reifen
            const reifengroesse = document.getElementById('reifengroesse')?.value;
            const reifentyp = document.getElementById('reifentyp')?.value;
            const reifenanzahl = document.getElementById('reifenanzahl')?.value;
            if (reifengroesse || reifentyp || reifenanzahl) {
                if (reifengroesse) details.reifengroesse = reifengroesse;
                if (reifentyp) details.reifentyp = reifentyp;
                if (reifenanzahl) details.reifenanzahl = reifenanzahl;
            }

            // Mechanik
            const mechanikProblem = document.getElementById('mechanik-problem')?.value;
            const mechanikSymptome = document.getElementById('mechanik-symptome')?.value;
            if (mechanikProblem || mechanikSymptome) {
                if (mechanikProblem) details.mechanikProblem = mechanikProblem;
                if (mechanikSymptome) details.mechanikSymptome = mechanikSymptome;
            }

            // Lackierung
            const farbname = document.getElementById('farbname')?.value;
            const farbvariante = document.getElementById('farbvariante')?.value;
            const farbnummer = document.getElementById('farbnummer')?.value;
            const lackart = document.querySelector('input[name="lackart"]:checked')?.value;
            if (farbname || farbvariante || farbnummer || lackart) {
                if (farbname) details.farbname = farbname;
                if (farbvariante) details.farbvariante = farbvariante;
                if (farbnummer) details.farbnummer = farbnummer;
                if (lackart) details.lackart = lackart;
            }

            // Glas
            const scheibentyp = document.getElementById('scheibentyp')?.value;
            const schadensgroesse = document.getElementById('schadensgroesse')?.value;
            const glasposition = document.getElementById('glasposition')?.value;
            if (scheibentyp || schadensgroesse || glasposition) {
                if (scheibentyp) details.scheibentyp = scheibentyp;
                if (schadensgroesse) details.schadensgroesse = schadensgroesse;
                if (glasposition) details.glasposition = glasposition;
            }

            // Klima
            const klimaservice = document.getElementById('klimaservice')?.value;
            const kaeltemittel = document.getElementById('kaeltemittel')?.value;
            const klimaproblem = document.getElementById('klimaproblem')?.value;
            if (klimaservice || kaeltemittel || klimaproblem) {
                if (klimaservice) details.klimaservice = klimaservice;
                if (kaeltemittel) details.kaeltemittel = kaeltemittel;
                if (klimaproblem) details.klimaproblem = klimaproblem;
            }

            // Dellen
            const dellenanzahl = document.getElementById('dellenanzahl')?.value;
            const dellengroesse = document.getElementById('dellengroesse')?.value;
            const lackschaden = document.getElementById('lackschaden')?.value;
            const dellenpositionen = document.getElementById('dellenpositionen')?.value;
            if (dellenanzahl || dellengroesse || lackschaden || dellenpositionen) {
                if (dellenanzahl) details.dellenanzahl = dellenanzahl;
                if (dellengroesse) details.dellengroesse = dellengroesse;
                if (lackschaden) details.lackschaden = lackschaden;
                if (dellenpositionen) details.dellenpositionen = dellenpositionen;
            }

            // Versicherung
            const schadensnummer = document.getElementById('versicherung-schadensnummer')?.value;
            const versicherung = document.getElementById('versicherung-name')?.value;
            const schadendatum = document.getElementById('versicherung-schadendatum')?.value;
            const unfallhergang = document.getElementById('versicherung-hergang')?.value;
            if (schadensnummer || versicherung || schadendatum || unfallhergang) {
                if (schadensnummer) details.schadensnummer = schadensnummer;
                if (versicherung) details.versicherung = versicherung;
                if (schadendatum) details.schadendatum = schadendatum;
                if (unfallhergang) details.unfallhergang = unfallhergang;
            }

            // Pflege
            const paket = document.getElementById('pflege-paket')?.value;
            const zusatzleistungen = document.getElementById('pflege-zusatz')?.value;
            if (paket || zusatzleistungen) {
                if (paket) details.paket = paket;
                if (zusatzleistungen) details.zusatzleistungen = zusatzleistungen;
            }

            // TÃœV
            const pruefart = document.getElementById('tuev-pruefart')?.value;
            const faelligkeit = document.getElementById('tuev-faelligkeit')?.value;
            const bekannteMaengel = document.getElementById('tuev-maengel')?.value;
            if (pruefart || faelligkeit || bekannteMaengel) {
                if (pruefart) details.pruefart = pruefart;
                if (faelligkeit) details.faelligkeit = faelligkeit;
                if (bekannteMaengel) details.bekannteMaengel = bekannteMaengel;
            }

            // Folierung
            const folierungArt = document.getElementById('folierungArt')?.value;
            const folierungMaterial = document.getElementById('folierungMaterial')?.value;
            const folierungFarbe = document.getElementById('folierungFarbe')?.value;
            const folierungInfo = document.getElementById('folierungInfo')?.value;
            if (folierungArt || folierungMaterial || folierungFarbe || folierungInfo) {
                if (folierungArt) details.folierungArt = folierungArt;
                if (folierungMaterial) details.folierungMaterial = folierungMaterial;
                if (folierungFarbe) details.folierungFarbe = folierungFarbe;
                if (folierungInfo) details.folierungInfo = folierungInfo;
            }

            // Steinschutz
            const steinschutzUmfang = document.getElementById('steinschutzUmfang')?.value;
            const steinschutzMaterial = document.getElementById('steinschutzMaterial')?.value;
            const steinschutzInfo = document.getElementById('steinschutzInfo')?.value;
            if (steinschutzUmfang || steinschutzMaterial || steinschutzInfo) {
                if (steinschutzUmfang) details.steinschutzUmfang = steinschutzUmfang;
                if (steinschutzMaterial) details.steinschutzMaterial = steinschutzMaterial;
                if (steinschutzInfo) details.steinschutzInfo = steinschutzInfo;
            }

            // Werbebeklebung
            const werbebeklebungUmfang = document.getElementById('werbebeklebungUmfang')?.value;
            const werbebeklebungKomplexitaet = document.getElementById('werbebeklebungKomplexitaet')?.value;
            const werbebeklebungText = document.getElementById('werbebeklebungText')?.value;
            const werbebeklebungInfo = document.getElementById('werbebeklebungInfo')?.value;
            if (werbebeklebungUmfang || werbebeklebungKomplexitaet || werbebeklebungText || werbebeklebungInfo) {
                if (werbebeklebungUmfang) details.werbebeklebungUmfang = werbebeklebungUmfang;
                if (werbebeklebungKomplexitaet) details.werbebeklebungKomplexitaet = werbebeklebungKomplexitaet;
                if (werbebeklebungText) details.werbebeklebungText = werbebeklebungText;
                if (werbebeklebungInfo) details.werbebeklebungInfo = werbebeklebungInfo;
            }

            console.log('ğŸ“‹ Service-Details gesammelt:', details);
            return Object.keys(details).length > 0 ? details : null;
        }

        // ============================================
        // SAVE ENTWURF (Update intermediate state)
        // ============================================

        async function saveEntwurf() {
            try {
                console.log('ğŸ’¾ === ENTWURF AKTUALISIEREN ===');

                if (!currentEntwurfId) {
                    throw new Error('Kein Entwurf ausgewÃ¤hlt');
                }

                // Show loading
                const saveBtn = document.getElementById('saveBtn');
                const originalText = saveBtn.textContent;
                saveBtn.innerHTML = '<span class="loading"></span> Speichert...';

                // ğŸ”§ BUG #9 FIX (2025-11-20): Email-Format-Validierung
                const kundenEmail = document.getElementById('kundenEmail').value.trim();
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!kundenEmail || !emailRegex.test(kundenEmail)) {
                    saveBtn.innerHTML = originalText;
                    toast.error('âŒ UngÃ¼ltige Email-Adresse. Bitte geben Sie eine gÃ¼ltige Email ein.');
                    return;
                }

                // Gather data
                const updatedData = {
                    kundenname: document.getElementById('kundenname').value.trim(),
                    kundenEmail: document.getElementById('kundenEmail').value.trim().toLowerCase(),
                    telefon: document.getElementById('telefon').value.trim(),
                    marke: document.getElementById('marke').value.trim(),
                    modell: document.getElementById('modell').value.trim(),
                    baujahrVon: document.getElementById('baujahrVon').value.trim(),
                    kmstand: document.getElementById('kmstand').value.trim(),
                    vin: document.getElementById('vin').value.trim(),
                    // âœ… serviceTyp is READ-ONLY (Pattern 21 - NEVER overwrite!) - set by Meister, cannot be changed here
                    notizen: document.getElementById('notizen').value.trim(),
                    vereinbarterPreis: parseFloat(document.getElementById('vereinbarterPreis').value) || 0,  // FIX: Nov 17, 2025 - BUG #2 (type consistency)
                    geplantesAbnahmeDatum: document.getElementById('geplantesAbnahmeDatum').value,
                    updatedAt: new Date().toISOString(),

                    // ğŸš— Ersatzfahrzeug (FIX: Nov 27, 2025)
                    ersatzfahrzeugGewuenscht: document.getElementById('ersatzfahrzeugGewuenscht')?.checked || false,
                    zugewiesenesErsatzfahrzeug: document.getElementById('zugewiesenesErsatzfahrzeug')?.value || null,

                    // ğŸš— Abholungs-Daten (FIX: Nov 27, 2025)
                    fahrzeugAbholen: document.getElementById('fahrzeugAbholenJa')?.checked || false,
                    abholadresse: document.getElementById('abholadresse')?.value || '',
                    abholdatum: document.getElementById('abholdatum')?.value || '',
                    abholzeit: document.getElementById('abholzeit')?.value || '',
                    abholnotiz: document.getElementById('abholnotiz')?.value || '',

                    // ğŸ“… Service-Vorplanung (FIX: Dez 09, 2025)
                    servicePlan: currentEntwurf.servicePlan || {}
                };

                // ğŸš— FIX (2025-11-27): Ersatzfahrzeug-Kosten aus Input-Feldern lesen (nicht neu berechnen!)
                const ersatzfahrzeugGewuenscht = document.getElementById('ersatzfahrzeugGewuenscht')?.checked || false;
                const zugewiesenesErsatzfahrzeug = document.getElementById('zugewiesenesErsatzfahrzeug')?.value || null;
                const ersatzfahrzeugTagesmiete = parseFloat(document.getElementById('ersatzfahrzeugTagesmieteInput')?.value) || 0;
                const ersatzfahrzeugTage = parseInt(document.getElementById('ersatzfahrzeugTageInput')?.value) || 0;
                const ersatzfahrzeugGesamt = ersatzfahrzeugTagesmiete * ersatzfahrzeugTage;
                const ersatzfahrzeugKennzeichen = document.getElementById('ersatzfahrzeugName')?.textContent || '';
                // ğŸ†• FIX (Nov 27): Werkstatt-Name aus Pool-Daten oder eigene Werkstatt
                const ersatzfahrzeugSelect = document.getElementById('zugewiesenesErsatzfahrzeug');
                const selectedOption = ersatzfahrzeugSelect?.options[ersatzfahrzeugSelect?.selectedIndex];
                const ersatzfahrzeugWerkstattName = selectedOption?.dataset?.werkstatt || window.werkstattName || '';

                // Kalkulations-Tabellen Daten (inkl. Ersatzfahrzeug)
                updatedData.kalkulationData = {
                    ersatzteile: ersatzteileData,
                    arbeitslohn: arbeitslohnData,
                    lackierung: lackierungData,
                    materialien: materialienData,
                    // ğŸš— FIX (2025-11-27): Ersatzfahrzeug-Kosten aus manuell editierbaren Inputs
                    ersatzfahrzeug: (ersatzfahrzeugGewuenscht && zugewiesenesErsatzfahrzeug && ersatzfahrzeugGesamt > 0) ? {
                        fahrzeugId: zugewiesenesErsatzfahrzeug,
                        kennzeichen: ersatzfahrzeugKennzeichen,
                        tagesmiete: ersatzfahrzeugTagesmiete,
                        tage: ersatzfahrzeugTage,
                        gesamt: ersatzfahrzeugGesamt,
                        werkstattName: ersatzfahrzeugWerkstattName  // ğŸ†• FIX (Nov 27): Pool-Werkstatt-Name
                    } : null
                };

                // Restliche Daten
                Object.assign(updatedData, {
                    // ğŸ”§ Service-Details (Pattern 34 - FIX: Nov 17, 2025)
                    serviceDetails: gatherServiceDetails(),

                    // ğŸ–¼ï¸ Fotos (Phase 3)
                    photoUrls: photos  // âœ… FIX Bug #7 (2025-11-23): Standardized field name (was: fotos)
                });

                // Update Firestore
                const werkstattId = window.werkstattId; // âœ… SECURITY FIX: No 'mosbach' fallback
                const collectionName = `partnerAnfragen_${werkstattId}`;

                await window.db.collection(collectionName)
                    .doc(currentEntwurfId)
                    .update(updatedData);

                console.log('âœ… Entwurf aktualisiert');

                // ğŸš— PHASE 2: Status-Sync + Kalender-Event bei Leihfahrzeug-Zuweisung
                // (zugewiesenesErsatzfahrzeug bereits in Zeile ~2850 deklariert)
                if (zugewiesenesErsatzfahrzeug) {
                    try {
                        // 1. Leihfahrzeug-Dokument laden fÃ¼r Kennzeichen
                        const leihfahrzeugDoc = await window.db.collection(`leihfahrzeuge_${werkstattId}`).doc(zugewiesenesErsatzfahrzeug).get();
                        const leihfahrzeugData = leihfahrzeugDoc.exists ? leihfahrzeugDoc.data() : {};
                        const leihfahrzeugKennzeichen = leihfahrzeugData.kennzeichen || 'Leihfahrzeug';

                        // 2. Leihfahrzeug-Status auf "vergeben" setzen
                        await window.db.collection(`leihfahrzeuge_${werkstattId}`).doc(zugewiesenesErsatzfahrzeug).update({
                            status: 'vergeben',
                            aktuelleZuweisung: {
                                kundenName: document.getElementById('kundenname').value.trim(),
                                fahrzeugKennzeichen: document.getElementById('kennzeichen')?.value || '',
                                entwurfId: currentEntwurfId,
                                von: new Date().toISOString(),
                                bis: document.getElementById('geplantesAbnahmeDatum').value || null
                            }
                        });
                        console.log('ğŸš— Leihfahrzeug-Status auf "vergeben" gesetzt');

                        // 3. Kalender-Event erstellen
                        const kalenderEvent = {
                            typ: 'leihfahrzeug',
                            titel: `ğŸš— ${leihfahrzeugKennzeichen} â†’ ${document.getElementById('kundenname').value.trim()}`,
                            start: new Date().toISOString(),
                            ende: document.getElementById('geplantesAbnahmeDatum').value || null,
                            fahrzeugId: zugewiesenesErsatzfahrzeug,
                            leihfahrzeugKennzeichen: leihfahrzeugKennzeichen,
                            entwurfId: currentEntwurfId,
                            kundenKennzeichen: document.getElementById('kennzeichen')?.value || '',
                            status: 'aktiv',
                            werkstattId: werkstattId,
                            createdAt: new Date().toISOString()
                        };
                        await window.db.collection(`kalenderEvents_${werkstattId}`).add(kalenderEvent);
                        console.log('ğŸ“… Kalender-Event fÃ¼r Leihfahrzeug erstellt');

                    } catch (leihfahrzeugError) {
                        console.error('âš ï¸ Leihfahrzeug-Sync Fehler (Entwurf wurde trotzdem gespeichert):', leihfahrzeugError);
                    }
                }

                // ğŸ“… FIX (2025-11-27): Abholtermin â†’ Kalender-Event
                const abholdatumValue = document.getElementById('abholdatum')?.value;
                const abholzeitValue = document.getElementById('abholzeit')?.value || '09:00';
                const fahrzeugAbholenChecked = document.getElementById('fahrzeugAbholenJa')?.checked;

                if (abholdatumValue && fahrzeugAbholenChecked) {
                    try {
                        const abholEvent = {
                            typ: 'abholung',
                            titel: `ğŸšš Abholung: ${document.getElementById('kennzeichen')?.value || 'Fahrzeug'}`,
                            fahrzeugId: currentEntwurfId,
                            kennzeichen: document.getElementById('kennzeichen')?.value || '',
                            kundenName: document.getElementById('kundenname')?.value.trim() || '',
                            datum: abholdatumValue,
                            zeit: abholzeitValue,
                            adresse: document.getElementById('abholadresse')?.value || '',
                            notiz: document.getElementById('abholnotiz')?.value || '',
                            status: 'geplant',
                            werkstattId: werkstattId,
                            createdAt: new Date().toISOString()
                        };
                        await window.db.collection(`kalenderEvents_${werkstattId}`).add(abholEvent);
                        console.log('ğŸ“… Abholtermin im Kalender eingetragen');
                    } catch (abholError) {
                        console.warn('âš ï¸ Abholtermin Kalender-Event Fehler:', abholError);
                    }
                }

                // ğŸ“… FIX (2025-11-27): Geplante Abnahme â†’ Kalender-Event
                const geplantesAbnahmeDatumValue = document.getElementById('geplantesAbnahmeDatum')?.value;

                if (geplantesAbnahmeDatumValue) {
                    try {
                        const abnahmeEvent = {
                            typ: 'geplante_abnahme',
                            titel: `âœ… Abnahme: ${document.getElementById('kennzeichen')?.value || 'Fahrzeug'}`,
                            fahrzeugId: currentEntwurfId,
                            kennzeichen: document.getElementById('kennzeichen')?.value || '',
                            kundenName: document.getElementById('kundenname')?.value.trim() || '',
                            datum: geplantesAbnahmeDatumValue,
                            status: 'geplant',
                            werkstattId: werkstattId,
                            createdAt: new Date().toISOString()
                        };
                        await window.db.collection(`kalenderEvents_${werkstattId}`).add(abnahmeEvent);
                        console.log('ğŸ“… Geplante Abnahme im Kalender eingetragen');
                    } catch (abnahmeError) {
                        console.warn('âš ï¸ Abnahme Kalender-Event Fehler:', abnahmeError);
                    }
                }

                // Reset button
                saveBtn.innerHTML = '<i data-feather="check"></i> Gespeichert!';
                feather.replace();
                setTimeout(() => {
                    saveBtn.textContent = originalText;
                    feather.replace();
                }, 2000);

                showToast('âœ… Entwurf aktualisiert', 'success', 3000);

            } catch (error) {
                console.error('âŒ Fehler beim Speichern:', error);
                showToast(`âŒ Fehler: ${error.message}`, 'error', 6000);
                document.getElementById('saveBtn').textContent = 'Entwurf aktualisieren';
                feather.replace();
            }
        }

        // ============================================
        // ZENTRALE DATENBANKEN - KALKULATIONS-DATA
        // ============================================

        /**
         * Speichert Ersatzteile in zentrale Ersatzteile-DB (ersatzteile_{werkstattId})
         * ErmÃ¶glicht spÃ¤tere Statistiken, API-Integrationen und Ersatzteil-Suche
         * @param {Array} ersatzteile - Array von Ersatzteilen (ersatzteileData)
         * @param {string} fahrzeugId - ID des Fahrzeugs
         * @param {string} kennzeichen - Kennzeichen des Fahrzeugs
         * @param {string} kundenname - Name des Kunden
         * @returns {Promise<number>} Anzahl der gespeicherten Ersatzteile
         */
        async function saveErsatzteileToCentralDB(ersatzteile, fahrzeugId, kennzeichen, kundenname) {
            if (!ersatzteile || ersatzteile.length === 0) {
                console.log('â„¹ï¸ Keine Ersatzteile zum Speichern');
                return 0;
            }

            if (!window.db) {
                console.error('âŒ Firebase nicht initialisiert');
                return 0;
            }

            console.log(`ğŸ—„ï¸ Speichere ${ersatzteile.length} Ersatzteile in zentrale DB (ersatzteile_${window.werkstattId})...`);

            // ğŸ”§ BUG #8 FIX #7 (2025-11-20): Use firebase.auth() instead of broken window.currentUser
            const currentUser = firebase.auth().currentUser;
            const userName = currentUser?.displayName || currentUser?.email || localStorage.getItem('userName') || 'BÃ¼ro';
            const userId = currentUser?.uid || null;
            const userEmail = currentUser?.email || null;

            const werkstattId = window.werkstattId; // âœ… SECURITY FIX: No 'mosbach' fallback
            const batch = window.db.batch();
            let successCount = 0;

            for (const teil of ersatzteile) {
                try {
                    const ersatzteilId = 'et_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

                    // Zentrale Ersatzteil-Daten
                    // ğŸ”§ FIX (2025-11-29): Erweiterte Feld-Mapping-Kette fÃ¼r kalkulation.html KompatibilitÃ¤t
                    const einzelpreis = parseFloat(teil.einzelpreis || teil.preis) || 0;
                    const anzahl = parseInt(teil.anzahl || teil.menge) || 1;
                    const ersatzteilData = {
                        id: ersatzteilId,
                        etn: teil.etn || teil.teilenummer || '',
                        benennung: teil.benennung || teil.name || '',
                        einzelpreis: einzelpreis,
                        // Referenz-Daten
                        fahrzeugId: fahrzeugId,
                        kennzeichen: kennzeichen,
                        kundenname: kundenname,
                        // Meta-Daten
                        werkstattId: werkstattId,
                        createdAt: new Date().toISOString(),
                        createdBy: userName,
                        createdByUserId: userId,  // ğŸ†• FIX: User-ID fÃ¼r eindeutige Zuordnung
                        createdByEmail: userEmail,  // ğŸ†• FIX: Email fÃ¼r Compliance
                        // Optional: Anzahl aus diesem spezifischen Auftrag
                        anzahlInAuftrag: anzahl,
                        gesamtpreisInAuftrag: parseFloat(teil.gesamtpreis) || (einzelpreis * anzahl),
                        // ğŸ”§ FIX (2025-11-29): Lieferant und Link aus kalkulation.html
                        lieferant: teil.lieferant || null,
                        bestellLink: teil.bestellLink || null
                    };

                    // In Batch hinzufÃ¼gen
                    const docRef = window.getCollection('ersatzteile').doc(ersatzteilId);
                    batch.set(docRef, ersatzteilData);

                    successCount++;
                } catch (error) {
                    console.error('âŒ Fehler beim Speichern von Ersatzteil:', teil, error);
                }
            }

            // Batch commit
            try {
                await batch.commit();
                console.log(`âœ… ${successCount} Ersatzteile erfolgreich in zentraler DB gespeichert`);
                return successCount;
            } catch (error) {
                console.error('âŒ Batch-Commit fehlgeschlagen:', error);
                throw error;
            }
        }

        /**
         * ğŸ†• FIX (2025-11-29): Erstellt Bestellungen aus Ersatzteilen fÃ¼r Kanban-Anzeige
         * Identisch zur Funktion in meine-anfragen.html
         * @param {Array} ersatzteile - Array von Ersatzteilen
         * @param {string} kennzeichen - Kennzeichen des Fahrzeugs
         * @param {string} fahrzeugId - ID des Fahrzeugs
         * @returns {number} Anzahl erstellter Bestellungen
         */
        async function createBestellungenFromErsatzteile(ersatzteile, kennzeichen, fahrzeugId) {
            if (!ersatzteile || ersatzteile.length === 0) {
                console.log('â„¹ï¸ Keine Ersatzteile zum Konvertieren');
                return 0;
            }

            console.log(`ğŸ“¦ [ENTWURF] Erstelle ${ersatzteile.length} Bestellungen aus Ersatzteilen...`);

            let bestellungenCreated = 0;
            const batch = db.batch();

            for (const teil of ersatzteile) {
                try {
                    const bestellungId = `best_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

                    // ğŸ”§ FIX (2025-11-29): Erweiterte Feld-Mapping-Kette fÃ¼r kalkulation.html KompatibilitÃ¤t
                    const einzelpreis = parseFloat(teil.einzelpreis || teil.preis) || 0;
                    const menge = parseInt(teil.anzahl || teil.menge) || 1;
                    const bestellungData = {
                        id: bestellungId,
                        fahrzeugId: String(fahrzeugId),
                        kennzeichen: kennzeichen || 'k.A.',
                        werkstattId: window.werkstattId,

                        // Ersatzteil-Daten (mit Fallback-Kette)
                        etn: teil.etn || teil.teilenummer || '',
                        benennung: teil.benennung || teil.name || 'Ersatzteil',
                        menge: menge,  // ğŸ”§ FIX: 'menge' statt 'anzahl' fÃ¼r material.html KompatibilitÃ¤t
                        einzelpreis: einzelpreis,
                        gesamtpreis: parseFloat(teil.gesamtpreis) || (einzelpreis * menge),

                        // Bestellungs-Metadaten
                        // ğŸ†• FIX (2025-11-29): 'bestellt' statt 'offen' fÃ¼r Konsistenz mit meine-anfragen.html
                        status: 'bestellt',  // bestellt â†’ angeliefert (konsistent mit KVA-Pipeline)
                        source: 'entwurf',  // ğŸ”§ FIX: 'source' statt 'quelle' fÃ¼r material.html Badge
                        bestelltVon: localStorage.getItem('userName') || 'BÃ¼ro',
                        bestelltAm: new Date().toISOString(),
                        createdAt: new Date().toISOString(),
                        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                        // ğŸ”§ FIX (2025-11-29): Lieferant und Link aus kalkulation.html
                        lieferantName: teil.lieferant || null,
                        bestellLink: teil.bestellLink || null
                    };

                    const docRef = window.getCollection('bestellungen').doc(bestellungId);
                    batch.set(docRef, bestellungData);
                    bestellungenCreated++;
                } catch (error) {
                    console.error('âŒ Fehler beim Erstellen der Bestellung:', teil, error);
                }
            }

            try {
                await batch.commit();
                console.log(`âœ… ${bestellungenCreated} Bestellungen erfolgreich erstellt (Quelle: Entwurf)`);
                return bestellungenCreated;
            } catch (error) {
                console.error('âŒ Batch-Commit fÃ¼r Bestellungen fehlgeschlagen:', error);
                return 0;
            }
        }

        /**
         * Speichert Arbeitslohn in zentrale Arbeitslohn-DB (arbeitslohn_{werkstattId})
         * ErmÃ¶glicht spÃ¤tere Durchschnittspreise und Standard-TÃ¤tigkeiten
         * @param {Array} arbeitslohn - Array von Arbeitslohn-Positionen
         * @param {string} fahrzeugId - ID des Fahrzeugs
         * @param {string} kennzeichen - Kennzeichen des Fahrzeugs
         * @param {string} kundenname - Name des Kunden
         * @returns {Promise<number>} Anzahl der gespeicherten Positionen
         */
        async function saveArbeitslohnToCentralDB(arbeitslohn, fahrzeugId, kennzeichen, kundenname) {
            if (!arbeitslohn || arbeitslohn.length === 0) {
                console.log('â„¹ï¸ Kein Arbeitslohn zum Speichern');
                return 0;
            }

            console.log(`ğŸ—„ï¸ Speichere ${arbeitslohn.length} Arbeitslohn-Positionen in zentrale DB...`);

            const userName = window.currentUser?.name || localStorage.getItem('userName') || 'BÃ¼ro';
            const werkstattId = window.werkstattId; // âœ… SECURITY FIX: No 'mosbach' fallback
            const batch = window.db.batch();
            let successCount = 0;

            for (const position of arbeitslohn) {
                try {
                    const positionId = 'al_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

                    const positionData = {
                        id: positionId,
                        taetigkeit: position.taetigkeit || '',
                        stundensatz: position.stundensatz || 0,
                        stunden: position.stunden || 0,
                        gesamtpreis: position.gesamtpreis || 0,
                        // Referenz-Daten
                        fahrzeugId: fahrzeugId,
                        kennzeichen: kennzeichen,
                        kundenname: kundenname,
                        // Meta-Daten
                        werkstattId: werkstattId,
                        createdAt: new Date().toISOString(),
                        createdBy: userName
                    };

                    const docRef = window.getCollection('arbeitslohn').doc(positionId);
                    batch.set(docRef, positionData);
                    successCount++;
                } catch (error) {
                    console.error('âŒ Fehler beim Speichern von Arbeitslohn:', position, error);
                }
            }

            try {
                await batch.commit();
                console.log(`âœ… ${successCount} Arbeitslohn-Positionen gespeichert`);
                return successCount;
            } catch (error) {
                console.error('âŒ Batch-Commit fehlgeschlagen:', error);
                throw error;
            }
        }

        /**
         * Speichert Lackierung in zentrale Lackierung-DB (lackierung_{werkstattId})
         * ErmÃ¶glicht spÃ¤tere Preisstatistiken und mÂ²-Berechnungen
         * @param {Array} lackierung - Array von Lackierungs-Positionen
         * @param {string} fahrzeugId - ID des Fahrzeugs
         * @param {string} kennzeichen - Kennzeichen des Fahrzeugs
         * @param {string} kundenname - Name des Kunden
         * @returns {Promise<number>} Anzahl der gespeicherten Positionen
         */
        async function saveLackierungToCentralDB(lackierung, fahrzeugId, kennzeichen, kundenname) {
            if (!lackierung || lackierung.length === 0) {
                console.log('â„¹ï¸ Keine Lackierung zum Speichern');
                return 0;
            }

            console.log(`ğŸ—„ï¸ Speichere ${lackierung.length} Lackierungs-Positionen in zentrale DB...`);

            const userName = window.currentUser?.name || localStorage.getItem('userName') || 'BÃ¼ro';
            const werkstattId = window.werkstattId; // âœ… SECURITY FIX: No 'mosbach' fallback
            const batch = window.db.batch();
            let successCount = 0;

            for (const position of lackierung) {
                try {
                    const positionId = 'lack_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

                    const positionData = {
                        id: positionId,
                        teil: position.teil || '',
                        m2: position.m2 || 0,
                        preis_pro_m2: position.preis_pro_m2 || 0,
                        gesamtpreis: position.gesamtpreis || 0,
                        // Referenz-Daten
                        fahrzeugId: fahrzeugId,
                        kennzeichen: kennzeichen,
                        kundenname: kundenname,
                        // Meta-Daten
                        werkstattId: werkstattId,
                        createdAt: new Date().toISOString(),
                        createdBy: userName
                    };

                    const docRef = window.getCollection('lackierung').doc(positionId);
                    batch.set(docRef, positionData);
                    successCount++;
                } catch (error) {
                    console.error('âŒ Fehler beim Speichern von Lackierung:', position, error);
                }
            }

            try {
                await batch.commit();
                console.log(`âœ… ${successCount} Lackierungs-Positionen gespeichert`);
                return successCount;
            } catch (error) {
                console.error('âŒ Batch-Commit fehlgeschlagen:', error);
                throw error;
            }
        }

        /**
         * Speichert Materialien in zentrale Materialien-DB (materialien_{werkstattId})
         * ErmÃ¶glicht spÃ¤tere Material-Statistiken und Bestandsverwaltung
         * @param {Array} materialien - Array von Material-Positionen
         * @param {string} fahrzeugId - ID des Fahrzeugs
         * @param {string} kennzeichen - Kennzeichen des Fahrzeugs
         * @param {string} kundenname - Name des Kunden
         * @returns {Promise<number>} Anzahl der gespeicherten Positionen
         */
        async function saveMaterialienToCentralDB(materialien, fahrzeugId, kennzeichen, kundenname) {
            if (!materialien || materialien.length === 0) {
                console.log('â„¹ï¸ Keine Materialien zum Speichern');
                return 0;
            }

            console.log(`ğŸ—„ï¸ Speichere ${materialien.length} Material-Positionen in zentrale DB...`);

            const userName = window.currentUser?.name || localStorage.getItem('userName') || 'BÃ¼ro';
            const werkstattId = window.werkstattId; // âœ… SECURITY FIX: No 'mosbach' fallback
            const batch = window.db.batch();
            let successCount = 0;

            for (const material of materialien) {
                try {
                    const materialId = 'mat_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

                    const materialData = {
                        id: materialId,
                        material: material.material || '',
                        einheit: material.einheit || '',
                        menge: material.menge || 0,
                        einzelpreis: material.einzelpreis || 0,
                        gesamtpreis: material.gesamtpreis || 0,
                        // Referenz-Daten
                        fahrzeugId: fahrzeugId,
                        kennzeichen: kennzeichen,
                        kundenname: kundenname,
                        // Meta-Daten
                        werkstattId: werkstattId,
                        createdAt: new Date().toISOString(),
                        createdBy: userName
                    };

                    const docRef = window.getCollection('materialien').doc(materialId);
                    batch.set(docRef, materialData);
                    successCount++;
                } catch (error) {
                    console.error('âŒ Fehler beim Speichern von Material:', material, error);
                }
            }

            try {
                await batch.commit();
                console.log(`âœ… ${successCount} Material-Positionen gespeichert`);
                return successCount;
            } catch (error) {
                console.error('âŒ Batch-Commit fehlgeschlagen:', error);
                throw error;
            }
        }

        // ============================================
        // ERSTELLE ANGEBOT & VERSENDE
        // ============================================

        async function erstelleAngebot() {
            try {
                console.log('ğŸ“¤ === ANGEBOT ERSTELLEN & VERSENDEN ===');

                if (!currentEntwurfId) {
                    throw new Error('Kein Entwurf ausgewÃ¤hlt');
                }

                // Validation
                const requiredFields = {
                    'Kundenname': document.getElementById('kundenname').value.trim(),
                    'Kunden-Email': document.getElementById('kundenEmail').value.trim(),
                    'Marke': document.getElementById('marke').value.trim(),
                    'Modell': document.getElementById('modell').value.trim(),
                    'Notizen': document.getElementById('notizen').value.trim(),
                    'Fertigstellungsdatum': document.getElementById('geplantesAbnahmeDatum').value.trim(),
                };

                for (const [field, value] of Object.entries(requiredFields)) {
                    if (!value) {
                        showToast(`âš ï¸ Bitte fÃ¼llen Sie das Feld "${field}" aus!`, 'error', 5000);
                        return;
                    }
                }

                // ğŸ†• FIX Nov 30, 2025: Preis-Validierung mit 2-Varianten-Support
                const summeBruttoOriginal = parseFloat(document.getElementById('summeBruttoOriginal')?.value) || 0;
                const summeBruttoAftermarket = parseFloat(document.getElementById('summeBruttoAftermarket')?.value) || 0;
                const vereinbarterPreis = parseFloat(document.getElementById('vereinbarterPreis')?.value) || 0;
                const hasVarianten = summeBruttoOriginal > 0 || summeBruttoAftermarket > 0;

                if (!hasVarianten && !vereinbarterPreis) {
                    showToast('âš ï¸ Bitte geben Sie einen Preis ein!', 'error', 5000);
                    return;
                }

                console.log('ğŸ’° Preis-Validierung:', { summeBruttoOriginal, summeBruttoAftermarket, vereinbarterPreis, hasVarianten });

                // Email format validation
                const email = document.getElementById('kundenEmail').value.trim().toLowerCase();
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    showToast('âš ï¸ UngÃ¼ltige Email-Adresse!', 'error', 5000);
                    return;
                }

                // Show loading
                const sendBtn = document.getElementById('sendBtn');
                const originalText = sendBtn.textContent;
                sendBtn.innerHTML = '<span class="loading"></span> Wird versendet...';

                // Step 1: Ensure Partner Account exists
                console.log('ğŸ” Step 1: Partner Account sicherstellen...');
                const ensurePartnerAccount = window.functions.httpsCallable('ensurePartnerAccount');
                const accountResult = await ensurePartnerAccount({
                    email: email,
                    name: document.getElementById('kundenname').value.trim() || 'Kunde',  // âœ… FIX: Fallback for empty name (Bug #22 Regression)
                    werkstattId: window.werkstattId
                });

                console.log('âœ… Partner Account:', accountResult.data);

                // ğŸ†” Extract partnerId (FIX: Nov 17, 2025 - Pipeline Data Mapping)
                const partnerId = accountResult.data.partnerId;

                // âœ… VALIDATE partnerId exists (FIX: Nov 17, 2025 - BUG #3)
                if (!partnerId) {
                    console.error('âŒ ensurePartnerAccount returned:', accountResult.data);
                    throw new Error('Partner-ID konnte nicht erstellt werden. Bitte erneut versuchen.');
                }

                console.log('ğŸ“Œ Partner ID:', partnerId);

                // Step 2: Create Auto-Login Token
                console.log('ğŸ”‘ Step 2: Auto-Login Token erstellen...');
                const createToken = window.functions.httpsCallable('createPartnerAutoLoginToken');
                const tokenResult = await createToken({
                    email: email,
                });

                const autoLoginToken = tokenResult.data.token;
                console.log('âœ… Auto-Login Token erstellt');

                // Step 3: Generate QR Code URL
                const baseUrl = window.location.origin + window.location.pathname.replace(/[^/]+$/, '');
                const qrCodeUrl = `${baseUrl}partner-app/auto-login.html?token=${autoLoginToken}`;
                console.log('ğŸ”— QR-Code URL:', qrCodeUrl);

                // ğŸ”„ BUGFIX: Email-First Pattern (prevents inconsistent state)
                // OLD: Update Firestore â†’ Send Email (if email fails â†’ status inconsistent!)
                // NEW: Send Email â†’ Update Firestore (only if email succeeds)

                // Step 4: Send Email FIRST (before status change)
                console.log('ğŸ“§ Step 4: Email versenden (BEFORE status update)...');
                const sendEmail = window.functions.httpsCallable('sendEntwurfEmail');
                const emailResult = await sendEmail({
                    kundenEmail: email,
                    kundenname: document.getElementById('kundenname').value.trim(),
                    kennzeichen: document.getElementById('kennzeichen').value.trim(),
                    qrCodeUrl: qrCodeUrl,
                    fahrzeugId: currentEntwurfId,
                    // ğŸ†• FIX Nov 30, 2025: Varianten-Preise fÃ¼r Email-Template
                    hasVarianten: hasVarianten,
                    summeBruttoOriginal: summeBruttoOriginal,
                    summeBruttoAftermarket: summeBruttoAftermarket,
                    vereinbarterPreis: hasVarianten ? null : vereinbarterPreis,
                });

                // âœ… PATTERN 31: Check for Demo Mode (SendGrid API Key invalid/missing)
                if (emailResult.data.demoMode) {
                    console.warn('âš ï¸ [DEMO MODE] Email nicht versendet:', emailResult.data.message);
                    showToast('âš ï¸ Demo-Modus: Email-Versand Ã¼bersprungen.\n\nAngebot wird trotzdem erstellt, aber Email wird NICHT versendet.\n\nğŸ’¡ Tipp: SendGrid API Key in Firebase Secret Manager aktualisieren.', 'warning', 8000);
                } else {
                    console.log('âœ… Email versendet');
                }

                // Step 5: Update Entwurf Status ONLY AFTER successful email
                console.log('ğŸ“ Step 5: Entwurf-Status aktualisieren (nach erfolgreicher Email)...');
                const werkstattId = window.werkstattId; // âœ… SECURITY FIX: No 'mosbach' fallback
                const collectionName = `partnerAnfragen_${werkstattId}`;

                // ğŸ†• FIX Nov 30, 2025: 2-Varianten-Support (Original + Aftermarket)
                const angebotDetails = {
                    // Fallback: vereinbarterPreis fÃ¼r manuelle Eingabe, sonst Original-Variante
                    preis: hasVarianten ? summeBruttoOriginal : vereinbarterPreis,
                    serviceBeschreibung: document.getElementById('notizen').value.trim(),
                    fertigstellungsdatum: document.getElementById('geplantesAbnahmeDatum').value,
                    erstelltAm: new Date().toISOString(),
                    erstelltVon: window.currentUser?.name || 'BÃ¼ro',
                    // ğŸ†• 2-Varianten-Preise fÃ¼r Partner-Auswahl
                    hasVarianten: hasVarianten,
                    summeBruttoOriginal: summeBruttoOriginal || null,
                    summeBruttoAftermarket: summeBruttoAftermarket || null,
                };

                await window.db.collection(collectionName).doc(currentEntwurfId).update({
                    // Update all fields
                    kundenname: document.getElementById('kundenname').value.trim(),
                    kennzeichen: document.getElementById('kennzeichen').value.trim(),  // FIX: Nov 17, 2025 - BUG #4
                    kundenEmail: email,
                    telefon: document.getElementById('telefon').value.trim(),
                    marke: document.getElementById('marke').value.trim(),
                    modell: document.getElementById('modell').value.trim(),
                    baujahrVon: document.getElementById('baujahrVon').value.trim(),
                    kmstand: document.getElementById('kmstand').value.trim(),
                    vin: document.getElementById('vin').value.trim(),
                    // âœ… serviceTyp is READ-ONLY (Pattern 21) - NEVER overwrite (already set by Meister)
                    notizen: document.getElementById('notizen').value.trim(),
                    // ğŸ†• FIX Nov 30, 2025: 2-Varianten-Preise speichern
                    vereinbarterPreis: hasVarianten ? summeBruttoOriginal : vereinbarterPreis,
                    summeBruttoOriginal: summeBruttoOriginal || null,
                    summeBruttoAftermarket: summeBruttoAftermarket || null,
                    hasVarianten: hasVarianten,
                    geplantesAbnahmeDatum: document.getElementById('geplantesAbnahmeDatum').value,

                    // ğŸ†” Partner ID Mapping (FIX: Nov 17, 2025 - enables partner to see offers!)
                    partnerId: partnerId,

                    // Change entwurf status (ONLY after successful email!)
                    entwurfStatus: 'angebot_erstellt',
                    status: 'kva_gesendet',

                    // Save offer details
                    angebotDetails: angebotDetails,

                    // ğŸš— FIX (2025-11-27): Ersatzfahrzeug-Kosten fÃ¼r PDF sammeln
                    // (Variablen inline berechnet, da auÃŸerhalb des await-Blocks deklariert)

                    // Kalkulations-Tabellen Daten (inkl. Ersatzfahrzeug fÃ¼r PDF!)
                    kalkulationData: {
                        ersatzteile: ersatzteileData,
                        arbeitslohn: arbeitslohnData,
                        lackierung: lackierungData,
                        materialien: materialienData,
                        // ğŸ†• FIX Nov 30, 2025: 2-Varianten-Preise in kalkulationData
                        summeBruttoOriginal: summeBruttoOriginal || null,
                        summeBruttoAftermarket: summeBruttoAftermarket || null,
                        hasVarianten: hasVarianten,
                        // ğŸš— FIX (2025-11-27): Ersatzfahrzeug-Kosten fÃ¼r PDF
                        ersatzfahrzeug: (() => {
                            const gewuenscht = document.getElementById('ersatzfahrzeugGewuenscht')?.checked || false;
                            const zugewiesen = document.getElementById('zugewiesenesErsatzfahrzeug')?.value || null;
                            const tagesmiete = parseFloat(document.getElementById('ersatzfahrzeugTagesmieteInput')?.value) || 0;
                            const tage = parseInt(document.getElementById('ersatzfahrzeugTageInput')?.value) || 0;
                            const gesamt = tagesmiete * tage;
                            const kennzeichen = document.getElementById('ersatzfahrzeugName')?.textContent || '';

                            return (gewuenscht && zugewiesen && gesamt > 0) ? {
                                fahrzeugId: zugewiesen,
                                kennzeichen: kennzeichen,
                                tagesmiete: tagesmiete,
                                tage: tage,
                                gesamt: gesamt
                            } : null;
                        })()
                    },

                    // ğŸ”§ Service-Details (Pattern 34 - FIX: Nov 17, 2025)
                    serviceDetails: gatherServiceDetails(),

                    // ğŸ–¼ï¸ Fotos (Phase 3)
                    photoUrls: photos,  // âœ… FIX: Korrekter Feldname (preserviert Original)

                    // ğŸ†• FIX (2025-11-29): Ersatzfahrzeug/Abholservice-Flags fÃ¼r annehmenKVA() Anlieferung-Status
                    // KRITISCH: Diese Felder werden von meine-anfragen.html geprÃ¼ft um prozessStatus zu setzen!
                    ersatzfahrzeugGewuenscht: document.getElementById('ersatzfahrzeugGewuenscht')?.checked || false,
                    abholserviceGewuenscht: document.getElementById('fahrzeugAbholenJa')?.checked || false,

                    // ğŸš— Abholungs-Daten (FIX: 2025-12-09) - MÃœSSEN beim Angebot erstellen auch gespeichert werden!
                    // KRITISCH: Ohne diese Felder gehen Abholung-Details verloren wenn User direkt "Angebot erstellen" klickt!
                    fahrzeugAbholen: document.getElementById('fahrzeugAbholenJa')?.checked || false,
                    abholadresse: document.getElementById('abholadresse')?.value || '',
                    abholdatum: document.getElementById('abholdatum')?.value || '',
                    abholzeit: document.getElementById('abholzeit')?.value || '',
                    abholnotiz: document.getElementById('abholnotiz')?.value || '',

                    // ğŸ“… Service-Vorplanung (FIX: Dez 09, 2025)
                    servicePlan: currentEntwurf.servicePlan || {},

                    // Metadata
                    angebotErstelltAm: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),

                    // ğŸ”§ BUG #8 FIX #5 (2025-11-20): Add lastModifiedBy audit trail
                    lastModifiedBy: firebase.auth().currentUser?.displayName || firebase.auth().currentUser?.email || 'BÃ¼ro',
                    lastModifiedByUserId: firebase.auth().currentUser?.uid || null,
                    lastModifiedByEmail: firebase.auth().currentUser?.email || null,
                    lastModified: firebase.firestore.FieldValue.serverTimestamp()
                });

                console.log('âœ… Entwurf-Status aktualisiert (Email + Status update komplett)');

                // ğŸ†• Pipeline-Optimierung (2025-12-08): Wenn Quelle 'fahrzeuge' ist, auch dort Status aktualisieren
                if (currentEntwurf?.source === 'fahrzeuge') {
                    try {
                        await window.getCollection('fahrzeuge').doc(currentEntwurfId).update({
                            status: 'kva_gesendet',
                            kvaGesendetAm: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        console.log('âœ… Fahrzeug-Status auf "kva_gesendet" aktualisiert:', currentEntwurfId);
                    } catch (fahrzeugError) {
                        console.warn('âš ï¸ Fahrzeug-Status-Update fehlgeschlagen:', fahrzeugError);
                    }
                }

                // ğŸ—„ï¸ Step 5b: Speichere Kalkulations-Daten in zentrale Datenbanken (fÃ¼r Automatisierung & PreisvorschlÃ¤ge)
                console.log('ğŸ—„ï¸ Step 5b: Speichere Kalkulations-Daten in zentrale DBs...');
                try {
                    const kennzeichen = document.getElementById('kennzeichen').value.trim();
                    const kundenname = document.getElementById('kundenname').value.trim();

                    // âœ… Phase 1: Ersatzteile speichern (nur Stammdaten - KEINE Bestellungen!)
                    // ğŸ†• FIX (2025-11-30): Bestellungen werden ERST bei Kundenannahme erstellt
                    // (in meine-anfragen.html annehmenKVA() Funktion)
                    // GRUND: Vorher wurden Bestellungen doppelt erstellt (beim Senden + bei Annahme)
                    if (ersatzteileData && ersatzteileData.length > 0) {
                        await saveErsatzteileToCentralDB(ersatzteileData, currentEntwurfId, kennzeichen, kundenname);
                        console.log('   â„¹ï¸ Ersatzteile-Stammdaten gespeichert (Bestellungen werden erst bei Kundenannahme erstellt)');
                    }

                    // âœ… Phase 2: Arbeitslohn speichern
                    if (arbeitslohnData && arbeitslohnData.length > 0) {
                        await saveArbeitslohnToCentralDB(arbeitslohnData, currentEntwurfId, kennzeichen, kundenname);
                    }

                    // âœ… Phase 3: Lackierung speichern
                    if (lackierungData && lackierungData.length > 0) {
                        await saveLackierungToCentralDB(lackierungData, currentEntwurfId, kennzeichen, kundenname);
                    }

                    // âœ… Phase 4: Materialien speichern
                    if (materialienData && materialienData.length > 0) {
                        await saveMaterialienToCentralDB(materialienData, currentEntwurfId, kennzeichen, kundenname);
                    }

                    console.log('âœ… Alle Kalkulations-Daten in zentrale DBs gespeichert');
                } catch (error) {
                    console.error('âš ï¸ Fehler beim Speichern in zentrale DBs (nicht-kritisch):', error);
                    // Non-blocking error - continue with PDF generation
                }

                // Step 6: Generate PDF fÃ¼r Admin
                console.log('ğŸ“„ Step 6: Generiere Kalkulation-PDF fÃ¼r Admin...');
                showToast('ğŸ“„ Erstelle Kalkulation-PDF...', 'info', 3000);

                const generatePDF = window.functions.httpsCallable('generateAngebotPDF');
                const pdfResult = await generatePDF({
                    entwurfId: currentEntwurfId,
                    werkstattId: werkstattId
                });

                console.log('âœ… PDF generiert:', pdfResult.data.filename);

                // âœ… FIX: Nov 17, 2025 - BUG #2 - Download PDF for BÃ¼ro-Mitarbeiter
                console.log('ğŸ’¾ Step 6b: Lade PDF herunter fÃ¼r BÃ¼ro-Mitarbeiter...');
                try {
                    const pdfBlob = base64ToBlob(pdfResult.data.pdfBase64, 'application/pdf');
                    const downloadUrl = URL.createObjectURL(pdfBlob);
                    const downloadLink = document.createElement('a');
                    downloadLink.href = downloadUrl;
                    downloadLink.download = pdfResult.data.filename;
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                    URL.revokeObjectURL(downloadUrl);
                    console.log('âœ… PDF heruntergeladen:', pdfResult.data.filename);
                } catch (downloadError) {
                    console.error('âš ï¸ PDF-Download fehlgeschlagen (aber Email wird trotzdem gesendet):', downloadError);
                    // Continue with email sending even if download fails
                }

                // Step 7: Send PDF to Admin
                console.log('ğŸ“§ Step 7: Sende Kalkulation-PDF an Admin...');
                showToast('ğŸ“§ Sende Email an Admin...', 'info', 3000);

                const sendAdminEmail = window.functions.httpsCallable('sendAngebotPDFToAdmin');
                const adminEmailResult = await sendAdminEmail({
                    pdfBase64: pdfResult.data.pdfBase64,
                    filename: pdfResult.data.filename,
                    entwurfId: currentEntwurfId,
                    werkstattId: werkstattId,
                    kennzeichen: document.getElementById('kennzeichen').value.trim(),
                    kundenname: document.getElementById('kundenname').value.trim(),
                    vereinbarterPreis: document.getElementById('vereinbarterPreis').value
                });

                // âœ… BUG #4 FIX: Check for email skip
                if (adminEmailResult.data && adminEmailResult.data.emailSkipped) {
                    console.warn('âš ï¸ Admin-Email wurde Ã¼bersprungen (erwartet):', adminEmailResult.data.message);
                    showToast(
                        'â„¹ï¸ PDF erstellt, aber Admin-Email Ã¼bersprungen (SendGrid deaktiviert).\n\nğŸ’¡ Tipp: Laden Sie das PDF manuell herunter.',
                        'info',
                        6000
                    );
                } else {
                    console.log('âœ… Admin-Email versendet');
                }

                // Step 8: Success!
                sendBtn.innerHTML = '<i data-feather="check"></i> Versendet!';
                feather.replace();

                // Show success message
                const successMsg = document.getElementById('successMessage');
                successMsg.classList.add('show');

                showToast('âœ… Angebot erfolgreich versendet!', 'success', 4000);

                // Redirect after 2 seconds
                setTimeout(() => {
                    safeNavigate('liste.html');
                }, 2000);

            } catch (error) {
                console.error('âŒ Fehler beim Versenden des Angebots:', error);

                // âœ… IMPROVED: Context-specific error messages (FIX: Nov 17, 2025 - BUG #6)
                let errorMsg = 'âŒ Fehler beim Versenden des Angebots.\n\n';

                if (error.message.includes('Partner-Account') || error.message.includes('ensurePartnerAccount') || error.message.includes('Partner-ID')) {
                    errorMsg += 'ğŸ‘¤ Partner-Account konnte nicht erstellt werden.\n\n';
                    errorMsg += `Details: ${error.message}\n\n`;
                    errorMsg += 'ğŸ’¡ Tipp: PrÃ¼fen Sie die Kunden-Email und versuchen Sie es erneut.';
                } else if (error.message.includes('Email') || error.message.includes('sendEntwurfEmail')) {
                    errorMsg += 'ğŸ“§ Email konnte nicht versendet werden.\n\n';

                    // âœ… PATTERN 31: Check if it's a SendGrid API Key issue
                    if (error.message.toLowerCase().includes('unauthorized') ||
                        error.message.toLowerCase().includes('api key') ||
                        error.message.toLowerCase().includes('sendgrid')) {
                        errorMsg += 'ğŸ” SendGrid API Key Problem:\n';
                        errorMsg += 'â€¢ API Key ist ungÃ¼ltig oder abgelaufen\n';
                        errorMsg += 'â€¢ API Key wurde nicht konfiguriert\n\n';
                        errorMsg += 'ğŸ’¡ LÃ¶sung:\n';
                        errorMsg += '1. Neuen SendGrid API Key erstellen (https://app.sendgrid.com)\n';
                        errorMsg += '2. In Firebase Secret Manager aktualisieren:\n';
                        errorMsg += '   firebase functions:secrets:set SENDGRID_API_KEY\n\n';
                        errorMsg += 'âš ï¸ ACHTUNG: Workflow lÃ¤uft jetzt im Demo-Modus!\n';
                        errorMsg += '   â†’ Angebot wird erstellt (OHNE Email-Versand)\n';
                        errorMsg += '   â†’ Kunde erhÃ¤lt KEINE Email!';
                    } else {
                        errorMsg += 'MÃ¶gliche GrÃ¼nde:\n';
                        errorMsg += 'â€¢ UngÃ¼ltige Email-Adresse\n';
                        errorMsg += 'â€¢ SendGrid-Fehler (Trial abgelaufen)\n';
                        errorMsg += 'â€¢ Netzwerkproblem\n\n';
                        errorMsg += 'ğŸ’¡ Tipp: PrÃ¼fen Sie die Email-Adresse und versuchen Sie es erneut.\n';
                        errorMsg += 'âš ï¸ Der Entwurf bleibt als "offen" gespeichert.';
                    }
                } else if (error.message.includes('Token') || error.message.includes('createPartnerAutoLoginToken')) {
                    errorMsg += 'ğŸ”‘ Auto-Login Token konnte nicht erstellt werden.\n\n';
                    errorMsg += `Details: ${error.message}\n\n`;
                    errorMsg += 'ğŸ’¡ Tipp: Versuchen Sie es erneut oder kontaktieren Sie den Support.';
                } else if (error.message.includes('PDF') || error.message.includes('generateAngebotPDF')) {
                    errorMsg += 'ğŸ“„ PDF konnte nicht generiert werden.\n\n';
                    errorMsg += `Details: ${error.message}\n\n`;
                    errorMsg += 'ğŸ’¡ Tipp: PrÃ¼fen Sie die Kalkulations-Daten und versuchen Sie es erneut.';
                } else if (error.message.includes('network') || error.message.includes('Network') || error.message.includes('fetch')) {
                    errorMsg += 'ğŸŒ Netzwerkfehler aufgetreten.\n\n';
                    errorMsg += 'MÃ¶gliche GrÃ¼nde:\n';
                    errorMsg += 'â€¢ Keine Internetverbindung\n';
                    errorMsg += 'â€¢ Firebase-Server nicht erreichbar\n';
                    errorMsg += 'â€¢ Timeout\n\n';
                    errorMsg += 'ğŸ’¡ Tipp: PrÃ¼fen Sie Ihre Internetverbindung und versuchen Sie es erneut.';
                } else {
                    errorMsg += `Details: ${error.message}\n\n`;
                    errorMsg += 'ğŸ’¡ Tipp: Bitte versuchen Sie es erneut oder kontaktieren Sie den Support.';
                }

                showToast(errorMsg, 'error', 10000);
                document.getElementById('sendBtn').textContent = 'Angebot erstellen & versenden';
                feather.replace();
            }
        }

        // ============================================
        // BUG #4 FIX: PDF RETRY FUNCTION
        // ============================================

        /**
         * Retry PDF Generation after previous failure
         * Clears error flags and retries generateAngebotPDF Cloud Function
         */
        async function retryPDFGeneration() {
            try {
                console.log('ğŸ”„ === PDF RETRY STARTED ===');

                const retryBtn = document.getElementById('pdfRetryBtn');
                const retryBtnText = document.getElementById('retryBtnText');

                // Disable button and show loading state
                retryBtn.disabled = true;
                retryBtnText.textContent = 'Wird generiert...';
                feather.replace();

                const werkstattId = window.werkstattId; // âœ… SECURITY FIX: No 'mosbach' fallback
                const collectionName = `partnerAnfragen_${werkstattId}`;

                if (!currentEntwurfId) {
                    throw new Error('Kein Entwurf ausgewÃ¤hlt');
                }

                // Step 1: Clear previous error flags in Firestore
                console.log('ğŸ§¹ Clearing error flags...');
                await window.db.collection(collectionName).doc(currentEntwurfId).update({
                    pdfGenerationFailed: firebase.firestore.FieldValue.delete(),
                    pdfGenerationError: firebase.firestore.FieldValue.delete(),
                    pdfGenerationFailedAt: firebase.firestore.FieldValue.delete()
                });

                // Step 2: Retry PDF generation
                console.log('ğŸ“„ Retrying PDF generation...');
                const generatePDF = window.functions.httpsCallable('generateAngebotPDF');
                const pdfResult = await generatePDF({
                    entwurfId: currentEntwurfId,
                    werkstattId: werkstattId
                });

                console.log('âœ… PDF retry successful:', pdfResult.data.filename);
                showToast('âœ… PDF erfolgreich generiert!', 'success', 3000);

                // Hide retry button
                retryBtn.style.display = 'none';

                // Reset button state
                retryBtn.disabled = false;
                retryBtnText.textContent = 'PDF erneut generieren';
                feather.replace();

            } catch (error) {
                console.error('âŒ PDF retry failed:', error);

                let errorMsg = 'âŒ PDF-Generierung fehlgeschlagen:\n\n';

                if (error.message.includes('PDF') || error.message.includes('generateAngebotPDF')) {
                    errorMsg += `${error.message}\n\n`;
                    errorMsg += 'ğŸ’¡ Tipp: PrÃ¼fen Sie die Kalkulations-Daten und versuchen Sie es erneut.';
                } else {
                    errorMsg += `${error.message}`;
                }

                showToast(errorMsg, 'error', 10000);

                // Re-enable button
                const retryBtn = document.getElementById('pdfRetryBtn');
                const retryBtnText = document.getElementById('retryBtnText');
                retryBtn.disabled = false;
                retryBtnText.textContent = 'PDF erneut generieren';
                feather.replace();
            }
        }

        // ============================================
        // PDF UPLOAD & PARSING
        // ============================================

        // PDF Upload Event Handler
        const datPdfInput = document.getElementById('datPdfInput');
        if (datPdfInput) {
            datPdfInput.addEventListener('change', handlePdfUpload);
        }

        async function handlePdfUpload(event) {
            const file = event.target.files[0];
            if (!file || file.type !== 'application/pdf') {
                showToast('âŒ Bitte wÃ¤hlen Sie eine PDF-Datei', 'error');
                return;
            }

            // UI Feedback
            document.getElementById('pdfFileName').textContent = file.name;
            document.getElementById('pdfRemoveBtn').style.display = 'inline-block';

            try {
                let pdfExtraction;

                try {
                    // PRIMARY: OpenAI GPT-4 Vision
                    console.log('ğŸ¤– [PRIMARY] Trying OpenAI GPT-4 Vision...');
                    showToast('â³ PDF wird analysiert mit AI...', 'info', 3000);
                    pdfExtraction = await parseWithOpenAI(file);
                    console.log('âœ… [PRIMARY] OpenAI parsing successful');
                } catch (openaiError) {
                    // FALLBACK: Regex-based parsing
                    console.warn('âš ï¸ [FALLBACK] OpenAI failed, using regex:', openaiError);
                    showToast('âš ï¸ AI-Parsing fehlgeschlagen, verwende Regex-Fallback...', 'warning', 3000);
                    pdfExtraction = await parseDatPdf(file);
                    pdfExtraction.source = 'pdf-regex';
                    console.log('âœ… [FALLBACK] Regex parsing completed');
                }

                // Store PDF data
                pdfData = pdfExtraction;

                // Fill form and tables
                fillFormFromPdf(pdfData);

                // Populate tables
                if (pdfData.ersatzteile) {
                    pdfData.ersatzteile.forEach(item => addErsatzteilRow(item));
                }
                if (pdfData.arbeitslohn) {
                    pdfData.arbeitslohn.forEach(item => addArbeitslohnRow(item));
                }
                if (pdfData.lackierung) {
                    pdfData.lackierung.forEach(item => addLackierungRow(item));
                }
                if (pdfData.materialien) {
                    pdfData.materialien.forEach(item => addMaterialienRow(item));
                }

                // ğŸ”§ FIX: Update Gesamtsumme nach PDF-Import
                updateKostenaufschluesselung();

                showToast('âœ… Fahrzeugdaten aus PDF Ã¼bernommen!', 'success');

            } catch (error) {
                console.error('âŒ PDF-Parsing Fehler:', error);
                showToast('Fehler beim Lesen der PDF. Bitte Daten manuell eingeben.', 'error');
                removePdf();
            }
        }

        async function parseWithOpenAI(pdfFile) {
            console.log('ğŸ¤– [OPENAI] Starte PDF-Parsing mit OpenAI GPT-4 Vision...');

            // Convert PDF to PNG images
            const pngImagesArray = await convertPdfToImage(pdfFile);

            // Call Cloud Function
            console.log('â˜ï¸ [OPENAI] Calling Cloud Function parseDATPDF...');
            const parseDATPDF = window.functions.httpsCallable('parseDATPDF');
            const result = await parseDATPDF({ imagesBase64: pngImagesArray });

            if (!result.data.success) {
                throw new Error('OpenAI Parsing fehlgeschlagen');
            }

            const extractedData = result.data.data;
            extractedData.source = 'openai';

            console.log('âœ… [OPENAI] Parsing erfolgreich:', extractedData);
            return extractedData;
        }

        async function convertPdfToImage(pdfFile) {
            console.log('ğŸ–¼ï¸ [PDFâ†’PNG] Converting PDF to PNG images...');

            const arrayBuffer = await pdfFile.arrayBuffer();
            const uint8Array = new Uint8Array(arrayBuffer);

            const loadingTask = pdfjsLib.getDocument({ data: uint8Array });
            const pdf = await loadingTask.promise;

            console.log(`ğŸ“„ [PDFâ†’PNG] PDF loaded: ${pdf.numPages} page(s)`);

            const pngImages = [];

            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                const page = await pdf.getPage(pageNum);
                const scale = 2.0;
                const viewport = page.getViewport({ scale });

                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = viewport.width;
                canvas.height = viewport.height;

                await page.render({ canvasContext: context, viewport: viewport }).promise;

                const pngDataUrl = canvas.toDataURL('image/png', 1.0);
                const pngBase64 = pngDataUrl.split(',')[1];

                pngImages.push(pngBase64);
            }

            console.log(`âœ… [PDFâ†’PNG] All ${pdf.numPages} pages converted`);
            return pngImages;
        }

        async function parseDatPdf(file) {
            console.log('ğŸ“„ [REGEX] Parsing PDF with regex fallback...');

            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

            let extractedData = {
                fahrzeugdaten: {},
                ersatzteile: [],
                arbeitslohn: [],
                lackierung: [],
                materialien: []
            };

            for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                const page = await pdf.getPage(pageNum);
                const textContent = await page.getTextContent();
                const text = textContent.items.map(item => item.str).join(' ');

                // Extract Fahrzeugdaten
                const hsnMatch = text.match(/HSN[\s:]+(\d+)/);
                const tsnMatch = text.match(/TSN[\s:]+([A-Z0-9]+)/);
                const vinMatch = text.match(/FIN[\s:]+([\dA-Z]{17})/);

                if (hsnMatch) extractedData.fahrzeugdaten.hsn = hsnMatch[1];
                if (tsnMatch) extractedData.fahrzeugdaten.tsn = tsnMatch[1];
                if (vinMatch) extractedData.fahrzeugdaten.vin = vinMatch[1];

                // Extract Ersatzteile (simplified regex)
                const ersatzteilRegex = /(\d{10})\s+([A-ZÃ„Ã–Ãœa-zÃ¤Ã¶Ã¼ÃŸ\s]+?)\s+(\d+)\s+([\d\.,]+)\s+([\d\.,]+)/g;
                let match;
                while ((match = ersatzteilRegex.exec(text)) !== null) {
                    extractedData.ersatzteile.push({
                        etn: match[1].trim(),
                        benennung: match[2].trim(),
                        anzahl: parseInt(match[3]),
                        einzelpreis: parseFloat(match[4].replace(',', '.')),
                        gesamtpreis: parseFloat(match[5].replace(',', '.'))
                    });
                }
            }

            console.log(`âœ… [REGEX] Extracted: ${extractedData.ersatzteile.length} Ersatzteile`);
            return extractedData;
        }

        function fillFormFromPdf(data) {
            console.log('ğŸ“ FÃ¼lle Formular mit PDF-Daten...');

            if (data.fahrzeugdaten) {
                if (data.fahrzeugdaten.vin) {
                    const vinInput = document.getElementById('vin');
                    if (vinInput) vinInput.value = data.fahrzeugdaten.vin;
                }
                if (data.fahrzeugdaten.marke) {
                    const markeInput = document.getElementById('marke');
                    if (markeInput) markeInput.value = data.fahrzeugdaten.marke;
                }
                if (data.fahrzeugdaten.modell) {
                    const modellInput = document.getElementById('modell');
                    if (modellInput) modellInput.value = data.fahrzeugdaten.modell;
                }
            }

            console.log('âœ… Formular ausgefÃ¼llt');
        }

        function removePdf() {
            // Clear PDF input
            const datPdfInput = document.getElementById('datPdfInput');
            if (datPdfInput) datPdfInput.value = '';

            // Hide remove button
            document.getElementById('pdfRemoveBtn').style.display = 'none';

            // Clear filename
            document.getElementById('pdfFileName').textContent = '';

            // Clear stored data
            pdfData = null;

            console.log('ğŸ—‘ï¸ PDF removed');
            showToast('PDF entfernt', 'info', 2000);
        }

        // ============================================
        // FOTO-UPLOAD
        // ============================================

        const photoInput = document.getElementById('photoInput');
        const photoGrid = document.getElementById('photoGrid');

        if (photoInput) {
            photoInput.addEventListener('change', handlePhotoUpload);
        }

        async function handlePhotoUpload(e) {
            const files = Array.from(e.target.files);

            // Validate file sizes
            for (const file of files) {
                if (file.size > 5 * 1024 * 1024) {
                    showToast(`Foto "${file.name}" ist zu groÃŸ (${(file.size / 1024 / 1024).toFixed(1)} MB)! Max. 5 MB pro Foto.`, 'error', 5000);
                    e.target.value = '';
                    return;
                }
            }

            // Check total photo limit
            if (photos.length + files.length > 10) {
                showToast('Maximal 10 Fotos erlaubt!', 'error', 3000);
                e.target.value = '';
                return;
            }

            // âœ… NEW: Upload files to Firebase Storage instead of Base64
            const werkstattId = window.werkstattId; // âœ… SECURITY FIX: No 'mosbach' fallback
            const entwurfId = currentEntwurfId || `temp_${Date.now()}`;

            showToast('ğŸ“¤ Fotos werden hochgeladen...', 'info', 2000);

            for (const file of files) {
                try {
                    // Create unique filename
                    const timestamp = Date.now();
                    const sanitizedFilename = file.name.replace(/[^a-zA-Z0-9._-]/g, '_');
                    const storagePath = `entwuerfe/${werkstattId}/${entwurfId}/photo_${timestamp}_${sanitizedFilename}`;

                    // Upload to Firebase Storage
                    const storage = firebase.storage();
                    const storageRef = storage.ref(storagePath);
                    const uploadTask = await storageRef.put(file);

                    // Get download URL
                    const downloadURL = await uploadTask.ref.getDownloadURL();

                    // Store URL instead of Base64
                    photos.push(downloadURL);
                    console.log(`âœ… Foto hochgeladen: ${storagePath}`);

                } catch (error) {
                    console.error('âŒ Fehler beim Foto-Upload:', error);
                    showToast(`Fehler beim Upload von "${file.name}": ${error.message}`, 'error', 5000);
                }
            }

            updatePhotoGrid();
            showToast(`âœ… ${files.length} Foto(s) hochgeladen!`, 'success', 3000);
            e.target.value = '';
        }

        function updatePhotoGrid() {
            photoGrid.innerHTML = '';

            // Display existing photos
            photos.forEach((photo, index) => {
                const div = document.createElement('div');
                div.className = 'photo-item';
                div.innerHTML = `
                    <img src="${photo}" alt="Foto ${index + 1}">
                    <button class="remove-photo" onclick="removePhoto(${index})">Ã—</button>
                `;
                photoGrid.appendChild(div);
            });

            // Add "Add Photo" button (if < 10 photos)
            if (photos.length < 10) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'photo-item empty';
                emptyDiv.onclick = () => photoInput.click();
                emptyDiv.innerHTML = `
                    <i data-feather="camera"></i>
                    <span>Foto hinzufÃ¼gen</span>
                `;
                photoGrid.appendChild(emptyDiv);
            }

            feather.replace();
            console.log(`ğŸ“¸ ${photos.length} Fotos geladen`);
        }

        async function removePhoto(index) {
            const photoUrl = photos[index];

            // If it's a Storage URL (not Base64), delete from Storage
            if (photoUrl && photoUrl.startsWith('https://firebasestorage.googleapis.com')) {
                try {
                    const storage = firebase.storage();
                    const photoRef = storage.refFromURL(photoUrl);
                    await photoRef.delete();
                    console.log(`âœ… Foto aus Storage gelÃ¶scht: ${photoRef.fullPath}`);
                } catch (error) {
                    // Ignore errors (file might already be deleted or not exist)
                    console.warn('âš ï¸ Konnte Foto nicht aus Storage lÃ¶schen:', error.message);
                }
            }

            photos.splice(index, 1);
            updatePhotoGrid();
            showToast('Foto entfernt', 'info', 2000);
        }

        // ğŸ†• Design-Galerie rendern (fÃ¼r Folierung/Werbebeklebung aus kalkulation.html)
        function renderDesignGallery(designUrls) {
            const section = document.getElementById('designGallerySection');
            const gallery = document.getElementById('designGallery');

            if (!section || !gallery) return;

            // Alle Designs sammeln
            let allDesigns = [];
            for (const [fieldId, files] of Object.entries(designUrls)) {
                if (Array.isArray(files)) {
                    files.forEach(f => allDesigns.push({ ...f, fieldId }));
                }
            }

            // Keine Designs vorhanden â†’ ausblenden
            if (allDesigns.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';

            gallery.innerHTML = allDesigns.map(file => {
                const isImage = file.type?.startsWith('image/');
                const imgSrc = file.url || file.base64 || '';

                return `
                    <div class="photo-item" style="cursor: ${isImage ? 'pointer' : 'default'};"
                         ${isImage ? `onclick="openDesignLightbox('${imgSrc}')"` : ''}>
                        ${isImage
                            ? `<img src="${imgSrc}" alt="${file.name || 'Design'}">`
                            : `<div style="display: flex; align-items: center; justify-content: center; height: 100%; font-size: 2rem;">${getDesignFileIcon(file.type)}</div>`
                        }
                    </div>
                `;
            }).join('');

            console.log(`ğŸ¨ ${allDesigns.length} Design(s) in Galerie angezeigt`);
        }

        // Helper: Datei-Icon fÃ¼r Designs
        function getDesignFileIcon(mimeType) {
            if (!mimeType) return 'ğŸ“';
            if (mimeType.includes('pdf')) return 'ğŸ“„';
            if (mimeType.includes('illustrator') || mimeType.includes('ai')) return 'ğŸ¨';
            if (mimeType.includes('photoshop') || mimeType.includes('psd')) return 'ğŸ–¼ï¸';
            if (mimeType.includes('svg')) return 'âœï¸';
            return 'ğŸ“';
        }

        // Design-Lightbox Ã¶ffnen
        function openDesignLightbox(imgSrc) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                cursor: pointer;
            `;
            modal.innerHTML = `<img src="${imgSrc}" style="max-width: 90%; max-height: 90%; object-fit: contain; border-radius: 8px;">`;
            modal.addEventListener('click', () => modal.remove());
            document.body.appendChild(modal);
        }

        // ============================================
        // HELPER FUNCTIONS
        // ============================================

        function showToast(message, type = 'info', duration = 3000) {
            // Check if toast container exists
            let toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                toastContainer.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px;';
                document.body.appendChild(toastContainer);
            }

            // Create toast
            const toast = document.createElement('div');
            toast.style.cssText = `
                background: ${type === 'success' ? 'var(--color-success)' : type === 'error' ? 'var(--color-error)' : 'var(--color-primary)'};
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                font-weight: 500;
                max-width: 400px;
                animation: slideInRight 0.3s ease-out;
            `;
            toast.textContent = message;

            toastContainer.appendChild(toast);

            // Auto-remove
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // Add animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from {
                    opacity: 0;
                    transform: translateX(100px);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }
            @keyframes slideOutRight {
                from {
                    opacity: 1;
                    transform: translateX(0);
                }
                to {
                    opacity: 0;
                    transform: translateX(100px);
                }
            }
        `;
        document.head.appendChild(style);

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // âš ï¸ ABGELAUFENE LEIHFAHRZEUG-ANFRAGEN
        // Anfragen, deren Leihfahrzeug-Reservierung nach 48h abgelaufen ist
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        async function loadAbgelaufeneAnfragen() {
            try {
                console.log('ğŸ”„ Lade abgelaufene Leihfahrzeug-Anfragen...');

                const snapshot = await window.getCollection('anfragen')
                    .where('status', '==', 'leihfahrzeug_abgelaufen')
                    .get();

                const abgelaufeneSection = document.getElementById('abgelaufeneSection');
                const abgelaufeneList = document.getElementById('abgelaufeneList');

                if (snapshot.empty) {
                    abgelaufeneSection.style.display = 'none';
                    console.log('âœ… Keine abgelaufenen Leihfahrzeug-Anfragen');
                    return;
                }

                const abgelaufene = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log(`ğŸ“‹ ${abgelaufene.length} abgelaufene Anfragen gefunden`);

                // Render cards
                abgelaufeneList.innerHTML = abgelaufene.map(anfrage => {
                    const abgelaufenAm = anfrage.leihfahrzeugAbgelaufenAm?.toDate
                        ? anfrage.leihfahrzeugAbgelaufenAm.toDate().toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })
                        : 'Unbekannt';

                    const leihfahrzeug = anfrage.vorherigeLeitfahrzeugDetails ||
                                        anfrage.kva?.zugewiesenesLeihfahrzeug ||
                                        anfrage.kalkulationData?.ersatzfahrzeug;

                    return `
                        <div class="abgelaufen-card" style="background: var(--card-bg); border: 1px solid var(--border); border-left: 4px solid #f59e0b; border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                <div>
                                    <h3 style="margin: 0; color: var(--text-primary);">
                                        ğŸš— ${anfrage.kennzeichen || 'Kein Kennzeichen'}
                                    </h3>
                                    <p style="color: var(--text-secondary); margin: 4px 0 0 0;">
                                        ${anfrage.kundenname || 'Unbekannter Kunde'}
                                        ${anfrage.marke ? ` - ${anfrage.marke} ${anfrage.modell || ''}` : ''}
                                    </p>
                                </div>
                                <span style="background: #fef3c7; color: #b45309; padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 500;">
                                    âš ï¸ Reservierung abgelaufen
                                </span>
                            </div>

                            <div style="background: var(--bg-secondary); padding: 12px; border-radius: 8px; margin-bottom: 16px;">
                                <p style="margin: 0 0 8px 0; color: #b45309; font-size: 14px;">
                                    <strong>â° Abgelaufen am:</strong> ${abgelaufenAm}
                                </p>
                                ${leihfahrzeug ? `
                                <p style="margin: 0; color: var(--text-secondary); font-size: 14px;">
                                    <strong>ğŸš™ Ehem. Leihfahrzeug:</strong> ${leihfahrzeug.kennzeichen || 'Unbekannt'}
                                    ${leihfahrzeug.marke ? ` (${leihfahrzeug.marke} ${leihfahrzeug.modell || ''})` : ''}
                                </p>
                                ` : ''}
                            </div>

                            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                <button class="btn btn-primary" onclick="reaktivierenAnfrage('${anfrage.id}')" style="display: flex; align-items: center; gap: 6px;">
                                    <i data-feather="refresh-cw" style="width: 16px; height: 16px;"></i>
                                    Reaktivieren (neues Leihfahrzeug)
                                </button>
                                <button class="btn btn-secondary" onclick="stornierenAnfrage('${anfrage.id}')" style="display: flex; align-items: center; gap: 6px; color: #ef4444;">
                                    <i data-feather="x-circle" style="width: 16px; height: 16px;"></i>
                                    Stornieren
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');

                abgelaufeneSection.style.display = 'block';

                // Refresh feather icons
                if (typeof feather !== 'undefined') feather.replace();

            } catch (error) {
                console.error('âŒ Fehler beim Laden abgelaufener Anfragen:', error);
            }
        }

        async function reaktivierenAnfrage(anfrageId) {
            if (!confirm('Anfrage reaktivieren?\n\nDie Anfrage wird zurÃ¼ck zur KVA-Erstellung gesetzt, damit ein neues Leihfahrzeug zugewiesen werden kann.')) {
                return;
            }

            try {
                console.log('ğŸ”„ Reaktiviere Anfrage:', anfrageId);

                await window.getCollection('anfragen').doc(anfrageId).update({
                    status: 'kva_erstellen',
                    reaktiviertAm: firebase.firestore.FieldValue.serverTimestamp(),
                    reaktiviertVon: window.currentUser?.name || 'Unbekannt',
                    // Leihfahrzeug-Felder zurÃ¼cksetzen
                    'kva.zugewiesenesLeihfahrzeug': null,
                    'kalkulationData.ersatzfahrzeug': null
                });

                showToast('âœ… Anfrage reaktiviert! Sie kÃ¶nnen jetzt ein neues Leihfahrzeug zuweisen.', 'success', 4000);

                // Redirect zur Kalkulation-Seite
                setTimeout(() => {
                    safeNavigate(`kalkulation.html?id=${anfrageId}`);
                }, 1500);

            } catch (error) {
                console.error('âŒ Fehler beim Reaktivieren:', error);
                showToast('âŒ Fehler beim Reaktivieren der Anfrage', 'error', 5000);
            }
        }

        async function stornierenAnfrage(anfrageId) {
            if (!confirm('Anfrage wirklich stornieren?\n\nDiese Aktion kann nicht rÃ¼ckgÃ¤ngig gemacht werden.')) {
                return;
            }

            try {
                console.log('âŒ Storniere Anfrage:', anfrageId);

                await window.getCollection('anfragen').doc(anfrageId).update({
                    status: 'storniert',
                    storniertAm: firebase.firestore.FieldValue.serverTimestamp(),
                    storniertVon: window.currentUser?.name || 'Unbekannt',
                    stornierungsgrund: 'Leihfahrzeug-Reservierung abgelaufen, nicht reaktiviert'
                });

                showToast('âœ… Anfrage storniert', 'success', 3000);

                // Liste aktualisieren
                await loadAbgelaufeneAnfragen();

            } catch (error) {
                console.error('âŒ Fehler beim Stornieren:', error);
                showToast('âŒ Fehler beim Stornieren der Anfrage', 'error', 5000);
            }
        }
    </script>

    <!-- ğŸŒ“ THEME TOGGLE SCRIPT -->
    <script>
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            if (typeof feather !== 'undefined') feather.replace();
        }
    </script>
</body>
</html>
