<!DOCTYPE html>
<html lang="de">
<head>
    <!-- Bug #5 Fix: Early werkstattId initialization -->
    <script>
        window.werkstattId = 'mosbach';
        console.log('‚úÖ werkstattId set early:', window.werkstattId);
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fahrzeug-√úbersicht | Auto-Lackierzentrum Mosbach</title>

    <!-- Aggressive No-Cache Headers (Cache-Fix f√ºr v=a4192c4) -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

    <!-- Firebase Config -->
    <script src="firebase-config.js?v=8652b32"></script>

    <!-- Error Handler & Toast Notifications -->
    <script src="error-handler.js"></script>

    <!-- Listener Registry - Memory Leak Prevention -->
    <script src="listener-registry.js"></script>

    <!-- Auth Manager f√ºr Multi-Tenant Support -->
    <script src="js/auth-manager.js"></script>

    <!-- Event System f√ºr Real-Time Updates (Phase 3) -->
    <script src="js/app-events.js"></script>

    <!-- Design System -->
    <link rel="stylesheet" href="design-system.css?v=af6b90f">
    <link rel="stylesheet" href="components.css?v=af6b90f">
    <link rel="stylesheet" href="animations.css?v=af6b90f">
    <link rel="stylesheet" href="mobile-first.css?v=af6b90f">
    <link rel="stylesheet" href="css/ai-chat-widget.css">

    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>

    <!-- GSAP Animation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <style>
        /* ============================================
           DARK GLASS - LISTE.HTML
           Auto-Lackierzentrum Mosbach
           Version: 1.0 Dark Mode
           ============================================ */

        /* ===== BODY - LIGHT MODE (Default) ===== */
        body {
            font-family: 'SF Pro Display', 'Inter', var(--font-system); /* ‚úÖ Konsistent mit index.html */
            /* üé® Light Mode - Heller Gradient */
            background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            color: rgba(0, 0, 0, 0.9); /* Dark Text for Light Mode */
            overflow-x: hidden;
            position: relative;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* ===== BODY - DARK MODE ===== */
        [data-theme="dark"] body {
            /* üé® RADIAL GRADIENT (OLED-optimiert) + Aurora Animation */
            background-image:
                radial-gradient(
                    ellipse at 20% 20%,
                    rgba(0, 191, 255, 0.08) 0%,
                    transparent 50%
                ),
                var(--gradient-dark-bg);
            background-size: 200% 200%, 100% 100%;
            animation: aurora-shift 30s ease-in-out infinite;
            color: var(--color-text-primary);
        }

        @keyframes aurora-shift {
            0% { background-position: 0% 0%, 0% 0%; }
            50% { background-position: 100% 100%, 0% 0%; }
            100% { background-position: 0% 0%, 0% 0%; }
        }

        /* ACCENT-LIGHT - THEME-AWARE (‚úÖ Konsistent mit index.html) */
        .accent-light {
            content: '';
            position: fixed;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            /* ‚úÖ THEME-AWARE: Golden Glow (Light) / Cyan Glow (Dark) */
            background: radial-gradient(circle, var(--accent-light-color) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
            animation: pulse 8s ease-in-out infinite;
            /* GPU-Acceleration f√ºr smooth Parallax */
            transform: translate3d(0, 0, 0);
            will-change: transform;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }  /* ‚úÖ Konsistent mit index.html */
            50% { opacity: 0.8; }
        }

        /* ============================================
           üé® PAGE TRANSITION OVERLAY (‚úÖ Konsistent mit index.html)
           Blur-Overlay beim Seitenwechsel
           ============================================ */
        .page-transition-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: rgba(11, 11, 12, 0.4);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-out;
        }

        .page-transition-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        /* ============================================
           üåô THEME TOGGLE BUTTON (‚úÖ Konsistent mit index.html)
           Fixed Position - Dual-Icon System - Fancy Animations
           ============================================ */
        .theme-toggle {
            position: fixed;
            top: var(--space-4);
            right: var(--space-4);
            z-index: 10000; /* Above everything */
            width: 56px;
            height: 56px;
            border-radius: var(--radius-full);
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            box-shadow: var(--shadow-lg), inset 0 1px 1px rgba(255,255,255,0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            border: none;
        }

        .theme-toggle:hover {
            transform: scale(1.1) rotate(15deg);  /* ‚úÖ Fancy Animation! */
            box-shadow: var(--shadow-xl), inset 0 1px 1px rgba(255,255,255,0.2);
        }

        .theme-toggle:active {
            transform: scale(0.95);
        }

        .theme-toggle__icon {
            position: absolute;
            width: 24px;
            height: 24px;
            color: var(--color-text-primary);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        /* Show sun icon in dark mode, moon in light mode */
        [data-theme="dark"] .theme-toggle__icon--light {
            opacity: 1;
            transform: rotate(0deg) scale(1);
        }

        [data-theme="dark"] .theme-toggle__icon--dark {
            opacity: 0;
            transform: rotate(180deg) scale(0);
        }

        :root .theme-toggle__icon--light,
        [data-theme="light"] .theme-toggle__icon--light {
            opacity: 0;
            transform: rotate(-180deg) scale(0);
        }

        :root .theme-toggle__icon--dark,
        [data-theme="light"] .theme-toggle__icon--dark {
            opacity: 1;
            transform: rotate(0deg) scale(1);
        }

        /* Mobile: Smaller toggle button */
        @media (max-width: 768px) {
            .theme-toggle {
                width: 48px;
                height: 48px;
                top: var(--space-3);
                right: var(--space-3);
            }

            .theme-toggle__icon {
                width: 20px;
                height: 20px;
            }
        }

        /* MAIN CONTAINER */
        .main-container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-6);
            padding-bottom: 100px; /* Space for bottom nav */
        }

        /* HERO HEADER - Glass Container */
        .hero-header {
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-lg), inset 0 1px 1px rgba(255,255,255,0.15);
            padding: var(--space-8);
            margin-bottom: var(--space-6);
            text-align: center;
        }

        .hero-header__icon {
            width: 80px;
            height: 80px;
            background: rgba(0, 191, 255, 0.15);
            border-radius: var(--radius-2xl);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto var(--space-4);
            border: 1px solid rgba(0, 191, 255, 0.3);
        }

        .hero-header__icon i {
            color: var(--color-primary);
            width: 48px;
            height: 48px;
        }

        .hero-header h1 {
            font-size: clamp(24px, 5vw, 36px);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin-bottom: var(--space-2);
            letter-spacing: -0.02em;
        }

        .hero-header p {
            font-size: var(--font-size-base);
            color: var(--color-text-secondary);
            margin: 0;
        }

        /* STATS DASHBOARD - Glass Cards */
        .stats-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }

        .stat-card {
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md), inset 0 1px 1px rgba(255,255,255,0.1);
            padding: var(--space-5);
            text-align: center;
            transition: all var(--duration-base) var(--ease-out);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--color-border);
        }

        .stat-card__icon {
            width: 48px;
            height: 48px;
            margin: 0 auto var(--space-3);
            background: rgba(0, 191, 255, 0.1);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-card__icon i {
            color: var(--color-primary);
            width: 24px;
            height: 24px;
        }

        .stat-card__value {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
            margin-bottom: var(--space-1);
            line-height: 1;
        }

        .stat-card__label {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
            font-weight: var(--font-weight-semibold);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* SEARCH & FILTER SECTION - Glass Container */
        .search-filter-section {
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md), inset 0 1px 1px rgba(255,255,255,0.1);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
        }

        .search-filter-section h3 {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin-bottom: var(--space-4);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .search-filter-section h3 i {
            width: 20px;
            height: 20px;
            color: var(--color-primary);
        }

        /* SEARCH BOX - Glass Input */
        .search-box {
            margin-bottom: var(--space-4);
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: var(--space-3) var(--space-4) var(--space-3) var(--space-10);
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            font-size: var(--font-size-base);
            color: var(--color-text-primary);
            font-family: var(--font-system);
            transition: all var(--duration-base) var(--ease-out);
        }

        .search-box input::placeholder {
            color: var(--color-text-tertiary);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(0, 191, 255, 0.1);
            background: rgba(255, 255, 255, 0.08);
        }

        .search-box i {
            position: absolute;
            left: var(--space-4);
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-text-tertiary);
            width: 20px;
            height: 20px;
            pointer-events: none;
        }

        /* FILTER BUTTONS - Glass Pills */
        .filter-group {
            margin-bottom: var(--space-3);
        }

        .filter-group__label {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-secondary);
            margin-bottom: var(--space-2);
            display: block;
        }

        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-2);
        }

        .filter-btn {
            padding: var(--space-2) var(--space-4);
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid var(--color-border);
            color: var(--color-text-primary);
            border-radius: var(--radius-full);
            cursor: pointer;
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            font-family: var(--font-system);
            transition: all var(--duration-base) var(--ease-out);
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
        }

        .filter-btn i {
            width: 16px;
            height: 16px;
        }

        .filter-btn:hover {
            border-color: var(--color-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
            background: rgba(255, 255, 255, 0.08);
        }

        .filter-btn.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
            box-shadow: 0 0 20px rgba(0, 191, 255, 0.3);
        }

        /* TABLE SECTION - Glass Container */
        .table-section {
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg), inset 0 1px 1px rgba(255,255,255,0.1);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
            overflow: hidden;
        }

        .table-section h3 {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin-bottom: var(--space-4);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .table-section h3 i {
            width: 20px;
            height: 20px;
            color: var(--color-primary);
        }

        /* TABLE WRAPPER - Scrollable */
        .table-wrapper {
            overflow-x: auto;
            border-radius: var(--radius-lg);
            background: rgba(255, 255, 255, 0.02);
        }

        .table-wrapper::-webkit-scrollbar {
            height: 8px;
        }

        .table-wrapper::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-full);
        }

        .table-wrapper::-webkit-scrollbar-thumb {
            background: var(--color-primary);
            border-radius: var(--radius-full);
        }

        .table-wrapper::-webkit-scrollbar-thumb:hover {
            background: var(--color-primary-hover);
        }

        /* TABLE */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--font-size-sm);
        }

        table thead {
            background: rgba(0, 191, 255, 0.15);
            border-bottom: 1px solid var(--color-border);
        }

        table th {
            padding: var(--space-4);
            text-align: left;
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            cursor: pointer;
            user-select: none;
            transition: all var(--duration-base) var(--ease-out);
            white-space: nowrap;
            position: relative;
        }

        table th:hover {
            background: rgba(0, 191, 255, 0.25);
        }

        table th.sortable::after {
            content: ' ‚óÜ';
            font-size: 10px;
            opacity: 0.4;
            margin-left: var(--space-1);
            color: var(--color-text-tertiary);
        }

        table th.sortable.asc::after {
            content: ' ‚ñ≤';
            opacity: 1;
            color: var(--color-primary);
        }

        table th.sortable.desc::after {
            content: ' ‚ñº';
            opacity: 1;
            color: var(--color-primary);
        }

        table tbody tr {
            border-bottom: 1px solid var(--color-border-light);
            transition: all var(--duration-base) var(--ease-out);
        }

        table tbody tr:hover {
            background: rgba(0, 191, 255, 0.05);
            transform: scale(1.002);
        }

        table tbody tr:last-child {
            border-bottom: none;
        }

        table td {
            padding: var(--space-4);
            color: var(--color-text-primary);
            vertical-align: middle;
        }

        /* STATUS BADGES - With Icons */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            white-space: nowrap;
        }

        .status-badge i {
            width: 14px;
            height: 14px;
        }

        /* Status: Neu/Wartend - Gray */
        .status-neu,
        .status-angenommen,
        .status-terminiert {
            background: rgba(142, 142, 147, 0.2);
            color: var(--color-text-secondary);
            border: 1px solid rgba(142, 142, 147, 0.3);
        }

        /* Status: In Arbeit - Blue */
        .status-vorbereitung,
        .status-lackierung,
        .status-in_arbeit,
        .status-bestellung,
        .status-angekommen,
        .status-montage,
        .status-wuchten,
        .status-diagnose,
        .status-pruefung,
        .status-in_pruefung,
        .status-angebot,
        .status-beauftragt,
        .status-reparatur,
        .status-in_reparatur,
        .status-test,
        .status-termin,
        .status-termin_bestaetigt,
        .status-termin_gebucht,
        .status-aufbereitung,
        .status-trocknung {
            background: rgba(0, 191, 255, 0.2);
            color: var(--color-primary);
            border: 1px solid rgba(0, 191, 255, 0.3);
        }

        /* Status: Bereit/Fertig - Green */
        .status-bereit,
        .status-fertig,
        .status-abholbereit,
        .status-abgeschlossen,
        .status-freigabe {
            background: rgba(50, 215, 75, 0.2);
            color: var(--color-success);
            border: 1px solid rgba(50, 215, 75, 0.3);
        }

        /* Status: Qualit√§tskontrolle - Orange */
        .status-qualitaetskontrolle,
        .status-qualitaet,
        .status-gutachten {
            background: rgba(255, 149, 0, 0.2);
            color: var(--color-warning);
            border: 1px solid rgba(255, 149, 0, 0.3);
        }

        /* ACTION BUTTONS - With Icons */
        .action-buttons {
            display: flex;
            gap: var(--space-2);
        }

        .btn-action {
            padding: var(--space-2) var(--space-3);
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
            transition: all var(--duration-base) var(--ease-out);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            min-width: 80px;
            justify-content: center;
        }

        .btn-action i {
            width: 14px;
            height: 14px;
        }

        .btn-view {
            background: rgba(0, 191, 255, 0.15);
            color: var(--color-primary);
            border: 1px solid rgba(0, 191, 255, 0.3);
        }

        .btn-view:hover {
            background: rgba(0, 191, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .btn-edit {
            background: rgba(255, 149, 0, 0.15);
            color: var(--color-warning);
            border: 1px solid rgba(255, 149, 0, 0.3);
        }

        .btn-edit:hover {
            background: rgba(255, 149, 0, 0.3);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .btn-delete {
            background: rgba(255, 59, 48, 0.15);
            color: var(--color-error);
            border: 1px solid rgba(255, 59, 48, 0.3);
        }

        .btn-delete:hover {
            background: rgba(255, 59, 48, 0.3);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        /* PAGINATION - Glass Container */
        .pagination-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-4);
            margin-top: var(--space-6);
            padding: var(--space-4);
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            flex-wrap: wrap;
        }

        .pagination-info {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            font-weight: var(--font-weight-medium);
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .pagination-btn {
            padding: var(--space-2) var(--space-4);
            background: rgba(0, 191, 255, 0.15);
            color: var(--color-primary);
            border: 1px solid rgba(0, 191, 255, 0.3);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            transition: all var(--duration-base) var(--ease-out);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
        }

        .pagination-btn i {
            width: 16px;
            height: 16px;
        }

        .pagination-btn:hover:not(:disabled) {
            background: rgba(0, 191, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .pagination-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .pagination-current {
            padding: var(--space-2) var(--space-4);
            background: var(--color-primary);
            color: white;
            border-radius: var(--radius-md);
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-sm);
        }

        .pagination-select {
            padding: var(--space-2) var(--space-3);
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-primary);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            cursor: pointer;
            transition: all var(--duration-base) var(--ease-out);
        }

        .pagination-select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(0, 191, 255, 0.1);
        }

        /* MODAL - Dark Glass Overlay */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: var(--z-modal);
            background: rgba(11, 11, 12, 0.8);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            align-items: center;
            justify-content: center;
            padding: var(--space-6);
            animation: fadeIn 0.3s ease-out;
        }

        .modal.show {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--color-surface-elevated);
            backdrop-filter: blur(var(--glass-blur-strong)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur-strong)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-2xl);
            padding: var(--space-8);
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-6);
            padding-bottom: var(--space-4);
            border-bottom: 1px solid var(--color-border);
        }

        .modal-header h2 {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .modal-header h2 i {
            width: 28px;
            height: 28px;
            color: var(--color-primary);
        }

        .close-btn {
            background: rgba(255, 59, 48, 0.15);
            border: 1px solid rgba(255, 59, 48, 0.3);
            color: var(--color-error);
            border-radius: var(--radius-full);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            line-height: 1;
            transition: all var(--duration-base) var(--ease-out);
        }

        .close-btn:hover {
            background: rgba(255, 59, 48, 0.3);
            transform: scale(1.1);
        }

        .detail-row {
            margin-bottom: var(--space-4);
            padding: var(--space-3);
            background: rgba(255, 255, 255, 0.02);
            border-radius: var(--radius-md);
            border: 1px solid var(--color-border-light);
        }

        .detail-row strong {
            display: block;
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-secondary);
            margin-bottom: var(--space-1);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .detail-row span {
            font-size: var(--font-size-base);
            color: var(--color-text-primary);
        }

        .photo-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: var(--space-3);
            margin-top: var(--space-2);
        }

        .photo-gallery img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
            cursor: pointer;
            transition: all var(--duration-base) var(--ease-out);
        }

        .photo-gallery img:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-lg);
        }

        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: var(--space-16) var(--space-8);
            color: var(--color-text-tertiary);
        }

        .empty-state i {
            width: 64px;
            height: 64px;
            color: var(--color-text-tertiary);
            margin-bottom: var(--space-4);
        }

        .empty-state h3 {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-secondary);
            margin-bottom: var(--space-2);
        }

        .empty-state p {
            font-size: var(--font-size-base);
            color: var(--color-text-tertiary);
        }

        /* BOTTOM NAVIGATION - Glass */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: var(--z-fixed);
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur-strong)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur-strong)) saturate(var(--glass-saturation));
            border-top: 1px solid var(--color-border-glass);
            box-shadow: 0 -4px 24px rgba(0,0,0,0.3);
            padding: var(--space-2) 0;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .bottom-nav__item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-2) var(--space-3);
            color: var(--color-text-secondary);
            text-decoration: none;
            transition: all var(--duration-base) var(--ease-out);
            border-radius: var(--radius-md);
            min-width: 70px;
        }

        .bottom-nav__item i {
            width: 24px;
            height: 24px;
        }

        .bottom-nav__item span {
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
        }

        .bottom-nav__item:hover {
            color: var(--color-text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .bottom-nav__item.active {
            color: var(--color-primary);
            background: rgba(0, 191, 255, 0.1);
        }

        /* ============================================
           LIGHT MODE OVERRIDES - Glassmorphismus Deaktivieren
           ‚úÖ KONSISTENT MIT index.html
           ============================================ */

        /* ‚úÖ GLASSMORPHISMUS F√úR LIGHT MODE DEAKTIVIEREN */
        [data-theme="light"] .hero-header,
        [data-theme="light"] .stat-card,
        [data-theme="light"] .search-filter-section,
        [data-theme="light"] .table-section,
        [data-theme="light"] .bottom-nav {
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            background: rgba(255, 255, 255, 1.0) !important; /* ‚úÖ KOMPLETT OPAK! */
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.12) !important; /* Schatten f√ºr Tiefe */
        }

        /* Hero Header - Stronger Text + Text-Shadow */
        [data-theme="light"] .hero-header h1 {
            color: #000000;
            font-weight: var(--font-weight-semibold);
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
        }

        [data-theme="light"] .hero-header p {
            color: rgba(0, 0, 0, 0.75);
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.3);
        }

        [data-theme="light"] .hero-header__icon i {
            color: rgba(0, 0, 0, 0.85);
            stroke-width: 2.5;
        }

        /* Stat Cards - Darker Icons + Stronger Text */
        [data-theme="light"] .stat-card__icon i {
            color: rgba(0, 0, 0, 0.85);
            stroke-width: 2.5;
        }

        [data-theme="light"] .stat-card__value {
            color: var(--color-primary);
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
        }

        [data-theme="light"] .stat-card__label {
            color: rgba(0, 0, 0, 0.65);
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.3);
        }

        /* Search & Filter Section - Stronger Text */
        [data-theme="light"] .search-filter-section h3 {
            color: #000000;
            font-weight: var(--font-weight-semibold);
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
        }

        [data-theme="light"] .search-filter-section h3 i {
            color: rgba(0, 0, 0, 0.85);
            stroke-width: 2.5;
        }

        /* Table Section - Stronger Text */
        [data-theme="light"] .table-section h3 {
            color: #000000;
            font-weight: var(--font-weight-semibold);
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
        }

        [data-theme="light"] table th {
            color: #000000;
            font-weight: var(--font-weight-semibold);
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.3);
        }

        [data-theme="light"] table td {
            color: rgba(0, 0, 0, 0.85);
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.2);
        }

        /* Status Badges - Colored Backgrounds for Light Mode */
        [data-theme="light"] .status-badge.status-pending {
            background: rgba(255, 149, 0, 0.15);
            color: #8c5700;
            border-color: rgba(255, 149, 0, 0.4);
            font-weight: var(--font-weight-semibold);
        }

        [data-theme="light"] .status-badge.status-in-process {
            background: rgba(0, 122, 255, 0.15);
            color: #0051a0;
            border-color: rgba(0, 122, 255, 0.4);
            font-weight: var(--font-weight-semibold);
        }

        [data-theme="light"] .status-badge.status-completed {
            background: rgba(52, 199, 89, 0.15);
            color: #1b7e34;
            border-color: rgba(52, 199, 89, 0.4);
            font-weight: var(--font-weight-semibold);
        }

        /* Bottom Nav - Stronger Text + Opaque */
        [data-theme="light"] .bottom-nav {
            background: rgba(255, 255, 255, 1.0) !important;
            box-shadow: 0 -2px 12px rgba(0, 0, 0, 0.12) !important;
        }

        [data-theme="light"] .bottom-nav__item {
            color: rgba(0, 0, 0, 0.75);
        }

        [data-theme="light"] .bottom-nav__item.active {
            color: var(--color-primary);
            font-weight: var(--font-weight-semibold);
            background: rgba(0, 122, 255, 0.12);
        }

        [data-theme="light"] .bottom-nav__item.active i {
            stroke-width: 2.5;
        }

        [data-theme="light"] .bottom-nav__label {
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.5);
        }

        /* ============================================
           DARK MODE OVERRIDES - Glass + Text-Readability
           ============================================ */

        /* Table Headers - Dark Mode mit Text-Readability Fixes */
        [data-theme="dark"] table th {
            color: rgba(255, 255, 255, 1.0); /* ‚úÖ Pure White */
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.8),
                         0 0 16px rgba(255, 255, 255, 0.4);
        }

        /* Table Cells - Dark Mode mit Text-Readability Fixes */
        [data-theme="dark"] table td {
            color: rgba(255, 255, 255, 1.0); /* ‚úÖ Pure White */
            text-shadow: 0 0 6px rgba(255, 255, 255, 0.6);
        }

        /* Status Badges - Dark Mode mit Solid Backgrounds */
        [data-theme="dark"] .status-badge {
            background: rgba(0, 0, 0, 0.4);
            padding: 6px 12px;
            border-radius: 6px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            text-shadow: 0 0 6px rgba(255, 255, 255, 0.6);
        }

        /* Hero Header - Dark Mode */
        [data-theme="dark"] .hero-header h1 {
            color: rgba(255, 255, 255, 1.0);
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.8),
                         0 0 16px rgba(255, 255, 255, 0.4);
        }

        [data-theme="dark"] .hero-header p {
            color: rgba(255, 255, 255, 0.65);
            text-shadow: 0 0 6px rgba(255, 255, 255, 0.6);
        }

        /* Stat Cards - Dark Mode Text-Readability */
        [data-theme="dark"] .stat-card__value {
            text-shadow: 0 0 8px var(--glow-primary);
        }

        [data-theme="dark"] .stat-card__label {
            color: rgba(255, 255, 255, 0.65);
            text-shadow: 0 0 6px rgba(255, 255, 255, 0.6);
        }

        /* Search & Filter - Dark Mode */
        [data-theme="dark"] .search-filter-section h3,
        [data-theme="dark"] .table-section h3 {
            color: rgba(255, 255, 255, 1.0);
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
        }

        /* Pagination - Dark Mode Text-Readability */
        [data-theme="dark"] .pagination-info,
        [data-theme="dark"] .page-number {
            color: rgba(255, 255, 255, 1.0);
            text-shadow: 0 0 6px rgba(255, 255, 255, 0.6);
        }

        /* ============================================
           DARK MODE - CONTAINER BACKGROUNDS (CRITICAL FIX!)
           ============================================ */

        /* Hero Header - Dark Mode Container */
        [data-theme="dark"] .hero-header {
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            box-shadow: var(--shadow-lg), inset 0 1px 1px rgba(255,255,255,0.15);
        }

        /* Stat Cards - Dark Mode Container */
        [data-theme="dark"] .stat-card {
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            box-shadow: var(--shadow-md), inset 0 1px 1px rgba(255,255,255,0.1);
        }

        /* Search & Filter Section - Dark Mode Container */
        [data-theme="dark"] .search-filter-section {
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            box-shadow: var(--shadow-md), inset 0 1px 1px rgba(255,255,255,0.1);
        }

        /* Table Section - Dark Mode Container */
        [data-theme="dark"] .table-section {
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            box-shadow: var(--shadow-md), inset 0 1px 1px rgba(255,255,255,0.1);
        }

        /* Table - Dark Mode Backgrounds */
        [data-theme="dark"] table thead {
            background: rgba(0, 191, 255, 0.15);
            border-bottom: 1px solid var(--color-border);
        }

        [data-theme="dark"] table tbody tr:hover {
            background: rgba(0, 191, 255, 0.05);
            transform: scale(1.002);
        }

        [data-theme="dark"] table tbody tr {
            border-bottom: 1px solid var(--color-border-light);
        }

        /* ============================================
           MOBILE HEADER & THEME TOGGLE
           ============================================ */

        /* RESPONSIVE - Mobile */
        @media (max-width: 768px) {
            /* ‚ùå HIDE Desktop Header on Mobile */
            .hero-header {
                display: none;
            }

            /* ‚ùå NO BOTTOM NAV - Remove padding! */
            .main-container {
                padding: var(--space-4);
                padding-bottom: 0; /* ‚úÖ Bottom Nav entfernt! */
                padding-top: var(--space-4); /* Space after mobile header */
            }

            .hero-header__icon {
                width: 60px;
                height: 60px;
            }

            .hero-header__icon i {
                width: 32px;
                height: 32px;
            }

            .hero-header h1 {
                font-size: 24px;
            }

            /* ‚úÖ STATS-DASHBOARD MOBILE OPTIMIZATION - Minimalistisch 2√ó2 Grid */
            .stats-dashboard {
                grid-template-columns: repeat(2, 1fr); /* ‚úÖ Kompakte 2 Spalten */
                gap: var(--space-2);                    /* ‚úÖ Kleiner Gap */
            }

            .stat-card {
                padding: var(--space-3);                /* ‚úÖ Weniger Padding - minimalistisch */
            }

            .stat-card__icon {
                width: 32px;                            /* ‚úÖ Kleine Icons */
                height: 32px;
                margin-bottom: var(--space-2);
            }

            .stat-card__icon i {
                width: 16px;                            /* ‚úÖ Kleine Icon-Gr√∂√üe */
                height: 16px;
            }

            .stat-card__value {
                font-size: var(--font-size-xl);         /* ‚úÖ Kleinere Zahlen - kompakt */
                margin-bottom: var(--space-1);
            }

            .stat-card__label {
                font-size: 10px;                        /* ‚úÖ Sehr klein - minimalistisch */
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }

            .table-section,
            .search-filter-section {
                padding: var(--space-4);
            }

            /* Mobile Table - Horizontal Scroll */
            .table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            table {
                min-width: 900px; /* Force horizontal scroll on small screens */
            }

            /* ‚úÖ PAGINATION MOBILE OPTIMIZATION */
            .pagination-container {
                flex-direction: column;
                align-items: stretch;
                gap: var(--space-3);      /* Spacing zwischen Info, Controls, Select */
                padding: var(--space-3);  /* Kompakteres Padding */
            }

            .pagination-info {
                font-size: 12px;
                text-align: center;
                order: 1; /* Info oben */
            }

            .pagination-controls {
                justify-content: center;
                flex-wrap: wrap;          /* Buttons k√∂nnen umbrechen */
                gap: var(--space-2);      /* Kleinerer Gap zwischen Buttons */
                order: 2; /* Controls in der Mitte */
            }

            .pagination-btn {
                padding: var(--space-2) var(--space-3); /* Kleinere Buttons */
                font-size: 12px;
            }

            /* ‚ùå HIDE "Erste" und "Letzte" Buttons auf Mobile - zu viele Buttons! */
            #firstPageBtn,
            #lastPageBtn {
                display: none; /* Nur Zur√ºck, Nummer, Weiter anzeigen */
            }

            .pagination-current {
                padding: var(--space-2) var(--space-3);
                font-size: 12px;
            }

            .pagination-select {
                width: 100%;  /* Full-width auf Mobile */
                font-size: 12px;
                order: 3; /* Select unten */
            }

            /* ‚úÖ FILTER-BUTTONS MOBILE OPTIMIZATION */
            .filter-btn {
                padding: var(--space-2) var(--space-3); /* ‚úÖ Kompakter */
                font-size: 12px;                         /* ‚úÖ Kleiner */
                white-space: nowrap;                     /* ‚úÖ Kein Text-Wrapping */
            }

            .filter-btn i {
                display: none; /* ‚úÖ Icons ausblenden auf Mobile - spart Platz! */
            }

            /* Status-Filter: 2x2 Grid Layout */
            .filter-group:first-of-type .filter-buttons {
                display: grid;
                grid-template-columns: 1fr 1fr; /* ‚úÖ 2 Spalten */
                gap: var(--space-2);
            }

            /* Kunden-Filter: Full-width gestapelt */
            .filter-group:last-of-type .filter-buttons {
                display: flex;
                flex-direction: column; /* ‚úÖ Vertikal gestapelt */
                gap: var(--space-2);
            }

            .filter-group:last-of-type .filter-btn {
                width: 100%;             /* ‚úÖ Full-width */
                justify-content: center;
            }

            .modal-content {
                padding: var(--space-6);
            }

            .bottom-nav__item span {
                font-size: 10px;
            }
        }

        /* LOADING SPINNER */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 191, 255, 0.2);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* TOAST NOTIFICATION */
        .toast-container {
            position: fixed;
            top: var(--space-4);
            right: var(--space-4);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .toast {
            background: var(--color-surface-elevated);
            backdrop-filter: blur(var(--glass-blur-strong));
            -webkit-backdrop-filter: blur(var(--glass-blur-strong));
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            box-shadow: var(--shadow-xl);
            min-width: 300px;
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .toast.success {
            border-left: 4px solid var(--color-success);
        }

        .toast.error {
            border-left: 4px solid var(--color-error);
        }

        .toast.info {
            border-left: 4px solid var(--color-primary);
        }
    </style>

    <!-- Phase 3: Event Listeners for Real-Time UI Updates -->
    <script>
        /**
         * Setup event listeners for AI Agent actions
         * Note: liste.html already has Firestore realtime listeners,
         * so these event listeners mainly provide logging and notifications
         */
        function setupListeEventListeners() {
            // Check if event system is available
            if (!window.appEvents) {
                console.warn('‚ö†Ô∏è [LISTE] Event system not available yet, will retry...');
                // Retry after a short delay
                setTimeout(setupListeEventListeners, 500);
                return;
            }

            console.log('üëÇ [LISTE] Setting up event listeners...');
            console.log('‚ÑπÔ∏è [LISTE] Note: Firestore realtime listener already active, events provide additional logging');

            // Listen for fahrzeug created
            window.appEvents.on('fahrzeugCreated', (data) => {
                console.log('ü§ñ [LISTE] AI created vehicle:', data.fahrzeug.kennzeichen);
                console.log('   ‚Ü≥ Firestore realtime listener will auto-refresh the list');
                // Optional: Show toast notification
                // showToast(`Fahrzeug ${data.fahrzeug.kennzeichen} wurde erstellt`, 'success');
            });

            // Listen for fahrzeug updated
            window.appEvents.on('fahrzeugUpdated', (data) => {
                console.log('ü§ñ [LISTE] AI updated vehicle:', data.vehicleId);
                console.log('   ‚Ü≥ Firestore realtime listener will auto-refresh the list');
                // Optional: Show toast notification
                // showToast(`Fahrzeug wurde aktualisiert`, 'info');
            });

            // Listen for fahrzeug deleted
            window.appEvents.on('fahrzeugDeleted', (data) => {
                console.log('ü§ñ [LISTE] AI deleted vehicle:', data.vehicleId);
                console.log('   ‚Ü≥ Firestore realtime listener will auto-refresh the list');
            });

            console.log('‚úÖ [LISTE] Event listeners registered successfully');
        }

        // Initialize event listeners when page loads
        if (document.readyState === 'loading') {
            window.listenerRegistry.registerDOM(document, 'DOMContentLoaded', setupListeEventListeners, 'document DOMContentLoaded');
        } else {
            // DOM already loaded
            setupListeEventListeners();
        }
    </script>
</head>
<body>
    <!-- ‚úÖ FIXED THEME TOGGLE (Konsistent mit index.html) -->
    <button id="themeToggle" class="theme-toggle" aria-label="Toggle Light/Dark Mode">
        <i data-feather="sun" class="theme-toggle__icon theme-toggle__icon--light"></i>
        <i data-feather="moon" class="theme-toggle__icon theme-toggle__icon--dark"></i>
    </button>

    <!-- ACCENT-LIGHT - Pulsing Glow (Theme-Aware) -->
    <div class="accent-light"></div>

    <!-- PAGE TRANSITION OVERLAY -->
    <div class="page-transition-overlay"></div>

    <!-- TOAST NOTIFICATION CONTAINER -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- MAIN CONTAINER -->
    <div class="main-container">

        <!-- STATS DASHBOARD -->
        <div class="stats-dashboard" id="statsDashboard">
            <!-- Stats will be injected by JavaScript -->
        </div>

        <!-- SEARCH & FILTER SECTION -->
        <div class="search-filter-section">
            <h3>
                <i data-feather="search"></i>
                Suchen & Filtern
            </h3>

            <!-- SEARCH BOX -->
            <div class="search-box">
                <i data-feather="search"></i>
                <input
                    type="text"
                    id="searchInput"
                    placeholder="Suche nach Kennzeichen, Kundenname oder Marke..."
                    oninput="filterTable()">
            </div>

            <!-- FILTER BUTTONS - Status -->
            <div class="filter-group">
                <span class="filter-group__label">Status-Filter</span>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterStatus('all')">
                        <i data-feather="list"></i> Alle
                    </button>
                    <button class="filter-btn" onclick="filterStatus('angenommen')">
                        <i data-feather="clock"></i> Angenommen
                    </button>
                    <button class="filter-btn" onclick="filterStatus('in_arbeit')">
                        <i data-feather="tool"></i> In Arbeit
                    </button>
                    <button class="filter-btn" onclick="filterStatus('abgeschlossen')">
                        <i data-feather="check-circle"></i> Abgeschlossen
                    </button>
                </div>
            </div>

            <!-- FILTER BUTTONS - Kunden -->
            <div class="filter-group">
                <span class="filter-group__label">Kunden-Filter</span>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterKunden('all')">
                        <i data-feather="users"></i> Alle Kunden
                    </button>
                    <button class="filter-btn" onclick="filterKunden('stammkunden')">
                        <i data-feather="star"></i> Stammkunden
                    </button>
                    <button class="filter-btn" onclick="filterKunden('neukunden')">
                        <i data-feather="user-plus"></i> Neukunden
                    </button>
                </div>
            </div>
        </div>

        <!-- TABLE SECTION -->
        <div class="table-section">
            <h3>
                <i data-feather="list"></i>
                Fahrzeugliste
            </h3>

            <div class="table-wrapper">
                <table id="vehicleTable">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortTable('kennzeichen')">Kennzeichen</th>
                            <th class="sortable" onclick="sortTable('marke')">Marke / Modell</th>
                            <th class="sortable" onclick="sortTable('kunde')">Kunde</th>
                            <th class="sortable" onclick="sortTable('serviceTyp')">Service</th>
                            <th class="sortable" onclick="sortTable('status')">Status</th>
                            <th class="sortable" onclick="sortTable('datum')">Datum</th>
                            <th>Aktionen</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Table rows will be injected by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- PAGINATION -->
            <div class="pagination-container">
                <div class="pagination-info" id="paginationInfo">
                    <!-- Info will be injected by JavaScript -->
                </div>

                <div class="pagination-controls">
                    <button class="pagination-btn" id="firstPageBtn" onclick="goToPage(1)" disabled>
                        <i data-feather="chevrons-left"></i> Erste
                    </button>
                    <button class="pagination-btn" id="prevPageBtn" onclick="prevPage()" disabled>
                        <i data-feather="chevron-left"></i> Zur√ºck
                    </button>
                    <span class="pagination-current" id="currentPage">1</span>
                    <button class="pagination-btn" id="nextPageBtn" onclick="nextPage()">
                        Weiter <i data-feather="chevron-right"></i>
                    </button>
                    <button class="pagination-btn" id="lastPageBtn" onclick="goToLastPage()">
                        Letzte <i data-feather="chevrons-right"></i>
                    </button>
                </div>

                <div>
                    <select class="pagination-select" id="itemsPerPageSelect" onchange="changeItemsPerPage()">
                        <option value="10">10 pro Seite</option>
                        <option value="20" selected>20 pro Seite</option>
                        <option value="50">50 pro Seite</option>
                        <option value="100">100 pro Seite</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL - Vehicle Details -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>
                    <i data-feather="info"></i>
                    Fahrzeug-Details
                </h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody">
                <!-- Details will be injected by JavaScript -->
            </div>
        </div>
    </div>

    <!-- üóëÔ∏è BOTTOM NAVIGATION ENTFERNT - Nur Mobile Header! -->

    <script>
        /* ============================================
           JAVASCRIPT - LISTE.HTML
           Dark Glass Version 1.0
           ============================================ */

        // GLOBAL STATE
        let allVehicles = [];
        let allKunden = [];
        let filteredVehicles = [];
        let currentFilter = 'all';
        let currentKundenFilter = 'all';
        let currentSortColumn = null;
        let currentSortDirection = 'none';
        let currentPage = 1;
        let itemsPerPage = 20;
        let totalPages = 1;
        let firebaseInitialized = false;
        // ‚úÖ firebaseApp wird von firebase-config.js √ºber window.firebaseApp bereitgestellt
        let unsubscribeListener = null;

        // INITIALIZE ON LOAD
        window.addEventListener('load', async function() {
            console.log('üöÄ [LISTE] Initialisiere Fahrzeug-√úbersicht...');

            // Initialize Feather Icons
            if (typeof feather !== 'undefined') {
                feather.replace();
            }

            // Initialize Firebase
            try {
                if (typeof initFirebase !== 'undefined') {
                    await initFirebase();

                    if (window.firebaseInitialized && window.firebaseApp) {
                        firebaseApp = window.firebaseApp;
                        firebaseInitialized = true;
                        console.log('‚úÖ [LISTE] Firebase initialisiert');

                        // Auth-Check f√ºr Multi-Tenant Support (Race Condition Fix)
                        console.log('üîê [LISTE] Pr√ºfe Auth State f√ºr Multi-Tenant...');
                        let currentUser = null;
                        let attempts = 0;
                        const maxAttempts = 20;

                        while (!currentUser && attempts < maxAttempts) {
                            currentUser = window.authManager?.getCurrentUser();
                            if (!currentUser) {
                                console.log(`‚è≥ [LISTE] Warte auf Auth State (${attempts + 1}/${maxAttempts})...`);
                                await new Promise(resolve => setTimeout(resolve, 250));
                                attempts++;
                            }
                        }

                        if (!currentUser) {
                            console.warn('‚ö†Ô∏è [LISTE] Kein User eingeloggt - verwende globale Collections');
                        } else {
                            console.log('‚úÖ [LISTE] Auth State geladen');
                            console.log('   User:', currentUser.name);
                            console.log('   WerkstattId:', currentUser.werkstattId);
                        }

                        // Load customers
                        await loadKunden();

                        // Setup realtime listener
                        setupRealtimeListener();
                    } else {
                        console.warn('‚ö†Ô∏è [LISTE] Firebase init fehlgeschlagen, nutze LocalStorage');
                        await loadKunden();
                        loadFromLocalStorage();
                    }
                } else {
                    console.warn('‚ö†Ô∏è [LISTE] Firebase-Config nicht gefunden, nutze LocalStorage');
                    await loadKunden();
                    loadFromLocalStorage();
                }
            } catch (error) {
                console.error('‚ùå [LISTE] Firebase Fehler:', error);
                await loadKunden();
                loadFromLocalStorage();
            }

            // GSAP Entrance Animations
            initAnimations();
        });

        // LOAD CUSTOMERS
        async function loadKunden() {
            try {
                if (firebaseInitialized && firebaseApp && firebaseApp.getAllKunden) {
                    allKunden = await firebaseApp.getAllKunden();
                    console.log(`‚úÖ [LISTE] ${allKunden.length} Kunden aus Firebase geladen`);
                } else {
                    allKunden = JSON.parse(localStorage.getItem('kunden') || '[]');
                    console.log(`‚úÖ [LISTE] ${allKunden.length} Kunden aus LocalStorage geladen`);
                }
            } catch (error) {
                console.error('‚ùå [LISTE] Fehler beim Laden der Kunden:', error);
                allKunden = [];
            }
        }

        // SETUP REALTIME LISTENER (Firebase)
        function setupRealtimeListener() {
            if (!firebaseInitialized || !firebaseApp || !firebaseApp.listenToFahrzeuge) {
                console.warn('‚ö†Ô∏è [LISTE] Realtime-Listener nicht verf√ºgbar');
                return;
            }

            console.log('üîÑ [LISTE] Aktiviere Realtime-Listener...');

            unsubscribeListener = firebaseApp.listenToFahrzeuge(function(fahrzeuge) {
                console.log(`üî• [LISTE] Realtime Update: ${fahrzeuge.length} Fahrzeuge empfangen`);

                // Lazy Loading: Photos are NOT loaded automatically (performance!)
                fahrzeuge.forEach(fahrzeug => {
                    fahrzeug.photos = fahrzeug.photos || [];
                    fahrzeug.nachherPhotos = fahrzeug.nachherPhotos || [];
                });

                allVehicles = fahrzeuge;
                updateStats();
                filterTable();

                console.log('‚úÖ [LISTE] Tabelle automatisch aktualisiert');
            });
        }

        // LOAD FROM LOCAL STORAGE (Fallback)
        function loadFromLocalStorage() {
            try {
                allVehicles = JSON.parse(localStorage.getItem('fahrzeuge') || '[]');
                console.log(`‚úÖ [LISTE] ${allVehicles.length} Fahrzeuge aus LocalStorage geladen`);
                updateStats();
                filterTable();
            } catch (error) {
                console.error('‚ùå [LISTE] Fehler beim Laden aus LocalStorage:', error);
                allVehicles = [];
                updateStats();
                filterTable();
            }
        }

        // UPDATE STATS DASHBOARD
        function updateStats() {
            const stats = {
                total: allVehicles.length,
                angenommen: allVehicles.filter(v => ['angenommen', 'neu', 'terminiert'].includes(v.status)).length,
                in_arbeit: allVehicles.filter(v => ['vorbereitung', 'lackierung', 'in_arbeit', 'bestellung', 'angekommen', 'montage', 'wuchten', 'diagnose', 'pruefung', 'in_pruefung', 'angebot', 'beauftragt', 'reparatur', 'in_reparatur', 'test', 'termin', 'termin_bestaetigt', 'termin_gebucht', 'aufbereitung', 'trocknung'].includes(v.status)).length,
                abgeschlossen: allVehicles.filter(v => ['bereit', 'fertig', 'abholbereit', 'abgeschlossen', 'freigabe'].includes(v.status)).length,
                qualitaet: allVehicles.filter(v => ['qualitaetskontrolle', 'qualitaet', 'gutachten'].includes(v.status)).length
            };

            const dashboard = document.getElementById('statsDashboard');
            dashboard.innerHTML = `
                <div class="stat-card">
                    <div class="stat-card__icon">
                        <i data-feather="database"></i>
                    </div>
                    <div class="stat-card__value">${stats.total}</div>
                    <div class="stat-card__label">Gesamt</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card__icon">
                        <i data-feather="clock"></i>
                    </div>
                    <div class="stat-card__value">${stats.angenommen}</div>
                    <div class="stat-card__label">Angenommen</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card__icon">
                        <i data-feather="tool"></i>
                    </div>
                    <div class="stat-card__value">${stats.in_arbeit}</div>
                    <div class="stat-card__label">In Arbeit</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card__icon">
                        <i data-feather="check-circle"></i>
                    </div>
                    <div class="stat-card__value">${stats.abgeschlossen}</div>
                    <div class="stat-card__label">Abgeschlossen</div>
                </div>
            `;

            // Re-initialize Feather Icons for new stats
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        }

        // FILTER STATUS
        function filterStatus(status) {
            currentFilter = status;
            currentPage = 1;

            // Update active button
            document.querySelectorAll('.filter-buttons .filter-btn').forEach((btn, index) => {
                if (index <= 3) { // Status filter buttons
                    btn.classList.remove('active');
                }
            });
            event.target.classList.add('active');

            filterTable();
        }

        // FILTER KUNDEN
        function filterKunden(filter) {
            currentKundenFilter = filter;
            currentPage = 1;

            // Update active button
            const buttons = document.querySelectorAll('.filter-group')[1].querySelectorAll('.filter-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            filterTable();
        }

        // FILTER TABLE (Search + Status + Kunden)
        function filterTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            // Start with all vehicles
            filteredVehicles = allVehicles.filter(vehicle => {
                // Search filter
                const matchesSearch = !searchTerm ||
                    vehicle.kennzeichen?.toLowerCase().includes(searchTerm) ||
                    vehicle.kunde?.toLowerCase().includes(searchTerm) ||
                    vehicle.marke?.toLowerCase().includes(searchTerm) ||
                    vehicle.modell?.toLowerCase().includes(searchTerm);

                // Status filter
                let matchesStatus = true;
                if (currentFilter === 'angenommen') {
                    matchesStatus = ['angenommen', 'neu', 'terminiert'].includes(vehicle.status);
                } else if (currentFilter === 'in_arbeit') {
                    matchesStatus = ['vorbereitung', 'lackierung', 'in_arbeit', 'bestellung', 'angekommen', 'montage', 'wuchten', 'diagnose', 'pruefung', 'in_pruefung', 'angebot', 'beauftragt', 'reparatur', 'in_reparatur', 'test', 'termin', 'termin_bestaetigt', 'termin_gebucht', 'aufbereitung', 'trocknung'].includes(vehicle.status);
                } else if (currentFilter === 'abgeschlossen') {
                    matchesStatus = ['bereit', 'fertig', 'abholbereit', 'abgeschlossen', 'freigabe'].includes(vehicle.status);
                }

                // Kunden filter
                let matchesKunden = true;
                if (currentKundenFilter === 'stammkunden') {
                    const kunde = allKunden.find(k => k.name === vehicle.kunde);
                    matchesKunden = kunde && kunde.besuche >= 3;
                } else if (currentKundenFilter === 'neukunden') {
                    const kunde = allKunden.find(k => k.name === vehicle.kunde);
                    matchesKunden = kunde && kunde.besuche < 3;
                }

                return matchesSearch && matchesStatus && matchesKunden;
            });

            renderTable();
        }

        // RENDER TABLE
        function renderTable() {
            const tableBody = document.getElementById('tableBody');

            // Calculate pagination
            totalPages = Math.ceil(filteredVehicles.length / itemsPerPage);
            if (totalPages === 0) totalPages = 1;
            if (currentPage > totalPages) currentPage = totalPages;

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredVehicles.length);
            const vehiclesToDisplay = filteredVehicles.slice(startIndex, endIndex);

            // Empty state
            if (vehiclesToDisplay.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7">
                            <div class="empty-state">
                                <i data-feather="inbox"></i>
                                <h3>Keine Fahrzeuge gefunden</h3>
                                <p>Keine Fahrzeuge entsprechen den aktuellen Filterkriterien.</p>
                            </div>
                        </td>
                    </tr>
                `;
                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
                updatePaginationControls();
                return;
            }

            // Render rows
            tableBody.innerHTML = vehiclesToDisplay.map(vehicle => {
                const statusClass = `status-${vehicle.status?.toLowerCase().replace(/\s/g, '_')}`;
                const statusIcon = getStatusIcon(vehicle.status);
                const serviceLabel = getServiceLabel(vehicle.serviceTyp);

                return `
                    <tr>
                        <td><strong>${vehicle.kennzeichen || 'N/A'}</strong></td>
                        <td>${vehicle.marke || 'N/A'} ${vehicle.modell || ''}</td>
                        <td>${vehicle.kunde || 'N/A'}</td>
                        <td>${serviceLabel}</td>
                        <td>
                            <span class="status-badge ${statusClass}">
                                <i data-feather="${statusIcon}"></i>
                                ${formatStatus(vehicle.status)}
                            </span>
                        </td>
                        <td>${formatDate(vehicle.datum)}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-action btn-view" onclick="viewDetails('${vehicle.id}')">
                                    <i data-feather="eye"></i> Details
                                </button>
                                <button class="btn-action btn-delete" onclick="deleteVehicle('${vehicle.id}')">
                                    <i data-feather="trash-2"></i> L√∂schen
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            // Re-initialize Feather Icons
            if (typeof feather !== 'undefined') {
                feather.replace();
            }

            updatePaginationControls();
        }

        // GET STATUS ICON
        function getStatusIcon(status) {
            const statusLower = status?.toLowerCase().replace(/\s/g, '_');
            const icons = {
                'neu': 'inbox',
                'angenommen': 'clock',
                'terminiert': 'calendar',
                'vorbereitung': 'loader',
                'lackierung': 'droplet',
                'in_arbeit': 'tool',
                'bestellung': 'shopping-cart',
                'angekommen': 'package',
                'montage': 'settings',
                'wuchten': 'disc',
                'diagnose': 'search',
                'pruefung': 'clipboard',
                'in_pruefung': 'clipboard',
                'angebot': 'file-text',
                'beauftragt': 'check-square',
                'reparatur': 'wrench',
                'in_reparatur': 'wrench',
                'test': 'activity',
                'termin': 'calendar',
                'termin_bestaetigt': 'calendar-check',
                'termin_gebucht': 'calendar',
                'aufbereitung': 'droplet',
                'trocknung': 'wind',
                'bereit': 'check',
                'fertig': 'check-circle',
                'abholbereit': 'package',
                'abgeschlossen': 'check-circle',
                'freigabe': 'unlock',
                'qualitaetskontrolle': 'alert-circle',
                'qualitaet': 'shield',
                'gutachten': 'file-text'
            };
            return icons[statusLower] || 'circle';
        }

        // GET SERVICE LABEL
        function getServiceLabel(serviceTyp) {
            const labels = {
                'lackierung': 'üé® Lackierung',
                'lackier': 'üé® Lackierung',  // Alias f√ºr Consistency
                'reifen': 'üõû Reifen',
                'mechanik': 'üîß Mechanik',
                'pflege': '‚ú® Pflege',
                'tuev': 'üìã T√úV',  // FIX: 'tuv' ‚Üí 'tuev'
                'tuv': 'üìã T√úV',   // Legacy Support
                'versicherung': 'üìÑ Versicherung',
                'glas': 'üîç Glas-Reparatur',
                'klima': '‚ùÑÔ∏è Klima-Service',
                'dellen': 'üî® Dellen-Dr√ºckung'
            };
            return labels[serviceTyp?.toLowerCase()] || serviceTyp || 'N/A';
        }

        // FORMAT STATUS
        function formatStatus(status) {
            if (!status) return 'N/A';
            return status.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        // FORMAT DATE
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString;
            return date.toLocaleDateString('de-DE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // SORT TABLE
        function sortTable(column) {
            // Update sort direction
            if (currentSortColumn === column) {
                if (currentSortDirection === 'none') {
                    currentSortDirection = 'asc';
                } else if (currentSortDirection === 'asc') {
                    currentSortDirection = 'desc';
                } else {
                    currentSortDirection = 'none';
                    currentSortColumn = null;
                }
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }

            // Update table headers
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('asc', 'desc');
            });

            if (currentSortDirection !== 'none') {
                const th = Array.from(document.querySelectorAll('th.sortable')).find(th =>
                    th.textContent.toLowerCase().includes(column) ||
                    th.onclick.toString().includes(column)
                );
                if (th) {
                    th.classList.add(currentSortDirection);
                }
            }

            // Sort filtered vehicles
            if (currentSortDirection === 'none') {
                // Reset to original order
                filterTable();
                return;
            }

            filteredVehicles.sort((a, b) => {
                let aVal = a[column] || '';
                let bVal = b[column] || '';

                // Special handling for dates
                if (column === 'datum') {
                    aVal = new Date(aVal).getTime() || 0;
                    bVal = new Date(bVal).getTime() || 0;
                }

                // String comparison
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }

                if (currentSortDirection === 'asc') {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
            });

            renderTable();
        }

        // VIEW DETAILS
        // ‚ú® SERVICE-DETAILS RENDERING
        function renderServiceDetails(vehicle) {
            if (!vehicle.serviceDetails) return '';

            let html = '<div class="detail-row" style="background: rgba(0, 122, 255, 0.05); padding: 12px; border-radius: 8px; margin: 8px 0;">';
            html += '<strong style="display: block; margin-bottom: 8px;">üîß Service-Details</strong>';
            html += '<div style="padding-left: 16px;">';

            switch(vehicle.serviceTyp) {
                case 'reifen':
                    if (vehicle.serviceDetails.reifengroesse) {
                        html += `<p style="margin: 4px 0;">üõû <strong>Reifengr√∂√üe:</strong> ${vehicle.serviceDetails.reifengroesse}</p>`;
                    }
                    if (vehicle.serviceDetails.reifentyp) {
                        const typLabels = { sommer: 'Sommerreifen', winter: 'Winterreifen', ganzjahr: 'Ganzjahresreifen' };
                        html += `<p style="margin: 4px 0;">üìÖ <strong>Typ:</strong> ${typLabels[vehicle.serviceDetails.reifentyp] || vehicle.serviceDetails.reifentyp}</p>`;
                    }
                    if (vehicle.serviceDetails.reifenanzahl) {
                        html += `<p style="margin: 4px 0;">üî¢ <strong>Anzahl:</strong> ${vehicle.serviceDetails.reifenanzahl}x</p>`;
                    }
                    break;

                case 'glas':
                    if (vehicle.serviceDetails.scheibentyp) {
                        html += `<p style="margin: 4px 0;">ü™ü <strong>Scheibe:</strong> ${vehicle.serviceDetails.scheibentyp}</p>`;
                    }
                    if (vehicle.serviceDetails.schadensgroesse) {
                        html += `<p style="margin: 4px 0;">üí• <strong>Schaden:</strong> ${vehicle.serviceDetails.schadensgroesse}</p>`;
                    }
                    if (vehicle.serviceDetails.glasposition) {
                        html += `<p style="margin: 4px 0;">üìç <strong>Position:</strong> ${vehicle.serviceDetails.glasposition}</p>`;
                    }
                    break;

                case 'klima':
                    if (vehicle.serviceDetails.klimaservice) {
                        html += `<p style="margin: 4px 0;">‚ùÑÔ∏è <strong>Service-Art:</strong> ${vehicle.serviceDetails.klimaservice}</p>`;
                    }
                    if (vehicle.serviceDetails.kaeltemittel) {
                        html += `<p style="margin: 4px 0;">üí® <strong>K√§ltemittel:</strong> ${vehicle.serviceDetails.kaeltemittel}</p>`;
                    }
                    if (vehicle.serviceDetails.klimaproblem) {
                        html += `<p style="margin: 4px 0;">üìù <strong>Problem:</strong> ${vehicle.serviceDetails.klimaproblem}</p>`;
                    }
                    break;

                case 'dellen':
                    if (vehicle.serviceDetails.dellenanzahl) {
                        html += `<p style="margin: 4px 0;">üî® <strong>Anzahl Dellen:</strong> ${vehicle.serviceDetails.dellenanzahl}x</p>`;
                    }
                    if (vehicle.serviceDetails.dellengroesse) {
                        const groesseLabels = { klein: 'Klein (< 5cm)', mittel: 'Mittel (5-10cm)', gross: 'Gro√ü (> 10cm)' };
                        html += `<p style="margin: 4px 0;">üìè <strong>Gr√∂√üe:</strong> ${groesseLabels[vehicle.serviceDetails.dellengroesse] || vehicle.serviceDetails.dellengroesse}</p>`;
                    }
                    if (vehicle.serviceDetails.lackschaden) {
                        const lackschadenLabel = vehicle.serviceDetails.lackschaden === 'ja' ? '‚ö†Ô∏è Ja (Lackierung n√∂tig)' : '‚úÖ Nein (nur Delle)';
                        html += `<p style="margin: 4px 0;">üé® <strong>Lackschaden:</strong> ${lackschadenLabel}</p>`;
                    }
                    if (vehicle.serviceDetails.dellenpositionen) {
                        html += `<p style="margin: 4px 0;">üìç <strong>Positionen:</strong> ${vehicle.serviceDetails.dellenpositionen}</p>`;
                    }
                    break;

                default:
                    // Andere Services: Generische Anzeige aller serviceDetails Felder
                    Object.keys(vehicle.serviceDetails).forEach(key => {
                        html += `<p style="margin: 4px 0;"><strong>${key}:</strong> ${vehicle.serviceDetails[key]}</p>`;
                    });
                    break;
            }

            html += '</div></div>';
            return html;
        }

        async function viewDetails(vehicleId) {
            // ‚úÖ FIX: String-Vergleich f√ºr ID (vehicleId kommt als String vom onclick)
            const vehicle = allVehicles.find(v => window.compareIds(v.id, vehicleId));
            if (!vehicle) {
                showToast('Fehler: Fahrzeug nicht gefunden', 'error');
                return;
            }

            // Load photos lazily (performance!)
            let vorherPhotos = [];
            let nachherPhotos = [];

            if (firebaseInitialized && firebaseApp && firebaseApp.getFahrzeugFotos) {
                try {
                    const fotosData = await firebaseApp.getFahrzeugFotos(vehicleId);
                    vorherPhotos = fotosData.vorher || [];
                    nachherPhotos = fotosData.nachher || [];
                    console.log(`‚úÖ [LISTE] Fotos geladen f√ºr ${vehicleId}: ${vorherPhotos.length} vorher, ${nachherPhotos.length} nachher`);
                } catch (error) {
                    console.error('‚ùå [LISTE] Fehler beim Laden der Fotos:', error);
                }
            } else {
                // Fallback: LocalStorage
                vorherPhotos = vehicle.photos || [];
                nachherPhotos = vehicle.nachherPhotos || [];
            }

            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div class="detail-row">
                    <strong>Kennzeichen</strong>
                    <span>${vehicle.kennzeichen || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <strong>Marke / Modell</strong>
                    <span>${vehicle.marke || 'N/A'} ${vehicle.modell || ''}</span>
                </div>
                <div class="detail-row">
                    <strong>Kunde</strong>
                    <span>${vehicle.kunde || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <strong>Service-Typ</strong>
                    <span>${getServiceLabel(vehicle.serviceTyp)}</span>
                </div>
                ${renderServiceDetails(vehicle)}
                <div class="detail-row">
                    <strong>Status</strong>
                    <span>${formatStatus(vehicle.status)}</span>
                </div>
                <div class="detail-row">
                    <strong>Datum</strong>
                    <span>${formatDate(vehicle.datum)}</span>
                </div>
                ${vehicle.farbnummer ? `
                <div class="detail-row">
                    <strong>Farbnummer</strong>
                    <span>${vehicle.farbnummer}</span>
                </div>
                ` : ''}
                ${vehicle.bemerkungen ? `
                <div class="detail-row">
                    <strong>Bemerkungen</strong>
                    <span>${vehicle.bemerkungen}</span>
                </div>
                ` : ''}
                ${vorherPhotos.length > 0 ? `
                <div class="detail-row">
                    <strong>Fotos (Vorher)</strong>
                    <div class="photo-gallery">
                        ${vorherPhotos.map((photo, i) => `
                            <img src="${photo}" alt="Vorher ${i + 1}" loading="lazy" decoding="async" onclick="openPhotoFullscreen('${photo}')">
                        `).join('')}
                    </div>
                </div>
                ` : ''}
                ${nachherPhotos.length > 0 ? `
                <div class="detail-row">
                    <strong>Fotos (Nachher)</strong>
                    <div class="photo-gallery">
                        ${nachherPhotos.map((photo, i) => `
                            <img src="${photo}" alt="Nachher ${i + 1}" loading="lazy" decoding="async" onclick="openPhotoFullscreen('${photo}')">
                        `).join('')}
                    </div>
                </div>
                ` : ''}
            `;

            document.getElementById('detailModal').classList.add('show');

            // Re-initialize Feather Icons
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        }

        // CLOSE MODAL
        function closeModal() {
            document.getElementById('detailModal').classList.remove('show');
        }

        // OPEN PHOTO FULLSCREEN
        function openPhotoFullscreen(photoSrc) {
            const fullscreenDiv = document.createElement('div');
            fullscreenDiv.style.cssText = `
                position: fixed;
                inset: 0;
                z-index: 10000;
                background: rgba(0,0,0,0.95);
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
            `;
            fullscreenDiv.innerHTML = `<img src="${photoSrc}" style="max-width: 95%; max-height: 95%; border-radius: 12px;" loading="lazy" decoding="async">`;
            fullscreenDiv.onclick = () => fullscreenDiv.remove();
            document.body.appendChild(fullscreenDiv);
        }

        // DELETE VEHICLE
        async function deleteVehicle(vehicleId) {
            if (!confirm('M√∂chten Sie dieses Fahrzeug wirklich l√∂schen?')) {
                return;
            }

            try {
                if (firebaseInitialized && firebaseApp && firebaseApp.deleteFahrzeug) {
                    await firebaseApp.deleteFahrzeug(vehicleId);
                    showToast('Fahrzeug erfolgreich gel√∂scht', 'success');
                } else {
                    // Fallback: LocalStorage
                    // ‚úÖ FIX: String-Vergleich f√ºr ID Konsistenz
                    allVehicles = allVehicles.filter(v => String(v.id) !== String(vehicleId));
                    localStorage.setItem('fahrzeuge', JSON.stringify(allVehicles));
                    updateStats();
                    filterTable();
                    showToast('Fahrzeug erfolgreich gel√∂scht (LocalStorage)', 'success');
                }
            } catch (error) {
                console.error('‚ùå [LISTE] Fehler beim L√∂schen:', error);
                showToast('Fehler beim L√∂schen des Fahrzeugs', 'error');
            }
        }

        // PAGINATION CONTROLS
        function updatePaginationControls() {
            const infoElement = document.getElementById('paginationInfo');
            const currentPageElement = document.getElementById('currentPage');
            const firstBtn = document.getElementById('firstPageBtn');
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            const lastBtn = document.getElementById('lastPageBtn');

            const startIndex = (currentPage - 1) * itemsPerPage + 1;
            const endIndex = Math.min(startIndex + itemsPerPage - 1, filteredVehicles.length);

            infoElement.textContent = `${startIndex}-${endIndex} von ${filteredVehicles.length} Fahrzeugen`;
            currentPageElement.textContent = `${currentPage} / ${totalPages}`;

            firstBtn.disabled = currentPage === 1;
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages || totalPages === 0;
            lastBtn.disabled = currentPage === totalPages || totalPages === 0;

            // Re-initialize Feather Icons for pagination buttons
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        }

        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        }

        function goToPage(page) {
            currentPage = page;
            renderTable();
        }

        function goToLastPage() {
            currentPage = totalPages;
            renderTable();
        }

        function changeItemsPerPage() {
            const select = document.getElementById('itemsPerPageSelect');
            itemsPerPage = parseInt(select.value);
            currentPage = 1;
            renderTable();
        }

        // TOAST NOTIFICATION
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <i data-feather="${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'info'}"></i>
                    <span style="flex: 1; font-size: 14px; font-weight: 500; color: var(--color-text-primary);">${message}</span>
                </div>
            `;

            document.getElementById('toastContainer').appendChild(toast);

            if (typeof feather !== 'undefined') {
                feather.replace();
            }

            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease-out forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // GSAP ENTRANCE ANIMATIONS
        function initAnimations() {
            if (typeof gsap === 'undefined') {
                console.warn('‚ö†Ô∏è [LISTE] GSAP nicht geladen - Animationen deaktiviert');
                return;
            }

            // ‚úÖ CONDITIONAL CHECKS - Nur animieren wenn Element existiert!
            let animatedCount = 0;

            // Hero Header (versteckt auf Mobile)
            const heroHeader = document.querySelector('.hero-header');
            if (heroHeader) {
                gsap.from('.hero-header', {
                    opacity: 0,
                    y: -30,
                    duration: 0.6,
                    ease: 'power2.out'
                });
                animatedCount++;
            }

            // Stats Dashboard
            const statsDashboard = document.querySelector('.stats-dashboard');
            if (statsDashboard) {
                gsap.from('.stats-dashboard', {
                    opacity: 0,
                    y: 30,
                    duration: 0.6,
                    delay: 0.1,
                    ease: 'power2.out'
                });
                animatedCount++;
            }

            // Search & Filter Section
            const searchFilter = document.querySelector('.search-filter-section');
            if (searchFilter) {
                gsap.from('.search-filter-section', {
                    opacity: 0,
                    y: 30,
                    duration: 0.6,
                    delay: 0.2,
                    ease: 'power2.out'
                });
                animatedCount++;
            }

            // Table Section
            const tableSection = document.querySelector('.table-section');
            if (tableSection) {
                gsap.from('.table-section', {
                    opacity: 0,
                    y: 30,
                    duration: 0.6,
                    delay: 0.3,
                    ease: 'power2.out'
                });
                animatedCount++;
            }

            console.log(`‚úÖ [LISTE] GSAP Animationen initialisiert (${animatedCount} Elemente animiert)`);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('detailModal');
            if (event.target === modal) {
                closeModal();
            }
        };

        /* ============================================
           üåô THEME TOGGLE - LIGHT/DARK MODE
           ============================================ */

        // Get Theme from LocalStorage or default to 'light'
        const getTheme = () => {
            return localStorage.getItem('theme') || 'light';
        };

        // ‚úÖ UPDATE FEATHER ICONS STROKE-WIDTH (KONSISTENT MIT index.html)
        const updateFeatherIcons = (theme) => {
            const strokeWidth = theme === 'light' ? '2.5' : '2';

            // Update all Feather Icons SVGs
            document.querySelectorAll('i[data-feather]').forEach(icon => {
                const svg = icon.querySelector('svg');
                if (svg) {
                    // Update stroke-width on all paths and shapes
                    svg.querySelectorAll('*[stroke]').forEach(element => {
                        element.setAttribute('stroke-width', strokeWidth);
                    });
                }
            });

            console.log(`üé® [LISTE] Feather Icons stroke-width updated to ${strokeWidth} for ${theme} mode`);
        };

        // Initialize Theme on Page Load
        document.addEventListener('DOMContentLoaded', () => {
            const html = document.documentElement;
            const themeToggle = document.getElementById('themeToggle'); // ‚úÖ Neues ID!

            // Initialize theme (default: light)
            let currentTheme = localStorage.getItem('theme') || 'light';
            html.setAttribute('data-theme', currentTheme);
            console.log(`üåì [LISTE] Theme initialized: ${currentTheme}`);

            // Toggle theme on button click
            if (themeToggle) {
                const themeToggleHandler = () => {
                    currentTheme = currentTheme === 'light' ? 'dark' : 'light';
                    html.setAttribute('data-theme', currentTheme);
                    localStorage.setItem('theme', currentTheme);

                    console.log(`üåì [LISTE] Theme switched to: ${currentTheme}`);

                    // Re-initialize Feather Icons for theme change
                    if (typeof feather !== 'undefined') {
                        feather.replace();
                        // Wait for feather.replace() to finish, then update stroke-width
                        setTimeout(() => updateFeatherIcons(currentTheme), 50);
                    }
                };
                window.listenerRegistry.registerDOM(themeToggle, 'click', themeToggleHandler, 'Theme Toggle Button');
            }

            // Initialize Feather Icons on load
            if (typeof feather !== 'undefined') {
                feather.replace();
                // Wait for feather.replace() to finish, then update stroke-width
                setTimeout(() => {
                    updateFeatherIcons(currentTheme);
                    console.log('‚úÖ [LISTE] Feather Icons initialized');
                }, 50);
            }

            console.log('‚úÖ [LISTE] Theme System initialized');
        });
    </script>

    <!-- KI-Chat-Assistent -->
    <div id="aiChatWidget"></div>
    <script src="js/ai-agent-tools.js"></script>
    <script src="js/ai-agent-engine.js"></script>
    <script src="js/ai-chat-widget.js"></script>

    <!-- ============================================
         SERVICE WORKER REGISTRATION - Offline-Funktionalit√§t
         ============================================ -->
    <script>
        // Service Worker nur registrieren wenn:
        // 1. Browser unterst√ºtzt Service Worker
        // 2. NICHT in Playwright Tests (navigator.webdriver)
        // 3. NICHT auf Emulator-Port (8000)
        if ('serviceWorker' in navigator && !navigator.webdriver && window.location.port !== '8000') {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('./sw.js', {
                        scope: './'
                    });

                    console.log('‚úÖ [SW] Service Worker registriert:', registration.scope);

                    // Update-Handling: Neuen SW aktivieren wenn gefunden
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('üîÑ [SW] Update gefunden, installiere...');

                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                console.log('‚úÖ [SW] Update bereit! Seite neu laden f√ºr neue Version.');

                                // Optional: Auto-reload nach 3 Sekunden
                                // setTimeout(() => window.location.reload(), 3000);
                            }
                        });
                    });

                } catch (error) {
                    console.error('‚ùå [SW] Registrierung fehlgeschlagen:', error);
                }
            });
        } else {
            console.log('‚ÑπÔ∏è [SW] Service Worker nicht registriert (Test-Modus oder nicht unterst√ºtzt)');
        }
    </script>
</body>
</html>
