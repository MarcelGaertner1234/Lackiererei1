<!DOCTYPE html>
<html lang="de">
<head>
    <!-- werkstattId will be set dynamically by auth-manager.js after login -->
    <script>
        // window.werkstattId is set automatically after successful login
        // This ensures proper multi-tenant data isolation
    </script>
    <script>
        // BUGFIX 2025-11-04: Pre-initialize werkstattId from localStorage
        // Fixes: werkstattId undefined error (regression from commit 35ae4eb - Nov 3 multi-tenant fix)
        // Pattern: Same as partner-app files (meine-anfragen.html, auto-login.html, etc.)
        const storedWerkstatt = localStorage.getItem('werkstattId');
        if (storedWerkstatt) {
            window.werkstattId = storedWerkstatt;
            console.log('‚úÖ [LISTE-PRELOAD] werkstattId pre-initialized from localStorage:', window.werkstattId);
        } else {
            console.warn('‚ö†Ô∏è [LISTE-PRELOAD] No werkstattId in localStorage - user must login first');
        }
    </script>

    <!-- üåì FOUC Prevention: Load Theme BEFORE CSS to prevent flash -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            console.log(`üåì Theme pre-loaded in <head>: ${savedTheme} (FOUC Prevention)`);
        })();
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fahrzeug-√úbersicht | Auto-Lackierzentrum Mosbach</title>

    <!-- Aggressive No-Cache Headers (Cache-Fix f√ºr v=a4192c4) -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>

    <!-- Firebase Config -->
    <script src="firebase-config.js?v=8652b32"></script>

    <!-- Error Handler & Toast Notifications -->
    <script src="error-handler.js"></script>

    <!-- Listener Registry - Memory Leak Prevention -->
    <script src="listener-registry.js"></script>

    <!-- Auth Manager f√ºr Multi-Tenant Support -->
    <script src="js/auth-manager.js"></script>
    <script src="js/settings-manager.js"></script>

    <!-- Event System f√ºr Real-Time Updates (Phase 3) -->
    <script src="js/app-events.js"></script>

    <!-- Design System -->
    <link rel="stylesheet" href="design-system.css?v=af6b90f">
    <link rel="stylesheet" href="components.css?v=af6b90f">
    <link rel="stylesheet" href="animations.css?v=af6b90f">
    <link rel="stylesheet" href="mobile-first.css?v=af6b90f">
    <link rel="stylesheet" href="css/skeleton.css"> <!-- üÜï Skeleton Loaders -->
    <link rel="stylesheet" href="css/ai-chat-widget.css">
    <link rel="stylesheet" href="css/quota-display.css">

    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>

    <!-- GSAP Animation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <style>
        /* ============================================
           DARK GLASS - LISTE.HTML
           Auto-Lackierzentrum Mosbach
           Version: 1.0 Dark Mode
           ============================================ */

        /* ===== BODY - LIGHT MODE (Default) ===== */
        body {
            font-family: 'SF Pro Display', 'Inter', var(--font-system); /* ‚úÖ Konsistent mit index.html */
            /* üé® Light Mode - Heller Gradient */
            background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
            color: rgba(0, 0, 0, 0.9); /* Dark Text for Light Mode */
            overflow-x: hidden;
            position: relative;
            transition: background 0.3s ease, color 0.3s ease;
        }

        /* ===== BODY - DARK MODE ===== */
        [data-theme="dark"] body {
            /* üé® RADIAL GRADIENT (OLED-optimiert) + Aurora Animation */
            background-image:
                radial-gradient(
                    ellipse at 20% 20%,
                    rgba(0, 191, 255, 0.08) 0%,
                    transparent 50%
                ),
                var(--gradient-dark-bg);
            background-size: 200% 200%, 100% 100%;
            animation: aurora-shift 30s ease-in-out infinite;
            color: var(--color-text-primary);
        }

        @keyframes aurora-shift {
            0% { background-position: 0% 0%, 0% 0%; }
            50% { background-position: 100% 100%, 0% 0%; }
            100% { background-position: 0% 0%, 0% 0%; }
        }

        /* ACCENT-LIGHT - THEME-AWARE (‚úÖ Konsistent mit index.html) */
        .accent-light {
            content: '';
            position: fixed;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            /* ‚úÖ THEME-AWARE: Golden Glow (Light) / Cyan Glow (Dark) */
            background: radial-gradient(circle, var(--accent-light-color) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
            animation: pulse 8s ease-in-out infinite;
            /* GPU-Acceleration f√ºr smooth Parallax */
            transform: translate3d(0, 0, 0);
            will-change: transform;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }  /* ‚úÖ Konsistent mit index.html */
            50% { opacity: 0.8; }
        }

        /* ============================================
           üé® PAGE TRANSITION OVERLAY (‚úÖ Konsistent mit index.html)
           Blur-Overlay beim Seitenwechsel
           ============================================ */
        .page-transition-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: rgba(11, 11, 12, 0.4);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-out;
        }

        .page-transition-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        /* ============================================
           üåô THEME TOGGLE BUTTON (‚úÖ Konsistent mit index.html)
           Fixed Position - Dual-Icon System - Fancy Animations
           ============================================ */
        .theme-toggle {
            position: fixed;
            top: var(--space-4);
            right: var(--space-4);
            z-index: 10000; /* Above everything */
            width: 56px;
            height: 56px;
            border-radius: var(--radius-full);
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            box-shadow: var(--shadow-lg), inset 0 1px 1px rgba(255,255,255,0.1);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            border: none;
        }

        .theme-toggle:hover {
            transform: scale(1.1) rotate(15deg);  /* ‚úÖ Fancy Animation! */
            box-shadow: var(--shadow-xl), inset 0 1px 1px rgba(255,255,255,0.2);
        }

        .theme-toggle:active {
            transform: scale(0.95);
        }

        .theme-toggle__icon {
            position: absolute;
            width: 24px;
            height: 24px;
            color: var(--color-text-primary);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        /* Show sun icon in dark mode, moon in light mode */
        [data-theme="dark"] .theme-toggle__icon--light {
            opacity: 1;
            transform: rotate(0deg) scale(1);
        }

        [data-theme="dark"] .theme-toggle__icon--dark {
            opacity: 0;
            transform: rotate(180deg) scale(0);
        }

        :root .theme-toggle__icon--light,
        [data-theme="light"] .theme-toggle__icon--light {
            opacity: 0;
            transform: rotate(-180deg) scale(0);
        }

        :root .theme-toggle__icon--dark,
        [data-theme="light"] .theme-toggle__icon--dark {
            opacity: 1;
            transform: rotate(0deg) scale(1);
        }

        /* Mobile: Smaller toggle button */
        @media (max-width: 768px) {
            .theme-toggle {
                width: 48px;
                height: 48px;
                top: var(--space-3);
                right: var(--space-3);
            }

            .theme-toggle__icon {
                width: 20px;
                height: 20px;
            }
        }

        /* MAIN CONTAINER */
        .main-container {
            position: relative;
            z-index: 1;
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-6);
            padding-bottom: 100px; /* Space for bottom nav */
        }

        /* HERO HEADER - Glass Container */
        .hero-header {
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-lg), inset 0 1px 1px rgba(255,255,255,0.15);
            padding: var(--space-8);
            margin-bottom: var(--space-6);
            text-align: center;
        }

        .hero-header__icon {
            width: 80px;
            height: 80px;
            background: rgba(0, 191, 255, 0.15);
            border-radius: var(--radius-2xl);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto var(--space-4);
            border: 1px solid rgba(0, 191, 255, 0.3);
        }

        .hero-header__icon i {
            color: var(--color-primary);
            width: 48px;
            height: 48px;
        }

        .hero-header h1 {
            font-size: clamp(24px, 5vw, 36px);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin-bottom: var(--space-2);
            letter-spacing: -0.02em;
        }

        .hero-header p {
            font-size: var(--font-size-base);
            color: var(--color-text-secondary);
            margin: 0;
        }

        /* STATS DASHBOARD - Glass Cards */
        .stats-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }

        .stat-card {
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md), inset 0 1px 1px rgba(255,255,255,0.1);
            padding: var(--space-5);
            text-align: center;
            transition: all var(--duration-base) var(--ease-out);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--color-border);
        }

        .stat-card__icon {
            width: 48px;
            height: 48px;
            margin: 0 auto var(--space-3);
            background: rgba(0, 191, 255, 0.1);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-card__icon i {
            color: var(--color-primary);
            width: 24px;
            height: 24px;
        }

        .stat-card__value {
            font-size: var(--font-size-3xl);
            font-weight: var(--font-weight-bold);
            color: var(--color-primary);
            margin-bottom: var(--space-1);
            line-height: 1;
        }

        .stat-card__label {
            font-size: var(--font-size-xs);
            color: var(--color-text-secondary);
            font-weight: var(--font-weight-semibold);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* SEARCH & FILTER SECTION - Glass Container */
        .search-filter-section {
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md), inset 0 1px 1px rgba(255,255,255,0.1);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
        }

        .search-filter-section h3 {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin-bottom: var(--space-4);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .search-filter-section h3 i {
            width: 20px;
            height: 20px;
            color: var(--color-primary);
        }

        /* SEARCH BOX - Glass Input */
        .search-box {
            margin-bottom: var(--space-4);
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: var(--space-3) var(--space-4) var(--space-3) var(--space-10);
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            font-size: var(--font-size-base);
            color: var(--color-text-primary);
            font-family: var(--font-system);
            transition: all var(--duration-base) var(--ease-out);
        }

        .search-box input::placeholder {
            color: var(--color-text-tertiary);
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(0, 191, 255, 0.1);
            background: rgba(255, 255, 255, 0.08);
        }

        .search-box i {
            position: absolute;
            left: var(--space-4);
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-text-tertiary);
            width: 20px;
            height: 20px;
            pointer-events: none;
        }

        /* FILTER BUTTONS - Glass Pills */
        .filter-group {
            margin-bottom: var(--space-3);
        }

        .filter-group__label {
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-secondary);
            margin-bottom: var(--space-2);
            display: block;
        }

        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-2);
        }

        .filter-btn {
            padding: var(--space-2) var(--space-4);
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid var(--color-border);
            color: var(--color-text-primary);
            border-radius: var(--radius-full);
            cursor: pointer;
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            font-family: var(--font-system);
            transition: all var(--duration-base) var(--ease-out);
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
        }

        .filter-btn i {
            width: 16px;
            height: 16px;
        }

        .filter-btn:hover {
            border-color: var(--color-primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
            background: rgba(255, 255, 255, 0.08);
        }

        .filter-btn.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
            box-shadow: 0 0 20px rgba(0, 191, 255, 0.3);
        }

        /* TABLE SECTION - Glass Container */
        .table-section {
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg), inset 0 1px 1px rgba(255,255,255,0.1);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
            overflow: hidden;
        }

        .table-section h3 {
            font-size: var(--font-size-lg);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            margin-bottom: var(--space-4);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .table-section h3 i {
            width: 20px;
            height: 20px;
            color: var(--color-primary);
        }

        /* TABLE WRAPPER - Scrollable */
        .table-wrapper {
            overflow-x: auto;
            border-radius: var(--radius-lg);
            background: rgba(255, 255, 255, 0.02);
        }

        .table-wrapper::-webkit-scrollbar {
            height: 8px;
        }

        .table-wrapper::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-full);
        }

        .table-wrapper::-webkit-scrollbar-thumb {
            background: var(--color-primary);
            border-radius: var(--radius-full);
        }

        .table-wrapper::-webkit-scrollbar-thumb:hover {
            background: var(--color-primary-hover);
        }

        /* TABLE */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: var(--font-size-sm);
        }

        table thead {
            background: rgba(0, 191, 255, 0.15);
            border-bottom: 1px solid var(--color-border);
        }

        table th {
            padding: var(--space-4);
            text-align: left;
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            cursor: pointer;
            user-select: none;
            transition: all var(--duration-base) var(--ease-out);
            white-space: nowrap;
            position: relative;
        }

        table th:hover {
            background: rgba(0, 191, 255, 0.25);
        }

        table th.sortable::after {
            content: ' ‚óÜ';
            font-size: 10px;
            opacity: 0.4;
            margin-left: var(--space-1);
            color: var(--color-text-tertiary);
        }

        table th.sortable.asc::after {
            content: ' ‚ñ≤';
            opacity: 1;
            color: var(--color-primary);
        }

        table th.sortable.desc::after {
            content: ' ‚ñº';
            opacity: 1;
            color: var(--color-primary);
        }

        table tbody tr {
            border-bottom: 1px solid var(--color-border-light);
            transition: all var(--duration-base) var(--ease-out);
        }

        table tbody tr:hover {
            background: rgba(0, 191, 255, 0.05);
            transform: scale(1.002);
        }

        table tbody tr:last-child {
            border-bottom: none;
        }

        table td {
            padding: var(--space-4);
            color: var(--color-text-primary);
            vertical-align: middle;
        }

        /* STATUS BADGES - With Icons */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-1) var(--space-3);
            border-radius: var(--radius-full);
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            white-space: nowrap;
        }

        .status-badge i {
            width: 14px;
            height: 14px;
        }

        /* Status: Neu/Wartend - Gray */
        .status-neu,
        .status-angenommen,
        .status-terminiert {
            background: rgba(142, 142, 147, 0.2);
            color: var(--color-text-secondary);
            border: 1px solid rgba(142, 142, 147, 0.3);
        }

        /* Status: In Arbeit - Blue */
        .status-vorbereitung,
        .status-lackierung,
        .status-in_arbeit,
        .status-bestellung,
        .status-angekommen,
        .status-montage,
        .status-wuchten,
        .status-diagnose,
        .status-pruefung,
        .status-in_pruefung,
        .status-angebot,
        .status-beauftragt,
        .status-reparatur,
        .status-in_reparatur,
        .status-test,
        .status-termin,
        .status-termin_bestaetigt,
        .status-termin_gebucht,
        .status-aufbereitung,
        .status-trocknung {
            background: rgba(0, 191, 255, 0.2);
            color: var(--color-primary);
            border: 1px solid rgba(0, 191, 255, 0.3);
        }

        /* Status: Bereit/Fertig - Green */
        .status-bereit,
        .status-fertig,
        .status-abholbereit,
        .status-abgeschlossen,
        .status-freigabe {
            background: rgba(50, 215, 75, 0.2);
            color: var(--color-success);
            border: 1px solid rgba(50, 215, 75, 0.3);
        }

        /* Status: Qualit√§tskontrolle - Orange */
        .status-qualitaetskontrolle,
        .status-qualitaet,
        .status-gutachten {
            background: rgba(255, 149, 0, 0.2);
            color: var(--color-warning);
            border: 1px solid rgba(255, 149, 0, 0.3);
        }

        /* ACTION BUTTONS - With Icons */
        .action-buttons {
            display: flex;
            gap: var(--space-2);
        }

        .btn-action {
            padding: var(--space-2) var(--space-3);
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
            transition: all var(--duration-base) var(--ease-out);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            min-width: 80px;
            justify-content: center;
        }

        .btn-action i {
            width: 14px;
            height: 14px;
        }

        .btn-view {
            background: rgba(0, 191, 255, 0.15);
            color: var(--color-primary);
            border: 1px solid rgba(0, 191, 255, 0.3);
        }

        .btn-view:hover {
            background: rgba(0, 191, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .btn-edit {
            background: rgba(255, 149, 0, 0.15);
            color: var(--color-warning);
            border: 1px solid rgba(255, 149, 0, 0.3);
        }

        .btn-edit:hover {
            background: rgba(255, 149, 0, 0.3);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .btn-delete {
            background: rgba(255, 59, 48, 0.15);
            color: var(--color-error);
            border: 1px solid rgba(255, 59, 48, 0.3);
        }

        .btn-delete:hover {
            background: rgba(255, 59, 48, 0.3);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        /* TOGGLE BUTTONS - Payment & Invoice Status */
        .btn-toggle {
            padding: var(--space-2) var(--space-3);
            border: none;
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-semibold);
            transition: all var(--duration-base) var(--ease-out);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            min-width: 100px;
            justify-content: center;
        }

        .btn-toggle i {
            width: 14px;
            height: 14px;
        }

        .btn-toggle-success {
            background: rgba(52, 199, 89, 0.15);
            color: #34c759;
            border: 1px solid rgba(52, 199, 89, 0.3);
        }

        .btn-toggle-success:hover {
            background: rgba(52, 199, 89, 0.25);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .btn-toggle-secondary {
            background: rgba(142, 142, 147, 0.15);
            color: var(--color-text-secondary);
            border: 1px solid rgba(142, 142, 147, 0.3);
        }

        .btn-toggle-secondary:hover {
            background: rgba(142, 142, 147, 0.25);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        /* üõ°Ô∏è PERFORMANCE FIX Phase 1.2: "Alle laden" Banner */
        .load-more-banner {
            display: none;
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.15) 0%, rgba(255, 152, 0, 0.15) 100%);
            border: 1px solid rgba(255, 193, 7, 0.4);
            border-radius: var(--radius-lg);
            padding: var(--space-3) var(--space-4);
            margin-bottom: var(--space-4);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }

        .load-more-content {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            flex-wrap: wrap;
        }

        .load-more-content i {
            color: #ffc107;
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .load-more-content span {
            color: var(--color-text-primary);
            font-size: var(--font-size-sm);
            flex: 1;
            min-width: 200px;
        }

        .load-more-content .btn-sm {
            padding: var(--space-2) var(--space-3);
            font-size: var(--font-size-xs);
            flex-shrink: 0;
        }

        [data-theme="dark"] .load-more-banner {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 152, 0, 0.1) 100%);
            border-color: rgba(255, 193, 7, 0.3);
        }

        /* PAGINATION - Glass Container */
        .pagination-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--space-4);
            margin-top: var(--space-6);
            padding: var(--space-4);
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            flex-wrap: wrap;
        }

        .pagination-info {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            font-weight: var(--font-weight-medium);
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .pagination-btn {
            padding: var(--space-2) var(--space-4);
            background: rgba(0, 191, 255, 0.15);
            color: var(--color-primary);
            border: 1px solid rgba(0, 191, 255, 0.3);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            transition: all var(--duration-base) var(--ease-out);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
        }

        .pagination-btn i {
            width: 16px;
            height: 16px;
        }

        .pagination-btn:hover:not(:disabled) {
            background: rgba(0, 191, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        .pagination-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .pagination-current {
            padding: var(--space-2) var(--space-4);
            background: var(--color-primary);
            color: white;
            border-radius: var(--radius-md);
            font-weight: var(--font-weight-bold);
            font-size: var(--font-size-sm);
        }

        .pagination-select {
            padding: var(--space-2) var(--space-3);
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-primary);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            cursor: pointer;
            transition: all var(--duration-base) var(--ease-out);
        }

        .pagination-select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(0, 191, 255, 0.1);
        }

        /* MODAL - Dark Glass Overlay */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: var(--z-modal);
            background: rgba(11, 11, 12, 0.8);
            backdrop-filter: blur(var(--glass-blur));
            -webkit-backdrop-filter: blur(var(--glass-blur));
            align-items: center;
            justify-content: center;
            padding: var(--space-6);
            animation: fadeIn 0.3s ease-out;
        }

        .modal.show {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--color-surface-elevated);
            backdrop-filter: blur(var(--glass-blur-strong)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur-strong)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-2xl);
            padding: var(--space-8);
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-6);
            padding-bottom: var(--space-4);
            border-bottom: 1px solid var(--color-border);
        }

        .modal-header h2 {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .modal-header h2 i {
            width: 28px;
            height: 28px;
            color: var(--color-primary);
        }

        .close-btn {
            background: rgba(255, 59, 48, 0.15);
            border: 1px solid rgba(255, 59, 48, 0.3);
            color: var(--color-error);
            border-radius: var(--radius-full);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
            line-height: 1;
            transition: all var(--duration-base) var(--ease-out);
        }

        .close-btn:hover {
            background: rgba(255, 59, 48, 0.3);
            transform: scale(1.1);
        }

        .detail-row {
            margin-bottom: var(--space-4);
            padding: var(--space-3);
            background: rgba(255, 255, 255, 0.02);
            border-radius: var(--radius-md);
            border: 1px solid var(--color-border-light);
        }

        .detail-row strong {
            display: block;
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-secondary);
            margin-bottom: var(--space-1);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .detail-row span {
            font-size: var(--font-size-base);
            color: var(--color-text-primary);
        }

        .photo-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: var(--space-3);
            margin-top: var(--space-2);
        }

        .photo-gallery img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
            cursor: pointer;
            transition: all var(--duration-base) var(--ease-out);
        }

        .photo-gallery img:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-lg);
        }

        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: var(--space-16) var(--space-8);
            color: var(--color-text-tertiary);
        }

        .empty-state i {
            width: 64px;
            height: 64px;
            color: var(--color-text-tertiary);
            margin-bottom: var(--space-4);
        }

        .empty-state h3 {
            font-size: var(--font-size-2xl);
            font-weight: var(--font-weight-semibold);
            color: var(--color-text-secondary);
            margin-bottom: var(--space-2);
        }

        .empty-state p {
            font-size: var(--font-size-base);
            color: var(--color-text-tertiary);
        }

        /* BOTTOM NAVIGATION - Glass */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: var(--z-fixed);
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur-strong)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur-strong)) saturate(var(--glass-saturation));
            border-top: 1px solid var(--color-border-glass);
            box-shadow: 0 -4px 24px rgba(0,0,0,0.3);
            padding: var(--space-2) 0;
            display: flex;
            justify-content: space-around;
            align-items: center;
        }

        .bottom-nav__item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-2) var(--space-3);
            color: var(--color-text-secondary);
            text-decoration: none;
            transition: all var(--duration-base) var(--ease-out);
            border-radius: var(--radius-md);
            min-width: 70px;
        }

        .bottom-nav__item i {
            width: 24px;
            height: 24px;
        }

        .bottom-nav__item span {
            font-size: var(--font-size-xs);
            font-weight: var(--font-weight-medium);
        }

        .bottom-nav__item:hover {
            color: var(--color-text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .bottom-nav__item.active {
            color: var(--color-primary);
            background: rgba(0, 191, 255, 0.1);
        }

        /* ============================================
           LIGHT MODE OVERRIDES - Glassmorphismus Deaktivieren
           ‚úÖ KONSISTENT MIT index.html
           ============================================ */

        /* ‚úÖ GLASSMORPHISMUS F√úR LIGHT MODE DEAKTIVIEREN */
        [data-theme="light"] .hero-header,
        [data-theme="light"] .stat-card,
        [data-theme="light"] .search-filter-section,
        [data-theme="light"] .table-section,
        [data-theme="light"] .bottom-nav {
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            background: rgba(255, 255, 255, 1.0) !important; /* ‚úÖ KOMPLETT OPAK! */
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.12) !important; /* Schatten f√ºr Tiefe */
        }

        /* Hero Header - Stronger Text + Text-Shadow */
        [data-theme="light"] .hero-header h1 {
            color: #000000;
            font-weight: var(--font-weight-semibold);
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
        }

        [data-theme="light"] .hero-header p {
            color: rgba(0, 0, 0, 0.75);
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.3);
        }

        [data-theme="light"] .hero-header__icon i {
            color: rgba(0, 0, 0, 0.85);
            stroke-width: 2.5;
        }

        /* Stat Cards - Darker Icons + Stronger Text */
        [data-theme="light"] .stat-card__icon i {
            color: rgba(0, 0, 0, 0.85);
            stroke-width: 2.5;
        }

        [data-theme="light"] .stat-card__value {
            color: var(--color-primary);
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
        }

        [data-theme="light"] .stat-card__label {
            color: rgba(0, 0, 0, 0.65);
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.3);
        }

        /* Search & Filter Section - Stronger Text */
        [data-theme="light"] .search-filter-section h3 {
            color: #000000;
            font-weight: var(--font-weight-semibold);
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
        }

        [data-theme="light"] .search-filter-section h3 i {
            color: rgba(0, 0, 0, 0.85);
            stroke-width: 2.5;
        }

        /* Table Section - Stronger Text */
        [data-theme="light"] .table-section h3 {
            color: #000000;
            font-weight: var(--font-weight-semibold);
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
        }

        [data-theme="light"] table th {
            color: #000000;
            font-weight: var(--font-weight-semibold);
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.3);
        }

        [data-theme="light"] table td {
            color: rgba(0, 0, 0, 0.85);
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.2);
        }

        /* Status Badges - Colored Backgrounds for Light Mode */
        [data-theme="light"] .status-badge.status-pending {
            background: rgba(255, 149, 0, 0.15);
            color: #8c5700;
            border-color: rgba(255, 149, 0, 0.4);
            font-weight: var(--font-weight-semibold);
        }

        [data-theme="light"] .status-badge.status-in-process {
            background: rgba(0, 122, 255, 0.15);
            color: #0051a0;
            border-color: rgba(0, 122, 255, 0.4);
            font-weight: var(--font-weight-semibold);
        }

        [data-theme="light"] .status-badge.status-completed {
            background: rgba(52, 199, 89, 0.15);
            color: #1b7e34;
            border-color: rgba(52, 199, 89, 0.4);
            font-weight: var(--font-weight-semibold);
        }

        /* Bottom Nav - Stronger Text + Opaque */
        [data-theme="light"] .bottom-nav {
            background: rgba(255, 255, 255, 1.0) !important;
            box-shadow: 0 -2px 12px rgba(0, 0, 0, 0.12) !important;
        }

        [data-theme="light"] .bottom-nav__item {
            color: rgba(0, 0, 0, 0.75);
        }

        [data-theme="light"] .bottom-nav__item.active {
            color: var(--color-primary);
            font-weight: var(--font-weight-semibold);
            background: rgba(0, 122, 255, 0.12);
        }

        [data-theme="light"] .bottom-nav__item.active i {
            stroke-width: 2.5;
        }

        [data-theme="light"] .bottom-nav__label {
            text-shadow: 0 1px 1px rgba(255, 255, 255, 0.5);
        }

        /* ============================================
           DARK MODE OVERRIDES - Glass + Text-Readability
           ============================================ */

        /* Table Headers - Dark Mode mit Text-Readability Fixes */
        [data-theme="dark"] table th {
            color: rgba(255, 255, 255, 1.0); /* ‚úÖ Pure White */
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.8),
                         0 0 16px rgba(255, 255, 255, 0.4);
        }

        /* Table Cells - Dark Mode mit Text-Readability Fixes */
        [data-theme="dark"] table td {
            color: rgba(255, 255, 255, 1.0); /* ‚úÖ Pure White */
            text-shadow: 0 0 6px rgba(255, 255, 255, 0.6);
        }

        /* Status Badges - Dark Mode mit Solid Backgrounds */
        [data-theme="dark"] .status-badge {
            background: rgba(0, 0, 0, 0.4);
            padding: 6px 12px;
            border-radius: 6px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            text-shadow: 0 0 6px rgba(255, 255, 255, 0.6);
        }

        /* Hero Header - Dark Mode */
        [data-theme="dark"] .hero-header h1 {
            color: rgba(255, 255, 255, 1.0);
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.8),
                         0 0 16px rgba(255, 255, 255, 0.4);
        }

        [data-theme="dark"] .hero-header p {
            color: rgba(255, 255, 255, 0.65);
            text-shadow: 0 0 6px rgba(255, 255, 255, 0.6);
        }

        /* Stat Cards - Dark Mode Text-Readability */
        [data-theme="dark"] .stat-card__value {
            text-shadow: 0 0 8px var(--glow-primary);
        }

        [data-theme="dark"] .stat-card__label {
            color: rgba(255, 255, 255, 0.65);
            text-shadow: 0 0 6px rgba(255, 255, 255, 0.6);
        }

        /* Search & Filter - Dark Mode */
        [data-theme="dark"] .search-filter-section h3,
        [data-theme="dark"] .table-section h3 {
            color: rgba(255, 255, 255, 1.0);
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.8);
        }

        /* Pagination - Dark Mode Text-Readability */
        [data-theme="dark"] .pagination-info,
        [data-theme="dark"] .page-number {
            color: rgba(255, 255, 255, 1.0);
            text-shadow: 0 0 6px rgba(255, 255, 255, 0.6);
        }

        /* ============================================
           DARK MODE - CONTAINER BACKGROUNDS (CRITICAL FIX!)
           ============================================ */

        /* Hero Header - Dark Mode Container */
        [data-theme="dark"] .hero-header {
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            box-shadow: var(--shadow-lg), inset 0 1px 1px rgba(255,255,255,0.15);
        }

        /* Stat Cards - Dark Mode Container */
        [data-theme="dark"] .stat-card {
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            box-shadow: var(--shadow-md), inset 0 1px 1px rgba(255,255,255,0.1);
        }

        /* Search & Filter Section - Dark Mode Container */
        [data-theme="dark"] .search-filter-section {
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            box-shadow: var(--shadow-md), inset 0 1px 1px rgba(255,255,255,0.1);
        }

        /* Table Section - Dark Mode Container */
        [data-theme="dark"] .table-section {
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            box-shadow: var(--shadow-md), inset 0 1px 1px rgba(255,255,255,0.1);
        }

        /* Table - Dark Mode Backgrounds */
        [data-theme="dark"] table thead {
            background: rgba(0, 191, 255, 0.15);
            border-bottom: 1px solid var(--color-border);
        }

        [data-theme="dark"] table tbody tr:hover {
            background: rgba(0, 191, 255, 0.05);
            transform: scale(1.002);
        }

        [data-theme="dark"] table tbody tr {
            border-bottom: 1px solid var(--color-border-light);
        }

        /* ============================================
           MOBILE HEADER & THEME TOGGLE
           ============================================ */

        /* RESPONSIVE - Mobile */
        @media (max-width: 768px) {
            /* ‚ùå HIDE Desktop Header on Mobile */
            .hero-header {
                display: none;
            }

            /* ‚ùå NO BOTTOM NAV - Remove padding! */
            .main-container {
                padding: var(--space-4);
                padding-bottom: 0; /* ‚úÖ Bottom Nav entfernt! */
                padding-top: var(--space-4); /* Space after mobile header */
            }

            .hero-header__icon {
                width: 60px;
                height: 60px;
            }

            .hero-header__icon i {
                width: 32px;
                height: 32px;
            }

            .hero-header h1 {
                font-size: 24px;
            }

            /* ‚úÖ STATS-DASHBOARD MOBILE OPTIMIZATION - Minimalistisch 2√ó2 Grid */
            .stats-dashboard {
                grid-template-columns: repeat(2, 1fr); /* ‚úÖ Kompakte 2 Spalten */
                gap: var(--space-2);                    /* ‚úÖ Kleiner Gap */
            }

            .stat-card {
                padding: var(--space-3);                /* ‚úÖ Weniger Padding - minimalistisch */
            }

            .stat-card__icon {
                width: 32px;                            /* ‚úÖ Kleine Icons */
                height: 32px;
                margin-bottom: var(--space-2);
            }

            .stat-card__icon i {
                width: 16px;                            /* ‚úÖ Kleine Icon-Gr√∂√üe */
                height: 16px;
            }

            .stat-card__value {
                font-size: var(--font-size-xl);         /* ‚úÖ Kleinere Zahlen - kompakt */
                margin-bottom: var(--space-1);
            }

            .stat-card__label {
                font-size: 10px;                        /* ‚úÖ Sehr klein - minimalistisch */
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }

            .table-section,
            .search-filter-section {
                padding: var(--space-4);
            }

            /* Mobile Table - Horizontal Scroll */
            .table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            table {
                min-width: 900px; /* Force horizontal scroll on small screens */
            }

            /* ‚úÖ PAGINATION MOBILE OPTIMIZATION */
            .pagination-container {
                flex-direction: column;
                align-items: stretch;
                gap: var(--space-3);      /* Spacing zwischen Info, Controls, Select */
                padding: var(--space-3);  /* Kompakteres Padding */
            }

            .pagination-info {
                font-size: 12px;
                text-align: center;
                order: 1; /* Info oben */
            }

            .pagination-controls {
                justify-content: center;
                flex-wrap: wrap;          /* Buttons k√∂nnen umbrechen */
                gap: var(--space-2);      /* Kleinerer Gap zwischen Buttons */
                order: 2; /* Controls in der Mitte */
            }

            .pagination-btn {
                padding: var(--space-2) var(--space-3); /* Kleinere Buttons */
                font-size: 12px;
            }

            /* ‚ùå HIDE "Erste" und "Letzte" Buttons auf Mobile - zu viele Buttons! */
            #firstPageBtn,
            #lastPageBtn {
                display: none; /* Nur Zur√ºck, Nummer, Weiter anzeigen */
            }

            .pagination-current {
                padding: var(--space-2) var(--space-3);
                font-size: 12px;
            }

            .pagination-select {
                width: 100%;  /* Full-width auf Mobile */
                font-size: 12px;
                order: 3; /* Select unten */
            }

            /* ‚úÖ FILTER-BUTTONS MOBILE OPTIMIZATION */
            .filter-btn {
                padding: var(--space-2) var(--space-3); /* ‚úÖ Kompakter */
                font-size: 12px;                         /* ‚úÖ Kleiner */
                white-space: nowrap;                     /* ‚úÖ Kein Text-Wrapping */
            }

            .filter-btn i {
                display: none; /* ‚úÖ Icons ausblenden auf Mobile - spart Platz! */
            }

            /* Status-Filter: 2x2 Grid Layout */
            .filter-group:first-of-type .filter-buttons {
                display: grid;
                grid-template-columns: 1fr 1fr; /* ‚úÖ 2 Spalten */
                gap: var(--space-2);
            }

            /* Kunden-Filter: Full-width gestapelt */
            .filter-group:last-of-type .filter-buttons {
                display: flex;
                flex-direction: column; /* ‚úÖ Vertikal gestapelt */
                gap: var(--space-2);
            }

            .filter-group:last-of-type .filter-btn {
                width: 100%;             /* ‚úÖ Full-width */
                justify-content: center;
            }

            .modal-content {
                padding: var(--space-6);
            }

            .bottom-nav__item span {
                font-size: 10px;
            }
        }

        /* LOADING SPINNER */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 191, 255, 0.2);
            border-top-color: var(--color-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* TOAST NOTIFICATION */
        .toast-container {
            position: fixed;
            top: var(--space-4);
            right: var(--space-4);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .toast {
            background: var(--color-surface-elevated);
            backdrop-filter: blur(var(--glass-blur-strong));
            -webkit-backdrop-filter: blur(var(--glass-blur-strong));
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-lg);
            padding: var(--space-4);
            box-shadow: var(--shadow-xl);
            min-width: 300px;
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .toast.success {
            border-left: 4px solid var(--color-success);
        }

        .toast.error {
            border-left: 4px solid var(--color-error);
        }

        .toast.info {
            border-left: 4px solid var(--color-primary);
        }

        /* ============================================
           üé® UX REDESIGN 2025 - 5 PHASEN
           ============================================ */

        /* ===== PHASE 2: MICRO-INTERACTIONS ===== */

        /* 3D Tilt Effect auf Cards */
        .vehicle-card,
        .header-card,
        .stats-card {
            transform-style: preserve-3d;
            transition: transform 0.15s ease-out, box-shadow 0.3s ease-out;
        }

        .vehicle-card.tilt-active {
            transform: perspective(1000px) rotateX(var(--tilt-x, 0deg)) rotateY(var(--tilt-y, 0deg));
            box-shadow:
                var(--shadow-2xl),
                0 20px 40px rgba(0, 191, 255, 0.15);
        }

        /* Ripple Effect auf Buttons */
        .nav-btn,
        .filter-btn,
        .vehicle-card {
            position: relative;
            overflow: hidden;
        }

        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
            transform: scale(0);
            animation: ripple-animation 0.6s ease-out;
            pointer-events: none;
        }

        @keyframes ripple-animation {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* Enhanced Hover Glow */
        .vehicle-card:hover {
            box-shadow:
                var(--shadow-2xl),
                0 0 30px rgba(0, 191, 255, 0.2);
        }

        [data-theme="light"] .vehicle-card:hover {
            box-shadow:
                0 8px 30px rgba(0, 0, 0, 0.12),
                0 0 20px rgba(0, 122, 255, 0.1);
        }

        /* ===== PHASE 3: MODERN 2025 DESIGN ===== */

        /* Gradient Mesh Background */
        .gradient-mesh {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -3;
            background:
                radial-gradient(ellipse at 20% 20%, rgba(0, 191, 255, 0.15) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(138, 43, 226, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(0, 122, 255, 0.08) 0%, transparent 60%);
            animation: gradient-drift 20s ease-in-out infinite alternate;
        }

        [data-theme="light"] .gradient-mesh {
            background:
                radial-gradient(ellipse at 20% 20%, rgba(0, 122, 255, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(138, 43, 226, 0.05) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(0, 191, 255, 0.06) 0%, transparent 60%);
        }

        @keyframes gradient-drift {
            0% { transform: translate(0, 0) scale(1); }
            100% { transform: translate(-20px, -20px) scale(1.05); }
        }

        /* Noise Texture Overlay */
        .noise-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -2;
            opacity: 0.03;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
        }

        [data-theme="light"] .noise-overlay {
            opacity: 0.02;
        }

        /* Floating Orbs */
        .floating-orb {
            position: fixed;
            border-radius: 50%;
            pointer-events: none;
            z-index: -1;
            filter: blur(60px);
            animation: orb-float 15s ease-in-out infinite;
        }

        .floating-orb--1 {
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(0, 191, 255, 0.2) 0%, transparent 70%);
            top: 10%;
            left: 5%;
            animation-delay: 0s;
        }

        .floating-orb--2 {
            width: 300px;
            height: 300px;
            background: radial-gradient(circle, rgba(138, 43, 226, 0.15) 0%, transparent 70%);
            top: 60%;
            right: 10%;
            animation-delay: -5s;
        }

        .floating-orb--3 {
            width: 250px;
            height: 250px;
            background: radial-gradient(circle, rgba(0, 122, 255, 0.12) 0%, transparent 70%);
            bottom: 20%;
            left: 40%;
            animation-delay: -10s;
        }

        @keyframes orb-float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(30px, -20px) scale(1.05); }
            50% { transform: translate(-20px, 30px) scale(0.95); }
            75% { transform: translate(20px, 20px) scale(1.02); }
        }

        [data-theme="light"] .floating-orb--1 {
            background: radial-gradient(circle, rgba(0, 122, 255, 0.1) 0%, transparent 70%);
        }

        [data-theme="light"] .floating-orb--2 {
            background: radial-gradient(circle, rgba(138, 43, 226, 0.08) 0%, transparent 70%);
        }

        [data-theme="light"] .floating-orb--3 {
            background: radial-gradient(circle, rgba(0, 191, 255, 0.06) 0%, transparent 70%);
        }

        /* ===== PHASE 4: LIGHT MODE OVERHAUL ===== */

        [data-theme="light"] .header-card,
        [data-theme="light"] .filter-container {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.08);
            box-shadow:
                0 4px 20px rgba(0, 0, 0, 0.06),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
        }

        [data-theme="light"] .vehicle-card {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0, 0, 0, 0.06);
            box-shadow:
                0 2px 12px rgba(0, 0, 0, 0.06),
                inset 0 1px 0 rgba(255, 255, 255, 1);
        }

        [data-theme="light"] .nav-btn {
            background: linear-gradient(135deg, rgba(0, 122, 255, 0.9), rgba(0, 100, 220, 0.85)) !important;
            box-shadow: 0 2px 10px rgba(0, 122, 255, 0.25);
        }

        [data-theme="light"] .nav-btn:hover {
            box-shadow: 0 4px 15px rgba(0, 122, 255, 0.35);
        }

        /* üåô DARK MODE FORM FIELDS (HOTFIX) */
        .filter-input,
        .filter-select,
        input[type="search"],
        input[type="text"],
        select {
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid rgba(255, 255, 255, 0.15);
            color: var(--color-text-primary);
            border-radius: var(--radius-md);
            transition: all var(--duration-base) var(--ease-out);
        }

        .filter-input:focus,
        .filter-select:focus,
        input[type="search"]:focus,
        input[type="text"]:focus,
        select:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(0, 191, 255, 0.2);
            outline: none;
        }

        /* ‚òÄÔ∏è LIGHT MODE FORM FIELDS (Override) */
        [data-theme="light"] .filter-input,
        [data-theme="light"] .filter-select,
        [data-theme="light"] input[type="search"],
        [data-theme="light"] input[type="text"],
        [data-theme="light"] select {
            background: #ffffff;
            border: 2px solid rgba(0, 0, 0, 0.1);
            color: #1a1a2e;
        }

        [data-theme="light"] .filter-input:focus,
        [data-theme="light"] .filter-select:focus,
        [data-theme="light"] input[type="search"]:focus,
        [data-theme="light"] input[type="text"]:focus,
        [data-theme="light"] select:focus {
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.15);
        }

        /* ===== PHASE 5: MOBILE POLISH ===== */

        /* Scroll Animations */
        .scroll-reveal {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }

        .scroll-reveal.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Enhanced Touch Feedback */
        @media (hover: none) and (pointer: coarse) {
            .vehicle-card:active,
            .nav-btn:active {
                transform: scale(0.97);
                transition: transform 0.1s ease-out;
            }
        }

        /* Larger Touch Targets on Mobile */
        @media (max-width: 768px) {
            .nav-btn {
                min-height: 44px;
                min-width: 44px;
            }

            .filter-input,
            .filter-select {
                min-height: 48px;
                font-size: 16px; /* Prevents iOS zoom */
            }

            /* Disable floating orbs on mobile for performance */
            .floating-orb {
                display: none;
            }
        }

        /* Reduced Motion Support */
        @media (prefers-reduced-motion: reduce) {
            .gradient-mesh,
            .floating-orb,
            .vehicle-card,
            .scroll-reveal {
                animation: none !important;
                transition: none !important;
            }
        }

        /* üîô ZUR√úCK-BUTTON (Fixed Position) */
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-4);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-md);
            color: var(--color-text-primary);
            font-weight: 500;
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(-2px);
            border-color: var(--color-primary);
        }

        [data-theme="light"] .back-button {
            background: rgba(255, 255, 255, 0.8);
            border-color: rgba(0, 0, 0, 0.1);
            color: #1a1a2e;
        }

        [data-theme="light"] .back-button:hover {
            background: rgba(255, 255, 255, 0.95);
        }

        @media (max-width: 768px) {
            .back-button {
                top: 10px;
                left: 10px;
                padding: var(--space-2);
            }
            .back-button span {
                display: none;
            }
        }
    </style>

    <!-- Phase 3: Event Listeners for Real-Time UI Updates -->
    <script>
        /**
         * Setup event listeners for AI Agent actions
         * Note: liste.html already has Firestore realtime listeners,
         * so these event listeners mainly provide logging and notifications
         */
        function setupListeEventListeners() {
            // Check if event system is available
            if (!window.appEvents) {
                console.warn('‚ö†Ô∏è [LISTE] Event system not available yet, will retry...');
                // Retry after a short delay
                setTimeout(setupListeEventListeners, 500);
                return;
            }

            console.log('üëÇ [LISTE] Setting up event listeners...');
            console.log('‚ÑπÔ∏è [LISTE] Note: Firestore realtime listener already active, events provide additional logging');

            // Listen for fahrzeug created
            window.appEvents.on('fahrzeugCreated', (data) => {
                console.log('ü§ñ [LISTE] AI created vehicle:', data.fahrzeug.kennzeichen);
                console.log('   ‚Ü≥ Firestore realtime listener will auto-refresh the list');
                // Optional: Show toast notification
                // showToast(`Fahrzeug ${data.fahrzeug.kennzeichen} wurde erstellt`, 'success');
            });

            // Listen for fahrzeug updated
            window.appEvents.on('fahrzeugUpdated', (data) => {
                console.log('ü§ñ [LISTE] AI updated vehicle:', data.vehicleId);
                console.log('   ‚Ü≥ Firestore realtime listener will auto-refresh the list');
                // Optional: Show toast notification
                // showToast(`Fahrzeug wurde aktualisiert`, 'info');
            });

            // Listen for fahrzeug deleted
            window.appEvents.on('fahrzeugDeleted', (data) => {
                console.log('ü§ñ [LISTE] AI deleted vehicle:', data.vehicleId);
                console.log('   ‚Ü≥ Firestore realtime listener will auto-refresh the list');
            });

            console.log('‚úÖ [LISTE] Event listeners registered successfully');
        }

        // Initialize event listeners when page loads
        if (document.readyState === 'loading') {
            window.listenerRegistry.registerDOM(document, 'DOMContentLoaded', setupListeEventListeners, 'document DOMContentLoaded');
        } else {
            // DOM already loaded
            setupListeEventListeners();
        }
    </script>
</head>
<body class="has-ai-features">
    <!-- üé® Modern 2025 Background Effects -->
    <div class="gradient-mesh" aria-hidden="true"></div>
    <div class="noise-overlay" aria-hidden="true"></div>
    <div class="floating-orb floating-orb--1" aria-hidden="true"></div>
    <div class="floating-orb floating-orb--2" aria-hidden="true"></div>
    <div class="floating-orb floating-orb--3" aria-hidden="true"></div>

    <!-- üîô ZUR√úCK-BUTTON -->
    <button class="back-button" onclick="history.back()" title="Zur√ºck">
        <i data-feather="arrow-left"></i>
        <span>Zur√ºck</span>
    </button>

    <!-- ‚úÖ FIXED THEME TOGGLE (Konsistent mit index.html) -->
    <button id="themeToggle" class="theme-toggle" aria-label="Toggle Light/Dark Mode">
        <i data-feather="sun" class="theme-toggle__icon theme-toggle__icon--light"></i>
        <i data-feather="moon" class="theme-toggle__icon theme-toggle__icon--dark"></i>
    </button>

    <!-- ACCENT-LIGHT - Pulsing Glow (Theme-Aware) -->
    <div class="accent-light"></div>

    <!-- PAGE TRANSITION OVERLAY -->
    <div class="page-transition-overlay"></div>

    <!-- TOAST NOTIFICATION CONTAINER -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- MAIN CONTAINER -->
    <div class="main-container">

        <!-- STATS DASHBOARD -->
        <div class="stats-dashboard" id="statsDashboard">
            <!-- Stats will be injected by JavaScript -->
        </div>

        <!-- SEARCH & FILTER SECTION -->
        <div class="search-filter-section">
            <h3>
                <i data-feather="search"></i>
                Suchen & Filtern
            </h3>

            <!-- SEARCH BOX -->
            <div class="search-box">
                <i data-feather="search"></i>
                <input
                    type="text"
                    id="searchInput"
                    placeholder="Suche nach Kennzeichen, Kundenname oder Marke..."
                    oninput="filterTable()">
            </div>

            <!-- FILTER BUTTONS - Status -->
            <div class="filter-group">
                <span class="filter-group__label">Status-Filter</span>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterStatus('all')">
                        <i data-feather="list"></i> Alle
                    </button>
                    <button class="filter-btn" onclick="filterStatus('angenommen')">
                        <i data-feather="clock"></i> Angenommen
                    </button>
                    <button class="filter-btn" onclick="filterStatus('in_arbeit')">
                        <i data-feather="tool"></i> In Arbeit
                    </button>
                    <button class="filter-btn" onclick="filterStatus('abgeschlossen')">
                        <i data-feather="check-circle"></i> Abgeschlossen
                    </button>
                </div>
            </div>

            <!-- FILTER BUTTONS - Kunden -->
            <div class="filter-group">
                <span class="filter-group__label">Kunden-Filter</span>
                <div class="filter-buttons">
                    <button class="filter-btn active" onclick="filterKunden('all')">
                        <i data-feather="users"></i> Alle Kunden
                    </button>
                    <button class="filter-btn" onclick="filterKunden('stammkunden')">
                        <i data-feather="star"></i> Stammkunden
                    </button>
                    <button class="filter-btn" onclick="filterKunden('neukunden')">
                        <i data-feather="user-plus"></i> Neukunden
                    </button>
                </div>
            </div>

            <!-- üÜï FIX (2025-12-01): FILTER BUTTONS - Service-Typ -->
            <div class="filter-group">
                <span class="filter-group__label">Service-Filter</span>
                <div class="filter-buttons" style="flex-wrap: wrap; gap: 6px;">
                    <button class="filter-btn active" onclick="filterService('all')">
                        <i data-feather="grid"></i> Alle
                    </button>
                    <button class="filter-btn" onclick="filterService('lackier')">
                        üé® Lackierung
                    </button>
                    <button class="filter-btn" onclick="filterService('reifen')">
                        üöó Reifen
                    </button>
                    <button class="filter-btn" onclick="filterService('mechanik')">
                        üîß Mechanik
                    </button>
                    <button class="filter-btn" onclick="filterService('tuev')">
                        üìã T√úV
                    </button>
                    <button class="filter-btn" onclick="filterService('glas')">
                        ü™ü Glas
                    </button>
                    <button class="filter-btn" onclick="filterService('pflege')">
                        ‚ú® Pflege
                    </button>
                    <button class="filter-btn" onclick="filterService('versicherung')">
                        üõ°Ô∏è Versicherung
                    </button>
                    <button class="filter-btn" onclick="filterService('klima')">
                        ‚ùÑÔ∏è Klima
                    </button>
                    <button class="filter-btn" onclick="filterService('dellen')">
                        üî® Dellen
                    </button>
                    <button class="filter-btn" onclick="filterService('folierung')">
                        üé≠ Folierung
                    </button>
                    <button class="filter-btn" onclick="filterService('steinschutz')">
                        üõ°Ô∏è Steinschutz
                    </button>
                    <button class="filter-btn" onclick="filterService('werbebeklebung')">
                        üì¢ Werbung
                    </button>
                </div>
            </div>
        </div>

        <!-- TABLE SECTION -->
        <div class="table-section">
            <h3>
                <i data-feather="list"></i>
                Fahrzeugliste
            </h3>

            <div class="table-wrapper">
                <!-- ü¶¥ SKELETON LOADER (shown while loading data) -->
                <div id="tableSkeleton" class="skeleton-table" role="status" aria-live="polite" aria-label="Lade Fahrzeuge...">
                    <!-- Skeleton Row 1 -->
                    <div class="skeleton-table-row skeleton-stagger" style="--row-index: 0">
                        <div class="skeleton skeleton-table-cell"></div>
                        <div class="skeleton skeleton-table-cell"></div>
                        <div class="skeleton skeleton-table-cell"></div>
                        <div class="skeleton skeleton-table-cell"></div>
                    </div>
                    <!-- Skeleton Row 2 -->
                    <div class="skeleton-table-row skeleton-stagger" style="--row-index: 1">
                        <div class="skeleton skeleton-table-cell"></div>
                        <div class="skeleton skeleton-table-cell"></div>
                        <div class="skeleton skeleton-table-cell"></div>
                        <div class="skeleton skeleton-table-cell"></div>
                    </div>
                    <!-- Skeleton Row 3 -->
                    <div class="skeleton-table-row skeleton-stagger" style="--row-index: 2">
                        <div class="skeleton skeleton-table-cell"></div>
                        <div class="skeleton skeleton-table-cell"></div>
                        <div class="skeleton skeleton-table-cell"></div>
                        <div class="skeleton skeleton-table-cell"></div>
                    </div>
                    <!-- Skeleton Row 4 -->
                    <div class="skeleton-table-row skeleton-stagger" style="--row-index: 3">
                        <div class="skeleton skeleton-table-cell"></div>
                        <div class="skeleton skeleton-table-cell"></div>
                        <div class="skeleton skeleton-table-cell"></div>
                        <div class="skeleton skeleton-table-cell"></div>
                    </div>
                    <!-- Skeleton Row 5 -->
                    <div class="skeleton-table-row skeleton-stagger" style="--row-index: 4">
                        <div class="skeleton skeleton-table-cell"></div>
                        <div class="skeleton skeleton-table-cell"></div>
                        <div class="skeleton skeleton-table-cell"></div>
                        <div class="skeleton skeleton-table-cell"></div>
                    </div>
                    <!-- Skeleton Row 6 -->
                    <div class="skeleton-table-row skeleton-stagger" style="--row-index: 5">
                        <div class="skeleton skeleton-table-cell"></div>
                        <div class="skeleton skeleton-table-cell"></div>
                        <div class="skeleton skeleton-table-cell"></div>
                        <div class="skeleton skeleton-table-cell"></div>
                    </div>
                </div>

                <!-- üìã ACTUAL TABLE (hidden until data loaded) -->
                <table id="vehicleTable" style="display: none;">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortTable('kennzeichen')">Kennzeichen</th>
                            <th class="sortable" onclick="sortTable('marke')">Marke / Modell</th>
                            <th class="sortable" onclick="sortTable('kunde')">Kunde</th>
                            <th class="sortable" onclick="sortTable('serviceTyp')">Service</th>
                            <th class="sortable" onclick="sortTable('status')">Status</th>
                            <th class="sortable" onclick="sortTable('datum')">Datum</th>
                            <th class="sortable" onclick="sortTable('bezahlt')">Bezahlt</th>
                            <th class="sortable" onclick="sortTable('rechnungGeschrieben')">Rechnung</th>
                            <th>Aktionen</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <!-- Table rows will be injected by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- PAGINATION -->
            <div class="pagination-container">
                <div class="pagination-info" id="paginationInfo">
                    <!-- Info will be injected by JavaScript -->
                </div>

                <div class="pagination-controls">
                    <button class="pagination-btn" id="firstPageBtn" onclick="goToPage(1)" disabled>
                        <i data-feather="chevrons-left"></i> Erste
                    </button>
                    <button class="pagination-btn" id="prevPageBtn" onclick="prevPage()" disabled>
                        <i data-feather="chevron-left"></i> Zur√ºck
                    </button>
                    <span class="pagination-current" id="currentPage">1</span>
                    <button class="pagination-btn" id="nextPageBtn" onclick="nextPage()">
                        Weiter <i data-feather="chevron-right"></i>
                    </button>
                    <button class="pagination-btn" id="lastPageBtn" onclick="goToLastPage()">
                        Letzte <i data-feather="chevrons-right"></i>
                    </button>
                </div>

                <div>
                    <select class="pagination-select" id="itemsPerPageSelect" onchange="changeItemsPerPage()">
                        <option value="10">10 pro Seite</option>
                        <option value="20" selected>20 pro Seite</option>
                        <option value="50">50 pro Seite</option>
                        <option value="100">100 pro Seite</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL - Vehicle Details -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>
                    <i data-feather="info"></i>
                    Fahrzeug-Details
                </h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody">
                <!-- Details will be injected by JavaScript -->
            </div>
        </div>
    </div>

    <!-- üóëÔ∏è BOTTOM NAVIGATION ENTFERNT - Nur Mobile Header! -->

    <script>
        /* ============================================
           JAVASCRIPT - LISTE.HTML
           Dark Glass Version 1.0
           ============================================ */

        // GLOBAL STATE
        let allVehicles = [];
        let allKunden = [];
        let filteredVehicles = [];
        let currentFilter = 'all';
        let currentKundenFilter = 'all';
        let currentServiceFilter = 'all';  // üÜï FIX (2025-12-01): Service-Filter
        let currentSortColumn = null;
        let currentSortDirection = 'none';
        let currentPage = 1;
        let itemsPerPage = 20;
        let totalPages = 1;
        let firebaseInitialized = false;
        // ‚úÖ firebaseApp wird von firebase-config.js √ºber window.firebaseApp bereitgestellt
        let unsubscribeListener = null;

        // üõ°Ô∏è PERFORMANCE FIX Phase 1.2: Initiales Limit f√ºr schnellere Ladezeit
        const INITIAL_LOAD_LIMIT = 100;  // Initial nur 100 Fahrzeuge laden
        const FULL_LOAD_LIMIT = 500;     // Maximum bei "Alle laden"
        let isFullyLoaded = false;       // Flag ob alle Daten geladen wurden

        // üõ°Ô∏è PERFORMANCE FIX Phase 1.3: Listener-Cleanup f√ºr Memory Leak Prevention
        window.addEventListener('beforeunload', () => {
            if (unsubscribeListener) {
                console.log('üßπ [LISTE] Cleanup: Firestore Listener wird entfernt');
                unsubscribeListener();
                unsubscribeListener = null;
            }
        });

        // INITIALIZE ON LOAD
        window.addEventListener('load', async function() {
            console.log('üöÄ [LISTE] Initialisiere Fahrzeug-√úbersicht...');

            // Initialize Feather Icons
            if (typeof feather !== 'undefined') {
                feather.replace();
            }

            // Initialize Firebase
            try {
                if (typeof initFirebase !== 'undefined') {
                    await initFirebase();

                    if (window.firebaseInitialized && window.firebaseApp) {
                        firebaseApp = window.firebaseApp;
                        firebaseInitialized = true;
                        console.log('‚úÖ [LISTE] Firebase initialisiert');

                        // Auth-Check f√ºr Multi-Tenant Support (Race Condition Fix)
                        console.log('üîê [LISTE] Pr√ºfe Auth State f√ºr Multi-Tenant...');
                        let currentUser = null;
                        let attempts = 0;
                        const maxAttempts = 20;

                        while (!currentUser && attempts < maxAttempts) {
                            currentUser = window.authManager?.getCurrentUser();
                            if (!currentUser) {
                                console.log(`‚è≥ [LISTE] Warte auf Auth State (${attempts + 1}/${maxAttempts})...`);
                                await new Promise(resolve => setTimeout(resolve, 250));
                                attempts++;
                            }
                        }

                        if (!currentUser) {
                            console.warn('‚ö†Ô∏è [LISTE] Kein User eingeloggt - verwende globale Collections');
                        } else {
                            console.log('‚úÖ [LISTE] Auth State geladen');
                            console.log('   User:', currentUser.name);
                            console.log('   WerkstattId:', currentUser.werkstattId);

                            // üÜï BUGFIX 2025-11-04 (FIX #41): Partner-Zugriff auf Werkstatt-Seiten blockieren
                            // Partner d√ºrfen nur das Partner-Portal nutzen, nicht Werkstatt-Seiten
                            const userRole = currentUser.rolle || currentUser.role; // Support both property names
                            if (userRole === 'partner') {
                                console.warn('üö´ Partner-Zugriff blockiert! Redirect zu Partner-Portal...');
                                safeNavigate('./partner-app/meine-anfragen.html');
                                return; // Stop further execution
                            }
                        }

                        // Load Werkstatt Branding (Logo & Page Title)
                        try {
                            const settings = await window.settingsManager.loadSettings();
                            if (settings?.profil) {
                                // Update Page Title
                                document.title = `${settings.profil.name} | Fahrzeugliste`;

                                // Add Logo to Header (if available)
                                if (settings.profil.logoUrl) {
                                    const header = document.querySelector('.page-header h1');
                                    if (header) {
                                        const logoImg = document.createElement('img');
                                        logoImg.src = settings.profil.logoUrl;
                                        logoImg.alt = settings.profil.name;
                                        logoImg.style.cssText = 'height: 32px; width: auto; margin-right: 12px; vertical-align: middle;';
                                        header.insertBefore(logoImg, header.firstChild);
                                    }
                                }

                                console.log('‚úÖ [LISTE] Werkstatt-Branding geladen:', settings.profil.name);
                            }
                        } catch (error) {
                            console.warn('‚ö†Ô∏è [LISTE] Werkstatt-Branding konnte nicht geladen werden:', error);
                        }

                        // Load customers
                        await loadKunden();

                        // Setup realtime listener
                        setupRealtimeListener();
                    } else {
                        console.warn('‚ö†Ô∏è [LISTE] Firebase init fehlgeschlagen, nutze LocalStorage');
                        await loadKunden();
                        loadFromLocalStorage();
                    }
                } else {
                    console.warn('‚ö†Ô∏è [LISTE] Firebase-Config nicht gefunden, nutze LocalStorage');
                    await loadKunden();
                    loadFromLocalStorage();
                }
            } catch (error) {
                console.error('‚ùå [LISTE] Firebase Fehler:', error);
                await loadKunden();
                loadFromLocalStorage();
            }

            // GSAP Entrance Animations
            initAnimations();
        });

        // LOAD CUSTOMERS
        async function loadKunden() {
            try {
                if (firebaseInitialized && firebaseApp && firebaseApp.getAllKunden) {
                    allKunden = await firebaseApp.getAllKunden();
                    console.log(`‚úÖ [LISTE] ${allKunden.length} Kunden aus Firebase geladen`);
                } else {
                    allKunden = JSON.parse(localStorage.getItem('kunden') || '[]');
                    console.log(`‚úÖ [LISTE] ${allKunden.length} Kunden aus LocalStorage geladen`);
                }
            } catch (error) {
                console.error('‚ùå [LISTE] Fehler beim Laden der Kunden:', error);
                allKunden = [];
            }
        }

        // SETUP REALTIME LISTENER (Firebase)
        // üõ°Ô∏è PERFORMANCE FIX Phase 1.2: Optional limit parameter f√ºr initiales Laden
        function setupRealtimeListener(limit = INITIAL_LOAD_LIMIT) {
            if (!firebaseInitialized || !firebaseApp || !firebaseApp.listenToFahrzeuge) {
                console.warn('‚ö†Ô∏è [LISTE] Realtime-Listener nicht verf√ºgbar');
                return;
            }

            // Cleanup vorheriger Listener
            if (unsubscribeListener) {
                unsubscribeListener();
                unsubscribeListener = null;
            }

            console.log(`üîÑ [LISTE] Aktiviere Realtime-Listener (limit: ${limit})...`);

            unsubscribeListener = firebaseApp.listenToFahrzeuge(function(fahrzeuge) {
                console.log(`üî• [LISTE] Realtime Update: ${fahrzeuge.length} Fahrzeuge empfangen (limit: ${limit})`);

                // üõ°Ô∏è DATA RESCUE - Auto-Heal Missing Fields (BUG #13 FIX - 2025-11-24)
                fahrzeuge.forEach(fahrzeug => {
                    // Lazy Loading: Photos are NOT loaded automatically (performance!)
                    fahrzeug.photos = fahrzeug.photos || [];
                    fahrzeug.nachherPhotos = fahrzeug.nachherPhotos || [];

                    // Fix #0: Initialize additionalServices if missing (BUG #13 FIX - 2025-11-24)
                    // üõ°Ô∏è Pattern 62 FIX (2025-11-26): Also handle Object‚ÜíArray conversion
                    // CRITICAL: Firestore sometimes returns Object instead of Array for additionalServices
                    if (!fahrzeug.additionalServices) {
                        console.warn(`üîß DATA RESCUE [LISTE - ${fahrzeug.kennzeichen}]: additionalServices is undefined ‚Üí Initialize to []`);
                        fahrzeug.additionalServices = [];
                    } else if (!Array.isArray(fahrzeug.additionalServices)) {
                        // Pattern 62 FIX: Convert Object ‚Üí Array
                        if (typeof fahrzeug.additionalServices === 'object') {
                            console.warn(`üîß DATA RESCUE [LISTE - ${fahrzeug.kennzeichen}]: additionalServices is Object ‚Üí Convert to Array`);
                            fahrzeug.additionalServices = Object.values(fahrzeug.additionalServices);
                        } else {
                            console.warn(`üîß DATA RESCUE [LISTE - ${fahrzeug.kennzeichen}]: additionalServices invalid type ‚Üí Reset to []`);
                            fahrzeug.additionalServices = [];
                        }
                    }
                });

                allVehicles = fahrzeuge;

                // üõ°Ô∏è PERFORMANCE FIX Phase 1.2: Pr√ºfen ob mehr Daten verf√ºgbar sein k√∂nnten
                if (fahrzeuge.length >= limit && !isFullyLoaded) {
                    showLoadMoreBanner();
                } else {
                    hideLoadMoreBanner();
                    if (fahrzeuge.length >= limit) {
                        isFullyLoaded = true;
                    }
                }

                updateStats();
                filterTable();

                console.log('‚úÖ [LISTE] Tabelle automatisch aktualisiert');
            }, limit);  // üõ°Ô∏è PERFORMANCE FIX Phase 1.2: Limit an Listener √ºbergeben
        }

        // üõ°Ô∏è PERFORMANCE FIX Phase 1.2: "Alle laden" Funktionalit√§t
        function loadAllVehicles() {
            console.log('‚ö° [PERF] Benutzer hat "Alle laden" geklickt - Lade alle Fahrzeuge...');
            isFullyLoaded = true;
            hideLoadMoreBanner();
            setupRealtimeListener(FULL_LOAD_LIMIT);
        }

        function showLoadMoreBanner() {
            let banner = document.getElementById('loadMoreBanner');
            if (!banner) {
                banner = document.createElement('div');
                banner.id = 'loadMoreBanner';
                banner.className = 'load-more-banner';
                banner.innerHTML = `
                    <div class="load-more-content">
                        <i data-feather="alert-circle"></i>
                        <span>Es werden nur die neuesten ${INITIAL_LOAD_LIMIT} Fahrzeuge angezeigt.</span>
                        <button class="btn btn-primary btn-sm" onclick="loadAllVehicles()">
                            <i data-feather="download"></i> Alle laden
                        </button>
                    </div>
                `;
                const tableContainer = document.querySelector('.table-container');
                if (tableContainer) {
                    tableContainer.parentNode.insertBefore(banner, tableContainer);
                    if (typeof feather !== 'undefined') {
                        feather.replace();
                    }
                }
            }
            banner.style.display = 'block';
        }

        function hideLoadMoreBanner() {
            const banner = document.getElementById('loadMoreBanner');
            if (banner) {
                banner.style.display = 'none';
            }
        }

        // LOAD FROM LOCAL STORAGE (Fallback)
        function loadFromLocalStorage() {
            try {
                allVehicles = JSON.parse(localStorage.getItem('fahrzeuge') || '[]');
                console.log(`‚úÖ [LISTE] ${allVehicles.length} Fahrzeuge aus LocalStorage geladen`);
                updateStats();
                filterTable();
            } catch (error) {
                console.error('‚ùå [LISTE] Fehler beim Laden aus LocalStorage:', error);
                allVehicles = [];
                updateStats();
                filterTable();
            }
        }

        // UPDATE STATS DASHBOARD
        function updateStats() {
            const stats = {
                total: allVehicles.length,
                angenommen: allVehicles.filter(v => ['angenommen', 'neu', 'terminiert'].includes(v.status)).length,
                in_arbeit: allVehicles.filter(v => ['vorbereitung', 'lackierung', 'in_arbeit', 'bestellung', 'angekommen', 'montage', 'wuchten', 'diagnose', 'pruefung', 'in_pruefung', 'angebot', 'beauftragt', 'reparatur', 'in_reparatur', 'test', 'termin', 'termin_bestaetigt', 'termin_gebucht', 'aufbereitung', 'trocknung'].includes(v.status)).length,
                abgeschlossen: allVehicles.filter(v => ['bereit', 'fertig', 'abholbereit', 'abgeschlossen', 'freigabe'].includes(v.status)).length,
                qualitaet: allVehicles.filter(v => ['qualitaetskontrolle', 'qualitaet', 'gutachten'].includes(v.status)).length
            };

            const dashboard = document.getElementById('statsDashboard');
            dashboard.innerHTML = `
                <div class="stat-card">
                    <div class="stat-card__icon">
                        <i data-feather="database"></i>
                    </div>
                    <div class="stat-card__value">${stats.total}</div>
                    <div class="stat-card__label">Gesamt</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card__icon">
                        <i data-feather="clock"></i>
                    </div>
                    <div class="stat-card__value">${stats.angenommen}</div>
                    <div class="stat-card__label">Angenommen</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card__icon">
                        <i data-feather="tool"></i>
                    </div>
                    <div class="stat-card__value">${stats.in_arbeit}</div>
                    <div class="stat-card__label">In Arbeit</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card__icon">
                        <i data-feather="check-circle"></i>
                    </div>
                    <div class="stat-card__value">${stats.abgeschlossen}</div>
                    <div class="stat-card__label">Abgeschlossen</div>
                </div>
            `;

            // Re-initialize Feather Icons for new stats
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        }

        // FILTER STATUS
        function filterStatus(status) {
            currentFilter = status;
            currentPage = 1;

            // Update active button
            document.querySelectorAll('.filter-buttons .filter-btn').forEach((btn, index) => {
                if (index <= 3) { // Status filter buttons
                    btn.classList.remove('active');
                }
            });
            event.target.classList.add('active');

            filterTable();
        }

        // FILTER KUNDEN
        function filterKunden(filter) {
            currentKundenFilter = filter;
            currentPage = 1;

            // Update active button
            const buttons = document.querySelectorAll('.filter-group')[1].querySelectorAll('.filter-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            filterTable();
        }

        // üÜï FIX (2025-12-01): FILTER SERVICE-TYP
        // Filtert nach Primary Service ODER Additional Services (Multi-Service Support)
        function filterService(serviceTyp) {
            currentServiceFilter = serviceTyp;
            currentPage = 1;

            // Update active button (3. Filter-Gruppe = index 2)
            const buttons = document.querySelectorAll('.filter-group')[2]?.querySelectorAll('.filter-btn');
            if (buttons) {
                buttons.forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
            }

            filterTable();
        }

        // üÜï Helper: Pr√ºft ob Fahrzeug einen bestimmten Service hat (Primary ODER Additional)
        function hasService(vehicle, serviceTyp) {
            // Check primary service
            if (vehicle.serviceTyp === serviceTyp) return true;

            // Check additional services (supports both String-Array and Object-Array)
            if (vehicle.additionalServices && Array.isArray(vehicle.additionalServices)) {
                return vehicle.additionalServices.some(s => {
                    if (typeof s === 'string') return s === serviceTyp;
                    if (s && s.serviceTyp) return s.serviceTyp === serviceTyp;
                    return false;
                });
            }

            return false;
        }

        // FILTER TABLE (Search + Status + Kunden)
        function filterTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            // Start with all vehicles
            filteredVehicles = allVehicles.filter(vehicle => {
                // Search filter
                const matchesSearch = !searchTerm ||
                    vehicle.kennzeichen?.toLowerCase().includes(searchTerm) ||
                    vehicle.kunde?.toLowerCase().includes(searchTerm) ||
                    vehicle.marke?.toLowerCase().includes(searchTerm) ||
                    vehicle.modell?.toLowerCase().includes(searchTerm);

                // Status filter
                let matchesStatus = true;
                if (currentFilter === 'angenommen') {
                    matchesStatus = ['angenommen', 'neu', 'terminiert'].includes(vehicle.status);
                } else if (currentFilter === 'in_arbeit') {
                    matchesStatus = ['vorbereitung', 'lackierung', 'in_arbeit', 'bestellung', 'angekommen', 'montage', 'wuchten', 'diagnose', 'pruefung', 'in_pruefung', 'angebot', 'beauftragt', 'reparatur', 'in_reparatur', 'test', 'termin', 'termin_bestaetigt', 'termin_gebucht', 'aufbereitung', 'trocknung'].includes(vehicle.status);
                } else if (currentFilter === 'abgeschlossen') {
                    matchesStatus = ['bereit', 'fertig', 'abholbereit', 'abgeschlossen', 'freigabe'].includes(vehicle.status);
                }

                // Kunden filter
                // üÜï FIX: allKunden kann undefined sein wenn noch nicht geladen
                let matchesKunden = true;
                if (currentKundenFilter === 'stammkunden' && allKunden) {
                    const kunde = allKunden.find(k => k.name === vehicle.kunde);
                    matchesKunden = kunde && kunde.besuche >= 3;
                } else if (currentKundenFilter === 'neukunden' && allKunden) {
                    const kunde = allKunden.find(k => k.name === vehicle.kunde);
                    matchesKunden = kunde && kunde.besuche < 3;
                }

                // üÜï FIX (2025-12-01): Service-Typ Filter (Multi-Service Support)
                let matchesService = true;
                if (currentServiceFilter !== 'all') {
                    matchesService = hasService(vehicle, currentServiceFilter);
                }

                return matchesSearch && matchesStatus && matchesKunden && matchesService;
            });

            renderTable();
        }

        // RENDER TABLE
        function renderTable() {
            const tableBody = document.getElementById('tableBody');

            // ü¶¥ SKELETON LOADER: Hide skeleton, show table
            const skeleton = document.getElementById('tableSkeleton');
            const table = document.getElementById('vehicleTable');
            if (skeleton && skeleton.style.display !== 'none') {
                skeleton.style.display = 'none';
                table.style.display = 'table';
                // table.classList.add('fade-in'); // Removed - caused table to disappear after animation
                console.log('‚úÖ [SKELETON] Skeleton hidden, table visible');
            }

            // Calculate pagination
            totalPages = Math.ceil(filteredVehicles.length / itemsPerPage);
            if (totalPages === 0) totalPages = 1;
            if (currentPage > totalPages) currentPage = totalPages;

            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = Math.min(startIndex + itemsPerPage, filteredVehicles.length);
            const vehiclesToDisplay = filteredVehicles.slice(startIndex, endIndex);

            // Empty state
            if (vehiclesToDisplay.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9">
                            <div class="empty-state">
                                <i data-feather="inbox"></i>
                                <h3>Keine Fahrzeuge gefunden</h3>
                                <p>Keine Fahrzeuge entsprechen den aktuellen Filterkriterien.</p>
                            </div>
                        </td>
                    </tr>
                `;
                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
                updatePaginationControls();
                return;
            }

            // Render rows
            tableBody.innerHTML = vehiclesToDisplay.map(vehicle => {
                const statusClass = `status-${vehicle.status?.toLowerCase().replace(/\s/g, '_')}`;
                const statusIcon = getStatusIcon(vehicle.status);
                const serviceLabel = getServiceLabel(vehicle.serviceTyp);

                return `
                    <tr>
                        <td><strong>${vehicle.kennzeichen || 'N/A'}</strong></td>
                        <td>${vehicle.marke || 'N/A'} ${vehicle.modell || ''}</td>
                        <td>${vehicle.kundenname || 'N/A'}</td>
                        <td>${serviceLabel}</td>
                        <td>
                            <span class="status-badge ${statusClass}">
                                <i data-feather="${statusIcon}"></i>
                                ${formatStatus(vehicle.status)}
                            </span>
                        </td>
                        <td>${formatDate(vehicle.datum)}</td>
                        <td>
                            <button class="btn-toggle ${vehicle.bezahlt ? 'btn-toggle-success' : 'btn-toggle-secondary'}"
                                    onclick="toggleBezahlt('${vehicle.id}')">
                                <i data-feather="${vehicle.bezahlt ? 'check-circle' : 'circle'}"></i>
                                ${vehicle.bezahlt ? 'Bezahlt' : 'Unbezahlt'}
                            </button>
                        </td>
                        <td>
                            <button class="btn-toggle ${vehicle.rechnungGeschrieben ? 'btn-toggle-success' : 'btn-toggle-secondary'}"
                                    onclick="toggleRechnung('${vehicle.id}')">
                                <i data-feather="${vehicle.rechnungGeschrieben ? 'file-text' : 'file'}"></i>
                                ${vehicle.rechnungGeschrieben ? 'Erstellt' : 'Ausstehend'}
                            </button>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-action btn-view" onclick="viewDetails('${vehicle.id}')">
                                    <i data-feather="eye"></i> Details
                                </button>
                                <button class="btn-action btn-delete" onclick="deleteVehicle('${vehicle.id}')">
                                    <i data-feather="trash-2"></i> L√∂schen
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');

            // Re-initialize Feather Icons
            if (typeof feather !== 'undefined') {
                feather.replace();
            }

            updatePaginationControls();
        }

        // GET STATUS ICON
        function getStatusIcon(status) {
            const statusLower = status?.toLowerCase().replace(/\s/g, '_');
            const icons = {
                'neu': 'inbox',
                'angenommen': 'clock',
                'terminiert': 'calendar',
                'vorbereitung': 'loader',
                'lackierung': 'droplet',
                'in_arbeit': 'tool',
                'bestellung': 'shopping-cart',
                'angekommen': 'package',
                'montage': 'settings',
                'wuchten': 'disc',
                'diagnose': 'search',
                'pruefung': 'clipboard',
                'in_pruefung': 'clipboard',
                'angebot': 'file-text',
                'beauftragt': 'check-square',
                'reparatur': 'wrench',
                'in_reparatur': 'wrench',
                'test': 'activity',
                'termin': 'calendar',
                'termin_bestaetigt': 'calendar-check',
                'termin_gebucht': 'calendar',
                'aufbereitung': 'droplet',
                'trocknung': 'wind',
                'bereit': 'check',
                'fertig': 'check-circle',
                'abholbereit': 'package',
                'abgeschlossen': 'check-circle',
                'freigabe': 'unlock',
                'qualitaetskontrolle': 'alert-circle',
                'qualitaet': 'shield',
                'gutachten': 'file-text'
            };
            return icons[statusLower] || 'circle';
        }

        // GET SERVICE LABEL
        function getServiceLabel(serviceTyp) {
            const labels = {
                'lackierung': 'üé® Lackierung',
                'lackier': 'üé® Lackierung',  // Alias f√ºr Consistency
                'reifen': 'üõû Reifen',
                'mechanik': 'üîß Mechanik',
                'pflege': '‚ú® Pflege',
                'tuev': 'üìã T√úV',  // FIX: 'tuv' ‚Üí 'tuev'
                'tuv': 'üìã T√úV',   // Legacy Support
                'versicherung': 'üìÑ Versicherung',
                'glas': 'üîç Glas-Reparatur',
                'klima': '‚ùÑÔ∏è Klima-Service',
                'dellen': 'üî® Dellen-Dr√ºckung',
                'folierung': 'üåà Auto Folierung',
                'steinschutz': 'üõ°Ô∏è Steinschutzfolie',
                'werbebeklebung': 'üì¢ Fahrzeugbeschriftung'
            };
            return labels[serviceTyp?.toLowerCase()] || serviceTyp || 'N/A';
        }

        // FORMAT STATUS
        function formatStatus(status) {
            if (!status) return 'N/A';
            return status.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }

        // FORMAT DATE - mit Firestore Timestamp-Handling
        function formatDate(dateInput) {
            if (!dateInput) return 'N/A';

            let date;
            // Firestore Timestamp-Objekt erkennen (hat .seconds Eigenschaft)
            if (dateInput && typeof dateInput === 'object' && dateInput.seconds) {
                date = new Date(dateInput.seconds * 1000);
            } else if (typeof dateInput.toDate === 'function') {
                // Firebase Timestamp mit toDate() Methode
                date = dateInput.toDate();
            } else {
                date = new Date(dateInput);
            }

            if (isNaN(date.getTime())) return String(dateInput);
            return date.toLocaleDateString('de-DE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // SORT TABLE
        function sortTable(column) {
            // Update sort direction
            if (currentSortColumn === column) {
                if (currentSortDirection === 'none') {
                    currentSortDirection = 'asc';
                } else if (currentSortDirection === 'asc') {
                    currentSortDirection = 'desc';
                } else {
                    currentSortDirection = 'none';
                    currentSortColumn = null;
                }
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }

            // Update table headers
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('asc', 'desc');
            });

            if (currentSortDirection !== 'none') {
                const th = Array.from(document.querySelectorAll('th.sortable')).find(th =>
                    th.textContent.toLowerCase().includes(column) ||
                    th.onclick.toString().includes(column)
                );
                if (th) {
                    th.classList.add(currentSortDirection);
                }
            }

            // Sort filtered vehicles
            if (currentSortDirection === 'none') {
                // Reset to original order
                filterTable();
                return;
            }

            filteredVehicles.sort((a, b) => {
                let aVal = a[column] || '';
                let bVal = b[column] || '';

                // Special handling for dates
                if (column === 'datum') {
                    aVal = new Date(aVal).getTime() || 0;
                    bVal = new Date(bVal).getTime() || 0;
                }

                // String comparison
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }

                if (currentSortDirection === 'asc') {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
            });

            renderTable();
        }

        // VIEW DETAILS
        // ‚ú® SERVICE-DETAILS RENDERING
        // üÜï Phase 1.3: Bearbeitungs-History anzeigen
        function renderBearbeitungsHistory(vehicle) {
            if (!vehicle.bearbeitungsHistory || vehicle.bearbeitungsHistory.length === 0) return '';

            let html = '<div class="detail-row" style="background: rgba(76, 175, 80, 0.05); padding: 12px; border-radius: 8px; margin: 8px 0;">';
            html += '<strong style="display: block; margin-bottom: 8px;">üë§ Bearbeitungs-History (Audit-Trail)</strong>';
            html += '<div style="padding-left: 16px;">';

            // Service-Emojis
            const serviceEmojis = {
                'lackierung': 'üé®',
                'mechanik': 'üîß',
                'reifen': 'üõû',
                'pflege': '‚ú®',
                'tuev': 'üìã',
                'versicherung': 'üìÑ',
                'glas': 'üîç',
                'klima': '‚ùÑÔ∏è',
                'dellen': 'üî®',
                'folierung': 'üé¨',
                'steinschutz': 'üõ°Ô∏è',
                'werbebeklebung': 'üì¢'
            };

            // Zeige die letzten 5 Eintr√§ge (neueste zuerst)
            const history = vehicle.bearbeitungsHistory.slice(-5).reverse();

            history.forEach((eintrag, index) => {
                const mitarbeiterName = eintrag.mitarbeiterName || 'Unbekannt';
                const rolle = eintrag.rolle || 'Sonstige';
                const services = eintrag.services || [];
                const serviceIcons = services.map(s => serviceEmojis[s] || '').join(' ');
                const datum = new Date(eintrag.timestamp).toLocaleString('de-DE', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                const aktion = eintrag.aktion || 'Status ge√§ndert';
                const statusChange = eintrag.alterStatus && eintrag.neuerStatus
                    ? `${eintrag.alterStatus} ‚Üí ${eintrag.neuerStatus}`
                    : '';
                const fotoIcon = eintrag.hatFoto ? ' üì∏' : '';

                html += `
                    <div style="padding: 8px; background: ${index === 0 ? 'rgba(76, 175, 80, 0.1)' : 'transparent'}; border-radius: 6px; margin-bottom: 6px;">
                        <p style="margin: 2px 0; font-weight: ${index === 0 ? '600' : 'normal'};">
                            ${index === 0 ? '‚≠ê ' : ''}${mitarbeiterName} (${rolle}) ${serviceIcons}${fotoIcon}
                        </p>
                        <p style="margin: 2px 0; font-size: 12px; color: #666;">
                            ${aktion} ${statusChange ? '¬∑ ' + statusChange : ''}
                        </p>
                        <p style="margin: 2px 0; font-size: 11px; color: #999;">
                            ${datum}
                        </p>
                    </div>
                `;
            });

            html += '</div></div>';
            return html;
        }

        function renderServiceDetails(vehicle, serviceTitle = null) {
            if (!vehicle.serviceDetails) return '';

            let html = '<div class="detail-row" style="background: rgba(0, 122, 255, 0.05); padding: 12px; border-radius: 8px; margin: 8px 0;">';
            // üîß FIX (2025-11-13): Conditional title for additional services
            if (serviceTitle) {
                html += `<strong style="display: block; margin-bottom: 8px;">üîß ${serviceTitle}</strong>`;
            } else {
                html += '<strong style="display: block; margin-bottom: 8px;">üîß Service-Details</strong>';
            }
            html += '<div style="padding-left: 16px;">';

            switch(vehicle.serviceTyp) {
                case 'reifen':
                    if (vehicle.serviceDetails.reifengroesse) {
                        html += `<p style="margin: 4px 0;">üõû <strong>Reifengr√∂√üe:</strong> ${vehicle.serviceDetails.reifengroesse}</p>`;
                    }
                    if (vehicle.serviceDetails.reifentyp) {
                        const typLabels = { sommer: 'Sommerreifen', winter: 'Winterreifen', ganzjahr: 'Ganzjahresreifen' };
                        html += `<p style="margin: 4px 0;">üìÖ <strong>Typ:</strong> ${typLabels[vehicle.serviceDetails.reifentyp] || vehicle.serviceDetails.reifentyp}</p>`;
                    }
                    if (vehicle.serviceDetails.reifenanzahl) {
                        html += `<p style="margin: 4px 0;">üî¢ <strong>Anzahl:</strong> ${vehicle.serviceDetails.reifenanzahl}x</p>`;
                    }
                    break;

                case 'glas':
                    if (vehicle.serviceDetails.scheibentyp) {
                        html += `<p style="margin: 4px 0;">ü™ü <strong>Scheibe:</strong> ${vehicle.serviceDetails.scheibentyp}</p>`;
                    }
                    if (vehicle.serviceDetails.schadensgroesse) {
                        html += `<p style="margin: 4px 0;">üí• <strong>Schaden:</strong> ${vehicle.serviceDetails.schadensgroesse}</p>`;
                    }
                    if (vehicle.serviceDetails.glasposition) {
                        html += `<p style="margin: 4px 0;">üìç <strong>Position:</strong> ${vehicle.serviceDetails.glasposition}</p>`;
                    }
                    break;

                case 'klima':
                    if (vehicle.serviceDetails.klimaservice) {
                        html += `<p style="margin: 4px 0;">‚ùÑÔ∏è <strong>Service-Art:</strong> ${vehicle.serviceDetails.klimaservice}</p>`;
                    }
                    if (vehicle.serviceDetails.kaeltemittel) {
                        html += `<p style="margin: 4px 0;">üí® <strong>K√§ltemittel:</strong> ${vehicle.serviceDetails.kaeltemittel}</p>`;
                    }
                    if (vehicle.serviceDetails.klimaproblem) {
                        html += `<p style="margin: 4px 0;">üìù <strong>Problem:</strong> ${vehicle.serviceDetails.klimaproblem}</p>`;
                    }
                    break;

                case 'dellen':
                    if (vehicle.serviceDetails.dellenanzahl) {
                        html += `<p style="margin: 4px 0;">üî® <strong>Anzahl Dellen:</strong> ${vehicle.serviceDetails.dellenanzahl}x</p>`;
                    }
                    if (vehicle.serviceDetails.dellengroesse) {
                        const groesseLabels = { klein: 'Klein (< 5cm)', mittel: 'Mittel (5-10cm)', gross: 'Gro√ü (> 10cm)' };
                        html += `<p style="margin: 4px 0;">üìè <strong>Gr√∂√üe:</strong> ${groesseLabels[vehicle.serviceDetails.dellengroesse] || vehicle.serviceDetails.dellengroesse}</p>`;
                    }
                    if (vehicle.serviceDetails.lackschaden) {
                        const lackschadenLabel = vehicle.serviceDetails.lackschaden === 'ja' ? '‚ö†Ô∏è Ja (Lackierung n√∂tig)' : '‚úÖ Nein (nur Delle)';
                        html += `<p style="margin: 4px 0;">üé® <strong>Lackschaden:</strong> ${lackschadenLabel}</p>`;
                    }
                    if (vehicle.serviceDetails.dellenpositionen) {
                        html += `<p style="margin: 4px 0;">üìç <strong>Positionen:</strong> ${vehicle.serviceDetails.dellenpositionen}</p>`;
                    }
                    break;

                case 'lackier':
                case 'lackierung':
                    // Lackierung-spezifische Felder
                    if (vehicle.serviceDetails.farbname) {
                        html += `<p style="margin: 4px 0;">üé® <strong>Farbname:</strong> ${vehicle.serviceDetails.farbname}</p>`;
                    }
                    if (vehicle.serviceDetails.farbnummer) {
                        html += `<p style="margin: 4px 0;">üî¢ <strong>Farbnummer:</strong> ${vehicle.serviceDetails.farbnummer}</p>`;
                    }
                    if (vehicle.serviceDetails.farbvariante) {
                        html += `<p style="margin: 4px 0;">‚ú® <strong>Variante:</strong> ${vehicle.serviceDetails.farbvariante}</p>`;
                    }
                    if (vehicle.serviceDetails.oberflaeche) {
                        html += `<p style="margin: 4px 0;">üñåÔ∏è <strong>Oberfl√§che:</strong> ${vehicle.serviceDetails.oberflaeche}</p>`;
                    }
                    if (vehicle.serviceDetails.bereich) {
                        html += `<p style="margin: 4px 0;">üìç <strong>Bereich:</strong> ${vehicle.serviceDetails.bereich}</p>`;
                    }
                    break;

                default:
                    // Andere Services: Generische Anzeige aller serviceDetails Felder
                    Object.keys(vehicle.serviceDetails).forEach(key => {
                        html += `<p style="margin: 4px 0;"><strong>${key}:</strong> ${vehicle.serviceDetails[key]}</p>`;
                    });
                    break;
            }

            html += '</div></div>';
            return html;
        }

        async function viewDetails(vehicleId) {
            // ‚úÖ FIX: String-Vergleich f√ºr ID (vehicleId kommt als String vom onclick)
            const vehicle = allVehicles.find(v => window.compareIds(v.id, vehicleId));
            if (!vehicle) {
                showToast('Fehler: Fahrzeug nicht gefunden', 'error');
                return;
            }

            // Load photos lazily (performance!)
            let vorherPhotos = [];
            let nachherPhotos = [];

            if (firebaseInitialized && firebaseApp && firebaseApp.getFahrzeugFotos) {
                try {
                    const fotosData = await firebaseApp.getFahrzeugFotos(vehicleId);
                    vorherPhotos = fotosData.vorher || [];
                    nachherPhotos = fotosData.nachher || [];
                    console.log(`‚úÖ [LISTE] Fotos geladen f√ºr ${vehicleId}: ${vorherPhotos.length} vorher, ${nachherPhotos.length} nachher`);
                } catch (error) {
                    console.error('‚ùå [LISTE] Fehler beim Laden der Fotos:', error);
                }
            } else {
                // Fallback: LocalStorage
                vorherPhotos = vehicle.photos || [];
                nachherPhotos = vehicle.nachherPhotos || [];
            }

            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div class="detail-row">
                    <strong>Kennzeichen</strong>
                    <span>${vehicle.kennzeichen || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <strong>Marke / Modell</strong>
                    <span>${vehicle.marke || 'N/A'} ${vehicle.modell || ''}</span>
                </div>
                <div class="detail-row">
                    <strong>Kunde</strong>
                    <span>${vehicle.kundenname || 'N/A'}</span>
                </div>
                <div class="detail-row">
                    <strong>Service-Typ</strong>
                    <span>
                        ${getServiceLabel(vehicle.serviceTyp)}
                        ${vehicle.additionalServices && vehicle.additionalServices.length > 0
                            ? '<br><span style="color: rgba(100, 60, 255, 0.8); font-size: 0.9em;">' +
                              vehicle.additionalServices.map(as => '+ ' + getServiceLabel(as.serviceTyp)).join('<br>') +
                              '</span>'
                            : ''}
                    </span>
                </div>
                ${renderServiceDetails({...vehicle, serviceDetails: vehicle.serviceDetails || vehicle.serviceData})}  <!-- FIX #37: Fallback to serviceData for old vehicles -->
                ${vehicle.additionalServices && vehicle.additionalServices.length > 0
                    ? vehicle.additionalServices.map(as =>
                        renderServiceDetails(
                            { serviceTyp: as.serviceTyp, serviceDetails: as.serviceDetails || as.serviceData },  // üîß FIX (2025-11-13): Backward compatibility for old vehicles with "serviceData" field
                            `Zus√§tzlicher Service: ${getServiceLabel(as.serviceTyp)}`
                        )
                      ).join('')
                    : ''}
                ${renderBearbeitungsHistory(vehicle)}
                <div class="detail-row">
                    <strong>Status</strong>
                    <span>${formatStatus(vehicle.status)}</span>
                </div>
                <div class="detail-row">
                    <strong>Datum</strong>
                    <span>${formatDate(vehicle.datum)}</span>
                </div>
                ${vehicle.farbnummer ? `
                <div class="detail-row">
                    <strong>Farbnummer</strong>
                    <span>${vehicle.farbnummer}</span>
                </div>
                ` : ''}
                ${vehicle.bemerkungen ? `
                <div class="detail-row">
                    <strong>Bemerkungen</strong>
                    <span>${vehicle.bemerkungen}</span>
                </div>
                ` : ''}

                <!-- üìû KONTAKTDATEN SECTION -->
                ${(vehicle.kundenEmail || vehicle.telefon) ? `
                <div class="detail-section" style="margin: 16px 0; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                    <h4 style="margin: 0 0 8px 0; font-size: 14px; color: #333;">üìû Kontaktdaten</h4>
                    ${vehicle.kundenEmail ? `
                    <div class="detail-row">
                        <strong>Email</strong>
                        <span><a href="mailto:${vehicle.kundenEmail}" style="color: #1976d2;">${vehicle.kundenEmail}</a></span>
                    </div>
                    ` : ''}
                    ${vehicle.telefon ? `
                    <div class="detail-row">
                        <strong>Telefon</strong>
                        <span><a href="tel:${vehicle.telefon}" style="color: #1976d2;">${vehicle.telefon}</a></span>
                    </div>
                    ` : ''}
                </div>
                ` : ''}

                <!-- üöó FAHRZEUGDATEN ERWEITERT -->
                ${(vehicle.baujahrVon || vehicle.kmstand || vehicle.vin) ? `
                <div class="detail-section" style="margin: 16px 0; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                    <h4 style="margin: 0 0 8px 0; font-size: 14px; color: #333;">üöó Fahrzeugdaten</h4>
                    ${vehicle.baujahrVon ? `
                    <div class="detail-row">
                        <strong>Baujahr</strong>
                        <span>${vehicle.baujahrVon}</span>
                    </div>
                    ` : ''}
                    ${vehicle.kmstand ? `
                    <div class="detail-row">
                        <strong>KM-Stand</strong>
                        <span>${Number(vehicle.kmstand).toLocaleString('de-DE')} km</span>
                    </div>
                    ` : ''}
                    ${vehicle.vin ? `
                    <div class="detail-row">
                        <strong>VIN</strong>
                        <span style="font-family: monospace; font-size: 12px;">${vehicle.vin}</span>
                    </div>
                    ` : ''}
                </div>
                ` : ''}

                <!-- üìÖ TERMINE SECTION -->
                ${(vehicle.geplantesAbnahmeDatum || vehicle.angebotDetails?.fertigstellungsdatum || vehicle.abholdatum) ? `
                <div class="detail-section" style="margin: 16px 0; padding: 12px; background: #e3f2fd; border-radius: 8px;">
                    <h4 style="margin: 0 0 8px 0; font-size: 14px; color: #1565c0;">üìÖ Termine</h4>
                    ${vehicle.abholdatum || vehicle.anliefertermin ? `
                    <div class="detail-row">
                        <strong>Auftragsstart</strong>
                        <span>${formatDate(vehicle.abholdatum || vehicle.anliefertermin)}</span>
                    </div>
                    ` : ''}
                    ${vehicle.geplantesAbnahmeDatum || vehicle.angebotDetails?.fertigstellungsdatum ? `
                    <div class="detail-row">
                        <strong>Fertigstellung</strong>
                        <span>${formatDate(vehicle.geplantesAbnahmeDatum || vehicle.angebotDetails?.fertigstellungsdatum)}</span>
                    </div>
                    ` : ''}
                </div>
                ` : ''}

                <!-- üí∂ PREISE SECTION -->
                ${(vehicle.vereinbarterPreis || vehicle.angebotDetails?.gewaehlt?.gesamt || vehicle.angebotDetails?.preis || vehicle.angebotDetails?.summeBruttoOriginal || vehicle.angebotDetails?.summeBruttoAftermarket) ? `
                <div class="detail-section" style="margin: 16px 0; padding: 12px; background: #e8f5e9; border-radius: 8px;">
                    <h4 style="margin: 0 0 8px 0; font-size: 14px; color: #2e7d32;">üí∂ Preise</h4>
                    ${(() => {
                        // Fallback-Chain f√ºr den vereinbarten Preis
                        const preis = vehicle.vereinbarterPreis || vehicle.angebotDetails?.gewaehlt?.gesamt || vehicle.angebotDetails?.preis;
                        return preis ? `
                        <div class="detail-row">
                            <strong>Vereinbarter Preis</strong>
                            <span style="font-weight: bold; color: #2e7d32;">${Number(preis).toLocaleString('de-DE', {minimumFractionDigits: 2})} ‚Ç¨</span>
                        </div>
                        ` : '';
                    })()}
                    ${vehicle.angebotDetails?.summeBruttoOriginal ? `
                    <div class="detail-row">
                        <strong>Original-Teile</strong>
                        <span>${Number(vehicle.angebotDetails.summeBruttoOriginal).toLocaleString('de-DE', {minimumFractionDigits: 2})} ‚Ç¨</span>
                    </div>
                    ` : ''}
                    ${vehicle.angebotDetails?.summeBruttoAftermarket ? `
                    <div class="detail-row">
                        <strong>Aftermarket</strong>
                        <span>${Number(vehicle.angebotDetails.summeBruttoAftermarket).toLocaleString('de-DE', {minimumFractionDigits: 2})} ‚Ç¨</span>
                    </div>
                    ` : ''}
                </div>
                ` : ''}

                <!-- üìã KVA/ANGEBOT SECTION -->
                ${(vehicle.kva || vehicle.angebotDetails?.varianten || (vehicle.angebotDetails?.summeBruttoOriginal && vehicle.angebotDetails?.summeBruttoAftermarket)) ? `
                <div class="detail-section" style="margin: 16px 0; padding: 12px; background: linear-gradient(135deg, #fff8e1, #ffecb3); border-radius: 8px; border-left: 4px solid #ff9800;">
                    <h4 style="margin: 0 0 12px 0; font-size: 14px; color: #e65100;">üìã Kostenvoranschlag (KVA)</h4>

                    <!-- Varianten-√úbersicht -->
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        ${vehicle.angebotDetails?.summeBruttoAftermarket ? `
                        <div style="flex: 1; min-width: 120px; padding: 10px; background: #e8f5e9; border-radius: 6px; text-align: center;">
                            <div style="font-size: 11px; color: #666;">Aftermarket</div>
                            <div style="font-size: 16px; font-weight: bold; color: #2e7d32;">
                                ${Number(vehicle.angebotDetails.summeBruttoAftermarket).toLocaleString('de-DE', {minimumFractionDigits: 2})} ‚Ç¨
                            </div>
                        </div>
                        ` : ''}
                        ${vehicle.angebotDetails?.summeBruttoOriginal ? `
                        <div style="flex: 1; min-width: 120px; padding: 10px; background: #e3f2fd; border-radius: 6px; text-align: center;">
                            <div style="font-size: 11px; color: #666;">Original</div>
                            <div style="font-size: 16px; font-weight: bold; color: #1565c0;">
                                ${Number(vehicle.angebotDetails.summeBruttoOriginal).toLocaleString('de-DE', {minimumFractionDigits: 2})} ‚Ç¨
                            </div>
                        </div>
                        ` : ''}
                    </div>

                    <!-- Gew√§hlte Variante -->
                    ${vehicle.angebotDetails?.gewaehlt || vehicle.kva?.gewaehlteVariante ? `
                    <div style="margin-top: 10px; padding: 8px; background: rgba(46,125,50,0.1); border-radius: 4px;">
                        <strong style="color: #2e7d32;">‚úÖ Gew√§hlt:</strong>
                        ${vehicle.angebotDetails?.gewaehlt?.name || vehicle.kva?.gewaehlteVariante || 'N/A'}
                        ${vehicle.angebotDetails?.gewaehlt?.gesamt ? ` - ${Number(vehicle.angebotDetails.gewaehlt.gesamt).toLocaleString('de-DE', {minimumFractionDigits: 2})} ‚Ç¨` : ''}
                    </div>
                    ` : ''}

                    <!-- Ersatzteile (wenn vorhanden) -->
                    ${vehicle.ersatzteile && vehicle.ersatzteile.length > 0 ? `
                    <div style="margin-top: 10px;">
                        <strong style="font-size: 12px;">Ersatzteile (${vehicle.ersatzteile.length}):</strong>
                        <div style="margin-top: 4px; font-size: 11px; max-height: 100px; overflow-y: auto;">
                            ${vehicle.ersatzteile.slice(0, 5).map(et => `
                                <div style="display: flex; justify-content: space-between; padding: 2px 0; border-bottom: 1px solid #eee;">
                                    <span>${et.benennung || et.name || 'Ersatzteil'}</span>
                                    <span>${Number(et.gesamtpreis || et.preis || 0).toLocaleString('de-DE', {minimumFractionDigits: 2})} ‚Ç¨</span>
                                </div>
                            `).join('')}
                            ${vehicle.ersatzteile.length > 5 ? `<div style="color: #666; padding-top: 4px;">... +${vehicle.ersatzteile.length - 5} weitere</div>` : ''}
                        </div>
                    </div>
                    ` : ''}
                </div>
                ` : ''}

                <!-- üöô ABHOLUNG & LEIHFAHRZEUG SECTION -->
                ${(vehicle.abholadresse || vehicle.ersatzfahrzeugGewuenscht || vehicle.kalkulationData?.ersatzfahrzeug) ? `
                <div class="detail-section" style="margin: 16px 0; padding: 12px; background: #fff3e0; border-radius: 8px;">
                    <h4 style="margin: 0 0 8px 0; font-size: 14px; color: #e65100;">üöô Abholung & Leihfahrzeug</h4>
                    ${vehicle.abholadresse ? `
                    <div class="detail-row">
                        <strong>Abholadresse</strong>
                        <span>${vehicle.abholadresse}</span>
                    </div>
                    ` : ''}
                    ${vehicle.kalkulationData?.ersatzfahrzeug ? `
                    <div class="detail-row">
                        <strong>Leihfahrzeug</strong>
                        <span>${vehicle.kalkulationData.ersatzfahrzeug.kennzeichen || vehicle.kalkulationData.ersatzfahrzeug.fahrzeug || 'Ja'}</span>
                    </div>
                    <div class="detail-row">
                        <strong>Leihdauer</strong>
                        <span>${vehicle.kalkulationData.ersatzfahrzeug.tage || '-'} Tage ${vehicle.kalkulationData.ersatzfahrzeug.tagesmiete ? `√ó ${vehicle.kalkulationData.ersatzfahrzeug.tagesmiete}‚Ç¨ = ${vehicle.kalkulationData.ersatzfahrzeug.gesamt || (vehicle.kalkulationData.ersatzfahrzeug.tage * vehicle.kalkulationData.ersatzfahrzeug.tagesmiete)}‚Ç¨` : ''}</span>
                    </div>
                    ` : vehicle.ersatzfahrzeugGewuenscht ? `
                    <div class="detail-row">
                        <strong>Leihfahrzeug</strong>
                        <span>Gew√ºnscht ‚úì</span>
                    </div>
                    ` : ''}
                </div>
                ` : ''}

                <!-- üìÑ DOKUMENTE/PDFs SECTION (User-Priorit√§t!) -->
                ${(vehicle.pdfUrl || vehicle.angebotPdfUrl) ? `
                <div class="detail-section" style="margin: 16px 0; padding: 12px; background: #fce4ec; border-radius: 8px;">
                    <h4 style="margin: 0 0 8px 0; font-size: 14px; color: #c2185b;">üìÑ Dokumente</h4>
                    ${vehicle.pdfUrl ? `
                    <div class="detail-row">
                        <strong>Entwurf-PDF</strong>
                        <span><a href="${vehicle.pdfUrl}" target="_blank" style="color: #c2185b; text-decoration: none; display: inline-flex; align-items: center; gap: 4px;">üì• Herunterladen</a></span>
                    </div>
                    ` : ''}
                    ${vehicle.angebotPdfUrl ? `
                    <div class="detail-row">
                        <strong>Angebot-PDF</strong>
                        <span><a href="${vehicle.angebotPdfUrl}" target="_blank" style="color: #c2185b; text-decoration: none; display: inline-flex; align-items: center; gap: 4px;">üì• Herunterladen</a></span>
                    </div>
                    ` : ''}
                </div>
                ` : ''}

                <!-- üìù NOTIZEN SECTION -->
                ${vehicle.notizen ? `
                <div class="detail-section" style="margin: 16px 0; padding: 12px; background: #fffde7; border-radius: 8px;">
                    <h4 style="margin: 0 0 8px 0; font-size: 14px; color: #f9a825;">üìù Notizen</h4>
                    <div style="white-space: pre-wrap; font-size: 13px; color: #333;">${vehicle.notizen}</div>
                </div>
                ` : ''}

                ${vorherPhotos.length > 0 ? `
                <div class="detail-row">
                    <strong>Fotos (Vorher)</strong>
                    <div class="photo-gallery">
                        ${vorherPhotos.map((photo, i) => `
                            <img src="${photo}" alt="Vorher ${i + 1}" loading="lazy" decoding="async" onclick="openPhotoFullscreen('${photo}')">
                        `).join('')}
                    </div>
                </div>
                ` : ''}
                ${nachherPhotos.length > 0 ? `
                <div class="detail-row">
                    <strong>Fotos (Nachher)</strong>
                    <div class="photo-gallery">
                        ${nachherPhotos.map((photo, i) => `
                            <img src="${photo}" alt="Nachher ${i + 1}" loading="lazy" decoding="async" onclick="openPhotoFullscreen('${photo}')">
                        `).join('')}
                    </div>
                </div>
                ` : ''}
            `;

            document.getElementById('detailModal').classList.add('show');

            // Re-initialize Feather Icons
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        }

        // CLOSE MODAL
        function closeModal() {
            document.getElementById('detailModal').classList.remove('show');
        }

        // OPEN PHOTO FULLSCREEN
        function openPhotoFullscreen(photoSrc) {
            const fullscreenDiv = document.createElement('div');
            fullscreenDiv.style.cssText = `
                position: fixed;
                inset: 0;
                z-index: 10000;
                background: rgba(0,0,0,0.95);
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
            `;
            fullscreenDiv.innerHTML = `<img src="${photoSrc}" style="max-width: 95%; max-height: 95%; border-radius: 12px;" loading="lazy" decoding="async">`;
            fullscreenDiv.onclick = () => fullscreenDiv.remove();
            document.body.appendChild(fullscreenDiv);
        }

        // DELETE VEHICLE
        async function deleteVehicle(vehicleId) {
            if (!confirm('M√∂chten Sie dieses Fahrzeug wirklich l√∂schen?')) {
                return;
            }

            try {
                if (firebaseInitialized && firebaseApp && firebaseApp.deleteFahrzeug) {
                    await firebaseApp.deleteFahrzeug(vehicleId);
                    showToast('Fahrzeug erfolgreich gel√∂scht', 'success');
                } else {
                    // Fallback: LocalStorage
                    // ‚úÖ FIX: String-Vergleich f√ºr ID Konsistenz
                    allVehicles = allVehicles.filter(v => String(v.id) !== String(vehicleId));
                    localStorage.setItem('fahrzeuge', JSON.stringify(allVehicles));
                    updateStats();
                    filterTable();
                    showToast('Fahrzeug erfolgreich gel√∂scht (LocalStorage)', 'success');
                }
            } catch (error) {
                console.error('‚ùå [LISTE] Fehler beim L√∂schen:', error);
                showToast('Fehler beim L√∂schen des Fahrzeugs', 'error');
            }
        }

        // TOGGLE BEZAHLT STATUS
        async function toggleBezahlt(vehicleId) {
            const vehicle = allVehicles.find(v => String(v.id) === String(vehicleId));
            if (!vehicle) {
                showToast('Fahrzeug nicht gefunden', 'error');
                return;
            }

            const newValue = !vehicle.bezahlt;

            try {
                if (firebaseInitialized && firebaseApp && firebaseApp.updateFahrzeug) {
                    await firebaseApp.updateFahrzeug(vehicleId, {
                        bezahlt: newValue,
                        lastModified: Date.now()
                    });
                    showToast(`Bezahlt-Status: ${newValue ? 'Bezahlt' : 'Unbezahlt'}`, 'success');
                    // Realtime listener will auto-update UI
                } else {
                    showToast('Firebase nicht verf√ºgbar', 'error');
                }
            } catch (error) {
                console.error('‚ùå [TOGGLE] Bezahlt-Fehler:', error);
                showToast('Fehler beim Aktualisieren', 'error');
            }
        }

        // TOGGLE RECHNUNG STATUS
        async function toggleRechnung(vehicleId) {
            const vehicle = allVehicles.find(v => String(v.id) === String(vehicleId));
            if (!vehicle) {
                showToast('Fahrzeug nicht gefunden', 'error');
                return;
            }

            const newValue = !vehicle.rechnungGeschrieben;

            try {
                if (firebaseInitialized && firebaseApp && firebaseApp.updateFahrzeug) {
                    await firebaseApp.updateFahrzeug(vehicleId, {
                        rechnungGeschrieben: newValue,
                        lastModified: Date.now()
                    });
                    showToast(`Rechnung: ${newValue ? 'Erstellt' : 'Ausstehend'}`, 'success');
                    // Realtime listener will auto-update UI
                } else {
                    showToast('Firebase nicht verf√ºgbar', 'error');
                }
            } catch (error) {
                console.error('‚ùå [TOGGLE] Rechnung-Fehler:', error);
                showToast('Fehler beim Aktualisieren', 'error');
            }
        }

        // PAGINATION CONTROLS
        function updatePaginationControls() {
            const infoElement = document.getElementById('paginationInfo');
            const currentPageElement = document.getElementById('currentPage');
            const firstBtn = document.getElementById('firstPageBtn');
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            const lastBtn = document.getElementById('lastPageBtn');

            const startIndex = (currentPage - 1) * itemsPerPage + 1;
            const endIndex = Math.min(startIndex + itemsPerPage - 1, filteredVehicles.length);

            infoElement.textContent = `${startIndex}-${endIndex} von ${filteredVehicles.length} Fahrzeugen`;
            currentPageElement.textContent = `${currentPage} / ${totalPages}`;

            firstBtn.disabled = currentPage === 1;
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages || totalPages === 0;
            lastBtn.disabled = currentPage === totalPages || totalPages === 0;

            // Re-initialize Feather Icons for pagination buttons
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        }

        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        }

        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        }

        function goToPage(page) {
            currentPage = page;
            renderTable();
        }

        function goToLastPage() {
            currentPage = totalPages;
            renderTable();
        }

        function changeItemsPerPage() {
            const select = document.getElementById('itemsPerPageSelect');
            itemsPerPage = parseInt(select.value);
            currentPage = 1;
            renderTable();
        }

        // TOAST NOTIFICATION
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <i data-feather="${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'info'}"></i>
                    <span style="flex: 1; font-size: 14px; font-weight: 500; color: var(--color-text-primary);">${message}</span>
                </div>
            `;

            document.getElementById('toastContainer').appendChild(toast);

            if (typeof feather !== 'undefined') {
                feather.replace();
            }

            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease-out forwards';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // GSAP ENTRANCE ANIMATIONS
        function initAnimations() {
            if (typeof gsap === 'undefined') {
                console.warn('‚ö†Ô∏è [LISTE] GSAP nicht geladen - Animationen deaktiviert');
                return;
            }

            // ‚úÖ CONDITIONAL CHECKS - Nur animieren wenn Element existiert!
            let animatedCount = 0;

            // Hero Header (versteckt auf Mobile)
            const heroHeader = document.querySelector('.hero-header');
            if (heroHeader) {
                gsap.from('.hero-header', {
                    opacity: 0,
                    y: -30,
                    duration: 0.6,
                    ease: 'power2.out'
                });
                animatedCount++;
            }

            // Stats Dashboard
            const statsDashboard = document.querySelector('.stats-dashboard');
            if (statsDashboard) {
                gsap.from('.stats-dashboard', {
                    opacity: 0,
                    y: 30,
                    duration: 0.6,
                    delay: 0.1,
                    ease: 'power2.out'
                });
                animatedCount++;
            }

            // Search & Filter Section
            const searchFilter = document.querySelector('.search-filter-section');
            if (searchFilter) {
                gsap.from('.search-filter-section', {
                    opacity: 0,
                    y: 30,
                    duration: 0.6,
                    delay: 0.2,
                    ease: 'power2.out'
                });
                animatedCount++;
            }

            // Table Section
            const tableSection = document.querySelector('.table-section');
            if (tableSection) {
                gsap.from('.table-section', {
                    opacity: 0,
                    y: 30,
                    duration: 0.6,
                    delay: 0.3,
                    ease: 'power2.out'
                });
                animatedCount++;
            }

            console.log(`‚úÖ [LISTE] GSAP Animationen initialisiert (${animatedCount} Elemente animiert)`);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('detailModal');
            if (event.target === modal) {
                closeModal();
            }
        };

        /* ============================================
           üåô THEME TOGGLE - LIGHT/DARK MODE
           ============================================ */

        // Get Theme from LocalStorage or default to 'light'
        const getTheme = () => {
            return localStorage.getItem('theme') || 'light';
        };

        // ‚úÖ UPDATE FEATHER ICONS STROKE-WIDTH (KONSISTENT MIT index.html)
        const updateFeatherIcons = (theme) => {
            const strokeWidth = theme === 'light' ? '2.5' : '2';

            // Update all Feather Icons SVGs
            document.querySelectorAll('i[data-feather]').forEach(icon => {
                const svg = icon.querySelector('svg');
                if (svg) {
                    // Update stroke-width on all paths and shapes
                    svg.querySelectorAll('*[stroke]').forEach(element => {
                        element.setAttribute('stroke-width', strokeWidth);
                    });
                }
            });

            console.log(`üé® [LISTE] Feather Icons stroke-width updated to ${strokeWidth} for ${theme} mode`);
        };

        // Initialize Theme on Page Load
        document.addEventListener('DOMContentLoaded', () => {
            const html = document.documentElement;
            const themeToggle = document.getElementById('themeToggle'); // ‚úÖ Neues ID!

            // Initialize theme (default: light)
            let currentTheme = localStorage.getItem('theme') || 'light';
            html.setAttribute('data-theme', currentTheme);
            console.log(`üåì [LISTE] Theme initialized: ${currentTheme}`);

            // Toggle theme on button click
            if (themeToggle) {
                const themeToggleHandler = () => {
                    currentTheme = currentTheme === 'light' ? 'dark' : 'light';
                    html.setAttribute('data-theme', currentTheme);
                    localStorage.setItem('theme', currentTheme);

                    console.log(`üåì [LISTE] Theme switched to: ${currentTheme}`);

                    // Re-initialize Feather Icons for theme change
                    if (typeof feather !== 'undefined') {
                        feather.replace();
                        // Wait for feather.replace() to finish, then update stroke-width
                        setTimeout(() => updateFeatherIcons(currentTheme), 50);
                    }
                };
                window.listenerRegistry.registerDOM(themeToggle, 'click', themeToggleHandler, 'Theme Toggle Button');
            }

            // Initialize Feather Icons on load
            if (typeof feather !== 'undefined') {
                feather.replace();
                // Wait for feather.replace() to finish, then update stroke-width
                setTimeout(() => {
                    updateFeatherIcons(currentTheme);
                    console.log('‚úÖ [LISTE] Feather Icons initialized');
                }, 50);
            }

            console.log('‚úÖ [LISTE] Theme System initialized');
        });
    </script>

    <!-- KI-Chat-Assistent -->
    <div id="aiChatWidget"></div>
    <script src="js/ai-agent-tools.js"></script>
    <script src="js/ai-agent-engine.js"></script>
    <script src="js/ai-chat-widget.js"></script>
    <script src="js/quota-display.js"></script>

    <!-- ============================================
         SERVICE WORKER REGISTRATION - Offline-Funktionalit√§t
         ============================================ -->
    <script>
        // Service Worker nur registrieren wenn:
        // 1. Browser unterst√ºtzt Service Worker
        // 2. NICHT in Playwright Tests (navigator.webdriver)
        // 3. NICHT auf Emulator-Port (8000)
        if ('serviceWorker' in navigator && !navigator.webdriver && window.location.port !== '8000') {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('./sw.js', {
                        scope: './'
                    });

                    console.log('‚úÖ [SW] Service Worker registriert:', registration.scope);

                    // Update-Handling: Neuen SW aktivieren wenn gefunden
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        console.log('üîÑ [SW] Update gefunden, installiere...');

                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                console.log('‚úÖ [SW] Update bereit! Seite neu laden f√ºr neue Version.');

                                // Optional: Auto-reload nach 3 Sekunden
                                // setTimeout(() => window.location.reload(), 3000);
                            }
                        });
                    });

                } catch (error) {
                    console.error('‚ùå [SW] Registrierung fehlgeschlagen:', error);
                }
            });
        } else {
            console.log('‚ÑπÔ∏è [SW] Service Worker nicht registriert (Test-Modus oder nicht unterst√ºtzt)');
        }
    </script>

    <!-- üé® UX REDESIGN 2025 - JavaScript -->
    <script>
        // ============================================
        // üé® UX REDESIGN 2025 - MICRO-INTERACTIONS
        // ============================================

        // 3D Tilt Effect on Vehicle Cards
        function init3DTiltEffect() {
            const cards = document.querySelectorAll('.vehicle-card');

            cards.forEach(card => {
                card.addEventListener('mouseenter', function() {
                    this.classList.add('tilt-active');
                });

                card.addEventListener('mouseleave', function() {
                    this.classList.remove('tilt-active');
                    this.style.setProperty('--tilt-x', '0deg');
                    this.style.setProperty('--tilt-y', '0deg');
                });

                card.addEventListener('mousemove', function(e) {
                    if (!this.classList.contains('tilt-active')) return;

                    const rect = this.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    const centerX = rect.width / 2;
                    const centerY = rect.height / 2;

                    const tiltX = ((y - centerY) / centerY) * -3;
                    const tiltY = ((x - centerX) / centerX) * 3;

                    this.style.setProperty('--tilt-x', `${tiltX}deg`);
                    this.style.setProperty('--tilt-y', `${tiltY}deg`);
                });
            });

            console.log('‚úÖ 3D Tilt Effect initialized on', cards.length, 'vehicle cards');
        }

        // Ripple Effect on Buttons
        function initRippleEffect() {
            const rippleElements = document.querySelectorAll('.nav-btn, .filter-btn');

            rippleElements.forEach(element => {
                element.addEventListener('click', function(e) {
                    const existingRipple = this.querySelector('.ripple');
                    if (existingRipple) existingRipple.remove();

                    const ripple = document.createElement('span');
                    ripple.classList.add('ripple');

                    const rect = this.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    const x = e.clientX - rect.left - size / 2;
                    const y = e.clientY - rect.top - size / 2;

                    ripple.style.width = ripple.style.height = `${size}px`;
                    ripple.style.left = `${x}px`;
                    ripple.style.top = `${y}px`;

                    this.appendChild(ripple);
                    setTimeout(() => ripple.remove(), 600);
                });
            });

            console.log('‚úÖ Ripple Effect initialized on', rippleElements.length, 'elements');
        }

        // Scroll Reveal Animations
        function initScrollAnimations() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('visible');
                    }
                });
            }, {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            });

            document.querySelectorAll('.vehicle-card').forEach(el => {
                el.classList.add('scroll-reveal');
                observer.observe(el);
            });

            console.log('‚úÖ Scroll Animations initialized');
        }

        // GSAP Entry Animations
        function initGSAPAnimations() {
            if (typeof gsap === 'undefined') {
                console.warn('‚ö†Ô∏è GSAP not loaded, skipping entry animations');
                return;
            }

            gsap.from('.header-card', {
                duration: 0.8,
                y: -30,
                opacity: 0,
                ease: 'power3.out'
            });

            gsap.from('.filter-container', {
                duration: 0.8,
                y: 30,
                opacity: 0,
                ease: 'power3.out',
                delay: 0.2
            });

            gsap.from('.vehicle-card', {
                duration: 0.6,
                y: 20,
                opacity: 0,
                ease: 'power2.out',
                stagger: 0.08,
                delay: 0.4
            });

            console.log('‚úÖ GSAP Entry Animations initialized');
        }

        // Initialize all UX features
        document.addEventListener('DOMContentLoaded', function() {
            if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                console.log('‚ö†Ô∏è Reduced motion preference detected, skipping animations');
                return;
            }

            setTimeout(() => {
                init3DTiltEffect();
                initRippleEffect();
                initScrollAnimations();
                initGSAPAnimations();
                console.log('üé® UX Redesign 2025 fully initialized for Liste');
            }, 100);
        });

        // Re-initialize when cards are dynamically loaded
        const originalRenderCards = window.renderCards;
        if (typeof originalRenderCards === 'function') {
            window.renderCards = function(...args) {
                const result = originalRenderCards.apply(this, args);
                setTimeout(() => {
                    init3DTiltEffect();
                    initScrollAnimations();
                }, 100);
                return result;
            };
        }
    </script>
</body>
</html>
