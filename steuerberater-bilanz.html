<!DOCTYPE html>
<html lang="de">
<head>
    <!-- üåì FOUC Prevention: Load Theme BEFORE CSS to prevent flash -->
    <script>
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>

    <script>
        /// <reference path="js/types.js" />
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bilanz-√úbersicht | Steuerberater Dashboard</title>

    <!-- Mobile-Responsive CSS Framework -->
    <link rel="stylesheet" href="mobile-responsive.css">

    <!-- Apple Liquid Glass Design System -->
    <link rel="stylesheet" href="design-system.css">
    <link rel="stylesheet" href="components.css">
    <link rel="stylesheet" href="animations.css">
    <link rel="stylesheet" href="mobile-first.css">
    <link rel="stylesheet" href="css/ai-chat-widget.css">
    <link rel="stylesheet" href="css/quota-display.css">

    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>

    <!-- GSAP Animation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', 'Inter', var(--font-system);
            background: var(--color-background);
            min-height: 100vh;
            padding: var(--space-6) var(--space-4) 100px;
            color: var(--color-text-primary);
            transition: background 0.3s ease, color 0.3s ease;
            overflow-x: auto;
            position: relative;
        }

        /* üé® Marken-Charakter: Dezentes Reflex-Pattern (Lack-Oberfl√§che) */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 50px,
                rgba(255, 255, 255, 0.02) 50px,
                rgba(255, 255, 255, 0.02) 51px
            );
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;

            /* Glassmorphismus - Apple Liquid Glass Style */
            background: var(--color-surface);
            backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-saturation));
            border: 1px solid var(--color-border-glass);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);

            padding: var(--space-8);
            position: relative;
            overflow: visible;

            /* ‚ú® Page-Transition: Slide-In beim Laden */
            animation: slideIn 0.4s cubic-bezier(0.22, 1, 0.36, 1);
        }

        /* üé¨ Page-Transition Animation */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Navigation Bar */
        .nav-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            padding: 15px;
            background: var(--color-surface);
            border-radius: 12px;
            border: 1px solid var(--color-border-glass);
        }

        .nav-btn {
            padding: 10px 20px;
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border-glass);
            border-radius: 8px;
            color: var(--color-text-primary);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover {
            background: var(--color-surface-elevated);
            color: var(--color-primary);
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: var(--color-success);
            color: white;
            border-color: var(--color-success);
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            color: var(--color-text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* KPI Cards Grid */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border-glass);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s cubic-bezier(0.22, 1, 0.36, 1);
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--accent-color);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .kpi-card:hover::before {
            opacity: 1;
        }

        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .kpi-card.success {
            --accent-color: var(--color-success);
        }

        .kpi-card.warning {
            --accent-color: var(--color-warning);
        }

        .kpi-card.danger {
            --accent-color: var(--color-error);
        }

        .kpi-card.info {
            --accent-color: var(--color-info);
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .kpi-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--accent-color);
            color: white;
        }

        .kpi-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--color-text-primary);
            margin-bottom: 8px;
            font-variant-numeric: tabular-nums;
        }

        .kpi-subtitle {
            font-size: 13px;
            color: var(--color-text-secondary);
        }

        .kpi-trend {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 8px;
        }

        .kpi-trend.positive {
            background: rgba(34, 197, 94, 0.1);
            color: var(--color-success);
        }

        .kpi-trend.negative {
            background: rgba(239, 68, 68, 0.1);
            color: var(--color-error);
        }

        /* Period Selector */
        .period-selector {
            display: flex;
            gap: 8px;
            background: var(--color-surface);
            padding: 8px;
            border-radius: 12px;
            border: 1px solid var(--color-border-glass);
        }

        .period-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: var(--color-text-secondary);
            font-weight: 600;
            font-size: 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .period-btn:hover {
            background: var(--color-surface-elevated);
            color: var(--color-text-primary);
        }

        .period-btn.active {
            background: var(--color-success);
            color: white;
        }

        /* Section */
        .section {
            background: var(--color-surface-elevated);
            border: 1px solid var(--color-border-glass);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--color-border-glass);
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--color-text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Table Styling */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table thead {
            background: var(--color-surface);
            border-radius: 8px;
        }

        .data-table th {
            padding: 12px 16px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table td {
            padding: 16px;
            border-top: 1px solid var(--color-border-glass);
            color: var(--color-text-primary);
            font-size: 14px;
        }

        .data-table tbody tr {
            transition: background 0.2s;
        }

        .data-table tbody tr:hover {
            background: var(--color-surface);
        }

        .amount {
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }

        .amount.positive {
            color: var(--color-success);
        }

        .amount.negative {
            color: var(--color-error);
        }

        /* Loading State */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            gap: 20px;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--color-border-glass);
            border-top-color: var(--color-success);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: var(--space-4);
            }

            .header h1 {
                font-size: 24px;
            }

            .kpi-grid {
                grid-template-columns: 1fr;
            }

            .period-selector {
                flex-wrap: wrap;
            }
        }

        /* üåì THEME TOGGLE */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid var(--color-border);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .theme-toggle:hover { transform: scale(1.05); background: rgba(255, 255, 255, 0.15); }
        .theme-toggle__icon { width: 20px; height: 20px; color: var(--color-text-primary); }
        .theme-toggle__icon--light { display: none; }
        [data-theme="light"] .theme-toggle__icon--light { display: block; }
        [data-theme="light"] .theme-toggle__icon--dark { display: none; }
        [data-theme="light"] .theme-toggle { background: rgba(255,255,255,0.8); border-color: rgba(0,0,0,0.1); }

        /* üîô ZUR√úCK-BUTTON (Fixed Position) */
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--color-border, rgba(255,255,255,0.1));
            border-radius: 8px;
            color: var(--color-text-primary, #e0e0e0);
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .back-button:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(-2px);
        }
        [data-theme="light"] .back-button {
            background: rgba(255, 255, 255, 0.8);
            border-color: rgba(0, 0, 0, 0.1);
            color: #1a1a2e;
        }
        @media (max-width: 768px) {
            .back-button { top: 10px; left: 10px; padding: 8px; }
            .back-button span { display: none; }
        }
    </style>
</head>
<body class="has-ai-features">
    <!-- üîô ZUR√úCK-BUTTON -->
    <button class="back-button" onclick="history.back()" title="Zur√ºck">
        <i data-feather="arrow-left"></i>
        <span>Zur√ºck</span>
    </button>

    <!-- üåì THEME TOGGLE -->
    <button id="themeToggle" class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle Theme">
        <i data-feather="sun" class="theme-toggle__icon theme-toggle__icon--light"></i>
        <i data-feather="moon" class="theme-toggle__icon theme-toggle__icon--dark"></i>
    </button>

    <div class="container">
        <!-- Navigation -->
        <div class="nav-bar">
            <a href="index.html" class="nav-btn">
                <i data-feather="home"></i>
                Dashboard
            </a>
            <a href="steuerberater-bilanz.html" class="nav-btn active">
                <i data-feather="pie-chart"></i>
                Bilanz-√úbersicht
            </a>
            <a href="steuerberater-statistiken.html" class="nav-btn">
                <i data-feather="trending-up"></i>
                Statistiken
            </a>
            <a href="steuerberater-kosten.html" class="nav-btn">
                <i data-feather="layers"></i>
                Kostenaufschl√ºsselung
            </a>
            <a href="steuerberater-export.html" class="nav-btn">
                <i data-feather="download"></i>
                Export & Berichte
            </a>
        </div>

        <!-- Header -->
        <div class="header">
            <div style="display: flex; align-items: center; gap: 16px;">
                <h1>
                    <i data-feather="bar-chart-2" style="color: var(--color-success);"></i>
                    Bilanz-√úbersicht
                </h1>
                <!-- Offene Posten Badge (NEU 2025-11-12) -->
                <div id="offenePostenBadge" style="display: none; cursor: pointer;" onclick="openOffenePostenModal()">
                    <div style="padding: 8px 16px; background: rgba(251, 146, 60, 0.15); border: 1px solid rgba(251, 146, 60, 0.3); border-radius: 20px; display: flex; align-items: center; gap: 8px; transition: all 0.2s;">
                        <i data-feather="alert-circle" style="width: 16px; height: 16px; color: #fb923c;"></i>
                        <span id="offenePostenCount" style="font-size: 14px; font-weight: 600; color: #fb923c;">0</span>
                        <span style="font-size: 14px; color: #fb923c;">offene Bestellungen</span>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <div class="period-selector">
                    <button class="period-btn" data-period="month">Monat</button>
                    <button class="period-btn" data-period="quarter">Quartal</button>
                    <button class="period-btn active" data-period="year">Jahr</button>
                    <button class="period-btn" data-period="all">Gesamt</button>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="loading">
            <div class="spinner"></div>
            <p style="color: var(--color-text-secondary); font-weight: 600;">Finanzdaten werden geladen...</p>
        </div>

        <!-- KPI Cards -->
        <div id="kpiCards" class="kpi-grid" style="display: none;">
            <!-- Umsatz Card -->
            <div class="kpi-card success">
                <div class="kpi-header">
                    <span class="kpi-title">Gesamtumsatz</span>
                    <div class="kpi-icon" style="background: var(--color-success);">
                        <i data-feather="trending-up"></i>
                    </div>
                </div>
                <div class="kpi-value" id="kpiUmsatz">0,00 ‚Ç¨</div>
                <div class="kpi-subtitle" id="kpiUmsatzCount">0 Fahrzeuge abgeschlossen</div>
                <span class="kpi-trend positive" id="kpiUmsatzTrend" style="display: none;">
                    <i data-feather="arrow-up" style="width: 14px; height: 14px;"></i>
                    +0% vs. Vorjahr
                </span>
            </div>

            <!-- Kosten Card -->
            <div class="kpi-card warning">
                <div class="kpi-header">
                    <span class="kpi-title">Gesamtkosten</span>
                    <div class="kpi-icon" style="background: var(--color-warning);">
                        <i data-feather="dollar-sign"></i>
                    </div>
                </div>
                <div class="kpi-value" id="kpiKosten">0,00 ‚Ç¨</div>
                <div class="kpi-subtitle">Ersatzteile + Lohn + Material</div>
            </div>

            <!-- Gewinn Card -->
            <div class="kpi-card info">
                <div class="kpi-header">
                    <span class="kpi-title">Bruttogewinn</span>
                    <div class="kpi-icon" style="background: var(--color-info);">
                        <i data-feather="activity"></i>
                    </div>
                </div>
                <div class="kpi-value" id="kpiGewinn">0,00 ‚Ç¨</div>
                <div class="kpi-subtitle" id="kpiMarge">Marge: 0%</div>
            </div>

            <!-- Durchschnitt Card -->
            <div class="kpi-card info">
                <div class="kpi-header">
                    <span class="kpi-title">√ò Auftragswert</span>
                    <div class="kpi-icon" style="background: var(--color-primary);">
                        <i data-feather="shopping-cart"></i>
                    </div>
                </div>
                <div class="kpi-value" id="kpiDurchschnitt">0,00 ‚Ç¨</div>
                <div class="kpi-subtitle">Pro abgeschlossenem Fahrzeug</div>
            </div>
        </div>

        <!-- Monatliche √úbersicht -->
        <div id="monthlySection" class="section" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">
                    <i data-feather="calendar"></i>
                    Monatliche √úbersicht 2025
                </h2>
            </div>
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Monat</th>
                            <th>Fahrzeuge</th>
                            <th>Umsatz (Brutto)</th>
                            <th>Kosten (Netto)</th>
                            <th>Gewinn</th>
                            <th>Marge</th>
                        </tr>
                    </thead>
                    <tbody id="monthlyTableBody">
                        <!-- Wird via JavaScript gef√ºllt -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Service-√úbersicht -->
        <div id="serviceSection" class="section" style="display: none;">
            <div class="section-header">
                <h2 class="section-title">
                    <i data-feather="tool"></i>
                    Umsatz nach Service-Art
                </h2>
            </div>
            <div style="overflow-x: auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Service</th>
                            <th>Anzahl</th>
                            <th>Umsatz (Brutto)</th>
                            <th>√ò Wert</th>
                            <th>Anteil</th>
                        </tr>
                    </thead>
                    <tbody id="serviceTableBody">
                        <!-- Wird via JavaScript gef√ºllt -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Offene Posten Modal (NEU 2025-11-12) -->
        <div id="offenePostenModal" style="display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 1000; padding: 40px; overflow-y: auto;" onclick="closeOffenePostenModal()">
            <div style="max-width: 900px; margin: 0 auto; background: var(--color-surface); border-radius: 16px; padding: 32px; box-shadow: var(--shadow-xl);" onclick="event.stopPropagation()">
                <!-- Modal Header -->
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 24px;">
                    <div>
                        <h2 style="font-size: 24px; font-weight: 700; color: var(--color-text-primary); margin-bottom: 8px;">
                            <i data-feather="alert-circle" style="width: 24px; height: 24px; color: #fb923c; vertical-align: middle;"></i>
                            Offene Bestellungen
                        </h2>
                        <p style="font-size: 14px; color: var(--color-text-secondary);">
                            Fahrzeuge mit abgeschlossenen Auftr√§gen, aber noch ausstehenden Materialbestellungen
                        </p>
                    </div>
                    <button onclick="closeOffenePostenModal()" style="background: none; border: none; cursor: pointer; padding: 8px; color: var(--color-text-secondary);">
                        <i data-feather="x" style="width: 24px; height: 24px;"></i>
                    </button>
                </div>

                <!-- Warning Banner -->
                <div style="padding: 16px; background: rgba(251, 146, 60, 0.1); border-left: 4px solid #fb923c; border-radius: 8px; margin-bottom: 24px;">
                    <div style="font-size: 14px; font-weight: 600; color: #fb923c; margin-bottom: 4px;">
                        ‚ö†Ô∏è Diese Kosten sind noch nicht in der Bilanz erfasst!
                    </div>
                    <div style="font-size: 13px; color: var(--color-text-secondary);">
                        Sobald die Bestellungen als "angeliefert" markiert werden, flie√üen die Kosten in die n√§chste Bilanz ein.
                    </div>
                </div>

                <!-- Tabelle -->
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--color-border-glass);">
                                <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; color: var(--color-text-secondary);">Kennzeichen</th>
                                <th style="padding: 12px; text-align: left; font-size: 13px; font-weight: 600; color: var(--color-text-secondary);">Status</th>
                                <th style="padding: 12px; text-align: center; font-size: 13px; font-weight: 600; color: var(--color-text-secondary);">Anzahl Bestellungen</th>
                                <th style="padding: 12px; text-align: right; font-size: 13px; font-weight: 600; color: var(--color-text-secondary);">Gesamtwert</th>
                                <th style="padding: 12px; text-align: center; font-size: 13px; font-weight: 600; color: var(--color-text-secondary);">Alter</th>
                                <th style="padding: 12px; text-align: center; font-size: 13px; font-weight: 600; color: var(--color-text-secondary);">Aktion</th>
                            </tr>
                        </thead>
                        <tbody id="offenePostenTableBody">
                            <!-- Wird via JavaScript gef√ºllt -->
                        </tbody>
                    </table>
                </div>

                <!-- Footer -->
                <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--color-border-glass); text-align: center;">
                    <a href="material.html" style="display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; background: var(--color-primary); color: white; border-radius: 8px; text-decoration: none; font-weight: 600; transition: all 0.2s;">
                        <i data-feather="package" style="width: 16px; height: 16px;"></i>
                        Zur Material-Verwaltung
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- üÜï BUGFIX 2025-11-18: Pre-initialize werkstattId (Race Condition Fix - Pattern 2) -->
    <script>
        // Pre-load werkstattId from sessionStorage BEFORE Firebase SDKs load
        // Prevents race condition where Firebase initializes before werkstattId is set
        const sessionWerkstatt = sessionStorage.getItem('session_werkstatt');
        if (sessionWerkstatt) {
            try {
                const werkstattData = JSON.parse(sessionWerkstatt);
                if (werkstattData.werkstattId) {
                    window.werkstattId = werkstattData.werkstattId;
                    console.log('‚úÖ [STEUERBERATER-PRELOAD] werkstattId pre-initialized:', window.werkstattId);
                }
            } catch (e) {
                console.error('‚ùå [STEUERBERATER-PRELOAD] Failed to parse sessionStorage:', e);
            }
        }

        // Fallback: Try localStorage (legacy support)
        if (!window.werkstattId) {
            const storedWerkstattId = localStorage.getItem('werkstattId');
            if (storedWerkstattId) {
                window.werkstattId = storedWerkstattId;
                console.log('‚úÖ [STEUERBERATER-PRELOAD] werkstattId from localStorage:', window.werkstattId);
            }
        }
    </script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>

    <!-- App Scripts (CRITICAL: firebase-config.js MUST be first!) -->
    <script src="firebase-config.js"></script>
    <script src="listener-registry.js"></script>
    <script src="js/auth-manager.js"></script>
    <script src="js/settings-manager.js"></script>
    <script src="js/toast.js"></script>

    <script>
        // ============================================
        // GLOBAL STATE
        // ============================================
        let currentPeriod = 'year';
        let allFahrzeuge = [];
        let werkstattId = '';

        // ============================================
        // INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Steuerberater Bilanz-Dashboard initialisiert');

            // Feather Icons
            feather.replace();

            // Auth Check
            await checkAuth();

            // Period Selector
            document.querySelectorAll('.period-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentPeriod = btn.dataset.period;
                    calculateAndDisplayData();
                });
            });

            // Load Data
            await loadFinancialData();
        });

        // ============================================
        // AUTH CHECK
        // ============================================
        async function checkAuth() {
            return new Promise((resolve) => {
                firebase.auth().onAuthStateChanged(async (user) => {
                    if (!user) {
                        console.warn('‚ùå Nicht eingeloggt - Redirect zu Login');
                        safeNavigate('login.html');
                        return;
                    }

                    // Get werkstattId (pre-initialized globally, fallback to sessionStorage)
                    werkstattId = window.werkstattId || sessionStorage.getItem('werkstattId');
                    if (!werkstattId) {
                        console.error('‚ùå Keine werkstattId gefunden');
                        toast.error('Fehler: Keine Werkstatt-ID gefunden', { duration: 5000 });
                        return;
                    }

                    // üÜï BUGFIX 2025-11-15 (FIX #5): Partner-Zugriff auf Werkstatt-Seiten blockieren
                    // Partner d√ºrfen nur das Partner-Portal nutzen, nicht Werkstatt-Seiten
                    const role = sessionStorage.getItem('role');
                    if (role === 'partner') {
                        console.warn('üö´ Partner-Zugriff blockiert! Redirect zu Partner-Portal...');
                        safeNavigate('./partner-app/meine-anfragen.html');
                        return; // Stop further execution
                    }

                    // Check role
                    if (role !== 'werkstatt' && role !== 'steuerberater' && role !== 'admin' && role !== 'superadmin') {
                        console.warn('‚ùå Zugriff verweigert - Keine Steuerberater-Rolle');
                        toast.error('Zugriff verweigert! Nur f√ºr Steuerberater.', { duration: 5000 });
                        setTimeout(() => safeNavigate('index.html'), 2000);
                        return;
                    }

                    console.log('‚úÖ Auth OK - Steuerberater:', user.email);
                    resolve();
                });
            });
        }

        // ============================================
        // LOAD FINANCIAL DATA
        // ============================================
        async function loadFinancialData() {
            try {
                console.log(`üìä Lade Fahrzeuge f√ºr werkstattId: ${werkstattId}`);

                const collection = `fahrzeuge_${werkstattId}`;
                const snapshot = await firebase.firestore()
                    .collection(collection)
                    .where('status', '==', 'abgeschlossen')
                    .get();

                allFahrzeuge = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

                console.log(`‚úÖ ${allFahrzeuge.length} abgeschlossene Fahrzeuge geladen`);

                // Hide loading, show content
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('kpiCards').style.display = 'grid';
                document.getElementById('monthlySection').style.display = 'block';
                document.getElementById('serviceSection').style.display = 'block';

                // Calculate and display
                calculateAndDisplayData();

            } catch (error) {
                console.error('‚ùå Fehler beim Laden der Daten:', error);
                toast.error('Fehler beim Laden der Finanzdaten', { duration: 5000 });
                document.getElementById('loadingState').innerHTML = `
                    <i data-feather="alert-circle" style="width: 48px; height: 48px; color: var(--color-error);"></i>
                    <p style="color: var(--color-error); font-weight: 600;">Fehler beim Laden der Daten</p>
                `;
                feather.replace();
            }
        }

        // ============================================
        // CALCULATE & DISPLAY DATA
        // ============================================
        function calculateAndDisplayData() {
            const filteredFahrzeuge = filterByPeriod(allFahrzeuge, currentPeriod);
            console.log(`üìä Berechnungen f√ºr Periode: ${currentPeriod} (${filteredFahrzeuge.length} Fahrzeuge)`);

            // KPIs berechnen
            let totalUmsatz = 0;
            let totalKosten = 0;

            filteredFahrzeuge.forEach(fahrzeug => {
                // üîß 2025-11-18: Waterfall-Logic f√ºr Revenue (Umsatz)
                // SOURCE 1: gesamtsummeBrutto (from Entwurf workflow)
                // SOURCE 2: rechnung.bruttoBetrag (from invoice generation)
                // SOURCE 3: vereinbarterPreis (agreed price - fallback)
                // SOURCE 4: 0 (no revenue data available)
                const brutto = parseFloat(
                    fahrzeug.gesamtsummeBrutto
                    || fahrzeug.rechnung?.bruttoBetrag
                    || fahrzeug.vereinbarterPreis
                    || 0
                );
                totalUmsatz += brutto;

                // Kosten = Ersatzteile + Arbeitslohn + Lackierung + Materialien (Netto)
                const kosten = calculateNettoKosten(fahrzeug);
                totalKosten += kosten;
            });

            const totalGewinn = totalUmsatz - totalKosten;
            const marge = totalUmsatz > 0 ? ((totalGewinn / totalUmsatz) * 100).toFixed(1) : 0;
            const durchschnitt = filteredFahrzeuge.length > 0 ? totalUmsatz / filteredFahrzeuge.length : 0;

            // KPIs anzeigen
            document.getElementById('kpiUmsatz').textContent = formatCurrency(totalUmsatz);
            document.getElementById('kpiUmsatzCount').textContent = `${filteredFahrzeuge.length} Fahrzeuge abgeschlossen`;
            document.getElementById('kpiKosten').textContent = formatCurrency(totalKosten);
            document.getElementById('kpiGewinn').textContent = formatCurrency(totalGewinn);
            document.getElementById('kpiMarge').textContent = `Marge: ${marge}%`;
            document.getElementById('kpiDurchschnitt').textContent = formatCurrency(durchschnitt);

            // Monthly Table
            renderMonthlyTable(filteredFahrzeuge);

            // Service Table
            renderServiceTable(filteredFahrzeuge);

            feather.replace();
        }

        // ============================================
        // FILTER BY PERIOD
        // ============================================
        function filterByPeriod(fahrzeuge, period) {
            if (period === 'all') return fahrzeuge;

            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth(); // 0-11
            const currentQuarter = Math.floor(currentMonth / 3); // 0-3

            return fahrzeuge.filter(f => {
                if (!f.abgeschlossenAm) return false;

                const date = f.abgeschlossenAm.toDate ? f.abgeschlossenAm.toDate() : new Date(f.abgeschlossenAm);
                const year = date.getFullYear();
                const month = date.getMonth();
                const quarter = Math.floor(month / 3);

                switch (period) {
                    case 'month':
                        return year === currentYear && month === currentMonth;
                    case 'quarter':
                        return year === currentYear && quarter === currentQuarter;
                    case 'year':
                        return year === currentYear;
                    default:
                        return true;
                }
            });
        }

        // ============================================
        // CALCULATE NETTO KOSTEN (üîß 2025-11-18: Waterfall-Logic)
        // ============================================
        /**
         * Waterfall-Logic f√ºr Kostenberechnung
         * SOURCE 1: kalkulationData (BEST - full itemized breakdown)
         * SOURCE 2: kva.breakdown (PARTIAL - category totals)
         * SOURCE 3: kostenAufschluesselung (PARTIAL - direct workshop)
         * SOURCE 4: pdfImport.editedData (PARTIAL - PDF import)
         * SOURCE 5: 0 (no data available)
         */
        function calculateNettoKosten(fahrzeug) {
            // ‚úÖ SOURCE 1: kalkulationData (BEST - full itemized breakdown)
            if (fahrzeug.kalkulationData) {
                const kalkulation = fahrzeug.kalkulationData;
                const hasData = (
                    (kalkulation.ersatzteile && kalkulation.ersatzteile.length > 0) ||
                    (kalkulation.arbeitslohn && kalkulation.arbeitslohn.length > 0) ||
                    (kalkulation.lackierung && kalkulation.lackierung.length > 0) ||
                    (kalkulation.materialien && kalkulation.materialien.length > 0)
                );

                if (hasData) {
                    let kosten = 0;
                    kosten += (kalkulation.ersatzteile || []).reduce((sum, item) => sum + (item.gesamtpreis || 0), 0);
                    kosten += (kalkulation.arbeitslohn || []).reduce((sum, item) => sum + (item.gesamtpreis || 0), 0);
                    kosten += (kalkulation.lackierung || []).reduce((sum, item) => sum + (item.gesamtpreis || 0), 0);
                    kosten += (kalkulation.materialien || []).reduce((sum, item) => sum + (item.gesamtpreis || 0), 0);
                    return kosten;
                }
            }

            // ‚ö†Ô∏è SOURCE 2: kva.breakdown (PARTIAL - category totals only)
            if (fahrzeug.kva && fahrzeug.kva.breakdown) {
                const breakdown = fahrzeug.kva.breakdown;
                return parseFloat(breakdown.ersatzteile || 0)
                     + parseFloat(breakdown.arbeitslohn || 0)
                     + parseFloat(breakdown.lackierung || 0)
                     + parseFloat(breakdown.materialien || 0);
            }

            // ‚ö†Ô∏è SOURCE 3: kostenAufschluesselung (PARTIAL - direct workshop breakdown)
            if (fahrzeug.kostenAufschluesselung) {
                const kosten = fahrzeug.kostenAufschluesselung;
                return parseFloat(kosten.ersatzteile || 0)
                     + parseFloat(kosten.arbeitslohn || 0)
                     + parseFloat(kosten.lackierung || 0)
                     + parseFloat(kosten.materialien || 0);
            }

            // ‚ö†Ô∏è SOURCE 4: pdfImport.editedData (PARTIAL - PDF import)
            if (fahrzeug.pdfImport?.editedData) {
                let kosten = 0;
                const data = fahrzeug.pdfImport.editedData;

                if (data.ersatzteile) {
                    kosten += data.ersatzteile.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0);
                }
                if (data.arbeitslohn) {
                    kosten += data.arbeitslohn.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0);
                }
                if (data.lackierung) {
                    kosten += data.lackierung.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0);
                }
                if (data.materialien) {
                    kosten += data.materialien.reduce((sum, item) => sum + (item.gesamtpreis || 0), 0);
                }

                // Add nachbestellungen (material orders)
                if (fahrzeug.nachbestellungen && Array.isArray(fahrzeug.nachbestellungen)) {
                    kosten += fahrzeug.nachbestellungen.reduce((sum, bestellung) => {
                        return sum + (bestellung.gesamtpreis || 0);
                    }, 0);
                }

                return kosten;
            }

            // ‚ùå SOURCE 5: No data available
            return 0;
        }

        // ============================================
        // RENDER MONTHLY TABLE
        // ============================================
        function renderMonthlyTable(fahrzeuge) {
            const monthlyData = {};
            const months = ['Januar', 'Februar', 'M√§rz', 'April', 'Mai', 'Juni', 'Juli', 'August', 'September', 'Oktober', 'November', 'Dezember'];

            // Initialize all months
            months.forEach((name, index) => {
                monthlyData[index] = { name, count: 0, umsatz: 0, kosten: 0 };
            });

            // Aggregate data
            fahrzeuge.forEach(f => {
                if (!f.abgeschlossenAm) return;
                const date = f.abgeschlossenAm.toDate ? f.abgeschlossenAm.toDate() : new Date(f.abgeschlossenAm);
                const month = date.getMonth();

                monthlyData[month].count++;
                monthlyData[month].umsatz += parseFloat(f.gesamtsummeBrutto || 0);
                monthlyData[month].kosten += calculateNettoKosten(f);
            });

            // Render table
            const tbody = document.getElementById('monthlyTableBody');
            tbody.innerHTML = '';

            Object.values(monthlyData).forEach(data => {
                const gewinn = data.umsatz - data.kosten;
                const marge = data.umsatz > 0 ? ((gewinn / data.umsatz) * 100).toFixed(1) : 0;

                const row = `
                    <tr>
                        <td><strong>${data.name}</strong></td>
                        <td>${data.count}</td>
                        <td class="amount">${formatCurrency(data.umsatz)}</td>
                        <td class="amount">${formatCurrency(data.kosten)}</td>
                        <td class="amount ${gewinn >= 0 ? 'positive' : 'negative'}">${formatCurrency(gewinn)}</td>
                        <td>${marge}%</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // ============================================
        // RENDER SERVICE TABLE
        // ============================================
        function renderServiceTable(fahrzeuge) {
            const serviceData = {};

            // Aggregate by service type
            fahrzeuge.forEach(f => {
                const service = f.serviceTyp || 'Unbekannt';
                if (!serviceData[service]) {
                    serviceData[service] = { count: 0, umsatz: 0 };
                }
                serviceData[service].count++;
                serviceData[service].umsatz += parseFloat(f.gesamtsummeBrutto || 0);
            });

            // Calculate total for percentages
            const totalUmsatz = Object.values(serviceData).reduce((sum, s) => sum + s.umsatz, 0);

            // Render table
            const tbody = document.getElementById('serviceTableBody');
            tbody.innerHTML = '';

            // Sort by revenue (descending)
            const sorted = Object.entries(serviceData).sort((a, b) => b[1].umsatz - a[1].umsatz);

            sorted.forEach(([service, data]) => {
                const avg = data.count > 0 ? data.umsatz / data.count : 0;
                const percentage = totalUmsatz > 0 ? ((data.umsatz / totalUmsatz) * 100).toFixed(1) : 0;

                const row = `
                    <tr>
                        <td><strong>${service}</strong></td>
                        <td>${data.count}</td>
                        <td class="amount">${formatCurrency(data.umsatz)}</td>
                        <td class="amount">${formatCurrency(avg)}</td>
                        <td>${percentage}%</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // ============================================
        // OFFENE POSTEN DASHBOARD (NEU 2025-11-12)
        // ============================================

        /**
         * Pr√ºft offene Bestellungen f√ºr abgeschlossene Fahrzeuge
         */
        async function checkOffenePosten() {
            if (!window.db) return;

            try {
                const werkstattId = window.werkstattId; // ‚úÖ SECURITY FIX: No 'mosbach' fallback

                // 1. Lade alle abgeschlossenen Fahrzeuge
                const fahrzeugeSnapshot = await window.getCollection('fahrzeuge')
                    .where('status', '==', 'abgeschlossen')
                    .get();

                // 2. Sammle Fahrzeug-IDs
                const fahrzeugIds = [];
                const fahrzeugMap = {};
                fahrzeugeSnapshot.forEach(doc => {
                    const data = doc.data();
                    fahrzeugIds.push(data.id);
                    fahrzeugMap[data.id] = data;
                });

                if (fahrzeugIds.length === 0) {
                    return; // Keine abgeschlossenen Fahrzeuge
                }

                // 3. Lade alle Bestellungen mit status='bestellt' f√ºr diese Fahrzeuge
                const bestellungenSnapshot = await window.getCollection('bestellungen')
                    .where('status', '==', 'bestellt')
                    .get();

                // 4. Gruppiere Bestellungen nach Fahrzeug
                const offenePostenMap = {};
                bestellungenSnapshot.forEach(doc => {
                    const bestellung = doc.data();
                    if (fahrzeugIds.includes(bestellung.fahrzeugId)) {
                        if (!offenePostenMap[bestellung.fahrzeugId]) {
                            offenePostenMap[bestellung.fahrzeugId] = [];
                        }
                        offenePostenMap[bestellung.fahrzeugId].push(bestellung);
                    }
                });

                const offenePostenCount = Object.keys(offenePostenMap).length;

                // 5. Zeige Badge falls offene Posten existieren
                if (offenePostenCount > 0) {
                    document.getElementById('offenePostenBadge').style.display = 'block';
                    document.getElementById('offenePostenCount').textContent = offenePostenCount;

                    // Speichere Daten f√ºr Modal
                    window.offenePostenData = { offenePostenMap, fahrzeugMap };
                }

                console.log(`üìä [OFFENE POSTEN] ${offenePostenCount} Fahrzeuge mit offenen Bestellungen`);

            } catch (error) {
                console.error('‚ùå [OFFENE POSTEN] Fehler:', error);
            }
        }

        /**
         * √ñffnet Modal mit offenen Posten
         */
        function openOffenePostenModal() {
            const modal = document.getElementById('offenePostenModal');
            const tbody = document.getElementById('offenePostenTableBody');

            modal.style.display = 'block';
            document.body.style.overflow = 'hidden';

            if (!window.offenePostenData) {
                tbody.innerHTML = '<tr><td colspan="6" style="padding: 24px; text-align: center; color: var(--color-text-secondary);">Keine Daten verf√ºgbar</td></tr>';
                return;
            }

            const { offenePostenMap, fahrzeugMap } = window.offenePostenData;

            // Tabelle f√ºllen
            tbody.innerHTML = '';
            Object.keys(offenePostenMap).forEach(fahrzeugId => {
                const bestellungen = offenePostenMap[fahrzeugId];
                const fahrzeug = fahrzeugMap[fahrzeugId];

                const anzahl = bestellungen.length;
                const gesamtwert = bestellungen.reduce((sum, b) => sum + (b.gesamtpreis || 0), 0);

                // √Ñlteste Bestellung finden
                const aelteste = bestellungen.reduce((oldest, b) => {
                    const date = new Date(b.bestelltAm);
                    return !oldest || date < new Date(oldest.bestelltAm) ? b : oldest;
                }, null);

                const alter = Math.floor((Date.now() - new Date(aelteste.bestelltAm)) / (1000 * 60 * 60 * 24));

                // Farb-Codierung
                let alterColor = '#6b7280'; // Grau
                if (alter > 14) alterColor = '#ef4444'; // Rot
                else if (alter > 7) alterColor = '#fb923c'; // Orange

                const row = `
                    <tr style="border-bottom: 1px solid var(--color-border-glass);">
                        <td style="padding: 12px; font-weight: 600;">${fahrzeug.kennzeichen || fahrzeugId}</td>
                        <td style="padding: 12px;">
                            <span style="padding: 4px 8px; background: rgba(251, 146, 60, 0.15); color: #fb923c; border-radius: 4px; font-size: 12px; font-weight: 600;">
                                Bestellt
                            </span>
                        </td>
                        <td style="padding: 12px; text-align: center; font-weight: 600;">${anzahl}</td>
                        <td style="padding: 12px; text-align: right; font-weight: 600;">${formatCurrency(gesamtwert)}</td>
                        <td style="padding: 12px; text-align: center;">
                            <span style="padding: 4px 8px; background: rgba(${alterColor === '#ef4444' ? '239, 68, 68' : alterColor === '#fb923c' ? '251, 146, 60' : '107, 114, 128'}, 0.15); color: ${alterColor}; border-radius: 4px; font-size: 12px; font-weight: 600;">
                                ${alter} Tage
                            </span>
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <a href="material.html?fahrzeug=${fahrzeugId}" style="color: var(--color-primary); text-decoration: none; font-weight: 600; font-size: 13px;">
                                Details ‚Üí
                            </a>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            // Feather Icons aktualisieren
            feather.replace();
        }

        /**
         * Schlie√üt Modal
         */
        function closeOffenePostenModal() {
            document.getElementById('offenePostenModal').style.display = 'none';
            document.body.style.overflow = '';
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        function formatCurrency(value) {
            return new Intl.NumberFormat('de-DE', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }
    </script>

    <!-- üåì THEME TOGGLE SCRIPT -->
    <script>
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            if (typeof feather !== 'undefined') feather.replace();
        }
    </script>
</body>
</html>
